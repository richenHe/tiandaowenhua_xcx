/**
 * CloudBase MySQL 数据库连接模块
 * 使用 @cloudbase/node-sdk 的 rdb() 方法连接 MySQL
 * 
 * ⚠️ 重要说明：
 * - CloudBase 环境 ID: cloud1-0gnn3mn17b581124
 * - MySQL 实例 ID: tnt-e300s320g
 * - MySQL 数据库名: tiandao_culture
 * - 必须同时指定 instance 和 database 参数
 */

const cloudbase = require('@cloudbase/node-sdk');

// 初始化 CloudBase（使用当前环境）
const app = cloudbase.init({
  env: cloudbase.SYMBOL_CURRENT_ENV
});

// 获取关系型数据库引用
// ✅ 正确：需要指定 instance（MySQL实例ID）和 database（数据库名）
const db = app.rdb({
  instance: 'tnt-e300s320g',       // MySQL 实例ID
  database: 'tiandao_culture'      // 数据库名
});

/**
 * 执行查询（只读操作）
 * @param {string} table - 表名
 * @param {Object} options - 查询选项
 * @returns {Promise<Array>} 查询结果
 */
async function query(table, options = {}) {
  try {
    const { columns = '*', where = {}, limit, offset, orderBy } = options;
    
    let queryBuilder = db.from(table).select(columns);
    
    // 应用 where 条件
    for (const [key, value] of Object.entries(where)) {
      queryBuilder = queryBuilder.eq(key, value);
    }
    
    // 应用排序
    if (orderBy) {
      queryBuilder = queryBuilder.order(orderBy.column, { ascending: orderBy.ascending !== false });
    }
    
    // 应用分页
    if (limit) {
      queryBuilder = queryBuilder.limit(limit);
    }
    if (offset) {
      queryBuilder = queryBuilder.offset(offset);
    }
    
    const { data, error } = await queryBuilder;
    
    if (error) {
      throw new Error(error.message || '数据库查询失败');
    }
    
    return data || [];
  } catch (error) {
    console.error('[DB Query Error]:', error);
    throw error;
  }
}

/**
 * 执行原始 SQL 查询
 * @param {string} sql - SQL 语句
 * @param {Array} params - 参数（注意：rdb 可能不支持参数化查询）
 * @returns {Promise<Array>} 查询结果
 */
async function rawQuery(sql, params = []) {
  try {
    // 注意：CloudBase rdb() 可能不直接支持原始 SQL
    // 如果需要执行原始 SQL，可能需要使用 HTTP API 或其他方式
    console.warn('[DB] rawQuery 可能需要使用其他方式实现');
    throw new Error('原始 SQL 查询暂不支持，请使用查询构建器');
  } catch (error) {
    console.error('[DB Raw Query Error]:', error);
    throw error;
  }
}

/**
 * 插入数据
 * @param {string} table - 表名
 * @param {Object} data - 数据对象
 * @returns {Promise<Object>} 插入结果
 */
async function insert(table, data) {
  try {
    // _openid 会由服务端自动填充，无需手动设置
    const { data: result, error } = await db
      .from(table)
      .insert(data);
    
    if (error) {
      throw new Error(error.message || '数据插入失败');
    }
    
    return result;
  } catch (error) {
    console.error('[DB Insert Error]:', error);
    throw error;
  }
}

/**
 * 更新数据
 * @param {string} table - 表名
 * @param {Object} data - 更新数据
 * @param {Object} where - WHERE 条件
 * @returns {Promise<Object>} 更新结果
 */
async function update(table, data, where) {
  try {
    let queryBuilder = db.from(table).update(data);
    
    // 应用 where 条件
    for (const [key, value] of Object.entries(where)) {
      queryBuilder = queryBuilder.eq(key, value);
    }
    
    const { data: result, error } = await queryBuilder;
    
    if (error) {
      throw new Error(error.message || '数据更新失败');
    }
    
    return result;
  } catch (error) {
    console.error('[DB Update Error]:', error);
    throw error;
  }
}

/**
 * 删除数据（软删除）
 * @param {string} table - 表名
 * @param {Object} where - WHERE 条件
 * @returns {Promise<Object>} 删除结果
 */
async function softDelete(table, where) {
  try {
    return await update(table, { is_deleted: 1 }, where);
  } catch (error) {
    console.error('[DB Soft Delete Error]:', error);
    throw error;
  }
}

/**
 * 查询单条数据
 * @param {string} table - 表名
 * @param {Object} where - WHERE 条件
 * @returns {Promise<Object|null>} 查询结果
 */
async function findOne(table, where) {
  try {
    const results = await query(table, { where, limit: 1 });
    return results.length > 0 ? results[0] : null;
  } catch (error) {
    console.error('[DB FindOne Error]:', error);
    throw error;
  }
}

/**
 * 统计数量
 * @param {string} table - 表名
 * @param {Object} where - WHERE 条件
 * @returns {Promise<number>} 数量
 */
async function count(table, where = {}) {
  try {
    let queryBuilder = db.from(table).select('count', { count: 'exact' });
    
    // 应用 where 条件
    for (const [key, value] of Object.entries(where)) {
      queryBuilder = queryBuilder.eq(key, value);
    }
    
    const { count: total, error } = await queryBuilder;
    
    if (error) {
      throw new Error(error.message || '统计失败');
    }
    
    return total || 0;
  } catch (error) {
    console.error('[DB Count Error]:', error);
    throw error;
  }
}

/**
 * 事务处理（注意：rdb 可能不直接支持事务）
 * @param {Function} callback - 事务回调函数
 * @returns {Promise<any>} 事务执行结果
 */
async function transaction(callback) {
  console.warn('[DB] transaction 在 CloudBase rdb 中可能需要特殊处理');
  throw new Error('事务功能暂不支持');
}

module.exports = {
  db,           // 导出 db 实例供高级用法
  query,
  rawQuery,
  insert,
  update,
  softDelete,
  findOne,
  count,
  transaction
};
