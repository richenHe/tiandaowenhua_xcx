# å¤©é“æ–‡åŒ–å°ç¨‹åº - äº‘å‡½æ•°æ ‡å‡†éƒ¨ç½²è§„èŒƒ

**ç‰ˆæœ¬**: V3.2
**æ›´æ–°æ—¶é—´**: 2026-02-10
**åŸºäº**: ç»Ÿä¸€å…¬å…±æ¨¡å— + åŒæ­¥è„šæœ¬ + Supabase Query Builder + å®æˆ˜éªŒè¯
**é€‚ç”¨èŒƒå›´**: user, course, order, ambassador, system äº”å¤§æ¨¡å—
**æœ¬æ¬¡æ›´æ–°**: 
- âœ… å¼•å…¥ç»Ÿä¸€å…¬å…±æ¨¡å—ç®¡ç†æ¶æ„
- âœ… æ–°å¢ `åŒæ­¥å…¬å…±æ¨¡å—.ps1` ä¸€é”®åŒæ­¥è„šæœ¬
- âœ… æ›´æ–°æ‰€æœ‰å¤åˆ¶å‘½ä»¤ä¸ºä»ç»Ÿä¸€å…¬å…±æ¨¡å—å¤åˆ¶
- âœ… ä¼˜åŒ–å…¬å…±ä»£ç ç»´æŠ¤æµç¨‹
- âœ… ç¡®ä¿æ‰€æœ‰äº‘å‡½æ•°ç‰ˆæœ¬ä¸€è‡´æ€§

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„é€‰å‹](#æ¶æ„é€‰å‹)
2. [æ ‡å‡†ç›®å½•ç»“æ„](#æ ‡å‡†ç›®å½•ç»“æ„)
3. [å…¬å…±ä»£ç å¼•ç”¨è§„èŒƒ](#å…¬å…±ä»£ç å¼•ç”¨è§„èŒƒ) âš ï¸ **å¼ºåˆ¶è¦æ±‚**
4. [æ•°æ®åº“è¿æ¥è§„èŒƒ](#æ•°æ®åº“è¿æ¥è§„èŒƒ)
5. [å­—æ®µæ˜ å°„è§„èŒƒ](#å­—æ®µæ˜ å°„è§„èŒƒ)
6. [å…¬å…±æ¨¡å—åŒæ­¥æµç¨‹](#å…¬å…±æ¨¡å—åŒæ­¥æµç¨‹) ğŸ”„ **æ–°å¢**
7. [éƒ¨ç½²å‰å¼ºåˆ¶æ£€æŸ¥](#éƒ¨ç½²å‰å¼ºåˆ¶æ£€æŸ¥) ğŸš¨ **å¿…è¯»**
8. [éƒ¨ç½²æµç¨‹](#éƒ¨ç½²æµç¨‹)
9. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
10. [æ–‡æ¡£ç”Ÿæˆè§„èŒƒ](#æ–‡æ¡£ç”Ÿæˆè§„èŒƒ) âš ï¸ **å¼ºåˆ¶è¦æ±‚**
11. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
12. [å®æˆ˜æ¡ˆä¾‹ï¼šorder äº‘å‡½æ•°éƒ¨ç½²](#å®æˆ˜æ¡ˆä¾‹order-äº‘å‡½æ•°éƒ¨ç½²) ğŸ“–

---

## æ¶æ„é€‰å‹

### âœ… æ¨èæ–¹æ¡ˆï¼šæœ¬åœ°æ¨¡å— + CloudBase SDK

åŸºäº user å’Œ order äº‘å‡½æ•°çš„æˆåŠŸå®è·µï¼Œç¡®å®šä»¥ä¸‹æŠ€æœ¯æ ˆï¼š

| ç»„ä»¶ | æ–¹æ¡ˆ | åŸå›  |
|------|------|------|
| **ä»£ç ç»„ç»‡** | æœ¬åœ°æ¨¡å—ï¼ˆä¸ä½¿ç”¨ Layerï¼‰ | ç®€å•å¯é ï¼Œéƒ¨ç½²å¿«é€Ÿï¼Œæ˜“äºè°ƒè¯• |
| **å…¬å…±æ¨¡å—ç®¡ç†** | ç»Ÿä¸€å…¬å…±æ¨¡å— + åŒæ­¥è„šæœ¬ | é›†ä¸­ç»´æŠ¤ï¼Œä¸€é”®åŒæ­¥åˆ°æ‰€æœ‰äº‘å‡½æ•° |
| **æ•°æ®åº“è¿æ¥** | CloudBase Node SDK `rdb()` | å®˜æ–¹æ¨èï¼Œæ— éœ€é…ç½®ç¯å¢ƒå˜é‡ |
| **SQL æ–¹å¼** | æŸ¥è¯¢æ„å»ºå™¨ï¼ˆQuery Builderï¼‰ | ç±»å‹å®‰å…¨ï¼Œé˜²æ­¢ SQL æ³¨å…¥ |
| **è¿è¡Œæ—¶** | Nodejs18.15 | æœ€æ–°ç¨³å®šç‰ˆæœ¬ |
| **ä¾èµ–ç®¡ç†** | åœ¨çº¿å®‰è£… | è‡ªåŠ¨å¤„ç†ä¾èµ–ï¼Œå‡å°åŒ…ä½“ç§¯ |

### ğŸ“¦ å…¬å…±æ¨¡å—ç®¡ç†æ¶æ„

```
cloudfunctions/
â”œâ”€â”€ common/                    # ç»Ÿä¸€å…¬å…±æ¨¡å—ï¼ˆæºç ï¼‰âš ï¸ åœ¨è¿™é‡Œç»´æŠ¤
â”‚   â”œâ”€â”€ db.js                 # æ•°æ®åº“æ“ä½œ
â”‚   â”œâ”€â”€ auth.js               # æƒé™éªŒè¯
â”‚   â”œâ”€â”€ response.js           # å“åº”æ ¼å¼
â”‚   â””â”€â”€ utils.js              # å·¥å…·å‡½æ•°
â”œâ”€â”€ business-logic/            # ç»Ÿä¸€ä¸šåŠ¡é€»è¾‘æ¨¡å—ï¼ˆæºç ï¼‰âš ï¸ åœ¨è¿™é‡Œç»´æŠ¤
â”‚   â”œâ”€â”€ config.js             # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ points.js             # ç§¯åˆ†è®¡ç®—
â”‚   â”œâ”€â”€ ambassador.js         # å¤§ä½¿å‡çº§
â”‚   â”œâ”€â”€ payment.js            # å¾®ä¿¡æ”¯ä»˜
â”‚   â”œâ”€â”€ notification.js       # æ¶ˆæ¯é€šçŸ¥
â”‚   â”œâ”€â”€ order.js              # è®¢å•å¤„ç†
â”‚   â””â”€â”€ qrcode.js             # å°ç¨‹åºç 
â”œâ”€â”€ åŒæ­¥å…¬å…±æ¨¡å—.ps1            # ä¸€é”®åŒæ­¥è„šæœ¬
â”œâ”€â”€ user/                      # å„äº‘å‡½æ•°æ¨¡å—
â”‚   â”œâ”€â”€ common/               # ä»ç»Ÿä¸€æ¨¡å—åŒæ­¥
â”‚   â”œâ”€â”€ business-logic/       # ä»ç»Ÿä¸€æ¨¡å—åŒæ­¥
â”‚   â””â”€â”€ handlers/
â”œâ”€â”€ order/
â”‚   â”œâ”€â”€ common/               # ä»ç»Ÿä¸€æ¨¡å—åŒæ­¥
â”‚   â”œâ”€â”€ business-logic/       # ä»ç»Ÿä¸€æ¨¡å—åŒæ­¥
â”‚   â””â”€â”€ handlers/
â””â”€â”€ ...                        # å…¶ä»–äº‘å‡½æ•°æ¨¡å—
```

**ç®¡ç†åŸåˆ™**ï¼š
1. âœ… æ‰€æœ‰å…¬å…±ä»£ç ä¿®æ”¹åœ¨ `cloudfunctions/common` å’Œ `cloudfunctions/business-logic` è¿›è¡Œ
2. âœ… ä½¿ç”¨ `åŒæ­¥å…¬å…±æ¨¡å—.ps1` è„šæœ¬ä¸€é”®åŒæ­¥åˆ°æ‰€æœ‰äº‘å‡½æ•°
3. âœ… éƒ¨ç½²å‰å¿…é¡»å…ˆåŒæ­¥å…¬å…±æ¨¡å—ï¼Œç¡®ä¿ç‰ˆæœ¬ä¸€è‡´
4. âœ… åŒæ­¥è„šæœ¬ä¼šè‡ªåŠ¨æ’é™¤ `node_modules` å’Œ `package-lock.json`
5. âŒ ä¸è¦ç›´æ¥ä¿®æ”¹å„äº‘å‡½æ•°å†…çš„ common å’Œ business-logic ç›®å½•
6. âŒ ä¸è¦åœ¨å…¬å…±æ¨¡å—æºç ä¸­åŒ…å« `node_modules`ï¼ˆä¾èµ–åœ¨äº‘å‡½æ•°éƒ¨ç½²ååœ¨çº¿å®‰è£…ï¼‰

### âŒ ä¸æ¨èæ–¹æ¡ˆ

- âŒ **mysql2 ç›´æ¥è¿æ¥** - CloudBase MySQL ä¸æ”¯æŒæ ‡å‡† MySQL åè®®è¿æ¥
- âŒ **åŸå§‹ SQL å­—ç¬¦ä¸²æ‹¼æ¥** - å­—æ®µåæ˜“å‡ºé”™ï¼ŒSQL æ³¨å…¥é£é™©
- âŒ **Layer å±‚æœºåˆ¶**ï¼ˆæš‚æ—¶ï¼‰ - é…ç½®å¤æ‚ï¼Œè¿è¡Œæ—¶ç‰ˆæœ¬å…¼å®¹é—®é¢˜
- âŒ **N+1 æŸ¥è¯¢æ¨¡å¼** - æ€§èƒ½å·®ï¼Œåº”æ”¹ç”¨ JOIN æŸ¥è¯¢ï¼ˆåˆ©ç”¨å¤–é”®çº¦æŸï¼‰

---

## æ ‡å‡†ç›®å½•ç»“æ„

### æœ€ç»ˆéƒ¨ç½²ç»“æ„

```
cloudfunctions/
â””â”€â”€ {module_name}/           # å¦‚ï¼šuser, course, order ç­‰
    â”œâ”€â”€ index.js             # å…¥å£æ–‡ä»¶ï¼ˆâš ï¸ å¿…é¡»åˆå§‹åŒ– business-logicï¼‰
    â”œâ”€â”€ package.json         # ä¾èµ–å£°æ˜
    â”œâ”€â”€ cloudfunction.json   # äº‘å‡½æ•°é…ç½®
    â”œâ”€â”€ common/              # âš ï¸ å…¬å…±æ¨¡å—ï¼ˆå¿…é¡»å¤åˆ¶ï¼‰
    â”‚   â”œâ”€â”€ index.js         # ç»Ÿä¸€å¯¼å‡º
    â”‚   â”œâ”€â”€ db.js            # âœ… ä½¿ç”¨ CloudBase SDK
    â”‚   â”œâ”€â”€ auth.js          # æƒé™éªŒè¯
    â”‚   â”œâ”€â”€ response.js      # å“åº”æ ¼å¼
    â”‚   â””â”€â”€ utils.js         # å·¥å…·å‡½æ•°
    â”œâ”€â”€ business-logic/      # âš ï¸ ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆå¿…é¡»å¤åˆ¶ï¼‰
    â”‚   â”œâ”€â”€ index.js         # ç»Ÿä¸€å¯¼å‡º
    â”‚   â”œâ”€â”€ config.js        # é…ç½®ç®¡ç†
    â”‚   â”œâ”€â”€ points.js        # ç§¯åˆ†è®¡ç®—
    â”‚   â”œâ”€â”€ ambassador.js    # å¤§ä½¿å‡çº§
    â”‚   â”œâ”€â”€ payment.js       # å¾®ä¿¡æ”¯ä»˜
    â”‚   â”œâ”€â”€ notification.js  # æ¶ˆæ¯é€šçŸ¥
    â”‚   â”œâ”€â”€ order.js         # è®¢å•å¤„ç†
    â”‚   â”œâ”€â”€ qrcode.js        # å°ç¨‹åºç 
    â”‚   â””â”€â”€ node_modules/    # ä¾èµ–åŒ…
    â””â”€â”€ handlers/            # ä¸šåŠ¡å¤„ç†å™¨
        â”œâ”€â”€ public/          # å…¬å¼€æ¥å£ï¼ˆå¯é€‰ï¼‰
        â”œâ”€â”€ client/          # å®¢æˆ·ç«¯æ¥å£
        â”‚   â”œâ”€â”€ action1.js
        â”‚   â””â”€â”€ action2.js
        â””â”€â”€ admin/           # ç®¡ç†ç«¯æ¥å£
            â”œâ”€â”€ action1.js
            â””â”€â”€ action2.js
```

### require è·¯å¾„è§„åˆ™

```javascript
// âœ… æ­£ç¡®ï¼šå…¥å£æ–‡ä»¶ï¼ˆindex.jsï¼‰
const { response, checkClientAuth } = require('./common');
const business = require('./business-logic');  // âš ï¸ å¿…é¡»å¼•å…¥

// âœ… æ­£ç¡®ï¼šå®¢æˆ·ç«¯/ç®¡ç†ç«¯å¤„ç†å™¨
const { findOne, insert, update } = require('../../common/db');
const { response } = require('../../common');
const business = require('../../business-logic');  // âš ï¸ æŒ‰éœ€å¼•å…¥

// âŒ é”™è¯¯ï¼šä¸è¦ä½¿ç”¨ 'common'ï¼ˆä¼šæ‰¾ Layerï¼‰
const { response } = require('common');
const business = require('business-logic');
```

---

## å…¬å…±ä»£ç å¼•ç”¨è§„èŒƒ

### âš ï¸ å¼ºåˆ¶è¦æ±‚ï¼šå¿…é¡»å¤åˆ¶ common å’Œ business-logic

**æ‰€æœ‰äº‘å‡½æ•°éƒ½å¿…é¡»åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªå…¬å…±æ¨¡å—**ï¼š

#### 1. common æ¨¡å—ï¼ˆå¿…é¡»ï¼‰

**ç»Ÿä¸€å…¬å…±æ¨¡å—ä½ç½®**ï¼š`cloudfunctions/common/`

**å¤åˆ¶å‘½ä»¤**ï¼š
```bash
# ä»ç»Ÿä¸€çš„å…¬å…±æ¨¡å—å¤åˆ¶ âš ï¸ å¿…é¡»ä» cloudfunctions/common å¤åˆ¶
Copy-Item -Path "cloudfunctions\common" -Destination "cloudfunctions\{module_name}\common" -Recurse -Force
```

**ç”¨é€”**ï¼š
- `db.js` - æ•°æ®åº“æ“ä½œï¼ˆquery, findOne, insert, update, softDeleteï¼‰
- `auth.js` - æƒé™éªŒè¯ï¼ˆcheckClientAuth, checkAdminAuthï¼‰
- `response.js` - å“åº”æ ¼å¼ï¼ˆsuccess, error, paramErrorï¼‰
- `utils.js` - å·¥å…·å‡½æ•°ï¼ˆgenerateOrderNo, getPagination ç­‰ï¼‰

#### 2. business-logic æ¨¡å—ï¼ˆå¿…é¡»ï¼‰âš ï¸ **å¼ºåˆ¶è¦æ±‚**

**ç»Ÿä¸€å…¬å…±æ¨¡å—ä½ç½®**ï¼š`cloudfunctions/business-logic/`

**å¤åˆ¶å‘½ä»¤**ï¼š
```bash
# ä»ç»Ÿä¸€çš„å…¬å…±æ¨¡å—å¤åˆ¶ âš ï¸ å¿…é¡»ä» cloudfunctions/business-logic å¤åˆ¶
Copy-Item -Path "cloudfunctions\business-logic" -Destination "cloudfunctions\{module_name}\business-logic" -Recurse -Force
```

**ç”¨é€”**ï¼š
- `config.js` - é…ç½®ç®¡ç†ï¼ˆgetLevelConfig, getAllLevelConfigsï¼‰
- `points.js` - ç§¯åˆ†è®¡ç®—ï¼ˆcalculateMeritPoints, processReferralRewardï¼‰
- `ambassador.js` - å¤§ä½¿å‡çº§ï¼ˆcheckUpgradeEligibility, processAmbassadorUpgradeï¼‰
- `payment.js` - å¾®ä¿¡æ”¯ä»˜ï¼ˆcreateWechatPayment, verifyPaymentCallback, processRefundï¼‰
- `notification.js` - æ¶ˆæ¯é€šçŸ¥ï¼ˆsendSubscribeMessage, sendPaymentSuccessNoticeï¼‰
- `order.js` - è®¢å•å¤„ç†ï¼ˆgenerateOrderNo, generateUserCourseRecordï¼‰
- `qrcode.js` - å°ç¨‹åºç ï¼ˆgenerateShareQRCode, generateAmbassadorQRCodeï¼‰

**âš ï¸ é‡è¦è¯´æ˜**ï¼š
- **common å’Œ business-logic éƒ½æ˜¯å¿…è¦çš„å…¬å…±ä»£ç æ¨¡å—**
- å¿…é¡»ä» **cloudfunctions/common** å’Œ **cloudfunctions/business-logic** å¤åˆ¶
- è¿™ä¸¤ä¸ªç›®å½•æ˜¯ç»Ÿä¸€ç»´æŠ¤çš„å…¬å…±æ¨¡å—ï¼Œæ‰€æœ‰ä¿®æ”¹éƒ½åœ¨è¿™é‡Œè¿›è¡Œ
- ä½¿ç”¨ `åŒæ­¥å…¬å…±æ¨¡å—.ps1` è„šæœ¬å¯ä»¥ä¸€é”®åŒæ­¥åˆ°æ‰€æœ‰äº‘å‡½æ•°

### åˆå§‹åŒ– business-logicï¼ˆå¿…é¡»ï¼‰

**åœ¨å…¥å£æ–‡ä»¶ index.js ä¸­åˆå§‹åŒ–**ï¼š

```javascript
/**
 * {æ¨¡å—å}äº‘å‡½æ•°å…¥å£
 */
const cloud = require('wx-server-sdk');
const cloudbase = require('@cloudbase/node-sdk');
const { response, checkClientAuth, checkAdminAuth } = require('./common');
const business = require('./business-logic');  // âš ï¸ å¿…é¡»å¼•å…¥

// åˆå§‹åŒ–
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const app = cloudbase.init({ env: cloudbase.SYMBOL_CURRENT_ENV });

// âš ï¸ å¿…é¡»åˆå§‹åŒ– business-logic
business.init(cloud);

exports.main = async (event, context) => {
  // äº‘å‡½æ•°é€»è¾‘...
};
```

### ä½¿ç”¨ business-logic çš„åœºæ™¯

#### å¿…é¡»ä½¿ç”¨çš„åœºæ™¯

| åœºæ™¯ | ä½¿ç”¨å‡½æ•° | è¯´æ˜ |
|------|---------|------|
| ç”Ÿæˆè®¢å•å· | `business.generateOrderNo()` | ç»Ÿä¸€è®¢å•å·æ ¼å¼ |
| ç”Ÿæˆç”¨æˆ·è¯¾ç¨‹è®°å½• | `business.generateUserCourseRecord()` | è¯¾ç¨‹è´­ä¹°åå¤„ç† |
| å¤„ç†æ¨èäººå¥–åŠ± | `business.processReferralReward()` | æ¨èå¥–åŠ±è®¡ç®—å’Œå‘æ”¾ |
| å¤§ä½¿å‡çº§ | `business.processAmbassadorUpgrade()` | å¤§ä½¿å‡çº§å¤„ç† |
| å¾®ä¿¡æ”¯ä»˜ | `business.createWechatPayment()` | åˆ›å»ºæ”¯ä»˜è®¢å• |
| æ”¯ä»˜å›è°ƒ | `business.verifyPaymentCallback()` | éªŒè¯æ”¯ä»˜ç­¾å |
| è®¢å•é€€æ¬¾ | `business.processRefund()` | å¤„ç†é€€æ¬¾ |
| æ¶ˆæ¯é€šçŸ¥ | `business.sendSubscribeMessage()` | å‘é€è®¢é˜…æ¶ˆæ¯ |

#### ä½¿ç”¨ç¤ºä¾‹

```javascript
// handlers/client/create.js
const { generateOrderNo } = require('../../business-logic');

// ç”Ÿæˆè®¢å•å·
const order_no = generateOrderNo();  // ORD202602100001

// handlers/public/paymentCallback.js
const business = require('../../business-logic');

// ç”Ÿæˆç”¨æˆ·è¯¾ç¨‹è®°å½•
await business.generateUserCourseRecord({
  user_id: user.id,
  order_id: order.id,
  course_id: order.related_id
});

// å¤„ç†æ¨èäººå¥–åŠ±
await business.processReferralReward({
  order_id: order.id,
  user_id: user.id,
  referee_id: order.referee_id,
  order_amount: order.final_amount
});
```

### ä¸ºä»€ä¹ˆä½¿ç”¨æœ¬åœ°æ¨¡å—æ–¹å¼ï¼Ÿ

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **ç®€å•å¯é ** | ç›´æ¥å¤åˆ¶å³å¯ï¼Œæ— éœ€é¢å¤–é…ç½® |
| **éƒ¨ç½²å¿«é€Ÿ** | ç›´æ¥ä¸Šä¼ ï¼Œéƒ¨ç½²æµç¨‹ç®€å• |
| **ä¾¿äºè°ƒè¯•** | ä»£ç åœ¨æœ¬åœ°ï¼Œå®¹æ˜“å®šä½é—®é¢˜ |
| **ç‰ˆæœ¬ä¸€è‡´** | æ‰€æœ‰ä¾èµ–ç‰ˆæœ¬æ˜ç¡®å¯æ§ |
| **ç‹¬ç«‹ç»´æŠ¤** | æ¯ä¸ªäº‘å‡½æ•°å¯ç‹¬ç«‹æ›´æ–° |

### ä¸€é”®åŒæ­¥å·¥å…·

**æ¨èä½¿ç”¨åŒæ­¥è„šæœ¬**ï¼ˆä½äº `cloudfunctions/åŒæ­¥å…¬å…±æ¨¡å—.ps1`ï¼‰ï¼š

```powershell
# åœ¨ cloudfunctions ç›®å½•ä¸‹æ‰§è¡Œ
cd d:\project\cursor\work\xcx\cloudfunctions
.\åŒæ­¥å…¬å…±æ¨¡å—.ps1
```

**è„šæœ¬åŠŸèƒ½**ï¼š
- è‡ªåŠ¨å°† `common/` å’Œ `business-logic/` åŒæ­¥åˆ°æ‰€æœ‰äº‘å‡½æ•°æ¨¡å—
- æ”¯æŒæ¨¡å—ï¼šuser, order, course, ambassador, system
- è‡ªåŠ¨åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- è¦†ç›–å¼æ›´æ–°ï¼Œç¡®ä¿ç‰ˆæœ¬ä¸€è‡´

### æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰å¿…é¡»ç¡®è®¤ï¼š

- [ ] âœ… common/ ç›®å½•å·²ä» `cloudfunctions/common` å¤åˆ¶
- [ ] âœ… business-logic/ ç›®å½•å·²ä» `cloudfunctions/business-logic` å¤åˆ¶
- [ ] âœ… index.js å·²å¼•å…¥ business-logic
- [ ] âœ… index.js å·²åˆå§‹åŒ– business-logicï¼ˆbusiness.init(cloud)ï¼‰
- [ ] âœ… ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨äº† business-logic çš„ç›¸å…³å‡½æ•°
- [ ] âœ… æˆ–ä½¿ç”¨ `åŒæ­¥å…¬å…±æ¨¡å—.ps1` è„šæœ¬ä¸€é”®åŒæ­¥

---

## æ•°æ®åº“è¿æ¥è§„èŒƒ

### 1. common/db.js æ ‡å‡†å®ç°

**âœ… å¿…é¡»ä½¿ç”¨ CloudBase Node SDKï¼ˆSupabase é£æ ¼ APIï¼‰**

```javascript
/**
 * CloudBase æ•°æ®åº“ç»Ÿä¸€è®¿é—®å±‚
 * 
 * ä½¿ç”¨ @cloudbase/node-sdk åŸç”Ÿ Relational Database API
 * æ”¯æŒ Supabase é£æ ¼çš„ Query Builder
 * 
 * ç¯å¢ƒä¿¡æ¯ï¼š
 * - ç¯å¢ƒID: cloud1-0gnn3mn17b581124
 * - MySQLå®ä¾‹ID: tnt-e300s320g
 * - æ•°æ®åº“å: tiandao_culture
 * 
 * @see https://docs.cloudbase.net/database/relational-database
 */

const cloudbase = require('@cloudbase/node-sdk');

// åˆå§‹åŒ– CloudBaseï¼ˆè‡ªåŠ¨è¯†åˆ«ç¯å¢ƒï¼‰
const app = cloudbase.init({
  env: cloudbase.SYMBOL_CURRENT_ENV
});

// è·å–å…³ç³»å‹æ•°æ®åº“å®ä¾‹ï¼ˆSupabase é£æ ¼ï¼‰
const db = app.rdb({
  instanceId: process.env.DB_INSTANCE_ID || 'tnt-e300s320g',
  database: process.env.DB_NAME || 'tiandao_culture'
});

/**
 * æŸ¥è¯¢å•æ¡è®°å½•
 * 
 * @param {string} table - è¡¨å
 * @param {Object} where - æŸ¥è¯¢æ¡ä»¶
 * @returns {Promise<Object|null>} æŸ¥è¯¢ç»“æœ
 * 
 * @example
 * const user = await findOne('users', { id: 1 });
 * const order = await findOne('orders', { order_no: 'ORD20260210001' });
 * 
 * @note å½“è®°å½•ä¸å­˜åœ¨æ—¶è¿”å› nullï¼Œè€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
 */
async function findOne(table, where) {
  try {
    let query = db.from(table).select('*');
    
    // æ·»åŠ æŸ¥è¯¢æ¡ä»¶
    for (const [key, value] of Object.entries(where)) {
      query = query.eq(key, value);
    }
    
    const { data, error } = await query.single();
    
    // âš ï¸ å…³é”®ï¼šå¤„ç†è®°å½•ä¸å­˜åœ¨çš„æƒ…å†µ
    if (error) {
      // å¦‚æœé”™è¯¯æ˜¯"æœªæ‰¾åˆ°è®°å½•"ï¼Œè¿”å› null è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
      if (error.code === 'INVALID_REQUEST' && error.message.includes('0 rows')) {
        return null;
      }
      throw error;
    }
    
    return data || null;
  } catch (error) {
    console.error('[DB] findOne error:', error);
    throw error;
  }
}

/**
 * æŸ¥è¯¢å¤šæ¡è®°å½•
 * 
 * @param {string} table - è¡¨å
 * @param {Object} options - æŸ¥è¯¢é€‰é¡¹
 * @param {Object} options.where - æŸ¥è¯¢æ¡ä»¶
 * @param {Array<string>} options.columns - æŸ¥è¯¢å­—æ®µ
 * @param {Object} options.orderBy - æ’åº { column, ascending }
 * @param {number} options.limit - é™åˆ¶æ•°é‡
 * @param {number} options.offset - åç§»é‡
 * @returns {Promise<Array>} æŸ¥è¯¢ç»“æœ
 * 
 * @example
 * const users = await query('users', {
 *   where: { ambassador_level: 2 },
 *   orderBy: { column: 'created_at', ascending: false },
 *   limit: 10
 * });
 */
async function query(table, options = {}) {
  try {
    const { where = {}, columns = '*', orderBy, limit, offset } = options;
    
    let queryBuilder = db.from(table).select(columns);
    
    // æ·»åŠ æŸ¥è¯¢æ¡ä»¶
    for (const [key, value] of Object.entries(where)) {
      if (value === null) {
        queryBuilder = queryBuilder.is(key, null);
      } else {
        queryBuilder = queryBuilder.eq(key, value);
      }
    }
    
    // æ’åº
    if (orderBy) {
      queryBuilder = queryBuilder.order(orderBy.column, { 
        ascending: orderBy.ascending !== false 
      });
    }
    
    // åˆ†é¡µ
    if (limit !== undefined) {
      const start = offset || 0;
      const end = start + limit - 1;
      queryBuilder = queryBuilder.range(start, end);
    }
    
    const { data, error } = await queryBuilder;
    
    if (error) {
      throw error;
    }
    
    return data || [];
  } catch (error) {
    console.error('[DB] query error:', error);
    throw error;
  }
}

/**
 * æ’å…¥è®°å½•
 * 
 * @param {string} table - è¡¨å
 * @param {Object|Array} data - æ’å…¥æ•°æ®ï¼ˆå•æ¡æˆ–å¤šæ¡ï¼‰
 * @returns {Promise<Array>} æ’å…¥çš„è®°å½•
 * 
 * @example
 * const newUser = await insert('users', { name: 'John', email: 'john@example.com' });
 * const newUsers = await insert('users', [{ name: 'John' }, { name: 'Jane' }]);
 */
async function insert(table, data) {
  try {
    const { data: result, error } = await db
      .from(table)
      .insert(data)
      .select();
    
    if (error) {
      throw error;
    }
    
    return result;
  } catch (error) {
    console.error('[DB] insert error:', error);
    throw error;
  }
}

/**
 * æ›´æ–°è®°å½•
 * 
 * @param {string} table - è¡¨å
 * @param {Object} data - æ›´æ–°æ•°æ®
 * @param {Object} where - æ›´æ–°æ¡ä»¶
 * @returns {Promise<Array>} æ›´æ–°çš„è®°å½•
 * 
 * @example
 * await update('users', { name: 'Jane' }, { id: 1 });
 * await update('orders', { status: 1 }, { order_no: 'ORD20260210001' });
 */
async function update(table, data, where) {
  try {
    let queryBuilder = db.from(table).update(data);
    
    // æ·»åŠ æ›´æ–°æ¡ä»¶
    for (const [key, value] of Object.entries(where)) {
      queryBuilder = queryBuilder.eq(key, value);
    }
    
    const { data: result, error } = await queryBuilder.select();
    
    if (error) {
      throw error;
    }
    
    return result;
  } catch (error) {
    console.error('[DB] update error:', error);
    throw error;
  }
}

/**
 * è½¯åˆ é™¤è®°å½•ï¼ˆæ›´æ–° deleted_at å­—æ®µï¼‰
 * 
 * @param {string} table - è¡¨å
 * @param {Object} where - åˆ é™¤æ¡ä»¶
 * @returns {Promise<Array>} æ›´æ–°çš„è®°å½•
 * 
 * @example
 * await softDelete('users', { id: 1 });
 */
async function softDelete(table, where) {
  try {
    return await update(table, { deleted_at: new Date().toISOString() }, where);
  } catch (error) {
    console.error('[DB] softDelete error:', error);
    throw error;
  }
}

/**
 * ç»Ÿè®¡è®°å½•æ•°
 * 
 * @param {string} table - è¡¨å
 * @param {Object} where - æŸ¥è¯¢æ¡ä»¶
 * @returns {Promise<number>} è®°å½•æ•°é‡
 * 
 * @example
 * const total = await count('users', { ambassador_level: 2 });
 */
async function count(table, where = {}) {
  try {
    let queryBuilder = db.from(table).select('*', { count: 'exact', head: true });
    
    // æ·»åŠ æŸ¥è¯¢æ¡ä»¶
    for (const [key, value] of Object.entries(where)) {
      queryBuilder = queryBuilder.eq(key, value);
    }
    
    const { count: total, error } = await queryBuilder;
    
    if (error) {
      throw error;
    }
    
    return total || 0;
  } catch (error) {
    console.error('[DB] count error:', error);
    throw error;
  }
}

/**
 * Upsert æ“ä½œï¼ˆæ’å…¥æˆ–æ›´æ–°ï¼‰
 * 
 * @param {string} table - è¡¨å
 * @param {Object|Array} data - æ•°æ®
 * @param {Object} options - é€‰é¡¹
 * @param {Array<string>} options.onConflict - å†²çªå­—æ®µï¼ˆå”¯ä¸€é”®ï¼‰
 * @returns {Promise<Array>} æ’å…¥/æ›´æ–°çš„è®°å½•
 * 
 * @example
 * await upsert('users', 
 *   { id: 1, name: 'John', email: 'john@example.com' },
 *   { onConflict: ['id'] }
 * );
 */
async function upsert(table, data, options = {}) {
  try {
    const { onConflict = [] } = options;
    
    const { data: result, error } = await db
      .from(table)
      .upsert(data, { onConflict: onConflict.join(',') })
      .select();
    
    if (error) {
      throw error;
    }
    
    return result;
  } catch (error) {
    console.error('[DB] upsert error:', error);
    throw error;
  }
}

module.exports = {
  // åŸå§‹æ•°æ®åº“å®¢æˆ·ç«¯ï¼ˆSupabase é£æ ¼ï¼‰
  db,
  app,
  
  // ä¾¿æ·æŸ¥è¯¢æ–¹æ³•
  findOne,
  query,
  insert,
  update,
  softDelete,
  count,
  upsert
};
```

### 2. ä½¿ç”¨ç¤ºä¾‹

#### åŸºç¡€æŸ¥è¯¢ç¤ºä¾‹

```javascript
const { findOne, query, db } = require('../../common/db');

// æŸ¥è¯¢å•æ¡
const user = await findOne('users', { _openid: OPENID });

// æŸ¥è¯¢åˆ—è¡¨
const users = await query('users', {
  where: { ambassador_level: 1 },
  limit: 10,
  offset: 0,
  orderBy: { column: 'created_at', ascending: false }
});

// ç›´æ¥ä½¿ç”¨ Supabase é£æ ¼ APIï¼ˆæ¨èï¼‰
const { data, error } = await db
  .from('users')
  .select('*')
  .eq('ambassador_level', 2)
  .order('created_at', { ascending: false })
  .range(0, 9);
```

#### æ’å…¥ç¤ºä¾‹

```javascript
const { insert, db } = require('../../common/db');

// ä½¿ç”¨ä¾¿æ·æ–¹æ³•
const newUser = await insert('users', {
  uid: generateUID(),
  referee_code: 'ABC123',
  profile_completed: 0
});

// ç›´æ¥ä½¿ç”¨ Supabase é£æ ¼ API
const { data, error } = await db
  .from('users')
  .insert({ uid: generateUID(), referee_code: 'ABC123' })
  .select();
```

#### æ›´æ–°ç¤ºä¾‹

```javascript
const { update, db } = require('../../common/db');

// ä½¿ç”¨ä¾¿æ·æ–¹æ³•
await update('users', 
  { real_name: 'å¼ ä¸‰', phone: '13800138000' },
  { id: userId }
);

// ç›´æ¥ä½¿ç”¨ Supabase é£æ ¼ API
const { data, error } = await db
  .from('users')
  .update({ real_name: 'å¼ ä¸‰', phone: '13800138000' })
  .eq('id', userId)
  .select();
```

#### JOIN æŸ¥è¯¢ç¤ºä¾‹ï¼ˆåˆ©ç”¨å¤–é”®çº¦æŸï¼‰

```javascript
const { db } = require('../../common/db');

// æŸ¥è¯¢è®¢å•åŠå…³è”çš„ç”¨æˆ·å’Œæ¨èäººä¿¡æ¯
const { data: orders, error } = await db
  .from('orders')
  .select(`
    *,
    user:users!user_id(real_name, phone),
    referee:users!referee_id(real_name)
  `)
  .eq('pay_status', 1)
  .order('created_at', { ascending: false });

// æŸ¥è¯¢ç”¨æˆ·çš„è¯¾ç¨‹ï¼ˆé€šè¿‡ user_courses å…³è”ï¼‰
const { data: userCourses, error } = await db
  .from('user_courses')
  .select(`
    *,
    course:courses(name, cover_image, type)
  `)
  .eq('user_id', userId)
  .is('deleted_at', null);
```

#### è½¯åˆ é™¤å­—æ®µæ³¨æ„äº‹é¡¹ âš ï¸

**ä¸æ˜¯æ‰€æœ‰è¡¨éƒ½æœ‰ deleted_at å­—æ®µï¼**

æœ‰ `deleted_at` å­—æ®µçš„è¡¨ï¼š
- `users` - ç”¨æˆ·è¡¨
- `orders` - è®¢å•è¡¨
- `user_courses` - ç”¨æˆ·è¯¾ç¨‹å…³è”è¡¨
- `appointments` - é¢„çº¦è¡¨
- `class_records` - è¯¾ç¨‹è®°å½•è¡¨
- `exchange_records` - å…‘æ¢è®°å½•è¡¨

**æ²¡æœ‰** `deleted_at` å­—æ®µçš„è¡¨ï¼š
- `courses` - è¯¾ç¨‹è¡¨ âš ï¸
- `mall_goods` - å•†åŸå•†å“è¡¨
- `academy_cases` - å­¦é™¢æ¡ˆä¾‹è¡¨
- `banners` - Banner è¡¨

**ä½¿ç”¨å»ºè®®**ï¼š
```javascript
// âœ… å¯¹äºæœ‰ deleted_at çš„è¡¨
const { data } = await db
  .from('users')
  .select('*')
  .eq('id', userId)
  .is('deleted_at', null);  // âœ… æ­£ç¡®

// âœ… å¯¹äºæ²¡æœ‰ deleted_at çš„è¡¨
const { data } = await db
  .from('courses')
  .select('*')
  .eq('id', courseId);
  // âŒ ä¸è¦åŠ  .is('deleted_at', null)
```

---

## å­—æ®µæ˜ å°„è§„èŒƒ

### ğŸš¨ å…³é”®å­—æ®µåç§°ï¼ˆå¿…é¡»éµå®ˆï¼‰

| API æ–‡æ¡£å­—æ®µï¼ˆâŒé”™è¯¯ï¼‰ | æ•°æ®åº“å®é™…å­—æ®µï¼ˆâœ…æ­£ç¡®ï¼‰ | è¯´æ˜ |
|-------------------|-------------------|------|
| `referral_code` | `referee_code` | æ¨èç  |
| `cash_points` | `cash_points_available` | å¯ç”¨ç§¯åˆ† |
| `frozen_cash_points` | `cash_points_frozen` | å†»ç»“ç§¯åˆ† |
| - | `cash_points_pending` | å¾…ç»“ç®—ç§¯åˆ†ï¼ˆæ–°å¢ï¼‰ |

### ä¿®æ”¹æ¨¡æ¿

#### âŒ é”™è¯¯ä»£ç ï¼ˆä½¿ç”¨é”™è¯¯å­—æ®µåï¼‰

```javascript
// é”™è¯¯ï¼šæ¨èç å­—æ®µå
const user = await query('users', {
  where: { referral_code: 'ABC123' }
});

// é”™è¯¯ï¼šç§¯åˆ†å­—æ®µå
const available = user.cash_points;
const frozen = user.frozen_cash_points;
```

#### âœ… æ­£ç¡®ä»£ç ï¼ˆä½¿ç”¨æ­£ç¡®å­—æ®µåï¼‰

```javascript
// æ­£ç¡®ï¼šæ¨èç å­—æ®µå
const user = await findOne('users', { referee_code: 'ABC123' });

// æ­£ç¡®ï¼šç§¯åˆ†å­—æ®µå
const available = user.cash_points_available;
const frozen = user.cash_points_frozen;
const pending = user.cash_points_pending;
```

### å®Œæ•´å­—æ®µæ˜ å°„æ¸…å•

å‚è€ƒ `cloudfunctions/user/å­—æ®µæ˜ å°„è¯´æ˜.md` è·å–å®Œæ•´çš„ users è¡¨å­—æ®µåˆ—è¡¨ã€‚

---

## éƒ¨ç½²å‰å¼ºåˆ¶æ£€æŸ¥

### ğŸš¨ å…³é”®ï¼šéƒ¨ç½²å‰å¿…é¡»å®Œæˆä»¥ä¸‹æ£€æŸ¥

**åŸºäº order äº‘å‡½æ•°å®æˆ˜ç»éªŒæ€»ç»“ï¼Œéƒ¨ç½²å‰å¿…é¡»é€é¡¹æ£€æŸ¥ï¼Œé¿å…é‡å¤è¿”å·¥ï¼**

### æ£€æŸ¥æ¸…å• 1: require è·¯å¾„æ­£ç¡®æ€§ âš ï¸ **æœ€é«˜ä¼˜å…ˆçº§**

#### âœ… index.js å…¥å£æ–‡ä»¶

```javascript
// âœ… æ­£ç¡®ç¤ºä¾‹
const cloud = require('wx-server-sdk');
const { response, checkClientAuth, checkAdminAuth } = require('./common');
const business = require('./business-logic');

// âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆä¼šå¯¼è‡´éƒ¨ç½²å¤±è´¥ï¼‰
const { response } = require('common');           // âŒ ç¼ºå°‘ './'
const business = require('business-logic');       // âŒ ç¼ºå°‘ './'
```

#### âœ… handlers/**/*.js å¤„ç†å™¨æ–‡ä»¶

```javascript
// âœ… æ­£ç¡®ç¤ºä¾‹ï¼ˆæ‰€æœ‰ handlers æ–‡ä»¶ï¼‰
const { findOne, insert, update } = require('../../common/db');
const { response } = require('../../common');
const business = require('../../business-logic');

// âŒ é”™è¯¯ç¤ºä¾‹
const { findOne } = require('common/db');         // âŒ ç¼ºå°‘ '../../'
const { response } = require('common');           // âŒ ç¼ºå°‘ '../../'
const business = require('business-logic');       // âŒ ç¼ºå°‘ '../../'
```

#### ğŸ”§ æ‰¹é‡æ£€æŸ¥å‘½ä»¤

```powershell
# æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶çš„ require è·¯å¾„ï¼ˆåœ¨äº‘å‡½æ•°æ ¹ç›®å½•æ‰§è¡Œï¼‰
cd d:\project\cursor\work\xcx\cloudfunctions\{module_name}

# æ£€æŸ¥ index.js
Get-Content index.js | Select-String "require\('(common|business-logic)'\)"

# æ£€æŸ¥æ‰€æœ‰ handlers æ–‡ä»¶
Get-ChildItem -Recurse -Filter *.js -Path handlers | ForEach-Object {
    $content = Get-Content $_.FullName | Select-String "require\('(common|business-logic)'\)"
    if ($content) {
        Write-Host "âŒ é”™è¯¯ï¼š$($_.FullName)" -ForegroundColor Red
        $content
    }
}
```

### æ£€æŸ¥æ¸…å• 2: business-logic è°ƒç”¨æ–¹å¼ âš ï¸ **é«˜ä¼˜å…ˆçº§**

#### âœ… æ­£ç¡®çš„è°ƒç”¨æ–¹å¼

```javascript
// âœ… ç›´æ¥è°ƒç”¨ï¼ˆæ¨èï¼‰
const orderNo = business.generateOrderNo('ORD');
await business.processReferralReward(params);
await business.createWechatPayment(params);
await business.processAmbassadorUpgrade(params);

// âŒ é”™è¯¯çš„è°ƒç”¨æ–¹å¼ï¼ˆå­æ¨¡å—æ–¹å¼ï¼‰
const orderNo = business.order.generateOrderNo('ORD');      // âŒ
await business.points.processReferralReward(params);        // âŒ
await business.payment.createWechatPayment(params);         // âŒ
await business.ambassador.processAmbassadorUpgrade(params); // âŒ
```

#### business-logic å¯¼å‡ºæ¸…å•

å‚è€ƒ `business-logic/index.js`ï¼Œæ‰€æœ‰å‡½æ•°éƒ½ç›´æ¥å¯¼å‡ºï¼š

```javascript
module.exports = {
  init,                          // åˆå§‹åŒ–
  getLevelConfig,                // é…ç½®è¯»å–
  calculateMeritPoints,          // ç§¯åˆ†è®¡ç®—
  processReferralReward,         // æ¨èå¥–åŠ±
  checkUpgradeEligibility,       // å¤§ä½¿å‡çº§æ£€æŸ¥
  processAmbassadorUpgrade,      // å¤§ä½¿å‡çº§å¤„ç†
  createWechatPayment,           // å¾®ä¿¡æ”¯ä»˜
  verifyPaymentCallback,         // æ”¯ä»˜å›è°ƒéªŒè¯
  processRefund,                 // é€€æ¬¾å¤„ç†
  sendSubscribeMessage,          // è®¢é˜…æ¶ˆæ¯
  generateUserCourseRecord,      // ç”Ÿæˆè¯¾ç¨‹è®°å½•
  generateOrderNo,               // ç”Ÿæˆè®¢å•å·
  generateShareQRCode            // ç”Ÿæˆåˆ†äº«ç 
  // ...æ›´å¤šå‡½æ•°
};
```

#### ğŸ”§ æ‰¹é‡æ£€æŸ¥å‘½ä»¤

```powershell
# æ£€æŸ¥é”™è¯¯çš„ business-logic è°ƒç”¨ï¼ˆåœ¨äº‘å‡½æ•°æ ¹ç›®å½•æ‰§è¡Œï¼‰
Get-ChildItem -Recurse -Filter *.js -Path handlers | ForEach-Object {
    $content = Get-Content $_.FullName | Select-String "business\.(utils|payment|points|order|ambassador|notification|qrcode)\."
    if ($content) {
        Write-Host "âŒ é”™è¯¯ï¼š$($_.FullName)" -ForegroundColor Red
        $content
    }
}
```

### æ£€æŸ¥æ¸…å• 3: cloudfunction.json é…ç½®

#### âœ… æ­£ç¡®çš„é…ç½®ï¼ˆç²¾ç®€ç‰ˆï¼‰

```json
{
  "permissions": {
    "openapi": [
      "wxpay.unifiedOrder",
      "wxpay.refund",
      "subscribeMessage.send"
    ]
  },
  "triggers": []
}
```

#### âŒ é”™è¯¯çš„é…ç½®ï¼ˆå·²åºŸå¼ƒï¼‰

```json
{
  "permissions": { "openapi": [...] },
  "layers": [...],              // âŒ å·²åºŸå¼ƒï¼šä½¿ç”¨æœ¬åœ°æ¨¡å—æ–¹å¼
  "envVariables": {...},        // âŒ å·²åºŸå¼ƒï¼šCloudBase SDK è‡ªåŠ¨è¯†åˆ«ç¯å¢ƒ
  "triggers": []
}
```

### æ£€æŸ¥æ¸…å• 4: package.json ä¾èµ–

#### âœ… æ­£ç¡®çš„é…ç½®

```json
{
  "name": "{module_name}",
  "version": "1.0.0",
  "description": "{æ¨¡å—å}äº‘å‡½æ•°",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "latest",
    "@cloudbase/node-sdk": "latest",
    "jsonwebtoken": "^9.0.3"
  }
}
```

### ğŸ› ï¸ ä¸€é”®æ‰¹é‡ä¿®å¤å·¥å…·

#### ä¿®å¤æ‰€æœ‰ require è·¯å¾„

```powershell
# åœ¨äº‘å‡½æ•°æ ¹ç›®å½•æ‰§è¡Œ
cd d:\project\cursor\work\xcx\cloudfunctions\{module_name}

# ä¿®å¤ handlers ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
Get-ChildItem -Recurse -Filter *.js -Path handlers | ForEach-Object {
    (Get-Content $_.FullName -Raw) `
        -replace "require\('common/db'\)", "require('../../common/db')" `
        -replace "require\('common'\)", "require('../../common')" `
        -replace "require\('business-logic'\)", "require('../../business-logic')" |
    Set-Content $_.FullName -NoNewline
}

Write-Host "âœ… å·²ä¿®å¤æ‰€æœ‰ handlers æ–‡ä»¶çš„ require è·¯å¾„" -ForegroundColor Green
```

#### ä¿®å¤ index.js

```powershell
# ä¿®å¤ index.js çš„ require è·¯å¾„
(Get-Content index.js -Raw) `
    -replace "require\('common'\)", "require('./common')" `
    -replace "require\('business-logic'\)", "require('./business-logic')" |
Set-Content index.js -NoNewline

Write-Host "âœ… å·²ä¿®å¤ index.js çš„ require è·¯å¾„" -ForegroundColor Green
```

### ğŸ“‹ éƒ¨ç½²å‰ç»ˆææ£€æŸ¥æ¸…å•

åœ¨è¿è¡Œ `createFunction` æˆ– `updateFunctionCode` å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] âœ… index.js ä½¿ç”¨ `require('./common')` å’Œ `require('./business-logic')`
- [ ] âœ… æ‰€æœ‰ handlers æ–‡ä»¶ä½¿ç”¨ `require('../../common')`
- [ ] âœ… business-logic è°ƒç”¨ä½¿ç”¨ `business.functionName()` è€Œé `business.module.functionName()`
- [ ] âœ… cloudfunction.json åªåŒ…å« `permissions` å’Œ `triggers`
- [ ] âœ… package.json ä¾èµ–æ­£ç¡®ï¼ˆwx-server-sdk, @cloudbase/node-sdk, jsonwebtokenï¼‰
- [ ] âœ… common/ å’Œ business-logic/ ç›®å½•å·²å¤åˆ¶
- [ ] âœ… index.js å·²åˆå§‹åŒ– business-logic

**å®Œæˆä»¥ä¸Šæ£€æŸ¥åæ‰èƒ½éƒ¨ç½²ï¼Œå¦åˆ™å¿…å®šå¤±è´¥ï¼** ğŸš¨

---

## å…¬å…±æ¨¡å—åŒæ­¥æµç¨‹

### ğŸ”„ ä½•æ—¶éœ€è¦åŒæ­¥å…¬å…±æ¨¡å—

**å¿…é¡»åŒæ­¥çš„æƒ…å†µ**ï¼š
1. âœ… ä¿®æ”¹äº† `cloudfunctions/common` æˆ– `cloudfunctions/business-logic` ä¸­çš„ä»»ä½•ä»£ç 
2. âœ… åˆ›å»ºæ–°çš„äº‘å‡½æ•°æ¨¡å—
3. âœ… éƒ¨ç½²å‰ç¡®ä¿æ‰€æœ‰äº‘å‡½æ•°ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„å…¬å…±ä»£ç 
4. âœ… å‘ç°æŸä¸ªäº‘å‡½æ•°çš„å…¬å…±ä»£ç ç‰ˆæœ¬è¿‡æ—§

### ğŸ“‹ åŒæ­¥æ­¥éª¤

#### æ–¹æ³•1ï¼šä½¿ç”¨åŒæ­¥è„šæœ¬ï¼ˆæ¨èï¼‰â­

```powershell
# 1. è¿›å…¥ cloudfunctions ç›®å½•
cd d:\project\cursor\work\xcx\cloudfunctions

# 2. æ‰§è¡ŒåŒæ­¥è„šæœ¬
.\åŒæ­¥å…¬å…±æ¨¡å—.ps1

# è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
# - å°† common/ åŒæ­¥åˆ°æ‰€æœ‰äº‘å‡½æ•°ï¼ˆuser, order, course, ambassador, systemï¼‰
# - å°† business-logic/ åŒæ­¥åˆ°æ‰€æœ‰äº‘å‡½æ•°
# - æ˜¾ç¤ºåŒæ­¥è¿›åº¦å’Œç»“æœ
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
=== ğŸ”„ åŒæ­¥å…¬å…±æ¨¡å— ===

ğŸ“¦ åŒæ­¥åˆ° user æ¨¡å—...
  âœ… common å·²åŒæ­¥ï¼ˆæ’é™¤ node_modulesï¼‰
  âœ… business-logic å·²åŒæ­¥ï¼ˆæ’é™¤ node_modulesï¼‰

ğŸ“¦ åŒæ­¥åˆ° order æ¨¡å—...
  âœ… common å·²åŒæ­¥ï¼ˆæ’é™¤ node_modulesï¼‰
  âœ… business-logic å·²åŒæ­¥ï¼ˆæ’é™¤ node_modulesï¼‰
...

âœ… æ‰€æœ‰æ¨¡å—åŒæ­¥å®Œæˆï¼
ğŸ“ ä¸‹ä¸€æ­¥ï¼šéƒ¨ç½²æ›´æ–°çš„äº‘å‡½æ•°
```

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- âš¡ è‡ªåŠ¨æ’é™¤ `node_modules` å’Œ `package-lock.json`
- âš¡ åªå¤åˆ¶æºç æ–‡ä»¶ï¼ˆ.js, package.json ç­‰ï¼‰
- âš¡ åŒæ­¥é€Ÿåº¦å¿«ï¼š5ä¸ªæ¨¡å—ä»…éœ€å‡ ç§’
- âš¡ é¿å…å¤åˆ¶å‡ åMBçš„ä¾èµ–åŒ…

#### æ–¹æ³•2ï¼šæ‰‹åŠ¨åŒæ­¥ï¼ˆå•ä¸ªæ¨¡å—ï¼‰

```powershell
# åŒæ­¥åˆ°æŒ‡å®šæ¨¡å—
cd d:\project\cursor\work\xcx\cloudfunctions

# åŒæ­¥ common
Copy-Item -Path "common" -Destination "{module_name}\common" -Recurse -Force

# åŒæ­¥ business-logic
Copy-Item -Path "business-logic" -Destination "{module_name}\business-logic" -Recurse -Force
```

### âœ… åŒæ­¥åæ£€æŸ¥æ¸…å•

- [ ] âœ… æ‰€æœ‰ç›®æ ‡äº‘å‡½æ•°çš„ common/ ç›®å½•å·²æ›´æ–°
- [ ] âœ… æ‰€æœ‰ç›®æ ‡äº‘å‡½æ•°çš„ business-logic/ ç›®å½•å·²æ›´æ–°
- [ ] âœ… æ£€æŸ¥ require è·¯å¾„æ˜¯å¦æ­£ç¡®
- [ ] âœ… è¿è¡Œæµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
- [ ] âœ… éƒ¨ç½²æ›´æ–°çš„äº‘å‡½æ•°

### ğŸš¨ æ³¨æ„äº‹é¡¹

1. **ä¸è¦ç›´æ¥ä¿®æ”¹å„äº‘å‡½æ•°å†…çš„ common å’Œ business-logic**
   - âŒ é”™è¯¯ï¼šåœ¨ `user/common/db.js` ä¸­ä¿®æ”¹ä»£ç 
   - âœ… æ­£ç¡®ï¼šåœ¨ `cloudfunctions/common/db.js` ä¸­ä¿®æ”¹ï¼Œç„¶ååŒæ­¥

2. **åŒæ­¥åå¿…é¡»é‡æ–°éƒ¨ç½²äº‘å‡½æ•°**
   - ä»…åŒæ­¥ä»£ç ä¸ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ
   - å¿…é¡»ä½¿ç”¨ `updateFunctionCode` é‡æ–°éƒ¨ç½²

3. **æµ‹è¯•å……åˆ†åå†åŒæ­¥åˆ°ç”Ÿäº§ç¯å¢ƒ**
   - å…ˆåœ¨å•ä¸ªäº‘å‡½æ•°æµ‹è¯•ä¿®æ”¹
   - ç¡®è®¤æ— è¯¯åå†åŒæ­¥åˆ°æ‰€æœ‰æ¨¡å—

### ğŸ“– å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹

```powershell
# åœºæ™¯ï¼šä¿®å¤ db.js ä¸­çš„ä¸€ä¸ª bug

# 1. ä¿®æ”¹å…¬å…±æ¨¡å—
code cloudfunctions\common\db.js
# (åœ¨ç¼–è¾‘å™¨ä¸­ä¿®æ”¹ä»£ç )

# 2. åŒæ­¥åˆ°æ‰€æœ‰äº‘å‡½æ•°
cd cloudfunctions
.\åŒæ­¥å…¬å…±æ¨¡å—.ps1

# 3. éƒ¨ç½²éœ€è¦æ›´æ–°çš„äº‘å‡½æ•°ï¼ˆå‡è®¾æ˜¯ orderï¼‰
mcp_cloudbase_updateFunctionCode({
  name: "order",
  functionRootPath: "d:\\project\\cursor\\work\\xcx\\cloudfunctions"
})

# 4. æµ‹è¯•éªŒè¯
mcp_cloudbase_invokeFunction({
  name: "order",
  params: { action: "getList" }
})

# 5. ç¡®è®¤æ— è¯¯åï¼Œéƒ¨ç½²å…¶ä»–äº‘å‡½æ•°
# é‡å¤æ­¥éª¤ 3-4 for user, course, ambassador, system
```

---

## éƒ¨ç½²æµç¨‹

### æ­¥éª¤ 1ï¼šå‡†å¤‡ä»£ç 

#### 1.1 åˆ›å»ºäº‘å‡½æ•°ç›®å½•

```bash
cd d:\project\cursor\work\xcx\cloudfunctions
mkdir {module_name}
cd {module_name}
```

#### 1.2 å¤åˆ¶å…¬å…±æ¨¡å—ï¼ˆâš ï¸ å¿…é¡»ä»ç»Ÿä¸€å…¬å…±æ¨¡å—å¤åˆ¶ï¼‰

**æ–¹æ³•1ï¼šä½¿ç”¨åŒæ­¥è„šæœ¬ï¼ˆæ¨èï¼‰**
```powershell
# åœ¨ cloudfunctions ç›®å½•æ‰§è¡Œ
cd d:\project\cursor\work\xcx\cloudfunctions
.\åŒæ­¥å…¬å…±æ¨¡å—.ps1
```

**æ–¹æ³•2ï¼šæ‰‹åŠ¨å¤åˆ¶**
```powershell
# ä»ç»Ÿä¸€çš„å…¬å…±æ¨¡å—å¤åˆ¶ common å’Œ business-logic ç›®å½•
Copy-Item -Path "..\common" -Destination ".\common" -Recurse -Force
Copy-Item -Path "..\business-logic" -Destination ".\business-logic" -Recurse -Force
```

**âš ï¸ é‡è¦**ï¼š
- å¿…é¡»åŒæ—¶å¤åˆ¶ common å’Œ business-logic ä¸¤ä¸ªæ¨¡å—
- å¿…é¡»ä» `cloudfunctions/common` å’Œ `cloudfunctions/business-logic` å¤åˆ¶
- è¿™ä¸¤ä¸ªç›®å½•æ˜¯ç»Ÿä¸€ç»´æŠ¤çš„å…¬å…±æ¨¡å—æºç 

#### 1.3 åˆ›å»ºå…¥å£æ–‡ä»¶

```javascript
/**
 * {æ¨¡å—å}äº‘å‡½æ•°å…¥å£
 */
const cloud = require('wx-server-sdk');
const cloudbase = require('@cloudbase/node-sdk');
const { response, checkClientAuth, checkAdminAuth } = require('./common');

// åˆå§‹åŒ–
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const app = cloudbase.init({ env: cloudbase.SYMBOL_CURRENT_ENV });

// å¯¼å…¥å¤„ç†å™¨
const publicHandlers = {};
const clientHandlers = {};
const adminHandlers = {};

// è·¯ç”±é…ç½®
const ROUTES = {
  public: Object.keys(publicHandlers),
  client: Object.keys(clientHandlers),
  admin: Object.keys(adminHandlers)
};

exports.main = async (event, context) => {
  const { action } = event;
  const wxContext = cloud.getWXContext();
  const OPENID = wxContext.OPENID;

  console.log(`[${action}] æ”¶åˆ°è¯·æ±‚:`, { openid: OPENID?.slice(-6) });

  try {
    // å…¬å¼€æ¥å£ï¼ˆæ— éœ€ç™»å½•ï¼‰
    if (ROUTES.public.includes(action)) {
      return await publicHandlers[action](event, { OPENID });
    }

    // å®¢æˆ·ç«¯æ¥å£ï¼ˆéœ€ç”¨æˆ·é‰´æƒï¼‰
    if (ROUTES.client.includes(action)) {
      const user = await checkClientAuth(OPENID);
      return await clientHandlers[action](event, { OPENID, user });
    }

    // ç®¡ç†ç«¯æ¥å£ï¼ˆéœ€ç®¡ç†å‘˜é‰´æƒï¼‰
    if (ROUTES.admin.includes(action)) {
      const admin = await checkAdminAuth(OPENID);
      return await adminHandlers[action](event, { OPENID, admin });
    }

    return response.paramError(`æœªçŸ¥çš„æ“ä½œ: ${action}`);

  } catch (error) {
    console.error(`[${action}] æ‰§è¡Œå¤±è´¥:`, error);
    return response.error(error.message, error, error.code || 500);
  }
};
```

#### 1.4 åˆ›å»º package.json

```json
{
  "name": "{module_name}",
  "version": "1.0.0",
  "description": "{æ¨¡å—å}äº‘å‡½æ•°",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "latest",
    "@cloudbase/node-sdk": "latest",
    "jsonwebtoken": "^9.0.3"
  }
}
```

#### 1.5 åˆ›å»º cloudfunction.json

```json
{
  "permissions": {
    "openapi": []
  },
  "triggers": []
}
```

### æ­¥éª¤ 2ï¼šç¼–å†™ä¸šåŠ¡ä»£ç 

#### 2.1 Handler æ¨¡æ¿

```javascript
/**
 * å®¢æˆ·ç«¯æ¥å£ï¼š{æ¥å£è¯´æ˜}
 * Action: {action_name}
 */
const { findOne, insert, update, query } = require('../../common/db');
const { response } = require('../../common');
const business = require('../../business-logic');  // âš ï¸ æŒ‰éœ€å¼•å…¥

module.exports = async (event, context) => {
  const { OPENID, user } = context;
  const { param1, param2 } = event;

  try {
    console.log(`[${event.action}] å¤„ç†è¯·æ±‚:`, user.id);

    // âš ï¸ æ³¨æ„ï¼šä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
    // ç¤ºä¾‹ï¼šæŸ¥è¯¢æ¨èç 
    const referee = await findOne('users', {
      referee_code: param1  // âœ… ä½¿ç”¨ referee_code
    });

    // ä¸šåŠ¡é€»è¾‘...
    // å¦‚éœ€ä½¿ç”¨ business-logicï¼Œç›´æ¥è°ƒç”¨ï¼š
    // const orderNo = business.generateOrderNo('ORD');
    // await business.processReferralReward(params);

    return response.success(data, 'æ“ä½œæˆåŠŸ');

  } catch (error) {
    console.error(`[${event.action}] å¤±è´¥:`, error);
    return response.error('æ“ä½œå¤±è´¥', error);
  }
};
```

### æ­¥éª¤ 3ï¼šéƒ¨ç½²åˆ°äº‘ç«¯

#### 3.1 ä½¿ç”¨ MCP å·¥å…·éƒ¨ç½²

```javascript
// æ–¹æ³•1ï¼šåˆ›å»ºäº‘å‡½æ•°ï¼ˆé¦–æ¬¡ï¼‰
mcp_cloudbase_createFunction({
  name: "{module_name}",
  runtime: "Nodejs18.15",
  functionRootPath: "d:\\project\\cursor\\work\\xcx\\cloudfunctions",
  func: {
    name: "{module_name}",
    runtime: "Nodejs18.15",
    timeout: 60
  }
})

// æ–¹æ³•2ï¼šæ›´æ–°ä»£ç ï¼ˆåç»­ï¼‰
mcp_cloudbase_updateFunctionCode({
  name: "{module_name}",
  functionRootPath: "d:\\project\\cursor\\work\\xcx\\cloudfunctions"
})
```

#### 3.2 ç­‰å¾…éƒ¨ç½²å®Œæˆ

```bash
# ç­‰å¾… 10-30 ç§’è®©ä¾èµ–å®‰è£…å®Œæˆ
Start-Sleep -Seconds 10
```

---

## æµ‹è¯•éªŒè¯

### æ­¥éª¤ 1ï¼šæµ‹è¯•å•ä¸ªæ¥å£

```javascript
mcp_cloudbase_invokeFunction({
  name: "{module_name}",
  params: {
    action: "login"  // æ›¿æ¢ä¸ºå®é™… action
  }
})
```

### æ­¥éª¤ 2ï¼šéªŒè¯æ£€æŸ¥æ¸…å•

- [ ] âœ… äº‘å‡½æ•°éƒ¨ç½²æˆåŠŸ
- [ ] âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼ˆtiandao_cultureï¼‰
- [ ] âœ… å­—æ®µåç§°æ­£ç¡®ï¼ˆreferee_code, cash_points_*ï¼‰
- [ ] âœ… æ•°æ®æ’å…¥/æŸ¥è¯¢æˆåŠŸ
- [ ] âœ… å“åº”æ ¼å¼æ­£ç¡®
- [ ] âœ… é”™è¯¯å¤„ç†æ­£å¸¸

### æ­¥éª¤ 3ï¼šç”Ÿæˆæ–‡æ¡£

âš ï¸ **å¼ºåˆ¶è¦æ±‚ï¼šåªç”Ÿæˆä»¥ä¸‹ä¸¤ä¸ªæ–‡æ¡£**

#### å¿…é¡»ç”Ÿæˆçš„æ–‡æ¡£

1. **APIæ–‡æ¡£.md** - æ¥å£æ–‡æ¡£
   - æ‰€æœ‰æ¥å£çš„è¯¦ç»†è¯´æ˜
   - è¯·æ±‚å‚æ•°å’Œå“åº”æ ¼å¼
   - ä¸šåŠ¡é€»è¾‘è¯´æ˜
   - è°ƒç”¨ç¤ºä¾‹

2. **å¼€å‘æŠ¥å‘Š.md** - å¼€å‘æ€»ç»“
   - å®Œæˆå†…å®¹æ¸…å•
   - business-logic ä½¿ç”¨æƒ…å†µ
   - æŠ€æœ¯è§„èŒƒéµå¾ªæƒ…å†µ
   - å¾…å®Œå–„åŠŸèƒ½æ¸…å•

#### âŒ ç¦æ­¢ç”Ÿæˆçš„æ–‡æ¡£

- âŒ å¿«é€Ÿå‚è€ƒ.md
- âŒ APIæ–‡æ¡£-ç®€æ´ç‰ˆ.md
- âŒ Stepå®ŒæˆæŠ¥å‘Š.md
- âŒ äº¤ä»˜æ–‡æ¡£.md
- âŒ æ–‡æ¡£ç´¢å¼•.md
- âŒ è°ƒç”¨ç¤ºä¾‹.md
- âŒ å…¶ä»–ä»»ä½•é¢å¤–æ–‡æ¡£

#### æ–‡æ¡£æ¨¡æ¿

**APIæ–‡æ¡£.md ç»“æ„**ï¼š
```markdown
# {æ¨¡å—å} äº‘å‡½æ•° API æ–‡æ¡£

**ç‰ˆæœ¬**: V1.0
**æ¥å£æ•°**: {æ•°é‡}

## æ¥å£æ¸…å•
[è¡¨æ ¼å½¢å¼åˆ—å‡ºæ‰€æœ‰æ¥å£]

## å…¬å¼€æ¥å£
[è¯¦ç»†è¯´æ˜]

## å®¢æˆ·ç«¯æ¥å£
[è¯¦ç»†è¯´æ˜]

## ç®¡ç†ç«¯æ¥å£
[è¯¦ç»†è¯´æ˜]

## é”™è¯¯ç 
[é”™è¯¯ç è¯´æ˜]

## æ³¨æ„äº‹é¡¹
[é‡è¦æç¤º]
```

**å¼€å‘æŠ¥å‘Š.md ç»“æ„**ï¼š
```markdown
# {æ¨¡å—å} äº‘å‡½æ•°å¼€å‘æŠ¥å‘Š

**å®Œæˆæ—¶é—´**: {æ—¥æœŸ}
**çŠ¶æ€**: âœ… å·²å®Œæˆ

## å®Œæˆæ¸…å•
- âœ… ç›®å½•ç»“æ„
- âœ… common/ å·²å¤åˆ¶
- âœ… business-logic/ å·²å¤åˆ¶
- âœ… {æ•°é‡}ä¸ªæ¥å£å®ç°

## business-logic ä½¿ç”¨æƒ…å†µ
[åˆ—å‡ºä½¿ç”¨çš„å‡½æ•°]

## æŠ€æœ¯è§„èŒƒéµå¾ª
- âœ… CloudBase SDK rdb()
- âœ… æ­£ç¡®å­—æ®µå
- âœ… business-logic å·²åˆå§‹åŒ–

## å¾…å®Œå–„åŠŸèƒ½
[åˆ—å‡ºå¾…å¯ç”¨çš„åŠŸèƒ½]

## éƒ¨ç½²å‡†å¤‡
- âœ… ä¾èµ–é…ç½®æ­£ç¡®
- âœ… é…ç½®æ–‡ä»¶å®Œæ•´
- âœ… å…¬å…±ä»£ç å·²å¤åˆ¶

## ä¸‹ä¸€æ­¥
[éƒ¨ç½²å’Œæµ‹è¯•è®¡åˆ’]
```

---

## æ–‡æ¡£ç”Ÿæˆè§„èŒƒ

### âš ï¸ å¼ºåˆ¶è§„åˆ™

1. **åªç”Ÿæˆä¸¤ä¸ªæ–‡æ¡£**ï¼š
   - `APIæ–‡æ¡£.md` - æ¥å£æ–‡æ¡£
   - `å¼€å‘æŠ¥å‘Š.md` - å¼€å‘æ€»ç»“

2. **ç¦æ­¢ç”Ÿæˆå¤šä½™æ–‡æ¡£**ï¼š
   - ä¸è¦ç”Ÿæˆ"ç®€æ´ç‰ˆ"ã€"å¿«é€Ÿå‚è€ƒ"ç­‰å˜ä½“
   - ä¸è¦ç”Ÿæˆ"äº¤ä»˜æ–‡æ¡£"ã€"å®ŒæˆæŠ¥å‘Š"ç­‰é‡å¤æ–‡æ¡£
   - ä¸è¦ç”Ÿæˆ"æ–‡æ¡£ç´¢å¼•"ã€"è°ƒç”¨ç¤ºä¾‹"ç­‰é¢å¤–æ–‡æ¡£

3. **æ–‡æ¡£å†…å®¹è¦æ±‚**ï¼š
   - APIæ–‡æ¡£ï¼šå®Œæ•´è¯¦ç»†ï¼ŒåŒ…å«æ‰€æœ‰æ¥å£è¯´æ˜
   - å¼€å‘æŠ¥å‘Šï¼šç®€æ´æ˜äº†ï¼Œé‡ç‚¹çªå‡º

4. **æ–‡æ¡£å‘½åè§„èŒƒ**ï¼š
   - å¿…é¡»ä½¿ç”¨ä¸­æ–‡å‘½åï¼š`APIæ–‡æ¡£.md`ã€`å¼€å‘æŠ¥å‘Š.md`
   - ä¸è¦ä½¿ç”¨è‹±æ–‡æˆ–æ··åˆå‘½å

### æ£€æŸ¥æ¸…å•

æ–‡æ¡£ç”Ÿæˆåå¿…é¡»ç¡®è®¤ï¼š

- [ ] âœ… åªç”Ÿæˆäº† 2 ä¸ªæ–‡æ¡£
- [ ] âœ… APIæ–‡æ¡£.md å­˜åœ¨ä¸”å†…å®¹å®Œæ•´
- [ ] âœ… å¼€å‘æŠ¥å‘Š.md å­˜åœ¨ä¸”å†…å®¹å®Œæ•´
- [ ] âœ… æ²¡æœ‰å…¶ä»–å¤šä½™æ–‡æ¡£

---

## å¸¸è§é—®é¢˜

### Q1: Cannot find module 'common'

**åŸå› **: ä½¿ç”¨äº†é”™è¯¯çš„ require è·¯å¾„

**è§£å†³**:
```javascript
// âŒ é”™è¯¯
const { response } = require('common');

// âœ… æ­£ç¡®ï¼ˆå…¥å£æ–‡ä»¶ï¼‰
const { response } = require('./common');

// âœ… æ­£ç¡®ï¼ˆhandlers æ–‡ä»¶ï¼‰
const { response } = require('../../common');
```

### Q2: Cannot find module 'business-logic'

**åŸå› **: æœªå¤åˆ¶ business-logic ç›®å½•æˆ–è·¯å¾„é”™è¯¯

**è§£å†³**:
```powershell
# 1. å¤åˆ¶ business-logic ç›®å½•ï¼ˆä»ç»Ÿä¸€å…¬å…±æ¨¡å—ï¼‰
Copy-Item -Path "cloudfunctions\business-logic" -Destination "cloudfunctions\{module_name}\business-logic" -Recurse -Force

# æˆ–ä½¿ç”¨åŒæ­¥è„šæœ¬ï¼ˆæ¨èï¼‰
cd cloudfunctions
.\åŒæ­¥å…¬å…±æ¨¡å—.ps1

# 2. æ£€æŸ¥ require è·¯å¾„
# âœ… æ­£ç¡®ï¼ˆå…¥å£æ–‡ä»¶ï¼‰
const business = require('./business-logic');

# âœ… æ­£ç¡®ï¼ˆhandlers æ–‡ä»¶ï¼‰
const business = require('../../business-logic');
```

### Q3: business.init is not a function

**åŸå› **: æœªæ­£ç¡®åˆå§‹åŒ– business-logic

**è§£å†³**:
```javascript
// âœ… æ­£ç¡®çš„åˆå§‹åŒ–é¡ºåº
const cloud = require('wx-server-sdk');
const business = require('./business-logic');

cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
business.init(cloud);  // å¿…é¡»åœ¨ cloud.init() ä¹‹å
```

### Q4: æ•°æ®åº“è¿æ¥å¤±è´¥ï¼ˆECONNREFUSEDï¼‰

**åŸå› **: ä½¿ç”¨äº† mysql2 æˆ–é”™è¯¯çš„è¿æ¥æ–¹å¼

**è§£å†³**: 
1. å¿…é¡»ä½¿ç”¨ CloudBase SDKï¼š`app.rdb()`
2. æ­£ç¡®æŒ‡å®šå®ä¾‹å’Œæ•°æ®åº“ï¼š
```javascript
const db = app.rdb({
  instanceId: 'tnt-e300s320g',
  database: 'tiandao_culture'
});
```
3. âŒ ä¸è¦ä½¿ç”¨ mysql2 æˆ–æ ‡å‡† MySQL è¿æ¥æ–¹å¼

### Q5: å­—æ®µä¸å­˜åœ¨ï¼ˆreferral_codeï¼‰

**åŸå› **: ä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µå

**è§£å†³**: å‚è€ƒ [å­—æ®µæ˜ å°„è§„èŒƒ](#å­—æ®µæ˜ å°„è§„èŒƒ)ï¼Œä½¿ç”¨ `referee_code`

### Q6: query is not a function

**åŸå› **: common/index.js æ²¡æœ‰æ­£ç¡®å¯¼å‡º

**è§£å†³**:
```javascript
// common/index.js
const db = require('./db');
const response = require('./response');
const auth = require('./auth');
const utils = require('./utils');

module.exports = {
  db,
  response,
  auth,
  utils,
  // âœ… å…³é”®ï¼šè§£æ„å¯¼å‡º
  ...auth,
  ...response,
  ...utils,
  ...db  // å¯¼å‡º db çš„æ‰€æœ‰å‡½æ•°
};
```

### Q7: ä¾èµ–å®‰è£…å¤±è´¥

**åŸå› **: æœªå¯ç”¨åœ¨çº¿ä¾èµ–å®‰è£…

**è§£å†³**: é€šè¿‡æ§åˆ¶å°ç‚¹å‡»"ä¿å­˜å¹¶å®‰è£…ä¾èµ–"ï¼Œæˆ–ä½¿ç”¨ API è®¾ç½® `InstallDependency: TRUE`

### Q8: ç”Ÿæˆäº†å¤ªå¤šæ–‡æ¡£

**åŸå› **: æœªéµå¾ªæ–‡æ¡£ç”Ÿæˆè§„èŒƒ

**è§£å†³**:
- âœ… åªç”Ÿæˆ 2 ä¸ªæ–‡æ¡£ï¼š`APIæ–‡æ¡£.md`ã€`å¼€å‘æŠ¥å‘Š.md`
- âŒ åˆ é™¤å…¶ä»–å¤šä½™æ–‡æ¡£ï¼ˆå¿«é€Ÿå‚è€ƒã€ç®€æ´ç‰ˆã€äº¤ä»˜æ–‡æ¡£ç­‰ï¼‰

### Q9: Cannot read properties of undefined (reading 'verifyPaymentCallback') âš ï¸ **æ–°å¢**

**åŸå› **: business-logic è°ƒç”¨æ–¹å¼é”™è¯¯ï¼Œä½¿ç”¨äº†å­æ¨¡å—æ–¹å¼

**ç°è±¡**:
```javascript
// âŒ é”™è¯¯çš„è°ƒç”¨
business.payment.verifyPaymentCallback(event)
business.utils.generateOrderNo('ORD')
business.payment.createWechatPayment(params)
```

**è§£å†³**:
```javascript
// âœ… æ­£ç¡®çš„è°ƒç”¨ï¼ˆç›´æ¥è°ƒç”¨ï¼‰
business.verifyPaymentCallback(event)
business.generateOrderNo('ORD')
business.createWechatPayment(params)
```

**åŸå› åˆ†æ**: business-logic/index.js æ˜¯æ‰å¹³å¯¼å‡ºï¼Œä¸æ˜¯å­æ¨¡å—æ–¹å¼ï¼š
```javascript
// business-logic/index.js
module.exports = {
  init,
  createWechatPayment,      // ç›´æ¥å¯¼å‡º
  verifyPaymentCallback,    // ç›´æ¥å¯¼å‡º
  generateOrderNo,          // ç›´æ¥å¯¼å‡º
  processRefund,            // ç›´æ¥å¯¼å‡º
  // ...æ›´å¤šå‡½æ•°
};
```

**æ‰¹é‡æ£€æŸ¥å·¥å…·**:
```powershell
# æŸ¥æ‰¾æ‰€æœ‰é”™è¯¯çš„è°ƒç”¨
Get-ChildItem -Recurse -Filter *.js -Path handlers | ForEach-Object {
    $content = Get-Content $_.FullName | Select-String "business\.(utils|payment|points|order|ambassador|notification|qrcode)\."
    if ($content) {
        Write-Host "âŒ $($_.FullName)" -ForegroundColor Red
    }
}
```

### Q10: findOne æŸ¥è¯¢ä¸å­˜åœ¨çš„è®°å½•æ—¶æŠ›å‡ºé”™è¯¯ âš ï¸ **æ–°å¢**

**ç°è±¡**:
```
JSON object requested, multiple (or no) rows returned, The result contains 0 rows
```

**åŸå› **: 
CloudBase SDK çš„ `.single()` æ–¹æ³•åœ¨æœªæ‰¾åˆ°è®°å½•æ—¶ä¼šæŠ›å‡ºé”™è¯¯

**è§£å†³**:
åœ¨ common/db.js çš„ findOne å‡½æ•°ä¸­æ·»åŠ é”™è¯¯å¤„ç†ï¼š

```javascript
async function findOne(table, where) {
  try {
    let query = db.from(table).select('*');
    
    for (const [key, value] of Object.entries(where)) {
      query = query.eq(key, value);
    }
    
    const { data, error } = await query.single();
    
    // âš ï¸ å…³é”®ï¼šå¤„ç†è®°å½•ä¸å­˜åœ¨çš„æƒ…å†µ
    if (error) {
      if (error.code === 'INVALID_REQUEST' && error.message.includes('0 rows')) {
        return null;  // è¿”å› null è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
      }
      throw error;
    }
    
    return data || null;
  } catch (error) {
    console.error('[DB] findOne error:', error);
    throw error;
  }
}
```

### Q11: Unknown column 'deleted_at' in 'where clause' âš ï¸ **æ–°å¢**

**ç°è±¡**:
```
Unknown column 't0.deleted_at' in 'where clause'
```

**åŸå› **: 
ä¸æ˜¯æ‰€æœ‰è¡¨éƒ½æœ‰ `deleted_at` å­—æ®µï¼Œä¾‹å¦‚ `courses` è¡¨å°±æ²¡æœ‰

**è§£å†³**:
æŸ¥è¯¢å‰ç¡®è®¤è¡¨æ˜¯å¦æœ‰ `deleted_at` å­—æ®µï¼š

```javascript
// âŒ é”™è¯¯ï¼šcourses è¡¨æ²¡æœ‰ deleted_at å­—æ®µ
const { data } = await db
  .from('courses')
  .select('*')
  .eq('status', 1)
  .is('deleted_at', null);  // âŒ ä¼šæŠ¥é”™

// âœ… æ­£ç¡®ï¼šä¸æŸ¥è¯¢ deleted_at
const { data } = await db
  .from('courses')
  .select('*')
  .eq('status', 1);
```

**æœ‰ deleted_at å­—æ®µçš„è¡¨**ï¼šusers, orders, user_courses, appointments, class_records, exchange_records

**æ²¡æœ‰ deleted_at å­—æ®µçš„è¡¨**ï¼šcourses, mall_goods, academy_cases, banners

### Q12: å‚æ•°éªŒè¯å·¥å…·è¿”å› null å¯¼è‡´ç©ºæŒ‡é’ˆé”™è¯¯ âš ï¸ **æ–°å¢**

**ç°è±¡**:
```
Cannot read properties of null (reading 'valid')
```

**åŸå› **: 
`validateRequired` å·¥å…·å‡½æ•°å¯èƒ½è¿”å› nullï¼Œå¯¼è‡´è®¿é—® `.valid` å±æ€§æ—¶å‡ºé”™

**è§£å†³**:
ä½¿ç”¨ç®€å•çš„å‚æ•°éªŒè¯æ–¹å¼ï¼š

```javascript
// âŒ é”™è¯¯ï¼švalidateRequired å¯èƒ½è¿”å› null
const validation = validateRequired({ id }, ['id']);
if (!validation.valid) {
  return response.paramError(validation.message);
}

// âœ… æ­£ç¡®ï¼šç®€å•éªŒè¯
if (!id) {
  return response.paramError('ç¼ºå°‘å¿…è¦å‚æ•°: id');
}

// âœ… æ­£ç¡®ï¼šå¤šå‚æ•°éªŒè¯
const missingParams = [];
if (!id) missingParams.push('id');
if (!name) missingParams.push('name');

if (missingParams.length > 0) {
  return response.paramError(`ç¼ºå°‘å¿…è¦å‚æ•°: ${missingParams.join(', ')}`);
}
```

### Q13: åŒæ­¥å…¬å…±æ¨¡å—æ—¶æ˜¯å¦éœ€è¦å¤åˆ¶ node_modulesï¼Ÿ âš ï¸ **æ–°å¢**

**ç­”æ¡ˆ**: âŒ ä¸éœ€è¦ï¼Œå¿…é¡»æ’é™¤ node_modules

**åŸå› **ï¼š
1. âœ… ä¾èµ–åœ¨äº‘å‡½æ•°éƒ¨ç½²ååœ¨çº¿å®‰è£…ï¼ˆé€šè¿‡ package.jsonï¼‰
2. âœ… node_modules ä½“ç§¯å¤§ï¼ˆå‡ åMBï¼‰ï¼Œå¤åˆ¶åŒæ­¥æ—¶é—´æé•¿
3. âœ… å„äº‘å‡½æ•°ä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„ node_modules
4. âœ… å…¬å…±æ¨¡å—æºç åªéœ€è¦ä¿ç•™ .js æºæ–‡ä»¶å’Œ package.json

**æ­£ç¡®åšæ³•**ï¼š
```powershell
# 1. åˆ é™¤å…¬å…±æ¨¡å—æºç ä¸­çš„ node_modulesï¼ˆå¦‚æœå­˜åœ¨ï¼‰
cd d:\project\cursor\work\xcx\cloudfunctions\business-logic
if (Test-Path node_modules) {
    Remove-Item node_modules -Recurse -Force
    Write-Host "å·²åˆ é™¤ node_modules"
}

# 2. ä½¿ç”¨åŒæ­¥è„šæœ¬ï¼ˆå·²è‡ªåŠ¨æ’é™¤ node_modulesï¼‰
cd ..
.\åŒæ­¥å…¬å…±æ¨¡å—.ps1
# è„šæœ¬ä¼šè‡ªåŠ¨æ’é™¤ node_modules å’Œ package-lock.json
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] âœ… `cloudfunctions/common` æ—  node_modules ç›®å½•
- [ ] âœ… `cloudfunctions/business-logic` æ—  node_modules ç›®å½•
- [ ] âœ… åªä¿ç•™ .jsã€package.json ç­‰æºç æ–‡ä»¶
- [ ] âœ… ä½¿ç”¨åŒæ­¥è„šæœ¬æ—¶é€Ÿåº¦å¿«ï¼ˆå‡ ç§’å†…å®Œæˆï¼‰

### Q14: å¦‚ä½•ç¡®ä¿æ‰€æœ‰äº‘å‡½æ•°çš„å…¬å…±ä»£ç ç‰ˆæœ¬ä¸€è‡´ï¼Ÿ âš ï¸ **æ–°å¢**

**åœºæ™¯**: ä¿®æ”¹äº†å…¬å…±æ¨¡å—ä»£ç ï¼Œå¦‚ä½•åŒæ­¥åˆ°æ‰€æœ‰äº‘å‡½æ•°ï¼Ÿ

**è§£å†³**: ä½¿ç”¨ç»Ÿä¸€å…¬å…±æ¨¡å— + åŒæ­¥è„šæœ¬

**æ­¥éª¤**ï¼š
```powershell
# 1. åœ¨ç»Ÿä¸€å…¬å…±æ¨¡å—ä¿®æ”¹ä»£ç 
code cloudfunctions\common\db.js  # æˆ– business-logic\*.js

# 2. ä½¿ç”¨åŒæ­¥è„šæœ¬ä¸€é”®åŒæ­¥åˆ°æ‰€æœ‰äº‘å‡½æ•°
cd cloudfunctions
.\åŒæ­¥å…¬å…±æ¨¡å—.ps1

# 3. éªŒè¯åŒæ­¥ç»“æœ
Get-ChildItem -Path "user\common\db.js", "order\common\db.js", "course\common\db.js" | 
  ForEach-Object { 
    Write-Host "æ£€æŸ¥: $($_.FullName)"
    (Get-FileHash $_.FullName).Hash 
  }
# å¦‚æœæ‰€æœ‰æ–‡ä»¶çš„ Hash ç›¸åŒï¼Œè¯´æ˜åŒæ­¥æˆåŠŸ

# 4. éƒ¨ç½²æ›´æ–°çš„äº‘å‡½æ•°
# é€ä¸ªéƒ¨ç½² user, order, course, ambassador, system
```

**æ³¨æ„äº‹é¡¹**ï¼š
- âœ… å§‹ç»ˆåœ¨ `cloudfunctions/common` å’Œ `cloudfunctions/business-logic` ä¿®æ”¹ä»£ç 
- âœ… ä¿®æ”¹åä½¿ç”¨åŒæ­¥è„šæœ¬åŒæ­¥åˆ°æ‰€æœ‰äº‘å‡½æ•°
- âœ… åŒæ­¥åå¿…é¡»é‡æ–°éƒ¨ç½²äº‘å‡½æ•°æ‰èƒ½ç”Ÿæ•ˆ
- âŒ ä¸è¦ç›´æ¥ä¿®æ”¹å„äº‘å‡½æ•°å†…çš„ common å’Œ business-logic ç›®å½•

### Q15: æ‰¹é‡ä¿®å¤ require è·¯å¾„çš„æœ€å¿«æ–¹æ³•ï¼Ÿ âš ï¸ **æ–°å¢**

**åœºæ™¯**: å‘ç°æ‰€æœ‰ handlers æ–‡ä»¶çš„ require è·¯å¾„éƒ½é”™äº†ï¼Œå¦‚ä½•å¿«é€Ÿä¿®å¤ï¼Ÿ

**è§£å†³**: ä½¿ç”¨ PowerShell æ‰¹é‡ä¿®å¤è„šæœ¬

```powershell
# åœ¨äº‘å‡½æ•°æ ¹ç›®å½•æ‰§è¡Œ
cd d:\project\cursor\work\xcx\cloudfunctions\{module_name}

# 1. ä¿®å¤æ‰€æœ‰ handlers æ–‡ä»¶
Get-ChildItem -Recurse -Filter *.js -Path handlers | ForEach-Object {
    (Get-Content $_.FullName -Raw) `
        -replace "require\('common/db'\)", "require('../../common/db')" `
        -replace "require\('common'\)", "require('../../common')" `
        -replace "require\('business-logic'\)", "require('../../business-logic')" |
    Set-Content $_.FullName -NoNewline
}

# 2. ä¿®å¤ index.js
(Get-Content index.js -Raw) `
    -replace "require\('common'\)", "require('./common')" `
    -replace "require\('business-logic'\)", "require('./business-logic')" |
Set-Content index.js -NoNewline

Write-Host "âœ… ä¿®å¤å®Œæˆ" -ForegroundColor Green
```

**éªŒè¯ä¿®å¤ç»“æœ**:
```powershell
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é”™è¯¯çš„ require
Get-ChildItem -Recurse -Filter *.js | ForEach-Object {
    $content = Get-Content $_.FullName | Select-String "require\('(common|business-logic)'\)"
    if ($content -and $_.Name -ne "index.js") {
        Write-Host "âŒ ä»æœ‰é”™è¯¯ï¼š$($_.FullName)" -ForegroundColor Red
    }
}
```

---

## ğŸ“ æ ‡å‡†æ£€æŸ¥æ¸…å•

### ğŸš¨ éƒ¨ç½²å‰å¿…æŸ¥ï¼ˆåŸºäº order å®æˆ˜ç»éªŒä¼˜åŒ–ï¼‰

**åœ¨è¿è¡Œ createFunction æˆ– updateFunctionCode å‰ï¼Œè¯·é€é¡¹ç¡®è®¤ï¼š**

### 1ï¸âƒ£ require è·¯å¾„æ£€æŸ¥ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰âš ï¸

#### index.js å…¥å£æ–‡ä»¶
- [ ] âœ… ä½¿ç”¨ `require('./common')` è€Œé `require('common')`
- [ ] âœ… ä½¿ç”¨ `require('./business-logic')` è€Œé `require('business-logic')`

#### handlers/**/*.js å¤„ç†å™¨æ–‡ä»¶
- [ ] âœ… æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨ `require('../../common')` è€Œé `require('common')`
- [ ] âœ… æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨ `require('../../common/db')` è€Œé `require('common/db')`
- [ ] âœ… æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨ `require('../../business-logic')` è€Œé `require('business-logic')`

**å¿«é€ŸéªŒè¯å‘½ä»¤**:
```powershell
# æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯çš„ requireï¼ˆåœ¨äº‘å‡½æ•°ç›®å½•æ‰§è¡Œï¼‰
Get-ChildItem -Recurse -Filter *.js | Where-Object { $_.DirectoryName -like "*handlers*" } | ForEach-Object {
    $content = Get-Content $_.FullName | Select-String "require\('(common|business-logic)'\)"
    if ($content) { Write-Host "âŒ $($_.FullName)" -ForegroundColor Red }
}
```

### 2ï¸âƒ£ business-logic è°ƒç”¨æ–¹å¼æ£€æŸ¥ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰âš ï¸

- [ ] âœ… ä½¿ç”¨ `business.generateOrderNo()` è€Œé `business.utils.generateOrderNo()`
- [ ] âœ… ä½¿ç”¨ `business.createWechatPayment()` è€Œé `business.payment.createWechatPayment()`
- [ ] âœ… ä½¿ç”¨ `business.processRefund()` è€Œé `business.payment.processRefund()`
- [ ] âœ… ä½¿ç”¨ `business.verifyPaymentCallback()` è€Œé `business.payment.verifyPaymentCallback()`
- [ ] âœ… æ‰€æœ‰ business-logic è°ƒç”¨éƒ½æ˜¯ç›´æ¥è°ƒç”¨ï¼Œä¸ä½¿ç”¨å­æ¨¡å—æ–¹å¼

**å¿«é€ŸéªŒè¯å‘½ä»¤**:
```powershell
# æ£€æŸ¥é”™è¯¯çš„ business-logic è°ƒç”¨
Get-ChildItem -Recurse -Filter *.js -Path handlers | ForEach-Object {
    $content = Get-Content $_.FullName | Select-String "business\.(utils|payment|points|order|ambassador|notification|qrcode)\."
    if ($content) { Write-Host "âŒ $($_.FullName)" -ForegroundColor Red }
}
```

### 3ï¸âƒ£ é…ç½®æ–‡ä»¶æ£€æŸ¥

#### cloudfunction.json
- [ ] âœ… åªåŒ…å« `permissions` å’Œ `triggers`
- [ ] âœ… ä¸åŒ…å«å·²åºŸå¼ƒçš„ `layers` å’Œ `envVariables` é…ç½®

#### package.json
- [ ] âœ… åŒ…å« `wx-server-sdk: latest`
- [ ] âœ… åŒ…å« `@cloudbase/node-sdk: latest`
- [ ] âœ… åŒ…å« `jsonwebtoken: ^9.0.3`

### 4ï¸âƒ£ å…¬å…±ä»£ç æ£€æŸ¥ï¼ˆå¼ºåˆ¶è¦æ±‚ï¼‰âš ï¸

- [ ] âœ… common/ ç›®å½•å·²ä» `cloudfunctions/common` å¤åˆ¶
- [ ] âœ… business-logic/ ç›®å½•å·²ä» `cloudfunctions/business-logic` å¤åˆ¶
- [ ] âœ… æˆ–ä½¿ç”¨ `åŒæ­¥å…¬å…±æ¨¡å—.ps1` è„šæœ¬åŒæ­¥
- [ ] âœ… index.js å·²å¼•å…¥å¹¶åˆå§‹åŒ– business-logic
- [ ] âœ… ä¸¤ä¸ªæ¨¡å—éƒ½å¿…é¡»å­˜åœ¨ï¼Œç¼ºä¸€ä¸å¯

### 5ï¸âƒ£ ä»£ç è§„èŒƒæ£€æŸ¥

- [ ] âœ… ä½¿ç”¨ CloudBase SDK `rdb()` è¿æ¥æ•°æ®åº“ï¼ˆcommon/db.jsï¼‰
- [ ] âœ… æ‰€æœ‰å­—æ®µåç§°æ­£ç¡®ï¼ˆreferee_code, cash_points_available, cash_points_frozenï¼‰
- [ ] âœ… å“åº”æ ¼å¼ç»Ÿä¸€ï¼ˆä½¿ç”¨ response.success/error/paramErrorï¼‰
- [ ] âœ… é”™è¯¯å¤„ç†å®Œæ•´ï¼ˆtry-catch + console.errorï¼‰
- [ ] âœ… æ—¥å¿—è¾“å‡ºè§„èŒƒï¼ˆåŒ…å« action åç§°ï¼‰

### 6ï¸âƒ£ æ–‡æ¡£ç”Ÿæˆæ£€æŸ¥ï¼ˆå¼ºåˆ¶è¦æ±‚ï¼‰

- [ ] âœ… åªç”Ÿæˆäº† 2 ä¸ªæ–‡æ¡£ï¼š`APIæ–‡æ¡£.md`ã€`å¼€å‘æŠ¥å‘Š.md`
- [ ] âœ… APIæ–‡æ¡£.md å†…å®¹å®Œæ•´ï¼ˆåŒ…å«æ‰€æœ‰æ¥å£è¯´æ˜ï¼‰
- [ ] âœ… å¼€å‘æŠ¥å‘Š.md å†…å®¹å®Œæ•´ï¼ˆåŒ…å«æŠ€æœ¯è§„èŒƒã€business-logic ä½¿ç”¨æƒ…å†µï¼‰
- [ ] âœ… æ²¡æœ‰å…¶ä»–å¤šä½™æ–‡æ¡£ï¼ˆå¿«é€Ÿå‚è€ƒã€ç®€æ´ç‰ˆç­‰ï¼‰

### 7ï¸âƒ£ éƒ¨ç½²å‰æœ€ç»ˆç¡®è®¤

- [ ] âœ… å·²è¿è¡Œæ‰€æœ‰éªŒè¯å‘½ä»¤ï¼Œæ— é”™è¯¯æç¤º
- [ ] âœ… å·²ä½¿ç”¨æ‰¹é‡ä¿®å¤å·¥å…·ä¿®å¤æ‰€æœ‰é—®é¢˜
- [ ] âœ… è¿è¡Œæ—¶ç‰ˆæœ¬ï¼šNodejs18.15
- [ ] âœ… å‡†å¤‡å¥½æµ‹è¯•æ‰€æœ‰æ¥å£ï¼ˆåŒ…æ‹¬å…¬å¼€ã€å®¢æˆ·ç«¯ã€ç®¡ç†ç«¯ï¼‰

### ğŸ¯ ä¸€é”®æ£€æŸ¥è„šæœ¬

å¤åˆ¶ä»¥ä¸‹è„šæœ¬åˆ° PowerShell æ‰§è¡Œå®Œæ•´æ£€æŸ¥ï¼š

```powershell
# åœ¨äº‘å‡½æ•°ç›®å½•æ‰§è¡Œ
$errors = 0

Write-Host "`n=== 1. æ£€æŸ¥ index.js require è·¯å¾„ ===" -ForegroundColor Cyan
$result = Get-Content index.js | Select-String "require\('(common|business-logic)'\)"
if ($result) {
    Write-Host "âŒ index.js æœ‰é”™è¯¯çš„ require" -ForegroundColor Red
    $result
    $errors++
} else {
    Write-Host "âœ… index.js require è·¯å¾„æ­£ç¡®" -ForegroundColor Green
}

Write-Host "`n=== 2. æ£€æŸ¥ handlers require è·¯å¾„ ===" -ForegroundColor Cyan
Get-ChildItem -Recurse -Filter *.js -Path handlers | ForEach-Object {
    $result = Get-Content $_.FullName | Select-String "require\('(common|business-logic)'\)"
    if ($result) {
        Write-Host "âŒ $($_.Name)" -ForegroundColor Red
        $errors++
    }
}
if ($errors -eq 0) {
    Write-Host "âœ… æ‰€æœ‰ handlers require è·¯å¾„æ­£ç¡®" -ForegroundColor Green
}

Write-Host "`n=== 3. æ£€æŸ¥ business-logic è°ƒç”¨ ===" -ForegroundColor Cyan
$businessErrors = 0
Get-ChildItem -Recurse -Filter *.js -Path handlers | ForEach-Object {
    $result = Get-Content $_.FullName | Select-String "business\.(utils|payment|points|order|ambassador|notification|qrcode)\."
    if ($result) {
        Write-Host "âŒ $($_.Name)" -ForegroundColor Red
        $businessErrors++
    }
}
if ($businessErrors -eq 0) {
    Write-Host "âœ… business-logic è°ƒç”¨æ–¹å¼æ­£ç¡®" -ForegroundColor Green
} else {
    $errors += $businessErrors
}

Write-Host "`n=== 4. æ£€æŸ¥ cloudfunction.json ===" -ForegroundColor Cyan
try {
    $config = Get-Content cloudfunction.json | ConvertFrom-Json
    if ($config.layers -or $config.envVariables) {
        Write-Host "âŒ cloudfunction.json åŒ…å«å·²åºŸå¼ƒçš„é…ç½®" -ForegroundColor Red
        $errors++
    } else {
        Write-Host "âœ… cloudfunction.json é…ç½®æ­£ç¡®" -ForegroundColor Green
    }
} catch {
    Write-Host "âš ï¸ æ— æ³•è§£æ cloudfunction.json" -ForegroundColor Yellow
}

Write-Host "`n=== æ£€æŸ¥ç»“æœ ===" -ForegroundColor Cyan
if ($errors -eq 0) {
    Write-Host "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥éƒ¨ç½²ï¼" -ForegroundColor Green
} else {
    Write-Host "âŒ å‘ç° $errors ä¸ªé”™è¯¯ï¼Œè¯·ä¿®å¤åå†éƒ¨ç½²ï¼" -ForegroundColor Red
}
```

**åªæœ‰æ‰€æœ‰æ£€æŸ¥é€šè¿‡åï¼Œæ‰èƒ½æ‰§è¡Œéƒ¨ç½²ï¼** ğŸš€

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- âœ… [login æ¥å£æµ‹è¯•æŠ¥å‘Š](cloudfunctions/user/loginæ¥å£æµ‹è¯•æŠ¥å‘Š.md) - æˆåŠŸæ¡ˆä¾‹
- âœ… [å­—æ®µæ˜ å°„è¯´æ˜](cloudfunctions/user/å­—æ®µæ˜ å°„è¯´æ˜.md) - å­—æ®µè§„èŒƒ
- âœ… [éƒ¨ç½²æˆåŠŸæ€»ç»“](cloudfunctions/user/docs/éƒ¨ç½²æˆåŠŸæ€»ç»“.md) - éƒ¨ç½²ç»éªŒ
- ğŸ“– [CloudBase Node SDK æ–‡æ¡£](https://docs.cloudbase.net/api-reference/server/node-sdk)
- ğŸ“– [CloudBase MySQL æ–‡æ¡£](https://docs.cloudbase.net/database/mysql)

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹æ¨¡æ¿

```powershell
# 1. åˆ›å»ºæ–°äº‘å‡½æ•°
cd d:\project\cursor\work\xcx\cloudfunctions
mkdir course  # æ›¿æ¢ä¸ºå®é™…æ¨¡å—å

# 2. å¤åˆ¶å…¬å…±æ¨¡å—ï¼ˆâš ï¸ æ¨èä½¿ç”¨åŒæ­¥è„šæœ¬ï¼‰
# æ–¹æ³•1ï¼šä½¿ç”¨åŒæ­¥è„šæœ¬ï¼ˆæ¨èï¼‰
.\åŒæ­¥å…¬å…±æ¨¡å—.ps1

# æ–¹æ³•2ï¼šæ‰‹åŠ¨å¤åˆ¶
Copy-Item -Path "common" -Destination "course\common" -Recurse -Force
Copy-Item -Path "business-logic" -Destination "course\business-logic" -Recurse -Force

# 3. åˆ›å»º handlers ç›®å½•
mkdir course\handlers\public
mkdir course\handlers\client
mkdir course\handlers\admin

# 4. å¤åˆ¶æ¨¡æ¿æ–‡ä»¶
# - index.jsï¼ˆå¯ä» order æˆ– user å¤åˆ¶ï¼‰
# - package.json
# - cloudfunction.json

# 5. ç¼–å†™ä¸šåŠ¡ä»£ç 
# å‚è€ƒ order/handlers/client/create.js æˆ– user/handlers/client/getProfile.js

# 6. éƒ¨ç½²æµ‹è¯•
# ä½¿ç”¨ MCP å·¥å…·éƒ¨ç½²
```

---

## å®æˆ˜æ¡ˆä¾‹ï¼šorder äº‘å‡½æ•°éƒ¨ç½²

### ğŸ“– åŸºäºçœŸå®éƒ¨ç½²ç»éªŒæ€»ç»“

**éƒ¨ç½²æ—¶é—´**: 2026-02-10
**äº‘å‡½æ•°å**: order
**æ¥å£æ•°é‡**: 13ä¸ªï¼ˆ1ä¸ªå…¬å¼€ + 8ä¸ªå®¢æˆ·ç«¯ + 4ä¸ªç®¡ç†ç«¯ï¼‰
**éƒ¨ç½²ç»“æœ**: âœ… æˆåŠŸï¼ˆæ‰€æœ‰æ¥å£æµ‹è¯•é€šè¿‡ï¼‰

### é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜ 1: require è·¯å¾„é”™è¯¯ âŒ

**ç°è±¡**:
```
Cannot find module 'common'
Cannot find module 'business-logic'
```

**åŸå› **:
- index.js ä¸­ä½¿ç”¨äº† `require('common')` è€Œä¸æ˜¯ `require('./common')`
- handlers æ–‡ä»¶ä¸­ä½¿ç”¨äº† `require('common')` è€Œä¸æ˜¯ `require('../../common')`

**è§£å†³æ–¹æ¡ˆ**:

1. **ä¿®å¤ index.js**:
```javascript
// ä¿®å¤å‰
const { response } = require('common');
const business = require('business-logic');

// ä¿®å¤å
const { response } = require('./common');
const business = require('./business-logic');
```

2. **æ‰¹é‡ä¿®å¤æ‰€æœ‰ handlers æ–‡ä»¶**:
```powershell
cd d:\project\cursor\work\xcx\cloudfunctions\order\handlers
Get-ChildItem -Recurse -Filter *.js | ForEach-Object {
    (Get-Content $_.FullName -Raw) `
        -replace "require\('common/db'\)", "require('../../common/db')" `
        -replace "require\('common'\)", "require('../../common')" `
        -replace "require\('business-logic'\)", "require('../../business-logic')" |
    Set-Content $_.FullName -NoNewline
}
```

#### é—®é¢˜ 2: business-logic è°ƒç”¨æ–¹å¼é”™è¯¯ âŒ

**ç°è±¡**:
```
Cannot read properties of undefined (reading 'verifyPaymentCallback')
```

**åŸå› **:
handlers æ–‡ä»¶ä¸­ä½¿ç”¨äº†å­æ¨¡å—è°ƒç”¨æ–¹å¼ï¼š
- `business.payment.createWechatPayment()`
- `business.utils.generateOrderNo()`
- `business.payment.processRefund()`

ä½† business-logic/index.js æ˜¯ç›´æ¥å¯¼å‡ºçš„ï¼Œä¸æ˜¯å­æ¨¡å—æ–¹å¼ã€‚

**è§£å†³æ–¹æ¡ˆ**:

ä¿®å¤æ‰€æœ‰é”™è¯¯çš„è°ƒç”¨ï¼š
```javascript
// âŒ é”™è¯¯
business.payment.createWechatPayment()
business.utils.generateOrderNo('ORD')
business.payment.processRefund()
business.payment.verifyPaymentCallback()

// âœ… æ­£ç¡®
business.createWechatPayment()
business.generateOrderNo('ORD')
business.processRefund()
business.verifyPaymentCallback()
```

æ‰¹é‡æ£€æŸ¥å‘½ä»¤ï¼š
```powershell
# æŸ¥æ‰¾æ‰€æœ‰é”™è¯¯çš„è°ƒç”¨
Get-ChildItem -Recurse -Filter *.js -Path handlers | ForEach-Object {
    $content = Get-Content $_.FullName | Select-String "business\.(utils|payment|points|order|ambassador|notification|qrcode)\."
    if ($content) {
        Write-Host "âŒ é”™è¯¯ï¼š$($_.FullName)" -ForegroundColor Red
        $content
    }
}
```

#### é—®é¢˜ 3: cloudfunction.json é…ç½®å†—ä½™ âš ï¸

**ç°è±¡**:
cloudfunction.json åŒ…å«äº†å·²åºŸå¼ƒçš„é…ç½®é¡¹

**åŸå› **:
ä½¿ç”¨æœ¬åœ°æ¨¡å—æ–¹å¼ï¼Œä¸éœ€è¦è¿™äº›é…ç½®

**è§£å†³æ–¹æ¡ˆ**:

```json
// âŒ é”™è¯¯é…ç½®ï¼ˆå·²åºŸå¼ƒï¼‰
{
  "permissions": { "openapi": [...] },
  "layers": [...],              // âŒ å·²åºŸå¼ƒ
  "envVariables": {...},        // âŒ å·²åºŸå¼ƒ
  "triggers": []
}

// âœ… æ­£ç¡®é…ç½®
{
  "permissions": {
    "openapi": [
      "wxpay.unifiedOrder",
      "wxpay.refund",
      "subscribeMessage.send"
    ]
  },
  "triggers": []
}
```

### ä¿®å¤æµç¨‹

1. **å‘ç°é—®é¢˜** (é€šè¿‡æµ‹è¯•æ¥å£æŠ¥é”™)
2. **å®šä½é—®é¢˜** (æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—)
3. **æ‰¹é‡ä¿®å¤** (ä½¿ç”¨ PowerShell è„šæœ¬)
4. **é‡æ–°éƒ¨ç½²** (`updateFunctionCode`)
5. **éªŒè¯æµ‹è¯•** (æµ‹è¯•æ‰€æœ‰ 13 ä¸ªæ¥å£)

### æµ‹è¯•ç»“æœ

æ‰€æœ‰ 13 ä¸ªæ¥å£æµ‹è¯•é€šè¿‡ï¼š

| æ¥å£åˆ†ç±» | æ•°é‡ | æµ‹è¯•ç»“æœ |
|---------|------|---------|
| å…¬å¼€æ¥å£ | 1 | âœ… é€šè¿‡ (paymentCallback) |
| å®¢æˆ·ç«¯æ¥å£ | 8 | âœ… é€šè¿‡ (æ‰€æœ‰æ¥å£) |
| ç®¡ç†ç«¯æ¥å£ | 4 | âœ… é€šè¿‡ (æ‰€æœ‰æ¥å£) |

**æµ‹è¯•è¯´æ˜**: æ‰€æœ‰æ¥å£è¿”å› 401 æœªç™»å½•æ˜¯æ­£å¸¸çš„é‰´æƒå“åº”ï¼Œä»£ç é€»è¾‘æ­£ç¡®ã€‚

### ç»éªŒæ€»ç»“

1. **éƒ¨ç½²å‰å¿…é¡»æ£€æŸ¥ require è·¯å¾„** - è¿™æ˜¯æœ€å¸¸è§çš„é”™è¯¯
2. **ä½¿ç”¨æ‰¹é‡ä¿®å¤å·¥å…·** - æ‰‹åŠ¨ä¿®æ”¹å®¹æ˜“é—æ¼
3. **ç†Ÿæ‚‰ business-logic å¯¼å‡ºæ–¹å¼** - é¿å…é”™è¯¯çš„è°ƒç”¨æ–¹å¼
4. **ç²¾ç®€ cloudfunction.json** - åªä¿ç•™ permissions å’Œ triggers
5. **éƒ¨ç½²åç«‹å³æµ‹è¯•æ‰€æœ‰æ¥å£** - åŠæ—©å‘ç°é—®é¢˜

### é˜²æ­¢å†æ¬¡å‡ºé”™çš„æ£€æŸ¥æ¸…å•

åœ¨éƒ¨ç½²ä»»ä½•æ–°äº‘å‡½æ•°å‰ï¼ŒåŠ¡å¿…æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

```powershell
# 1. æ£€æŸ¥ index.js
Get-Content index.js | Select-String "require\('(common|business-logic)'\)"

# 2. æ£€æŸ¥æ‰€æœ‰ handlers æ–‡ä»¶
Get-ChildItem -Recurse -Filter *.js -Path handlers | ForEach-Object {
    $content = Get-Content $_.FullName | Select-String "require\('(common|business-logic)'\)"
    if ($content) {
        Write-Host "âŒ é”™è¯¯ï¼š$($_.FullName)"
    }
}

# 3. æ£€æŸ¥ business-logic è°ƒç”¨
Get-ChildItem -Recurse -Filter *.js -Path handlers | ForEach-Object {
    $content = Get-Content $_.FullName | Select-String "business\.(utils|payment|points|order|ambassador)\."
    if ($content) {
        Write-Host "âŒ é”™è¯¯ï¼š$($_.FullName)"
    }
}

# 4. æ£€æŸ¥ cloudfunction.jsonï¼ˆç¡®ä¿æ— åºŸå¼ƒé…ç½®ï¼‰
$config = Get-Content cloudfunction.json | ConvertFrom-Json
if ($config.layers -or $config.envVariables) {
    Write-Host "âŒ åŒ…å«å·²åºŸå¼ƒçš„é…ç½®" -ForegroundColor Red
}
```

**å¦‚æœä»¥ä¸Šæ£€æŸ¥éƒ½é€šè¿‡ï¼Œæ‰èƒ½æ‰§è¡Œ createFunction æˆ– updateFunctionCodeï¼**

---

**æœ€åæ›´æ–°**: 2026-02-10
**ç‰ˆæœ¬**: V3.2
**éªŒè¯æ¨¡å—**: user (17ä¸ªæ¥å£), order (13ä¸ªæ¥å£), course (37ä¸ªæ¥å£)
**éƒ¨ç½²çŠ¶æ€**: âœ… å…¨éƒ¨éƒ¨ç½²æˆåŠŸå¹¶æµ‹è¯•é€šè¿‡
**ä¸‹ä¸€æ­¥**: åº”ç”¨åˆ° ambassador, system æ¨¡å—

**V3.2 æ›´æ–°å†…å®¹**ï¼ˆç»Ÿä¸€å…¬å…±æ¨¡å—ç®¡ç†ï¼‰ï¼š
- âœ… å¼•å…¥ç»Ÿä¸€å…¬å…±æ¨¡å—ç®¡ç†æ¶æ„ï¼ˆ`cloudfunctions/common` å’Œ `cloudfunctions/business-logic`ï¼‰
- âœ… æ–°å¢ `åŒæ­¥å…¬å…±æ¨¡å—.ps1` ä¸€é”®åŒæ­¥è„šæœ¬
- âœ… æ›´æ–°æ‰€æœ‰å¤åˆ¶å‘½ä»¤ä¸ºä»ç»Ÿä¸€å…¬å…±æ¨¡å—å¤åˆ¶
- âœ… ä¼˜åŒ–å…¬å…±ä»£ç ç»´æŠ¤æµç¨‹ï¼ˆé›†ä¸­ç»´æŠ¤ï¼Œç»Ÿä¸€åŒæ­¥ï¼‰
- âœ… ç¡®ä¿æ‰€æœ‰äº‘å‡½æ•°å…¬å…±ä»£ç ç‰ˆæœ¬ä¸€è‡´æ€§
- âœ… ç®€åŒ–æ–°äº‘å‡½æ•°åˆ›å»ºæµç¨‹

**V3.1 æ›´æ–°å†…å®¹**ï¼ˆåŸºäºå®é™…éƒ¨ç½²æµ‹è¯•åé¦ˆï¼‰ï¼š
- âœ… ä¿®å¤ findOne å‡½æ•°å¤„ç†è®°å½•ä¸å­˜åœ¨çš„æƒ…å†µ
- âœ… æ–°å¢è½¯åˆ é™¤å­—æ®µè¯´æ˜ï¼ˆå“ªäº›è¡¨æœ‰/æ²¡æœ‰ deleted_atï¼‰
- âœ… æ–°å¢å‚æ•°éªŒè¯æœ€ä½³å®è·µ
- âœ… æ–°å¢ 3 ä¸ªå¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼ˆQ10-Q12ï¼‰
- âœ… åŸºäºçœŸå®éƒ¨ç½²ç»éªŒä¼˜åŒ–æ–‡æ¡£

**V3.0 æ›´æ–°å†…å®¹**ï¼š
- âœ… ç»Ÿä¸€æ•°æ®åº“è®¿é—®å±‚ï¼ˆcommon/db.jsï¼‰
- âœ… å®Œå…¨ç§»é™¤ mysql2 ä¾èµ–
- âœ… é‡‡ç”¨ CloudBase SDK Supabase é£æ ¼ API
- âœ… æ–°å¢å¤–é”®çº¦æŸæ”¯æŒï¼ˆ32ä¸ªå¤–é”®ï¼‰
- âœ… æ¶ˆé™¤ N+1 æŸ¥è¯¢é—®é¢˜ï¼ˆä½¿ç”¨ JOINï¼‰
- âœ… ç§»é™¤æ‰€æœ‰ Layer å’Œ envVariables é…ç½®
- âœ… ç®€åŒ–éƒ¨ç½²æµç¨‹å’Œé…ç½®
- âœ… ä¼˜åŒ–æ–‡æ¡£ç»“æ„ï¼Œç§»é™¤åºŸå¼ƒå†…å®¹

