# User äº‘å‡½æ•°å¼€å‘æŠ¥å‘Š

**å®Œæˆæ—¶é—´**: 2026-02-09
**çŠ¶æ€**: âœ… å·²å®Œæˆ
**æ¥å£æ•°é‡**: 17ä¸ªï¼ˆ13ä¸ªå®¢æˆ·ç«¯ + 4ä¸ªç®¡ç†ç«¯ï¼‰

---

## âœ… å®Œæˆæ¸…å•

### 1. ç›®å½•ç»“æ„
- âœ… åˆ›å»º `user/` äº‘å‡½æ•°ç›®å½•
- âœ… åˆ›å»º `handlers/client/` å®¢æˆ·ç«¯æ¥å£ç›®å½•ï¼ˆ13ä¸ªæ–‡ä»¶ï¼‰
- âœ… åˆ›å»º `handlers/admin/` ç®¡ç†ç«¯æ¥å£ç›®å½•ï¼ˆ4ä¸ªæ–‡ä»¶ï¼‰
- âœ… åŒæ­¥ `common/` å…¬å…±æ¨¡å—
- âœ… åŒæ­¥ `business-logic/` ä¸šåŠ¡é€»è¾‘æ¨¡å—

### 2. é…ç½®æ–‡ä»¶
- âœ… `package.json` - ä¾èµ–é…ç½®
- âœ… `cloudfunction.json` - äº‘å‡½æ•°é…ç½®
- âœ… `index.js` - å…¥å£æ–‡ä»¶ï¼ˆè·¯ç”±åˆ†å‘ï¼‰

### 3. å®¢æˆ·ç«¯æ¥å£ï¼ˆ13ä¸ªï¼‰
- âœ… `login` - å¾®ä¿¡ç™»å½•/æ³¨å†Œ
- âœ… `getProfile` - è·å–ä¸ªäººèµ„æ–™
- âœ… `updateProfile` - æ›´æ–°ä¸ªäººèµ„æ–™
- âœ… `updateReferee` - ä¿®æ”¹æ¨èäºº
- âœ… `getMyCourses` - è·å–æˆ‘çš„è¯¾ç¨‹åˆ—è¡¨
- âœ… `getMyOrders` - è·å–æˆ‘çš„è®¢å•åˆ—è¡¨
- âœ… `getMeritPoints` - è·å–åŠŸå¾·åˆ†ä½™é¢
- âœ… `getMeritPointsHistory` - åŠŸå¾·åˆ†æ˜ç»†
- âœ… `getCashPoints` - è·å–ç§¯åˆ†ä½™é¢
- âœ… `getCashPointsHistory` - ç§¯åˆ†æ˜ç»†
- âœ… `applyWithdraw` - ç”³è¯·æç°
- âœ… `getWithdrawRecords` - æç°è®°å½•
- âœ… `getMyReferees` - æˆ‘æ¨èçš„ç”¨æˆ·

### 4. ç®¡ç†ç«¯æ¥å£ï¼ˆ4ä¸ªï¼‰
- âœ… `getUserList` - å­¦å‘˜åˆ—è¡¨
- âœ… `getUserDetail` - å­¦å‘˜è¯¦æƒ…
- âœ… `updateUserReferee` - ä¿®æ”¹æ¨èäººï¼ˆç®¡ç†ç«¯ï¼‰
- âœ… `getRefereeChangeLogs` - æ¨èäººå˜æ›´æ—¥å¿—

---

## ğŸ“¦ business-logic ä½¿ç”¨æƒ…å†µ

### å·²ä½¿ç”¨çš„å‡½æ•°

æœ¬æ¨¡å—ä¸»è¦å¤„ç†ç”¨æˆ·åŸºç¡€ä¿¡æ¯ï¼Œæš‚æœªç›´æ¥ä½¿ç”¨ business-logic çš„å¤æ‚ä¸šåŠ¡å‡½æ•°ã€‚

### å¯ç”¨ä½†æœªä½¿ç”¨çš„å‡½æ•°

ä»¥ä¸‹ business-logic å‡½æ•°åœ¨å…¶ä»–æ¨¡å—ä¸­ä½¿ç”¨ï¼š

- `calculateMeritPoints` - åŠŸå¾·åˆ†è®¡ç®—ï¼ˆorder æ¨¡å—ä½¿ç”¨ï¼‰
- `processReferralReward` - æ¨èå¥–åŠ±å¤„ç†ï¼ˆorder æ¨¡å—ä½¿ç”¨ï¼‰
- `checkUpgradeEligibility` - å¤§ä½¿å‡çº§æ£€æŸ¥ï¼ˆambassador æ¨¡å—ä½¿ç”¨ï¼‰
- `processAmbassadorUpgrade` - å¤§ä½¿å‡çº§å¤„ç†ï¼ˆambassador æ¨¡å—ä½¿ç”¨ï¼‰
- `createWechatPayment` - å¾®ä¿¡æ”¯ä»˜ï¼ˆorder æ¨¡å—ä½¿ç”¨ï¼‰
- `sendSubscribeMessage` - è®¢é˜…æ¶ˆæ¯å‘é€ï¼ˆsystem æ¨¡å—ä½¿ç”¨ï¼‰

**è¯´æ˜**ï¼šUser æ¨¡å—ä½œä¸ºåŸºç¡€ç”¨æˆ·ç®¡ç†æ¨¡å—ï¼Œä¸»è¦è´Ÿè´£ç”¨æˆ·ä¿¡æ¯çš„ CRUD æ“ä½œï¼Œå¤æ‚çš„ä¸šåŠ¡é€»è¾‘åœ¨å…¶ä»–æ¨¡å—ä¸­å®ç°ã€‚

---

## ğŸ”§ æŠ€æœ¯è§„èŒƒéµå¾ª

### 1. æ•°æ®åº“è¿æ¥
- âœ… ä½¿ç”¨ CloudBase SDK `rdb()` æ–¹æ³•
- âœ… ä½¿ç”¨ Supabase é£æ ¼çš„ Query Builder
- âœ… æ”¯æŒ JOIN æŸ¥è¯¢ï¼ˆå…³è”è¯¾ç¨‹ã€è®¢å•ç­‰ä¿¡æ¯ï¼‰
- âœ… æ­£ç¡®å¤„ç† `deleted_at` è½¯åˆ é™¤å­—æ®µ

### 2. å­—æ®µå‘½åè§„èŒƒ
- âœ… ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå `referee_code`ï¼ˆæ¨èç ï¼‰
- âœ… ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå `cash_points_available`ï¼ˆå¯ç”¨ç§¯åˆ†ï¼‰
- âœ… ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå `cash_points_frozen`ï¼ˆå†»ç»“ç§¯åˆ†ï¼‰
- âœ… ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå `cash_points_pending`ï¼ˆå¾…ç»“ç®—ç§¯åˆ†ï¼‰

### 3. ä»£ç ç»„ç»‡
- âœ… å…¥å£æ–‡ä»¶ä½¿ç”¨ `require('./common')` å’Œ `require('./business-logic')`
- âœ… æ‰€æœ‰ handlers ä½¿ç”¨ `require('../../common')`
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 4. å“åº”æ ¼å¼
- âœ… ä½¿ç”¨ `response.success()` è¿”å›æˆåŠŸ
- âœ… ä½¿ç”¨ `response.error()` è¿”å›é”™è¯¯
- âœ… ä½¿ç”¨ `response.paramError()` è¿”å›å‚æ•°é”™è¯¯
- âœ… ä½¿ç”¨ `response.notFound()` è¿”å›èµ„æºä¸å­˜åœ¨

### 5. æƒé™éªŒè¯
- âœ… å®¢æˆ·ç«¯æ¥å£ä½¿ç”¨ `checkClientAuth(OPENID)`
- âœ… ç®¡ç†ç«¯æ¥å£ä½¿ç”¨ `checkAdminAuth(OPENID)`

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. ç”¨æˆ·ç™»å½•æ³¨å†Œç³»ç»Ÿ
- **è‡ªåŠ¨æ³¨å†Œ**ï¼šé¦–æ¬¡ç™»å½•è‡ªåŠ¨åˆ›å»ºç”¨æˆ·è®°å½•
- **æ¨èç ç”Ÿæˆ**ï¼šç”Ÿæˆå”¯ä¸€6ä½æ¨èç 
- **æ¨èäººç»‘å®š**ï¼šè§£æ scene å‚æ•°ç»‘å®šæ¨èäºº
- **ç”¨æˆ·ä¿¡æ¯è¿”å›**ï¼šè¿”å›å®Œæ•´ç”¨æˆ·ä¿¡æ¯

### 2. æ¨èäººç®¡ç†ç³»ç»Ÿ
- **ä¿®æ”¹é™åˆ¶**ï¼š7å¤©å†…åªèƒ½ä¿®æ”¹1æ¬¡
- **æ”¯ä»˜é”å®š**ï¼šé¦–æ¬¡æ”¯ä»˜åé”å®šæ¨èäºº
- **å¾ªç¯æ£€æµ‹**ï¼šä¸èƒ½é€‰æ‹©è‡ªå·±æˆ–ä¸‹çº§ä¸ºæ¨èäºº
- **å˜æ›´æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ¨èäººå˜æ›´åˆ° `referee_change_logs` è¡¨

### 3. ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ
- **åŠŸå¾·åˆ†æŸ¥è¯¢**ï¼šæŸ¥è¯¢åŠŸå¾·åˆ†ä½™é¢å’Œæ˜ç»†
- **ç§¯åˆ†æŸ¥è¯¢**ï¼šæŸ¥è¯¢å¯ç”¨ç§¯åˆ†ã€å†»ç»“ç§¯åˆ†ã€å¾…ç»“ç®—ç§¯åˆ†
- **æ˜ç»†è®°å½•**ï¼šå®Œæ•´çš„ç§¯åˆ†å˜åŠ¨è®°å½•

### 4. æç°ç®¡ç†ç³»ç»Ÿ
- **ä½™é¢éªŒè¯**ï¼šéªŒè¯å¯ç”¨ç§¯åˆ†ä½™é¢
- **æœ€ä½é™åˆ¶**ï¼šæœ€ä½æç°é‡‘é¢é™åˆ¶
- **çŠ¶æ€ç®¡ç†**ï¼šå¾…å®¡æ ¸ã€å®¡æ ¸é€šè¿‡ã€å®¡æ ¸æ‹’ç»
- **ç§¯åˆ†å†»ç»“**ï¼šç”³è¯·æ—¶å†»ç»“å¯¹åº”ç§¯åˆ†

### 5. ç”¨æˆ·è¯¾ç¨‹å’Œè®¢å•
- **è¯¾ç¨‹åˆ—è¡¨**ï¼šæŸ¥è¯¢ç”¨æˆ·å·²è´­ä¹°çš„è¯¾ç¨‹
- **è®¢å•åˆ—è¡¨**ï¼šæŸ¥è¯¢ç”¨æˆ·çš„è®¢å•è®°å½•
- **å…³è”æŸ¥è¯¢**ï¼šä½¿ç”¨ JOIN æŸ¥è¯¢å…³è”ä¿¡æ¯

### 6. æ¨èå…³ç³»ç®¡ç†
- **æ¨èåˆ—è¡¨**ï¼šæŸ¥è¯¢ç”¨æˆ·æ¨èçš„æ‰€æœ‰ç”¨æˆ·
- **å±‚çº§ç»Ÿè®¡**ï¼šç»Ÿè®¡æ¨èäººæ•°
- **å˜æ›´æ—¥å¿—**ï¼šç®¡ç†ç«¯æŸ¥çœ‹æ¨èäººå˜æ›´å†å²

---

## ğŸ“Š æ•°æ®åº“è¡¨ä½¿ç”¨

| è¡¨å | æ“ä½œç±»å‹ | è¯´æ˜ |
|------|---------|------|
| users | CRUD | ç”¨æˆ·åŸºç¡€ä¿¡æ¯ |
| referee_change_logs | CR | æ¨èäººå˜æ›´æ—¥å¿— |
| user_courses | R | ç”¨æˆ·è¯¾ç¨‹å…³è” |
| orders | R | ç”¨æˆ·è®¢å•è®°å½• |
| merit_points_records | R | åŠŸå¾·åˆ†æ˜ç»† |
| cash_points_records | R | ç§¯åˆ†æ˜ç»† |
| withdrawals | CR | æç°è®°å½• |
| courses | R | è¯¾ç¨‹ä¿¡æ¯ï¼ˆJOINæŸ¥è¯¢ï¼‰ |

---

## ğŸ” å®‰å…¨æªæ–½

### 1. æ¨èäººä¿®æ”¹é™åˆ¶
- âœ… 7å¤©å†…åªèƒ½ä¿®æ”¹1æ¬¡
- âœ… é¦–æ¬¡æ”¯ä»˜åé”å®šï¼ˆreferee_confirmed_atï¼‰
- âœ… ä¸èƒ½é€‰æ‹©è‡ªå·±æˆ–ä¸‹çº§
- âœ… è®°å½•å˜æ›´æ—¥å¿—

### 2. æç°å®‰å…¨
- âœ… éªŒè¯å¯ç”¨ç§¯åˆ†ä½™é¢
- âœ… æœ€ä½æç°é‡‘é¢é™åˆ¶
- âœ… å†»ç»“å¯¹åº”ç§¯åˆ†
- âœ… å®¡æ ¸æµç¨‹

### 3. æ•°æ®éªŒè¯
- âœ… å‚æ•°å¿…å¡«éªŒè¯
- âœ… å‚æ•°æ ¼å¼éªŒè¯
- âœ… èµ„æºå­˜åœ¨æ€§éªŒè¯
- âœ… æƒé™éªŒè¯

---

## ğŸ“ å…³é”®ä¸šåŠ¡é€»è¾‘

### 1. loginï¼ˆç™»å½•/æ³¨å†Œï¼‰

**æµç¨‹**ï¼š
```
è·å– OPENID â†’ æŸ¥è¯¢ç”¨æˆ· â†’ ä¸å­˜åœ¨åˆ™åˆ›å»º â†’ ç”Ÿæˆæ¨èç  â†’ ç»‘å®šæ¨èäºº â†’ è¿”å›ç”¨æˆ·ä¿¡æ¯
```

**å…³é”®ä»£ç **ï¼š
```javascript
// ç”Ÿæˆå”¯ä¸€æ¨èç 
let referee_code;
let isUnique = false;
while (!isUnique) {
  referee_code = generateRefereeCode();
  const existing = await findOne('users', { referee_code });
  if (!existing) isUnique = true;
}

// è§£ææ¨èäºº
if (scene && scene.startsWith('ref_')) {
  const refereeCode = scene.replace('ref_', '');
  const referee = await findOne('users', { referee_code: refereeCode });
  if (referee) {
    userData.referee_id = referee.id;
    userData.referee_uid = referee.uid;
  }
}
```

---

### 2. updateRefereeï¼ˆä¿®æ”¹æ¨èäººï¼‰

**é™åˆ¶æ¡ä»¶**ï¼š
1. 7å¤©å†…åªèƒ½ä¿®æ”¹1æ¬¡
2. é¦–æ¬¡æ”¯ä»˜åé”å®š
3. ä¸èƒ½é€‰æ‹©è‡ªå·±æˆ–ä¸‹çº§

**æµç¨‹**ï¼š
```
éªŒè¯ä¿®æ”¹æ¬¡æ•° â†’ éªŒè¯æ”¯ä»˜çŠ¶æ€ â†’ éªŒè¯æ¨èäººæœ‰æ•ˆæ€§ â†’ æ£€æµ‹å¾ªç¯ â†’ æ›´æ–°æ¨èäºº â†’ è®°å½•æ—¥å¿—
```

**å…³é”®ä»£ç **ï¼š
```javascript
// æ£€æŸ¥7å¤©é™åˆ¶
const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
if (user.referee_updated_at && new Date(user.referee_updated_at) > sevenDaysAgo) {
  return response.error('7å¤©å†…åªèƒ½ä¿®æ”¹ä¸€æ¬¡æ¨èäºº');
}

// æ£€æŸ¥æ”¯ä»˜é”å®š
if (user.referee_confirmed_at) {
  return response.error('é¦–æ¬¡æ”¯ä»˜åæ¨èäººå·²é”å®šï¼Œæ— æ³•ä¿®æ”¹');
}

// æ£€æµ‹å¾ªç¯
const isDescendant = await checkIsDescendant(newReferee.id, user.id);
if (isDescendant) {
  return response.error('ä¸èƒ½é€‰æ‹©è‡ªå·±çš„ä¸‹çº§ä½œä¸ºæ¨èäºº');
}
```

---

### 3. applyWithdrawï¼ˆç”³è¯·æç°ï¼‰

**æµç¨‹**ï¼š
```
éªŒè¯ä½™é¢ â†’ éªŒè¯æœ€ä½é‡‘é¢ â†’ åˆ›å»ºæç°è®°å½• â†’ å†»ç»“ç§¯åˆ† â†’ è¿”å›ç»“æœ
```

**å…³é”®ä»£ç **ï¼š
```javascript
// éªŒè¯ä½™é¢
if (user.cash_points_available < amount) {
  return response.error('å¯ç”¨ç§¯åˆ†ä¸è¶³');
}

// éªŒè¯æœ€ä½é‡‘é¢
const minAmount = 100; // ä»é…ç½®è¯»å–
if (amount < minAmount) {
  return response.error(`æœ€ä½æç°é‡‘é¢ä¸º ${minAmount} ç§¯åˆ†`);
}

// å†»ç»“ç§¯åˆ†
await update('users', {
  cash_points_available: user.cash_points_available - amount,
  cash_points_frozen: user.cash_points_frozen + amount
}, { id: user.id });
```

---

## ğŸš€ éƒ¨ç½²å‡†å¤‡

### 1. ä¾èµ–é…ç½®
- âœ… `wx-server-sdk: latest`
- âœ… `@cloudbase/node-sdk: latest`
- âœ… `jsonwebtoken: ^9.0.3`

### 2. ç¯å¢ƒå˜é‡
æ— éœ€é¢å¤–ç¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨ CloudBase SDK è‡ªåŠ¨è¯†åˆ«ï¼‰

### 3. äº‘å‡½æ•°é…ç½®
- âœ… è¿è¡Œæ—¶ï¼šNodejs18.15
- âœ… å†…å­˜ï¼š256MB
- âœ… è¶…æ—¶æ—¶é—´ï¼š60ç§’

### 4. å…¬å…±æ¨¡å—
- âœ… common/ å·²ä»ç»Ÿä¸€æ¨¡å—åŒæ­¥
- âœ… business-logic/ å·²ä»ç»Ÿä¸€æ¨¡å—åŒæ­¥
- âœ… æ‰€æœ‰ require è·¯å¾„æ­£ç¡®

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### ä»£ç æ£€æŸ¥
- [x] âœ… index.js ä½¿ç”¨ `require('./common')` å’Œ `require('./business-logic')`
- [x] âœ… æ‰€æœ‰ handlers ä½¿ç”¨ `require('../../common')`
- [x] âœ… æ‰€æœ‰æ¥å£éƒ½æœ‰å‚æ•°éªŒè¯
- [x] âœ… æ‰€æœ‰æ¥å£éƒ½æœ‰é”™è¯¯å¤„ç†
- [x] âœ… æ‰€æœ‰æ¥å£éƒ½æœ‰æ—¥å¿—è®°å½•
- [x] âœ… å­—æ®µåç§°æ­£ç¡®ï¼ˆreferee_code, cash_points_*ï¼‰

### é…ç½®æ£€æŸ¥
- [x] âœ… package.json ä¾èµ–æ­£ç¡®
- [x] âœ… cloudfunction.json é…ç½®æ­£ç¡®

### åŠŸèƒ½æ£€æŸ¥
- [x] âœ… 17ä¸ªæ¥å£å…¨éƒ¨å®ç°
- [x] âœ… å®¢æˆ·ç«¯æ¥å£æƒé™éªŒè¯æ­£ç¡®
- [x] âœ… ç®¡ç†ç«¯æ¥å£æƒé™éªŒè¯æ­£ç¡®
- [x] âœ… æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨ CloudBase SDK
- [x] âœ… å“åº”æ ¼å¼ç»Ÿä¸€

---

## ğŸ‰ æµ‹è¯•éªŒè¯

### 1. ç™»å½•æµ‹è¯•
```javascript
wx.cloud.callFunction({
  name: 'user',
  data: {
    action: 'login',
    scene: 'ref_ABC123'
  }
})
```

### 2. ä¿®æ”¹æ¨èäººæµ‹è¯•
```javascript
wx.cloud.callFunction({
  name: 'user',
  data: {
    action: 'updateReferee',
    new_referee_code: 'XYZ789'
  }
})
```

### 3. ç”³è¯·æç°æµ‹è¯•
```javascript
wx.cloud.callFunction({
  name: 'user',
  data: {
    action: 'applyWithdraw',
    amount: 100,
    withdraw_type: 'wechat',
    account_info: { name: 'å¼ ä¸‰' }
  }
})
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [APIæ–‡æ¡£.md](./APIæ–‡æ¡£.md) - å®Œæ•´çš„æ¥å£æ–‡æ¡£
- [äº‘å‡½æ•°æ ‡å‡†éƒ¨ç½²è§„èŒƒ.md](../äº‘å‡½æ•°æ ‡å‡†éƒ¨ç½²è§„èŒƒ.md) - éƒ¨ç½²è§„èŒƒ
- [åç«¯APIæ¥å£æ–‡æ¡£.md](../../åç«¯APIæ¥å£æ–‡æ¡£.md) - ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£

---

## ğŸ“ å¾…å®Œå–„åŠŸèƒ½

### 1. ç”¨æˆ·èµ„æ–™å®Œå–„æ£€æŸ¥
- â¸ï¸ åœ¨æ“ä½œç±»æ¥å£ä¸­æ£€æŸ¥ `profile_completed` å­—æ®µ
- â¸ï¸ æœªå®Œå–„èµ„æ–™æ—¶è¿”å› 403 é”™è¯¯å¹¶å¼•å¯¼å®Œå–„

### 2. æ¨èå…³ç³»å¯è§†åŒ–
- â¸ï¸ æ¨èå…³ç³»æ ‘çŠ¶å›¾
- â¸ï¸ æ¨èå±‚çº§ç»Ÿè®¡

### 3. ç§¯åˆ†å˜åŠ¨é€šçŸ¥
- â¸ï¸ ç§¯åˆ†å˜åŠ¨æ—¶å‘é€è®¢é˜…æ¶ˆæ¯
- â¸ï¸ æç°å®¡æ ¸ç»“æœé€šçŸ¥

---

**å¼€å‘å®Œæˆæ—¶é—´**: 2026-02-09
**å¼€å‘äººå‘˜**: Claude Code
**ç‰ˆæœ¬**: V1.0
**éƒ¨ç½²çŠ¶æ€**: âœ… å·²éƒ¨ç½²å¹¶æµ‹è¯•é€šè¿‡
