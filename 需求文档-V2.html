<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天道文化课程、学员和大使管理平台 V2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2em;
            margin-bottom: 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 2px solid #333;
        }
        
        h2 {
            font-size: 1.75em;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 1px solid #ddd;
        }
        
        h3 {
            font-size: 1.5em;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
        }
        
        h4 {
            font-size: 1.25em;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        
        h5 {
            font-size: 1.1em;
            margin-top: 0.8em;
            margin-bottom: 0.5em;
        }
        
        p {
            margin-bottom: 1em;
        }
        
        ul, ol {
            margin-bottom: 1em;
            margin-left: 2em;
        }
        
        li {
            margin-bottom: 0.3em;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
        }
        
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        
        table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        
        pre {
            background-color: #f6f8fa;
            padding: 16px;
            overflow: auto;
            border-radius: 6px;
            margin-bottom: 1em;
        }
        
        code {
            background-color: #f6f8fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "Courier New", monospace;
        }
        
        pre code {
            background-color: transparent;
            padding: 0;
        }
        
        hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 2em 0;
        }
        
        .mermaid {
            text-align: center;
            margin: 2em 0;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
        }
        
        strong {
            font-weight: bold;
        }
        
        em {
            font-style: italic;
        }
        
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 1em;
            margin-left: 0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container" id="content"></div>

    <script>
        // 嵌入的Markdown内容
        const markdownContent = `# 天道文化课程、学员和大使管理平台 V2.0

## 一、项目概述

### 1.1 项目背景
本项目旨在开发一个国学兵法课程线上商城小程序，为孙膑道天道文化课程提供线上购买、学习管理和推广的完整解决方案。

### 1.2 目标用户
- **学员**：购买和学习天道文化课程的用户
- **传播大使**：推广课程并获得功德分/积分的传播人员（青鸾大使、鸿鹄大使、金凤大使）
- **管理员**：后台管理人员，负责课程、学员、订单和大使管理

### 1.3 项目目标
- 提供便捷的课程浏览和购买体验
- 建立完善的传播大使推广体系
- 实现课程复训管理
- 支持直接推荐关系和双重奖励机制（功德分+积分）
- 提供全面的后台管理功能

### 1.4 核心机制说明

**奖励系统**（功德分与积分互斥）：

| 对比项 | 功德分 | 积分 |
|-------|--------|------|
| **性质** | 虚拟奖励分 | 可提现的现金分 |
| **获得方式** | 青鸾大使推荐、所有大使担任辅导员/义工 | 鸿鹄及以上大使推荐 |
| **使用方式** | 商城兑换商品、课程、复训、咨询 | 解冻后可提现 |
| **上限** | 无上限，持续获得 | 有上限（鸿鹄16880） |
| **解冻条件** | - | 推荐1个初探班解冻1688 |
| **互斥规则** | 不可与积分同时发放 | 不可与功德分同时发放 |

**核心规则**：
1. **功德分和积分不可同时发放**（二选一，仅限推荐奖励）
2. **青鸾大使推荐** → 只发功德分，无积分
3. **鸿鹄及以上推荐** → 只发积分（优先解冻，解冻完毕后按比例加积分）
4. **辅导员和义工** → 所有大使都可以担任，只发功德分
   - 这是额外职责，不是独立职位
   - 与推荐奖励并行，可以同时获得两个途径的功德分
5. **密训班包含初探班** → 推荐奖励只按密训班价格38888元计算

**青鸾大使举例**：
\`\`\`
场景：青鸾大使推荐学员购买初探班（价格1688元）

成为青鸾大使时：
- 获得1688冻结积分
- 不获得功德分

第1次推荐初探班：
- 解冻积分：1688（可提现，积分池已空）
- 功德分：0

第2次推荐初探班：
- 解冻积分：0（积分池已空）
- 获得功德分：1688 × 30% = 506.4

第N次推荐（N≥2）：
- 解冻积分：0
- 获得功德分：1688 × 30% = 506.4（持续获得）
\`\`\`

**鸿鹄大使举例**：
\`\`\`
升级时：冻结积分16880，可提现积分0

第1次推荐初探班（1688元）：
- 冻结积分：16880 - 1688 = 15192
- 可提现积分：0 + 1688 = 1688
- 功德分：0

第2次推荐密训班（38888元）：
- 冻结积分：15192（不变）
- 可提现积分：1688 + 7777.6 = 9465.6（直接加20%）

第10次推荐初探班：
- 冻结积分：0（全部解冻完毕）
- 可提现积分：持续累加

第11次推荐初探班（1688元）：
- 冻结积分：0（已空）
- 可提现积分：+ 506.4（30%直接加到可提现）
\`\`\`

---

## 二、推荐人确定机制（重要）

### 2.1 核心原则

**推荐人可多次修改，首次购买支付成功后最终确定并永久锁定**

### 2.2 三个阶段

#### 阶段1：注册时（临时记录）
- 用户通过推荐二维码进入小程序
- 系统临时记录推荐人ID到用户表的\`referee_id\`字段
- **此时推荐人可以修改**
- 记录推荐人变更日志（类型：注册）

#### 阶段2：个人资料修改（可修改）
- 用户在"个人信息"页面可看到"我的传播大使"字段
- 点击可从传播大使列表中选择新的推荐人
- **修改限制**：
  - 7天内只能修改一次
  - 不能选择自己
  - 不能选择自己的下级（防止循环推荐）
  - **只能选择准青鸾及以上等级的大使**
- 记录推荐人变更日志（类型：用户主动修改）

#### 阶段3：购买时（最终确定）
- 用户创建订单时，系统自动将用户资料中的推荐人ID复制到订单的\`referee_id\`字段
- **推荐人资格验证**（关键）：
  - 系统验证推荐人等级和购买课程类型的匹配关系
  - 准青鸾大使只能推荐初探班
  - 密训班/咨询/顾问等其他课程，推荐人必须是青鸾及以上等级
  - 验证失败：显示错误提示，不允许创建订单，提示更换推荐人
- 订单确认页面显示当前推荐人信息
- **支付前最后修改机会**：用户可在订单页再次修改推荐人
  - 修改时同样需要验证推荐人资格
- 记录推荐人变更日志（类型：订单修改）
- **支付成功后**：
  - 订单状态变为已支付
  - 订单的\`referee_confirmed_at\`记录当前时间
  - 订单的推荐人不可再修改
  - 如果是用户首次购买：
    - 将订单的推荐人ID同步到用户表
    - 设置\`is_referee_confirmed = 1\`
    - 记录\`referee_confirmed_at\`时间
    - **用户推荐人被永久锁定，后续购买不可再修改**

### 2.3 关键字段说明

#### users表
\`\`\`sql
referee_id              -- 推荐人ID（可修改，首次购买后确认）
referee_updated_at      -- 推荐人最后修改时间
is_referee_confirmed    -- 推荐人是否已确认(0否/1是)
referee_confirmed_at    -- 推荐人确认时间（首次购买支付成功时间）
\`\`\`

#### orders表
\`\`\`sql
referee_id              -- 订单推荐人ID（支付前可修改）
referee_confirmed_at    -- 推荐人确认时间（支付成功时记录）
is_reward_granted       -- 是否已发放奖励(0否/1是)
reward_granted_at       -- 奖励发放时间
\`\`\`

#### referee_change_logs表
\`\`\`sql
user_id                 -- 用户ID
old_referee_id          -- 原推荐人ID
new_referee_id          -- 新推荐人ID
change_type             -- 变更类型(1注册/2用户主动修改/3订单修改/4管理员修改)
change_source           -- 变更来源(1小程序用户资料/2订单确认页/3后台管理)
order_id                -- 关联订单ID
created_at              -- 创建时间
\`\`\`

### 2.4 奖励发放规则

**重要：奖励发放给订单中的推荐人，而非用户资料中的推荐人**

\`\`\`
场景示例1（正常流程）：

1. 用户A注册时扫了准青鸾大使B的二维码
   users.referee_id = B（准青鸾）

2. 用户A在个人资料中改为青鸾大使C
   users.referee_id = C（青鸾）
   记录变更日志：B -> C

3. 用户A购买初探班时又改为准青鸾大使D
   验证通过：准青鸾可推荐初探班
   orders.referee_id = D（准青鸾）
   记录变更日志：C -> D（关联订单号）

4. 支付成功后
   - 奖励发放给大使D（订单推荐人）
   - 用户A推荐人确认：users.is_referee_confirmed = 1
   - 用户A推荐人锁定：users.referee_id = D

5. 用户A再次购买密训班
   - 不可修改推荐人
   - 订单推荐人自动为大使D
   - 此时D已升级为青鸾（推荐过初探班）
   - 奖励继续发放给大使D

场景示例2（资格验证失败）：

1. 用户B注册时扫了准青鸾大使E的二维码
   users.referee_id = E（准青鸾）

2. 用户B直接购买密训班
   系统验证：E是准青鸾，只能推荐初探班
   验证失败：显示错误提示
   - "您的推荐人暂时只能推荐初探班课程"
   - "请选择青鸾及以上等级的推荐人，或先购买初探班"

3. 用户B修改推荐人为青鸾大使F
   验证通过：青鸾可推荐密训班
   orders.referee_id = F（青鸾）
   可以继续支付

4. 支付成功后
   - 奖励发放给大使F（订单推荐人）
   - 用户B推荐人确认并锁定为F
\`\`\`

### 2.5 风控机制

#### 修改频率限制
- 用户在个人资料中修改推荐人：7天只能修改1次
- 订单确认页面修改推荐人：不限制（但会记录日志）
- 支付成功后：完全不可修改

#### 异常检测
- 同一用户频繁在多个推荐人之间切换：标记异常
- 同一IP短时间内多个用户修改推荐人：可疑
- 同一推荐人短时间内被大量设置：刷单嫌疑
- 后台可查看所有变更日志，人工审核异常情况

#### 推荐人资格验证
\`\`\`python
def validate_referee(user_id, new_referee_id, course_type=None):
    # 1. 不能自己推荐自己
    if new_referee_id == user_id:
        raise Exception("不能选择自己为推荐人")
    
    # 2. 不能选择自己的下级
    referee = User.query.get(new_referee_id)
    if referee.referee_id == user_id:
        raise Exception("不能选择自己的下级为推荐人")
    
    # 3. 推荐人必须是传播大使（准青鸾及以上）
    if referee.ambassador_level < 1:
        raise Exception("推荐人必须是准青鸾及以上等级的传播大使")
    
    # 4. 准青鸾大使只能推荐初探班
    if course_type and referee.ambassador_level == 1:  # 准青鸾
        if course_type != 1:  # 不是初探班
            raise Exception("该推荐人暂时只能推荐初探班课程")
    
    return True

def validate_referee_for_order(user_id, referee_id, course_id):
    """订单创建时验证推荐人资格"""
    course = Course.query.get(course_id)
    return validate_referee(user_id, referee_id, course.type)
\`\`\`

**推荐人资格限制说明**：
- **普通学员（level=0）**：不能作为推荐人
- **准青鸾大使（level=1）**：
  - ✅ 可以作为推荐人
  - ✅ 只能推荐初探班课程
  - ❌ 不能推荐密训班、咨询、顾问等其他课程
  - 推荐1个初探班后升级为青鸾大使
- **青鸾及以上（level≥2）**：
  - ✅ 可以作为推荐人
  - ✅ 可以推荐所有类型课程

---

## 三、系统架构

### 2.1 技术架构

\`\`\`mermaid
flowchart TB
    subgraph 用户端
        A[微信小程序]
        B[微信支付]
    end
    
    subgraph 管理端
        C[后台管理系统Web]
    end
    
    subgraph 服务层
        D[API网关]
        E[业务服务]
        F[支付服务]
        G[消息服务]
    end
    
    subgraph 数据层
        H[MySQL数据库]
        I[Redis缓存]
        J[OSS文件存储]
    end
    
    subgraph 第三方服务
        K[微信开放平台]
        L[微信支付平台]
        M[短信服务]
    end
    
    A --> D
    C --> D
    D --> E
    D --> F
    D --> G
    
    E --> H
    E --> I
    E --> J
    
    F --> L
    G --> M
    A --> K
    B --> L
\`\`\`

**技术栈**：
- **前端**：微信小程序
- **后端**：后台管理系统（Web）
- **支付**：微信支付
- **数据库**：MySQL/PostgreSQL
- **缓存**：Redis
- **文件存储**：OSS（阿里云/腾讯云）

### 2.2 系统模块

\`\`\`mermaid
graph TB
    subgraph 小程序端
        A[用户模块] --> A1[微信授权登录]
        A --> A2[个人信息管理]
        
        B[课程模块] --> B1[课程列表]
        B --> B2[课程详情]
        B --> B3[课程购买]
        
        C[学习模块] --> C1[我的课程]
        C --> C2[复训管理]
        
        D[预约模块] --> D1[课程计划]
        D --> D2[预约报名]
        
        E[商学院模块] --> E1[商学院介绍]
        E --> E2[朋友圈素材]
        E --> E3[学员案例]
        
        F[传播大使模块] --> F1[大使等级]
        F --> F2[功德分管理]
        F --> F3[积分管理]
        F --> F4[推荐二维码]
        F --> F5[推荐信息]
        
        G[订单模块] --> G1[购买记录]
        G --> G2[支付管理]
    end
    
    subgraph 后台管理系统
        H[课程管理]
        I[学员管理]
        J[上课记录管理]
        K[订单管理]
        L[大使管理]
        M[消息提醒管理]
        N[系统管理]
    end
    
    小程序端 -.API调用.-> 后台管理系统
\`\`\`

---

## 三、功能需求详细说明

## 3.1 小程序端功能

### 3.1.1 登录模块

#### 微信授权登录
**功能描述**：使用微信一键登录，获取用户基本信息

**业务流程**：

\`\`\`mermaid
sequenceDiagram
    participant U as 用户
    participant MP as 小程序
    participant WX as 微信服务器
    participant BE as 后端服务器
    
    U->>MP: 打开小程序
    MP->>U: 显示登录页面
    U->>MP: 点击微信授权登录
    MP->>WX: 调用wx.login()
    WX-->>MP: 返回code
    MP->>BE: 发送code到后端
    BE->>WX: 使用code换取openid
    WX-->>BE: 返回openid和session_key
    BE->>BE: 创建/更新用户信息
    BE->>BE: 记录推荐人ID
    BE-->>MP: 返回用户token和首次登录标识
    
    alt 首次登录
        MP->>U: 强制显示个人资料填写页面
        U->>MP: 选择填写资料或暂不填写
        alt 填写资料
            MP->>BE: 提交个人资料（必填项）
            BE-->>MP: 保存成功
            MP->>U: 进入首页（正常模式）
        else 暂不填写
            MP->>MP: 设置预览模式标识
            MP->>U: 进入首页（预览模式）
            Note over U,MP: 预览模式：只能浏览，不能操作
        end
    else 非首次登录
        alt 已完善资料
            MP->>U: 进入首页（正常模式）
        else 未完善资料
            MP->>U: 进入首页（预览模式）
        end
    end
\`\`\`

**数据字段**：
- openid（微信唯一标识）
- unionid（开放平台唯一标识）
- 昵称、头像（微信授权获取）
- 手机号（可选）
- 推荐人ID（首次注册时临时记录，可在个人资料和购买时修改，首次购买支付成功后最终确定）
- is_first_login（是否首次登录标识）

**首次登录个人资料填写**：

**功能说明**：
- 首次登录后强制弹出个人资料填写页面
- 必须填写资料后才能使用完整功能
- 不填写只能以预览模式浏览小程序（只读模式）

**资料填写表单**（必填项标*）：
- 真实姓名（必填*）
- 手机号（必填*）
- 性别（选填）
- 出生八字（年月日时）（选填）
- 从事行业（选填）
- 所在地区（选填）
- 个人简介（选填）

**页面元素**：
- 标题："完善个人资料"
- 提示语："请完善资料后使用小程序功能"
- 说明文字："未完善资料只能预览，无法购买课程、预约等操作"
- 表单字段（真实姓名和手机号必填）
- "提交"按钮
- "暂不填写，先预览"按钮（次要按钮样式）

**业务规则**：
- 真实姓名和手机号为必填项，其他选填
- 点击"暂不填写，先预览"进入预览模式
- 点击"提交"保存信息后进入正常模式，可使用全部功能
- 预览模式下功能限制见下方说明
- 后续可在"用户信息"页面补充完善或首次填写

**预览模式功能限制**：

**可以访问（只读）**：
- ✅ 浏览课程列表和详情
- ✅ 查看通知公告
- ✅ 浏览商学院介绍
- ✅ 查看朋友圈素材
- ✅ 查看学员案例
- ✅ 查看课程计划

**不可操作（需完善资料）**：
- ❌ 购买课程
- ❌ 预约报名
- ❌ 申请成为大使
- ❌ 提交反馈
- ❌ 预约咨询
- ❌ 查看和使用"我的"相关功能

**预览模式提示**：
- 在受限功能入口显示"请先完善个人资料"提示
- 点击后弹窗引导去完善资料
- 显示"完善资料"悬浮按钮（右下角）

---

### 3.1.2 首页模块

#### 3.1.2.1 通知公告
**功能描述**：展示后台发布的通知和公告信息

**页面元素**：
- 公告标题
- 发布时间
- 公告类型标签（重要/普通）
- 点击查看详情

**业务规则**：
- 按发布时间倒序排列
- 重要公告置顶
- 支持富文本内容
- 支持图片和视频

#### 3.1.2.2 课程列表
**功能描述**：展示所有可购买的课程

**页面元素**：
- 课程封面图
- 课程名称
- 课程价格
- 课程简介
- 已购人数
- 课程标签（初探班/密训班/咨询/顾问）

**业务规则**：
- 支持课程分类筛选
- 支持搜索功能
- 已购课程显示"已购买"标识
- 课程可设置上架/下架状态

#### 3.1.2.3 课程详情
**功能描述**：展示课程完整信息，支持在线购买

**页面元素**：
- 课程详细介绍
- 课程大纲
- 讲师介绍
- 课程时长
- 课程价格
- 购买按钮
- 分享按钮（带推荐码）

**购买流程**：

\`\`\`mermaid
flowchart TD
    A[用户浏览课程详情] --> B[点击立即购买]
    B --> C[创建订单]
    C --> D{是否密训班?}
    D -->|是| D1[订单金额38888元]
    D1 --> D2[标记赠送1个初探班名额]
    D2 --> E
    D -->|否| E[确认订单信息]
    
    E --> E1[显示推荐人信息]
    E1 --> E2{是否修改推荐人?}
    E2 -->|是| E3[选择新的推荐人]
    E3 --> E4[更新订单推荐人]
    E4 --> F
    E2 -->|否| F[调起微信支付]
    
    F --> G{支付是否成功}
    G -->|失败| H[订单状态待支付]
    G -->|成功| I[接收支付回调]
    I --> J[更新订单状态已支付]
    J --> J1[最终确定推荐人]
    J1 --> J2{是否首次购买?}
    J2 -->|是| J3[设置用户推荐人已确认]
    J2 -->|否| K
    J3 --> K[课程加入我的课程]
    
    K --> L[计算推荐人奖励]
    L --> M[发放功德分或积分]
    
    M --> N{购买初探班?}
    N -->|是| O[处理积分解冻]
    N -->|否| P
    O --> P[发送购买成功通知]
    P --> Q[完成]
    
    note1[密训班包含初探班<br/>推荐奖励只按38888元计算]
    note2[支付成功后推荐人最终确定<br/>首次购买后推荐人不可再修改]
\`\`\`

**特殊规则**：
- 密训班可以直接购买，无需先购买初探班
- **密训班（38888元）默认包含初探班课程**（套餐模式）
- 购买密训班后，两个课程都会加入"我的课程"
- **重要**：推荐人奖励只按密训班价格38888元计算，不重复计算包含的初探班
- 复训费用与正式课程价格不同

**推荐人确定规则**：
- 确认订单页面显示当前推荐人信息（来自用户资料）
- **支付前可修改**：用户可在订单确认页面修改推荐人
- **推荐人资格验证**：
  - 推荐人必须是准青鸾及以上等级的传播大使
  - 如果推荐人是准青鸾大使，只能推荐初探班课程
  - 如果购买密训班/咨询等其他课程，推荐人必须是青鸾及以上等级
  - 不符合条件时显示错误提示并阻止下单
- **支付后最终确定**：支付成功后，订单中的推荐人即为获得奖励的推荐人
- **首次购买锁定**：用户首次购买支付成功后，推荐人被永久确认，后续购买不可再修改
- **奖励发放依据**：奖励发放给订单中最终确定的推荐人，而非用户资料中的推荐人
- 待支付订单可修改推荐人，已支付订单推荐人不可修改

**推荐人资格验证失败提示示例**：

场景1：推荐人不是传播大使
\`\`\`
❌ 错误提示：
"推荐人必须是准青鸾及以上等级的传播大使，请选择其他推荐人"
操作：阻止创建订单，需用户更换推荐人
\`\`\`

场景2：准青鸾推荐非初探班课程
\`\`\`
❌ 错误提示：
"您的推荐人暂时只能推荐初探班课程
推荐人升级为青鸾大使后即可推荐所有课程
请选择青鸾及以上等级的推荐人，或先购买初探班"
操作：阻止创建订单，需用户更换推荐人或改买初探班
\`\`\`

---

### 3.1.3 我的课程

**功能描述**：查看已购买的课程和复训情况

**页面元素**：
- 课程列表（已购）
- 课程进度
- 上课次数记录
- 预约上课按钮

**业务规则**：
- 初探班：提供复训机会
- 密训班：提供复训机会
- 只要第二次来上课都称作复训
- 复训需支付复训费
- 复训只以报名时间为准，没有次数限制

**数据展示**：
\`\`\`
课程名称：初探班
购买时间：2024-01-15
上课次数：3次
状态：可复训
\`\`\`

---

### 3.1.4 预约报名模块

#### 课程计划
**功能描述**：学员预约即将开课的课程，包括首次上课和复训

**页面元素**：
- 课程名称
- 开课时间
- 开课地点
- 剩余名额
- 预约按钮

**预约流程**：

\`\`\`mermaid
flowchart TD
    A[查看课程计划] --> B{是否已购课程}
    B -->|否| C[提示需先购买课程]
    B -->|是| D[选择上课日期]
    D --> E{检查报名截止时间}
    E -->|已截止| F[提示报名已截止]
    E -->|未截止| G{是否首次上课}
    
    G -->|是| H1[直接提交预约]
    H1 --> I1[预约成功]
    
    G -->|否复训| H2[提示需支付复训费]
    H2 --> H3{是否支付}
    H3 -->|是| H4[支付成功]
    H3 -->|否| H5[取消]
    H4 --> H6[预约复训]
    H6 --> I1
    
    I1 --> J[开启消息提醒]
    J --> K[完成]
\`\`\`

**业务规则**：
- **报名截止**：超过报名截止时间则无法报名和复训
- **复训截止**：开课前三天为复训截止时间
  - 开课前三天可以取消复训并退款
  - 到了开课前三天则不能取消和退款
- 每期课程有人数限制
- 只要第二次来上课都称作复训，没有次数限制
- 复训只以报名时间为准

---

### 3.1.5 商学院模块

#### 3.1.5.1 商学院介绍
**功能描述**：展示商学院文化、理念、师资等信息

**内容包括**：
- 商学院简介
- 核心理念
- 讲师团队
- 发展历程
- 荣誉资质

#### 3.1.5.2 朋友圈素材
**功能描述**：为传播大使提供推广素材

**内容类型**：
- 精美海报
- 宣传文案
- 课程介绍图文
- 学员反馈截图
- 活动通知

**功能**：
- 一键保存到相册
- 复制文案
- 素材分类

#### 3.1.5.3 学员案例
**功能描述**：展示优秀学员的学习成果和反馈

**展示内容**：
- 学员姓名/昵称
- 学员照片
- 学习心得
- 成长故事
- 视频见证

---

### 3.1.6 我的模块

#### 3.1.6.1 购买记录
**功能描述**：查看所有订单记录

**显示信息**：
- 订单号
- 课程名称
- 购买时间
- 支付金额
- 订单状态（待支付/已支付/已取消/已退款）
- 发票申请

**操作**：
- 查看详情
- 申请退款
- 联系客服

#### 3.1.6.2 预约课程
**功能描述**：查看已预约的课程

**显示信息**：
- 课程名称
- 预约时间
- 上课地点
- 签到码
- 取消预约

**消息提醒功能**：
- 预约成功后自动引导用户订阅消息通知
- 系统将在开课前按设定时间自动发送提醒消息
- 用户不可关闭课程提醒

#### 3.1.6.3 意见反馈
**功能描述**：用户提交建议和问题，可以针对已参加的课程进行反馈

**表单内容**：
- 反馈课程（可选，从"我的课程"中选择）
  - 显示：课程名称
  - 如不选择，则为通用反馈
- 反馈类型（功能建议/课程反馈/问题反馈/投诉）
- 反馈内容（必填）
- 图片上传（可选，最多3张）
- 联系方式（可选）

**业务流程**：

\`\`\`mermaid
flowchart TD
    A[打开意见反馈] --> B[选择反馈课程]
    B --> C{选择课程?}
    C -->|是| D[从我的课程中选择]
    C -->|否| E[通用反馈]
    D --> F[选择反馈类型]
    E --> F
    F --> G[填写反馈内容]
    G --> H[上传图片可选]
    H --> I[填写联系方式可选]
    I --> J[提交反馈]
    J --> K[提交成功提示]
\`\`\`

**显示规则**：
- 课程选择：仅显示用户已购买的课程
- 默认不选课程（通用反馈）
- 反馈类型根据是否选择课程动态调整：
  - 选择课程：课程内容/课程服务/讲师/场地
  - 未选课程：功能建议/问题反馈/投诉

#### 3.1.6.4 咨询预约
**功能描述**：预约一对一咨询服务

**业务流程**：
1. 选择咨询类型
2. 选择咨询时间
3. 填写咨询问题
4. 提交预约
5. 等待确认
6. 咨询完成后评价

#### 3.1.6.5 用户信息
**功能描述**：编辑个人资料

**可编辑字段**：
- 头像
- 昵称
- 性别
- 手机号
- 出生八字（年月日时）
- 从事行业
- 所在地区
- 个人简介
- **我的传播大使（推荐人）**（新增字段）

**推荐人字段说明**：
- 显示当前推荐人的昵称、头像和等级
- 可点击修改按钮选择其他传播大使
- 从传播大使列表中选择（**仅显示准青鸾及以上等级的大使**）
- **首次购买前可随时修改**
- 首次购买支付成功后推荐人被永久确认，不可再修改
- 显示状态标识：
  - 未确认：显示"可修改"提示
  - 已确认：显示"已确认"标识，不可修改
- 修改频率限制：7天内只能修改一次（防止恶意刷单）

**推荐人修改规则**：
- 不能选择自己为推荐人
- 不能选择自己的下级为推荐人（防止循环推荐）
- **只能选择有效的传播大使（准青鸾及以上等级）**
- 所有修改记录后台可审计

#### 3.1.6.6 我的协议
**功能描述**：查看已签署的传播大使协议

**页面元素**：
- 协议列表
- 协议状态标识

**协议列表显示**：
- 协议名称
  - 《传播大使合作协议》
  - 《鸿鹄大使补充协议》
- 签署时间
- 协议状态（有效/已到期）
- 合同期限（开始时间-结束时间）
- 查看详情按钮

**协议详情页面**：
- 协议完整内容
- 签署信息：
  - 签署人姓名
  - 签署手机号
  - 签署时间
  - 签署IP地址
  - 签署设备信息
- 合同期限：
  - 合同开始时间
  - 合同结束时间
  - 剩余天数
- 下载协议（PDF格式）
- 打印功能

**协议状态说明**：
- **有效**：协议在合同期内
- **已到期**：协议已过期，需续签

**特殊说明**：
- 仅青鸾大使及以上等级可查看协议
- 准青鸾大使无协议记录
- 传播大使合作协议：合同期1年，到期需续签
- 鸿鹄大使补充协议：与原协议关联

---

### 3.1.7 传播大使模块

#### 3.1.7.1 传播大使等级
**功能描述**：显示当前大使等级和权益

**显示内容**：
- 当前等级（普通学员/准青鸾大使/青鸾大使/鸿鹄大使/金凤大使）
- 等级图标和徽章
- 升级条件
- 权益说明
- 升级进度
- 申请按钮（普通学员已购买密训班时显示）
- 面试状态（申请后显示）
- 推荐进度（准青鸾大使显示）

**等级体系**：

\`\`\`mermaid
graph LR
    A[普通学员] -->|购买密训班+<br/>提交申请+完成面试| B[准青鸾大使]
    B -->|推荐1位初探班学员| C[青鸾大使]
    C -->|支付9800元<br/>获10个初探班名额| D[鸿鹄大使]
    C -->|感召一定名额| E[金凤大使]
\`\`\`

##### 普通学员
- 无推广权益
- **不能作为推荐人**
- 可通过购买密训班申请升级为准青鸾大使

##### 准青鸾大使

**成为条件**：
1. 购买密训班
2. 提交大使申请
3. 完成面试审核
4. 认可孙膑道天道文化价值
5. 愿意花时间帮助他人

**申请表单内容**：
- 真实姓名
- 手机号
- 微信号
- 所在城市
- 职业
- 为什么想成为传播大使
- 如何理解天道文化
- 是否愿意花时间帮助他人
- 预期推广计划

**权益**：
- **可以作为推荐人，但暂无推广奖励**
- 不获得功德分
- 不获得积分
- 可以生成推荐二维码（但推荐暂无奖励）
- **只能推荐初探班学员**（不能推荐密训班、咨询等其他课程）
- 等待推荐1位初探班学员购买并支付成功后，自动升级为正式青鸾大使
- **升级为青鸾大使后，才能推荐其他课程的学员**

**升级流程**：

\`\`\`mermaid
flowchart TD
    A[用户购买密训班] --> B[小程序点击申请大使]
    B --> C[填写申请表单]
    C --> D[提交申请]
    D --> E[后台初步审核]
    E --> F{审核结果}
    F -->|不通过| G[通知拒绝原因<br/>保持普通学员]
    F -->|通过| H[安排面试]
    H --> I[通知面试时间]
    I --> J[线下/线上面试]
    J --> K{面试结果}
    K -->|不通过| G
    K -->|通过| L[升级为准青鸾大使]
    L --> M[开通推荐码功能]
    M --> N[小程序显示准青鸾徽章]
    N --> O[等待推荐1个初探班]
\`\`\`

**申请状态显示**：
- 待提交：显示"申请成为大使"按钮
- 审核中：显示"申请审核中，请耐心等待"
- 待面试：显示"已通过初审，等待面试安排"
- 面试中：显示面试时间和联系方式
- 已通过：自动升级为准青鸾大使
- 已拒绝：显示拒绝原因，可重新申请

**重要说明**：
- **准青鸾大使可以作为推荐人，但暂无推广奖励**
- 准青鸾大使无需签署合同
- **只能推荐初探班学员**：
  - 如果学员购买密训班、咨询等其他课程，准青鸾无法作为推荐人
  - 系统会提示学员更换青鸾及以上等级的推荐人
- 虽然可以生成推荐码，但推荐学员购买课程时不会获得功德分和积分
- 必须成功推荐1位学员购买初探班并支付成功后，自动升级为正式青鸾大使
- **升级为青鸾大使后，才能推荐其他课程的学员**
- 升级为青鸾大使时需签署《传播大使合作协议》
- 升级时发放1688冻结积分
- 升级时不发放功德分

##### 青鸾大使

**成为条件**：
1. 已是准青鸾大使
2. 成功推荐1位学员购买初探班（支付成功）

**初始奖励**：
- 成为青鸾大使时获得1688冻结积分
- 不获得功德分

**推荐奖励机制**：

**第1次推荐初探班**：
- 解冻1688积分（可提现）
- 不获得功德分

**第2次及之后推荐**：
- 推荐初探班：30%功德分
- 推荐密训班：20%功德分
- 推荐咨询：20%功德分
- 不再解冻或获得积分

功德分使用：
1. 参加传播大使沙龙
2. 兑换咨询服务
3. 兑换第二年复训费
4. 兑换初探班和密训班课程
5. 兑换商城用品

**辅导员和义工奖励**（额外职责，非独立职位）：
- 所有大使都可以担任辅导员、参与义工
- 担任辅导员：获得功德分奖励
- 参与会务义工：获得功德分奖励
- 组织沙龙活动：获得功德分奖励
- 这是推荐之外的第二个功德分获得途径

**示例**：
\`\`\`
成为青鸾大使：
- 获得1688冻结积分
- 功德分：0

第1次推荐初探班（1688元）：
- 解冻积分：1688（可提现）
- 功德分：0

第2次推荐初探班（1688元）：
- 积分：0（积分池已空）
- 功德分：1688 × 30% = 506.4

第3次推荐密训班（38888元）：
- 积分：0
- 功德分：38888 × 20% = 7777.6

担任辅导员1次：
- 获得功德分：根据活动设定
- 积分：0
\`\`\`

**重要说明**：
- ✅ 成为青鸾时获得1688冻结积分
- ✅ 第1次推荐初探班解冻1688积分
- ✅ 第2次起推荐只获得功德分
- ✅ 功德分无上限，持续获得
- ✅ 所有大使都可以担任辅导员和义工获得功德分（额外途径）

**功德分获得途径**：
1. 推荐课程（第2次起）
2. 担任辅导员、参与义工、组织沙龙

**合同期**：1年

**升级流程**：

\`\`\`mermaid
flowchart TD
    A[准青鸾大使] --> B[成功推荐1位学员购买初探班]
    B --> C[学员完成支付]
    C --> D[系统自动检测]
    D --> E[发送升级通知]
    E --> F[小程序提示签署协议]
    F --> G[用户签署传播大使合作协议]
    G --> H{签署成功?}
    H -->|否| I[保持待签署状态]
    H -->|是| J[正式升级为青鸾大使]
    J --> K[记录合同期1年]
    K --> L[发放1688冻结积分]
    L --> M[记录这是第1次推荐]
    M --> N[不发放功德分]
    N --> O[开通完整青鸾权益]
    O --> P[完成升级]
    
    note1[注意: 成为青鸾获得1688冻结积分<br/>第1次推荐不发功德分<br/>必须签署协议才能正式升级]
\`\`\`

**电子协议签署**：
- **协议名称**：《传播大使合作协议》
- **签署时机**：准青鸾推荐1个初探班成功后，正式升级为青鸾大使前
- **协议内容**：
  - 大使权利与义务
  - 功德分和积分规则
  - 推广行为规范
  - 合同期限（1年）
  - 续约规则
  - 违约责任
- **签署方式**：
  1. 系统发送升级通知和协议签署提醒
  2. 用户进入小程序查看协议全文
  3. 勾选"我已阅读并同意协议内容"
  4. 输入手机号后四位确认签署
  5. 系统记录签署时间、IP、设备信息
- **签署记录**：协议签署后可在"我的协议"中查看
- **未签署影响**：未签署协议前，无法获得功德分和积分奖励

**协议说明**：
- 准青鸾大使无需签署协议
- 只有正式升级为青鸾大使时才需要签署《传播大使合作协议》
- 合同期从签署之日起计算1年
- 合同期内享有青鸾大使完整权益

##### 鸿鹄大使

**成为条件**：
1. 已是青鸾大使
2. 支付9800元获得10个初探班名额

**奖励机制：只发积分（推荐）+ 功德分（辅导员/义工）**

**推荐奖励（积分）**：

积分机制：
- 升级鸿鹄大使时获得：16880冻结积分（固定额度）+ 10个初探班名额
- 可提现积分初始为0
- 只有推荐初探班才解冻积分（冻结→可提现）
- 推荐其他课程直接加到可提现积分（不经过冻结）

**推荐初探班**（解冻机制）：
- 有冻结积分时：解冻1688积分（冻结-1688，可提现+1688）
- 冻结积分为0时：直接获得30%可提现积分

**推荐其他课程**（直接发放）：
- 推荐密训班：20%积分直接加到可提现积分
- 推荐咨询：20%积分直接加到可提现积分
- 推荐顾问：3%积分直接加到可提现积分
- 不消耗冻结积分，不受解冻限制

**辅导员和义工**：可担任辅导员、参与义工获得功德分（详见青鸾大使说明）

**示例**：
\`\`\`
升级时：
- 冻结积分：16880
- 可提现积分：0

第1次推荐初探班（1688元）：
- 冻结积分：16880 - 1688 = 15192
- 可提现积分：0 + 1688 = 1688
- 功德分：0

第2次推荐密训班（38888元）：
- 冻结积分：15192（不变）
- 可提现积分：1688 + 7777.6 = 9465.6

第3次推荐初探班（1688元）：
- 冻结积分：15192 - 1688 = 13504
- 可提现积分：9465.6 + 1688 = 11153.6

第10次推荐初探班：
- 冻结积分：0（全部解冻完毕）
- 可提现积分：持续累加

第11次推荐初探班（1688元）：
- 冻结积分：0（已空）
- 可提现积分：+ 506.4（1688 × 30%直接加）

第12次推荐密训班（38888元）：
- 冻结积分：0
- 可提现积分：+ 7777.6（38888 × 20%直接加）

担任辅导员1次：
- 功德分：根据活动设定
- 积分：0
\`\`\`

**重要说明**：
- ❌ 鸿鹄大使推荐不获得功德分
- ✅ 鸿鹄大使推荐只获得积分（解冻或直接发放）
- ✅ 所有大使都可以担任辅导员和义工获得功德分（额外途径）
- ✅ 解冻完10个名额后，按比例持续获得积分

**积分获得途径**：
1. 推荐初探班：解冻1688积分（有冻结时）或按30%发放（无冻结时）
2. 推荐其他课程：直接按比例加到可提现积分

**功德分获得途径**：
1. 担任辅导员、参与义工、组织沙龙（所有大使通用）

**合同期**：1年

**升级流程**：

\`\`\`mermaid
flowchart TD
    A[青鸾大使申请升级] --> B[签署鸿鹄大使补充协议]
    B --> C{签署成功?}
    C -->|否| D[无法继续升级]
    C -->|是| E[支付9800元]
    E --> F[创建订单购买10个初探班名额]
    F --> G{支付成功?}
    G -->|否| H[订单待支付]
    G -->|是| I[后台设置]
    I --> J[升级为鸿鹄大使]
    J --> K[保存补充协议]
    K --> L[发放16880冻结积分]
    L --> M[分配10个初探班名额]
    M --> N[开通鸿鹄大使权益]
    N --> O[完成升级]
\`\`\`

**电子协议签署**：
- **协议名称**：《鸿鹄大使补充协议》
- **签署时机**：支付升级费用前
- **协议内容**：
  - 鸿鹄大使权益说明
  - 积分规则（16880冻结积分）
  - 名额分配规则（10个初探班名额）
  - 推广责任与义务
  - 合同期续签（原合同基础上）
- **签署方式**：同准青鸾大使签署方式
- **签署记录**：与原协议关联，可在"我的协议"中查看

##### 金凤大使

**成为条件**：
- 感召到一定名额可以成为金凤大使（具体条件待定）

**奖励机制：只发积分（推荐）+ 功德分（辅导员/义工）**

**推荐奖励（积分）**：
- 推荐初探班：50%积分（直接加到可提现积分）
- 推荐密训班：40%积分（直接加到可提现积分）
- 推荐咨询：30%积分（直接加到可提现积分）
- 推荐顾问：5%积分（直接加到可提现积分）

**辅导员和义工**：可担任辅导员、参与义工获得功德分（同其他大使）

**积分机制**：
- 冻结积分：具体额度待定
- 只有推荐初探班才解冻（冻结→可提现）
- 推荐其他课程直接按比例加到可提现积分
- 不消耗冻结积分

**班主任要求**：
1. 积极配合商学院工作
2. 不传播负面信息
3. 每月组织不低于3次沙龙

---

#### 3.1.7.2 功德分管理

**功能描述**：展示功德分明细和余额

**显示内容**：
- 功德分余额
- 累计获得
- 累计消耗
- 功德分明细记录

**功德分明细包括**：
- 时间
- 来源（推荐课程/辅导员/义工/沙龙活动）
- 订单号（如推荐）
- 学员信息（如推荐）
- 活动信息（如辅导员/义工）
- 获得功德分

**功德分兑换**：
- 兑换课程
- 兑换复训
- 兑换咨询服务
- 兑换商城用品

**功德分获得规则**：
- 无上限，持续发放
- 青鸾大使推荐：按课程价格比例获得功德分
- 鸿鹄及以上推荐：不获得功德分，只获得积分
- 所有大使（任何等级）担任辅导员/义工：获得功德分
  - 这是额外的功德分获得途径，不是独立职位
  - 所有大使都可以参与，推荐和辅导员/义工两个途径并行
- 功德分和积分不可同时发放（仅限推荐奖励）

**奖励计算流程**：

\`\`\`mermaid
flowchart TD
    A[学员B购买课程并支付成功] --> A1[获取订单推荐人A<br/>不是用户资料推荐人]
    A1 --> A2{订单是否有推荐人?}
    A2 -->|否| E4[无奖励]
    A2 -->|是| B[系统查询推荐人A]
    B --> C[查询A的大使等级]
    C --> D{大使等级}
    
    D -->|准青鸾| E0[无奖励<br/>检查升级条件]
    D -->|青鸾| E1[青鸾奖励逻辑]
    D -->|鸿鹄/金凤| E2[按比例发放<br/>只发积分]
    D -->|普通学员| E4
    
    E0 --> Z{B购买初探班?}
    Z -->|是| Z1[自动升级A为青鸾大使]
    Z1 --> Z2[发放1688冻结积分]
    Z2 --> N[发送升级通知]
    Z -->|否| N
    
    E1 --> F1{B购买初探班?}
    F1 -->|否| F4[计算功德分<br/>密训班/咨询]
    F4 --> G4[发放功德分]
    G4 --> N
    
    F1 -->|是| F2{A是第1次推荐?}
    F2 -->|是| G1[解冻1688积分]
    G1 --> H1[不发功德分]
    H1 --> I1[标记已解冻]
    I1 --> N
    
    F2 -->|否| G2[计算功德分30%]
    G2 --> H2[发放功德分]
    H2 --> N
    
    E2 --> F3{是否购买初探班?}
    F3 -->|否| N
    F3 -->|是| F5{A还有冻结积分?}
    
    F5 -->|有| G5[解冻1688积分]
    G5 --> H5[记录积分解冻明细]
    H5 --> I5[更新积分余额]
    I5 --> N
    
    F5 -->|无| G6[计算积分<br/>按比例发放]
    G6 --> H6[记录积分明细]
    H6 --> I6[更新积分余额]
    I6 --> N
    
    E4 --> N
    
    note1[青鸾大使特殊规则:<br/>第1次推荐初探班解冻积分<br/>第2次起只发功德分]
    note2[重要：奖励发放给订单推荐人<br/>不是用户资料推荐人]
\`\`\`

---

#### 3.1.7.3 积分管理

**功能描述**：展示积分明细、余额和提现功能

**显示内容**：
- 积分余额
- 冻结积分
- 可提现积分
- 累计提现
- 积分明细记录

**积分明细包括**：
- 时间
- 来源（升级大使/推荐解冻）
- 积分数量
- 状态（冻结/可提现/已提现）

**积分提现**：
- 查看可提现金额
- 提交提现申请
- 填写提现账户信息
- 等待审核
- 提现到账

**积分获得规则**：

**冻结积分机制**：
- 青鸾大使：1688冻结积分（固定额度）
- 鸿鹄大使：16880冻结积分（固定额度）
- 可提现积分初始为0
- 两个字段独立管理

**推荐初探班**：
- 有冻结积分时：解冻1688积分（冻结-1688，可提现+1688）
- 无冻结积分时：
  - 青鸾：只发功德分，不发积分
  - 鸿鹄：直接加30%到可提现积分

**推荐其他课程**（密训班/咨询/顾问）：
- 不消耗冻结积分
- 直接按比例加到可提现积分
- 青鸾：发功德分，不发积分
- 鸿鹄：按比例发积分到可提现字段

**重要**：功德分和积分不可同时发放

**积分解冻流程（推荐初探班）**：

\`\`\`mermaid
flowchart TD
    A[学员B购买初探班] --> B[系统查询推荐人A]
    B --> C{A的大使等级?}
    
    C -->|普通学员| D[不处理<br/>结束]
    
    C -->|准青鸾| E[自动升级流程]
    E --> E1[升级A为青鸾大使]
    E1 --> E2[发放1688冻结积分]
    E2 --> E3[标记这是第1次推荐]
    E3 --> E4[不发功德分]
    E4 --> E5[发送升级通知]
    E5 --> Z[结束]
    
    C -->|青鸾| F0{A是第1次推荐?}
    F0 -->|是| F1[解冻1688积分]
    F1 --> F2[frozen_points: 1688-1688=0]
    F2 --> F3[available_points: 0+1688=1688]
    F3 --> F4[标记已解冻]
    F4 --> F5[不发功德分]
    F5 --> F6[发送积分解冻通知]
    F6 --> Z
    
    F0 -->|否| F7[计算功德分30%]
    F7 --> F8[发放功德分]
    F8 --> F9[发送功德分到账通知]
    F9 --> Z
    
    C -->|鸿鹄/金凤| G{A还有冻结积分?}
    G -->|有| H[解冻1688积分]
    H --> I[frozen_points: -1688]
    I --> J[available_points: +1688]
    J --> K[记录积分解冻明细]
    K --> L[发送积分解冻通知]
    L --> Z
    
    G -->|无| M[按比例计算积分30%]
    M --> N[available_points: +积分]
    N --> O[记录积分明细]
    O --> P[发送积分到账通知]
    P --> Z
    
    note1[初探班特殊规则:<br/>优先解冻冻结积分<br/>无冻结时按比例加到可提现]
\`\`\`

**推荐其他课程流程（密训班/咨询/顾问）**：

\`\`\`mermaid
flowchart TD
    A[学员B购买密训班/咨询/顾问] --> B[系统查询推荐人A]
    B --> C{A的大使等级?}
    
    C -->|普通学员/准青鸾| D[不处理<br/>结束]
    
    C -->|青鸾| E1[计算功德分]
    E1 --> E2[按比例发放功德分]
    E2 --> E3[不发积分]
    E3 --> E4[发送功德分通知]
    E4 --> Z[结束]
    
    C -->|鸿鹄/金凤| F1[计算积分百分比]
    F1 --> F2[密训班20%/咨询20%/顾问3%]
    F2 --> F3[available_points直接+积分]
    F3 --> F4[不触碰frozen_points]
    F4 --> F5[记录积分明细]
    F5 --> F6[发送积分到账通知]
    F6 --> Z
    
    note1[关键：密训班等课程<br/>不消耗冻结积分<br/>直接加到可提现积分]
\`\`\`

**提现流程**：

\`\`\`mermaid
flowchart TD
    A[用户查看可提现积分] --> B[点击提现]
    B --> C[填写提现金额和账户]
    C --> D[提交提现申请]
    D --> E[后台审核]
    E --> F{审核结果}
    F -->|拒绝| G[通知用户原因]
    F -->|通过| H[财务处理转账]
    H --> I[更新积分状态]
    I --> J[记录提现记录]
    J --> K[通知用户提现成功]
\`\`\`

---

#### 3.1.7.4 推荐二维码
**功能描述**：生成专属推荐二维码

**生成资格**：
- **准青鸾及以上等级**才能生成推荐二维码
- 普通学员不显示此功能

**功能**：
- 生成带推荐人ID的小程序码
- 保存到相册
- 分享到微信好友/朋友圈
- 二维码统计（扫码人数、转化率）

**二维码包含信息**：
- 推荐人ID
- 推荐人昵称
- 推荐人等级
- 二维码有效期

**准青鸾大使提示**：
- 准青鸾大使生成二维码时显示提示：
  - "您当前为准青鸾大使，暂时只能推荐初探班学员"
  - "推荐1位学员购买初探班后，将自动升级为青鸾大使"
  - "升级后可推荐所有课程"

#### 3.1.7.5 直接推荐人员信息
**功能描述**：查看直接推荐的学员和大使

**显示内容**：
- 推荐人数统计
  - 总推荐人数
  - 初探班人数
  - 密训班人数
  - 成为大使人数

**推荐列表**：
- 学员头像
- 学员昵称
- 购买课程
- 注册时间
- 累计消费
- 是否成为大使
---

## 3.2 后台管理系统功能

### 3.2.1 管理员登录
**功能描述**：后台管理员账号密码登录

**功能**：
- 用户名/手机号登录
- 密码加密存储
- 登录日志记录
- 权限验证
- Session管理

---

### 3.2.2 课程管理

#### 课程列表
**功能描述**：查看和管理所有课程

**列表显示**：
- 课程ID
- 课程名称
- 课程类型（初探班/密训班/咨询/顾问）
- 课程价格
- 复训价格
- 上架状态
- 创建时间
- 操作（编辑/删除/上下架）

#### 新增/编辑课程
**表单字段**：
- 课程名称
- 课程分类
- 课程封面图
- 课程详情图
- 课程简介
- 课程详细介绍（富文本）
- 课程大纲
- 讲师信息
- 课程时长
- 原价
- 现价
- 复训价格
- 是否允许复训
- 报名截止时间（相对开课时间，如：提前1天）
- 复训截止时间（默认：开课前3天）
- 购买限制（已取消，密训班可直接购买）
- 包含课程（多选，如密训班包含初探班）
- 库存数量
- 排序
- 上架状态

**时间规则说明**：
- **报名截止时间**：超过此时间后，首次报名和复训都无法进行
- **复训截止时间**：开课前3天为复训截止时间
  - 开课前三天可以取消复训并退款
  - 到了开课前三天则不能取消和退款

**消息推送配置**：
- 是否启用消息提醒
- 提前天数（开课前几天发送）
- 发送时间（几点几分发送）
- 消息模板内容
- 推送对象（已报名学员/已购买学员）

**消息模板变量**：
- {学员姓名}
- {课程名称}
- {上课日期}
- {上课时间}
- {上课地点}
- {讲师名称}

---

### 3.2.3 学员管理

**功能描述**：管理所有注册学员

**列表显示**：
- 学员ID
- 头像
- 昵称
- 手机号
- 出生八字
- 从事行业
- 注册时间
- 推荐人
- 大使等级
- 累计消费
- 购买课程数
- 操作（查看详情/编辑/禁用）

**学员详情**：
- 基本信息
  - 头像、昵称
  - 真实姓名、手机号
  - 性别
  - 出生八字（年月日时）
  - 从事行业
  - 所在地区（省份、城市）
  - 个人简介
  - 注册时间
  - 推荐人（传播大使）
  - 大使等级
- 购买记录
- 上课记录
- 复训情况
- 直接推荐的学员列表
- 功德分明细
- 积分明细
- 预约记录

**权限管理**：
- 设置大使等级
- 手动调整功德分
- 手动调整积分
- 禁用/启用账号
- 修改推荐关系（特殊情况，需记录变更日志）

**推荐人管理**：
- 查看当前推荐人信息
- 推荐人状态（未确认/已确认）
- 推荐人确认时间
- 查看推荐人变更历史记录：
  - 变更时间
  - 原推荐人
  - 新推荐人
  - 变更类型（注册/用户修改/订单修改/管理员修改）
  - 变更来源
  - 关联订单（如有）
  - 变更IP和设备
  - 操作人
- 管理员修改推荐人（需填写原因，记录日志）

**复训管理**：
- 查看每个学员的复训情况
- 查看复训记录和上课次数统计

---

### 3.2.4 上课记录管理

**功能描述**：登记每次课程的上课学员

**功能列表**：
1. 创建上课记录
2. 签到管理
3. 记录查询

#### 创建上课记录
**表单字段**：
- 课程名称
- 上课日期
- 上课时间
- 上课地点
- 讲师
- 课程期数

**自动触发功能**：
- 创建上课记录后，系统自动根据课程的消息提醒配置生成发送计划
- 如课程配置了"提前3天，10:00发送"，系统将自动在指定时间发送提醒

#### 签到管理
**功能**：
- 扫码签到
- 手动签到
- 查看签到名单
- 导出签到表

**签到记录包括**：
- 学员姓名
- 签到时间
- 是否首次上课
- 是否复训
- 备注

**签到流程**：

\`\`\`mermaid
flowchart TD
    A[学员到场] --> B[扫码/手动签到]
    B --> C[系统查询user_courses]
    C --> D{是否首次上课}
    
    D -->|是| E1[标记首次上课]
    E1 --> F
    
    D -->|否| E2[标记复训]
    E2 --> F
    
    F[增加上课次数+1]
    F --> G[记录签到详情]
    G --> H[更新学员课程数据]
    H --> I[签到完成]
\`\`\`

**业务规则**：
- 只要第二次来上课都称作复训
- 复训只以报名时间为准，没有次数限制
- 记录自动更新到"我的课程"
- 支持补签和取消签到

---

### 3.2.5 订单管理

**功能描述**：管理所有课程购买订单

**列表显示**：
- 订单号
- 购买学员
- 课程名称
- 订单金额
- 支付状态
- 支付时间
- 推荐人
- 功德分
- 积分处理状态
- 操作（查看详情/退款）

**订单详情**：
- 订单基本信息
- 学员信息
- 课程信息
- 支付信息（支付方式、支付流水号）
- **推荐人信息**：
  - 推荐人昵称/手机号
  - 推荐人等级
  - 推荐人确认时间（支付成功时记录）
  - 是否最终确定（已支付订单均为已确定）
  - 查看推荐人详细资料
- 功德分分配记录
- 积分解冻记录
- 奖励发放状态（未发放/已发放）
- 奖励发放时间
- 退款信息（如有）

**订单筛选**：
- 按时间范围
- 按课程类型
- 按支付状态
- 按推荐人

**退款处理流程**：

\`\`\`mermaid
flowchart TD
    A[学员申请退款] --> B[后台审核]
    B --> C{是否同意}
    C -->|拒绝| D[通知学员原因]
    C -->|同意| E[执行退款]
    E --> F[回退功德分]
    F --> G{是否有积分解冻?}
    G -->|有| G1[回退积分解冻]
    G -->|无| H
    G1 --> H[更新订单状态]
    H --> I[记录退款原因]
    I --> J[通知学员退款成功]
\`\`\`

**订单统计**：
- 总销售额
- 各课程销售数量
- 销售趋势图
- 推荐转化率

---

### 3.2.6 大使管理

**功能描述**：管理传播大使信息、功德分和积分

#### 准青鸾大使申请管理

**功能描述**：管理学员提交的准青鸾大使申请

**申请列表显示**：
- 申请ID
- 申请人头像昵称
- 真实姓名
- 手机号
- 所在城市
- 申请时间
- 申请状态（待审核/已通过初审/待面试/面试通过/已拒绝）
- 操作（查看详情/审核/安排面试）

**申请详情页面**：
- 申请人基本信息（头像、昵称、真实姓名、手机号、微信号）
- 所在城市、职业
- 是否已购买密训班（系统自动检查）
- 购买记录（购买时间、金额）
- 申请原因
- 对天道文化的理解
- 是否愿意帮助他人
- 推广计划
- 审核操作区

**审核操作**：
1. **初审通过**：
   - 点击"通过初审"
   - 状态变更为"已通过初审"
   - 可安排面试

2. **安排面试**：
   - 填写面试时间
   - 填写面试地点/线上链接
   - 填写联系人信息
   - 发送面试通知给申请人
   - 状态变更为"待面试"

3. **面试通过**：
   - 点击"面试通过"
   - 填写面试评价
   - 系统自动将用户升级为准青鸾大使（等级设为1）
   - 发送通过通知
   - 状态变更为"面试通过"

4. **拒绝申请**：
   - 填写拒绝原因
   - 发送拒绝通知
   - 状态变更为"已拒绝"
   - 用户保持普通学员身份

**筛选功能**：
- 按申请状态筛选
- 按申请时间筛选
- 搜索姓名/手机号

**统计数据**：
- 总申请数
- 待审核数
- 待面试数
- 通过率

#### 大使列表
**显示内容**：
- 大使ID
- 头像昵称
- 大使等级（准青鸾/青鸾/鸿鹄/金凤）
- 功德分余额
- 积分余额（可提现/冻结）
- 直接推荐人数
- 成为大使时间
- 操作（查看详情/编辑）

**准青鸾大使标识**：
- 列表中准青鸾大使特殊标识
- 显示推荐进度：已推荐X人（距离升级还需推荐1个初探班）
- 显示成为准青鸾的天数

#### 大使详情

**1. 大使基本信息**
- 姓名
- 手机号
- 微信号
- 大使等级
- 成为大使时间
- 合同到期时间

**2. 功德分信息**
- 功德分余额
- 累计获得功德分
- 累计兑换

**3. 积分信息**
- 总积分余额
- 可提现积分
- 冻结积分
- 累计提现
- 待审核提现

**4. 大使奖励核算**

显示每笔订单和活动带来的奖励：

**推荐订单奖励**：
- 订单时间
- 订单金额
- 购买学员
- 课程名称
- 奖励类型（功德分/积分）
- 奖励数量
- 积分解冻数量（鸿鹄及以上，如有）
- 状态（待发放/已发放/已取消）

**说明**：
- 青鸾大使：只显示功德分
- 鸿鹄及以上：只显示积分（解冻或直接发放）
- 密训班：按38888元计算奖励

**5. 会务义工、辅导员活动记录**

记录大使参与活动情况：
- 活动日期
- 活动类型（辅导员/会务义工/沙龙组织/其他）
- 活动名称
- 活动地点
- 奖励功德分
- 备注
- 记录时间

**添加活动记录**：
- 选择大使
- 选择活动类型
- 填写活动信息
- 设置奖励功德分
- 提交后自动发放功德分

**统计数据**：
- 累计参与次数
- 累计获得功德分
- 按活动类型分类统计

**6. 推荐学员和大使情况**

**推荐统计**：
- 直推学员数
- 直推大使数
- 各等级大使分布

**推荐学员列表**：

列表显示字段：
- 序号
- 学员头像
- 学员昵称
- 手机号
- 注册时间
- 大使等级（普通学员/准青鸾/青鸾/鸿鹄/金凤）
- 购买课程数
- 累计消费金额
- 为该大使带来的功德分
- 为该大使带来的解冻积分
- 状态（正常/已禁用）

**筛选功能**：
- 按大使等级筛选
- 按注册时间筛选
- 按消费金额排序
- 搜索学员昵称/手机号

**操作功能**：
- 查看学员详细信息
- 查看学员的购买记录
- 导出推荐学员列表

#### 功德分管理
**功能**：
- 手动调整功德分
- 功德分兑换审核
- 功德分冻结/解冻

#### 积分管理
**功能**：
- 手动调整积分
- 手动冻结/解冻积分
- 积分提现审核
- 查看提现记录

**积分提现审核流程**：

\`\`\`mermaid
flowchart TD
    A[用户提交提现申请] --> B[后台查看待审核列表]
    B --> C[查看申请详情]
    C --> D{审核判断}
    D -->|拒绝| E[填写拒绝原因]
    E --> F[通知用户]
    D -->|通过| G[确认转账信息]
    G --> H[标记待转账]
    H --> I[财务转账]
    I --> J[更新为已提现]
    J --> K[扣除可提现积分]
    K --> L[通知用户到账]
\`\`\`

#### 大使升级
**功能**：
- 审核准青鸾大使申请（面试审核）
- 查看准青鸾大使推荐进度
- 自动升级：准青鸾→青鸾（推荐1个初探班后自动）
- 手动升级大使等级（特殊情况）
- 设置合同期
- 发放冻结积分
- 分配名额（鸿鹄大使、金凤大使）

**准青鸾大使申请审核流程**：

\`\`\`mermaid
flowchart TD
    A[学员提交准青鸾大使申请] --> B[后台查看申请列表]
    B --> C[查看申请人资料]
    C --> D[确认已购买密训班]
    D --> E{初步审核}
    E -->|不通过| F[拒绝申请<br/>填写原因]
    E -->|通过| G[安排面试]
    G --> H[记录面试时间]
    H --> I[面试进行中]
    I --> J{面试评估}
    J -->|不通过| F
    J -->|通过| K[批准申请]
    K --> L[升级为准青鸾大使]
    L --> M[设置等级=1]
    M --> N[记录升级时间]
    N --> O[发送通知]
    O --> P[等待推荐初探班<br/>推荐成功后需签署协议]
\`\`\`

**准青鸾自动升级为青鸾**：
- 系统自动检测准青鸾大使的推荐情况
- 当推荐的学员购买初探班并支付成功后
- 触发升级流程：
  1. 发送升级通知，提示签署协议
  2. 用户在小程序签署《传播大使合作协议》
  3. 签署成功后，等级从1升级到2（准青鸾→青鸾）
  4. 记录合同期1年
  5. 发放1688冻结积分
  6. 标记这是第1次推荐（用于后续解冻判断）
  7. 不发放功德分
  8. 发送升级成功通知

**注意**：
- 必须签署《传播大使合作协议》才能正式升级为青鸾大使
- 未签署协议前，保持准青鸾状态，无法获得奖励
- 成为青鸾时获得1688冻结积分
- 第1次推荐初探班时解冻1688积分
- 第2次及之后推荐只获得功德分

---

### 3.2.7 消息提醒管理

**功能描述**：管理课程提醒消息的发送

#### 消息提醒配置

**功能**：
- 查看所有课程的消息提醒配置
- 编辑消息提醒规则
- 查看消息发送记录
- 手动触发消息发送

**配置项**：
- 课程名称
- 是否启用
- 提前天数
- 发送时间
- 消息模板
- 推送状态（启用/禁用）

#### 消息发送记录

**列表显示**：
- 发送时间
- 课程名称
- 上课日期
- 接收学员数
- 发送成功数
- 发送失败数
- 状态（待发送/发送中/已完成/失败）
- 操作（查看详情/重新发送）

**发送详情**：
- 学员列表
- 发送状态（成功/失败）
- 失败原因
- 消息内容

**消息发送流程**：

\`\`\`mermaid
flowchart TD
    A[后台创建上课记录] --> B[系统检查课程消息配置]
    B --> C{是否启用消息提醒?}
    C -->|否| D[不发送消息]
    C -->|是| E[读取配置参数]
    E --> F[提前天数N天<br/>发送时间HH:MM]
    F --> G[计算发送时间<br/>上课日期-N天 HH:MM]
    G --> H[创建消息发送计划]
    
    H --> I[定时任务每天检查]
    I --> J{到达发送时间?}
    J -->|否| I
    J -->|是| K[获取已预约学员列表]
    K --> L[生成消息内容<br/>填充模板变量]
    L --> M[逐个发送消息]
    
    M --> N{发送成功?}
    N -->|是| O[记录成功+1]
    N -->|否| P[记录失败+1<br/>记录失败原因]
    
    O --> Q{还有学员?}
    P --> Q
    Q -->|是| M
    Q -->|否| R[更新消息记录状态]
    R --> S[发送完成]
\`\`\`

#### 消息推送规则

**业务规则**：
1. 系统每天定时检查即将开课的课程
2. 根据课程设置的提前天数和时间自动发送提醒
3. 仅向已预约该课程的学员发送
4. 支持小程序订阅消息
5. 记录每次发送的详细日志

**示例**：
\`\`\`
课程：初探班第10期
上课时间：2024-12-25 09:00
提醒设置：提前3天，每天10:00发送

发送计划：
- 2024-12-22 10:00 发送第一次提醒
- 2024-12-23 10:00 发送第二次提醒  
- 2024-12-24 10:00 发送第三次提醒
\`\`\`

#### 手动发送消息

**功能**：
- 选择课程
- 选择目标学员（全部/部分）
- 自定义消息内容
- 立即发送或定时发送

---

### 3.2.8 系统管理

#### 后台用户管理
**功能描述**：管理后台管理员账号

**功能列表**：
- 添加管理员
- 编辑管理员信息
- 删除管理员
- 角色权限管理
- 操作日志查看

**字段**：
- 用户名
- 真实姓名
- 手机号
- 角色（超级管理员/课程管理员/订单管理员/客服）
- 状态
- 最后登录时间

#### 推荐人变更审计
**功能描述**：审计和监控推荐人变更记录，防止恶意刷单

**列表显示**：
- 变更时间
- 用户昵称/手机号
- 原推荐人
- 新推荐人
- 变更类型（注册/用户修改/订单修改/管理员修改）
- 变更来源（用户资料/订单页/后台）
- 关联订单号
- 变更IP地址
- 变更设备
- 操作人
- 状态（正常/异常）

**筛选功能**：
- 按变更时间范围筛选
- 按变更类型筛选
- 按用户搜索
- 按推荐人搜索
- 按异常状态筛选

**异常检测规则**：
- 同一用户7天内修改超过1次：标记为异常
- 同一用户频繁在不同推荐人之间切换：标记为高风险
- 同一IP短时间内多个用户修改推荐人：标记为可疑
- 同一推荐人短时间内被大量设置：标记为刷单嫌疑

**操作功能**：
- 查看详情
- 标记异常
- 冻结用户
- 导出记录
- 统计分析

**统计数据**：
- 今日变更次数
- 本周变更趋势
- 异常变更占比
- 高频变更用户Top10
- 高频被选推荐人Top10

#### 通知公告管理
**功能**：
- 发布通知公告
- 编辑/删除公告
- 设置重要公告
- 公告置顶

#### 系统设置
**功能**：
- 小程序基本信息
- 客服联系方式
- 支付配置
- 复训规则设置
- 功德分规则设置
- 积分规则设置
- 分佣比例配置

#### 协议模板管理
**功能描述**：管理传播大使电子协议模板

**协议模板列表**：
- 模板ID
- 协议名称
- 协议类型（传播大使合作/补充协议）
- 版本号
- 状态（启用/停用）
- 创建时间
- 最后修改时间
- 操作（编辑/预览/停用）

**协议模板类型**：
1. 《传播大使合作协议》
2. 《鸿鹄大使补充协议》

**编辑协议模板**：
- 协议名称
- 协议内容（富文本编辑器）
- 版本号（自动生成）
- 生效时间
- 变量标签支持：
  - {用户姓名}
  - {手机号}
  - {签署日期}
  - {合同开始日期}
  - {合同结束日期}
  - {大使等级}

**协议版本管理**：
- 查看历史版本
- 版本对比
- 恢复到某个版本
- 新版本自动编号

**业务规则**：
- 每次修改协议内容自动生成新版本
- 新版本从生效时间起对新签署生效
- 已签署的协议不受新版本影响
- 停用的协议不可用于新签署

---

### 3.2.9 协议签署管理

**功能描述**：管理和查询电子协议签署记录

#### 协议签署记录列表

**列表显示**：
- 签署ID
- 用户昵称/手机号
- 协议名称
- 协议类型
- 协议版本
- 签署时间
- 关联订单号（如有）
- 签署IP地址
- 签署设备
- 协议状态（有效/已到期/已作废）
- 操作（查看详情/导出）

**筛选功能**：
- 按协议类型筛选
- 按签署时间范围筛选
- 按协议状态筛选
- 搜索用户姓名/手机号
- 搜索订单号

**签署详情**：
- 用户信息：头像、昵称、真实姓名、手机号
- 协议信息：
  - 协议名称
  - 协议版本号
  - 协议完整内容（带用户信息填充）
- 签署信息：
  - 签署时间
  - 签署IP地址
  - 签署设备信息（型号、系统版本）
  - 签署确认方式（手机号后四位）
- 关联信息：
  - 关联订单号（如有）
  - 关联课程（如有）
  - 大使等级（如有）
  - 合同期限（传播大使协议）
- 操作：
  - 导出PDF
  - 打印协议
  - 作废协议（特殊情况）

**统计数据**：
- 各类协议签署总数
- 今日新增签署数
- 本月签署趋势图
- 即将到期协议数（传播大使协议）

#### 协议到期提醒

**功能描述**：管理传播大使合作协议到期提醒

**提醒列表**：
- 大使姓名/昵称
- 大使等级
- 合同开始时间
- 合同到期时间
- 距离到期天数
- 续签状态（未续签/已续签）
- 操作（发送提醒/手动续签）

**提醒规则**：
- 到期前30天显示预警
- 到期前7天发送提醒通知
- 到期当天再次提醒
- 已续签的不再提醒

**手动续签操作**：
- 选择大使
- 确认续签1年
- 系统自动更新合同结束时间
- 发送续签成功通知

---

### 3.2.10 反馈管理

**功能描述**：管理用户提交的意见反馈

#### 反馈列表

**列表显示**：
- 反馈ID
- 用户昵称/手机号
- 反馈课程（显示课程名称，无课程显示"通用反馈"）
- 反馈类型（功能建议/课程内容/课程服务/讲师/场地/问题反馈/投诉）
- 反馈内容（简略显示前50字）
- 图片数量
- 状态（待处理/处理中/已处理/已关闭）
- 提交时间
- 操作（查看详情/回复/标记处理/关闭）

**筛选功能**：
- 按反馈类型筛选
- 按处理状态筛选
- 按课程筛选
- 按时间范围筛选
- 搜索用户昵称/手机号

**统计信息**：
- 待处理数量
- 今日新增反馈
- 本周反馈数量
- 各类型反馈占比

#### 反馈详情

**显示内容**：
- 用户信息：头像、昵称、手机号
- 反馈课程：课程名称（如有）
- 反馈类型
- 反馈内容
- 图片查看（大图预览）
- 联系方式
- 提交时间
- 处理状态
- 处理记录：
  - 状态变更记录
  - 处理人
  - 处理时间

**操作功能**：
- 回复反馈（填写回复内容）
- 更改状态（待处理→处理中→已处理→已关闭）
- 标记重要
- 导出反馈记录
- 转发相关部门

**处理流程**：

\`\`\`mermaid
flowchart TD
    A[用户提交反馈] --> B[进入待处理列表]
    B --> C[管理员查看]
    C --> D{反馈类型判断}
    D -->|一般反馈| E[标记处理中]
    D -->|紧急问题| F[优先处理]
    E --> G[调查问题/改进建议]
    F --> G
    G --> H[填写回复内容]
    H --> I[标记已处理]
    I --> J[系统通知用户]
    J --> K{用户满意?}
    K -->|是| L[关闭反馈]
    K -->|否| M[继续跟进]
    M --> G
\`\`\`

#### 课程反馈统计

**功能描述**：统计各课程的反馈情况

**显示内容**：
- 课程名称
- 反馈总数
- 好评数（课程内容/服务类型且已处理）
- 问题数（问题反馈/投诉类型）
- 待处理数
- 满意度评分（根据反馈类型和处理情况计算）

**用途**：
- 发现课程质量问题
- 改进课程内容和服务
- 评估讲师表现
- 优化场地安排

---

## 四、数据库设计

### 4.1 数据库关系图

\`\`\`mermaid
erDiagram
    users ||--o{ orders : "购买"
    users ||--o{ user_courses : "拥有"
    users ||--o{ merit_points_records : "获得功德分"
    users ||--o{ cash_points_records : "积分记录"
    users ||--o{ withdraw_records : "提现记录"
    users ||--o{ attendance_records : "签到"
    users ||--o{ appointments : "预约"
    users ||--o{ referee_relations : "推荐关系"
    users ||--o{ contract_signatures : "签署协议"
    
    courses ||--o{ orders : "被购买"
    courses ||--o{ user_courses : "包含"
    courses ||--o{ class_records : "开班"
    courses ||--o{ course_notification_configs : "消息配置"
    
    orders ||--o{ merit_points_records : "产生功德分"
    orders ||--o{ cash_points_records : "积分变动"
    
    class_records ||--o{ attendance_records : "学员签到"
    class_records ||--o{ appointments : "被预约"
    class_records ||--o{ notification_logs : "消息提醒"
    
    notification_logs ||--o{ notification_details : "发送明细"
    users ||--o{ notification_details : "接收消息"
    
    user_courses ||--o{ attendance_records : "上课记录"
    user_courses ||--o{ appointments : "课程预约"
    
    contract_templates ||--o{ contract_signatures : "签署"
    
    users {
        int id PK
        string openid
        string nickname
        int referee_id FK
        int ambassador_level
        decimal merit_points
        decimal cash_points_frozen
        decimal cash_points_available
    }
    
    courses {
        int id PK
        string name
        int type
        decimal current_price
        decimal retrain_price
    }
    
    orders {
        int id PK
        string order_no
        int user_id FK
        int course_id FK
        decimal amount
        int referee_id FK
    }
    
    merit_points_records {
        int id PK
        int user_id FK
        int source
        decimal amount
        int order_id FK
    }
    
    cash_points_records {
        int id PK
        int user_id FK
        int type
        decimal amount
        int order_id FK
    }
    
    withdraw_records {
        int id PK
        int user_id FK
        decimal amount
        int status
    }
    
    contract_templates {
        int id PK
        string contract_name
        int contract_type
        string version
        int status
    }
    
    contract_signatures {
        int id PK
        int user_id FK
        int contract_template_id FK
        int ambassador_level
        datetime sign_time
        int status
    }
\`\`\`

### 4.2 核心数据表

#### 用户表 (users)
\`\`\`
id                      主键
openid                  微信openid
unionid                 微信unionid
nickname                昵称
avatar                  头像
real_name               真实姓名
phone                   手机号
gender                  性别
birth_bazi              出生八字（年月日时）
industry                从事行业
province                省份
city                    城市
personal_intro          个人简介
profile_completed       资料是否完善(0否/1是)
referee_id              推荐人ID（可修改，首次购买支付成功后确认）
referee_code            推荐码（唯一）
referee_updated_at      推荐人最后修改时间
is_referee_confirmed    推荐人是否已确认(0否/1是，首次购买支付成功后设为1)
referee_confirmed_at    推荐人确认时间（首次购买支付成功时间）
ambassador_level        大使等级(0普通/1准青鸾/2青鸾/3鸿鹄/4金凤)
merit_points            功德分余额
cash_points_frozen      冻结积分
cash_points_available   可提现积分
is_first_recommend      是否首次推荐(0否/1是，青鸾大使专用)
contract_start          合同开始时间（青鸾及以上有值）
contract_end            合同结束时间（青鸾及以上有值）
status                  状态(1正常/0禁用)
created_at              创建时间
updated_at              更新时间
\`\`\`

**合同字段说明**：
- 准青鸾大使：contract_start和contract_end为空（无需签署协议）
- 青鸾大使：签署《传播大使合作协议》后填写，合同期1年
- 鸿鹄大使：签署《鸿鹄大使补充协议》后可续签，更新合同结束时间
- 金凤大使：同鸿鹄大使规则

#### 课程表 (courses)
\`\`\`
id                  主键
name                课程名称
type                课程类型(1初探班/2密训班/3咨询/4顾问)
cover_image         封面图
description         简介
content             详细介绍
outline             课程大纲
teacher             讲师信息
duration            课程时长
original_price      原价
current_price       现价
retrain_price       复训价格
allow_retrain       是否允许复训
prerequisite_id     前置课程ID（已废弃，密训班可直接购买）
included_course_ids 包含的课程ID（JSON数组，如密训班包含初探班：["1"]）
stock               库存
sort                排序
status              状态(1上架/0下架)
created_at          创建时间
updated_at          更新时间
\`\`\`

#### 订单表 (orders)
\`\`\`
id                  主键
order_no            订单号（唯一）
user_id             购买用户ID
course_id           课程ID
course_name         课程名称
amount              订单金额
pay_status          支付状态(0待支付/1已支付/2已取消/3已退款)
pay_time            支付时间
pay_method          支付方式
transaction_id      支付流水号
referee_id          推荐人ID（支付前可修改，支付后最终确定）
referee_confirmed_at 推荐人确认时间（支付成功时记录）
is_reward_granted   是否已发放奖励(0否/1是)
reward_granted_at   奖励发放时间
is_retrain          是否复训(0否/1是)
refund_reason       退款原因
refund_time         退款时间
created_at          创建时间
updated_at          更新时间
\`\`\`

#### 用户课程表 (user_courses)
\`\`\`
id                  主键
user_id             用户ID
course_id           课程ID
order_id            订单ID
buy_time            购买时间
first_class_time    首次上课时间
attend_count        上课次数
status              状态(1正常/0过期)
created_at          创建时间
updated_at          更新时间
\`\`\`

#### 上课记录表 (class_records)
\`\`\`
id                  主键
course_id           课程ID
course_name         课程名称
class_date          上课日期
class_time          上课时间
class_location      上课地点
teacher             讲师
period              期数
created_at          创建时间
\`\`\`

#### 签到记录表 (attendance_records)
\`\`\`
id                  主键
class_record_id     上课记录ID
user_id             学员ID
user_course_id      用户课程ID
checkin_time        签到时间
is_first_class      是否首次上课(0否/1是)
is_retrain          是否复训(0否/1是)
remark              备注
created_at          创建时间
\`\`\`

#### 功德分记录表 (merit_points_records)
\`\`\`
id                  主键
user_id             用户ID
source              来源(1推荐初探班/2推荐密训班/3推荐咨询/4推荐顾问/5辅导员/6义工/7沙龙活动/8兑换/9其他)
amount              功德分数量
order_id            关联订单ID(推荐时有值)
referee_user_id     被推荐人ID(推荐时有值)
activity_id         活动ID(辅导员/义工时有值)
remark              备注
created_at          创建时间
\`\`\`

#### 积分记录表 (cash_points_records)
\`\`\`
id                  主键
user_id             用户ID
type                类型(1获得冻结/2解冻/3直接发放/4提现/5退款回退)
amount              积分数量
order_id            关联订单ID
referee_user_id     被推荐人ID
remark              备注
created_at          创建时间
\`\`\`

#### 提现记录表 (withdraw_records)
\`\`\`
id                  主键
user_id             用户ID
withdraw_no         提现单号（唯一）
amount              提现金额
account_type        账户类型(1微信/2支付宝/3银行卡)
account_info        账户信息(JSON)
status              状态(0待审核/1审核通过/2已转账/3已拒绝)
reject_reason       拒绝原因
apply_time          申请时间
audit_time          审核时间
transfer_time       转账时间
created_at          创建时间
updated_at          更新时间
\`\`\`

**说明**：
- 密训班购买时，系统自动创建两条user_courses记录：密训班+初探班
- 通过course_id和order_id关联，无需额外表记录

#### 推荐关系表 (referee_relations)
\`\`\`
id                  主键
user_id             用户ID
referee_id          推荐人ID（传播大使ID）
created_at          创建时间
\`\`\`

**说明**：
- referee_id：推荐该用户的传播大使ID
- 只记录直接推荐关系，无多层级概念

#### 推荐人变更日志表 (referee_change_logs)
\`\`\`
id                  主键
user_id             用户ID
old_referee_id      原推荐人ID
new_referee_id      新推荐人ID
change_type         变更类型(1注册/2用户主动修改/3订单修改/4管理员修改)
change_source       变更来源(1小程序用户资料/2订单确认页/3后台管理)
order_id            关联订单ID（订单修改时有值）
change_ip           变更IP地址
change_device       变更设备信息(JSON)
admin_id            管理员ID（管理员修改时有值）
remark              备注
created_at          创建时间
\`\`\`

**说明**：
- 记录所有推荐人变更操作，用于审计和风控
- change_type类型：
  - 1注册：用户首次注册时临时设置推荐人
  - 2用户主动修改：用户在个人资料页面修改推荐人
  - 3订单修改：用户在订单确认页面修改推荐人
  - 4管理员修改：后台管理员特殊情况修改
- 所有变更均需记录IP地址和设备信息
- 用于风控分析和异常检测

#### 意见反馈表 (feedbacks)
\`\`\`
id                  主键
user_id             用户ID
course_id           课程ID（可为空，表示通用反馈）
feedback_type       反馈类型(1功能建议/2课程内容/3课程服务/4讲师/5场地/6问题反馈/7投诉)
content             反馈内容
images              图片(JSON数组)
contact             联系方式
status              状态(0待处理/1处理中/2已处理/3已关闭)
reply               回复内容
reply_time          回复时间
created_at          创建时间
updated_at          更新时间
\`\`\`

**说明**：
- course_id为空：通用反馈
- course_id有值：针对该课程的反馈
- 反馈类型1功能建议/6问题反馈/7投诉：通常不关联课程
- 反馈类型2课程内容/3课程服务/4讲师/5场地：通常关联课程

#### 大使申请表 (ambassador_applications)
\`\`\`
id                  主键
user_id             用户ID
real_name           真实姓名
phone               手机号
wechat_id           微信号
city                所在城市
occupation          职业
apply_reason        申请原因
understanding       对天道文化的理解
willing_help        是否愿意帮助他人
promotion_plan      推广计划
status              状态(0待审核/1已通过初审/2待面试/3面试通过/4已拒绝)
interview_time      面试时间
interview_remark    面试备注
reject_reason       拒绝原因
audit_admin_id      审核管理员ID
audit_time          审核时间
created_at          申请时间
updated_at          更新时间
\`\`\`

**说明**：
- 面试通过后直接升级为准青鸾大使
- 准青鸾大使无需签署协议

#### 协议模板表 (contract_templates)
\`\`\`
id                  主键
contract_name       协议名称
contract_type       协议类型(1传播大使合作/2补充协议)
contract_subtype    协议子类型(1大使合作/2鸿鹄补充)
content             协议内容(富文本)
version             版本号(如: v1.0, v1.1)
effective_time      生效时间
status              状态(1启用/0停用)
created_by          创建人ID
created_at          创建时间
updated_at          更新时间
\`\`\`

**说明**：
- 协议类型：1传播大使合作、2补充协议
- 协议子类型：1大使合作（青鸾大使）、2鸿鹄补充（鸿鹄大使）
- 版本号：每次修改内容自动生成新版本
- 支持变量：{用户姓名}、{手机号}、{签署日期}、{合同开始日期}、{合同结束日期}、{大使等级}等

#### 协议签署记录表 (contract_signatures)
\`\`\`
id                  主键
user_id             用户ID
contract_template_id 协议模板ID
contract_name       协议名称（冗余字段，方便查询）
contract_type       协议类型（冗余字段）
contract_version    协议版本（签署时的版本号）
contract_content    协议内容（签署时的完整内容，已填充变量）
ambassador_level    关联大使等级（1青鸾/2鸿鹄/3金凤）
sign_phone          签署手机号
sign_phone_suffix   签署确认手机号后四位
sign_ip             签署IP地址
sign_device         签署设备信息(JSON: 型号、系统、版本)
sign_time           签署时间
contract_start      合同开始时间
contract_end        合同结束时间
status              状态(1有效/2已到期/3已作废)
created_at          创建时间
updated_at          更新时间
\`\`\`

**说明**：
- 仅用于传播大使协议签署记录
- ambassador_level：1青鸾、2鸿鹄、3金凤（0准青鸾无协议）
- 签署设备信息示例：{"model": "iPhone 13", "os": "iOS", "version": "16.0"}
- contract_content保存签署时的完整内容，已替换所有变量
- status根据合同期判断：当前时间在合同期内为1有效，超过合同期为2已到期

#### 预约记录表 (appointments)
\`\`\`
id                  主键
user_id             用户ID
class_record_id     上课记录ID
user_course_id      用户课程ID
status              状态(0待上课/1已签到/2已取消/3缺席)
cancel_time         取消时间
cancel_reason       取消原因
created_at          创建时间
updated_at          更新时间
\`\`\`

#### 活动记录表 (activity_records)
\`\`\`
id                  主键
user_id             大使ID
activity_type       活动类型(1辅导员/2会务义工/3沙龙组织/4其他)
activity_name       活动名称
activity_date       活动日期
activity_location   活动地点
merit_points        奖励功德分
remark              备注
admin_id            记录人ID
created_at          创建时间
updated_at          更新时间
\`\`\`

#### 通知公告表 (announcements)
\`\`\`
id                  主键
title               标题
content             内容
type                类型(1普通/2重要)
is_top              是否置顶
status              状态(1发布/0下架)
publish_time        发布时间
created_at          创建时间
updated_at          更新时间
\`\`\`

#### 课程消息提醒配置表 (course_notification_configs)
\`\`\`
id                  主键
course_id           课程ID
is_enabled          是否启用(0否/1是)
advance_days        提前天数
send_time           发送时间(如: 10:00)
message_template    消息模板内容
target_type         推送对象(1已预约/2已购买)
created_at          创建时间
updated_at          更新时间
\`\`\`

#### 消息发送记录表 (notification_logs)
\`\`\`
id                  主键
class_record_id     上课记录ID
course_id           课程ID
course_name         课程名称
class_date          上课日期
send_time           发送时间
total_count         接收学员总数
success_count       发送成功数
fail_count          发送失败数
status              状态(0待发送/1发送中/2已完成/3失败)
created_at          创建时间
updated_at          更新时间
\`\`\`

#### 消息发送明细表 (notification_details)
\`\`\`
id                  主键
notification_log_id 消息记录ID
user_id             学员ID
message_content     消息内容
send_status         发送状态(0待发送/1成功/2失败)
fail_reason         失败原因
send_time           发送时间
created_at          创建时间
\`\`\`

---

## 五、接口设计建议

### 5.1 用户相关接口
- POST /api/user/login - 微信登录
  - 参数：code（微信code）、temp_referee_id（临时推荐人ID，扫码带来的）
  - 返回：token、is_first_login、profile_completed、is_referee_confirmed标识
- POST /api/user/complete-profile - 完善个人资料（必填：真实姓名、手机号）
- GET /api/user/info - 获取用户信息
  - 返回：包含referee_id、referee_name、is_referee_confirmed等推荐人信息
- PUT /api/user/info - 更新用户信息（包括推荐人）
- GET /api/user/referee - 获取推荐人详细信息
- PUT /api/user/update-referee - 更新推荐人
  - 参数：referee_id（新推荐人ID）
  - 校验：
    - 7天内只能修改一次
    - 不能自己推荐自己
    - 防止循环推荐
    - **推荐人必须是准青鸾及以上等级**
  - 返回：更新结果
- GET /api/user/ambassador-list - 获取可选的传播大使列表
  - 参数：course_type（可选，课程类型，用于过滤推荐人）
  - 返回：
    - 如果不传course_type：返回准青鸾及以上等级的传播大使列表
    - 如果传course_type=1（初探班）：返回准青鸾及以上等级的传播大使列表
    - 如果传course_type=2/3/4（密训班/咨询/顾问）：只返回青鸾及以上等级的传播大使列表
- GET /api/user/referee-status - 查询推荐人状态
  - 返回：is_referee_confirmed、referee_confirmed_at、can_modify（是否可修改）
- GET /api/user/profile-status - 查询资料完善状态（返回是否预览模式）

### 5.2 课程相关接口
- GET /api/course/list - 课程列表
- GET /api/course/detail - 课程详情
- GET /api/course/my - 我的课程

### 5.3 订单相关接口
- POST /api/order/create - 创建订单
  - 参数：course_id、referee_id（可选，不传则使用用户资料中的推荐人）
  - 返回：order_no、amount、referee_id、referee_name
  - 业务逻辑：
    - 订单推荐人优先级：订单指定 > 用户资料 > 无推荐人
    - **推荐人资格验证**：
      - 推荐人必须是准青鸾及以上等级
      - 准青鸾大使只能推荐初探班（course_type=1）
      - 其他课程推荐人必须是青鸾及以上等级
      - 验证失败返回错误，不允许创建订单
    - 记录推荐人变更日志（如果与用户资料不同）
- PUT /api/order/update-referee - 修改订单推荐人（支付前）
  - 参数：order_no、referee_id（新推荐人ID）
  - 校验：
    - 订单必须是待支付状态
    - **推荐人资格验证**（同创建订单）
  - 返回：更新结果
  - 记录：推荐人变更日志
- POST /api/order/pay - 发起支付
- POST /api/order/notify - 支付回调
  - **重要**：支付成功后需要：
    1. 根据courses表的included_course_ids字段，将密训班及其包含的初探班都加入用户课程
    2. **最终确定推荐人**：设置referee_confirmed_at、is_reward_granted=0
    3. **确认用户推荐人**：如果is_referee_confirmed=0，设置为1并记录确认时间
    4. 计算推荐人奖励时**只按密训班价格38888元**计算，不重复计算包含的初探班
    5. 发放奖励给订单中的推荐人（不是用户资料中的推荐人）
- GET /api/order/list - 订单列表
- GET /api/order/detail - 订单详情
  - 返回：包含referee_id、referee_name、referee_confirmed_at、is_reward_granted等信息

### 5.4 预约相关接口
- GET /api/appointment/class-plans - 课程计划列表
- POST /api/appointment/create - 创建预约
- DELETE /api/appointment/cancel - 取消预约
- GET /api/appointment/my - 我的预约

### 5.5 功德分相关接口
- GET /api/merit-points/balance - 功德分余额
- GET /api/merit-points/records - 功德分明细
- POST /api/merit-points/exchange - 功德分兑换

### 5.6 积分相关接口
- GET /api/cash-points/balance - 积分余额（冻结+可提现）
- GET /api/cash-points/records - 积分明细
- POST /api/cash-points/withdraw - 申请提现
- GET /api/cash-points/withdraw-list - 提现记录

### 5.7 大使相关接口
- GET /api/ambassador/info - 大使信息
- POST /api/ambassador/apply - 申请成为准青鸾大使
- GET /api/ambassador/apply-status - 查看申请状态
- GET /api/ambassador/qrcode - 生成推荐二维码
  - 校验：必须是准青鸾及以上等级
  - 返回：推荐二维码、推荐链接、推荐人信息
- GET /api/ambassador/referees - 推荐人员列表
- GET /api/ambassador/upgrade-progress - 查看升级进度（准青鸾查看推荐进度）
- GET /api/ambassador/validate-referee - 验证推荐人资格
  - 参数：referee_id（推荐人ID）、course_type（课程类型）
  - 返回：
    - valid（布尔值，是否有效）
    - error_message（错误提示，无效时返回）
    - referee_info（推荐人信息）
  - 用途：订单创建前验证推荐人资格

### 5.8 消息提醒相关接口
- GET /api/notification/configs - 获取消息提醒配置
- POST /api/notification/subscribe - 订阅消息授权
- GET /api/notification/history - 获取消息历史

### 5.9 其他接口
- GET /api/announcement/list - 公告列表
- GET /api/announcement/detail - 公告详情
- GET /api/material/list - 素材列表
- GET /api/case/list - 学员案例列表

### 5.10 反馈相关接口
- GET /api/feedback/my-courses - 获取可反馈的课程列表（我的课程）
- GET /api/feedback/types - 获取反馈类型列表
  - 参数：course_id（可选）
  - 返回：根据是否选择课程返回对应的反馈类型
- POST /api/feedback/submit - 提交反馈
  - 参数：course_id（可选）、feedback_type、content、images、contact
- GET /api/feedback/my-list - 我的反馈列表
- GET /api/feedback/detail - 反馈详情（含回复）

### 5.11 协议相关接口

#### 小程序端接口
- GET /api/contract/template - 获取协议模板
  - 参数：contract_type（协议类型）、ambassador_level（大使等级）
  - 返回：协议模板内容（已填充用户变量）
  - **说明**：仅青鸾及以上等级可调用
  
- POST /api/contract/sign - 签署协议
  - 参数：
    - contract_template_id（协议模板ID）
    - ambassador_level（大使等级：1青鸾/2鸿鹄）
    - sign_phone_suffix（手机号后四位）
    - sign_device（设备信息JSON）
  - 返回：签署记录ID、签署时间、合同期限
  - **重要**：
    - 准青鸾升级青鸾时必须调用此接口
    - 青鸾升级鸿鹄时必须调用此接口
  
- GET /api/contract/my-list - 我的协议列表
  - 返回：
    - 协议名称
    - 签署时间
    - 协议状态
    - 合同期限
    - 剩余天数
  - **说明**：仅青鸾及以上等级可查看
    
- GET /api/contract/detail - 协议详情
  - 参数：signature_id（签署记录ID）
  - 返回：
    - 协议完整内容
    - 签署信息（时间、IP、设备）
    - 大使等级
    - 合同期限
    
- GET /api/contract/check-sign-status - 检查协议签署状态
  - 参数：user_id（用户ID）、ambassador_level（大使等级）
  - 返回：是否已签署、签署记录ID、合同到期时间
  - **用途**：
    - 准青鸾推荐成功后检查是否已签署青鸾协议
    - 青鸾申请升级鸿鹄时检查是否已签署鸿鹄协议
  
- GET /api/contract/download-pdf - 下载协议PDF
  - 参数：signature_id（签署记录ID）
  - 返回：PDF文件流

#### 后台管理接口
- GET /api/admin/contract/template-list - 协议模板列表
- POST /api/admin/contract/template-create - 创建协议模板
- PUT /api/admin/contract/template-update - 更新协议模板（自动生成新版本）
- DELETE /api/admin/contract/template-delete - 删除协议模板
- GET /api/admin/contract/template-versions - 查看协议模板版本历史
- POST /api/admin/contract/template-restore - 恢复历史版本

- GET /api/admin/contract/signature-list - 协议签署记录列表
  - 支持筛选：协议类型、签署时间、协议状态、用户搜索
- GET /api/admin/contract/signature-detail - 协议签署详情
- POST /api/admin/contract/signature-void - 作废协议（特殊情况）
- GET /api/admin/contract/signature-export - 导出签署记录

- GET /api/admin/contract/expiring-list - 即将到期协议列表
  - 返回：30天内到期的传播大使合作协议
- POST /api/admin/contract/renew - 手动续签协议
  - 参数：user_id、renew_years（续签年数，默认1年）
  - 功能：更新合同结束时间，发送续签通知
  
- GET /api/admin/contract/statistics - 协议统计数据
  - 返回：各类协议签署总数、今日新增、本月趋势

---

## 六、非功能性需求

### 6.1 性能要求
- 页面加载时间 < 2秒
- 接口响应时间 < 500ms
- 支持同时在线用户 > 1000人
- 图片加载优化（CDN加速）

### 6.2 安全性要求
- HTTPS加密传输
- 用户token认证
- 敏感信息加密存储
- 防止SQL注入
- 接口防刷机制
- 支付安全验证
- 积分提现双重验证
- 协议签署安全：
  - 签署时验证手机号后四位
  - 记录签署IP地址和设备信息
  - 协议内容不可篡改（保存完整快照）
  - 防止重复签署同一协议

### 6.3 兼容性要求
- 支持微信小程序基础库 2.0 以上
- 兼容iOS和Android系统
- 后台管理系统支持主流浏览器（Chrome、Firefox、Safari、Edge）

### 6.4 数据备份
- 数据库每日自动备份
- 重要操作日志记录
- 数据恢复方案

### 6.5 运维监控
- 服务器性能监控
- 错误日志记录
- 用户行为统计
- 支付异常告警
- 积分异常告警

---

## 七、上线检查清单

### 7.1 小程序审核准备
- [ ] 小程序基本信息完善
- [ ] 营业执照和资质上传
- [ ] 类目选择（教育/在线教育）
- [ ] 隐私政策和用户协议
- [ ] 支付功能申请（需企业资质）
- [ ] 版本号和更新说明
- [ ] 测试账号提供

### 7.2 功能测试
- [ ] 登录授权流程
- [ ] 课程浏览和购买
- [ ] 支付流程（实际支付测试）
- [ ] 功德分计算准确性
- [ ] 积分冻结解冻准确性
- [ ] 积分提现流程
- [ ] **推荐关系建立和修改流程**
  - [ ] 扫码注册时临时记录推荐人
  - [ ] 个人资料页面修改推荐人
  - [ ] 订单确认页面修改推荐人
  - [ ] 支付成功后推荐人最终确定
  - [ ] 首次购买后推荐人锁定（不可再修改）
  - [ ] 推荐人修改频率限制（7天一次）
  - [ ] 防止自己推荐自己
  - [ ] 防止循环推荐
  - [ ] **推荐人资格验证**：
    - [ ] 推荐人必须是准青鸾及以上等级
    - [ ] 准青鸾只能推荐初探班
    - [ ] 其他课程必须青鸾及以上推荐人
    - [ ] 资格验证失败时显示错误提示
  - [ ] 推荐人变更日志记录
- [ ] **奖励发放准确性**
  - [ ] 奖励发放给订单推荐人（不是用户资料推荐人）
  - [ ] 多次修改推荐人后奖励发放正确
- [ ] **大使申请流程（准青鸾）**
- [ ] **准青鸾推荐成功后协议签署流程**
- [ ] **青鸾升级鸿鹄协议签署流程**
- [ ] 复训流程
- [ ] 预约功能
- [ ] 消息提醒功能
- [ ] **我的协议查看和下载（青鸾及以上）**
- [ ] 后台管理功能
- [ ] **后台协议模板管理**
- [ ] **后台协议签署记录查询**
- [ ] **协议到期提醒功能**
- [ ] **后台推荐人变更审计功能**
  - [ ] 查看推荐人变更日志
  - [ ] 异常检测和标记
  - [ ] 风控统计分析

### 7.3 数据准备
- [ ] 初始课程数据录入
- [ ] **传播大使协议模板准备**：
  - [ ] 《传播大使合作协议》（青鸾大使）
  - [ ] 《鸿鹄大使补充协议》（鸿鹄大使）
- [ ] 通知公告发布
- [ ] 商学院介绍内容
- [ ] 朋友圈素材准备
- [ ] 学员案例录入
- [ ] 后台管理员账号创建

### 7.4 运营准备
- [ ] 客服体系建立
- [ ] 用户操作手册
- [ ] 大使培训资料
- [ ] 推广素材准备
- [ ] 应急预案制定

---

## 八、后续迭代规划

### V1.0（基础版）
- 用户注册登录
- 课程浏览和购买
- **电子协议签署系统**
- 基础推荐关系
- 功德分系统
- 积分系统（冻结/解冻/提现）
- 消息提醒功能
- 后台管理
- **协议模板管理**
- **协议签署记录管理**

### V1.1（优化版）
- 在线客服
- 商城用品兑换
- 直播课程
- 课程评价
- 优惠券系统

### V2.0（增强版）
- 社区功能
- 学习打卡
- 作业提交
- 在线考试
- 学习证书

### V3.0（生态版）
- 知识付费
- 内容传播
- 私域流量运营
- 数据大屏
- AI智能推荐

---

## 九、项目关键风险

### 9.1 技术风险
- **风险**：支付回调处理失败导致订单状态异常
- **应对**：实现支付结果主动查询机制，定时任务检查异常订单

### 9.2 业务风险
- **风险**：功德分/积分计算错误导致财务损失
- **应对**：多重校验机制，人工审核大额积分，可回滚

### 9.3 合规风险
- **风险**：推荐分佣机制违反法律规定
- **应对**：只设置直接推荐关系，咨询法律顾问，避免传销嫌疑

### 9.4 运营风险
- **风险**：恶意刷单和虚假推荐
- **应对**：风控系统，异常订单人工审核，黑名单机制

### 9.5 积分风险
- **风险**：积分解冻机制被恶意利用
- **应对**：严格审核提现申请，限制提现频率，设置提现阈值

### 9.6 推荐人变更风险
- **风险1**：用户频繁修改推荐人套取奖励
- **应对**：
  - 7天内只能修改一次推荐人
  - 记录所有变更日志，后台可审计
  - 异常检测系统，自动标记高风险行为
  - 支付成功后推荐人不可修改（防止事后篡改）
  
- **风险2**：用户和推荐人串通刷单
- **应对**：
  - 同一IP短时间内多次修改推荐人：标记异常
  - 同一推荐人短时间内被大量用户设置：刷单嫌疑
  - 用户在多个推荐人之间频繁切换：高风险标记
  - 后台人工审核可疑订单
  
- **风险3**：循环推荐和自己推荐自己
- **应对**：
  - 系统校验：不允许自己推荐自己
  - 系统校验：不允许下级推荐上级（防止循环）
  - 数据完整性约束
  
- **风险4**：首次购买后恶意修改推荐人
- **应对**：
  - 首次购买支付成功后推荐人永久锁定（is_referee_confirmed=1）
  - 订单推荐人在支付成功后不可修改
  - 管理员修改需特殊权限并记录详细日志

---

## 十、附录

### 10.1 术语表
- **初探班**：入门级课程，价格1688元
- **密训班**：高级课程套餐，价格38888元，**默认包含初探班课程**，可直接购买（无需先购买初探班）
- **推荐奖励计算**：密训班推荐奖励只按38888元计算，不重复计算其中包含的初探班
- **复训**：已购课程学员重复上课
- **准青鸾大使**：购买密训班并通过申请和面试后的中间级别，可作为推荐人但暂无推广奖励，只能推荐初探班学员，推荐1个初探班学员购买并支付成功后自动升级为青鸾大使，升级后才能推荐其他课程
- **青鸾大使**：正式的传播大使，成为时获得1688冻结积分，第1次推荐初探班解冻积分，第2次起推荐只获得功德分
- **鸿鹄大使**：高级传播大使，推荐只获得积分，不获得功德分
- **功德分**：虚拟奖励分，不可提现，只能在商城兑换商品、课程、复训、咨询服务等。获得途径：①青鸾大使推荐（第2次起），②所有大使担任辅导员/义工（额外职责，非独立职位）
- **积分**：可提现的现金分，青鸾大使第1次推荐解冻，鸿鹄及以上大使推荐获得，采用冻结解冻机制，解冻后可提现
- **冻结积分**：固定额度的积分（青鸾1688，鸿鹄16880），只能通过推荐初探班解冻，解冻后转入可提现积分
- **可提现积分**：可以申请提现的积分，来源包括：①冻结积分解冻，②推荐其他课程直接按比例发放
- **积分解冻**：推荐初探班时，将冻结积分转为可提现积分的过程
- **积分直接发放**：推荐密训班/咨询/顾问时，不消耗冻结积分，直接按比例加到可提现积分
- **首次推荐标识**：青鸾大使专用字段，标识是否已完成第1次推荐并解冻积分
- **直接推荐关系**：传播大使与其直接推荐的学员之间的一对一推荐关系
- **互斥规则**：功德分和积分不可同时发放，每次奖励只发放其中一种
- **电子协议**：传播大使在小程序中以电子方式签署的法律协议，具有法律效力
- **协议模板**：后台预设的协议内容模板，支持变量替换，可版本管理
- **协议签署**：大使通过勾选同意并输入手机号后四位确认的电子签署行为
- **传播大使合作协议**：准青鸾升级为正式青鸾大使时签署的合作协议，合同期1年
- **鸿鹄大使补充协议**：青鸾大使升级为鸿鹄大使时签署的补充协议
- **协议版本**：协议模板的版本号（如v1.0），每次修改内容自动生成新版本
- **协议快照**：大使签署时保存的协议完整内容，保证签署内容不可篡改
- **合同期**：传播大使合作协议的有效期限，默认1年，到期需续签
- **协议前置条件**：准青鸾大使无需签署协议，只有正式青鸾大使及以上等级才需要签署协议
- **推荐人确定机制**：用户的推荐人可在注册、个人资料、订单确认时多次修改，首次购买支付成功后最终确定并永久锁定
- **临时推荐人**：用户注册时通过扫码带来的推荐人ID，保存在用户资料中但可修改
- **订单推荐人**：订单中记录的推荐人ID，可在支付前修改，支付成功后不可修改
- **最终推荐人**：用户首次购买支付成功后，订单中的推荐人即为最终推荐人，后续不可修改
- **推荐人确认**：首次购买支付成功后，用户的is_referee_confirmed设为1，推荐人被永久锁定
- **推荐人变更日志**：记录所有推荐人修改操作的日志表，用于审计和风控
- **推荐人修改频率限制**：用户7天内只能修改一次推荐人，防止恶意刷单
- **奖励发放依据**：奖励发放给订单中最终确定的推荐人，而非用户资料中的推荐人
- **推荐人资格限制**：
  - 普通学员不能作为推荐人
  - 准青鸾大使可作为推荐人，但只能推荐初探班
  - 青鸾及以上大使可推荐所有课程
- **推荐人资格验证**：创建订单和修改订单推荐人时，系统验证推荐人等级与课程类型的匹配关系，验证失败则阻止操作并提示用户更换推荐人

### 10.2 联系人
- 产品负责人：[姓名] [联系方式]
- 技术负责人：[姓名] [联系方式]
- 运营负责人：[姓名] [联系方式]

---

**文档版本**：V2.4  
**创建日期**：2024-12-22  
**最后更新**：2024-12-30  
**文档状态**：待评审  
**更新内容**：
- V2.2：简化推荐关系为直接推荐，去除多层级推荐、团队和绩效概念
- V2.3：调整推荐人确定机制，支持多次修改，首次购买支付成功后最终确定
  - 新增个人资料"我的传播大使"字段，可修改推荐人
  - 订单确认页面可修改推荐人
  - 支付成功后推荐人最终确定并永久锁定
  - 新增推荐人变更日志表（审计和风控）
  - 新增推荐人变更频率限制（7天一次）
  - 新增后台推荐人变更审计功能
  - 完善推荐人相关风控机制
- V2.4：新增推荐人资格限制规则
  - **推荐人必须是准青鸾及以上等级**（普通学员不能作为推荐人）
  - **准青鸾大使只能推荐初探班**（不能推荐密训班/咨询等其他课程）
  - **青鸾及以上大使可推荐所有课程**
  - 准青鸾推荐1个初探班后升级为青鸾大使，才能推荐其他课程
  - 新增推荐人资格验证机制（订单创建和修改时验证）
  - 完善推荐二维码生成规则
  - 更新传播大使列表过滤规则


`;

        // 初始化函数
        function init() {
            // 初始化Mermaid
            mermaid.initialize({ 
                startOnLoad: false,
                theme: 'default',
                securityLevel: 'loose'
            });

            // 配置marked
            marked.setOptions({
                breaks: true,
                gfm: true,
                tables: true
            });

            // 解析Markdown
            const htmlContent = marked.parse(markdownContent);
            
            // 插入HTML内容
            document.getElementById('content').innerHTML = htmlContent;

            // 渲染所有Mermaid图表
            mermaid.run({
                querySelector: '.language-mermaid'
            });
        }

        // 页面加载完成后执行
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>