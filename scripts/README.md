# цХ░цНох║УщГич╜▓шДЪцЬмф╜┐чФишп┤цШО

## ЁЯУЛ х╜УхЙНчК╢цАБ

тЬЕ **х╖▓хоМцИР**:
- хИЫх╗║ф║ЖцХ░цНох║УщГич╜▓шДЪцЬм `deploy-database.js`
- цПРхПЦф║ЖцЙАцЬЙ 9 ф╕кцибхЭЧчЪДх╗║шби SQLя╝ИхЕ▒ 28 х╝ашбия╝Й
- хИЫх╗║ф║Ж SQL цибхЭЧцЦЗф╗╢я╝Иambassador.js, academy-mall.js, contract.js, feedback.js, admin.jsя╝Й
- хИЫх╗║ф║Ж MySQL ш┐ЮцОец╡ЛшпХшДЪцЬм

тП│ **х╛ЕхоМцИР**:
- щЕНч╜о CloudBase MySQL хоЮф╛Л
- шо╛ч╜оцХ░цНох║Ушо┐щЧохЗншпБ
- цЙзшбМцХ░цНох║УщГич╜▓

## ЁЯФз щГич╜▓хЙНхЗЖхдЗ

### 1. хРпхКи CloudBase MySQL хоЮф╛Л

1. чЩ╗х╜Х CloudBase цОзхИ╢хП░: https://console.cloud.tencent.com/tcb
2. щАЙцЛйчОпхвГ: `cloud1-0gnn3mn17b581124`
3. ш┐ЫхЕе **ф║СцХ░цНох║У MySQL** щб╡щЭв
4. цЙ╛хИ░хоЮф╛Л: `tnt-e300s320g`
5. чбоф┐ЭхоЮф╛ЛчК╢цАБф╕║ **"ш┐РшбМф╕н"**
6. хжВцЮЬхоЮф╛ЛцЬкхРпхКия╝МчВ╣хЗ╗ **"хРпхКи"** цМЙщТо

### 2. шО╖хПЦцХ░цНох║Уш┐ЮцОеф┐бцБп

хЬи MySQL хоЮф╛ЛшпжцГЕщб╡щЭвя╝МшО╖хПЦф╗еф╕Лф┐бцБпя╝Ъ
- **хЖЕч╜СхЬ░хЭА**: чФиф║Ош┐ЮцОецХ░цНох║У
- **члпхПг**: щ╗Шшод 3306
- **чФицИ╖хРН**: щ╗Шшод root
- **хпЖчаБ**: щЬАшжБшо╛ч╜оцИЦщЗНч╜о

### 3. щЕНч╜ошо┐щЧоцЭГщЩР

чбоф┐Эф╗еф╕ЛцЭГщЩРх╖▓щЕНч╜оя╝Ъ
- хЕБшо╕ф╗Ох╜УхЙНч╜Сч╗Ьшо┐щЧо MySQL хоЮф╛Л
- хжВцЮЬф╜┐чФиф║СхЗ╜цХ░шо┐щЧоя╝МщЬАшжБщЕНч╜о VPC ч╜Сч╗Ь

### 4. шо╛ч╜очОпхвГхПШщЗП

```bash
# Windows (PowerShell)
$env:MYSQL_PASSWORD="your_password_here"

# Windows (CMD)
set MYSQL_PASSWORD=your_password_here

# Linux/Mac
export MYSQL_PASSWORD="your_password_here"
```

## ЁЯЪА щГич╜▓цнещкд

### цнещкд 1: ц╡ЛшпХш┐ЮцОе

```bash
node scripts/test-mysql-connection.js
```

хжВцЮЬш┐ЮцОецИРхКЯя╝Мф╝ЪцШ╛чд║ MySQL чЙИцЬмф┐бцБпуАВ

### цнещкд 2: щжЦцмбщкМшпБщГич╜▓я╝ИчФицИ╖цибхЭЧя╝Й

```bash
node scripts/deploy-database.js --module=users
```

ш┐Щх░ЖщГич╜▓чФицИ╖цибхЭЧчЪД 2 х╝ашбия╝Ъ
- `users` - чФицИ╖шби
- `referee_change_logs` - цОишНРф║║хПШцЫ┤цЧех┐Чшби

**щкМшпБцаЗхЗЖ**:
- тЬЕ 2 х╝ашбихИЫх╗║цИРхКЯ
- тЬЕ users шбицЬЙ `_openid` хнЧцо╡
- тЬЕ хнЧчмжщЫЖф╕║ utf8mb4_unicode_ci
- тЬЕ ч┤вх╝ХхИЫх╗║цнгчбо

### цнещкд 3: щГич╜▓хЙйф╜ЩцибхЭЧ

**хПкцЬЙцнещкд 2 щкМшпБщАЪш┐ЗхРОцЙНшГ╜цЙзшбМцндцнещкдя╝Б**

```bash
node scripts/deploy-database.js --module=remaining
```

ш┐Щх░ЖщГич╜▓хЙйф╜Щ 8 ф╕кцибхЭЧчЪД 26 х╝ашбия╝Ъ
- шп╛чиЛцибхЭЧя╝И2 х╝ашбия╝Й
- шовхНХцибхЭЧя╝И1 х╝ашбия╝Й
- щвДч║жцибхЭЧя╝И2 х╝ашбия╝Й
- хдзф╜┐цибхЭЧя╝И7 х╝ашбия╝Й
- хХЖхнжщЩвхХЖхЯОцибхЭЧя╝И5 х╝ашбия╝Й
- хНПшооцибхЭЧя╝И2 х╝ашбия╝Й
- хПНщжИц╢ИцБпцибхЭЧя╝И3 х╝ашбия╝Й
- хРОхП░чобчРЖцибхЭЧя╝И4 х╝ашбия╝Й

### цнещкд 4: хоМцХ┤щкМшпБ

щГич╜▓хоМцИРхРОя╝МщкМшпБцЙАцЬЙшбия╝Ъ

```bash
# ш┐ЮцОецХ░цНох║У
mysql -h <host> -u root -p tiandao_culture

# цгАцЯешбицХ░щЗПя╝Их║Фф╕║ 28я╝Й
SELECT COUNT(*) as table_count
FROM information_schema.tables
WHERE table_schema = 'tiandao_culture';

# хИЧхЗ║цЙАцЬЙшби
SHOW TABLES;

# цгАцЯе _openid хнЧцо╡я╝Их║ФцЬЙ 15 х╝ашбия╝Й
SELECT table_name
FROM information_schema.columns
WHERE table_schema = 'tiandao_culture'
  AND column_name = '_openid'
ORDER BY table_name;
```

## ЁЯУК цХ░цНох║Ушбиц╕ЕхНХ

### цибхЭЧ 1: чФицИ╖цибхЭЧя╝И2 х╝ашбия╝Й
- `users` - чФицИ╖шби
- `referee_change_logs` - цОишНРф║║хПШцЫ┤цЧех┐Чшби

### цибхЭЧ 2: шп╛чиЛцибхЭЧя╝И2 х╝ашбия╝Й
- `courses` - шп╛чиЛшби
- `user_courses` - чФицИ╖шп╛чиЛшби

### цибхЭЧ 3: шовхНХцибхЭЧя╝И1 х╝ашбия╝Й
- `orders` - шовхНХшби

### цибхЭЧ 4: щвДч║жцибхЭЧя╝И2 х╝ашбия╝Й
- `class_records` - ф╕Кшп╛шобхИТшби
- `appointments` - щвДч║жшби

### цибхЭЧ 5: хдзф╜┐цибхЭЧя╝И7 х╝ашбия╝Й
- `ambassador_applications` - хдзф╜┐чФ│шп╖шби
- `ambassador_quotas` - хдзф╜┐хРНщвЭшби
- `quota_usage_records` - хРНщвЭф╜┐чФишо░х╜Хшби
- `merit_points_records` - хКЯх╛╖хИЖшо░х╜Хшби
- `cash_points_records` - чзпхИЖшо░х╜Хшби
- `withdrawals` - цПРчО░шо░х╜Хшби
- `ambassador_upgrade_logs` - хдзф╜┐хНЗч║зцЧех┐Чшби

### цибхЭЧ 6: хХЖхнжщЩвхХЖхЯОцибхЭЧя╝И5 х╝ашбия╝Й
- `academy_intro` - хХЖхнжщЩвф╗Лч╗Ншби
- `academy_materials` - цЬЛхПЛхЬИч┤ацЭРшби
- `academy_cases` - хнжхСШцбИф╛Лшби
- `mall_goods` - хХЖхЯОхХЖхУБшби
- `mall_exchange_records` - хЕСцНвшо░х╜Хшби

### цибхЭЧ 7: хНПшооцибхЭЧя╝И2 х╝ашбия╝Й
- `contract_templates` - хНПшооцибцЭ┐шби
- `contract_signatures` - хНПшоочн╛ч╜▓шо░х╜Хшби

### цибхЭЧ 8: хПНщжИц╢ИцБпцибхЭЧя╝И3 х╝ашбия╝Й
- `feedbacks` - хПНщжИшби
- `notification_configs` - ц╢ИцБпщЕНч╜ошби
- `notification_logs` - ц╢ИцБпхПСщАБцЧех┐Чшби

### цибхЭЧ 9: хРОхП░чобчРЖцибхЭЧя╝И4 х╝ашбия╝Й
- `admin_users` - чобчРЖхСШшби
- `admin_operation_logs` - цУНф╜ЬцЧех┐Чшби
- `system_configs` - ч│╗ч╗ЯщЕНч╜ошби
- `announcements` - хЕмхСКшби

**цА╗шоб: 28 х╝ашби**

## ЁЯФН цХЕщЪЬцОТцЯе

### ш┐ЮцОехд▒ш┤е

**щФЩшпп**: `connect ECONNREFUSED`

**шзгхЖ│цЦ╣цбИ**:
1. цгАцЯе MySQL хоЮф╛ЛцШпхРжх╖▓хРпхКи
2. чбошодш┐ЮцОехЬ░хЭАхТМчлпхПгцШпхРжцнгчбо
3. цгАцЯеч╜Сч╗Ьшо┐щЧоцЭГщЩР
4. чбошодхпЖчаБцШпхРжцнгчбо

### цЭГщЩРф╕Нш╢│

**щФЩшпп**: `Access denied for user 'root'@'...'`

**шзгхЖ│цЦ╣цбИ**:
1. щЗНч╜о MySQL root хпЖчаБ
2. чбошодчОпхвГхПШщЗП `MYSQL_PASSWORD` х╖▓шо╛ч╜о
3. цгАцЯечФицИ╖цЭГщЩРщЕНч╜о

### шбих╖▓хнШхЬи

**щФЩшпп**: `Table '...' already exists`

**шзгхЖ│цЦ╣цбИ**:
шДЪцЬмф╜┐чФи `CREATE TABLE IF NOT EXISTS`я╝Мф╕Нф╝ЪцКещФЩуАВхжВцЮЬщЬАшжБщЗНцЦ░хИЫх╗║шбия╝Ъ

```sql
-- хИащЩдцХ░цНох║Уя╝Иш░ицЕОцУНф╜Ья╝Бя╝Й
DROP DATABASE IF EXISTS tiandao_culture;

-- щЗНцЦ░ш┐РшбМщГич╜▓шДЪцЬм
node scripts/deploy-database.js --module=users
```

## ЁЯУЭ хРОч╗нцнещкд

щГич╜▓хоМцИРхРОя╝Ъ

1. **щЕНч╜охоЙхЕишзДхИЩ**: х░ЖцЙАцЬЙ 28 х╝ашбишо╛ч╜оф╕║ `ADMINONLY`
2. **цПТхЕехИЭхзЛцХ░цНо**: ш┐РшбМхИЭхзЛцХ░цНошДЪцЬмя╝Их╛ЕхИЫх╗║я╝Й
3. **ц╡ЛшпХф║СхЗ╜цХ░**: щкМшпБф║СхЗ╜цХ░шГ╜хРжцнгх╕╕шо┐щЧоцХ░цНох║У
4. **щЕНч╜охдЗф╗╜**: шо╛ч╜оцХ░цНох║УшЗкхКихдЗф╗╜чнЦчХе

## ЁЯФЧ чЫ╕хЕ│цЦЗцбг

- [цХ░цНох║Ушо╛шобцЦЗцбг](../docs/database/README.md)
- [CloudBase цЦЗцбг](https://cloud.tencent.com/document/product/876)
- [щГич╜▓шобхИТ](../.agents/plans/01_ф║СцХ░цНох║УщГич╜▓шобхИТ.md)
