<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åå°ç®¡ç†æ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•</title>
  
  <!-- TDesign CSSï¼ˆæœ¬åœ°ï¼‰-->
  <link rel="stylesheet" href="./assets/libs/tdesign.min.css">
  
  <!-- è‡ªå®šä¹‰æ ·å¼ -->
  <link rel="stylesheet" href="./assets/css/tokens.css">
  
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    .test-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    .test-header {
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .mode-alert {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 4px;
      font-size: 14px;
    }

    .mode-alert.mock {
      background: #fff3e0;
      border: 1px solid #ff9800;
      color: #e65100;
    }

    .mode-alert.real {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      color: #0d47a1;
    }

    .test-stats {
      display: flex;
      gap: 24px;
      margin-top: 16px;
    }

    .stat-item {
      flex: 1;
      text-align: center;
      padding: 16px;
      background: #f5f5f5;
      border-radius: 4px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
    }

    .test-controls {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .test-modules {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .module-card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.3s;
    }

    .module-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .module-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .module-title {
      font-size: 16px;
      font-weight: 600;
    }

    .test-results {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .test-case {
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.3s;
    }

    .test-case.running {
      border-color: #0052d9;
      background: #f0f5ff;
    }

    .test-case.success {
      border-color: #00a870;
      background: #f0f9f6;
    }

    .test-case.failed {
      border-color: #e34d59;
      background: #fff0f1;
    }

    .test-case-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .test-case-title {
      font-weight: 600;
      font-size: 14px;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-dot.pending {
      background: #ccc;
    }

    .status-dot.running {
      background: #0052d9;
    }

    .status-dot.success {
      background: #00a870;
    }

    .status-dot.failed {
      background: #e34d59;
    }

    .test-case-info {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    .test-case-details {
      background: #f5f5f5;
      border-radius: 4px;
      padding: 12px;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .field-check {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
    }

    .field-check.success {
      color: #00a870;
    }

    .field-check.failed {
      color: #e34d59;
    }

    .field-name {
      font-family: monospace;
      font-weight: 600;
    }

    .error-message {
      background: #fff0f1;
      border: 1px solid #e34d59;
      border-radius: 4px;
      padding: 12px;
      margin-top: 12px;
      color: #e34d59;
      font-size: 12px;
    }

    .json-code {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.5;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 16px;
    }

    .progress-fill {
      height: 100%;
      background: #0052d9;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="test-container">
      <!-- æµ‹è¯•å¤´éƒ¨ -->
      <div class="test-header">
        <h1 style="margin: 0 0 16px 0;">ğŸ§ª åå°ç®¡ç†æ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆå…±64ä¸ªæ¥å£ï¼‰</h1>
        
        <!-- æ¨¡å¼æç¤º -->
        <div class="mode-alert" :class="testConfig.useMock ? 'mock' : 'real'">
          <strong>âš ï¸ å½“å‰æ¨¡å¼ï¼š{{ testConfig.useMock ? 'Mock æ¨¡å¼ï¼ˆå‡æ•°æ®æµ‹çœŸæ¥å£ï¼‰' : 'çœŸå®æ•°æ®æ¨¡å¼' }}</strong>
          <br>
          <span v-if="testConfig.useMock">
            Mock æ¨¡å¼ï¼šä½¿ç”¨å‡æ•°æ®ï¼ˆuserId=1, orderId=999ç­‰ï¼‰è°ƒç”¨çœŸå®åç«¯æ¥å£ï¼Œæµ‹è¯•æ¥å£æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚
          </span>
          <span v-else>
            çœŸå®æ•°æ®æ¨¡å¼ï¼šä½¿ç”¨çœŸå®ä¸šåŠ¡æ•°æ®è°ƒç”¨åç«¯æ¥å£ï¼ŒéªŒè¯å®é™…ä¸šåŠ¡æµç¨‹æ˜¯å¦æ­£ç¡®ã€‚
          </span>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="test-stats">
          <div class="stat-item">
            <div class="stat-value" :style="{color: '#0052d9'}">{{ totalTests }}</div>
            <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" :style="{color: '#00a870'}">{{ passedTests }}</div>
            <div class="stat-label">é€šè¿‡</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" :style="{color: '#e34d59'}">{{ failedTests }}</div>
            <div class="stat-label">å¤±è´¥</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" :style="{color: '#666'}">{{ Math.round(passRate) }}%</div>
            <div class="stat-label">é€šè¿‡ç‡</div>
          </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-bar" v-if="isRunning">
          <div class="progress-fill" :style="{width: progress + '%'}"></div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="test-controls">
          <t-button theme="primary" @click="runAllTests" :loading="isRunning" :disabled="isRunning">
            {{ isRunning ? 'æµ‹è¯•è¿è¡Œä¸­...' : 'è¿è¡Œæ‰€æœ‰æµ‹è¯•' }}
          </t-button>
          <t-button theme="default" @click="clearResults" :disabled="isRunning">
            æ¸…ç©ºç»“æœ
          </t-button>
          <t-button theme="default" @click="exportReport" :disabled="results.length === 0">
            å¯¼å‡º JSON æŠ¥å‘Š
          </t-button>
          <t-button theme="warning" variant="outline" @click="handleManualLogin" :disabled="isRunning">
            ğŸ”„ é‡æ–°ç™»å½•
          </t-button>
          <t-space align="center">
            <t-checkbox v-model="testConfig.skipSuccess">è·³è¿‡å·²æˆåŠŸ</t-checkbox>
            <t-checkbox v-model="testConfig.stopOnError">é‡é”™åœæ­¢</t-checkbox>
            <t-checkbox v-model="testConfig.showDetails">æ˜¾ç¤ºè¯¦æƒ…</t-checkbox>
            <t-checkbox v-model="testConfig.useMock" @change="handleMockChange">
              <span :style="{color: testConfig.useMock ? '#ff9800' : '#00a870', fontWeight: 600}">
                {{ testConfig.useMock ? 'Mockï¼ˆå‡æ•°æ®ï¼‰' : 'çœŸå®æ•°æ®' }}
              </span>
            </t-checkbox>
          </t-space>
          <div style="margin-left: auto; font-size: 12px; color: #666;">
            <div>ç®¡ç†å‘˜: {{ testConfig.admin.username }}</div>
            <div :style="{color: testConfig.token ? '#00a870' : '#e34d59'}">
              {{ testConfig.token ? 'âœ“ å·²ç™»å½•' : 'âœ— æœªç™»å½•' }}
            </div>
          </div>
        </div>
      </div>

      <!-- æµ‹è¯•æ¨¡å— -->
      <div class="test-modules" v-if="!isRunning || results.length === 0">
        <div 
          v-for="module in testModules" 
          :key="module.id"
          class="module-card"
          @click="runModuleTests(module.id)"
        >
          <div class="module-header">
            <div class="module-title">{{ module.name }}</div>
            <t-tag theme="primary" variant="light">{{ module.tests.length }} ä¸ªæµ‹è¯•</t-tag>
          </div>
          <div style="font-size: 12px; color: #666;">
            ğŸ“‹ {{ module.description }}
          </div>
        </div>
      </div>

      <!-- æµ‹è¯•ç»“æœ -->
      <div class="test-results" v-if="results.length > 0">
        <h3>æµ‹è¯•ç»“æœ</h3>
        <div 
          v-for="(result, index) in results" 
          :key="index"
          class="test-case"
          :class="result.status"
        >
          <div class="test-case-header">
            <div class="test-case-title">
              <span class="status-dot" :class="result.status"></span>
              {{ result.name }}
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <t-tag 
                :theme="result.status === 'success' ? 'success' : result.status === 'failed' ? 'danger' : 'default'"
                variant="light"
              >
                {{ result.status === 'success' ? 'âœ“ é€šè¿‡' : result.status === 'failed' ? 'âœ— å¤±è´¥' : 'â³ è¿è¡Œä¸­' }}
              </t-tag>
              <span style="font-size: 12px; color: #666;" v-if="result.duration">{{ result.duration }}ms</span>
            </div>
          </div>

          <div class="test-case-info">
            <strong>æ¥å£:</strong> {{ result.method }} {{ result.url }}
          </div>

          <!-- å­—æ®µæ£€æŸ¥ç»“æœ -->
          <div v-if="testConfig.showDetails && result.fieldChecks && result.fieldChecks.length > 0">
            <div style="margin: 12px 0 8px 0; font-weight: 600; font-size: 12px;">å­—æ®µéªŒè¯:</div>
            <div class="test-case-details">
              <div 
                v-for="(check, idx) in result.fieldChecks" 
                :key="idx"
                class="field-check"
                :class="check.exists ? 'success' : 'failed'"
              >
                <span>{{ check.exists ? 'âœ“' : 'âœ—' }}</span>
                <span class="field-name">{{ check.field }}</span>
                <span v-if="check.type"> ({{ check.type }})</span>
                <span v-if="!check.exists" style="color: #e34d59;"> - å­—æ®µç¼ºå¤±</span>
              </div>
            </div>
          </div>

          <!-- é”™è¯¯ä¿¡æ¯ -->
          <div v-if="result.error" class="error-message">
            <strong>é”™è¯¯:</strong> {{ result.error }}
          </div>

          <!-- å“åº”æ•°æ®ï¼ˆä»…æ˜¾ç¤ºé”™è¯¯æ—¶ï¼‰ -->
          <div v-if="testConfig.showDetails && result.response && result.status === 'failed'" 
               style="background: #f5f5f5; border-radius: 4px; padding: 12px; margin-top: 12px; font-size: 12px;">
            <strong>å“åº”æ•°æ®:</strong>
            <pre class="json-code">{{ JSON.stringify(result.response, null, 2) }}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue 3ï¼ˆæœ¬åœ°ï¼‰-->
  <script src="./assets/libs/vue.global.js"></script>
  
  <!-- TDesign Vueï¼ˆæœ¬åœ°ï¼‰-->
  <script src="./assets/libs/tdesign.min.js"></script>
  
  <!-- CloudBase SDKï¼ˆæœ¬åœ°ï¼‰-->
  <script src="./assets/libs/tcb.js"></script>
  
  <!-- é…ç½®æ–‡ä»¶ -->
  <script src="./assets/js/config.js"></script>
  
  <!-- API å°è£… -->
  <script src="./assets/js/admin-api.js"></script>
  
  <script>
    const { createApp, ref, computed, onMounted } = Vue;
    
    const app = createApp({
      setup() {
        const isRunning = ref(false);
        const results = ref([]);
        
        const testConfig = ref({
          skipSuccess: false,
          stopOnError: false,
          showDetails: true,
          useMock: true,  // é»˜è®¤ Mock æ¨¡å¼ï¼šä½¿ç”¨å‡æ•°æ®ï¼ˆuserId=1ç­‰ï¼‰æµ‹è¯•æ¥å£
          apiBaseURL: window.API_CONFIG?.baseURL || 'https://your-api-domain.com',
          token: '',
          admin: {
            username: 'herichen',
            password: 'tiandaowenhua'
          }
        });

        // åˆå§‹åŒ–
        onMounted(async () => {
          // å°è¯•ä» localStorage æ¢å¤ Token
          const savedToken = localStorage.getItem('api_test_token');
          if (savedToken) {
            testConfig.value.token = savedToken;
            console.log('âœ“ æ¢å¤ä¿å­˜çš„ Token:', savedToken.substring(0, 20) + '...');
            
            // éªŒè¯ Token æ˜¯å¦è¿˜æœ‰æ•ˆ
            try {
              await testTokenValidity();
            } catch (error) {
              console.warn('Token å·²å¤±æ•ˆï¼Œé‡æ–°ç™»å½•');
              TDesign.MessagePlugin.warning('ç™»å½•å·²è¿‡æœŸï¼Œæ­£åœ¨é‡æ–°ç™»å½•...');
              await autoLogin();
            }
          } else {
            // æ²¡æœ‰ä¿å­˜çš„ Tokenï¼Œè‡ªåŠ¨ç™»å½•
            console.log('âœ— æœªæ‰¾åˆ°ä¿å­˜çš„ Token');
            TDesign.MessagePlugin.info('æ­£åœ¨è‡ªåŠ¨ç™»å½•...');
            await autoLogin();
          }
        });

        // Mock æ¨¡å¼åˆ‡æ¢å¤„ç†ï¼ˆä¸¤ç§æ¨¡å¼éƒ½éœ€è¦ç™»å½•ï¼‰
        const handleMockChange = (checked) => {
          if (!testConfig.value.token) {
            // æ²¡æœ‰ Token æ—¶è‡ªåŠ¨ç™»å½•
            TDesign.MessagePlugin.info('æ­£åœ¨è‡ªåŠ¨ç™»å½•...');
            autoLogin();
          } else {
            // æç¤ºæ¨¡å¼åˆ‡æ¢
            if (checked) {
              TDesign.MessagePlugin.info('å·²åˆ‡æ¢åˆ° Mock æ¨¡å¼ï¼šä½¿ç”¨å‡æ•°æ®æµ‹è¯•æ¥å£');
            } else {
              TDesign.MessagePlugin.warning('å·²åˆ‡æ¢åˆ°çœŸå®æ•°æ®æ¨¡å¼ï¼šä½¿ç”¨å®é™…ä¸šåŠ¡æ•°æ®ï¼è¯·è°¨æ…æ“ä½œ');
            }
          }
        };

        // æ‰‹åŠ¨ç™»å½•
        const handleManualLogin = async () => {
          TDesign.MessagePlugin.info('æ­£åœ¨é‡æ–°ç™»å½•...');
          await autoLogin();
        };

        // éªŒè¯ Token æ˜¯å¦æœ‰æ•ˆ
        const testTokenValidity = async () => {
          try {
            const apiUrl = `https://${CONFIG.ENV_ID}.service.tcloudbase.com/${CONFIG.CLOUD_FUNCTIONS.SYSTEM}`;
            
            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                action: 'getStatistics',
                jwtToken: testConfig.value.token
              })
            });

            if (!response.ok) {
              throw new Error('Token éªŒè¯å¤±è´¥');
            }

            let result = await response.json();

            // è§£æ bodyï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (result.body && typeof result.body === 'string') {
              try {
                result = JSON.parse(result.body);
              } catch (e) {
                console.error('è§£æå“åº”å¤±è´¥:', e);
                throw new Error('Token éªŒè¯å¤±è´¥');
              }
            }

            if (!result.success || result.code === 401) {
              throw new Error('Token å·²è¿‡æœŸ');
            }
            
            console.log('âœ“ Token éªŒè¯æˆåŠŸ');
          } catch (error) {
            console.error('Token éªŒè¯å¤±è´¥:', error);
            throw error;
          }
        };

        // è‡ªåŠ¨ç™»å½•å‡½æ•°ï¼ˆå¢å¼ºç‰ˆï¼‰
        const autoLogin = async () => {
          try {
            console.log('å¼€å§‹è‡ªåŠ¨ç™»å½•...');
            console.log('ç®¡ç†å‘˜è´¦å·:', testConfig.value.admin.username);
            
            // ä½¿ç”¨ CloudBase äº‘å‡½æ•°æ ¼å¼è°ƒç”¨ç™»å½•æ¥å£
            const apiUrl = `https://${CONFIG.ENV_ID}.service.tcloudbase.com/${CONFIG.CLOUD_FUNCTIONS.SYSTEM}`;
            console.log('ç™»å½•æ¥å£:', apiUrl);
            
            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                action: 'login',
                username: testConfig.value.admin.username,
                password: testConfig.value.admin.password
              })
            });

            console.log('HTTP å“åº”çŠ¶æ€:', response.status, response.statusText);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            let result = await response.json();
            console.log('åŸå§‹å“åº”:', result);

            // è§£æ bodyï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (result.body && typeof result.body === 'string') {
              try {
                result = JSON.parse(result.body);
                console.log('è§£æåçš„å“åº”:', result);
              } catch (e) {
                console.error('è§£æå“åº” body å¤±è´¥:', e);
                throw new Error('ç™»å½•æ¥å£è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
              }
            }

            if (!result.success) {
              throw new Error(result.message || 'ç™»å½•å¤±è´¥');
            }
            
            if (result.data && result.data.token) {
              const token = result.data.token;
              testConfig.value.token = token;
              localStorage.setItem('api_test_token', token);
              localStorage.setItem(CONFIG.STORAGE_KEYS.TOKEN, token);
              
              // åŒæ—¶ä¿å­˜ç®¡ç†å‘˜ä¿¡æ¯
              if (result.data.admin) {
                localStorage.setItem(CONFIG.STORAGE_KEYS.ADMIN_INFO, JSON.stringify(result.data.admin));
              }
              
              TDesign.MessagePlugin.success('âœ“ è‡ªåŠ¨ç™»å½•æˆåŠŸ');
              console.log('âœ“ ç™»å½•æˆåŠŸ');
              console.log('Token:', token.substring(0, 30) + '...');
              console.log('ç®¡ç†å‘˜ä¿¡æ¯:', result.data.admin);
            } else {
              console.error('ç™»å½•å“åº”æ•°æ®:', result);
              throw new Error('ç™»å½•å“åº”ä¸­æ²¡æœ‰ token å­—æ®µ');
            }
          } catch (error) {
            console.error('âœ— è‡ªåŠ¨ç™»å½•å¤±è´¥:', error);
            TDesign.MessagePlugin.error('è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼š' + error.message);
            
            // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
            TDesign.DialogPlugin.alert({
              header: 'ç™»å½•å¤±è´¥',
              body: `æ— æ³•è‡ªåŠ¨ç™»å½•ç®¡ç†åå°ï¼Œè¯·æ£€æŸ¥ï¼š\n\n1. ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®\n2. äº‘å‡½æ•°æ˜¯å¦æ­£å¸¸éƒ¨ç½²\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n\né”™è¯¯è¯¦æƒ…: ${error.message}`,
              confirmBtn: 'æˆ‘çŸ¥é“äº†'
            });
          }
        };

        // æµ‹è¯•æ¨¡å—å®šä¹‰ï¼ˆ64ä¸ªæ¥å£å®Œæ•´ç‰ˆæœ¬ï¼‰
        const testModules = ref([
          {
            id: 'user',
            name: 'ç”¨æˆ·ç®¡ç†',
            description: 'å­¦å‘˜åˆ—è¡¨ã€è¯¦æƒ…ã€æ¨èäººç®¡ç†ï¼ˆ4ä¸ªæ¥å£ï¼‰',
            tests: [
              {
                name: '1. è·å–å­¦å‘˜åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/user/getUserList',
                params: { page: 1, pageSize: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'real_name', 'phone', 'ambassador_level', 'created_at']
              },
              {
                name: '2. è·å–å­¦å‘˜è¯¦æƒ…',
                method: 'GET',
                url: '/api/admin/user/getUserDetail',
                params: { userId: 30 },
                expectedFields: ['user', 'referee', 'refereeCount', 'courses']
              },
              {
                name: '3. ä¿®æ”¹å­¦å‘˜æ¨èäºº',
                method: 'POST',
                url: '/api/admin/user/updateUserReferee',
                body: { userId: 30, newRefereeId: 29, reason: 'æµ‹è¯•ä¿®æ”¹æ¨èäºº' },
                expectedFields: ['oldRefereeId', 'newRefereeId', 'newRefereeName']
              },
              {
                name: '4. æ¨èäººå˜æ›´è®°å½•',
                method: 'GET',
                url: '/api/admin/user/getRefereeChangeLogs',
                params: { userId: 30, page: 1, pageSize: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'user_id', 'old_referee_id', 'new_referee_id', 'created_at']
              }
            ]
          },
          {
            id: 'order',
            name: 'è®¢å•ç®¡ç†',
            description: 'è®¢å•åˆ—è¡¨ã€è¯¦æƒ…ã€é€€æ¬¾ã€æç°ï¼ˆ4ä¸ªæ¥å£ï¼‰',
            tests: [
              {
                name: '1. è·å–è®¢å•åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/order/getOrderList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['order_no', 'user_id', 'total_amount', 'pay_status', 'created_at']
              },
              {
                name: '2. è·å–è®¢å•è¯¦æƒ…',
                method: 'GET',
                url: '/api/admin/order/getOrderDetail',
                params: { order_no: 'TEST20260215001' },
                expectedFields: ['order_no', 'user_id', 'final_amount', 'pay_status']
              },
              {
                name: '3. è®¢å•é€€æ¬¾',
                method: 'POST',
                url: '/api/admin/order/refund',
                body: { order_no: 'TEST20260215001', refund_reason: 'æµ‹è¯•é€€æ¬¾' },
                expectedFields: ['refund_id', 'refund_amount']
              },
              {
                name: '4. æç°å®¡æ ¸',
                method: 'POST',
                url: '/api/admin/order/withdrawAudit',
                body: { withdrawal_id: 3, status: 1 },
                expectedFields: ['withdrawal_id', 'status', 'status_name']
              }
            ]
          },
          {
            id: 'course',
            name: 'è¯¾ç¨‹ç®¡ç†',
            description: 'è¯¾ç¨‹ã€æ’æœŸã€é¢„çº¦ã€æ¡ˆä¾‹ã€èµ„æ–™ï¼ˆ20ä¸ªæ¥å£ï¼‰',
            tests: [
              // 3.1 è¯¾ç¨‹ç®¡ç†ï¼ˆ4ä¸ªæ¥å£ï¼‰
              {
                name: '1. è·å–è¯¾ç¨‹åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/course/getCourseList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'name', 'type', 'current_price', 'status']
              },
              {
                name: '2. åˆ›å»ºè¯¾ç¨‹',
                method: 'POST',
                url: '/api/admin/course/createCourse',
                body: { name: 'æµ‹è¯•è¯¾ç¨‹', type: 1, current_price: 1688 },
                expectedFields: ['course_id']
              },
              {
                name: '3. æ›´æ–°è¯¾ç¨‹',
                method: 'POST',
                url: '/api/admin/course/updateCourse',
                body: { id: 1, name: 'æ›´æ–°åçš„è¯¾ç¨‹' },
                expectedFields: ['success']
              },
              {
                name: '4. åˆ é™¤è¯¾ç¨‹',
                method: 'POST',
                url: '/api/admin/course/deleteCourse',
                body: { id: 7 },
                expectedFields: ['success']
              },
              // 3.2 æ’æœŸç®¡ç†ï¼ˆ4ä¸ªæ¥å£ï¼‰
              {
                name: '5. è·å–æ’æœŸåˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/course/getClassRecordList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'course_id', 'class_date', 'start_time', 'status']
              },
              {
                name: '6. åˆ›å»ºæ’æœŸ',
                method: 'POST',
                url: '/api/admin/course/createClassRecord',
                body: { course_id: 1, class_date: '2026-03-01', start_time: '09:00', end_time: '12:00' },
                expectedFields: ['class_record_id']
              },
              {
                name: '7. æ›´æ–°æ’æœŸ',
                method: 'POST',
                url: '/api/admin/course/updateClassRecord',
                body: { id: 1, status: 1 },
                expectedFields: ['success']
              },
              {
                name: '8. åˆ é™¤æ’æœŸ',
                method: 'POST',
                url: '/api/admin/course/deleteClassRecord',
                body: { id: 9 },
                expectedFields: ['success']
              },
              // 3.3 é¢„çº¦ç®¡ç†ï¼ˆ3ä¸ªæ¥å£ï¼‰
              {
                name: '9. è·å–é¢„çº¦åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/course/getAppointmentList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'user_id', 'course_id', 'status', 'created_at']
              },
              {
                name: '10. æ›´æ–°é¢„çº¦çŠ¶æ€',
                method: 'POST',
                url: '/api/admin/course/updateAppointmentStatus',
                body: { id: 4, status: 2 },
                expectedFields: ['success']
              },
              {
                name: '11. æ‰¹é‡ç­¾åˆ°',
                method: 'POST',
                url: '/api/admin/course/batchCheckin',
                body: { class_record_id: 1, user_ids: [30] },
                expectedFields: ['success_count', 'failed_count']
              },
              // 3.4 æ¡ˆä¾‹ç®¡ç†ï¼ˆ4ä¸ªæ¥å£ï¼‰
              {
                name: '12. è·å–æ¡ˆä¾‹åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/course/getCaseList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'title', 'category', 'status', 'created_at']
              },
              {
                name: '13. åˆ›å»ºæ¡ˆä¾‹',
                method: 'POST',
                url: '/api/admin/course/createCase',
                body: { title: 'æµ‹è¯•æ¡ˆä¾‹', student_name: 'æµ‹è¯•å­¦å‘˜', category: 'å‘½ç†', content: 'æµ‹è¯•å†…å®¹' },
                expectedFields: ['case_id']
              },
              {
                name: '14. æ›´æ–°æ¡ˆä¾‹',
                method: 'POST',
                url: '/api/admin/course/updateCase',
                body: { id: 1, title: 'æ›´æ–°åçš„æ¡ˆä¾‹' },
                expectedFields: ['success']
              },
              {
                name: '15. åˆ é™¤æ¡ˆä¾‹',
                method: 'POST',
                url: '/api/admin/course/deleteCase',
                body: { id: 8 },
                expectedFields: ['success']
              },
              // 3.5 èµ„æ–™ç®¡ç†ï¼ˆ4ä¸ªæ¥å£ï¼‰
              {
                name: '16. è·å–èµ„æ–™åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/course/getMaterialList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'title', 'type', 'file_url', 'created_at']
              },
              {
                name: '17. åˆ›å»ºèµ„æ–™',
                method: 'POST',
                url: '/api/admin/course/createMaterial',
                body: { title: 'æµ‹è¯•èµ„æ–™', category: 'è§†é¢‘è¯¾ç¨‹', video_url: 'https://example.com/video.mp4' },
                expectedFields: ['material_id']
              },
              {
                name: '18. æ›´æ–°èµ„æ–™',
                method: 'POST',
                url: '/api/admin/course/updateMaterial',
                body: { id: 6, title: 'æ›´æ–°åçš„èµ„æ–™' },
                expectedFields: ['success']
              },
              {
                name: '19. åˆ é™¤èµ„æ–™',
                method: 'POST',
                url: '/api/admin/course/deleteMaterial',
                body: { id: 6 },
                expectedFields: ['success']
              },
              // 3.6 å­¦é™¢å†…å®¹ç®¡ç†ï¼ˆ1ä¸ªæ¥å£ï¼‰
              {
                name: '20. å­¦é™¢å†…å®¹ç®¡ç†',
                method: 'POST',
                url: '/api/admin/course/manageAcademyContent',
                body: { operation: 'create', title: 'æµ‹è¯•å•†å­¦é™¢ä»‹ç»', content: 'æµ‹è¯•å†…å®¹' },
                expectedFields: ['academy_id']
              }
            ]
          },
          {
            id: 'ambassador',
            name: 'å¤§ä½¿ç®¡ç†',
            description: 'å¤§ä½¿ã€ç”³è¯·ã€æ´»åŠ¨ã€åˆçº¦ï¼ˆ14ä¸ªæ¥å£ï¼‰',
            tests: [
              // 4.1 å¤§ä½¿ç®¡ç†ï¼ˆ4ä¸ªæ¥å£ï¼‰
              {
                name: '1. è·å–å¤§ä½¿åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/ambassador/getAmbassadorList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['user_id', 'real_name', 'ambassador_level', 'merit_points']
              },
              {
                name: '2. è·å–å¤§ä½¿è¯¦æƒ…',
                method: 'GET',
                url: '/api/admin/ambassador/getAmbassadorDetail',
                params: { user_id: 30 },
                expectedFields: ['user', 'statistics', 'referees']
              },
              {
                name: '3. æ›´æ–°å¤§ä½¿ç­‰çº§',
                method: 'POST',
                url: '/api/admin/ambassador/updateAmbassadorLevel',
                body: { user_id: 30, level: 2 },
                expectedFields: ['success']
              },
              {
                name: '4. ä¿®æ”¹åŠŸå¾·ç‚¹',
                method: 'POST',
                url: '/api/admin/ambassador/adjustPoints',
                body: { user_id: 30, point_type: 'merit', amount: 100, reason: 'æµ‹è¯•è°ƒæ•´' },
                expectedFields: ['success']
              },
              // 4.2 ç”³è¯·ç®¡ç†ï¼ˆ3ä¸ªæ¥å£ï¼‰
              {
                name: '5. è·å–ç”³è¯·åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/ambassador/getApplicationList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'user_id', 'real_name', 'status', 'created_at']
              },
              {
                name: '6. å®¡æ ¸ç”³è¯·',
                method: 'POST',
                url: '/api/admin/ambassador/auditApplication',
                body: { application_id: 2, approved: true },
                expectedFields: ['success']
              },
              {
                name: '7. è·å–ç”³è¯·è¯¦æƒ…',
                method: 'GET',
                url: '/api/admin/ambassador/getApplicationDetail',
                params: { application_id: 2 },
                expectedFields: ['id', 'user_id', 'real_name', 'status', 'materials']
              },
              // 4.3 æ´»åŠ¨ç®¡ç†ï¼ˆ4ä¸ªæ¥å£ï¼‰
              {
                name: '8. è·å–æ´»åŠ¨åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/ambassador/getActivityList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'user_id', 'activity_name', 'merit_points']
              },
              {
                name: '9. å®¡æ ¸æ´»åŠ¨',
                method: 'POST',
                url: '/api/admin/ambassador/auditActivity',
                body: { activity_id: 2, status: 1, merit_points: 50 },
                expectedFields: ['success']
              },
              {
                name: '10. è·å–æ´»åŠ¨è¯¦æƒ…',
                method: 'GET',
                url: '/api/admin/ambassador/getActivityDetail',
                params: { activity_id: 2 },
                expectedFields: ['id', 'user_id', 'activity_name', 'description', 'status']
              },
              {
                name: '11. åˆ é™¤æ´»åŠ¨',
                method: 'POST',
                url: '/api/admin/ambassador/deleteActivity',
                body: { activity_id: 3 },
                expectedFields: ['success']
              },
              // 4.4 åˆçº¦ç®¡ç†ï¼ˆ3ä¸ªæ¥å£ï¼‰
              {
                name: '12. è·å–åˆçº¦åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/ambassador/getContractList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'user_id', 'real_name', 'contract_level', 'status']
              },
              {
                name: '13. åˆ°æœŸåˆçº¦æé†’',
                method: 'GET',
                url: '/api/admin/ambassador/getExpiringContracts',
                params: { days: 30 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'user_id', 'real_name', 'expire_date']
              },
              {
                name: '14. åˆçº¦ç‰ˆæœ¬å†å²',
                method: 'GET',
                url: '/api/admin/ambassador/getContractVersions',
                params: { level: 1 },
                expectedFields: ['level', 'total', 'versions']
              }
            ]
          },
          {
            id: 'system',
            name: 'ç³»ç»Ÿç®¡ç†',
            description: 'è®¤è¯ã€ç»Ÿè®¡ã€ç®¡ç†å‘˜ã€é…ç½®ï¼ˆ21ä¸ªæ¥å£ï¼‰',
            tests: [
              // 5.1 è®¤è¯ï¼ˆ1ä¸ªæ¥å£ï¼‰
              {
                name: '1. ç®¡ç†å‘˜ç™»å½•',
                method: 'POST',
                url: '/api/admin/system/login',
                body: {
                  username: 'herichen',
                  password: 'tiandaowenhua'
                },
                expectedFields: ['token', 'admin']
              },
              // 5.2 ç»Ÿè®¡ï¼ˆ1ä¸ªæ¥å£ï¼‰
              {
                name: '2. æ•°æ®ç»Ÿè®¡',
                method: 'GET',
                url: '/api/admin/system/getStatistics',
                params: {},
                expectedFields: ['user_count', 'order_count', 'revenue_total', 'ambassador_count']
              },
              // 5.3 ç®¡ç†å‘˜ç®¡ç†ï¼ˆ4ä¸ªæ¥å£ï¼‰
              {
                name: '3. ç®¡ç†å‘˜åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/system/getAdminUserList',
                params: { page: 1, pageSize: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'username', 'role', 'created_at']
              },
              {
                name: '4. åˆ›å»ºç®¡ç†å‘˜',
                method: 'POST',
                url: '/api/admin/system/createAdminUser',
                body: { username: 'test_admin', password: 'test123', real_name: 'æµ‹è¯•ç®¡ç†å‘˜', role: 'editor' },
                expectedFields: ['id']
              },
              {
                name: '5. æ›´æ–°ç®¡ç†å‘˜',
                method: 'POST',
                url: '/api/admin/system/updateAdminUser',
                body: { id: 1, role: 'admin' },
                expectedFields: ['success']
              },
              {
                name: '6. åˆ é™¤ç®¡ç†å‘˜',
                method: 'POST',
                url: '/api/admin/system/deleteAdminUser',
                body: { id: 999 },
                expectedFields: ['success']
              },
              // 5.4 ç³»ç»Ÿé…ç½®ï¼ˆ4ä¸ªæ¥å£ï¼‰
              {
                name: '7. è·å–é…ç½®',
                method: 'GET',
                url: '/api/admin/system/getConfig',
                params: { key: 'system.maintenance' },
                expectedFields: ['key', 'value']
              },
              {
                name: '8. æ›´æ–°é…ç½®',
                method: 'POST',
                url: '/api/admin/system/updateConfig',
                body: { key: 'system.maintenance', value: 'false' },
                expectedFields: ['success']
              },
              {
                name: '9. è·å–é…ç½®åˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/system/getConfigList',
                params: { category: 'system' },
                expectedFields: ['total', 'list'],
                itemFields: ['key', 'value', 'description']
              },
              {
                name: '10. æ‰¹é‡æ›´æ–°é…ç½®',
                method: 'POST',
                url: '/api/admin/system/batchUpdateConfig',
                body: { 
                  configs: [
                    { key: 'system.maintenance', value: 'false' },
                    { key: 'points.exchange_rate', value: '0.01' }
                  ]
                },
                expectedFields: ['success']
              },
              // 5.5 å…¬å‘Šç®¡ç†ï¼ˆ4ä¸ªæ¥å£ï¼‰
              {
                name: '11. å…¬å‘Šåˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/system/getAnnouncementList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'title', 'type', 'status', 'created_at']
              },
              {
                name: '12. åˆ›å»ºå…¬å‘Š',
                method: 'POST',
                url: '/api/admin/system/createAnnouncement',
                body: { title: 'æµ‹è¯•å…¬å‘Š', content: 'å…¬å‘Šå†…å®¹', type: 'system' },
                expectedFields: ['announcement_id']
              },
              {
                name: '13. æ›´æ–°å…¬å‘Š',
                method: 'POST',
                url: '/api/admin/system/updateAnnouncement',
                body: { id: 1, title: 'æ›´æ–°åçš„å…¬å‘Š' },
                expectedFields: ['success']
              },
              {
                name: '14. åˆ é™¤å…¬å‘Š',
                method: 'POST',
                url: '/api/admin/system/deleteAnnouncement',
                body: { id: 999 },
                expectedFields: ['success']
              },
              // 5.6 é€šçŸ¥ç®¡ç†ï¼ˆ3ä¸ªæ¥å£ï¼‰
              {
                name: '15. å‘é€é€šçŸ¥',
                method: 'POST',
                url: '/api/admin/system/sendNotification',
                body: { 
                  user_ids: [1, 2, 3], 
                  title: 'æµ‹è¯•é€šçŸ¥', 
                  content: 'é€šçŸ¥å†…å®¹',
                  type: 'system'
                },
                expectedFields: ['success']
              },
              {
                name: '16. é€šçŸ¥é…ç½®ç®¡ç†',
                method: 'POST',
                url: '/api/admin/system/manageNotificationConfig',
                body: { action: 'list' },
                expectedFields: ['total', 'list']
              },
              {
                name: '17. é€šçŸ¥æ—¥å¿—æŸ¥è¯¢',
                method: 'GET',
                url: '/api/admin/system/getNotificationLogs',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'user_id', 'type', 'status', 'created_at']
              },
              // 5.7 åé¦ˆç®¡ç†ï¼ˆ4ä¸ªæ¥å£ï¼‰
              {
                name: '18. åé¦ˆåˆ—è¡¨',
                method: 'GET',
                url: '/api/admin/system/getFeedbackList',
                params: { page: 1, page_size: 20 },
                expectedFields: ['total', 'list'],
                itemFields: ['id', 'user_id', 'type', 'status', 'created_at']
              },
              {
                name: '19. åé¦ˆè¯¦æƒ…',
                method: 'GET',
                url: '/api/admin/system/getFeedbackDetail',
                params: { feedback_id: 1 },
                expectedFields: ['id', 'user_id', 'type', 'content', 'status']
              },
              {
                name: '20. å¤„ç†åé¦ˆ',
                method: 'POST',
                url: '/api/admin/system/handleFeedback',
                body: { feedback_id: 1, reply: 'æ„Ÿè°¢åé¦ˆï¼Œå·²å¤„ç†', status: 2 },
                expectedFields: ['success']
              },
              {
                name: '21. åˆ é™¤åé¦ˆ',
                method: 'POST',
                url: '/api/admin/system/deleteFeedback',
                body: { feedback_id: 999 },
                expectedFields: ['success']
              }
            ]
          }
        ]);

        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        const totalTests = computed(() => {
          return testModules.value.reduce((sum, module) => sum + module.tests.length, 0);
        });

        const passedTests = computed(() => {
          return results.value.filter(r => r.status === 'success').length;
        });

        const failedTests = computed(() => {
          return results.value.filter(r => r.status === 'failed').length;
        });

        const passRate = computed(() => {
          if (results.value.length === 0) return 0;
          return (passedTests.value / results.value.length) * 100;
        });

        const progress = computed(() => {
          if (totalTests.value === 0) return 0;
          return (results.value.length / totalTests.value) * 100;
        });

        // æ‰§è¡Œå•ä¸ªæµ‹è¯•
        const runTest = async (test) => {
          const startTime = Date.now();
          const result = {
            name: test.name,
            method: test.method,
            url: test.url,
            status: 'running',
            fieldChecks: [],
            response: null,
            error: null,
            duration: 0
          };

          results.value.push(result);

          try {
            // è°ƒç”¨ API
            const response = await makeApiCall(test);
            
            result.response = response;
            result.duration = Date.now() - startTime;

            // å­—æ®µéªŒè¯
            result.fieldChecks = [];
            if (test.expectedFields) {
              for (const field of test.expectedFields) {
                const exists = response && response.hasOwnProperty(field);
                result.fieldChecks.push({
                  field,
                  exists,
                  type: exists ? typeof response[field] : 'undefined'
                });
              }
            }

            // åˆ¤æ–­æˆåŠŸæˆ–å¤±è´¥
            const allFieldsExist = result.fieldChecks.every(check => check.exists);
            result.status = allFieldsExist ? 'success' : 'failed';

            if (!allFieldsExist) {
              const missingFields = result.fieldChecks.filter(c => !c.exists).map(c => c.field);
              result.error = `ç¼ºå°‘å¿…éœ€å­—æ®µ: ${missingFields.join(', ')}`;
            }

          } catch (error) {
            result.status = 'failed';
            result.error = error.message || 'è¯·æ±‚å¤±è´¥';
            result.duration = Date.now() - startTime;
          }

          return result;
        };

        // API è°ƒç”¨ï¼ˆä½¿ç”¨ CloudBase äº‘å‡½æ•°æ ¼å¼ - å¢å¼ºç‰ˆï¼‰
        const makeApiCall = async (test) => {
          try {
            // æ£€æŸ¥æ˜¯å¦æœ‰ Token
            if (!testConfig.value.token) {
              throw new Error('æœªæ‰¾åˆ°æˆ–æå–ç™»å½•å£ä»¤ï¼Œè¯·å…ˆç™»å½•');
            }
            
            // è§£æ RESTful URL è½¬æ¢ä¸ºäº‘å‡½æ•°è°ƒç”¨
            // /api/admin/user/getUserList -> user.getUserList
            // /api/admin/order/getOrderList -> order.getOrderList
            const urlMatch = test.url.match(/\/api\/admin\/(\w+)\/(\w+)/);
            if (!urlMatch) {
              throw new Error(`æ— æ³•è§£ææ¥å£åœ°å€: ${test.url}`);
            }
            
            const [, moduleName, actionName] = urlMatch;
            
            // è·å–äº‘å‡½æ•°åç§°
            const functionName = CONFIG.CLOUD_FUNCTIONS[moduleName.toUpperCase()];
            if (!functionName) {
              throw new Error(`æœªæ‰¾åˆ°æ¨¡å— ${moduleName} å¯¹åº”çš„äº‘å‡½æ•°`);
            }
            
            // åˆå¹¶å‚æ•°ï¼ˆGET çš„ params å’Œ POST çš„ bodyï¼‰
            const requestData = {
              action: actionName,
              jwtToken: testConfig.value.token,
              ...(test.params || {}),
              ...(test.body || {})
            };
            
            // ä½¿ç”¨ CloudBase HTTP API è°ƒç”¨äº‘å‡½æ•°
            const apiUrl = `https://${CONFIG.ENV_ID}.service.tcloudbase.com/${functionName}`;
            
            console.log(`[${test.name}] è°ƒç”¨äº‘å‡½æ•°:`, {
              url: apiUrl,
              data: { ...requestData, jwtToken: '***' } // éšè— Token
            });
            
            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(requestData)
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            let result = await response.json();

            // å¦‚æœè¿”å›çš„æ˜¯ HTTP Access Service çš„æ ¼å¼ï¼ˆå¸¦ body å­—æ®µï¼‰ï¼Œè§£æ body
            if (result.body && typeof result.body === 'string') {
              try {
                result = JSON.parse(result.body);
              } catch (e) {
                console.error('è§£æå“åº” body å¤±è´¥:', e);
                throw new Error('æ¥å£è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
              }
            }

            console.log(`[${test.name}] è¿”å›:`, result);

            // æ£€æŸ¥å“åº”
            if (!result.success) {
              // ç‰¹æ®Šå¤„ç†ï¼šç™»å½•è¿‡æœŸï¼ˆ401ï¼‰
              if (result.code === 401 || result.message?.includes('ç™»å½•') || result.message?.includes('è¿‡æœŸ') || result.message?.includes('token')) {
                console.warn('æ£€æµ‹åˆ°ç™»å½•è¿‡æœŸï¼Œå°è¯•é‡æ–°ç™»å½•...');
                TDesign.MessagePlugin.warning('ç™»å½•å·²è¿‡æœŸï¼Œæ­£åœ¨é‡æ–°ç™»å½•...');
                
                // é‡æ–°ç™»å½•
                await autoLogin();
                
                // å¦‚æœç™»å½•æˆåŠŸï¼Œä½¿ç”¨æ–° Token é‡è¯•å½“å‰è¯·æ±‚
                if (testConfig.value.token) {
                  requestData.jwtToken = testConfig.value.token;
                  const retryResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                  });
                  
                  let retryResult = await retryResponse.json();
                  
                  if (retryResult.body && typeof retryResult.body === 'string') {
                    retryResult = JSON.parse(retryResult.body);
                  }
                  
                  if (!retryResult.success) {
                    throw new Error(retryResult.message || 'é‡è¯•åä»ç„¶å¤±è´¥');
                  }
                  
                  console.log(`[${test.name}] é‡è¯•æˆåŠŸ`);
                  return retryResult.data;
                } else {
                  throw new Error('é‡æ–°ç™»å½•å¤±è´¥ï¼Œæ— æ³•ç»§ç»­æµ‹è¯•');
                }
              }
              
              throw new Error(result.message || result.error || 'è¯·æ±‚å¤±è´¥');
            }

            return result.data;
          } catch (error) {
            // æŠ›å‡ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
            console.error(`[${test.name}] APIè°ƒç”¨å¤±è´¥:`, error);
            throw new Error(error.message || 'è¯·æ±‚å¤±è´¥');
          }
        };

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        const runAllTests = async () => {
          if (isRunning.value) return;
          
          isRunning.value = true;
          results.value = [];

          try {
            for (const module of testModules.value) {
              for (const test of module.tests) {
                await runTest(test);

                if (testConfig.value.stopOnError) {
                  const lastResult = results.value[results.value.length - 1];
                  if (lastResult.status === 'failed') {
                    TDesign.MessagePlugin.error('æµ‹è¯•å¤±è´¥ï¼Œå·²åœæ­¢');
                    break;
                  }
                }
              }
            }

            TDesign.MessagePlugin.success(`æµ‹è¯•å®Œæˆï¼é€šè¿‡ ${passedTests.value}/${results.value.length}`);
          } catch (error) {
            TDesign.MessagePlugin.error('æµ‹è¯•å‡ºé”™ï¼š' + error.message);
          } finally {
            isRunning.value = false;
          }
        };

        // è¿è¡Œæ¨¡å—æµ‹è¯•
        const runModuleTests = async (moduleId) => {
          if (isRunning.value) return;

          const module = testModules.value.find(m => m.id === moduleId);
          if (!module) return;

          isRunning.value = true;

          try {
            for (const test of module.tests) {
              await runTest(test);
            }

            TDesign.MessagePlugin.success(`${module.name} æµ‹è¯•å®Œæˆ`);
          } catch (error) {
            TDesign.MessagePlugin.error('æµ‹è¯•å‡ºé”™ï¼š' + error.message);
          } finally {
            isRunning.value = false;
          }
        };

        // æ¸…ç©ºç»“æœ
        const clearResults = () => {
          results.value = [];
          TDesign.MessagePlugin.success('å·²æ¸…ç©ºç»“æœ');
        };

        // å¯¼å‡ºæŠ¥å‘Š
        const exportReport = () => {
          if (results.value.length === 0) {
            TDesign.MessagePlugin.warning('æ²¡æœ‰æµ‹è¯•ç»“æœå¯å¯¼å‡º');
            return;
          }

          try {
            // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ•°æ®
            const report = {
              summary: {
                total: totalTests.value,
                passed: passedTests.value,
                failed: failedTests.value,
                passRate: passRate.value,
                testDate: new Date().toISOString(),
                duration: results.value.reduce((sum, r) => sum + (r.duration || 0), 0)
              },
              details: results.value.map(r => ({
                name: r.name,
                status: r.status,
                method: r.method,
                url: r.url,
                duration: r.duration,
                fieldChecks: r.fieldChecks || [],
                error: r.error
              })),
              failedTests: results.value
                .filter(r => r.status === 'failed')
                .map(r => ({
                  name: r.name,
                  error: r.error,
                  missingFields: (r.fieldChecks || [])
                    .filter(fc => !fc.exists)
                    .map(fc => fc.field)
                }))
            };

            // åˆ›å»ºä¸‹è½½
            const blob = new Blob([JSON.stringify(report, null, 2)], { 
              type: 'application/json' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `api-test-report-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            TDesign.MessagePlugin.success('JSON æŠ¥å‘Šå·²å¯¼å‡º');
          } catch (error) {
            console.error('å¯¼å‡ºæŠ¥å‘Šå¤±è´¥:', error);
            TDesign.MessagePlugin.error('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
          }
        };

        return {
          isRunning,
          results,
          testModules,
          testConfig,
          totalTests,
          passedTests,
          failedTests,
          passRate,
          progress,
          runAllTests,
          runModuleTests,
          clearResults,
          exportReport,
          handleMockChange,
          handleManualLogin
        };
      }
    });
    
    app.use(TDesign);
    app.mount('#app');
  </script>
</body>
</html>
