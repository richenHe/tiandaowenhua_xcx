# 后台接口完整测试指南（含写入操作）

## 📋 测试工具说明

### 工具文件
- **测试工具**：`api-test-full.html`
- **功能**：完整测试所有 64 个后台接口，包括 CREATE/UPDATE/DELETE 操作

## 🎯 测试流程

### 1. 打开测试工具

```bash
# 在浏览器中打开
http://localhost:8080/admin/api-test-full.html
```

### 2. 配置测试选项

#### 选项 1：测试写入操作
- ✅ **勾选**：测试所有 64 个接口（包括 CREATE/UPDATE/DELETE）
- ❌ **不勾选**：仅测试只读接口（GET/LIST 操作）

#### 选项 2：自动清理测试数据
- ✅ **勾选**：测试完成后自动删除所有测试数据
- ❌ **不勾选**：保留测试数据（需手动清理）

### 3. 开始测试

点击 **"开始完整测试"** 按钮，工具会：

1. **自动登录**：使用管理员账号 `herichen`
2. **按模块测试**：
   - 系统模块（21个接口）
   - 用户模块（4个接口）
   - 订单模块（4个接口）
   - 课程模块（20个接口）
   - 大使模块（15个接口）
3. **智能处理依赖**：
   - 创建课程 → 创建排期
   - 创建合约模板 → 查询合约版本
4. **自动清理**：删除所有测试数据（可选）

### 4. 查看测试结果

#### 实时统计
- **总接口数**：64
- **测试通过**：绿色，接口正常
- **测试失败**：红色，接口异常
- **已跳过**：灰色，高风险操作

#### 详细日志
- **成功**：显示返回数据（JSON格式）
- **失败**：显示错误信息和堆栈

### 5. 导出报告

点击 **"导出完整报告"** 按钮，生成 JSON 报告：

```json
{
  "测试时间": "2026-02-13 10:30:00",
  "测试模式": "完整测试（含写入）",
  "总接口数": 64,
  "测试通过": 58,
  "测试失败": 2,
  "已跳过": 4,
  "通过率": "96.67%",
  "创建的测试数据": {
    "adminUsers": [123],
    "announcements": [456, 457],
    "courses": [789],
    "classRecords": [101112],
    ...
  },
  "详细结果": [...]
}
```

## 🔧 测试数据管理

### 测试数据标记
所有测试数据都带有唯一标记：

```
test_data_1739410200000_测试管理员
test_data_1739410200000_测试公告
test_data_1739410200000_测试课程
```

### 手动清理数据

如果没有自动清理，可以：

1. **使用测试工具**：点击 **"手动清理测试数据"** 按钮
2. **使用 SQL**：删除包含 `test_data_` 的记录

```sql
-- 清理测试管理员
DELETE FROM tiandao_culture.admin_users 
WHERE username LIKE 'test_data_%';

-- 清理测试公告
DELETE FROM tiandao_culture.announcements 
WHERE title LIKE 'test_data_%';

-- 清理测试课程
DELETE FROM tiandao_culture.courses 
WHERE name LIKE 'test_data_%';

-- 清理测试排期
DELETE FROM tiandao_culture.class_records 
WHERE id IN (
  SELECT cr.id FROM class_records cr
  INNER JOIN courses c ON cr.course_id = c.id
  WHERE c.name LIKE 'test_data_%'
);
```

## ⚠️ 注意事项

### 1. 环境选择
- ✅ **开发环境**：推荐，可放心测试
- ⚠️ **测试环境**：谨慎，注意数据清理
- ❌ **生产环境**：禁止，严重后果

### 2. 高风险操作测试
以下接口需要现有数据才能测试（如果数据不存在会自动跳过）：
- `refund` - 执行退款（需要已支付订单）
- `withdrawAudit` - 审核提现（需要提现申请）
- `batchCheckin` - 批量签到（需要已通过的预约）
- `auditApplication` - 审核申请（需要待审核申请）
- `replyFeedback` - 回复反馈（需要未回复反馈）
- `sendNotification` - 发送通知（需要真实用户）
- `updateAmbassadorLevelConfig` - 更新等级配置（需要现有配置）
- `manageAcademyContent` - 管理学院内容

### 3. 数据依赖
某些测试需要现有数据：
- **用户详情**：需要至少1个真实用户
- **订单详情**：需要至少1个真实订单
- **大使详情**：需要至少1个真实大使
- **推荐人变更**：需要至少2个真实用户

如果数据不存在，测试会标记为"成功（数据不存在）"。

### 4. 外键约束
删除顺序很重要：
```
排期 → 课程
签约 → 合约模板
订单 → 用户
```

测试工具会自动按正确顺序清理。

## 📊 测试覆盖率目标

### 目标
- **接口覆盖率**：100%（64/64）
- **测试通过率**：≥ 95%

### 当前状态
| 模块 | 接口数 | 已测试 | 通过 | 失败 | 跳过 |
|------|--------|--------|------|------|------|
| 系统模块 | 21 | 0 | 0 | 0 | 0 |
| 用户模块 | 4 | 0 | 0 | 0 | 0 |
| 订单模块 | 4 | 0 | 0 | 0 | 0 |
| 课程模块 | 20 | 0 | 0 | 0 | 0 |
| 大使模块 | 15 | 0 | 0 | 0 | 0 |
| **总计** | **64** | **0** | **0** | **0** | **0** |

*运行测试后自动更新此表格*

## 🐛 常见问题

### Q1：登录失败怎么办？
**A**：检查管理员账号是否存在且状态正常：
```sql
SELECT id, username, real_name, role, status 
FROM tiandao_culture.admin_users 
WHERE username = 'herichen';
```

### Q2：创建数据失败？
**A**：检查必填字段和外键约束：
- 管理员：`username`, `password`, `real_name`, `role`
- 课程：`name`, `type`, `price`
- 排期：`course_id`, `class_date`, `start_time`, `end_time`

### Q3：删除数据失败？
**A**：检查外键约束，先删除子表数据：
```sql
-- 查看外键关系
SELECT 
  TABLE_NAME,
  CONSTRAINT_NAME,
  REFERENCED_TABLE_NAME
FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
WHERE TABLE_SCHEMA = 'tiandao_culture'
  AND REFERENCED_TABLE_NAME IS NOT NULL;
```

### Q4：测试太慢怎么办？
**A**：
1. 关闭写入操作测试（只测试只读接口）
2. 减少延迟时间（修改代码中的 `setTimeout(resolve, 200)`）
3. 分模块测试（注释掉不需要的模块）

## 📝 测试报告模板

### 标题格式
```
后台接口完整测试报告_YYYYMMDD_HHMMSS.json
```

### 报告内容
- **测试时间**
- **测试模式**（只读/完整）
- **统计数据**（总数/通过/失败/跳过/通过率）
- **测试数据ID**（便于清理）
- **详细结果**（每个接口的请求/响应/错误）

## 🎯 下一步

1. ✅ 运行完整测试
2. ✅ 导出测试报告
3. ✅ 清理测试数据
4. ✅ 修复失败的接口
5. ✅ 重新测试
6. ✅ 达到 95% 通过率

---

**最后更新**：2026-02-13  
**工具版本**：v1.0.0

