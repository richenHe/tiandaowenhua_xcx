<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯¾ç¨‹åˆ—è¡¨ - å¤©é“æ–‡åŒ–åå°</title>
  
  <!-- TDesign CSSï¼ˆæœ¬åœ°ï¼‰-->
  <link rel="stylesheet" href="../../assets/libs/tdesign.min.css">
  <link rel="stylesheet" href="../../assets/css/tokens.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    .page-content {
      height: 100%;
      overflow-y: auto;
      background: #f5f5f5;
      padding: 24px;
    }
    
    .page-header {
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .page-title {
      font-size: 20px;
      font-weight: 600;
    }
    
    .search-form {
      background: white;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .table-card {
      background: white;
      border-radius: 8px;
      padding: 24px;
    }
    
    .type-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 12px;
    }
    
    .type-initial { background: #e3f2fd; color: #1976d2; }
    .type-intensive { background: #fce4ec; color: #c2185b; }
    .type-consultation { background: #f3e5f5; color: #7b1fa2; }
    
    .status-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 12px;
    }
    
    .status-active { background: #e8f5e9; color: #388e3c; }
    .status-inactive { background: #cfd8dc; color: #546e7a; }
    
    .course-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }
  
    /* TDesign å¸ƒå±€æ ·å¼ - å¿…éœ€ï¼*/
    .t-layout {
      height: 100vh;
    }
    
    .t-layout__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      background: #fff;
      border-bottom: 1px solid #dcdcdc;
    }
    
    .t-layout__sider {
      background: #fff;
      border-right: 1px solid #dcdcdc;
      width: 240px !important;
      flex-shrink: 0;
    }
    
    .t-layout__content {
      padding: 24px;
      overflow-y: auto;
      background: #f5f5f5;
    }

  </style>
</head>
<body>
  <div id="app">
    <t-layout style="height: 100vh;">
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <t-header height="64px" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
        background: #fff;
        border-bottom: 1px solid #dcdcdc;
      ">
        <div style="display: flex; align-items: center; gap: 16px;">
          <span style="font-size: 18px; font-weight: 600; color: #333;">ğŸ¨ å¤©é“æ–‡åŒ–åå°ç®¡ç†</span>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span>{{ adminInfo?.real_name || adminInfo?.username || 'ç®¡ç†å‘˜' }}</span>
          <t-button size="small" @click="handleLogout">é€€å‡º</t-button>
        </div>
      </t-header>
      
      <t-layout>
        <!-- ä¾§è¾¹èœå• -->
        <t-aside width="240px" style="
          background: #fff;
          border-right: 1px solid #dcdcdc;
          overflow-y: auto;
        ">
          <t-menu
            value="course-list"
            :default-expanded="['user', 'order', 'course', 'ambassador', 'system']"
            theme="light"
            @change="handleMenuChange"
          >
            <t-menu-item value="dashboard">
              <template #icon><t-icon name="dashboard" /></template>
              æ•°æ®æ¦‚è§ˆ
            </t-menu-item>
            
            <t-submenu value="user">
              <template #icon><t-icon name="user" /></template>
              <template #title>ç”¨æˆ·ç®¡ç†</template>
              <t-menu-item value="user-list">å­¦å‘˜åˆ—è¡¨</t-menu-item>
              <t-menu-item value="user-referee">æ¨èäººç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="order">
              <template #icon><t-icon name="order" /></template>
              <template #title>è®¢å•ç®¡ç†</template>
              <t-menu-item value="order-list">è®¢å•åˆ—è¡¨</t-menu-item>
              <t-menu-item value="order-refund">é€€æ¬¾ç®¡ç†</t-menu-item>
              <t-menu-item value="withdraw-audit">æç°å®¡æ ¸</t-menu-item>
            </t-submenu>
            
            <t-submenu value="course">
              <template #icon><t-icon name="file" /></template>
              <template #title>è¯¾ç¨‹ç®¡ç†</template>
              <t-menu-item value="course-list">è¯¾ç¨‹åˆ—è¡¨</t-menu-item>
              <t-menu-item value="schedule-list">æ’æœŸç®¡ç†</t-menu-item>
              <t-menu-item value="appointment-list">é¢„çº¦ç®¡ç†</t-menu-item>
              <t-menu-item value="case-list">æ¡ˆä¾‹ç®¡ç†</t-menu-item>
              <t-menu-item value="material-list">èµ„æ–™ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="ambassador">
              <template #icon><t-icon name="usergroup" /></template>
              <template #title>å¤§ä½¿ç®¡ç†</template>
              <t-menu-item value="ambassador-list">å¤§ä½¿åˆ—è¡¨</t-menu-item>
              <t-menu-item value="application-audit">ç”³è¯·å®¡æ ¸</t-menu-item>
              <t-menu-item value="activity-list">æ´»åŠ¨ç®¡ç†</t-menu-item>
              <t-menu-item value="contract-list">åˆçº¦ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="system">
              <template #icon><t-icon name="setting" /></template>
              <template #title>ç³»ç»Ÿç®¡ç†</template>
              <t-menu-item value="admin-list">ç®¡ç†å‘˜ç®¡ç†</t-menu-item>
              <t-menu-item value="config">ç³»ç»Ÿé…ç½®</t-menu-item>
              <t-menu-item value="announcement-list">å…¬å‘Šç®¡ç†</t-menu-item>
              <t-menu-item value="feedback-list">åé¦ˆç®¡ç†</t-menu-item>
              <t-menu-item value="notification-list">é€šçŸ¥ç®¡ç†</t-menu-item>
              <t-menu-item value="level-config">ç­‰çº§é…ç½®</t-menu-item>
            </t-submenu>
          </t-menu>
        </t-aside>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <t-content class="page-content">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
      <h1 class="page-title">è¯¾ç¨‹åˆ—è¡¨</h1>
      <t-space>
        <t-button theme="primary" @click="showAddDialog">æ–°å¢è¯¾ç¨‹</t-button>
        
      </t-space>
    </div>

    <!-- æœç´¢è¡¨å• -->
    <div class="search-form">
      <t-form :data="searchForm" layout="inline" @submit="handleSearch" @reset="handleReset">
        <t-form-item label="è¯¾ç¨‹åç§°" name="name">
          <t-input v-model="searchForm.name" placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°" />
        </t-form-item>
        
        <t-form-item label="è¯¾ç¨‹ç±»å‹" name="type">
          <t-select v-model="searchForm.type" placeholder="è¯·é€‰æ‹©è¯¾ç¨‹ç±»å‹" clearable>
            <t-option value="initial" label="åˆæ¢ç­" />
            <t-option value="intensive" label="å¯†è®­ç­" />
            <t-option value="consultation" label="å’¨è¯¢æœåŠ¡" />
          </t-select>
        </t-form-item>
        
        <t-form-item label="çŠ¶æ€" name="status">
          <t-select v-model="searchForm.status" placeholder="è¯·é€‰æ‹©çŠ¶æ€" clearable>
            <t-option :value="1" label="å¯ç”¨" />
            <t-option :value="0" label="åœç”¨" />
          </t-select>
        </t-form-item>
        
        <t-form-item>
          <t-button theme="primary" type="submit">æŸ¥è¯¢</t-button>
          <t-button theme="default" type="reset">é‡ç½®</t-button>
        </t-form-item>
      </t-form>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <div class="table-card">
      <t-table 
        :data="courses" 
        :columns="columns" 
        :loading="loading"
        :pagination="pagination"
        row-key="id"
        @page-change="handlePageChange"
      >
        <!-- è¯¾ç¨‹å›¾ç‰‡ -->
        <template #cover_image="{ row }">
          <img
            v-if="row.cover_image"
            :src="row.cover_image"
            class="course-image"
            :alt="row.name"
          />
          <span v-else>-</span>
        </template>
        
        <!-- è¯¾ç¨‹ç±»å‹ -->
        <template #type="{ row }">
          <span :class="['type-tag', getTypeClass(row.type)]">
            {{ getTypeText(row.type) }}
          </span>
        </template>
        
        <!-- çŠ¶æ€ -->
        <template #status="{ row }">
          <span :class="['status-tag', row.status === 1 ? 'status-active' : 'status-inactive']">
            {{ row.status === 1 ? 'å¯ç”¨' : 'åœç”¨' }}
          </span>
        </template>
        
        <!-- æ“ä½œåˆ— -->
        <template #operation="{ row }">
          <t-space>
            <t-link theme="primary" @click="editCourse(row)">ç¼–è¾‘</t-link>
            <t-link 
              :theme="row.status === 1 ? 'warning' : 'success'" 
              @click="toggleStatus(row)"
            >
              {{ row.status === 1 ? 'åœç”¨' : 'å¯ç”¨' }}
            </t-link>
            <t-link theme="danger" @click="deleteCourse(row)">åˆ é™¤</t-link>
          </t-space>
        </template>
      </t-table>
    </div>

    <!-- æ–°å¢/ç¼–è¾‘è¯¾ç¨‹å¯¹è¯æ¡† -->
    <t-dialog 
      v-model:visible="editDialogVisible" 
      :header="editMode === 'add' ? 'æ–°å¢è¯¾ç¨‹' : 'ç¼–è¾‘è¯¾ç¨‹'" 
      width="800px"
      @confirm="handleSave"
    >
      <t-form :data="editForm" ref="editFormRef" label-width="120px">
        <t-form-item label="è¯¾ç¨‹åç§°" name="name" :rules="[{ required: true, message: 'è¯·è¾“å…¥è¯¾ç¨‹åç§°' }]">
          <t-input v-model="editForm.name" placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°" />
        </t-form-item>
        
        <t-form-item label="è¯¾ç¨‹ç±»å‹" name="type" :rules="[{ required: true, message: 'è¯·é€‰æ‹©è¯¾ç¨‹ç±»å‹' }]">
          <t-select v-model="editForm.type" placeholder="è¯·é€‰æ‹©è¯¾ç¨‹ç±»å‹">
            <t-option value="initial" label="åˆæ¢ç­" />
            <t-option value="intensive" label="å¯†è®­ç­" />
            <t-option value="consultation" label="å’¨è¯¢æœåŠ¡" />
          </t-select>
        </t-form-item>
        
        <t-form-item label="è¯¾ç¨‹å°é¢" name="coverImage">
          <t-input v-model="editForm.coverImage" placeholder="è¯·è¾“å…¥è¯¾ç¨‹å°é¢å›¾ç‰‡URL" />
        </t-form-item>
        
        <t-form-item label="è¯¾ç¨‹ä»·æ ¼ï¼ˆå…ƒï¼‰" name="price" :rules="[{ required: true, message: 'è¯·è¾“å…¥è¯¾ç¨‹ä»·æ ¼' }]">
          <t-input-number v-model="editForm.price" :min="0" :step="0.01" />
        </t-form-item>
        
        <t-form-item label="è¯¾ç¨‹æ—¶é•¿" name="duration">
          <t-input v-model="editForm.duration" placeholder="ä¾‹å¦‚ï¼š3å¤©2å¤œ" />
        </t-form-item>
        
        <t-form-item label="è¯¾ç¨‹äººæ•°" name="maxStudents">
          <t-input-number v-model="editForm.maxStudents" :min="1" />
        </t-form-item>
        
        <t-form-item label="è¯¾ç¨‹ç®€ä»‹" name="description">
          <t-textarea v-model="editForm.description" placeholder="è¯·è¾“å…¥è¯¾ç¨‹ç®€ä»‹" :maxlength="500" />
        </t-form-item>
        
        <t-form-item label="è¯¾ç¨‹è¯¦æƒ…" name="content">
          <t-textarea v-model="editForm.content" placeholder="è¯·è¾“å…¥è¯¾ç¨‹è¯¦ç»†å†…å®¹" :maxlength="5000" />
        </t-form-item>
        
        <t-form-item label="æ’åº" name="sortOrder">
          <t-input-number v-model="editForm.sortOrder" :min="0" />
        </t-form-item>
        
        <t-form-item label="çŠ¶æ€" name="status">
          <t-switch v-model="editForm.status" :true-value="1" :false-value="0" />
          <span style="margin-left: 8px;">{{ editForm.status === 1 ? 'å¯ç”¨' : 'åœç”¨' }}</span>
        </t-form-item>
      </t-form>
    </t-dialog>
  </div>

  <!-- Vue 3 -->
  <script src="../../assets/libs/vue.global.js"></script>
  <!-- TDesign -->
  <script src="../../assets/libs/tdesign.min.js"></script>
  <!-- CloudBase SDK -->
  <script src="../../assets/libs/tcb-v2.js"></script>
  <!-- é…ç½® -->
  <script src="../../assets/js/config.js"></script>
  <!-- API å°è£… -->
  <script src="../../assets/js/admin-api.js"></script>

  <script>
    const { createApp, ref, reactive, onMounted } = Vue;

    createApp({
      setup() {
        // ç®¡ç†å‘˜ä¿¡æ¯
        const adminInfo = ref(null);
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const checkAuth = () => {
          adminInfo.value = AdminAPI.getCurrentAdmin();
          if (!adminInfo.value) {
            window.location.href = '../../login.html';
            return false;
          }
          return true;
        };
        
        // é€€å‡ºç™»å½•
        const handleLogout = () => {
          TDesign.DialogPlugin.confirm({
            header: 'ç¡®è®¤é€€å‡º',
            body: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
            onConfirm: () => {
              AdminAPI.logout();
            }
          });
        };
        
        // èœå•åˆ‡æ¢
        const handleMenuChange = (value) => {
          const routes = {
            'dashboard': '../../index.html',
            'user-list': '../user/list.html',
            'user-referee': '../user/referee.html',
            'order-list': '../order/list.html',
            'order-refund': '../order/refund.html',
            'withdraw-audit': '../order/withdraw-audit.html',
            'course-list': '../course/list.html',
            'schedule-list': '../course/schedule.html',
            'appointment-list': '../course/appointment.html',
            'case-list': '../course/case.html',
            'material-list': '../course/material.html',
            'ambassador-list': '../ambassador/list.html',
            'application-audit': '../ambassador/application-audit.html',
            'activity-list': '../ambassador/activity.html',
            'contract-list': '../ambassador/contract.html',
            'admin-list': '../system/admin.html',
            'config': '../system/config.html',
            'announcement-list': '../system/announcement.html',
            'feedback-list': '../system/feedback.html',
            'notification-list': '../system/notification.html',
            'level-config': '../system/level-config.html',
          };
          
          if (routes[value]) {
            window.location.href = routes[value];
          }
        };
        
        
        const loading = ref(false);
        const courses = ref([]);
        const searchForm = reactive({
          name: '',
          type: '',
          status: ''
        });
        
        const pagination = reactive({
          current: 1,
          pageSize: CONFIG.PAGE_SIZE,
          total: 0
        });

        const editDialogVisible = ref(false);
        const editMode = ref('add');
        const editFormRef = ref(null);
        const editForm = reactive({
          id: null,
          name: '',
          type: '',
          coverImage: '',
          price: 0,
          duration: '',
          maxStudents: 30,
          description: '',
          content: '',
          sortOrder: 0,
          status: 1
        });

        // è¡¨æ ¼åˆ—é…ç½®
        const columns = [
          { colKey: 'id', title: 'ID', width: 80 },
          { colKey: 'cover_image', title: 'è¯¾ç¨‹å›¾ç‰‡', width: 100 },
          { colKey: 'name', title: 'è¯¾ç¨‹åç§°', width: 150 },
          { colKey: 'nickname', title: 'è¯¾ç¨‹æ˜µç§°', width: 120 },
          { colKey: 'type', title: 'è¯¾ç¨‹ç±»å‹', width: 100 },
          { colKey: 'current_price', title: 'ç°ä»·ï¼ˆå…ƒï¼‰', width: 100 },
          { colKey: 'original_price', title: 'åŸä»·ï¼ˆå…ƒï¼‰', width: 100 },
          { colKey: 'duration', title: 'è¯¾ç¨‹æ—¶é•¿', width: 100 },
          { colKey: 'sold_count', title: 'å·²å”®', width: 80 },
          { colKey: 'sort_order', title: 'æ’åº', width: 80 },
          { colKey: 'status', title: 'çŠ¶æ€', width: 80 },
          { colKey: 'created_at', title: 'åˆ›å»ºæ—¶é—´', width: 160 },
          { colKey: 'operation', title: 'æ“ä½œ', width: 200, fixed: 'right' }
        ];

        // è·å–è¯¾ç¨‹åˆ—è¡¨
        const fetchCourses = async () => {
          loading.value = true;
          try {
            const params = {
              page: pagination.current,
              pageSize: pagination.pageSize,
              ...searchForm
            };

            const data = await AdminAPI.getCourseList(params);
            courses.value = data.list || [];
            pagination.total = data.total || 0;
          } catch (error) {
            console.error('è·å–è¯¾ç¨‹åˆ—è¡¨å¤±è´¥:', error);
            TDesign.Message.error('è·å–è¯¾ç¨‹åˆ—è¡¨å¤±è´¥: ' + error.message);
          } finally {
            loading.value = false;
          }
        };

        // æœç´¢
        const handleSearch = () => {
          pagination.current = 1;
          fetchCourses();
        };

        // é‡ç½®
        const handleReset = () => {
          Object.assign(searchForm, {
            name: '',
            type: '',
            status: ''
          });
          handleSearch();
        };

        // åˆ†é¡µå˜åŒ–
        const handlePageChange = (pageInfo) => {
          pagination.current = pageInfo.current;
          pagination.pageSize = pageInfo.pageSize;
          fetchCourses();
        };

        // æ˜¾ç¤ºæ–°å¢å¯¹è¯æ¡†
        const showAddDialog = () => {
          editMode.value = 'add';
          Object.assign(editForm, {
            id: null,
            name: '',
            type: '',
            coverImage: '',
            price: 0,
            duration: '',
            maxStudents: 30,
            description: '',
            content: '',
            sortOrder: 0,
            status: 1
          });
          editDialogVisible.value = true;
        };

        // ç¼–è¾‘è¯¾ç¨‹
        const editCourse = (course) => {
          editMode.value = 'edit';
          Object.assign(editForm, {
            id: course.id,
            name: course.name,
            nickname: course.nickname || '',
            type: course.type,
            coverImage: course.cover_image,
            originalPrice: course.original_price,
            currentPrice: course.current_price,
            retrainPrice: course.retrain_price,
            duration: course.duration,
            description: course.description,
            content: course.content,
            outline: course.outline,
            teacher: course.teacher,
            sortOrder: course.sort_order,
            status: course.status
          });
          editDialogVisible.value = true;
        };

        // ä¿å­˜è¯¾ç¨‹
        const handleSave = async () => {
          try {
            const params = {
              name: editForm.name,
              type: editForm.type,
              coverImage: editForm.coverImage,
              price: editForm.price,
              duration: editForm.duration,
              maxStudents: editForm.maxStudents,
              description: editForm.description,
              content: editForm.content,
              sortOrder: editForm.sortOrder,
              status: editForm.status
            };

            if (editMode.value === 'add') {
              await AdminAPI.createCourse(params);
              TDesign.Message.success('è¯¾ç¨‹åˆ›å»ºæˆåŠŸ');
            } else {
              params.courseId = editForm.id;
              await AdminAPI.updateCourse(params);
              TDesign.Message.success('è¯¾ç¨‹æ›´æ–°æˆåŠŸ');
            }

            editDialogVisible.value = false;
            fetchCourses();
          } catch (error) {
            TDesign.Message.error('ä¿å­˜å¤±è´¥: ' + error.message);
          }
        };

        // åˆ‡æ¢çŠ¶æ€
        const toggleStatus = async (course) => {
          try {
            await AdminAPI.updateCourse({
              courseId: course.id,
              status: course.status === 1 ? 0 : 1
            });
            TDesign.Message.success('çŠ¶æ€æ›´æ–°æˆåŠŸ');
            fetchCourses();
          } catch (error) {
            TDesign.Message.error('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + error.message);
          }
        };

        // åˆ é™¤è¯¾ç¨‹
        const deleteCourse = async (course) => {
          const confirmed = await TDesign.Dialog.confirm({
            header: 'åˆ é™¤è¯¾ç¨‹',
            body: `ç¡®è®¤åˆ é™¤è¯¾ç¨‹"${course.name}"ï¼Ÿ`,
            confirmBtn: 'ç¡®è®¤',
            cancelBtn: 'å–æ¶ˆ'
          });
          
          if (confirmed) {
            try {
              await AdminAPI.deleteCourse({ courseId: course.id });
              TDesign.Message.success('è¯¾ç¨‹åˆ é™¤æˆåŠŸ');
              fetchCourses();
            } catch (error) {
              TDesign.Message.error('åˆ é™¤å¤±è´¥: ' + error.message);
            }
          }
        };

        // è·å–ç±»å‹æ–‡æœ¬
        const getTypeText = (type) => {
          const typeMap = {
            initial: 'åˆæ¢ç­',
            intensive: 'å¯†è®­ç­',
            consultation: 'å’¨è¯¢æœåŠ¡'
          };
          return typeMap[type] || type;
        };

        // è·å–ç±»å‹æ ·å¼ç±»
        const getTypeClass = (type) => {
          const classMap = {
            initial: 'type-initial',
            intensive: 'type-intensive',
            consultation: 'type-consultation'
          };
          return classMap[type] || '';
        };

        // è¿”å›ä¸Šä¸€é¡µ
        

        onMounted(() => {
          if (checkAuth()) {
          fetchCourses();
        }
        });

        return {
          adminInfo,
          handleLogout,
          handleMenuChange,
          loading,
          courses,
          searchForm,
          pagination,
          columns,
          editDialogVisible,
          editMode,
          editFormRef,
          editForm,
          handleSearch,
          handleReset,
          handlePageChange,
          showAddDialog,
          editCourse,
          handleSave,
          toggleStatus,
          deleteCourse,
          getTypeText,
          getTypeClass,
          };
      }
    }).use(TDesign).mount('#app');
  </script>
</body>
</html>






