<!DOCTYPE html>
<html lang="zh-CN">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>èµ„æ–™ç®¡ç†</title><link rel="stylesheet" href="../../assets/libs/tdesign.min.css"><link rel="stylesheet" href="../../assets/css/tokens.css"><style>body{margin:0;padding:20px;background:#f5f5f5;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}.page-container{max-width:1400px;margin:0 auto;background:white;border-radius:8px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}.page-header{margin-bottom:24px}.page-title{font-size:20px;font-weight:600;color:#333;margin:0 0 8px 0}.page-desc{font-size:14px;color:#999;margin:0}.search-bar{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
    /* TDesign å¸ƒå±€æ ·å¼ - å¿…éœ€ï¼*/
    .t-layout {
      height: 100vh;
    }
    
    .t-layout__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      background: #fff;
      border-bottom: 1px solid #dcdcdc;
    }
    
    .t-layout__sider {
      background: #fff;
      border-right: 1px solid #dcdcdc;
      width: 240px !important;
      flex-shrink: 0;
    }
    
    .t-layout__content {
      padding: 24px;
      overflow-y: auto;
      background: #f5f5f5;
    }

  </style></head>
<body>
  <div id="app">
    <t-layout style="height: 100vh;">
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <t-header height="64px" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
        background: #fff;
        border-bottom: 1px solid #dcdcdc;
      ">
        <div style="display: flex; align-items: center; gap: 16px;">
          <span style="font-size: 18px; font-weight: 600; color: #333;">ğŸ¨ å¤©é“æ–‡åŒ–åå°ç®¡ç†</span>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span>{{ adminInfo?.real_name || adminInfo?.username || 'ç®¡ç†å‘˜' }}</span>
          <t-button size="small" @click="handleLogout">é€€å‡º</t-button>
        </div>
      </t-header>
      
      <t-layout>
        <!-- ä¾§è¾¹èœå• -->
        <t-aside width="240px" style="
          background: #fff;
          border-right: 1px solid #dcdcdc;
          overflow-y: auto;
        ">
          <t-menu
            value="material-list"
            :default-expanded="['user', 'order', 'course', 'ambassador', 'system']"
            theme="light"
            @change="handleMenuChange"
          >
            <t-menu-item value="dashboard">
              <template #icon><t-icon name="dashboard" /></template>
              æ•°æ®æ¦‚è§ˆ
            </t-menu-item>
            
            <t-submenu value="user">
              <template #icon><t-icon name="user" /></template>
              <template #title>ç”¨æˆ·ç®¡ç†</template>
              <t-menu-item value="user-list">å­¦å‘˜åˆ—è¡¨</t-menu-item>
              <t-menu-item value="user-referee">æ¨èå…³ç³»æŸ¥è¯¢</t-menu-item>
              <t-menu-item value="user-referee-logs">æ¨èäººå˜æ›´è®°å½•</t-menu-item>
            </t-submenu>
            
            <t-submenu value="order">
              <template #icon><t-icon name="order" /></template>
              <template #title>è®¢å•ç®¡ç†</template>
              <t-menu-item value="order-list">è®¢å•åˆ—è¡¨</t-menu-item>
              <t-menu-item value="order-refund">é€€æ¬¾ç®¡ç†</t-menu-item>
              <t-menu-item value="withdraw-audit">æç°å®¡æ ¸</t-menu-item>
            </t-submenu>
            
            <t-submenu value="course">
              <template #icon><t-icon name="file" /></template>
              <template #title>è¯¾ç¨‹ç®¡ç†</template>
              <t-menu-item value="course-list">è¯¾ç¨‹åˆ—è¡¨</t-menu-item>
              <t-menu-item value="schedule-list">æ’æœŸç®¡ç†</t-menu-item>
              <t-menu-item value="appointment-list">é¢„çº¦ç®¡ç†</t-menu-item>
              <t-menu-item value="case-list">æ¡ˆä¾‹ç®¡ç†</t-menu-item>
              <t-menu-item value="material-list">èµ„æ–™ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="ambassador">
              <template #icon><t-icon name="usergroup" /></template>
              <template #title>å¤§ä½¿ç®¡ç†</template>
              <t-menu-item value="ambassador-list">å¤§ä½¿åˆ—è¡¨</t-menu-item>
              <t-menu-item value="application-audit">ç”³è¯·å®¡æ ¸</t-menu-item>
              <t-menu-item value="activity-list">æ´»åŠ¨ç®¡ç†</t-menu-item>
              <t-menu-item value="contract-list">åˆçº¦ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="system">
              <template #icon><t-icon name="setting" /></template>
              <template #title>ç³»ç»Ÿç®¡ç†</template>
              <t-menu-item value="admin-list">ç®¡ç†å‘˜ç®¡ç†</t-menu-item>
              <t-menu-item value="config">ç³»ç»Ÿé…ç½®</t-menu-item>
              <t-menu-item value="announcement-list">å…¬å‘Šç®¡ç†</t-menu-item>
              <t-menu-item value="feedback-list">åé¦ˆç®¡ç†</t-menu-item>
              <t-menu-item value="notification-list">é€šçŸ¥ç®¡ç†</t-menu-item>
              <t-menu-item value="level-config">ç­‰çº§é…ç½®</t-menu-item>
            </t-submenu>
          </t-menu>
        </t-aside>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <t-content class="page-content"><div class="page-container"><div class="page-header"><h1 class="page-title">èµ„æ–™ç®¡ç†</h1><p class="page-desc">ç®¡ç†è¯¾ç¨‹å­¦ä¹ èµ„æ–™å’Œæ–‡æ¡£</p></div><div class="search-bar"><t-input v-model="filters.keyword" placeholder="èµ„æ–™åç§°" clearable style="width:200px;"><template #prefix-icon><t-icon name="search"/></template></t-input><t-select v-model="filters.courseId" :options="courseOptions" placeholder="å…³è”è¯¾ç¨‹" clearable style="width:200px;"/><t-select v-model="filters.type" :options="typeOptions" placeholder="èµ„æ–™ç±»å‹" clearable style="width:150px;"/><t-button theme="primary" @click="handleSearch"><template #icon><t-icon name="search"/></template>æŸ¥è¯¢</t-button><t-button theme="default" @click="handleReset"><template #icon><t-icon name="refresh"/></template>é‡ç½®</t-button><t-button theme="success" @click="handleAdd"><template #icon><t-icon name="add"/></template>ä¸Šä¼ èµ„æ–™</t-button></div><t-table :data="tableData" :columns="columns" :loading="loading" :pagination="pagination" @page-change="handlePageChange" row-key="id" bordered stripe hover><template #type="{ row }"><t-tag v-if="row.type==='pdf'" theme="primary">PDF</t-tag><t-tag v-else-if="row.type==='doc'" theme="success">æ–‡æ¡£</t-tag><t-tag v-else-if="row.type==='video'" theme="warning">è§†é¢‘</t-tag><t-tag v-else theme="default">å…¶ä»–</t-tag></template><template #size="{ row }">{{(row.size/(1024*1024)).toFixed(2)}} MB</template><template #operation="{ row }"><t-space size="small"><t-button theme="primary" size="small" variant="text" @click="handleDownload(row)">ä¸‹è½½</t-button><t-button theme="default" size="small" variant="text" @click="handleEdit(row)">ç¼–è¾‘</t-button><t-button theme="danger" size="small" variant="text" @click="handleDelete(row)">åˆ é™¤</t-button></t-space></template></t-table></div><t-dialog v-model:visible="formVisible" :header="formMode==='add'?'ä¸Šä¼ èµ„æ–™':'ç¼–è¾‘èµ„æ–™'" width="600px" @confirm="handleSubmit"><t-form ref="form" :data="formData" :rules="rules" label-width="100px"><t-form-item label="èµ„æ–™åç§°" name="title"><t-input v-model="formData.title" placeholder="è¯·è¾“å…¥èµ„æ–™åç§°"/></t-form-item><t-form-item label="å…³è”è¯¾ç¨‹" name="course_id"><t-select v-model="formData.course_id" :options="courseOptions" placeholder="é€‰æ‹©è¯¾ç¨‹"/></t-form-item><t-form-item label="èµ„æ–™ç±»å‹" name="type"><t-select v-model="formData.type" :options="typeOptions" placeholder="é€‰æ‹©ç±»å‹"/></t-form-item><t-form-item label="æ–‡ä»¶URL" name="file_url"><t-input v-model="formData.file_url" placeholder="æ–‡ä»¶å­˜å‚¨URL"/></t-form-item><t-form-item label="æ–‡ä»¶å¤§å°(B)" name="size"><t-input-number v-model="formData.size" :min="0" style="width:100%;"/></t-form-item><t-form-item label="èµ„æ–™æè¿°" name="description"><t-textarea v-model="formData.description" placeholder="é€‰å¡«" :maxlength="200" :autosize="{minRows:3,maxRows:6}"/></t-form-item></t-form></t-dialog>        </t-content>
      </t-layout>
    </t-layout>
  </div>

  <script src="../../assets/libs/vue.global.js"></script>
  <script src="../../assets/libs/tdesign.min.js"></script>
  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/admin-api.js"></script>
  <script src="../../assets/js/sidebar-navigation.js"></script>
  
  <script>
    const { createApp, ref, onMounted } = Vue;
    
    createApp({
      setup() {
        // å¼•å…¥ä¾§è¾¹æ å¯¼èˆªåŠŸèƒ½
        const { adminInfo, handleMenuChange, handleLogout } = SidebarNavigation.useSidebarNavigation();
        
        const loading = ref(false);
        const tableData = ref([]);
        const formVisible = ref(false);
        const formMode = ref('add');
        const formData = ref({});
        const filters = ref({ keyword: '', courseId: null, type: null });
        const courseOptions = ref([]);
        const typeOptions = [
          { label: 'PDF', value: 'pdf' },
          { label: 'æ–‡æ¡£', value: 'doc' },
          { label: 'è§†é¢‘', value: 'video' },
          { label: 'å…¶ä»–', value: 'other' }
        ];
        const pagination = ref({ current: 1, pageSize: 20, total: 0 });
        
        const columns = [
          { colKey: 'title', title: 'èµ„æ–™åç§°', width: 250 },
          { colKey: 'course_name', title: 'å…³è”è¯¾ç¨‹', width: 150 },
          { colKey: 'type', title: 'ç±»å‹', width: 100, cell: 'type' },
          { colKey: 'size', title: 'å¤§å°', width: 120, cell: 'size' },
          { colKey: 'download_count', title: 'ä¸‹è½½æ¬¡æ•°', width: 100 },
          { colKey: 'created_at', title: 'ä¸Šä¼ æ—¶é—´', width: 160 },
          { colKey: 'operation', title: 'æ“ä½œ', width: 180, fixed: 'right', cell: 'operation' }
        ];
        
        const rules = {
          title: [{ required: true, message: 'è¯·è¾“å…¥èµ„æ–™åç§°', type: 'error' }],
          course_id: [{ required: true, message: 'è¯·é€‰æ‹©å…³è”è¯¾ç¨‹', type: 'error' }],
          type: [{ required: true, message: 'è¯·é€‰æ‹©èµ„æ–™ç±»å‹', type: 'error' }],
          file_url: [{ required: true, message: 'è¯·è¾“å…¥æ–‡ä»¶URL', type: 'error' }]
        };
        
        const fetchData = async () => {
          loading.value = true;
          try {
            const params = {
              page: pagination.value.current,
              pageSize: pagination.value.pageSize,
              ...filters.value
            };
            const data = await AdminAPI.getMaterialList(params);
            tableData.value = data.list;
            pagination.value.total = data.total;
          } catch (error) {
            TDesign.MessagePlugin.error(error.message || 'è·å–æ•°æ®å¤±è´¥');
          } finally {
            loading.value = false;
          }
        };
        
        const fetchCourses = async () => {
          try {
            const data = await AdminAPI.getAllCourses();
            courseOptions.value = data.map(c => ({ label: c.name, value: c.id }));
          } catch (error) {
            console.error('è·å–è¯¾ç¨‹åˆ—è¡¨å¤±è´¥', error);
          }
        };
        
        const handleSearch = () => {
          pagination.value.current = 1;
          fetchData();
        };
        
        const handleReset = () => {
          filters.value = { keyword: '', courseId: null, type: null };
          handleSearch();
        };
        
        const handlePageChange = (pageInfo) => {
          pagination.value.current = pageInfo.current;
          pagination.value.pageSize = pageInfo.pageSize;
          fetchData();
        };
        
        const handleAdd = () => {
          formMode.value = 'add';
          formData.value = {};
          formVisible.value = true;
        };
        
        const handleEdit = (row) => {
          formMode.value = 'edit';
          formData.value = { ...row };
          formVisible.value = true;
        };
        
        const handleDelete = async (row) => {
          const confirmed = await TDesign.DialogPlugin.confirm({
            header: 'ç¡®è®¤åˆ é™¤',
            body: 'ç¡®è®¤åˆ é™¤è¯¥èµ„æ–™å—ï¼Ÿ',
            theme: 'warning'
          });
          if (!confirmed) return;
          
          try {
            await AdminAPI.deleteMaterial({ materialId: row.id });
            TDesign.MessagePlugin.success('åˆ é™¤æˆåŠŸ');
            fetchData();
          } catch (error) {
            TDesign.MessagePlugin.error(error.message || 'åˆ é™¤å¤±è´¥');
          }
        };
        
        const handleDownload = (row) => {
          window.open(row.file_url, '_blank');
        };
        
        const handleSubmit = async () => {
          try {
            if (formMode.value === 'add') {
              await AdminAPI.createMaterial(formData.value);
            } else {
              await AdminAPI.updateMaterial(formData.value);
            }
            TDesign.MessagePlugin.success('ä¿å­˜æˆåŠŸ');
            formVisible.value = false;
            fetchData();
          } catch (error) {
            TDesign.MessagePlugin.error(error.message || 'ä¿å­˜å¤±è´¥');
          }
        };
        
        onMounted(() => {
          fetchData();
          fetchCourses();
        });
        
        return {
          // ä¾§è¾¹æ å¯¼èˆª
          adminInfo,
          handleMenuChange,
          handleLogout,
          // é¡µé¢åŠŸèƒ½
          loading,
          tableData,
          formVisible,
          formMode,
          formData,
          filters,
          courseOptions,
          typeOptions,
          pagination,
          columns,
          rules,
          handleSearch,
          handleReset,
          handlePageChange,
          handleAdd,
          handleEdit,
          handleDelete,
          handleDownload,
          handleSubmit
        };
      }
    }).use(TDesign).mount('#app');
  </script>
</body>
</html>


