<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ’æœŸç®¡ç†</title>
  <link rel="stylesheet" href="../../assets/libs/tdesign.min.css">
  <link rel="stylesheet" href="../../assets/css/tokens.css">
  <style>
    body { margin: 0; padding: 20px; background: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    .page-container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .page-header { margin-bottom: 24px; }
    .page-title { font-size: 20px; font-weight: 600; color: #333; margin: 0 0 8px 0; }
    .page-desc { font-size: 14px; color: #999; margin: 0; }
    .search-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
  
    /* TDesign å¸ƒå±€æ ·å¼ - å¿…éœ€ï¼*/
    .t-layout {
      height: 100vh;
    }
    
    .t-layout__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      background: #fff;
      border-bottom: 1px solid #dcdcdc;
    }
    
    .t-layout__sider {
      background: #fff;
      border-right: 1px solid #dcdcdc;
      width: 240px !important;
      flex-shrink: 0;
    }
    
    .t-layout__content {
      padding: 24px;
      overflow-y: auto;
      background: #f5f5f5;
    }

  </style>
</head>
<body>
  <div id="app">
    <t-layout style="height: 100vh;">
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <t-header height="64px" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
        background: #fff;
        border-bottom: 1px solid #dcdcdc;
      ">
        <div style="display: flex; align-items: center; gap: 16px;">
          <span style="font-size: 18px; font-weight: 600; color: #333;">ğŸ¨ å¤©é“æ–‡åŒ–åå°ç®¡ç†</span>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span>{{ adminInfo?.real_name || adminInfo?.username || 'ç®¡ç†å‘˜' }}</span>
          <t-button size="small" @click="handleLogout">é€€å‡º</t-button>
        </div>
      </t-header>
      
      <t-layout>
        <!-- ä¾§è¾¹èœå• -->
        <t-aside width="240px" style="
          background: #fff;
          border-right: 1px solid #dcdcdc;
          overflow-y: auto;
        ">
          <t-menu
            value="schedule-list"
            :default-expanded="['user', 'order', 'course', 'ambassador', 'system']"
            theme="light"
            @change="handleMenuChange"
          >
            <t-menu-item value="dashboard">
              <template #icon><t-icon name="dashboard" /></template>
              æ•°æ®æ¦‚è§ˆ
            </t-menu-item>
            
            <t-submenu value="user">
              <template #icon><t-icon name="user" /></template>
              <template #title>ç”¨æˆ·ç®¡ç†</template>
              <t-menu-item value="user-list">å­¦å‘˜åˆ—è¡¨</t-menu-item>
              <t-menu-item value="user-referee">æ¨èå…³ç³»æŸ¥è¯¢</t-menu-item>
              <t-menu-item value="user-referee-logs">æ¨èäººå˜æ›´è®°å½•</t-menu-item>
            </t-submenu>
            
            <t-submenu value="order">
              <template #icon><t-icon name="order" /></template>
              <template #title>è®¢å•ç®¡ç†</template>
              <t-menu-item value="order-list">è®¢å•åˆ—è¡¨</t-menu-item>
              <t-menu-item value="order-refund">é€€æ¬¾ç®¡ç†</t-menu-item>
              <t-menu-item value="withdraw-audit">æç°å®¡æ ¸</t-menu-item>
            </t-submenu>
            
            <t-submenu value="course">
              <template #icon><t-icon name="file" /></template>
              <template #title>è¯¾ç¨‹ç®¡ç†</template>
              <t-menu-item value="course-list">è¯¾ç¨‹åˆ—è¡¨</t-menu-item>
              <t-menu-item value="schedule-list">æ’æœŸç®¡ç†</t-menu-item>
              <t-menu-item value="appointment-list">é¢„çº¦ç®¡ç†</t-menu-item>
              <t-menu-item value="case-list">æ¡ˆä¾‹ç®¡ç†</t-menu-item>
              <t-menu-item value="material-list">èµ„æ–™ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="ambassador">
              <template #icon><t-icon name="usergroup" /></template>
              <template #title>å¤§ä½¿ç®¡ç†</template>
              <t-menu-item value="ambassador-list">å¤§ä½¿åˆ—è¡¨</t-menu-item>
              <t-menu-item value="application-audit">ç”³è¯·å®¡æ ¸</t-menu-item>
              <t-menu-item value="activity-list">æ´»åŠ¨ç®¡ç†</t-menu-item>
              <t-menu-item value="contract-list">åˆçº¦ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="system">
              <template #icon><t-icon name="setting" /></template>
              <template #title>ç³»ç»Ÿç®¡ç†</template>
              <t-menu-item value="admin-list">ç®¡ç†å‘˜ç®¡ç†</t-menu-item>
              <t-menu-item value="config">ç³»ç»Ÿé…ç½®</t-menu-item>
              <t-menu-item value="announcement-list">å…¬å‘Šç®¡ç†</t-menu-item>
              <t-menu-item value="feedback-list">åé¦ˆç®¡ç†</t-menu-item>
              <t-menu-item value="notification-list">é€šçŸ¥ç®¡ç†</t-menu-item>
              <t-menu-item value="level-config">ç­‰çº§é…ç½®</t-menu-item>
            </t-submenu>
          </t-menu>
        </t-aside>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <t-content class="page-content">
    <div class="page-container">
      <div class="page-header">
        <h1 class="page-title">æ’æœŸç®¡ç†</h1>
        <p class="page-desc">ç®¡ç†è¯¾ç¨‹æ’æœŸï¼Œè®¾ç½®ä¸Šè¯¾æ—¶é—´å’Œåœ°ç‚¹</p>
      </div>

      <div class="search-bar">
        <t-select v-model="filters.courseId" :options="courseOptions" placeholder="é€‰æ‹©è¯¾ç¨‹" clearable style="width: 200px;" />
        <t-date-range-picker v-model="filters.dateRange" clearable placeholder="ä¸Šè¯¾æ—¶é—´" style="width: 280px;" />
        <t-select v-model="filters.status" :options="statusOptions" placeholder="çŠ¶æ€" clearable style="width: 150px;" />
        <t-button theme="primary" @click="handleSearch"><template #icon><t-icon name="search" /></template>æŸ¥è¯¢</t-button>
        <t-button theme="default" @click="handleReset"><template #icon><t-icon name="refresh" /></template>é‡ç½®</t-button>
        <t-button theme="success" @click="handleAdd"><template #icon><t-icon name="add" /></template>æ–°å¢æ’æœŸ</t-button>
      </div>

      <t-table :data="tableData" :columns="columns" :loading="loading" :pagination="pagination" @page-change="handlePageChange" row-key="id" bordered stripe hover>
        <template #status="{ row }">
          <t-tag v-if="row.status === 1" theme="success">å¯é¢„çº¦</t-tag>
          <t-tag v-else-if="row.status === 2" theme="warning">å·²æ»¡é¢</t-tag>
          <t-tag v-else theme="default">å·²ç»“æŸ</t-tag>
        </template>
        <template #operation="{ row }">
          <t-space size="small">
            <t-button theme="primary" size="small" variant="text" @click="handleEdit(row)">ç¼–è¾‘</t-button>
            <t-button theme="danger" size="small" variant="text" @click="handleDelete(row)">åˆ é™¤</t-button>
          </t-space>
        </template>
      </t-table>
    </div>

    <t-dialog v-model:visible="formVisible" :header="formMode === 'add' ? 'æ–°å¢æ’æœŸ' : 'ç¼–è¾‘æ’æœŸ'" width="600px" @confirm="handleSubmit">
      <t-form ref="form" :data="formData" :rules="rules" label-width="100px">
        <!-- æ‰€æœ‰å­—æ®µä½¿ç”¨ camelCaseï¼Œäº‘å‡½æ•°è´Ÿè´£è½¬æ¢ä¸º snake_case å­˜å…¥ DB -->
        <t-form-item label="è¯¾ç¨‹" name="courseId">
          <t-select v-model="formData.courseId" :options="courseOptions" placeholder="é€‰æ‹©è¯¾ç¨‹" />
        </t-form-item>
        <t-form-item label="ä¸Šè¯¾æ—¥æœŸ" name="classDate">
          <t-date-picker v-model="formData.classDate" clearable style="width: 100%;" />
        </t-form-item>
        <t-form-item label="å¼€å§‹æ—¶é—´" name="startTime">
          <t-time-picker v-model="formData.startTime" clearable style="width: 100%;" />
        </t-form-item>
        <t-form-item label="ç»“æŸæ—¶é—´" name="endTime">
          <t-time-picker v-model="formData.endTime" clearable style="width: 100%;" />
        </t-form-item>
        <t-form-item label="ä¸Šè¯¾åœ°ç‚¹" name="classLocation">
          <t-input v-model="formData.classLocation" placeholder="è¯·è¾“å…¥ä¸Šè¯¾åœ°ç‚¹" />
        </t-form-item>
        <t-form-item label="æ€»åé¢" name="totalQuota">
          <t-input-number v-model="formData.totalQuota" :min="1" :max="100" style="width: 100%;" />
        </t-form-item>
        <t-form-item label="å¤‡æ³¨" name="remark">
          <t-textarea v-model="formData.remark" placeholder="é€‰å¡«" :maxlength="200" />
        </t-form-item>
      </t-form>
    </t-dialog>
          </t-content>
      </t-layout>
    </t-layout>
  </div>

  <script src="../../assets/libs/vue.global.js"></script>
  <script src="../../assets/libs/tdesign.min.js"></script>
  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/admin-api.js"></script>

  <script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
      setup() {
        // ç®¡ç†å‘˜ä¿¡æ¯
        const adminInfo = ref(null);
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const checkAuth = () => {
          adminInfo.value = AdminAPI.getCurrentAdmin();
          if (!adminInfo.value) {
            window.location.href = '../../login.html';
            return false;
          }
          return true;
        };
        
        // é€€å‡ºç™»å½•
        const handleLogout = () => {
          TDesign.DialogPlugin.confirm({
            header: 'ç¡®è®¤é€€å‡º',
            body: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
            onConfirm: () => {
              AdminAPI.logout();
            }
          });
        };
        
        // èœå•åˆ‡æ¢
        const handleMenuChange = (value) => {
          const routes = {
            'dashboard': '../../index.html',
            'user-list': '../user/list.html',
            'user-referee': '../user/referee.html',
            'user-referee-logs': '../user/referee-logs.html',
            'order-list': '../order/list.html',
            'order-refund': '../order/refund.html',
            'withdraw-audit': '../order/withdraw-audit.html',
            'course-list': '../course/list.html',
            'schedule-list': '../course/schedule.html',
            'appointment-list': '../course/appointment.html',
            'case-list': '../course/case.html',
            'material-list': '../course/material.html',
            'ambassador-list': '../ambassador/list.html',
            'application-audit': '../ambassador/application-audit.html',
            'activity-list': '../ambassador/activity.html',
            'contract-list': '../ambassador/contract.html',
            'admin-list': '../system/admin.html',
            'config': '../system/config.html',
            'announcement-list': '../system/announcement.html',
            'feedback-list': '../system/feedback.html',
            'notification-list': '../system/notification.html',
            'level-config': '../system/level-config.html',
          };
          
          if (routes[value]) {
            window.location.href = routes[value];
          }
        };
        
        
        const loading = ref(false);
        const tableData = ref([]);
        const formVisible = ref(false);
        const formMode = ref('add');
        const formData = ref({});
        const filters = ref({ courseId: null, dateRange: [], status: null });
        const courseOptions = ref([]);
        const statusOptions = [
          { label: 'å¯é¢„çº¦', value: 1 },
          { label: 'å·²æ»¡é¢', value: 2 },
          { label: 'å·²ç»“æŸ', value: 0 }
        ];
        const pagination = ref({ current: 1, pageSize: 20, total: 0 });
        const columns = [
          { colKey: 'id', title: 'ID', width: 80 },
          { colKey: 'course_name', title: 'è¯¾ç¨‹åç§°', width: 200 },
          { colKey: 'class_date', title: 'ä¸Šè¯¾æ—¥æœŸ', width: 120 },
          { colKey: 'class_time', title: 'ä¸Šè¯¾æ—¶é—´', width: 120 },
          { colKey: 'class_location', title: 'ä¸Šè¯¾åœ°ç‚¹', ellipsis: true },
          { colKey: 'booked_quota', title: 'å·²é¢„çº¦', width: 100 },
          { colKey: 'total_quota', title: 'æ€»åé¢', width: 100 },
          { colKey: 'status', title: 'çŠ¶æ€', width: 100, cell: 'status' },
          { colKey: 'operation', title: 'æ“ä½œ', width: 150, fixed: 'right', cell: 'operation' }
        ];
        // è¡¨å•éªŒè¯è§„åˆ™ï¼Œname ä¸è¡¨å•å­—æ®µ camelCase ä¿æŒä¸€è‡´
        const rules = {
          courseId: [{ required: true, message: 'è¯·é€‰æ‹©è¯¾ç¨‹', type: 'error' }],
          classDate: [{ required: true, message: 'è¯·é€‰æ‹©ä¸Šè¯¾æ—¥æœŸ', type: 'error' }],
          startTime: [{ required: true, message: 'è¯·é€‰æ‹©å¼€å§‹æ—¶é—´', type: 'error' }],
          endTime: [{ required: true, message: 'è¯·é€‰æ‹©ç»“æŸæ—¶é—´', type: 'error' }],
          classLocation: [{ required: true, message: 'è¯·è¾“å…¥ä¸Šè¯¾åœ°ç‚¹', type: 'error' }],
          totalQuota: [{ required: true, message: 'è¯·è¾“å…¥æ€»åé¢', type: 'error' }]
        };

        const fetchData = async () => {
          loading.value = true;
          try {
            const params = { page: pagination.value.current, pageSize: pagination.value.pageSize, ...filters.value };
            const data = await AdminAPI.getScheduleList(params);
            tableData.value = data.list;
            pagination.value.total = data.total;
          } catch (error) {
            TDesign.MessagePlugin.error(error.message || 'è·å–æ•°æ®å¤±è´¥');
          } finally {
            loading.value = false;
          }
        };

        const fetchCourses = async () => {
          try {
            const data = await AdminAPI.getAllCourses();
            courseOptions.value = data.map(c => ({ label: c.name, value: c.id }));
          } catch (error) {
            console.error('è·å–è¯¾ç¨‹åˆ—è¡¨å¤±è´¥', error);
          }
        };

        const handleSearch = () => { pagination.value.current = 1; fetchData(); };
        const handleReset = () => { filters.value = { courseId: null, dateRange: [], status: null }; handleSearch(); };
        const handlePageChange = (pageInfo) => { pagination.value.current = pageInfo.current; pagination.value.pageSize = pageInfo.pageSize; fetchData(); };
        const handleAdd = () => { formMode.value = 'add'; formData.value = { totalQuota: 30 }; formVisible.value = true; };
        const handleEdit = (row) => {
          formMode.value = 'edit';
          // DB è¿”å› snake_caseï¼Œæ˜ å°„ä¸º camelCase ä¾›è¡¨å•ä½¿ç”¨
          // class_time æ ¼å¼å¦‚ "09:00-17:00"ï¼Œæ‹†åˆ†ä¸º startTime/endTime
          const timeParts = (row.class_time || '').split('-');
          formData.value = {
            id: row.id,
            courseId: row.course_id,
            classDate: row.class_date,
            startTime: timeParts[0] || '',
            endTime: timeParts[1] || '',
            classLocation: row.class_location,
            totalQuota: row.total_quota,
            remark: row.remark,
            teacher: row.teacher,
            status: row.status
          };
          formVisible.value = true;
        };
        const handleDelete = async (row) => {
          const confirmed = await TDesign.DialogPlugin.confirm({ header: 'ç¡®è®¤åˆ é™¤', body: 'ç¡®è®¤åˆ é™¤è¯¥æ’æœŸå—ï¼Ÿ', theme: 'warning' });
          if (!confirmed) return;
          try {
            await AdminAPI.deleteSchedule({ scheduleId: row.id });
            TDesign.MessagePlugin.success('åˆ é™¤æˆåŠŸ');
            fetchData();
          } catch (error) {
            TDesign.MessagePlugin.error(error.message || 'åˆ é™¤å¤±è´¥');
          }
        };
        const handleSubmit = async () => {
          try {
            if (formMode.value === 'add') {
              await AdminAPI.createSchedule(formData.value);
            } else {
              await AdminAPI.updateSchedule(formData.value);
            }
            TDesign.MessagePlugin.success('ä¿å­˜æˆåŠŸ');
            formVisible.value = false;
            fetchData();
          } catch (error) {
            TDesign.MessagePlugin.error(error.message || 'ä¿å­˜å¤±è´¥');
          }
        };

        onMounted(() => {
          if (checkAuth()) { fetchData(); fetchCourses(); }
        });

        return {
          adminInfo,
          handleLogout,
          handleMenuChange, loading, tableData, formVisible, formMode, formData, filters, courseOptions, statusOptions, pagination, columns, rules, handleSearch, handleReset, handlePageChange, handleAdd, handleEdit, handleDelete, handleSubmit };
      }
    }).use(TDesign).mount('#app');
  </script>
</body>
</html>








