<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€€æ¬¾å®¡æ ¸</title>
  <link rel="stylesheet" href="../../assets/libs/tdesign.min.css">
  <link rel="stylesheet" href="../../assets/css/tokens.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .page-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .page-header {
      margin-bottom: 24px;
    }
    .page-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin: 0 0 8px 0;
    }
    .page-desc {
      font-size: 14px;
      color: #999;
      margin: 0;
    }
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card:nth-child(2) {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .stat-card:nth-child(3) {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .stat-card:nth-child(4) {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    .stat-value {
      font-size: 32px;
      font-weight: 600;
      margin: 8px 0;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div id="app">
    <t-layout style="height: 100vh;">
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <t-header height="64px" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
        background: #fff;
        border-bottom: 1px solid #dcdcdc;
      ">
        <div style="display: flex; align-items: center; gap: 16px;">
          <span style="font-size: 18px; font-weight: 600; color: #333;">ğŸ¨ å¤©é“æ–‡åŒ–åå°ç®¡ç†</span>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span>{{ adminInfo?.real_name || adminInfo?.username || 'ç®¡ç†å‘˜' }}</span>
          <t-button size="small" @click="handleLogout">é€€å‡º</t-button>
        </div>
      </t-header>
      
      <t-layout>
        <!-- ä¾§è¾¹èœå• -->
        <t-aside width="240px" style="
          background: #fff;
          border-right: 1px solid #dcdcdc;
          overflow-y: auto;
        ">
          <t-menu
            value="order-refund"
            :default-expanded="['user', 'order', 'course', 'ambassador', 'system']"
            theme="light"
            @change="handleMenuChange"
          >
            <t-menu-item value="dashboard">
              <template #icon><t-icon name="dashboard" /></template>
              æ•°æ®æ¦‚è§ˆ
            </t-menu-item>
            
            <t-submenu value="user">
              <template #icon><t-icon name="user" /></template>
              <template #title>ç”¨æˆ·ç®¡ç†</template>
              <t-menu-item value="user-list">å­¦å‘˜åˆ—è¡¨</t-menu-item>
              <t-menu-item value="user-referee">æ¨èäººç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="order">
              <template #icon><t-icon name="order" /></template>
              <template #title>è®¢å•ç®¡ç†</template>
              <t-menu-item value="order-list">è®¢å•åˆ—è¡¨</t-menu-item>
              <t-menu-item value="order-refund">é€€æ¬¾ç®¡ç†</t-menu-item>
              <t-menu-item value="withdraw-audit">æç°å®¡æ ¸</t-menu-item>
            </t-submenu>
            
            <t-submenu value="course">
              <template #icon><t-icon name="file" /></template>
              <template #title>è¯¾ç¨‹ç®¡ç†</template>
              <t-menu-item value="course-list">è¯¾ç¨‹åˆ—è¡¨</t-menu-item>
              <t-menu-item value="schedule-list">æ’æœŸç®¡ç†</t-menu-item>
              <t-menu-item value="appointment-list">é¢„çº¦ç®¡ç†</t-menu-item>
              <t-menu-item value="case-list">æ¡ˆä¾‹ç®¡ç†</t-menu-item>
              <t-menu-item value="material-list">èµ„æ–™ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="ambassador">
              <template #icon><t-icon name="usergroup" /></template>
              <template #title>å¤§ä½¿ç®¡ç†</template>
              <t-menu-item value="ambassador-list">å¤§ä½¿åˆ—è¡¨</t-menu-item>
              <t-menu-item value="application-audit">ç”³è¯·å®¡æ ¸</t-menu-item>
              <t-menu-item value="activity-list">æ´»åŠ¨ç®¡ç†</t-menu-item>
              <t-menu-item value="contract-list">åˆçº¦ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="system">
              <template #icon><t-icon name="setting" /></template>
              <template #title>ç³»ç»Ÿç®¡ç†</template>
              <t-menu-item value="admin-list">ç®¡ç†å‘˜ç®¡ç†</t-menu-item>
              <t-menu-item value="config">ç³»ç»Ÿé…ç½®</t-menu-item>
              <t-menu-item value="announcement-list">å…¬å‘Šç®¡ç†</t-menu-item>
              <t-menu-item value="feedback-list">åé¦ˆç®¡ç†</t-menu-item>
              <t-menu-item value="notification-list">é€šçŸ¥ç®¡ç†</t-menu-item>
              <t-menu-item value="level-config">ç­‰çº§é…ç½®</t-menu-item>
            </t-submenu>
          </t-menu>
        </t-aside>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <t-content class="page-content">
    <div class="page-container">
      <!-- é¡µé¢å¤´éƒ¨ -->
      <div class="page-header">
        <h1 class="page-title">é€€æ¬¾å®¡æ ¸</h1>
        <p class="page-desc">å¤„ç†ç”¨æˆ·é€€æ¬¾ç”³è¯·ï¼Œæ”¯æŒæ‰¹é‡å®¡æ ¸å’Œé©³å›</p>
      </div>

      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="stats-cards">
        <div class="stat-card">
          <div class="stat-label">å¾…å®¡æ ¸</div>
          <div class="stat-value">{{ statistics.pending || 0 }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å·²é€šè¿‡</div>
          <div class="stat-value">{{ statistics.approved || 0 }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å·²é©³å›</div>
          <div class="stat-value">{{ statistics.rejected || 0 }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æ€»é‡‘é¢ï¼ˆå…ƒï¼‰</div>
          <div class="stat-value">{{ (statistics.totalAmount / 100).toFixed(2) || '0.00' }}</div>
        </div>
      </div>

      <!-- æœç´¢æ  -->
      <div class="search-bar">
        <t-input 
          v-model="filters.keyword" 
          placeholder="è®¢å•å·/ç”¨æˆ·æ‰‹æœºå·"
          clearable
          style="width: 220px;"
        >
          <template #prefix-icon>
            <t-icon name="search" />
          </template>
        </t-input>
        
        <t-select 
          v-model="filters.status" 
          :options="statusOptions"
          placeholder="é€€æ¬¾çŠ¶æ€"
          clearable
          style="width: 150px;"
        />

        <t-date-range-picker
          v-model="filters.dateRange"
          clearable
          placeholder="ç”³è¯·æ—¶é—´"
          style="width: 280px;"
        />
        
        <t-button theme="primary" @click="handleSearch">
          <template #icon><t-icon name="search" /></template>
          æŸ¥è¯¢
        </t-button>
        
        <t-button theme="default" @click="handleReset">
          <template #icon><t-icon name="refresh" /></template>
          é‡ç½®
        </t-button>

        <t-button 
          theme="success" 
          @click="handleBatchApprove"
          :disabled="selectedRowKeys.length === 0"
        >
          <template #icon><t-icon name="check-circle" /></template>
          æ‰¹é‡é€šè¿‡
        </t-button>

        <t-button 
          theme="danger" 
          @click="handleBatchReject"
          :disabled="selectedRowKeys.length === 0"
        >
          <template #icon><t-icon name="close-circle" /></template>
          æ‰¹é‡é©³å›
        </t-button>
      </div>

      <!-- æ•°æ®è¡¨æ ¼ -->
      <t-table
        :data="tableData"
        :columns="columns"
        :loading="loading"
        :pagination="pagination"
        row-key="id"
        :selected-row-keys="selectedRowKeys"
        @select-change="handleSelectChange"
        @page-change="handlePageChange"
        bordered
        stripe
        hover
      >
        <template #status="{ row }">
          <t-tag v-if="row.refund_status === 0" theme="warning">å¾…å®¡æ ¸</t-tag>
          <t-tag v-else-if="row.refund_status === 1" theme="success">å·²é€šè¿‡</t-tag>
          <t-tag v-else-if="row.refund_status === 2" theme="danger">å·²é©³å›</t-tag>
        </template>

        <template #amount="{ row }">
          <span style="color: #e37318; font-weight: 600;">Â¥{{ (row.amount / 100).toFixed(2) }}</span>
        </template>

        <template #operation="{ row }">
          <t-space size="small">
            <t-button 
              theme="primary" 
              size="small" 
              variant="text"
              @click="handleViewDetail(row)"
            >
              æŸ¥çœ‹è¯¦æƒ…
            </t-button>
            <t-button 
              v-if="row.refund_status === 0"
              theme="success" 
              size="small" 
              variant="text"
              @click="handleApprove(row)"
            >
              é€šè¿‡
            </t-button>
            <t-button 
              v-if="row.refund_status === 0"
              theme="danger" 
              size="small" 
              variant="text"
              @click="handleReject(row)"
            >
              é©³å›
            </t-button>
          </t-space>
        </template>
      </t-table>
    </div>

    <!-- è¯¦æƒ…å¯¹è¯æ¡† -->
    <t-dialog
      v-model:visible="detailVisible"
      header="é€€æ¬¾è¯¦æƒ…"
      width="600px"
      :footer="false"
    >
      <div v-if="currentRecord" style="padding: 16px 0;">
        <t-descriptions bordered :column="2">
          <t-descriptions-item label="è®¢å•å·">{{ currentRecord.order_no }}</t-descriptions-item>
          <t-descriptions-item label="é€€æ¬¾é‡‘é¢">
            <span style="color: #e37318; font-weight: 600;">Â¥{{ (currentRecord.amount / 100).toFixed(2) }}</span>
          </t-descriptions-item>
          <t-descriptions-item label="ç”¨æˆ·å§“å">{{ currentRecord.user_name }}</t-descriptions-item>
          <t-descriptions-item label="ç”¨æˆ·æ‰‹æœº">{{ currentRecord.user_phone }}</t-descriptions-item>
          <t-descriptions-item label="ç”³è¯·æ—¶é—´" :span="2">{{ currentRecord.created_at }}</t-descriptions-item>
          <t-descriptions-item label="é€€æ¬¾åŸå› " :span="2">{{ currentRecord.refund_reason || 'æ— ' }}</t-descriptions-item>
          <t-descriptions-item label="å®¡æ ¸çŠ¶æ€" :span="2">
            <t-tag v-if="currentRecord.refund_status === 0" theme="warning">å¾…å®¡æ ¸</t-tag>
            <t-tag v-else-if="currentRecord.refund_status === 1" theme="success">å·²é€šè¿‡</t-tag>
            <t-tag v-else-if="currentRecord.refund_status === 2" theme="danger">å·²é©³å›</t-tag>
          </t-descriptions-item>
          <t-descriptions-item v-if="currentRecord.reject_reason" label="é©³å›åŸå› " :span="2">
            {{ currentRecord.reject_reason }}
          </t-descriptions-item>
          <t-descriptions-item v-if="currentRecord.approved_at" label="å®¡æ ¸æ—¶é—´" :span="2">
            {{ currentRecord.approved_at }}
          </t-descriptions-item>
        </t-descriptions>
      </div>
    </t-dialog>

    <!-- é©³å›åŸå› å¯¹è¯æ¡† -->
    <t-dialog
      v-model:visible="rejectVisible"
      header="é©³å›é€€æ¬¾ç”³è¯·"
      width="500px"
      @confirm="confirmReject"
      @close="rejectReason = ''"
    >
      <t-textarea
        v-model="rejectReason"
        placeholder="è¯·è¾“å…¥é©³å›åŸå› ï¼ˆå¿…å¡«ï¼‰"
        :maxlength="200"
        :autosize="{ minRows: 4, maxRows: 8 }"
      />
    </t-dialog>
          </t-content>
      </t-layout>
    </t-layout>
  </div>

  <script src="../../assets/libs/vue.global.js"></script>
  <script src="../../assets/libs/tdesign.min.js"></script>
  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/admin-api.js"></script>

  <script>
    const { createApp, ref, onMounted } = Vue;

    const app = createApp({
      setup() {
        // ç®¡ç†å‘˜ä¿¡æ¯
        const adminInfo = ref(null);
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const checkAuth = () => {
          adminInfo.value = AdminAPI.getCurrentAdmin();
          if (!adminInfo.value) {
            window.location.href = '../../login.html';
            return false;
          }
          return true;
        };
        
        // é€€å‡ºç™»å½•
        const handleLogout = () => {
          TDesign.DialogPlugin.confirm({
            header: 'ç¡®è®¤é€€å‡º',
            body: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
            onConfirm: () => {
              AdminAPI.logout();
            }
          });
        };
        
        // èœå•åˆ‡æ¢
        const handleMenuChange = (value) => {
          const routes = {
            'dashboard': '../../index.html',
            'user-list': '../user/list.html',
            'user-referee': '../user/referee.html',
            'order-list': '../order/list.html',
            'order-refund': '../order/refund.html',
            'withdraw-audit': '../order/withdraw-audit.html',
            'course-list': '../course/list.html',
            'schedule-list': '../course/schedule.html',
            'appointment-list': '../course/appointment.html',
            'case-list': '../course/case.html',
            'material-list': '../course/material.html',
            'ambassador-list': '../ambassador/list.html',
            'application-audit': '../ambassador/application-audit.html',
            'activity-list': '../ambassador/activity.html',
            'contract-list': '../ambassador/contract.html',
            'admin-list': '../system/admin.html',
            'config': '../system/config.html',
            'announcement-list': '../system/announcement.html',
            'feedback-list': '../system/feedback.html',
            'notification-list': '../system/notification.html',
            'level-config': '../system/level-config.html',
          };
          
          if (routes[value]) {
            window.location.href = routes[value];
          }
        };
        
        
        const loading = ref(false);
        const tableData = ref([]);
        const selectedRowKeys = ref([]);
        const detailVisible = ref(false);
        const rejectVisible = ref(false);
        const currentRecord = ref(null);
        const rejectReason = ref('');
        const rejectTarget = ref(null); // å•ä¸ªæˆ–æ‰¹é‡

        const statistics = ref({
          pending: 0,
          approved: 0,
          rejected: 0,
          totalAmount: 0
        });

        const filters = ref({
          keyword: '',
          status: null,
          dateRange: []
        });

        const statusOptions = [
          { label: 'å…¨éƒ¨', value: null },
          { label: 'å¾…å®¡æ ¸', value: 0 },
          { label: 'å·²é€šè¿‡', value: 1 },
          { label: 'å·²é©³å›', value: 2 }
        ];

        const pagination = ref({
          current: 1,
          pageSize: 20,
          total: 0
        });

        const columns = [
          { colKey: 'row-select', type: 'multiple', width: 50, fixed: 'left' },
          { colKey: 'order_no', title: 'è®¢å•å·', width: 180 },
          { colKey: 'user_name', title: 'ç”¨æˆ·å§“å', width: 120 },
          { colKey: 'user_phone', title: 'æ‰‹æœºå·', width: 130 },
          { colKey: 'amount', title: 'é€€æ¬¾é‡‘é¢', width: 120, cell: 'amount' },
          { colKey: 'refund_reason', title: 'é€€æ¬¾åŸå› ', ellipsis: true },
          { colKey: 'created_at', title: 'ç”³è¯·æ—¶é—´', width: 160 },
          { colKey: 'status', title: 'çŠ¶æ€', width: 100, cell: 'status' },
          { colKey: 'operation', title: 'æ“ä½œ', width: 200, fixed: 'right', cell: 'operation' }
        ];

        const fetchData = async () => {
          loading.value = true;
          try {
            const params = {
              page: pagination.value.current,
              pageSize: pagination.value.pageSize,
              ...filters.value
            };

            const data = await AdminAPI.getRefundList(params);
            
            tableData.value = data.list;
            pagination.value.total = data.total;
            statistics.value = data.statistics;
          } catch (error) {
            TDesign.MessagePlugin.error(error.message || 'è·å–æ•°æ®å¤±è´¥');
          } finally {
            loading.value = false;
          }
        };

        const handleSearch = () => {
          pagination.value.current = 1;
          fetchData();
        };

        const handleReset = () => {
          filters.value = {
            keyword: '',
            status: null,
            dateRange: []
          };
          handleSearch();
        };

        const handleSelectChange = (value) => {
          selectedRowKeys.value = value;
        };

        const handlePageChange = (pageInfo) => {
          pagination.value.current = pageInfo.current;
          pagination.value.pageSize = pageInfo.pageSize;
          fetchData();
        };

        const handleViewDetail = (row) => {
          currentRecord.value = row;
          detailVisible.value = true;
        };

        const handleApprove = async (row) => {
          const confirmed = await TDesign.DialogPlugin.confirm({
            header: 'ç¡®è®¤é€šè¿‡',
            body: `ç¡®è®¤é€šè¿‡è®¢å• ${row.order_no} çš„é€€æ¬¾ç”³è¯·å—ï¼Ÿ`,
            theme: 'success'
          });

          if (!confirmed) return;

          try {
            await AdminAPI.approveRefund({ refundIds: [row.id] });
            TDesign.MessagePlugin.success('å®¡æ ¸é€šè¿‡');
            fetchData();
          } catch (error) {
            TDesign.MessagePlugin.error(error.message || 'æ“ä½œå¤±è´¥');
          }
        };

        const handleReject = (row) => {
          rejectTarget.value = [row.id];
          rejectVisible.value = true;
        };

        const handleBatchApprove = async () => {
          const confirmed = await TDesign.DialogPlugin.confirm({
            header: 'æ‰¹é‡é€šè¿‡',
            body: `ç¡®è®¤é€šè¿‡é€‰ä¸­çš„ ${selectedRowKeys.value.length} æ¡é€€æ¬¾ç”³è¯·å—ï¼Ÿ`,
            theme: 'success'
          });

          if (!confirmed) return;

          try {
            await AdminAPI.approveRefund({ refundIds: selectedRowKeys.value });
            TDesign.MessagePlugin.success('æ‰¹é‡å®¡æ ¸é€šè¿‡');
            selectedRowKeys.value = [];
            fetchData();
          } catch (error) {
            TDesign.MessagePlugin.error(error.message || 'æ“ä½œå¤±è´¥');
          }
        };

        const handleBatchReject = () => {
          rejectTarget.value = selectedRowKeys.value;
          rejectVisible.value = true;
        };

        const confirmReject = async () => {
          if (!rejectReason.value.trim()) {
            TDesign.MessagePlugin.warning('è¯·è¾“å…¥é©³å›åŸå› ');
            return;
          }

          try {
            await AdminAPI.rejectRefund({
              refundIds: rejectTarget.value,
              rejectReason: rejectReason.value
            });

            TDesign.MessagePlugin.success('å·²é©³å›');
            rejectVisible.value = false;
            rejectReason.value = '';
            selectedRowKeys.value = [];
            fetchData();
          } catch (error) {
            TDesign.MessagePlugin.error(error.message || 'æ“ä½œå¤±è´¥');
          }
        };

        onMounted(() => {
          if (checkAuth()) {
          fetchData();
        }
        });

        return {
          adminInfo,
          handleLogout,
          handleMenuChange,
          loading,
          tableData,
          selectedRowKeys,
          detailVisible,
          rejectVisible,
          currentRecord,
          rejectReason,
          statistics,
          filters,
          statusOptions,
          pagination,
          columns,
          handleSearch,
          handleReset,
          handleSelectChange,
          handlePageChange,
          handleViewDetail,
          handleApprove,
          handleReject,
          handleBatchApprove,
          handleBatchReject,
          confirmReject
        };
      }
    });

    app.use(TDesign);
    app.mount('#app');
  </script>
</body>
</html>

