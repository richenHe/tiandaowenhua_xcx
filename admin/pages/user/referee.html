<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¨èå…³ç³»æŸ¥è¯¢</title>
  <link rel="stylesheet" href="../../assets/libs/tdesign.min.css">
  <link rel="stylesheet" href="../../assets/css/tokens.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    .page-content {
      height: 100%;
      overflow-y: auto;
      background: #f5f5f5;
      padding: 24px;
    }
    
    .page-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .page-header {
      margin-bottom: 24px;
    }
    .page-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin: 0 0 8px 0;
    }
    .page-desc {
      font-size: 14px;
      color: #999;
      margin: 0;
    }
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tree-container {
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      padding: 20px;
      background: #fafafa;
      min-height: 400px;
    }
    .user-node {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      padding: 12px 16px;
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }
    .user-node:hover {
      border-color: #0052d9;
      box-shadow: 0 2px 8px rgba(0,82,217,0.1);
    }
    .user-info {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .user-stats {
      display: flex;
      gap: 16px;
      font-size: 14px;
      color: #666;
    }
    .child-nodes {
      margin-left: 40px;
      border-left: 2px dashed #e5e5e5;
      padding-left: 20px;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
  
    /* TDesign å¸ƒå±€æ ·å¼ - å¿…éœ€ï¼*/
    .t-layout {
      height: 100vh;
    }
    
    .t-layout__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      background: #fff;
      border-bottom: 1px solid #dcdcdc;
    }
    
    .t-layout__sider {
      background: #fff;
      border-right: 1px solid #dcdcdc;
      width: 240px !important;
      flex-shrink: 0;
    }
    
    .t-layout__content {
      padding: 24px;
      overflow-y: auto;
      background: #f5f5f5;
    }

  </style>
</head>
<body>
  <div id="app">
    <t-layout style="height: 100vh;">
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <t-header height="64px" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
        background: #fff;
        border-bottom: 1px solid #dcdcdc;
      ">
        <div style="display: flex; align-items: center; gap: 16px;">
          <span style="font-size: 18px; font-weight: 600; color: #333;">ğŸ¨ å¤©é“æ–‡åŒ–åå°ç®¡ç†</span>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span>{{ adminInfo?.real_name || adminInfo?.username || 'ç®¡ç†å‘˜' }}</span>
          <t-button size="small" @click="handleLogout">é€€å‡º</t-button>
        </div>
      </t-header>
      
      <t-layout>
        <!-- ä¾§è¾¹èœå• -->
        <t-aside width="240px" style="
          background: #fff;
          border-right: 1px solid #dcdcdc;
          overflow-y: auto;
        ">
          <t-menu
            value="user-referee"
            :default-expanded="['user', 'order', 'course', 'ambassador', 'system']"
            theme="light"
            @change="handleMenuChange"
          >
            <t-menu-item value="dashboard">
              <template #icon><t-icon name="dashboard" /></template>
              æ•°æ®æ¦‚è§ˆ
            </t-menu-item>
            
            <t-submenu value="user">
              <template #icon><t-icon name="user" /></template>
              <template #title>ç”¨æˆ·ç®¡ç†</template>
              <t-menu-item value="user-list">å­¦å‘˜åˆ—è¡¨</t-menu-item>
              <t-menu-item value="user-referee">æ¨èå…³ç³»æŸ¥è¯¢</t-menu-item>
              <t-menu-item value="user-referee-logs">æ¨èäººå˜æ›´è®°å½•</t-menu-item>
            </t-submenu>
            
            <t-submenu value="order">
              <template #icon><t-icon name="order" /></template>
              <template #title>è®¢å•ç®¡ç†</template>
              <t-menu-item value="order-list">è®¢å•åˆ—è¡¨</t-menu-item>
              <t-menu-item value="order-refund">é€€æ¬¾ç®¡ç†</t-menu-item>
              <t-menu-item value="withdraw-audit">æç°å®¡æ ¸</t-menu-item>
            </t-submenu>
            
            <t-submenu value="course">
              <template #icon><t-icon name="file" /></template>
              <template #title>è¯¾ç¨‹ç®¡ç†</template>
              <t-menu-item value="course-list">è¯¾ç¨‹åˆ—è¡¨</t-menu-item>
              <t-menu-item value="schedule-list">æ’æœŸç®¡ç†</t-menu-item>
              <t-menu-item value="appointment-list">é¢„çº¦ç®¡ç†</t-menu-item>
              <t-menu-item value="case-list">æ¡ˆä¾‹ç®¡ç†</t-menu-item>
              <t-menu-item value="material-list">èµ„æ–™ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="ambassador">
              <template #icon><t-icon name="usergroup" /></template>
              <template #title>å¤§ä½¿ç®¡ç†</template>
              <t-menu-item value="ambassador-list">å¤§ä½¿åˆ—è¡¨</t-menu-item>
              <t-menu-item value="application-audit">ç”³è¯·å®¡æ ¸</t-menu-item>
              <t-menu-item value="activity-list">æ´»åŠ¨ç®¡ç†</t-menu-item>
              <t-menu-item value="contract-list">åˆçº¦ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="system">
              <template #icon><t-icon name="setting" /></template>
              <template #title>ç³»ç»Ÿç®¡ç†</template>
              <t-menu-item value="admin-list">ç®¡ç†å‘˜ç®¡ç†</t-menu-item>
              <t-menu-item value="config">ç³»ç»Ÿé…ç½®</t-menu-item>
              <t-menu-item value="announcement-list">å…¬å‘Šç®¡ç†</t-menu-item>
              <t-menu-item value="feedback-list">åé¦ˆç®¡ç†</t-menu-item>
              <t-menu-item value="notification-list">é€šçŸ¥ç®¡ç†</t-menu-item>
              <t-menu-item value="level-config">ç­‰çº§é…ç½®</t-menu-item>
            </t-submenu>
          </t-menu>
        </t-aside>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <t-content class="page-content">
          <div class="page-container">
      <!-- é¡µé¢å¤´éƒ¨ -->
      <div class="page-header">
        <h1 class="page-title">æ¨èå…³ç³»æŸ¥è¯¢</h1>
        <p class="page-desc">æŸ¥çœ‹ç”¨æˆ·æ¨èæ ‘çŠ¶å…³ç³»ï¼Œæ”¯æŒæŒ‰ç”¨æˆ·IDæˆ–æ‰‹æœºå·æŸ¥è¯¢</p>
      </div>

      <!-- æœç´¢æ  -->
      <div class="search-bar">
        <t-input 
          v-model="searchQuery" 
          placeholder="è¾“å…¥ç”¨æˆ·IDæˆ–æ‰‹æœºå·"
          clearable
          style="width: 300px;"
          @enter="handleSearch"
        >
          <template #prefix-icon>
            <t-icon name="search" />
          </template>
        </t-input>
        
        <t-button theme="primary" @click="handleSearch" :loading="loading">
          <template #icon><t-icon name="search" /></template>
          æŸ¥è¯¢
        </t-button>
        
        <t-button theme="default" @click="handleReset">
          <template #icon><t-icon name="refresh" /></template>
          é‡ç½®
        </t-button>

        <t-select 
          v-model="treeDirection" 
          :options="directionOptions"
          style="width: 150px;"
          @change="handleDirectionChange"
        />
      </div>

      <!-- æ¨èæ ‘å±•ç¤º -->
      <div class="tree-container">
        <div v-if="!treeData && !loading" class="empty-state">
          <t-icon name="search" size="48px" style="color: #ddd; margin-bottom: 12px;" />
          <p>è¯·è¾“å…¥ç”¨æˆ·IDæˆ–æ‰‹æœºå·æŸ¥è¯¢æ¨èå…³ç³»</p>
        </div>

        <div v-else-if="loading" class="empty-state">
          <t-loading size="large" />
          <p style="margin-top: 12px;">åŠ è½½ä¸­...</p>
        </div>

        <div v-else-if="treeData">
          <user-tree-node 
            :node="treeData" 
            :direction="treeDirection"
            :level="0"
            @expand="handleExpand"
          />
        </div>

        <div v-else class="empty-state">
          <t-icon name="info-circle" size="48px" style="color: #ddd; margin-bottom: 12px;" />
          <p>æœªæ‰¾åˆ°ç›¸å…³ç”¨æˆ·</p>
        </div>
      </div>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <div v-if="treeData && stats" style="margin-top: 20px; padding: 16px; background: #f5f5f5; border-radius: 4px;">
        <t-row :gutter="16">
          <t-col :span="3">
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: 600; color: #0052d9;">{{ stats.totalUsers }}</div>
              <div style="font-size: 14px; color: #666; margin-top: 4px;">æ€»ç”¨æˆ·æ•°</div>
            </div>
          </t-col>
          <t-col :span="3">
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: 600; color: #00a870;">{{ stats.directReferrals }}</div>
              <div style="font-size: 14px; color: #666; margin-top: 4px;">ç›´æ¥æ¨è</div>
            </div>
          </t-col>
          <t-col :span="3">
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: 600; color: #e37318;">{{ stats.indirectReferrals }}</div>
              <div style="font-size: 14px; color: #666; margin-top: 4px;">é—´æ¥æ¨è</div>
            </div>
          </t-col>
          <t-col :span="3">
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: 600; color: #0052d9;">{{ stats.maxDepth }}</div>
              <div style="font-size: 14px; color: #666; margin-top: 4px;">æœ€å¤§å±‚çº§</div>
            </div>
          </t-col>
        </t-row>
      </div>
          </div>
        </t-content>
      </t-layout>
    </t-layout>
  </div>

  <script src="../../assets/libs/vue.global.js"></script>
  <script src="../../assets/libs/tdesign.min.js"></script>
  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/admin-api.js"></script>

  <script>
    const { createApp, ref, computed } = Vue;

    // æ ‘èŠ‚ç‚¹ç»„ä»¶
    const UserTreeNode = {
      name: 'UserTreeNode',
      props: {
        node: Object,
        direction: String,
        level: Number
      },
      template: `
        <div>
          <div class="user-node">
            <div class="user-info">
              <t-avatar :image="node.avatar" size="40px">{{ node.real_name?.[0] || node.nickname?.[0] || 'ç”¨' }}</t-avatar>
              <div>
                <div style="font-weight: 600; color: #333;">
                  {{ node.real_name || node.nickname || 'æœªå‘½åç”¨æˆ·' }}
                  <t-tag v-if="node.ambassador_level" size="small" theme="primary" style="margin-left: 8px;">
                    {{ getLevelName(node.ambassador_level) }}
                  </t-tag>
                </div>
                <div style="font-size: 12px; color: #999; margin-top: 4px;">
                  ID: {{ node.id }} | æ‰‹æœº: {{ node.phone || 'æœªç»‘å®š' }}
                </div>
              </div>
            </div>
            <div class="user-stats">
              <span>ç›´æ¨: <strong>{{ node.referral_count || 0 }}</strong></span>
              <span>æ€»æ¨: <strong>{{ node.total_referral_count || 0 }}</strong></span>
              <span>è®¢å•: <strong>{{ node.order_count || 0 }}</strong></span>
            </div>
          </div>
          
          <div v-if="node.children && node.children.length > 0" class="child-nodes">
            <user-tree-node 
              v-for="child in node.children" 
              :key="child.id"
              :node="child"
              :direction="direction"
              :level="level + 1"
            />
          </div>
        </div>
      `,
      methods: {
        getLevelName(level) {
          const levels = {
            0: 'æ™®é€šç”¨æˆ·',
            1: 'äº‘é›€',
            2: 'é’é¸¾',
            3: 'é¸¿é¹„'
          };
          return levels[level] || 'æœªçŸ¥';
        }
      }
    };

    const app = createApp({
      components: {
        UserTreeNode
      },
      setup() {
        // ç®¡ç†å‘˜ä¿¡æ¯
        const adminInfo = ref(null);
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const checkAuth = () => {
          adminInfo.value = AdminAPI.getCurrentAdmin();
          if (!adminInfo.value) {
            window.location.href = '../../login.html';
            return false;
          }
          return true;
        };
        
        // é€€å‡ºç™»å½•
        const handleLogout = () => {
          TDesign.DialogPlugin.confirm({
            header: 'ç¡®è®¤é€€å‡º',
            body: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
            onConfirm: () => {
              AdminAPI.logout();
            }
          });
        };
        
        // èœå•åˆ‡æ¢
        const handleMenuChange = (value) => {
          const routes = {
            'dashboard': '../../index.html',
            'user-list': '../user/list.html',
            'user-referee': '../user/referee.html',
            'user-referee-logs': '../user/referee-logs.html',
            'order-list': '../order/list.html',
            'order-refund': '../order/refund.html',
            'withdraw-audit': '../order/withdraw-audit.html',
            'course-list': '../course/list.html',
            'schedule-list': '../course/schedule.html',
            'appointment-list': '../course/appointment.html',
            'case-list': '../course/case.html',
            'material-list': '../course/material.html',
            'ambassador-list': '../ambassador/list.html',
            'application-audit': '../ambassador/application-audit.html',
            'activity-list': '../ambassador/activity.html',
            'contract-list': '../ambassador/contract.html',
            'admin-list': '../system/admin.html',
            'config': '../system/config.html',
            'announcement-list': '../system/announcement.html',
            'feedback-list': '../system/feedback.html',
            'notification-list': '../system/notification.html',
            'level-config': '../system/level-config.html',
          };
          
          if (routes[value]) {
            window.location.href = routes[value];
          }
        };
        
        const searchQuery = ref('');
        const loading = ref(false);
        const treeData = ref(null);
        const treeDirection = ref('down'); // 'down' å‘ä¸‹æŸ¥çœ‹æ¨èçš„äºº, 'up' å‘ä¸ŠæŸ¥çœ‹æ¨èäºº
        
        const directionOptions = [
          { label: 'å‘ä¸‹æŸ¥çœ‹ï¼ˆæŸ¥çœ‹æ¨èçš„ç”¨æˆ·ï¼‰', value: 'down' },
          { label: 'å‘ä¸ŠæŸ¥çœ‹ï¼ˆæŸ¥çœ‹æ¨èäººé“¾ï¼‰', value: 'up' }
        ];

        const stats = computed(() => {
          if (!treeData.value) return null;
          
          let totalUsers = 0;
          let directReferrals = 0;
          let indirectReferrals = 0;
          let maxDepth = 0;

          const traverse = (node, depth = 0) => {
            totalUsers++;
            maxDepth = Math.max(maxDepth, depth);
            
            if (depth === 1) {
              directReferrals++;
            } else if (depth > 1) {
              indirectReferrals++;
            }

            if (node.children) {
              node.children.forEach(child => traverse(child, depth + 1));
            }
          };

          traverse(treeData.value);

          return {
            totalUsers,
            directReferrals,
            indirectReferrals,
            maxDepth
          };
        });

        const handleSearch = async () => {
          if (!searchQuery.value.trim()) {
            TDesign.MessagePlugin.warning('è¯·è¾“å…¥ç”¨æˆ·IDæˆ–æ‰‹æœºå·');
            return;
          }

          loading.value = true;

          try {
            const data = await AdminAPI.getReferralTree(
              searchQuery.value.trim(),
              treeDirection.value
            );
            
            treeData.value = data;
            
            if (!data) {
              TDesign.MessagePlugin.warning('æœªæ‰¾åˆ°ç›¸å…³ç”¨æˆ·');
            }
          } catch (error) {
            TDesign.MessagePlugin.error(error.message || 'æŸ¥è¯¢å¤±è´¥');
            treeData.value = null;
          } finally {
            loading.value = false;
          }
        };

        const handleReset = () => {
          searchQuery.value = '';
          treeData.value = null;
          treeDirection.value = 'down';
        };

        const handleDirectionChange = () => {
          if (treeData.value) {
            handleSearch();
          }
        };

        const handleExpand = (nodeId) => {
          // å±•å¼€/æŠ˜å èŠ‚ç‚¹é€»è¾‘ï¼ˆå¦‚æœéœ€è¦æ‡’åŠ è½½ï¼‰
          console.log('Expand node:', nodeId);
        };

        // é¡µé¢åˆå§‹åŒ–
        checkAuth();
        
        return {
          adminInfo,
          handleLogout,
          handleMenuChange,
          searchQuery,
          loading,
          treeData,
          treeDirection,
          directionOptions,
          stats,
          handleSearch,
          handleReset,
          handleDirectionChange,
          handleExpand
        };
      }
    });

    app.use(TDesign);
    app.mount('#app');
  </script>
</body>
</html>

