<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€šçŸ¥ç®¡ç† - å¤©é“æ–‡åŒ–åå°</title>
  
  <link rel="stylesheet" href="../../assets/libs/tdesign.min.css">
  <link rel="stylesheet" href="../../assets/css/tokens.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    .t-layout {
      height: 100vh;
    }
    
    .t-layout__sider {
      background: #fff;
      border-right: 1px solid #dcdcdc;
      width: 240px !important;
      flex-shrink: 0;
    }
    
    .page-content {
      padding: 24px;
      overflow-y: auto;
      background: #f5f5f5;
    }
    
    .page-header {
      margin-bottom: 24px;
    }
    
    .page-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .search-form {
      background: white;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .table-card {
      background: white;
      border-radius: 8px;
      padding: 24px;
    }
    
    .toolbar {
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>
  <div id="app">
    <t-layout style="height: 100vh;">
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <t-header height="64px" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
        background: #fff;
        border-bottom: 1px solid #dcdcdc;
      ">
        <div style="display: flex; align-items: center; gap: 16px;">
          <span style="font-size: 18px; font-weight: 600; color: #333;">ğŸ¨ å¤©é“æ–‡åŒ–åå°ç®¡ç†</span>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span>{{ adminInfo?.real_name || adminInfo?.username || 'ç®¡ç†å‘˜' }}</span>
          <t-button size="small" @click="handleLogout">é€€å‡º</t-button>
        </div>
      </t-header>
      
      <t-layout>
        <!-- ä¾§è¾¹èœå• -->
        <t-aside width="240px" style="
          background: #fff;
          border-right: 1px solid #dcdcdc;
          overflow-y: auto;
        ">
          <t-menu
            value="notification-list"
            :default-expanded="['user', 'order', 'course', 'ambassador', 'system']"
            theme="light"
            @change="handleMenuChange"
          >
            <t-menu-item value="dashboard">
              <template #icon><t-icon name="dashboard" /></template>
              æ•°æ®æ¦‚è§ˆ
            </t-menu-item>
            
            <t-submenu value="user">
              <template #icon><t-icon name="user" /></template>
              <template #title>ç”¨æˆ·ç®¡ç†</template>
              <t-menu-item value="user-list">å­¦å‘˜åˆ—è¡¨</t-menu-item>
              <t-menu-item value="user-referee">æ¨èäººç®¡ç†</t-menu-item>
              <t-menu-item value="user-referee-logs">æ¨èäººå˜æ›´è®°å½•</t-menu-item>
            </t-submenu>
            
            <t-submenu value="order">
              <template #icon><t-icon name="order" /></template>
              <template #title>è®¢å•ç®¡ç†</template>
              <t-menu-item value="order-list">è®¢å•åˆ—è¡¨</t-menu-item>
              <t-menu-item value="order-refund">é€€æ¬¾ç®¡ç†</t-menu-item>
              <t-menu-item value="withdraw-audit">æç°å®¡æ ¸</t-menu-item>
            </t-submenu>
            
            <t-submenu value="course">
              <template #icon><t-icon name="file" /></template>
              <template #title>è¯¾ç¨‹ç®¡ç†</template>
              <t-menu-item value="course-list">è¯¾ç¨‹åˆ—è¡¨</t-menu-item>
              <t-menu-item value="schedule-list">æ’æœŸç®¡ç†</t-menu-item>
              <t-menu-item value="appointment-list">é¢„çº¦ç®¡ç†</t-menu-item>
              <t-menu-item value="case-list">æ¡ˆä¾‹ç®¡ç†</t-menu-item>
              <t-menu-item value="material-list">èµ„æ–™ç®¡ç†</t-menu-item>
              <t-menu-item value="academy-content">å­¦é™¢å†…å®¹</t-menu-item>
            </t-submenu>
            
            <t-submenu value="ambassador">
              <template #icon><t-icon name="usergroup" /></template>
              <template #title>å¤§ä½¿ç®¡ç†</template>
              <t-menu-item value="ambassador-list">å¤§ä½¿åˆ—è¡¨</t-menu-item>
              <t-menu-item value="application-audit">ç”³è¯·å®¡æ ¸</t-menu-item>
              <t-menu-item value="activity-list">æ´»åŠ¨ç®¡ç†</t-menu-item>
              <t-menu-item value="contract-list">åˆçº¦ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="system">
              <template #icon><t-icon name="setting" /></template>
              <template #title>ç³»ç»Ÿç®¡ç†</template>
              <t-menu-item value="admin-list">ç®¡ç†å‘˜ç®¡ç†</t-menu-item>
              <t-menu-item value="config">ç³»ç»Ÿé…ç½®</t-menu-item>
              <t-menu-item value="announcement-list">å…¬å‘Šç®¡ç†</t-menu-item>
              <t-menu-item value="feedback-list">åé¦ˆç®¡ç†</t-menu-item>
              <t-menu-item value="notification-list">é€šçŸ¥ç®¡ç†</t-menu-item>
              <t-menu-item value="level-config">ç­‰çº§é…ç½®</t-menu-item>
            </t-submenu>
          </t-menu>
        </t-aside>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <t-content class="page-content">
          <!-- é¡µé¢å¤´éƒ¨ -->
          <div class="page-header">
            <h1 class="page-title">é€šçŸ¥ç®¡ç†</h1>
          </div>
          
          <!-- æ ‡ç­¾é¡µ -->
          <t-tabs v-model="activeTab" @change="handleTabChange">
            <t-tab-panel value="send" label="å‘é€é€šçŸ¥"></t-tab-panel>
            <t-tab-panel value="config" label="é€šçŸ¥é…ç½®"></t-tab-panel>
            <t-tab-panel value="logs" label="é€šçŸ¥æ—¥å¿—"></t-tab-panel>
          </t-tabs>
          
          <!-- å‘é€é€šçŸ¥ -->
          <div class="table-card" v-if="activeTab === 'send'">
            <div class="toolbar">
              <t-space>
                <t-button theme="success" @click="handleSendNotification">
                  <template #icon><t-icon name="mail" /></template>
                  å‘é€é€šçŸ¥
                </t-button>
              </t-space>
            </div>
            
            <t-table
              :data="notificationList"
              :columns="notificationColumns"
              :loading="loading"
              :pagination="pagination"
              @page-change="handlePageChange"
              row-key="id"
            >
              <template #type="{ row }">
                <t-tag v-if="row.type === 'system'" theme="primary">ç³»ç»Ÿ</t-tag>
                <t-tag v-else-if="row.type === 'order'" theme="success">è®¢å•</t-tag>
                <t-tag v-else theme="warning">æ´»åŠ¨</t-tag>
              </template>
            </t-table>
          </div>
          
          <!-- é€šçŸ¥é…ç½® -->
          <div class="table-card" v-if="activeTab === 'config'">
            <div class="toolbar">
              <t-space>
                <t-button theme="primary" @click="handleAddConfig">
                  <template #icon><t-icon name="add" /></template>
                  æ–°å¢é…ç½®
                </t-button>
              </t-space>
            </div>
            
            <t-table
              :data="configList"
              :columns="configColumns"
              :loading="loading"
              :pagination="configPagination"
              @page-change="handleConfigPageChange"
              row-key="id"
            >
              <template #trigger_type="{ row }">
                <t-tag v-if="row.trigger_type === 'before_class'" theme="primary">ä¸Šè¯¾å‰</t-tag>
                <t-tag v-else-if="row.trigger_type === 'after_pay'" theme="success">æ”¯ä»˜å</t-tag>
                <t-tag v-else theme="warning">å…¶ä»–</t-tag>
              </template>
              
              <template #operation="{ row }">
                <t-space>
                  <t-button size="small" variant="text" theme="primary" @click="handleEditConfig(row)">ç¼–è¾‘</t-button>
                  <t-button size="small" variant="text" theme="danger" @click="handleDeleteConfig(row)">åˆ é™¤</t-button>
                </t-space>
              </template>
            </t-table>
          </div>
          
          <!-- é€šçŸ¥æ—¥å¿— -->
          <div class="table-card" v-if="activeTab === 'logs'">
            <div class="search-form">
              <t-form layout="inline">
                <t-form-item label="å¼€å§‹æ—¥æœŸ">
                  <t-date-picker v-model="logFilters.start_date" clearable style="width: 200px;"></t-date-picker>
                </t-form-item>
                <t-form-item label="ç»“æŸæ—¥æœŸ">
                  <t-date-picker v-model="logFilters.end_date" clearable style="width: 200px;"></t-date-picker>
                </t-form-item>
                <t-form-item>
                  <t-space>
                    <t-button theme="primary" @click="handleSearchLogs">æŸ¥è¯¢</t-button>
                    <t-button theme="default" @click="handleResetLogs">é‡ç½®</t-button>
                  </t-space>
                </t-form-item>
              </t-form>
            </div>
            
            <t-table
              :data="logList"
              :columns="logColumns"
              :loading="loading"
              :pagination="logPagination"
              @page-change="handleLogPageChange"
              row-key="id"
            >
              <template #send_status="{ row }">
                <t-tag v-if="row.send_status === 1" theme="success">æˆåŠŸ</t-tag>
                <t-tag v-else theme="danger">å¤±è´¥</t-tag>
              </template>
            </t-table>
          </div>
        </t-content>
      </t-layout>
    </t-layout>
    
    <!-- å‘é€é€šçŸ¥å¯¹è¯æ¡† -->
    <t-dialog
      v-model:visible="sendDialogVisible"
      header="å‘é€é€šçŸ¥"
      width="600px"
      @confirm="handleConfirmSend"
    >
      <t-form :data="sendForm" label-width="100px">
        <t-form-item label="æ¥æ”¶å¯¹è±¡">
          <t-select v-model="sendForm.target" :options="targetOptions" />
        </t-form-item>
        <t-form-item label="é€šçŸ¥ç±»å‹">
          <t-select v-model="sendForm.type" :options="typeOptions" />
        </t-form-item>
        <t-form-item label="é€šçŸ¥æ ‡é¢˜">
          <t-input v-model="sendForm.title" placeholder="è¯·è¾“å…¥é€šçŸ¥æ ‡é¢˜" />
        </t-form-item>
        <t-form-item label="é€šçŸ¥å†…å®¹">
          <t-textarea v-model="sendForm.content" :autosize="{ minRows: 6 }" placeholder="è¯·è¾“å…¥é€šçŸ¥å†…å®¹" />
        </t-form-item>
      </t-form>
    </t-dialog>
    
    <!-- é…ç½®å¯¹è¯æ¡† -->
    <t-dialog
      v-model:visible="configDialogVisible"
      :header="configMode === 'add' ? 'æ–°å¢é…ç½®' : 'ç¼–è¾‘é…ç½®'"
      width="600px"
      @confirm="handleConfirmConfig"
    >
      <t-form :data="configForm" label-width="100px">
        <t-form-item label="è¯¾ç¨‹">
          <t-select v-model="configForm.course_id" :options="courseOptions" placeholder="é€‰æ‹©è¯¾ç¨‹" />
        </t-form-item>
        <t-form-item label="è§¦å‘ç±»å‹">
          <t-select v-model="configForm.trigger_type" :options="triggerOptions" placeholder="é€‰æ‹©è§¦å‘ç±»å‹" />
        </t-form-item>
        <t-form-item label="æ¨¡æ¿ID">
          <t-input v-model="configForm.template_id" placeholder="è¯·è¾“å…¥æ¨¡æ¿ID" />
        </t-form-item>
        <t-form-item label="æå‰å¤©æ•°">
          <t-input-number v-model="configForm.advance_days" :min="0" :max="30" style="width: 100%;" />
        </t-form-item>
      </t-form>
    </t-dialog>
  </div>

  <script src="../../assets/libs/vue.global.js"></script>
  <script src="../../assets/libs/tdesign.min.js"></script>
  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/admin-api.js"></script>
  
  <script>
    const { createApp, ref, onMounted } = Vue;
    
    const app = createApp({
      setup() {
        // ç®¡ç†å‘˜ä¿¡æ¯
        const adminInfo = ref(null);
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const checkAuth = () => {
          adminInfo.value = AdminAPI.getCurrentAdmin();
          if (!adminInfo.value) {
            window.location.href = '../../login.html';
            return false;
          }
          return true;
        };
        
        // é€€å‡ºç™»å½•
        const handleLogout = () => {
          TDesign.DialogPlugin.confirm({
            header: 'ç¡®è®¤é€€å‡º',
            body: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
            onConfirm: () => {
              AdminAPI.logout();
            }
          });
        };
        
        // èœå•åˆ‡æ¢
        const handleMenuChange = (value) => {
          const routes = {
            'dashboard': '../../index.html',
            'user-list': '../user/list.html',
            'user-referee': '../user/referee.html',
            'user-referee-logs': '../user/referee-logs.html',
            'order-list': '../order/list.html',
            'order-refund': '../order/refund.html',
            'withdraw-audit': '../order/withdraw-audit.html',
            'course-list': '../course/list.html',
            'schedule-list': '../course/schedule.html',
            'appointment-list': '../course/appointment.html',
            'case-list': '../course/case.html',
            'material-list': '../course/material.html',
            'academy-content': '../course/academy.html',
            'ambassador-list': '../ambassador/list.html',
            'application-audit': '../ambassador/application-audit.html',
            'activity-list': '../ambassador/activity.html',
            'contract-list': '../ambassador/contract.html',
            'admin-list': '../system/admin.html',
            'config': '../system/config.html',
            'announcement-list': '../system/announcement.html',
            'feedback-list': '../system/feedback.html',
            'notification-list': '../system/notification.html',
            'level-config': '../system/level-config.html',
          };
          
          if (routes[value]) {
            window.location.href = routes[value];
          }
        };
        
        const loading = ref(false);
        const activeTab = ref('send');
        
        // å‘é€é€šçŸ¥
        const notificationList = ref([]);
        const pagination = ref({ current: 1, pageSize: 20, total: 0 });
        const sendDialogVisible = ref(false);
        const sendForm = ref({ target: 'all', type: 'system', title: '', content: '' });
        
        const targetOptions = [
          { label: 'å…¨éƒ¨ç”¨æˆ·', value: 'all' },
          { label: 'å…¨éƒ¨å¤§ä½¿', value: 'ambassadors' },
          { label: 'æŒ‡å®šç”¨æˆ·', value: 'users' }
        ];
        
        const typeOptions = [
          { label: 'ç³»ç»Ÿé€šçŸ¥', value: 'system' },
          { label: 'è®¢å•é€šçŸ¥', value: 'order' },
          { label: 'æ´»åŠ¨é€šçŸ¥', value: 'activity' }
        ];
        
        const notificationColumns = [
          { colKey: 'title', title: 'é€šçŸ¥æ ‡é¢˜', width: 250 },
          { colKey: 'type', title: 'ç±»å‹', width: 100 },
          { colKey: 'target_count', title: 'æ¥æ”¶äººæ•°', width: 100 },
          { colKey: 'created_at', title: 'å‘é€æ—¶é—´', width: 160 }
        ];
        
        // é€šçŸ¥é…ç½®
        const configList = ref([]);
        const configPagination = ref({ current: 1, pageSize: 20, total: 0 });
        const configDialogVisible = ref(false);
        const configMode = ref('add');
        const configForm = ref({ course_id: null, trigger_type: '', template_id: '', advance_days: 1 });
        const courseOptions = ref([]);
        
        const triggerOptions = [
          { label: 'ä¸Šè¯¾å‰æé†’', value: 'before_class' },
          { label: 'æ”¯ä»˜æˆåŠŸå', value: 'after_pay' },
          { label: 'é¢„çº¦æˆåŠŸå', value: 'after_appointment' }
        ];
        
        const configColumns = [
          { colKey: 'id', title: 'ID', width: 80 },
          { colKey: 'course_name', title: 'è¯¾ç¨‹åç§°', width: 200 },
          { colKey: 'trigger_type', title: 'è§¦å‘ç±»å‹', width: 120 },
          { colKey: 'template_id', title: 'æ¨¡æ¿ID', width: 150 },
          { colKey: 'advance_days', title: 'æå‰å¤©æ•°', width: 100 },
          { colKey: 'operation', title: 'æ“ä½œ', width: 150, fixed: 'right' }
        ];
        
        // é€šçŸ¥æ—¥å¿—
        const logList = ref([]);
        const logPagination = ref({ current: 1, pageSize: 20, total: 0 });
        const logFilters = ref({ start_date: '', end_date: '' });
        
        const logColumns = [
          { colKey: 'id', title: 'ID', width: 80 },
          { colKey: 'user_name', title: 'æ¥æ”¶ç”¨æˆ·', width: 120 },
          { colKey: 'notification_title', title: 'é€šçŸ¥æ ‡é¢˜', width: 250 },
          { colKey: 'send_status', title: 'å‘é€çŠ¶æ€', width: 100 },
          { colKey: 'send_time', title: 'å‘é€æ—¶é—´', width: 160 }
        ];
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        const handleTabChange = (value) => {
          activeTab.value = value;
          if (value === 'send') {
            loadNotificationList();
          } else if (value === 'config') {
            loadConfigList();
          } else if (value === 'logs') {
            loadLogList();
          }
        };
        
        // åŠ è½½é€šçŸ¥åˆ—è¡¨
        const loadNotificationList = async () => {
          loading.value = true;
          try {
            const result = await AdminAPI.getNotificationList({
              page: pagination.value.current,
              pageSize: pagination.value.pageSize
            });
            notificationList.value = result.list || [];
            pagination.value.total = result.total || 0;
          } catch (error) {
            TDesign.MessagePlugin.error('åŠ è½½å¤±è´¥: ' + error.message);
          } finally {
            loading.value = false;
          }
        };
        
        // åŠ è½½é…ç½®åˆ—è¡¨
        const loadConfigList = async () => {
          loading.value = true;
          try {
            const result = await AdminAPI.getNotificationConfigList({
              page: configPagination.value.current,
              pageSize: configPagination.value.pageSize
            });
            configList.value = result.list || [];
            configPagination.value.total = result.total || 0;
          } catch (error) {
            TDesign.MessagePlugin.error('åŠ è½½å¤±è´¥: ' + error.message);
          } finally {
            loading.value = false;
          }
        };
        
        // åŠ è½½æ—¥å¿—åˆ—è¡¨
        const loadLogList = async () => {
          loading.value = true;
          try {
            const result = await AdminAPI.getNotificationLogs({
              page: logPagination.value.current,
              pageSize: logPagination.value.pageSize,
              ...logFilters.value
            });
            logList.value = result.list || [];
            logPagination.value.total = result.total || 0;
          } catch (error) {
            TDesign.MessagePlugin.error('åŠ è½½å¤±è´¥: ' + error.message);
          } finally {
            loading.value = false;
          }
        };
        
        // åŠ è½½è¯¾ç¨‹åˆ—è¡¨
        const loadCourses = async () => {
          try {
            const data = await AdminAPI.getAllCourses();
            courseOptions.value = data.map(c => ({ label: c.name, value: c.id }));
          } catch (error) {
            console.error('åŠ è½½è¯¾ç¨‹åˆ—è¡¨å¤±è´¥:', error);
          }
        };
        
        // å‘é€é€šçŸ¥
        const handleSendNotification = () => {
          sendForm.value = { target: 'all', type: 'system', title: '', content: '' };
          sendDialogVisible.value = true;
        };
        
        const handleConfirmSend = async () => {
          try {
            await AdminAPI.sendNotification(sendForm.value);
            TDesign.MessagePlugin.success('å‘é€æˆåŠŸ');
            sendDialogVisible.value = false;
            loadNotificationList();
          } catch (error) {
            TDesign.MessagePlugin.error('å‘é€å¤±è´¥: ' + error.message);
          }
        };
        
        // é…ç½®ç®¡ç†
        const handleAddConfig = () => {
          configMode.value = 'add';
          configForm.value = { course_id: null, trigger_type: '', template_id: '', advance_days: 1 };
          configDialogVisible.value = true;
        };
        
        const handleEditConfig = (row) => {
          configMode.value = 'edit';
          configForm.value = { ...row };
          configDialogVisible.value = true;
        };
        
        const handleConfirmConfig = async () => {
          try {
            if (configMode.value === 'add') {
              await AdminAPI.createNotificationConfig(configForm.value);
            } else {
              await AdminAPI.updateNotificationConfig(configForm.value);
            }
            TDesign.MessagePlugin.success('ä¿å­˜æˆåŠŸ');
            configDialogVisible.value = false;
            loadConfigList();
          } catch (error) {
            TDesign.MessagePlugin.error('ä¿å­˜å¤±è´¥: ' + error.message);
          }
        };
        
        const handleDeleteConfig = async (row) => {
          const confirmed = await TDesign.DialogPlugin.confirm({
            header: 'ç¡®è®¤åˆ é™¤',
            body: 'ç¡®å®šè¦åˆ é™¤æ­¤é…ç½®å—ï¼Ÿ',
            theme: 'warning'
          });
          
          if (!confirmed) return;
          
          try {
            await AdminAPI.deleteNotificationConfig({ id: row.id });
            TDesign.MessagePlugin.success('åˆ é™¤æˆåŠŸ');
            loadConfigList();
          } catch (error) {
            TDesign.MessagePlugin.error('åˆ é™¤å¤±è´¥: ' + error.message);
          }
        };
        
        // æ—¥å¿—æŸ¥è¯¢
        const handleSearchLogs = () => {
          logPagination.value.current = 1;
          loadLogList();
        };
        
        const handleResetLogs = () => {
          logFilters.value = { start_date: '', end_date: '' };
          handleSearchLogs();
        };
        
        // åˆ†é¡µ
        const handlePageChange = (pageInfo) => {
          pagination.value.current = pageInfo.current;
          pagination.value.pageSize = pageInfo.pageSize;
          loadNotificationList();
        };
        
        const handleConfigPageChange = (pageInfo) => {
          configPagination.value.current = pageInfo.current;
          configPagination.value.pageSize = pageInfo.pageSize;
          loadConfigList();
        };
        
        const handleLogPageChange = (pageInfo) => {
          logPagination.value.current = pageInfo.current;
          logPagination.value.pageSize = pageInfo.pageSize;
          loadLogList();
        };
        
        onMounted(() => {
          if (checkAuth()) {
            loadNotificationList();
            loadCourses();
          }
        });
        
        return {
          adminInfo,
          handleLogout,
          handleMenuChange,
          loading,
          activeTab,
          notificationList,
          pagination,
          sendDialogVisible,
          sendForm,
          targetOptions,
          typeOptions,
          notificationColumns,
          configList,
          configPagination,
          configDialogVisible,
          configMode,
          configForm,
          courseOptions,
          triggerOptions,
          configColumns,
          logList,
          logPagination,
          logFilters,
          logColumns,
          handleTabChange,
          handleSendNotification,
          handleConfirmSend,
          handleAddConfig,
          handleEditConfig,
          handleConfirmConfig,
          handleDeleteConfig,
          handleSearchLogs,
          handleResetLogs,
          handlePageChange,
          handleConfigPageChange,
          handleLogPageChange,
        };
      }
    });
    
    app.use(TDesign);
    app.mount('#app');
  </script>
</body>
</html>

