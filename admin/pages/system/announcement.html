<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å…¬å‘Šç®¡ç†</title>
  <link rel="stylesheet" href="../../assets/libs/tdesign.min.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .c {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 24px;
    }
    
    /* TDesign å¸ƒå±€æ ·å¼ - å¿…éœ€ï¼*/
    .t-layout {
      height: 100vh;
    }
    
    .t-layout__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      background: #fff;
      border-bottom: 1px solid #dcdcdc;
    }
    
    .t-layout__sider {
      background: #fff;
      border-right: 1px solid #dcdcdc;
      width: 240px !important;
      flex-shrink: 0;
    }
    
    .t-layout__content {
      padding: 24px;
      overflow-y: auto;
      background: #f5f5f5;
    }

    /* äº‘å­˜å‚¨ä¸Šä¼ ç»„ä»¶æ ·å¼ */
    .upload-container {
      margin-bottom: 16px;
    }

    .upload-placeholder {
      width: 200px;
      height: 200px;
      border: 2px dashed #dcdcdc;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .upload-placeholder:hover {
      border-color: #0052d9;
      background: #f3f3f3;
    }

    .upload-placeholder i {
      font-size: 32px;
      color: #999;
      margin-bottom: 8px;
    }

    .upload-placeholder p {
      margin: 0;
      color: #999;
      font-size: 14px;
    }

    .image-preview {
      position: relative;
      width: 200px;
    }

    .image-preview img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #dcdcdc;
    }

    .image-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    .upload-tips {
      margin-top: 8px;
      font-size: 12px;
      color: #999;
    }
  </style>
</head>
<body>
  <div id="app">
    <t-layout style="height: 100vh;">
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <t-header height="64px" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
        background: #fff;
        border-bottom: 1px solid #dcdcdc;
      ">
        <div style="display: flex; align-items: center; gap: 16px;">
          <span style="font-size: 18px; font-weight: 600; color: #333;">ğŸ¨ å¤©é“æ–‡åŒ–åå°ç®¡ç†</span>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span>{{ adminInfo?.real_name || adminInfo?.username || 'ç®¡ç†å‘˜' }}</span>
          <t-button size="small" @click="handleLogout">é€€å‡º</t-button>
        </div>
      </t-header>
      
      <t-layout>
        <!-- ä¾§è¾¹èœå• -->
        <t-aside width="240px" style="
          background: #fff;
          border-right: 1px solid #dcdcdc;
          overflow-y: auto;
        ">
          <t-menu
            value="announcement-list"
            :default-expanded="['user', 'order', 'course', 'ambassador', 'system']"
            theme="light"
            @change="handleMenuChange"
          >
            <t-menu-item value="dashboard">
              <template #icon><t-icon name="dashboard" /></template>
              æ•°æ®æ¦‚è§ˆ
            </t-menu-item>
            
            <t-submenu value="user">
              <template #icon><t-icon name="user" /></template>
              <template #title>ç”¨æˆ·ç®¡ç†</template>
              <t-menu-item value="user-list">å­¦å‘˜åˆ—è¡¨</t-menu-item>
              <t-menu-item value="user-referee">æ¨èäººç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="order">
              <template #icon><t-icon name="order" /></template>
              <template #title>è®¢å•ç®¡ç†</template>
              <t-menu-item value="order-list">è®¢å•åˆ—è¡¨</t-menu-item>
              <t-menu-item value="order-refund">é€€æ¬¾ç®¡ç†</t-menu-item>
              <t-menu-item value="withdraw-audit">æç°å®¡æ ¸</t-menu-item>
            </t-submenu>
            
            <t-submenu value="course">
              <template #icon><t-icon name="file" /></template>
              <template #title>è¯¾ç¨‹ç®¡ç†</template>
              <t-menu-item value="course-list">è¯¾ç¨‹åˆ—è¡¨</t-menu-item>
              <t-menu-item value="schedule-list">æ’æœŸç®¡ç†</t-menu-item>
              <t-menu-item value="appointment-list">é¢„çº¦ç®¡ç†</t-menu-item>
              <t-menu-item value="case-list">æ¡ˆä¾‹ç®¡ç†</t-menu-item>
              <t-menu-item value="material-list">èµ„æ–™ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="ambassador">
              <template #icon><t-icon name="usergroup" /></template>
              <template #title>å¤§ä½¿ç®¡ç†</template>
              <t-menu-item value="ambassador-list">å¤§ä½¿åˆ—è¡¨</t-menu-item>
              <t-menu-item value="application-audit">ç”³è¯·å®¡æ ¸</t-menu-item>
              <t-menu-item value="activity-list">æ´»åŠ¨ç®¡ç†</t-menu-item>
              <t-menu-item value="contract-list">åˆçº¦ç®¡ç†</t-menu-item>
            </t-submenu>
            
            <t-submenu value="system">
              <template #icon><t-icon name="setting" /></template>
              <template #title>ç³»ç»Ÿç®¡ç†</template>
              <t-menu-item value="admin-list">ç®¡ç†å‘˜ç®¡ç†</t-menu-item>
              <t-menu-item value="config">ç³»ç»Ÿé…ç½®</t-menu-item>
              <t-menu-item value="announcement-list">å…¬å‘Šç®¡ç†</t-menu-item>
              <t-menu-item value="feedback-list">åé¦ˆç®¡ç†</t-menu-item>
              <t-menu-item value="notification-list">é€šçŸ¥ç®¡ç†</t-menu-item>
              <t-menu-item value="level-config">ç­‰çº§é…ç½®</t-menu-item>
            </t-submenu>
          </t-menu>
        </t-aside>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <t-content class="page-content">
          <div class="c">
            <h1 style="font-size:20px;font-weight:600;margin-bottom:24px;">å…¬å‘Šç®¡ç†</h1>
            
            <!-- æŸ¥è¯¢è¡¨å• -->
            <div style="display:flex;gap:12px;margin-bottom:20px;">
              <t-input v-model="keyword" placeholder="å…¬å‘Šæ ‡é¢˜" clearable style="width:200px;"/>
              <t-button theme="primary" @click="loadData">æŸ¥è¯¢</t-button>
              <t-button @click="resetSearch">é‡ç½®</t-button>
              <t-button theme="success" @click="handleAdd">å‘å¸ƒå…¬å‘Š</t-button>
            </div>
            
            <!-- æ•°æ®è¡¨æ ¼ -->
            <t-table 
              :data="dataList" 
              :columns="columns" 
              :loading="loading" 
              :pagination="pagination" 
              @page-change="handlePageChange" 
              bordered 
              stripe
            >
              <template #type="{row}">
                <t-tag v-if="row.category==='system'" theme="primary">ç³»ç»Ÿ</t-tag>
                <t-tag v-else-if="row.category==='activity'" theme="success">æ´»åŠ¨</t-tag>
                <t-tag v-else-if="row.category==='banner'" theme="warning">è½®æ’­å›¾</t-tag>
                <t-tag v-else>é€šçŸ¥</t-tag>
              </template>
              
              <template #status="{row}">
                <t-tag v-if="row.status===1" theme="success">æ˜¾ç¤º</t-tag>
                <t-tag v-else>éšè—</t-tag>
              </template>
              
              <template #op="{row}">
                <t-space>
                  <t-button size="small" variant="text" @click="handleEdit(row)">ç¼–è¾‘</t-button>
                  <t-button size="small" variant="text" theme="danger" @click="handleDelete(row)">åˆ é™¤</t-button>
                </t-space>
              </template>
            </t-table>
          </div>
          
          <!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
          <t-dialog 
            v-model:visible="dialogVisible" 
            :header="dialogMode==='add'?'å‘å¸ƒå…¬å‘Š':'ç¼–è¾‘å…¬å‘Š'" 
            width="700px" 
            @confirm="handleSave"
            @close="handleDialogClose"
          >
            <t-form :data="formData" label-width="100px">
              <t-form-item label="å…¬å‘Šæ ‡é¢˜" required>
                <t-input v-model="formData.title" placeholder="è¯·è¾“å…¥å…¬å‘Šæ ‡é¢˜"/>
              </t-form-item>
              
              <t-form-item label="å…¬å‘Šç±»å‹" required>
                <t-select v-model="formData.category" :options="typeOptions"/>
              </t-form-item>
              
              <!-- ğŸ”¥ äº‘å­˜å‚¨ä¸Šä¼ ç»„ä»¶ -->
              <t-form-item label="å°é¢å›¾ç‰‡">
                <div class="upload-container">
                  <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                  <input 
                    type="file" 
                    ref="fileInput" 
                    accept="image/*"
                    @change="handleFileChange"
                    style="display: none;"
                  >
                  
                  <!-- æœªä¸Šä¼ æ—¶æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ -->
                  <div v-if="!formData.coverImageURL" class="upload-placeholder" @click="triggerUpload">
                    <t-icon name="upload" />
                    <p>ç‚¹å‡»ä¸Šä¼ å°é¢</p>
                  </div>
                  
                  <!-- å·²ä¸Šä¼ æ—¶æ˜¾ç¤ºé¢„è§ˆ -->
                  <div v-else class="image-preview">
                    <img :src="formData.coverImageURL" alt="å°é¢é¢„è§ˆ">
                    <div class="image-actions">
                      <t-button size="small" variant="outline" @click="triggerUpload">
                        æ›´æ¢
                      </t-button>
                      <t-button size="small" theme="danger" variant="outline" @click="removeImage">
                        åˆ é™¤
                      </t-button>
                    </div>
                  </div>
                  
                  <div class="upload-tips">
                    å»ºè®®å°ºå¯¸ï¼š750x400ï¼Œæ”¯æŒ JPGã€PNGï¼Œä¸è¶…è¿‡ 5MB
                  </div>
                </div>
              </t-form-item>
              
              <t-form-item label="è·³è½¬é“¾æ¥">
                <t-input v-model="formData.link" placeholder="é€‰å¡«ï¼Œç”¨äºè½®æ’­å›¾è·³è½¬"/>
              </t-form-item>
              
              <t-form-item label="å…¬å‘Šå†…å®¹" required>
                <t-textarea 
                  v-model="formData.content" 
                  :autosize="{minRows:8}"
                  placeholder="è¯·è¾“å…¥å…¬å‘Šå†…å®¹"
                />
              </t-form-item>
              
              <t-form-item label="æ˜¾ç¤ºçŠ¶æ€">
                <t-radio-group v-model="formData.status">
                  <t-radio :value="1">æ˜¾ç¤º</t-radio>
                  <t-radio :value="0">éšè—</t-radio>
                </t-radio-group>
              </t-form-item>
            </t-form>
          </t-dialog>
        </t-content>
      </t-layout>
    </t-layout>
  </div>

  <!-- å¼•å…¥ä¾èµ– -->
  <script src="../../assets/libs/vue.global.js"></script>
  <script src="../../assets/libs/tdesign.min.js"></script>
  
  <!-- ğŸ”¥ å¼•å…¥äº‘å­˜å‚¨ç›¸å…³è„šæœ¬ï¼ˆä½¿ç”¨æœ¬åœ° SDKï¼‰ -->
  <script src="../../assets/libs/cloudbase.full.js"></script>
  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/cloudbase.js"></script>
  <script src="../../assets/js/cloud-storage-helper.js"></script>
  
  <script src="../../assets/js/admin-api.js"></script>
  <script src="../../assets/js/sidebar-navigation.js"></script>
  
  <script>
    const { createApp, ref, onMounted } = Vue;
    
    createApp({
      setup() {
        // å¼•å…¥ä¾§è¾¹æ å¯¼èˆªåŠŸèƒ½
        const { adminInfo, handleMenuChange, handleLogout } = SidebarNavigation.useSidebarNavigation();
        
        // æ•°æ®çŠ¶æ€
        const loading = ref(false);
        const dataList = ref([]);
        const dialogVisible = ref(false);
        const dialogMode = ref('add');
        const formData = ref({});
        const keyword = ref('');
        const pagination = ref({
          current: 1,
          pageSize: 20,
          total: 0
        });
        
        // ğŸ”¥ äº‘å­˜å‚¨ç›¸å…³çŠ¶æ€
        const fileInput = ref(null);
        const uploadLoading = ref(false);
        
        // é€‰é¡¹é…ç½®
        const typeOptions = [
          { label: 'ç³»ç»Ÿå…¬å‘Š', value: 'system' },
          { label: 'æ´»åŠ¨å…¬å‘Š', value: 'activity' },
          { label: 'è½®æ’­å›¾', value: 'banner' },
          { label: 'é€šçŸ¥', value: 'general' }
        ];
        
        // è¡¨æ ¼åˆ—é…ç½®
        const columns = [
          { colKey: 'title', title: 'å…¬å‘Šæ ‡é¢˜', width: 250 },
          { colKey: 'category', title: 'ç±»å‹', width: 100, cell: 'type' },
          { colKey: 'created_at', title: 'å‘å¸ƒæ—¶é—´', width: 160 },
          { colKey: 'status', title: 'çŠ¶æ€', width: 100, cell: 'status' },
          { colKey: 'op', title: 'æ“ä½œ', width: 150, cell: 'op' }
        ];
        
        // åŠ è½½æ•°æ®
        const loadData = async () => {
          loading.value = true;
          try {
            const data = await AdminAPI.getAnnouncementList({
              page: pagination.value.current,
              pageSize: pagination.value.pageSize,
              keyword: keyword.value
            });
            
            dataList.value = data.list;
            pagination.value.total = data.total;
          } catch (e) {
            TDesign.MessagePlugin.error(e.message);
          } finally {
            loading.value = false;
          }
        };
        
        // é‡ç½®æœç´¢
        const resetSearch = () => {
          keyword.value = '';
          loadData();
        };
        
        // åˆ†é¡µåˆ‡æ¢
        const handlePageChange = (pageInfo) => {
          pagination.value.current = pageInfo.current;
          pagination.value.pageSize = pageInfo.pageSize;
          loadData();
        };
        
        // æ–°å¢
        const handleAdd = () => {
          dialogMode.value = 'add';
          formData.value = {
            status: 1,
            category: 'system',
            title: '',
            content: '',
            link: '',
            cover_image: '',        // fileIDï¼ˆä¿å­˜åˆ°æ•°æ®åº“ï¼‰
            coverImageURL: ''       // ä¸´æ—¶ URLï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
          };
          dialogVisible.value = true;
        };
        
        // ç¼–è¾‘
        const handleEdit = async (row) => {
          dialogMode.value = 'edit';
          formData.value = {
            ...row,
            cover_image: row.cover_image || '',
            coverImageURL: ''
          };
          
          // ğŸ”¥ å¦‚æœæœ‰å°é¢å›¾ç‰‡ï¼Œè½¬æ¢ä¸ºä¸´æ—¶ URL
          if (row.cover_image) {
            try {
              const tempURL = await window.CloudStorageHelper.getSingleTempURL(row.cover_image);
              formData.value.coverImageURL = tempURL;
            } catch (error) {
              console.error('è·å–å°é¢ä¸´æ—¶URLå¤±è´¥:', error);
            }
          }
          
          dialogVisible.value = true;
        };
        
        // åˆ é™¤
        const handleDelete = async (row) => {
          const confirmed = await TDesign.DialogPlugin.confirm({
            header: 'ç¡®è®¤åˆ é™¤',
            body: 'ç¡®è®¤åˆ é™¤è¯¥å…¬å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚'
          });
          
          if (!confirmed) return;
          
          try {
            await AdminAPI.deleteAnnouncement(row.id);
            
            // ğŸ”¥ åˆ é™¤äº‘å­˜å‚¨æ–‡ä»¶
            if (row.cover_image) {
              try {
                await window.CloudStorageHelper.deleteFiles([row.cover_image]);
                console.log('âœ… å°é¢å›¾ç‰‡å·²åˆ é™¤');
              } catch (error) {
                console.warn('âš ï¸ å°é¢å›¾ç‰‡åˆ é™¤å¤±è´¥ï¼ˆä¸é˜»å¡ï¼‰:', error);
              }
            }
            
            TDesign.MessagePlugin.success('åˆ é™¤æˆåŠŸ');
            loadData();
          } catch (e) {
            TDesign.MessagePlugin.error(e.message);
          }
        };
        
        // ğŸ”¥ è§¦å‘æ–‡ä»¶é€‰æ‹©
        const triggerUpload = () => {
          fileInput.value?.click();
        };
        
        // ğŸ”¥ æ–‡ä»¶é€‰æ‹©å˜åŒ–
        const handleFileChange = async (event) => {
          const file = event.target.files[0];
          if (!file) return;
          
          // éªŒè¯æ–‡ä»¶
          const validation = window.CloudStorageHelper.validateFile(file, {
            acceptTypes: ['image/jpeg', 'image/png', 'image/jpg'],
            maxSize: 5 * 1024 * 1024  // 5MB
          });
          
          if (!validation.valid) {
            TDesign.MessagePlugin.warning(validation.error);
            return;
          }
          
          try {
            uploadLoading.value = true;
            TDesign.MessagePlugin.loading('ä¸Šä¼ ä¸­...', 0);
            
            // ğŸ”¥ ç”Ÿæˆäº‘å­˜å‚¨è·¯å¾„
            const cloudPath = window.CloudStorageHelper.generateCloudPath(
              'announcements/covers',
              formData.value.id || 'new',
              file.name
            );
            
            console.log('ğŸ“¤ ä¸Šä¼ è·¯å¾„:', cloudPath);
            
            // ğŸ”¥ åˆ é™¤æ—§æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
            if (formData.value.cover_image) {
              await window.CloudStorageHelper.deleteFiles([formData.value.cover_image]);
            }
            
            // ğŸ”¥ ä¸Šä¼ æ–°æ–‡ä»¶
            const result = await window.CloudStorageHelper.uploadSingleFile(file, cloudPath);
            
            // ğŸ”¥ ä¿å­˜ fileID å’Œä¸´æ—¶ URL
            formData.value.cover_image = result.fileID;
            formData.value.coverImageURL = result.tempFileURL;
            
            TDesign.MessagePlugin.closeAll();
            TDesign.MessagePlugin.success('ä¸Šä¼ æˆåŠŸ');
            
            // æ¸…ç©º input
            event.target.value = '';
          } catch (error) {
            console.error('ä¸Šä¼ å¤±è´¥:', error);
            TDesign.MessagePlugin.closeAll();
            TDesign.MessagePlugin.error('ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
          } finally {
            uploadLoading.value = false;
          }
        };
        
        // ğŸ”¥ åˆ é™¤å›¾ç‰‡
        const removeImage = async () => {
          try {
            // ğŸ”¥ åˆ é™¤äº‘å­˜å‚¨æ–‡ä»¶
            if (formData.value.cover_image) {
              await window.CloudStorageHelper.deleteFiles([formData.value.cover_image]);
            }
            
            // ğŸ”¥ æ¸…ç©ºæœ¬åœ°å¼•ç”¨
            formData.value.cover_image = '';
            formData.value.coverImageURL = '';
            
            TDesign.MessagePlugin.success('åˆ é™¤æˆåŠŸ');
          } catch (error) {
            console.error('åˆ é™¤å¤±è´¥:', error);
            TDesign.MessagePlugin.error('åˆ é™¤å¤±è´¥');
          }
        };
        
        // ä¿å­˜
        const handleSave = async () => {
          // éªŒè¯å¿…å¡«é¡¹
          if (!formData.value.title) {
            TDesign.MessagePlugin.warning('è¯·è¾“å…¥å…¬å‘Šæ ‡é¢˜');
            return false;
          }
          
          if (!formData.value.content) {
            TDesign.MessagePlugin.warning('è¯·è¾“å…¥å…¬å‘Šå†…å®¹');
            return false;
          }
          
          try {
            const submitData = {
              title: formData.value.title,
              category: formData.value.category,
              content: formData.value.content,
              link: formData.value.link || '',
              cover_image: formData.value.cover_image || '',  // ğŸ”¥ ä½¿ç”¨ fileID
              status: formData.value.status
            };
            
            if (dialogMode.value === 'add') {
              await AdminAPI.createAnnouncement(submitData);
            } else {
              submitData.id = formData.value.id;
              await AdminAPI.updateAnnouncement(submitData);
            }
            
            TDesign.MessagePlugin.success('ä¿å­˜æˆåŠŸ');
            dialogVisible.value = false;
            loadData();
          } catch (e) {
            TDesign.MessagePlugin.error(e.message);
            return false;
          }
        };
        
        // å¼¹çª—å…³é—­æ—¶æ¸…ç†
        const handleDialogClose = () => {
          formData.value = {};
        };
        
        // æŒ‚è½½æ—¶åŠ è½½æ•°æ®
        onMounted(() => {
          console.log('âœ… å…¬å‘Šç®¡ç†é¡µé¢åŠ è½½å®Œæˆ');
          console.log('âœ… CloudStorage çŠ¶æ€:', window.CloudStorage ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–');
          console.log('âœ… CloudStorageHelper çŠ¶æ€:', window.CloudStorageHelper ? 'å·²æŒ‚è½½' : 'æœªæŒ‚è½½');
          loadData();
        });
        
        return {
          // ä¾§è¾¹æ å¯¼èˆª
          adminInfo,
          handleMenuChange,
          handleLogout,
          
          // æ•°æ®çŠ¶æ€
          loading,
          dataList,
          dialogVisible,
          dialogMode,
          formData,
          keyword,
          pagination,
          typeOptions,
          columns,
          
          // ğŸ”¥ äº‘å­˜å‚¨ç›¸å…³
          fileInput,
          uploadLoading,
          
          // æ–¹æ³•
          loadData,
          resetSearch,
          handlePageChange,
          handleAdd,
          handleEdit,
          handleDelete,
          handleSave,
          handleDialogClose,
          
          // ğŸ”¥ äº‘å­˜å‚¨æ–¹æ³•
          triggerUpload,
          handleFileChange,
          removeImage
        };
      }
    }).use(TDesign).mount('#app');
  </script>
</body>
</html>
