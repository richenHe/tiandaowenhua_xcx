<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤©é“æ–‡åŒ–åå°æ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .config-section {
      padding: 20px 30px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }

    .config-row {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 15px;
    }

    .config-row label {
      min-width: 100px;
      font-weight: 500;
    }

    .config-row input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    .btn-secondary {
      background: #718096;
      color: white;
    }

    .btn-secondary:hover {
      background: #4a5568;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      padding: 30px;
      border-bottom: 1px solid #eee;
    }

    .stat-card {
      padding: 20px;
      border-radius: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .stat-card.success {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }

    .stat-card.error {
      background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    }

    .stat-card.pending {
      background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
    }

    .progress-bar {
      margin: 20px 30px;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      width: 0%;
    }

    .results {
      padding: 30px;
    }

    .module {
      margin-bottom: 30px;
    }

    .module-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background: #f7fafc;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      margin-bottom: 10px;
    }

    .module-header:hover {
      background: #edf2f7;
    }

    .module-title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
    }

    .module-stats {
      display: flex;
      gap: 15px;
      font-size: 14px;
    }

    .module-stat {
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 500;
    }

    .module-stat.total {
      background: #e6fffa;
      color: #234e52;
    }

    .module-stat.success {
      background: #c6f6d5;
      color: #22543d;
    }

    .module-stat.error {
      background: #fed7d7;
      color: #742a2a;
    }

    .api-list {
      display: none;
    }

    .api-list.show {
      display: block;
    }

    .api-item {
      padding: 15px 20px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }

    .api-item.success {
      border-left: 4px solid #48bb78;
      background: #f0fff4;
    }

    .api-item.error {
      border-left: 4px solid #f56565;
      background: #fff5f5;
    }

    .api-item.pending {
      border-left: 4px solid #ed8936;
      background: #fffaf0;
    }

    .api-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .api-name {
      font-weight: 600;
      font-size: 15px;
      color: #2d3748;
    }

    .api-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
    }

    .status-icon {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-icon.success {
      background: #48bb78;
    }

    .status-icon.error {
      background: #f56565;
    }

    .status-icon.pending {
      background: #ed8936;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .api-info {
      font-size: 13px;
      color: #718096;
      margin-bottom: 8px;
    }

    .api-time {
      font-size: 12px;
      color: #a0aec0;
    }

    .api-details {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .api-details pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .log-console {
      margin-top: 20px;
      padding: 15px;
      background: #1a202c;
      color: #e2e8f0;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-left: 3px solid transparent;
    }

    .log-entry.info {
      border-left-color: #4299e1;
    }

    .log-entry.success {
      border-left-color: #48bb78;
    }

    .log-entry.error {
      border-left-color: #f56565;
    }

    .log-time {
      color: #a0aec0;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ§ª å¤©é“æ–‡åŒ–åå°æ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•</h1>
      <p>å…¨é¢æµ‹è¯•æ‰€æœ‰åå°ç®¡ç†æ¥å£ | å…ˆå†™åè¯»éªŒè¯ | è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š</p>
    </div>

    <div class="config-section">
      <div class="config-row">
        <label>ç¯å¢ƒID:</label>
        <input type="text" id="envId" value="cloud1-0gnn3mn17b581124" placeholder="CloudBase ç¯å¢ƒ ID">
      </div>
      <div class="config-row">
        <label>ç®¡ç†å‘˜è´¦å·:</label>
        <input type="text" id="username" value="admin" placeholder="ç®¡ç†å‘˜ç”¨æˆ·å">
      </div>
      <div class="config-row">
        <label>ç®¡ç†å‘˜å¯†ç :</label>
        <input type="password" id="password" value="admin123" placeholder="ç®¡ç†å‘˜å¯†ç ">
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="startTest()">ğŸš€ å¼€å§‹å…¨é‡æµ‹è¯•</button>
        <button class="btn btn-success" onclick="testReadOnly()">ğŸ“– ä»…æµ‹è¯•è¯»æ¥å£</button>
        <button class="btn btn-danger" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
        <button class="btn btn-secondary" onclick="exportReport()">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">æ€»æ¥å£æ•°</div>
        <div class="stat-value" id="totalCount">0</div>
      </div>
      <div class="stat-card success">
        <div class="stat-label">æµ‹è¯•é€šè¿‡</div>
        <div class="stat-value" id="successCount">0</div>
      </div>
      <div class="stat-card error">
        <div class="stat-label">æµ‹è¯•å¤±è´¥</div>
        <div class="stat-value" id="errorCount">0</div>
      </div>
      <div class="stat-card pending">
        <div class="stat-label">å¾…æµ‹è¯•</div>
        <div class="stat-value" id="pendingCount">0</div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progressBar"></div>
    </div>

    <div class="results" id="results"></div>

    <div class="log-console" id="logConsole"></div>
  </div>

  <script src="https://web-9gikcbug35bad3a8-1257172164.tcloudbaseapp.com/sdk/1.7.0/cloud.js"></script>
  <script>
    // å…¨å±€å˜é‡
    let app = null;
    let jwtToken = null;
    let testResults = {
      total: 0,
      success: 0,
      error: 0,
      pending: 0,
      modules: {}
    };

    // æµ‹è¯•æ•°æ®å­˜å‚¨ï¼ˆç”¨äºå…ˆå†™åè¯»éªŒè¯ï¼‰
    let testData = {
      createdIds: {},
      testUser: null,
      testOrder: null,
      testCourse: null,
      testClassRecord: null
    };

    // åˆå§‹åŒ– CloudBase
    function initCloudBase() {
      const envId = document.getElementById('envId').value;
      app = window.cloudbase.init({
        env: envId
      });
      log('info', `CloudBase åˆå§‹åŒ–æˆåŠŸ: ${envId}`);
    }

    // æ—¥å¿—è¾“å‡º
    function log(type, message) {
      const logConsole = document.getElementById('logConsole');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
      logConsole.appendChild(entry);
      logConsole.scrollTop = logConsole.scrollHeight;
      console.log(`[${type}] ${message}`);
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStats() {
      document.getElementById('totalCount').textContent = testResults.total;
      document.getElementById('successCount').textContent = testResults.success;
      document.getElementById('errorCount').textContent = testResults.error;
      document.getElementById('pendingCount').textContent = testResults.pending;

      const progress = testResults.total > 0 ?
        ((testResults.success + testResults.error) / testResults.total * 100) : 0;
      document.getElementById('progressBar').style.width = progress + '%';
    }

    // è°ƒç”¨äº‘å‡½æ•°
    async function callCloudFunction(functionName, action, params = {}) {
      try {
        const requestData = {
          action: action,
          jwtToken: jwtToken,
          ...params
        };

        log('info', `è°ƒç”¨æ¥å£: ${functionName}.${action}`);

        const result = await app.callFunction({
          name: functionName,
          data: requestData
        });

        if (result.result.success) {
          log('success', `âœ“ ${functionName}.${action} æˆåŠŸ`);
          return { success: true, data: result.result.data };
        } else {
          log('error', `âœ— ${functionName}.${action} å¤±è´¥: ${result.result.message}`);
          return { success: false, error: result.result.message };
        }
      } catch (error) {
        log('error', `âœ— ${functionName}.${action} å¼‚å¸¸: ${error.message}`);
        return { success: false, error: error.message };
      }
    }

    // ç®¡ç†å‘˜ç™»å½•
    async function adminLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      log('info', 'å¼€å§‹ç®¡ç†å‘˜ç™»å½•...');

      const result = await callCloudFunction('system', 'login', {
        username: username,
        password: password
      });

      if (result.success && result.data.token) {
        jwtToken = result.data.token;
        log('success', 'âœ“ ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
        return true;
      } else {
        log('error', 'âœ— ç®¡ç†å‘˜ç™»å½•å¤±è´¥');
        return false;
      }
    }

    // æ¸²æŸ“æµ‹è¯•ç»“æœ
    function renderResults() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      for (const [moduleName, moduleData] of Object.entries(testResults.modules)) {
        const moduleDiv = document.createElement('div');
        moduleDiv.className = 'module';

        const successCount = moduleData.apis.filter(api => api.status === 'success').length;
        const errorCount = moduleData.apis.filter(api => api.status === 'error').length;

        moduleDiv.innerHTML = `
          <div class="module-header" onclick="toggleModule('${moduleName}')">
            <div class="module-title">${moduleData.title}</div>
            <div class="module-stats">
              <span class="module-stat total">æ€»æ•°: ${moduleData.apis.length}</span>
              <span class="module-stat success">æˆåŠŸ: ${successCount}</span>
              <span class="module-stat error">å¤±è´¥: ${errorCount}</span>
            </div>
          </div>
          <div class="api-list" id="module-${moduleName}">
            ${moduleData.apis.map(api => renderApiItem(api)).join('')}
          </div>
        `;

        resultsDiv.appendChild(moduleDiv);
      }
    }

    // æ¸²æŸ“å•ä¸ªæ¥å£é¡¹
    function renderApiItem(api) {
      const statusClass = api.status || 'pending';
      const statusText = {
        'success': 'âœ“ é€šè¿‡',
        'error': 'âœ— å¤±è´¥',
        'pending': 'â³ å¾…æµ‹è¯•'
      }[statusClass];

      return `
        <div class="api-item ${statusClass}">
          <div class="api-header">
            <div class="api-name">${api.name}</div>
            <div class="api-status">
              <span class="status-icon ${statusClass}"></span>
              ${statusText}
            </div>
          </div>
          <div class="api-info">
            <strong>æ¥å£:</strong> ${api.function}.${api.action} |
            <strong>ç±»å‹:</strong> ${api.type}
          </div>
          ${api.time ? `<div class="api-time">è€—æ—¶: ${api.time}ms</div>` : ''}
          ${api.details ? `
            <div class="api-details">
              <pre>${JSON.stringify(api.details, null, 2)}</pre>
            </div>
          ` : ''}
        </div>
      `;
    }

    // åˆ‡æ¢æ¨¡å—æ˜¾ç¤º
    function toggleModule(moduleName) {
      const moduleList = document.getElementById(`module-${moduleName}`);
      moduleList.classList.toggle('show');
    }

    // æ›´æ–°æ¥å£çŠ¶æ€
    function updateApiStatus(moduleName, apiName, status, details = null, time = null) {
      const module = testResults.modules[moduleName];
      if (!module) return;

      const api = module.apis.find(a => a.name === apiName);
      if (!api) return;

      if (api.status === 'pending') {
        testResults.pending--;
      }

      api.status = status;
      api.details = details;
      api.time = time;

      if (status === 'success') {
        testResults.success++;
      } else if (status === 'error') {
        testResults.error++;
      }

      updateStats();
      renderResults();
    }

    // å®šä¹‰æ‰€æœ‰æµ‹è¯•æ¥å£ï¼ˆå¿…é¡»åœ¨ initTestResults ä¹‹å‰å®šä¹‰ï¼‰
    let testAPIs = {
      system: {
        title: 'ç³»ç»Ÿç®¡ç†æ¨¡å— (21ä¸ªæ¥å£)',
        apis: [
          // èº«ä»½è®¤è¯
          { name: 'ç®¡ç†å‘˜ç™»å½•', function: 'system', action: 'login', type: 'è¯»æ“ä½œ', test: testSystemLogin },

          // ç³»ç»Ÿé…ç½®
          { name: 'è·å–ç³»ç»Ÿé…ç½®', function: 'system', action: 'getConfig', type: 'è¯»æ“ä½œ', test: testGetConfig },
          { name: 'æ›´æ–°ç³»ç»Ÿé…ç½®', function: 'system', action: 'updateConfig', type: 'å†™æ“ä½œ', test: testUpdateConfig },
          { name: 'è·å–ç»Ÿè®¡æ•°æ®', function: 'system', action: 'getStatistics', type: 'è¯»æ“ä½œ', test: testGetStatistics },

          // ç®¡ç†å‘˜ç®¡ç†
          { name: 'è·å–ç®¡ç†å‘˜åˆ—è¡¨', function: 'system', action: 'getAdminUserList', type: 'è¯»æ“ä½œ', test: testGetAdminUserList },
          { name: 'åˆ›å»ºç®¡ç†å‘˜', function: 'system', action: 'createAdminUser', type: 'å†™æ“ä½œ', test: testCreateAdminUser },
          { name: 'æ›´æ–°ç®¡ç†å‘˜', function: 'system', action: 'updateAdminUser', type: 'å†™æ“ä½œ', test: testUpdateAdminUser },
          { name: 'åˆ é™¤ç®¡ç†å‘˜', function: 'system', action: 'deleteAdminUser', type: 'å†™æ“ä½œ', test: testDeleteAdminUser },

          // å…¬å‘Šç®¡ç†
          { name: 'è·å–å…¬å‘Šåˆ—è¡¨', function: 'system', action: 'getAnnouncementList', type: 'è¯»æ“ä½œ', test: testGetAnnouncementList },
          { name: 'åˆ›å»ºå…¬å‘Š', function: 'system', action: 'createAnnouncement', type: 'å†™æ“ä½œ', test: testCreateAnnouncement },
          { name: 'æ›´æ–°å…¬å‘Š', function: 'system', action: 'updateAnnouncement', type: 'å†™æ“ä½œ', test: testUpdateAnnouncement },
          { name: 'åˆ é™¤å…¬å‘Š', function: 'system', action: 'deleteAnnouncement', type: 'å†™æ“ä½œ', test: testDeleteAnnouncement },

          // åé¦ˆç®¡ç†
          { name: 'è·å–åé¦ˆåˆ—è¡¨', function: 'system', action: 'getFeedbackList', type: 'è¯»æ“ä½œ', test: testGetFeedbackList },
          { name: 'å›å¤åé¦ˆ', function: 'system', action: 'replyFeedback', type: 'å†™æ“ä½œ', test: testReplyFeedback },

          // é€šçŸ¥ç®¡ç†
          { name: 'è·å–é€šçŸ¥é…ç½®åˆ—è¡¨', function: 'system', action: 'getNotificationConfigList', type: 'è¯»æ“ä½œ', test: testGetNotificationConfigList },
          { name: 'åˆ›å»ºé€šçŸ¥é…ç½®', function: 'system', action: 'createNotificationConfig', type: 'å†™æ“ä½œ', test: testCreateNotificationConfig },
          { name: 'æ›´æ–°é€šçŸ¥é…ç½®', function: 'system', action: 'updateNotificationConfig', type: 'å†™æ“ä½œ', test: testUpdateNotificationConfig },
          { name: 'è·å–é€šçŸ¥æ—¥å¿—', function: 'system', action: 'getNotificationLogs', type: 'è¯»æ“ä½œ', test: testGetNotificationLogs },

          // å¤§ä½¿ç­‰çº§é…ç½®
          { name: 'è·å–å¤§ä½¿ç­‰çº§é…ç½®', function: 'system', action: 'getAmbassadorLevelConfigs', type: 'è¯»æ“ä½œ', test: testGetAmbassadorLevelConfigs },
          { name: 'æ›´æ–°å¤§ä½¿ç­‰çº§é…ç½®', function: 'system', action: 'updateAmbassadorLevelConfig', type: 'å†™æ“ä½œ', test: testUpdateAmbassadorLevelConfig },
          { name: 'åˆå§‹åŒ–å¤§ä½¿ç­‰çº§é…ç½®', function: 'system', action: 'initAmbassadorLevelConfigs', type: 'å†™æ“ä½œ', test: testInitAmbassadorLevelConfigs }
        ]
      },

      user: {
        title: 'ç”¨æˆ·ç®¡ç†æ¨¡å— (4ä¸ªæ¥å£)',
        apis: [
          { name: 'è·å–å­¦å‘˜åˆ—è¡¨', function: 'user', action: 'getUserList', type: 'è¯»æ“ä½œ', test: testGetUserList },
          { name: 'è·å–å­¦å‘˜è¯¦æƒ…', function: 'user', action: 'getUserDetail', type: 'è¯»æ“ä½œ', test: testGetUserDetail },
          { name: 'ä¿®æ”¹å­¦å‘˜æ¨èäºº', function: 'user', action: 'updateUserReferee', type: 'å†™æ“ä½œ', test: testUpdateUserReferee },
          { name: 'è·å–æ¨èäººå˜æ›´æ—¥å¿—', function: 'user', action: 'getRefereeChangeLogs', type: 'è¯»æ“ä½œ', test: testGetRefereeChangeLogs }
        ]
      },

      order: {
        title: 'è®¢å•ç®¡ç†æ¨¡å— (6ä¸ªæ¥å£)',
        apis: [
          { name: 'è·å–è®¢å•åˆ—è¡¨', function: 'order', action: 'getOrderList', type: 'è¯»æ“ä½œ', test: testGetOrderList },
          { name: 'è·å–è®¢å•è¯¦æƒ…', function: 'order', action: 'getOrderDetail', type: 'è¯»æ“ä½œ', test: testGetOrderDetail },
          { name: 'è·å–é€€æ¬¾åˆ—è¡¨', function: 'order', action: 'getRefundList', type: 'è¯»æ“ä½œ', test: testGetRefundList },
          { name: 'ç®¡ç†å‘˜é€€æ¬¾', function: 'order', action: 'refund', type: 'å†™æ“ä½œ', test: testRefund },
          { name: 'è·å–æç°åˆ—è¡¨', function: 'order', action: 'getWithdrawList', type: 'è¯»æ“ä½œ', test: testGetWithdrawList },
          { name: 'å®¡æ ¸æç°ç”³è¯·', function: 'order', action: 'withdrawAudit', type: 'å†™æ“ä½œ', test: testWithdrawAudit }
        ]
      },

      course: {
        title: 'è¯¾ç¨‹ç®¡ç†æ¨¡å— (20ä¸ªæ¥å£)',
        apis: [
          // è¯¾ç¨‹ç®¡ç†
          { name: 'è·å–è¯¾ç¨‹åˆ—è¡¨', function: 'course', action: 'getCourseList', type: 'è¯»æ“ä½œ', test: testGetCourseList },
          { name: 'åˆ›å»ºè¯¾ç¨‹', function: 'course', action: 'createCourse', type: 'å†™æ“ä½œ', test: testCreateCourse },
          { name: 'æ›´æ–°è¯¾ç¨‹', function: 'course', action: 'updateCourse', type: 'å†™æ“ä½œ', test: testUpdateCourse },
          { name: 'åˆ é™¤è¯¾ç¨‹', function: 'course', action: 'deleteCourse', type: 'å†™æ“ä½œ', test: testDeleteCourse },

          // ä¸Šè¯¾æ’æœŸ
          { name: 'è·å–ä¸Šè¯¾æ’æœŸåˆ—è¡¨', function: 'course', action: 'getClassRecordList', type: 'è¯»æ“ä½œ', test: testGetClassRecordList },
          { name: 'åˆ›å»ºä¸Šè¯¾æ’æœŸ', function: 'course', action: 'createClassRecord', type: 'å†™æ“ä½œ', test: testCreateClassRecord },
          { name: 'æ›´æ–°ä¸Šè¯¾æ’æœŸ', function: 'course', action: 'updateClassRecord', type: 'å†™æ“ä½œ', test: testUpdateClassRecord },
          { name: 'åˆ é™¤ä¸Šè¯¾æ’æœŸ', function: 'course', action: 'deleteClassRecord', type: 'å†™æ“ä½œ', test: testDeleteClassRecord },

          // é¢„çº¦ç®¡ç†
          { name: 'è·å–é¢„çº¦åˆ—è¡¨', function: 'course', action: 'getAppointmentList', type: 'è¯»æ“ä½œ', test: testGetAppointmentList },
          { name: 'æ›´æ–°é¢„çº¦çŠ¶æ€', function: 'course', action: 'updateAppointmentStatus', type: 'å†™æ“ä½œ', test: testUpdateAppointmentStatus },
          { name: 'æ‰¹é‡ç­¾åˆ°', function: 'course', action: 'batchCheckin', type: 'å†™æ“ä½œ', test: testBatchCheckin },

          // æ¡ˆä¾‹ç®¡ç†
          { name: 'è·å–æ¡ˆä¾‹åˆ—è¡¨', function: 'course', action: 'getCaseList', type: 'è¯»æ“ä½œ', test: testGetCaseList },
          { name: 'åˆ›å»ºæ¡ˆä¾‹', function: 'course', action: 'createCase', type: 'å†™æ“ä½œ', test: testCreateCase },
          { name: 'æ›´æ–°æ¡ˆä¾‹', function: 'course', action: 'updateCase', type: 'å†™æ“ä½œ', test: testUpdateCase },
          { name: 'åˆ é™¤æ¡ˆä¾‹', function: 'course', action: 'deleteCase', type: 'å†™æ“ä½œ', test: testDeleteCase },

          // èµ„æ–™ç®¡ç†
          { name: 'è·å–èµ„æ–™åˆ—è¡¨', function: 'course', action: 'getMaterialList', type: 'è¯»æ“ä½œ', test: testGetMaterialList },
          { name: 'åˆ›å»ºèµ„æ–™', function: 'course', action: 'createMaterial', type: 'å†™æ“ä½œ', test: testCreateMaterial },
          { name: 'æ›´æ–°èµ„æ–™', function: 'course', action: 'updateMaterial', type: 'å†™æ“ä½œ', test: testUpdateMaterial },
          { name: 'åˆ é™¤èµ„æ–™', function: 'course', action: 'deleteMaterial', type: 'å†™æ“ä½œ', test: testDeleteMaterial },

          // å•†å­¦é™¢
          { name: 'ç®¡ç†å•†å­¦é™¢å†…å®¹', function: 'course', action: 'manageAcademyContent', type: 'å†™æ“ä½œ', test: testManageAcademyContent }
        ]
      },

      ambassador: {
        title: 'å¤§ä½¿ç®¡ç†æ¨¡å— (15ä¸ªæ¥å£)',
        apis: [
          // å¤§ä½¿ç®¡ç†
          { name: 'è·å–å¤§ä½¿åˆ—è¡¨', function: 'ambassador', action: 'getAmbassadorList', type: 'è¯»æ“ä½œ', test: testGetAmbassadorList },
          { name: 'è·å–å¤§ä½¿è¯¦æƒ…', function: 'ambassador', action: 'getAmbassadorDetail', type: 'è¯»æ“ä½œ', test: testGetAmbassadorDetail },

          // ç”³è¯·ç®¡ç†
          { name: 'è·å–å¤§ä½¿ç”³è¯·åˆ—è¡¨', function: 'ambassador', action: 'getApplicationList', type: 'è¯»æ“ä½œ', test: testGetApplicationList },
          { name: 'å®¡æ ¸å¤§ä½¿ç”³è¯·', function: 'ambassador', action: 'auditApplication', type: 'å†™æ“ä½œ', test: testAuditApplication },

          // æ´»åŠ¨ç®¡ç†
          { name: 'è·å–æ´»åŠ¨åˆ—è¡¨', function: 'ambassador', action: 'getActivityList', type: 'è¯»æ“ä½œ', test: testGetActivityList },
          { name: 'åˆ›å»ºæ´»åŠ¨', function: 'ambassador', action: 'createActivity', type: 'å†™æ“ä½œ', test: testCreateActivity },
          { name: 'æ›´æ–°æ´»åŠ¨', function: 'ambassador', action: 'updateActivity', type: 'å†™æ“ä½œ', test: testUpdateActivity },
          { name: 'åˆ é™¤æ´»åŠ¨', function: 'ambassador', action: 'deleteActivity', type: 'å†™æ“ä½œ', test: testDeleteActivity },

          // åè®®æ¨¡æ¿
          { name: 'è·å–åè®®æ¨¡æ¿åˆ—è¡¨', function: 'ambassador', action: 'getContractTemplateList', type: 'è¯»æ“ä½œ', test: testGetContractTemplateList },
          { name: 'åˆ›å»ºåè®®æ¨¡æ¿', function: 'ambassador', action: 'createContractTemplate', type: 'å†™æ“ä½œ', test: testCreateContractTemplate },
          { name: 'æ›´æ–°åè®®æ¨¡æ¿', function: 'ambassador', action: 'updateContractTemplate', type: 'å†™æ“ä½œ', test: testUpdateContractTemplate },
          { name: 'åˆ é™¤åè®®æ¨¡æ¿', function: 'ambassador', action: 'deleteContractTemplate', type: 'å†™æ“ä½œ', test: testDeleteContractTemplate },
          { name: 'è·å–åè®®ç‰ˆæœ¬å†å²', function: 'ambassador', action: 'getContractVersions', type: 'è¯»æ“ä½œ', test: testGetContractVersions },

          // ç­¾ç½²ç®¡ç†
          { name: 'è·å–ç­¾ç½²åˆ—è¡¨', function: 'ambassador', action: 'getSignatureList', type: 'è¯»æ“ä½œ', test: testGetSignatureList },
          { name: 'è·å–å³å°†åˆ°æœŸåè®®', function: 'ambassador', action: 'getExpiringContracts', type: 'è¯»æ“ä½œ', test: testGetExpiringContracts }
        ]
      }
    };

    // åˆå§‹åŒ–æµ‹è¯•ç»“æœ
    function initTestResults() {
      testResults = {
        total: 0,
        success: 0,
        error: 0,
        pending: 0,
        modules: {}
      };

      for (const [moduleName, moduleData] of Object.entries(testAPIs)) {
        testResults.modules[moduleName] = {
          title: moduleData.title,
          apis: moduleData.apis.map(api => ({
            ...api,
            status: 'pending'
          }))
        };
        testResults.total += moduleData.apis.length;
        testResults.pending += moduleData.apis.length;
      }

      updateStats();
      renderResults();
    }

    // ==================== æµ‹è¯•å‡½æ•°å®ç° ====================

    // System æ¨¡å—æµ‹è¯•å‡½æ•°
    async function testSystemLogin() {
      return await callCloudFunction('system', 'login', {
        username: document.getElementById('username').value,
        password: document.getElementById('password').value
      });
    }

    async function testGetConfig() {
      return await callCloudFunction('system', 'getConfig', {});
    }

    async function testUpdateConfig() {
      return await callCloudFunction('system', 'updateConfig', {
        key: 'test_config_' + Date.now(),
        value: { test: true, timestamp: Date.now() }
      });
    }

    async function testGetStatistics() {
      return await callCloudFunction('system', 'getStatistics', {});
    }

    async function testGetAdminUserList() {
      return await callCloudFunction('system', 'getAdminUserList', {
        page: 1,
        page_size: 20
      });
    }

    async function testCreateAdminUser() {
      const result = await callCloudFunction('system', 'createAdminUser', {
        username: 'test_admin_' + Date.now(),
        password: 'test123456',
        real_name: 'æµ‹è¯•ç®¡ç†å‘˜',
        role: 'operator',
        permissions: ['user:view', 'order:view']
      });
      if (result.success && result.data && result.data.id) {
        testData.createdIds.adminUser = result.data.id;
      }
      return result;
    }

    async function testUpdateAdminUser() {
      if (!testData.createdIds.adminUser) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºç®¡ç†å‘˜' };
      }
      return await callCloudFunction('system', 'updateAdminUser', {
        id: testData.createdIds.adminUser,
        real_name: 'æµ‹è¯•ç®¡ç†å‘˜(å·²æ›´æ–°)',
        status: 1
      });
    }

    async function testDeleteAdminUser() {
      if (!testData.createdIds.adminUser) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºç®¡ç†å‘˜' };
      }
      return await callCloudFunction('system', 'deleteAdminUser', {
        id: testData.createdIds.adminUser
      });
    }

    async function testGetAnnouncementList() {
      return await callCloudFunction('system', 'getAnnouncementList', {
        page: 1,
        pageSize: 20
      });
    }

    async function testCreateAnnouncement() {
      const result = await callCloudFunction('system', 'createAnnouncement', {
        title: 'æµ‹è¯•å…¬å‘Š_' + Date.now(),
        content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•å…¬å‘Šå†…å®¹',
        summary: 'æµ‹è¯•å…¬å‘Šæ‘˜è¦',
        category: 'general',
        target_type: 'all',
        is_top: false,
        is_popup: false,
        sort_order: 0,
        status: 1
      });
      if (result.success && result.data && result.data.id) {
        testData.createdIds.announcement = result.data.id;
      }
      return result;
    }

    async function testUpdateAnnouncement() {
      if (!testData.createdIds.announcement) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºå…¬å‘Š' };
      }
      return await callCloudFunction('system', 'updateAnnouncement', {
        id: testData.createdIds.announcement,
        title: 'æµ‹è¯•å…¬å‘Š(å·²æ›´æ–°)',
        content: 'æ›´æ–°åçš„å…¬å‘Šå†…å®¹'
      });
    }

    async function testDeleteAnnouncement() {
      if (!testData.createdIds.announcement) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºå…¬å‘Š' };
      }
      return await callCloudFunction('system', 'deleteAnnouncement', {
        id: testData.createdIds.announcement
      });
    }

    async function testGetFeedbackList() {
      return await callCloudFunction('system', 'getFeedbackList', {
        page: 1,
        page_size: 20
      });
    }

    async function testReplyFeedback() {
      const listResult = await callCloudFunction('system', 'getFeedbackList', {
        page: 1,
        page_size: 1,
        status: 0
      });

      if (listResult.success && listResult.data && listResult.data.list && listResult.data.list.length > 0) {
        const feedbackId = listResult.data.list[0]._id;
        return await callCloudFunction('system', 'replyFeedback', {
          id: feedbackId,
          reply: 'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†',
          status: 1
        });
      }
      return { success: true, data: { message: 'æš‚æ— å¾…å›å¤çš„åé¦ˆ' } };
    }

    async function testGetNotificationConfigList() {
      return await callCloudFunction('system', 'getNotificationConfigList', {});
    }

    async function testCreateNotificationConfig() {
      const result = await callCloudFunction('system', 'createNotificationConfig', {
        name: 'æµ‹è¯•é€šçŸ¥_' + Date.now(),
        config_name: 'æµ‹è¯•é€šçŸ¥é…ç½®',
        config_code: 'test_notify_' + Date.now(),
        trigger_type: 'manual',
        template_id: 'test_template',
        title: 'æµ‹è¯•é€šçŸ¥æ ‡é¢˜',
        content_template: 'æµ‹è¯•é€šçŸ¥å†…å®¹',
        page_path: '/pages/index/index'
      });
      if (result.success && result.data && result.data.id) {
        testData.createdIds.notificationConfig = result.data.id;
      }
      return result;
    }

    async function testUpdateNotificationConfig() {
      if (!testData.createdIds.notificationConfig) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºé€šçŸ¥é…ç½®' };
      }
      return await callCloudFunction('system', 'updateNotificationConfig', {
        id: testData.createdIds.notificationConfig,
        name: 'æµ‹è¯•é€šçŸ¥(å·²æ›´æ–°)',
        status: 1
      });
    }

    async function testGetNotificationLogs() {
      return await callCloudFunction('system', 'getNotificationLogs', {
        page: 1,
        page_size: 20
      });
    }

    async function testGetAmbassadorLevelConfigs() {
      return await callCloudFunction('system', 'getAmbassadorLevelConfigs', {});
    }

    async function testUpdateAmbassadorLevelConfig() {
      return await callCloudFunction('system', 'updateAmbassadorLevelConfig', {
        level: 1,
        level_name: 'åˆçº§å¤§ä½¿(æµ‹è¯•)',
        upgrade_type: 'auto',
        upgrade_conditions: { direct_students: 3 },
        benefits: { commission_rate: 0.1 },
        description: 'æµ‹è¯•æ›´æ–°'
      });
    }

    async function testInitAmbassadorLevelConfigs() {
      return await callCloudFunction('system', 'initAmbassadorLevelConfigs', {});
    }

    // User æ¨¡å—æµ‹è¯•å‡½æ•°
    async function testGetUserList() {
      return await callCloudFunction('user', 'getUserList', {
        page: 1,
        pageSize: 20
      });
    }

    async function testGetUserDetail() {
      const listResult = await callCloudFunction('user', 'getUserList', {
        page: 1,
        pageSize: 1
      });

      if (listResult.success && listResult.data && listResult.data.list && listResult.data.list.length > 0) {
        const userId = listResult.data.list[0]._id;
        return await callCloudFunction('user', 'getUserDetail', {
          userId: userId
        });
      }
      return { success: true, data: { message: 'æš‚æ— ç”¨æˆ·æ•°æ®' } };
    }

    async function testUpdateUserReferee() {
      const listResult = await callCloudFunction('user', 'getUserList', {
        page: 1,
        pageSize: 2
      });

      if (listResult.success && listResult.data && listResult.data.list && listResult.data.list.length >= 2) {
        const userId = listResult.data.list[0]._id;
        const newRefereeId = listResult.data.list[1]._id;
        return await callCloudFunction('user', 'updateUserReferee', {
          userId: userId,
          newRefereeId: newRefereeId,
          remark: 'æµ‹è¯•ä¿®æ”¹æ¨èäºº'
        });
      }
      return { success: true, data: { message: 'ç”¨æˆ·æ•°æ®ä¸è¶³' } };
    }

    async function testGetRefereeChangeLogs() {
      const listResult = await callCloudFunction('user', 'getUserList', {
        page: 1,
        pageSize: 1
      });

      if (listResult.success && listResult.data && listResult.data.list && listResult.data.list.length > 0) {
        const userId = listResult.data.list[0]._id;
        return await callCloudFunction('user', 'getRefereeChangeLogs', {
          userId: userId,
          page: 1,
          pageSize: 20
        });
      }
      return { success: true, data: { message: 'æš‚æ— ç”¨æˆ·æ•°æ®' } };
    }

    // Order æ¨¡å—æµ‹è¯•å‡½æ•°
    async function testGetOrderList() {
      return await callCloudFunction('order', 'getOrderList', {
        page: 1,
        page_size: 20
      });
    }

    async function testGetOrderDetail() {
      const listResult = await callCloudFunction('order', 'getOrderList', {
        page: 1,
        page_size: 1
      });

      if (listResult.success && listResult.data && listResult.data.list && listResult.data.list.length > 0) {
        const orderNo = listResult.data.list[0].order_no;
        return await callCloudFunction('order', 'getOrderDetail', {
          order_no: orderNo
        });
      }
      return { success: true, data: { message: 'æš‚æ— è®¢å•æ•°æ®' } };
    }

    async function testGetRefundList() {
      return await callCloudFunction('order', 'getRefundList', {
        page: 1,
        pageSize: 20
      });
    }

    async function testRefund() {
      const listResult = await callCloudFunction('order', 'getOrderList', {
        page: 1,
        page_size: 1,
        pay_status: 1
      });

      if (listResult.success && listResult.data && listResult.data.list && listResult.data.list.length > 0) {
        const orderNo = listResult.data.list[0].order_no;
        return await callCloudFunction('order', 'refund', {
          order_no: orderNo,
          refund_reason: 'æµ‹è¯•é€€æ¬¾'
        });
      }
      return { success: true, data: { message: 'æš‚æ— å¯é€€æ¬¾è®¢å•' } };
    }

    async function testGetWithdrawList() {
      return await callCloudFunction('order', 'getWithdrawList', {
        page: 1,
        pageSize: 20
      });
    }

    async function testWithdrawAudit() {
      const listResult = await callCloudFunction('order', 'getWithdrawList', {
        page: 1,
        pageSize: 1,
        status: 0
      });

      if (listResult.success && listResult.data && listResult.data.list && listResult.data.list.length > 0) {
        const withdrawalId = listResult.data.list[0]._id;
        return await callCloudFunction('order', 'withdrawAudit', {
          withdrawal_id: withdrawalId,
          status: 1
        });
      }
      return { success: true, data: { message: 'æš‚æ— å¾…å®¡æ ¸æç°' } };
    }

    // Course æ¨¡å—æµ‹è¯•å‡½æ•°
    async function testGetCourseList() {
      return await callCloudFunction('course', 'getCourseList', {
        page: 1,
        page_size: 20
      });
    }

    async function testCreateCourse() {
      const result = await callCloudFunction('course', 'createCourse', {
        name: 'æµ‹è¯•è¯¾ç¨‹_' + Date.now(),
        type: 1,
        cover_image: 'https://example.com/cover.jpg',
        description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è¯¾ç¨‹',
        content: 'æµ‹è¯•è¯¾ç¨‹è¯¦ç»†å†…å®¹',
        outline: 'è¯¾ç¨‹å¤§çº²',
        teacher: 'æµ‹è¯•è€å¸ˆ',
        duration: 3,
        current_price: 9800,
        original_price: 12800,
        retrain_price: 3800,
        allow_retrain: true,
        sort_order: 0,
        status: 1
      });
      if (result.success && result.data && result.data.id) {
        testData.createdIds.course = result.data.id;
      }
      return result;
    }

    async function testUpdateCourse() {
      if (!testData.createdIds.course) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºè¯¾ç¨‹' };
      }
      return await callCloudFunction('course', 'updateCourse', {
        id: testData.createdIds.course,
        name: 'æµ‹è¯•è¯¾ç¨‹(å·²æ›´æ–°)',
        current_price: 8800
      });
    }

    async function testDeleteCourse() {
      if (!testData.createdIds.course) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºè¯¾ç¨‹' };
      }
      return await callCloudFunction('course', 'deleteCourse', {
        id: testData.createdIds.course
      });
    }

    async function testGetClassRecordList() {
      return await callCloudFunction('course', 'getClassRecordList', {
        page: 1,
        page_size: 20
      });
    }

    async function testCreateClassRecord() {
      const courseResult = await callCloudFunction('course', 'getCourseList', {
        page: 1,
        page_size: 1
      });

      if (courseResult.success && courseResult.data && courseResult.data.list && courseResult.data.list.length > 0) {
        const courseId = courseResult.data.list[0]._id;
        const result = await callCloudFunction('course', 'createClassRecord', {
          course_id: courseId,
          class_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          class_time: '09:00-17:00',
          class_location: 'æµ‹è¯•åœ°ç‚¹',
          teacher: 'æµ‹è¯•è€å¸ˆ',
          total_quota: 30,
          remark: 'æµ‹è¯•æ’æœŸ',
          status: 1
        });
        if (result.success && result.data && result.data.id) {
          testData.createdIds.classRecord = result.data.id;
        }
        return result;
      }
      return { success: true, data: { message: 'æš‚æ— è¯¾ç¨‹æ•°æ®' } };
    }

    async function testUpdateClassRecord() {
      if (!testData.createdIds.classRecord) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºä¸Šè¯¾æ’æœŸ' };
      }
      return await callCloudFunction('course', 'updateClassRecord', {
        id: testData.createdIds.classRecord,
        total_quota: 40,
        notes: 'å·²æ›´æ–°é…é¢'
      });
    }

    async function testDeleteClassRecord() {
      if (!testData.createdIds.classRecord) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºä¸Šè¯¾æ’æœŸ' };
      }
      return await callCloudFunction('course', 'deleteClassRecord', {
        id: testData.createdIds.classRecord
      });
    }

    async function testGetAppointmentList() {
      return await callCloudFunction('course', 'getAppointmentList', {
        page: 1,
        page_size: 20
      });
    }

    async function testUpdateAppointmentStatus() {
      const listResult = await callCloudFunction('course', 'getAppointmentList', {
        page: 1,
        page_size: 1
      });

      if (listResult.success && listResult.data && listResult.data.list && listResult.data.list.length > 0) {
        const appointmentId = listResult.data.list[0]._id;
        return await callCloudFunction('course', 'updateAppointmentStatus', {
          id: appointmentId,
          status: 2,
          notes: 'æµ‹è¯•ç­¾åˆ°'
        });
      }
      return { success: true, data: { message: 'æš‚æ— é¢„çº¦æ•°æ®' } };
    }

    async function testBatchCheckin() {
      const listResult = await callCloudFunction('course', 'getAppointmentList', {
        page: 1,
        page_size: 5
      });

      if (listResult.success && listResult.data && listResult.data.list && listResult.data.list.length > 0) {
        const classRecordId = listResult.data.list[0].class_record_id;
        const userIds = listResult.data.list.map(item => item.user_id);
        return await callCloudFunction('course', 'batchCheckin', {
          class_record_id: classRecordId,
          user_ids: userIds
        });
      }
      return { success: true, data: { message: 'æš‚æ— é¢„çº¦æ•°æ®' } };
    }

    async function testGetCaseList() {
      return await callCloudFunction('course', 'getCaseList', {
        page: 1,
        page_size: 20
      });
    }

    async function testCreateCase() {
      const result = await callCloudFunction('course', 'createCase', {
        title: 'æµ‹è¯•æ¡ˆä¾‹_' + Date.now(),
        category: 'business',
        student_name: 'å¼ ä¸‰',
        student_avatar: 'https://example.com/avatar.jpg',
        student_title: 'ä¼ä¸šå®¶',
        summary: 'æµ‹è¯•æ¡ˆä¾‹æ‘˜è¦',
        content: 'æµ‹è¯•æ¡ˆä¾‹è¯¦ç»†å†…å®¹',
        quote: 'è¿™æ˜¯ä¸€æ®µå¼•ç”¨',
        achievements: ['æˆå°±1', 'æˆå°±2'],
        images: ['https://example.com/img1.jpg'],
        sort_order: 0,
        is_featured: false,
        status: 1
      });
      if (result.success && result.data && result.data.id) {
        testData.createdIds.case = result.data.id;
      }
      return result;
    }

    async function testUpdateCase() {
      if (!testData.createdIds.case) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºæ¡ˆä¾‹' };
      }
      return await callCloudFunction('course', 'updateCase', {
        id: testData.createdIds.case,
        title: 'æµ‹è¯•æ¡ˆä¾‹(å·²æ›´æ–°)',
        is_featured: true
      });
    }

    async function testDeleteCase() {
      if (!testData.createdIds.case) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºæ¡ˆä¾‹' };
      }
      return await callCloudFunction('course', 'deleteCase', {
        id: testData.createdIds.case
      });
    }

    async function testGetMaterialList() {
      return await callCloudFunction('course', 'getMaterialList', {
        page: 1,
        page_size: 20
      });
    }

    async function testCreateMaterial() {
      const result = await callCloudFunction('course', 'createMaterial', {
        title: 'æµ‹è¯•èµ„æ–™_' + Date.now(),
        category: 'document',
        image_url: 'https://example.com/material.jpg',
        content: 'æµ‹è¯•èµ„æ–™å†…å®¹',
        tags: ['æµ‹è¯•', 'èµ„æ–™'],
        sort_order: 0,
        status: 1
      });
      if (result.success && result.data && result.data.id) {
        testData.createdIds.material = result.data.id;
      }
      return result;
    }

    async function testUpdateMaterial() {
      if (!testData.createdIds.material) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºèµ„æ–™' };
      }
      return await callCloudFunction('course', 'updateMaterial', {
        id: testData.createdIds.material,
        title: 'æµ‹è¯•èµ„æ–™(å·²æ›´æ–°)'
      });
    }

    async function testDeleteMaterial() {
      if (!testData.createdIds.material) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºèµ„æ–™' };
      }
      return await callCloudFunction('course', 'deleteMaterial', {
        id: testData.createdIds.material
      });
    }

    async function testManageAcademyContent() {
      return await callCloudFunction('course', 'manageAcademyContent', {
        operation: 'create',
        title: 'æµ‹è¯•å•†å­¦é™¢å†…å®¹_' + Date.now(),
        cover_image: 'https://example.com/academy.jpg',
        summary: 'æµ‹è¯•æ‘˜è¦',
        content: 'æµ‹è¯•å†…å®¹',
        sort_order: 0,
        status: 1
      });
    }

    // Ambassador æ¨¡å—æµ‹è¯•å‡½æ•°
    async function testGetAmbassadorList() {
      return await callCloudFunction('ambassador', 'getAmbassadorList', {
        page: 1,
        page_size: 20
      });
    }

    async function testGetAmbassadorDetail() {
      const listResult = await callCloudFunction('ambassador', 'getAmbassadorList', {
        page: 1,
        page_size: 1
      });

      if (listResult.success && listResult.data && listResult.data.list && listResult.data.list.length > 0) {
        const userId = listResult.data.list[0].user_id || listResult.data.list[0]._id;
        return await callCloudFunction('ambassador', 'getAmbassadorDetail', {
          user_id: userId
        });
      }
      return { success: true, data: { message: 'æš‚æ— å¤§ä½¿æ•°æ®' } };
    }

    async function testGetApplicationList() {
      return await callCloudFunction('ambassador', 'getApplicationList', {
        page: 1,
        page_size: 20
      });
    }

    async function testAuditApplication() {
      const listResult = await callCloudFunction('ambassador', 'getApplicationList', {
        page: 1,
        page_size: 1,
        status: 0
      });

      if (listResult.success && listResult.data && listResult.data.list && listResult.data.list.length > 0) {
        const applicationId = listResult.data.list[0]._id;
        return await callCloudFunction('ambassador', 'auditApplication', {
          application_id: applicationId,
          approved: true
        });
      }
      return { success: true, data: { message: 'æš‚æ— å¾…å®¡æ ¸ç”³è¯·' } };
    }

    async function testGetActivityList() {
      return await callCloudFunction('ambassador', 'getActivityList', {
        page: 1,
        page_size: 20
      });
    }

    async function testCreateActivity() {
      const result = await callCloudFunction('ambassador', 'createActivity', {
        title: 'æµ‹è¯•æ´»åŠ¨_' + Date.now(),
        description: 'æµ‹è¯•æ´»åŠ¨æè¿°',
        activity_type: 'promotion',
        start_time: new Date().toISOString(),
        end_time: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
        target_level: [1, 2, 3],
        reward_config: { bonus: 1000 },
        status: 1
      });
      if (result.success && result.data && result.data.id) {
        testData.createdIds.activity = result.data.id;
      }
      return result;
    }

    async function testUpdateActivity() {
      if (!testData.createdIds.activity) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºæ´»åŠ¨' };
      }
      return await callCloudFunction('ambassador', 'updateActivity', {
        activity_id: testData.createdIds.activity,
        title: 'æµ‹è¯•æ´»åŠ¨(å·²æ›´æ–°)',
        status: 1
      });
    }

    async function testDeleteActivity() {
      if (!testData.createdIds.activity) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºæ´»åŠ¨' };
      }
      return await callCloudFunction('ambassador', 'deleteActivity', {
        activity_id: testData.createdIds.activity
      });
    }

    async function testGetContractTemplateList() {
      return await callCloudFunction('ambassador', 'getContractTemplateList', {
        page: 1,
        page_size: 20
      });
    }

    async function testCreateContractTemplate() {
      const result = await callCloudFunction('ambassador', 'createContractTemplate', {
        title: 'æµ‹è¯•åè®®æ¨¡æ¿_' + Date.now(),
        content: 'æµ‹è¯•åè®®å†…å®¹',
        level: 1,
        version: '1.0',
        effective_date: new Date().toISOString().split('T')[0],
        expiry_date: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
      });
      if (result.success && result.data && result.data.id) {
        testData.createdIds.contractTemplate = result.data.id;
      }
      return result;
    }

    async function testUpdateContractTemplate() {
      if (!testData.createdIds.contractTemplate) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºåè®®æ¨¡æ¿' };
      }
      return await callCloudFunction('ambassador', 'updateContractTemplate', {
        template_id: testData.createdIds.contractTemplate,
        title: 'æµ‹è¯•åè®®æ¨¡æ¿(å·²æ›´æ–°)',
        status: 1
      });
    }

    async function testDeleteContractTemplate() {
      if (!testData.createdIds.contractTemplate) {
        return { success: false, error: 'éœ€è¦å…ˆåˆ›å»ºåè®®æ¨¡æ¿' };
      }
      return await callCloudFunction('ambassador', 'deleteContractTemplate', {
        template_id: testData.createdIds.contractTemplate
      });
    }

    async function testGetContractVersions() {
      return await callCloudFunction('ambassador', 'getContractVersions', {
        level: 1
      });
    }

    async function testGetSignatureList() {
      return await callCloudFunction('ambassador', 'getSignatureList', {
        page: 1,
        page_size: 20
      });
    }

    async function testGetExpiringContracts() {
      return await callCloudFunction('ambassador', 'getExpiringContracts', {
        days: 30
      });
    }

    // ==================== ä¸»æµ‹è¯•æµç¨‹ ====================

    // æ‰§è¡Œå•ä¸ªæ¥å£æµ‹è¯•
    async function runApiTest(moduleName, api) {
      const startTime = Date.now();

      try {
        const result = await api.test();
        const endTime = Date.now();
        const duration = endTime - startTime;

        if (result.success) {
          updateApiStatus(moduleName, api.name, 'success', result.data, duration);
        } else {
          updateApiStatus(moduleName, api.name, 'error', { error: result.error }, duration);
        }
      } catch (error) {
        const endTime = Date.now();
        const duration = endTime - startTime;
        updateApiStatus(moduleName, api.name, 'error', { error: error.message }, duration);
      }
    }

    // å¼€å§‹å…¨é‡æµ‹è¯•
    async function startTest() {
      log('info', '========== å¼€å§‹å…¨é‡æµ‹è¯• ==========');

      // åˆå§‹åŒ–
      initCloudBase();
      initTestResults();

      // ç™»å½•
      const loginSuccess = await adminLogin();
      if (!loginSuccess) {
        log('error', 'ç™»å½•å¤±è´¥ï¼Œæµ‹è¯•ç»ˆæ­¢');
        return;
      }

      // æŒ‰æ¨¡å—é¡ºåºæµ‹è¯•
      for (const [moduleName, moduleData] of Object.entries(testAPIs)) {
        log('info', `\nå¼€å§‹æµ‹è¯•æ¨¡å—: ${moduleData.title}`);

        for (const api of moduleData.apis) {
          // å†™æ“ä½œéœ€è¦å…ˆæ‰§è¡Œå¯¹åº”çš„åˆ›å»ºæ“ä½œ
          if (api.type === 'å†™æ“ä½œ' && api.action.includes('update')) {
            // æ›´æ–°æ“ä½œä¾èµ–åˆ›å»ºæ“ä½œ
            const createApi = moduleData.apis.find(a =>
              a.action.includes('create') &&
              a.action.replace('create', '') === api.action.replace('update', '')
            );
            if (createApi && !testData.createdIds[createApi.action]) {
              log('info', `å…ˆæ‰§è¡Œåˆ›å»ºæ“ä½œ: ${createApi.name}`);
              await runApiTest(moduleName, createApi);
              await new Promise(resolve => setTimeout(resolve, 500));
            }
          }

          if (api.type === 'å†™æ“ä½œ' && api.action.includes('delete')) {
            // åˆ é™¤æ“ä½œä¾èµ–åˆ›å»ºæ“ä½œ
            const createApi = moduleData.apis.find(a =>
              a.action.includes('create') &&
              a.action.replace('create', '') === api.action.replace('delete', '')
            );
            if (createApi && !testData.createdIds[createApi.action]) {
              log('info', `å…ˆæ‰§è¡Œåˆ›å»ºæ“ä½œ: ${createApi.name}`);
              await runApiTest(moduleName, createApi);
              await new Promise(resolve => setTimeout(resolve, 500));
            }
          }

          await runApiTest(moduleName, api);

          // å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
          await new Promise(resolve => setTimeout(resolve, 300));
        }
      }

      log('success', '\n========== æµ‹è¯•å®Œæˆ ==========');
      log('info', `æ€»è®¡: ${testResults.total} | æˆåŠŸ: ${testResults.success} | å¤±è´¥: ${testResults.error}`);
    }

    // ä»…æµ‹è¯•è¯»æ¥å£
    async function testReadOnly() {
      log('info', '========== å¼€å§‹æµ‹è¯•è¯»æ¥å£ ==========');

      initCloudBase();
      initTestResults();

      const loginSuccess = await adminLogin();
      if (!loginSuccess) {
        log('error', 'ç™»å½•å¤±è´¥ï¼Œæµ‹è¯•ç»ˆæ­¢');
        return;
      }

      for (const [moduleName, moduleData] of Object.entries(testAPIs)) {
        log('info', `\nå¼€å§‹æµ‹è¯•æ¨¡å—: ${moduleData.title}`);

        for (const api of moduleData.apis) {
          if (api.type === 'è¯»æ“ä½œ') {
            await runApiTest(moduleName, api);
            await new Promise(resolve => setTimeout(resolve, 300));
          } else {
            // è·³è¿‡å†™æ“ä½œ
            updateApiStatus(moduleName, api.name, 'pending', { message: 'è·³è¿‡å†™æ“ä½œ' });
          }
        }
      }

      log('success', '\n========== è¯»æ¥å£æµ‹è¯•å®Œæˆ ==========');
      log('info', `æ€»è®¡: ${testResults.total} | æˆåŠŸ: ${testResults.success} | è·³è¿‡: ${testResults.pending}`);
    }

    // æ¸…ç©ºç»“æœ
    function clearResults() {
      testResults = {
        total: 0,
        success: 0,
        error: 0,
        pending: 0,
        modules: {}
      };
      testData = {
        createdIds: {},
        testUser: null,
        testOrder: null,
        testCourse: null,
        testClassRecord: null
      };
      document.getElementById('results').innerHTML = '';
      document.getElementById('logConsole').innerHTML = '';
      updateStats();
      log('info', 'å·²æ¸…ç©ºæµ‹è¯•ç»“æœ');
    }

    // å¯¼å‡ºæŠ¥å‘Š
    function exportReport() {
      const report = {
        timestamp: new Date().toISOString(),
        summary: {
          total: testResults.total,
          success: testResults.success,
          error: testResults.error,
          pending: testResults.pending,
          successRate: ((testResults.success / testResults.total) * 100).toFixed(2) + '%'
        },
        modules: {}
      };

      for (const [moduleName, moduleData] of Object.entries(testResults.modules)) {
        report.modules[moduleName] = {
          title: moduleData.title,
          apis: moduleData.apis.map(api => ({
            name: api.name,
            function: api.function,
            action: api.action,
            type: api.type,
            status: api.status,
            time: api.time,
            details: api.details
          }))
        };
      }

      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `api-test-report-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      log('success', 'æµ‹è¯•æŠ¥å‘Šå·²å¯¼å‡º');
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.onload = function() {
      try {
        log('info', 'æµ‹è¯•å·¥å…·å·²å°±ç»ª');
        log('info', 'è¯·é…ç½®ç¯å¢ƒIDå’Œç®¡ç†å‘˜è´¦å·ï¼Œç„¶åç‚¹å‡»"å¼€å§‹å…¨é‡æµ‹è¯•"æŒ‰é’®');

        // æ£€æŸ¥ CloudBase SDK
        if (typeof cloudbase === 'undefined') {
          log('error', 'CloudBase SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        } else {
          log('success', 'CloudBase SDK åŠ è½½æˆåŠŸ');
        }
      } catch (error) {
        console.error('åˆå§‹åŒ–é”™è¯¯:', error);
        alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
      }
    };
  </script>
</body>
</html>
