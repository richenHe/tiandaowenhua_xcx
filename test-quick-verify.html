<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿«é€ŸéªŒè¯ - ç®¡ç†å‘˜åˆ—è¡¨åˆ†é¡µ</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-bottom: 24px; }
    .status {
      padding: 16px;
      border-radius: 4px;
      margin: 16px 0;
      font-weight: 600;
    }
    .success { background: #f6ffed; border: 1px solid #b7eb8f; color: #52c41a; }
    .error { background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; }
    .info { background: #e6f7ff; border: 1px solid #91d5ff; color: #1890ff; }
    button {
      background: #0052D9;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
    }
    button:hover { background: #266FE8; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    pre {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .field-check {
      display: flex;
      align-items: center;
      padding: 8px;
      margin: 4px 0;
      background: #fafafa;
      border-radius: 4px;
    }
    .field-check .icon {
      margin-right: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª å¿«é€ŸéªŒè¯ - ç®¡ç†å‘˜åˆ—è¡¨åˆ†é¡µæ”¹é€ </h1>

    <div class="info status">
      <strong>éªŒè¯è¯´æ˜ï¼š</strong><br>
      æœ¬é¡µé¢å°†å¿«é€ŸéªŒè¯ <code>system/getAdminUserList</code> æ¥å£çš„åˆ†é¡µæ”¹é€ æ˜¯å¦æˆåŠŸã€‚<br>
      è¯·ç¡®ä¿å·²ç™»å½•ç®¡ç†åå°å¹¶éƒ¨ç½²äº†æœ€æ–°çš„äº‘å‡½æ•°ã€‚
    </div>

    <div style="margin: 24px 0;">
      <button onclick="runQuickTest()" id="testBtn">å¼€å§‹éªŒè¯</button>
      <button onclick="location.reload()">é‡ç½®</button>
    </div>

    <div id="results"></div>
  </div>

  <script src="admin/assets/js/config.js"></script>
  <script src="admin/assets/js/admin-api.js"></script>
  <script>
    async function runQuickTest() {
      const resultsDiv = document.getElementById('results');
      const testBtn = document.getElementById('testBtn');

      resultsDiv.innerHTML = '<div class="info status">â³ æ­£åœ¨æµ‹è¯•...</div>';
      testBtn.disabled = true;

      try {
        // æµ‹è¯•1: ç¬¬ä¸€é¡µ
        console.log('æµ‹è¯•1: ç¬¬ä¸€é¡µæ•°æ®');
        const result1 = await AdminAPI.getAdminUserList({ page: 1, page_size: 5 });

        // æ£€æŸ¥å¿…éœ€å­—æ®µ
        const requiredFields = ['list', 'total', 'page', 'pageSize', 'totalPages', 'hasMore', 'hasPrev'];
        const missingFields = requiredFields.filter(field => !(field in result1));

        if (missingFields.length > 0) {
          throw new Error(`ç¼ºå°‘å­—æ®µ: ${missingFields.join(', ')}`);
        }

        // éªŒè¯é€»è¾‘
        const checks = [
          { name: 'page åº”è¯¥ä¸º 1', pass: result1.page === 1 },
          { name: 'hasPrev åº”è¯¥ä¸º false', pass: result1.hasPrev === false },
          { name: 'list åº”è¯¥æ˜¯æ•°ç»„', pass: Array.isArray(result1.list) },
          { name: 'totalPages è®¡ç®—æ­£ç¡®', pass: result1.totalPages === Math.ceil(result1.total / result1.pageSize) },
          { name: 'hasMore è®¡ç®—æ­£ç¡®', pass: result1.hasMore === (result1.page < result1.totalPages) }
        ];

        let html = '<div class="success status">âœ… éªŒè¯é€šè¿‡ï¼</div>';
        html += '<h3>å­—æ®µæ£€æŸ¥ï¼š</h3>';

        for (const field of requiredFields) {
          html += `<div class="field-check">
            <span class="icon">âœ…</span>
            <strong>${field}:</strong> ${JSON.stringify(result1[field])}
          </div>`;
        }

        html += '<h3>é€»è¾‘éªŒè¯ï¼š</h3>';
        for (const check of checks) {
          const icon = check.pass ? 'âœ…' : 'âŒ';
          const className = check.pass ? 'success' : 'error';
          html += `<div class="field-check ${className}">
            <span class="icon">${icon}</span>
            ${check.name}
          </div>`;
        }

        // æµ‹è¯•2: pageSize å‚æ•°å…¼å®¹æ€§
        console.log('æµ‹è¯•2: pageSize å‚æ•°å…¼å®¹æ€§');
        const result2 = await AdminAPI.getAdminUserList({ page: 1, pageSize: 3 });

        html += '<h3>å‚æ•°å…¼å®¹æ€§æµ‹è¯•ï¼š</h3>';
        if (result2.pageSize === 3) {
          html += '<div class="field-check success">âœ… pageSize å‚æ•°å…¼å®¹æ€§æ­£å¸¸</div>';
        } else {
          html += '<div class="field-check error">âŒ pageSize å‚æ•°æœªç”Ÿæ•ˆ</div>';
        }

        html += '<h3>å®Œæ•´å“åº”æ•°æ®ï¼š</h3>';
        html += `<pre>${JSON.stringify(result1, null, 2)}</pre>`;

        html += '<div class="success status" style="margin-top: 24px;">';
        html += '<strong>ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼</strong><br>';
        html += 'å¯ä»¥ç»§ç»­æ‰¹é‡æ”¹é€ å…¶ä»–æ¥å£ã€‚';
        html += '</div>';

        resultsDiv.innerHTML = html;

      } catch (error) {
        console.error('æµ‹è¯•å¤±è´¥:', error);
        resultsDiv.innerHTML = `
          <div class="error status">
            <strong>âŒ éªŒè¯å¤±è´¥</strong><br>
            é”™è¯¯ä¿¡æ¯: ${error.message}<br><br>
            <strong>å¯èƒ½çš„åŸå› ï¼š</strong><br>
            1. æœªç™»å½•ç®¡ç†åå°<br>
            2. äº‘å‡½æ•°æœªéƒ¨ç½²æœ€æ–°ä»£ç <br>
            3. æ¥å£è¿”å›æ ¼å¼ä¸æ­£ç¡®<br><br>
            <strong>è§£å†³æ–¹æ³•ï¼š</strong><br>
            1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯<br>
            2. ç¡®è®¤å·²ç™»å½•: localStorage.getItem('admin_token')<br>
            3. ç¡®è®¤äº‘å‡½æ•°å·²éƒ¨ç½²: cloudbase functions:deploy system
          </div>
        `;
      } finally {
        testBtn.disabled = false;
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    window.onload = function() {
      const token = localStorage.getItem('admin_token');
      if (!token) {
        document.getElementById('results').innerHTML = `
          <div class="error status">
            <strong>âš ï¸ æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€</strong><br>
            è¯·å…ˆç™»å½•ç®¡ç†åå°ï¼Œç„¶ååˆ·æ–°æœ¬é¡µé¢ã€‚<br><br>
            <a href="admin/pages/auth/login.html" style="color: #0052D9;">å‰å¾€ç™»å½•</a>
          </div>
        `;
      }
    };
  </script>
</body>
</html>
