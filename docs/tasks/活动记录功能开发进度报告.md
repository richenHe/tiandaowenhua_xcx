# æ´»åŠ¨è®°å½•åŠŸèƒ½å¼€å‘è¿›åº¦æŠ¥å‘Š

> æ›´æ–°æ—¶é—´ï¼š2026-02-12
> çŠ¶æ€ï¼šäº‘å‡½æ•°å’Œå‰ç«¯APIå·²å®Œæˆï¼Œç­‰å¾…SQLæ‰§è¡Œåæ¥å…¥é¡µé¢

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è®¾è®¡ âœ…

**æ–‡ä»¶ä½ç½®ï¼š** `docs/database/æ´»åŠ¨è®°å½•è¡¨SQL.sql`

**åŒ…å«å†…å®¹ï¼š**
- `ambassador_activity_records` è¡¨ - å¤§ä½¿æ´»åŠ¨è®°å½•è¡¨
- `users.total_activity_count` å­—æ®µ - ç´¯è®¡æ´»åŠ¨æ¬¡æ•°
- `system_configs` å®¢æœç”µè¯é…ç½®
- æµ‹è¯•æ•°æ®ï¼ˆå¯é€‰ï¼‰

**çŠ¶æ€ï¼š** â³ ç­‰å¾…æ‰§è¡ŒSQL

---

### 2. äº‘å‡½æ•°å¼€å‘ âœ…

#### 2.1 user äº‘å‡½æ•°

**æ–°å¢æ–‡ä»¶ï¼š** `cloudfunctions/user/handlers/client/getReferralStats.js`

**åŠŸèƒ½ï¼š** è·å–æ¨èç»Ÿè®¡ä¿¡æ¯

**è¿”å›æ•°æ®ï¼š**
```javascript
{
  total_referrals: 5,                    // æ€»æ¨èäººæ•°
  ambassador_start_date: '2024-01-15',   // æˆä¸ºå¤§ä½¿æ—¶é—´
  total_activity_count: 12               // ç´¯è®¡æ´»åŠ¨æ¬¡æ•°
}
```

**å·²æ³¨å†Œï¼š** âœ… å·²åœ¨ `cloudfunctions/user/index.js` ä¸­æ³¨å†Œ

---

#### 2.2 system äº‘å‡½æ•°

**æ–°å¢æ–‡ä»¶ï¼š** `cloudfunctions/system/handlers/client/getSystemConfig.js`

**åŠŸèƒ½ï¼š** è·å–ç³»ç»Ÿé…ç½®

**è¯·æ±‚å‚æ•°ï¼š**
```javascript
{
  key: 'customer_service_phone'  // é…ç½®é”®
}
```

**è¿”å›æ•°æ®ï¼š**
```javascript
{
  value: '400-123-4567'
}
```

**å·²æ³¨å†Œï¼š** âœ… å·²åœ¨ `cloudfunctions/system/index.js` ä¸­æ³¨å†Œ

---

#### 2.3 ambassador äº‘å‡½æ•°

**æ–°å¢æ–‡ä»¶ï¼š**
1. `cloudfunctions/ambassador/handlers/client/getActivityRecords.js`
2. `cloudfunctions/ambassador/handlers/client/getActivityStats.js`

**åŠŸèƒ½1ï¼šgetActivityRecords** - è·å–æ´»åŠ¨è®°å½•åˆ—è¡¨

**è¯·æ±‚å‚æ•°ï¼š**
```javascript
{
  activityType: 0,  // æ´»åŠ¨ç±»å‹ç­›é€‰ï¼š0å…¨éƒ¨/1è¾…å¯¼å‘˜/2ä¹‰å·¥/3æ²™é¾™/4å…¶ä»–
  page: 1,
  pageSize: 10
}
```

**è¿”å›æ•°æ®ï¼š**
```javascript
{
  list: [
    {
      id: 1,
      activity_type: 1,
      activity_name: 'æ‹…ä»»è¾…å¯¼å‘˜',
      activity_desc: 'åˆæ¢ç­ç¬¬12æœŸ',
      location: 'åŒ—äº¬å¸‚æœé˜³åŒº',
      start_time: '2024-01-15 09:00:00',
      duration: '3å¤©',
      participant_count: 30,
      merit_points: 500.00,
      note: 'ååŠ©è®²å¸ˆæ•™å­¦...',
      created_at: '2024-01-15 09:00:00'
    }
  ],
  total: 12,
  stats: {
    total_count: 12,
    total_merit_points: 3850,
    month_count: 5,
    type_stats: { 1: 5, 2: 4, 3: 2, 4: 1 }
  }
}
```

**åŠŸèƒ½2ï¼šgetActivityStats** - è·å–æ´»åŠ¨ç»Ÿè®¡ä¿¡æ¯

**è¿”å›æ•°æ®ï¼š**
```javascript
{
  total_count: 12,
  total_merit_points: 3850,
  month_count: 5,
  type_stats: { 1: 5, 2: 4, 3: 2, 4: 1 }
}
```

**å·²æ³¨å†Œï¼š** âœ… å·²åœ¨ `cloudfunctions/ambassador/index.js` ä¸­æ³¨å†Œ

---

### 3. å‰ç«¯ç±»å‹å®šä¹‰ âœ…

#### 3.1 ambassador.ts

**æ–‡ä»¶ä½ç½®ï¼š** `src/api/types/ambassador.ts`

**æ–°å¢ç±»å‹ï¼š**
```typescript
// æ´»åŠ¨ç±»å‹æšä¸¾
export enum ActivityType {
  TUTOR = 1,      // è¾…å¯¼å‘˜
  VOLUNTEER = 2,  // ä¼šåŠ¡ä¹‰å·¥
  SALON = 3,      // æ²™é¾™ç»„ç»‡
  OTHER = 4       // å…¶ä»–æ´»åŠ¨
}

// æ´»åŠ¨è®°å½•
export interface ActivityRecord { ... }

// æ´»åŠ¨ç»Ÿè®¡ä¿¡æ¯
export interface ActivityStats { ... }

// è·å–æ´»åŠ¨è®°å½•è¯·æ±‚å‚æ•°
export interface GetActivityRecordsParams { ... }

// è·å–æ´»åŠ¨è®°å½•å“åº”æ•°æ®
export interface GetActivityRecordsResponse { ... }

// æ¨èç»Ÿè®¡ä¿¡æ¯
export interface ReferralStats { ... }
```

---

#### 3.2 user.ts

**æ–‡ä»¶ä½ç½®ï¼š** `src/api/types/user.ts`

**æ–°å¢ç±»å‹ï¼š**
```typescript
// æ¨èç»Ÿè®¡ä¿¡æ¯
export interface ReferralStats {
  total_referrals: number
  ambassador_start_date: string | null
  total_activity_count: number
}
```

---

#### 3.3 system.ts

**æ–‡ä»¶ä½ç½®ï¼š** `src/api/types/system.ts`

**æ–°å¢ç±»å‹ï¼š**
```typescript
// è·å–ç³»ç»Ÿé…ç½®è¯·æ±‚å‚æ•°
export interface GetSystemConfigParams {
  key: string
}

// è·å–ç³»ç»Ÿé…ç½®å“åº”æ•°æ®
export interface GetSystemConfigResponse {
  value: string
}
```

---

### 4. å‰ç«¯APIæ–¹æ³• âœ…

#### 4.1 UserApi

**æ–‡ä»¶ä½ç½®ï¼š** `src/api/modules/user.ts`

**æ–°å¢æ–¹æ³•ï¼š**
```typescript
/**
 * 15. è·å–æ¨èç»Ÿè®¡ä¿¡æ¯
 */
static async getReferralStats(): Promise<ReferralStats>
```

---

#### 4.2 SystemApi

**æ–‡ä»¶ä½ç½®ï¼š** `src/api/modules/system.ts`

**æ–°å¢æ–¹æ³•ï¼š**
```typescript
/**
 * 11. è·å–ç³»ç»Ÿé…ç½®
 */
static async getSystemConfig(params: GetSystemConfigParams): Promise<GetSystemConfigResponse>
```

---

#### 4.3 AmbassadorApi

**æ–‡ä»¶ä½ç½®ï¼š** `src/api/modules/ambassador.ts`

**æ–°å¢æ–¹æ³•ï¼š**
```typescript
/**
 * 12. è·å–æ´»åŠ¨è®°å½•åˆ—è¡¨
 */
static async getActivityRecords(params?: GetActivityRecordsParams): Promise<GetActivityRecordsResponse>

/**
 * 13. è·å–æ´»åŠ¨ç»Ÿè®¡ä¿¡æ¯
 */
static async getActivityStats(): Promise<ActivityStats>
```

---

## ğŸ“‹ ä¸‹ä¸€æ­¥å·¥ä½œ

### 1. æ‰§è¡ŒSQL â³

è¯·å…ˆæ‰§è¡Œ `docs/database/æ´»åŠ¨è®°å½•è¡¨SQL.sql` æ–‡ä»¶ï¼Œåˆ›å»ºæ•°æ®åº“è¡¨å’Œå­—æ®µã€‚

---

### 2. éƒ¨ç½²äº‘å‡½æ•° â³

éœ€è¦éƒ¨ç½²ä»¥ä¸‹äº‘å‡½æ•°ï¼š
- `user` äº‘å‡½æ•°ï¼ˆæ–°å¢ getReferralStats actionï¼‰
- `system` äº‘å‡½æ•°ï¼ˆæ–°å¢ getSystemConfig actionï¼‰
- `ambassador` äº‘å‡½æ•°ï¼ˆæ–°å¢ getActivityRecords å’Œ getActivityStats actionï¼‰

---

### 3. æ¥å…¥å‰ç«¯é¡µé¢ â³

éœ€è¦ä¿®æ”¹ä»¥ä¸‹é¡µé¢ï¼š

#### 3.1 å¤§ä½¿ç­‰çº§é¡µ (`pages/ambassador/level/index.vue`)

**éœ€è¦æ¥å…¥çš„APIï¼š**
- `UserApi.getReferralStats()` - è·å–æ¨èç»Ÿè®¡ä¿¡æ¯

**éœ€è¦æ›¿æ¢çš„ç¡¬ç¼–ç æ•°æ®ï¼š**
- ç¬¬15-20è¡Œï¼šå½“å‰ç­‰çº§å¡ç‰‡ï¼ˆç­‰çº§åç§°ã€æ¨èäººæ•°ã€æˆä¸ºå¤§ä½¿æ—¶é—´ï¼‰
- ç¬¬31ã€40è¡Œï¼šåŠŸå¾·åˆ†å’Œç§¯åˆ†ï¼ˆå·²æœ‰APIï¼Œæ— éœ€ä¿®æ”¹ï¼‰

---

#### 3.2 é¢„çº¦ç¡®è®¤é¡µ (`pages/course/appointment-confirm/index.vue`)

**éœ€è¦æ¥å…¥çš„APIï¼š**
- `SystemApi.getSystemConfig({ key: 'customer_service_phone' })` - è·å–å®¢æœç”µè¯

**éœ€è¦æ›¿æ¢çš„ç¡¬ç¼–ç æ•°æ®ï¼š**
- ç¬¬28è¡Œï¼šå®¢æœç”µè¯

---

#### 3.3 ä¸ªäººä¸­å¿ƒé¡µ (`pages/mine/index.vue`)

**éœ€è¦æ¥å…¥çš„APIï¼š**
- `UserApi.getReferralStats()` - è·å–æ¨èç»Ÿè®¡ä¿¡æ¯

**éœ€è¦æ›¿æ¢çš„ç¡¬ç¼–ç æ•°æ®ï¼š**
- ç¬¬210-230è¡Œï¼šè®¾ç½®èœå•ä¸­çš„å¼•èäººåˆ—è¡¨æ•°é‡
- ç¬¬233-237è¡Œï¼šåˆ é™¤å¸®åŠ©èœå•ä¸­çš„å…¬å‘Šæ•°é‡å¾½ç« 

**éœ€è¦æ–°å¢åŠŸèƒ½ï¼š**
- åœ¨ç”¨æˆ·åæ—è¾¹æ˜¾ç¤ºæˆé•¿ç­‰çº§å›¾æ ‡ï¼ˆæ ¹æ®ç´¯è®¡æ´»åŠ¨æ¬¡æ•°ï¼‰

---

#### 3.4 æ´»åŠ¨è®°å½•é¡µ (`pages/ambassador/activity-records/index.vue`)

**éœ€è¦æ¥å…¥çš„APIï¼š**
- `AmbassadorApi.getActivityRecords()` - è·å–æ´»åŠ¨è®°å½•åˆ—è¡¨
- `AmbassadorApi.getActivityStats()` - è·å–æ´»åŠ¨ç»Ÿè®¡ä¿¡æ¯

**éœ€è¦æ›¿æ¢çš„ç¡¬ç¼–ç æ•°æ®ï¼š**
- ç¬¬17-27è¡Œï¼šæ´»åŠ¨ç»Ÿè®¡å¡ç‰‡ï¼ˆç´¯è®¡æ´»åŠ¨ã€åŠŸå¾·åˆ†ã€æœ¬æœˆæ´»åŠ¨ï¼‰
- ç¬¬46-66è¡Œï¼šæ´»åŠ¨ç±»å‹ç»Ÿè®¡ï¼ˆè¾…å¯¼å‘˜ã€ä¹‰å·¥ã€æ²™é¾™ã€å…¶ä»–ï¼‰
- ç¬¬82-197è¡Œï¼šæ´»åŠ¨è®°å½•åˆ—è¡¨ï¼ˆæ‰€æœ‰ç¡¬ç¼–ç çš„æ´»åŠ¨æ•°æ®ï¼‰

**éœ€è¦å®ç°çš„åŠŸèƒ½ï¼š**
- Tabåˆ‡æ¢ç­›é€‰ï¼ˆå…¨éƒ¨/è¾…å¯¼å‘˜/ä¹‰å·¥/æ²™é¾™ï¼‰
- åˆ†é¡µåŠ è½½
- ç©ºçŠ¶æ€æç¤º

---

### 4. åˆ›å»ºæˆé•¿ç­‰çº§å·¥å…·å‡½æ•° â³

**æ–‡ä»¶ä½ç½®ï¼š** `src/utils/growth-level.ts`

**éœ€è¦åˆ›å»ºçš„å‡½æ•°ï¼š**
```typescript
/**
 * æ ¹æ®æ´»åŠ¨æ¬¡æ•°è®¡ç®—æˆé•¿ç­‰çº§æ˜¾ç¤º
 */
export function getGrowthLevelDisplay(activityCount: number): string

/**
 * è·å–æˆé•¿ç­‰çº§åç§°
 */
export function getGrowthLevelName(activityCount: number): string

/**
 * è·å–æˆé•¿ç­‰çº§æè¿°
 */
export function getGrowthLevelDesc(activityCount: number): string
```

---

## ğŸ“ å‘½åè§„èŒƒæé†’

æ ¹æ® `å‰åç«¯è”é€šå®æ–½è®¡åˆ’.md` çš„è¦æ±‚ï¼š

1. **å‰ç«¯ â†’ äº‘å‡½æ•°**ï¼šä½¿ç”¨ **camelCaseï¼ˆé©¼å³°å‘½åï¼‰**
   - âœ… `activityType`ï¼ˆæ­£ç¡®ï¼‰
   - âŒ `activity_type`ï¼ˆé”™è¯¯ï¼‰

2. **äº‘å‡½æ•° â†’ æ•°æ®åº“**ï¼šäº‘å‡½æ•°å†…éƒ¨è½¬æ¢ä¸º **snake_caseï¼ˆä¸‹åˆ’çº¿å‘½åï¼‰**

3. **äº‘å‡½æ•° â†’ å‰ç«¯**ï¼šè¿”å›æ•°æ®åº“åŸå§‹å­—æ®µï¼ˆsnake_caseï¼‰
   - âœ… `activity_type`ï¼ˆæ­£ç¡®ï¼‰
   - âŒ `activityType`ï¼ˆé”™è¯¯ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸ä¿®æ”¹å‰ç«¯é¡µé¢å…ƒç´ **ï¼šåªæ·»åŠ APIè°ƒç”¨é€»è¾‘ï¼Œä¸æ”¹å˜é¡µé¢ç»“æ„å’Œæ ·å¼

2. **å­—æ®µå¯¹é½**ï¼šæ‰€æœ‰å­—æ®µä»¥ `docs/database/æ•°æ®åº“è¯¦ç»†ä¿¡æ¯.md` ä¸ºå‡†

3. **Mockæ•°æ®æ›¿æ¢**ï¼šç¡®ä¿æ‰€æœ‰ç¡¬ç¼–ç çš„Mockæ•°æ®å·²è¢«APIè¿”å›çš„çœŸå®æ•°æ®æ›¿æ¢

4. **æµ‹è¯•éªŒè¯**ï¼šæ¯å®Œæˆä¸€ä¸ªé¡µé¢ç«‹å³æµ‹è¯•ï¼Œç¡®ä¿æ•°æ®æ­£ç¡®æ˜¾ç¤º

---

## ğŸ“Œ ç­‰å¾…ç¡®è®¤

è¯·ç¡®è®¤ï¼š
1. âœ… SQLæ˜¯å¦å·²æ‰§è¡ŒæˆåŠŸï¼Ÿ
2. âœ… äº‘å‡½æ•°æ˜¯å¦å·²éƒ¨ç½²ï¼Ÿ
3. â³ æ˜¯å¦éœ€è¦æˆ‘ç»§ç»­æ¥å…¥å‰ç«¯é¡µé¢ï¼Ÿ

ç¡®è®¤åæˆ‘å°†ç»§ç»­å¼€å‘å‰ç«¯é¡µé¢æ¥å…¥å·¥ä½œã€‚

---

**æ–‡æ¡£åˆ›å»ºå®Œæ¯• âœ…**
