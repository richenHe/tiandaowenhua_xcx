# 数据库索引优化方案

## 目标
优化课程列表查询性能，减少加载时间

## 当前查询分析

### 1. courses 表查询
```sql
SELECT * FROM courses 
WHERE status = 1 
ORDER BY sort_order ASC, created_at DESC 
LIMIT 20 OFFSET 0;
```

### 2. users 表查询
```sql
SELECT * FROM users WHERE openid = ?;
```

### 3. user_courses 表查询
```sql
SELECT course_id FROM user_courses 
WHERE user_id = ? AND deleted_at IS NULL;
```

## 推荐索引

### courses 表
```sql
-- 1. 状态索引（用于筛选启用的课程）
CREATE INDEX idx_courses_status ON courses(status);

-- 2. 类型索引（用于按类型筛选）
CREATE INDEX idx_courses_type ON courses(type);

-- 3. 复合索引（用于排序优化）
CREATE INDEX idx_courses_status_sort ON courses(status, sort_order, created_at);

-- 4. 全文搜索索引（如果支持，用于关键词搜索）
-- CREATE FULLTEXT INDEX idx_courses_search ON courses(name, description);
```

### users 表
```sql
-- openid 索引（用于用户查询）
CREATE UNIQUE INDEX idx_users_openid ON users(openid);
```

### user_courses 表
```sql
-- 1. 用户ID索引
CREATE INDEX idx_user_courses_user_id ON user_courses(user_id);

-- 2. 复合索引（用于查询用户购买的有效课程）
CREATE INDEX idx_user_courses_user_deleted ON user_courses(user_id, deleted_at);

-- 3. 课程ID索引（用于反向查询）
CREATE INDEX idx_user_courses_course_id ON user_courses(course_id);
```

## 执行优先级

### 高优先级（立即执行）
1. `idx_courses_status_sort` - 最关键，直接影响首页加载速度
2. `idx_users_openid` - 用户查询必需
3. `idx_user_courses_user_deleted` - 查询用户购买记录必需

### 中优先级（尽快执行）
4. `idx_courses_type` - 筛选功能使用
5. `idx_user_courses_course_id` - 提升关联查询性能

### 低优先级（可选）
6. 全文搜索索引 - 搜索功能使用

## 预期效果

### 优化前
- 首页课程加载：500-1000ms
- 冷启动：500ms+
- 数据库查询：200-300ms

### 优化后
- 首页课程加载：200-400ms（减少50-60%）
- 冷启动：500ms（不变，但缓存后无影响）
- 数据库查询：50-100ms（减少70%）

## 注意事项

1. **索引大小**：每个索引会占用存储空间，需要权衡
2. **写入性能**：索引会略微降低插入/更新速度（一般可忽略）
3. **定期维护**：大量数据变更后需要重建索引
4. **监控效果**：执行后监控查询性能，必要时调整

## 执行步骤

通过 CloudBase MCP 工具执行 SQL：

```sql
-- 1. 先检查现有索引
SHOW INDEX FROM courses;
SHOW INDEX FROM users;
SHOW INDEX FROM user_courses;

-- 2. 创建索引（如果不存在）
-- courses 表
CREATE INDEX IF NOT EXISTS idx_courses_status_sort ON courses(status, sort_order, created_at);
CREATE INDEX IF NOT EXISTS idx_courses_type ON courses(type);

-- users 表
CREATE UNIQUE INDEX IF NOT EXISTS idx_users_openid ON users(openid);

-- user_courses 表
CREATE INDEX IF NOT EXISTS idx_user_courses_user_deleted ON user_courses(user_id, deleted_at);
CREATE INDEX IF NOT EXISTS idx_user_courses_course_id ON user_courses(course_id);

-- 3. 验证索引创建成功
SHOW INDEX FROM courses;
SHOW INDEX FROM users;
SHOW INDEX FROM user_courses;
```












