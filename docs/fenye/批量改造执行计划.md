# 分页改造批量执行计划

## 改造进度

- ✅ 已完成：1/42 (2.4%)
- ⏳ 待改造：41/42 (97.6%)

## 已完成接口

1. ✅ `system/handlers/admin/getAdminUserList.js` - 管理端管理员列表

---

## 批量改造顺序

### 第一批：P0 优先级（7个接口）- 用户高频使用

#### 课程模块
1. `course/handlers/public/getList.js` - 获取课程列表 (模板 C)

#### 订单模块
2. `order/handlers/client/getMallCourses.js` - 获取商城课程 (模板 C)
3. `order/handlers/client/getMallGoods.js` - 获取商城商品 (模板 C)
4. `order/handlers/client/getList.js` - 获取订单列表 (模板 A)

#### 用户模块
5. `user/handlers/client/getMyCourses.js` - 获取我的课程 (模板 A)
6. `user/handlers/client/getMyOrders.js` - 获取我的订单 (模板 A)

#### 系统模块
7. `system/handlers/client/getAnnouncementList.js` - 获取公告列表 (模板 B)

---

### 第二批：P1 优先级（13个接口）- 大使功能

#### 课程模块
8. `course/handlers/public/getCaseList.js` - 获取案例列表 (模板 C)
9. `course/handlers/public/getMaterialList.js` - 获取资料列表 (模板 C)
10. `course/handlers/client/getClassRecords.js` - 获取上课排期 (模板 A)
11. `course/handlers/client/getMyAppointments.js` - 获取我的预约 (模板 A)

#### 订单模块
12. `order/handlers/client/getExchangeRecords.js` - 获取兑换记录 (模板 A)

#### 用户模块
13. `user/handlers/client/getMyReferees.js` - 获取推荐用户 (模板 A)
14. `user/handlers/client/getCashPointsHistory.js` - 获取积分明细 (模板 A)
15. `user/handlers/client/getMeritPointsHistory.js` - 获取功德分明细 (模板 A)
16. `user/handlers/client/getWithdrawRecords.js` - 获取提现记录 (模板 A)
17. `user/handlers/client/searchReferees.js` - 搜索推荐人 (模板 A)

#### 大使模块
18. `ambassador/handlers/client/getActivityRecords.js` - 获取活动记录 (模板 A)

#### 系统模块
19. `system/handlers/client/getMyFeedback.js` - 获取我的反馈 (模板 A)

---

### 第三批：P2 优先级（21个接口）- 管理端

#### 课程模块
20. `course/handlers/admin/getCourseList.js` - 管理端课程列表 (模板 B)
21. `course/handlers/admin/getCaseList.js` - 管理端案例列表 (模板 B)
22. `course/handlers/admin/getMaterialList.js` - 管理端资料列表 (模板 B)
23. `course/handlers/admin/getAppointmentList.js` - 管理端预约列表 (模板 B)

#### 订单模块
24. `order/handlers/admin/getOrderList.js` - 管理端订单列表 (模板 B)
25. `order/handlers/admin/getRefundList.js` - 管理端退款列表 (模板 A)
26. `order/handlers/admin/getWithdrawList.js` - 管理端提现列表 (模板 A)

#### 用户模块
27. `user/handlers/admin/getUserList.js` - 管理端用户列表 (模板 B)
28. `user/handlers/admin/getRefereeChangeLogs.js` - 推荐人变更日志 (模板 A)

#### 大使模块
29. `ambassador/handlers/admin/getActivityList.js` - 管理端活动列表 (模板 B)
30. `ambassador/handlers/admin/getAmbassadorList.js` - 管理端大使列表 (模板 B)
31. `ambassador/handlers/admin/getApplicationList.js` - 管理端申请列表 (模板 B)
32. `ambassador/handlers/admin/getContractTemplateList.js` - 协议模板列表 (模板 B)
33. `ambassador/handlers/admin/getSignatureList.js` - 签署列表 (模板 B)

#### 系统模块
34. `system/handlers/admin/getAnnouncementList.js` - 管理端公告列表 (模板 B)
35. `system/handlers/admin/getFeedbackList.js` - 管理端反馈列表 (模板 B)
36. `system/handlers/admin/getNotificationLogs.js` - 通知日志 (模板 B)

---

## 改造模板说明

### 模板 A：Supabase 风格接口（简单改造）

**改造要点**：
- 引入 `executePaginatedQuery`
- 移除 `getPagination` 和 `range()`
- 使用 `...result` 展开响应

**预计时间**：5-10分钟/个

---

### 模板 B：query/count 方式（需要重构）

**改造要点**：
- 改为 Supabase 风格
- 引入 `executePaginatedQuery`
- 移除 `query()` 和 `count()` 调用
- 添加 `count: 'exact'`

**预计时间**：10-15分钟/个

---

### 模板 C：带数据处理（需要保留处理逻辑）

**改造要点**：
- 使用 `executePaginatedQuery`
- 保留图片 URL 转换等数据处理
- 在 `result.list` 上进行处理

**预计时间**：10-15分钟/个

---

## 执行策略

### 1. 自动化改造
- 使用脚本批量替换代码
- 保留原有业务逻辑
- 统一错误处理

### 2. 分批部署
- 第一批：部署 P0 接口（7个）
- 第二批：部署 P1 接口（13个）
- 第三批：部署 P2 接口（21个）

### 3. 测试验证
- 每批部署后进行测试
- 确认无问题后继续下一批
- 发现问题立即回滚

---

## 预计时间

| 批次 | 接口数 | 预计时间 | 累计时间 |
|-----|-------|---------|---------|
| 第一批 (P0) | 7个 | 1小时 | 1小时 |
| 第二批 (P1) | 13个 | 1.5小时 | 2.5小时 |
| 第三批 (P2) | 21个 | 2.5小时 | 5小时 |
| **总计** | **41个** | **5小时** | **5小时** |

---

## 部署计划

### 云函数部署顺序

1. **course** - 课程模块（9个接口）
2. **order** - 订单模块（7个接口）
3. **user** - 用户模块（10个接口）
4. **ambassador** - 大使模块（6个接口）
5. **system** - 系统模块（5个接口，已部署1个）

### 部署命令

```bash
# 第一批：P0 接口
cloudbase functions:deploy course
cloudbase functions:deploy order
cloudbase functions:deploy user
cloudbase functions:deploy system

# 第二批：P1 接口
# (已包含在上述云函数中)

# 第三批：P2 接口
cloudbase functions:deploy ambassador
# (其他已包含在上述云函数中)
```

---

## 风险控制

### 1. 代码备份
- 改造前创建 Git 分支
- 每批改造后提交一次

### 2. 回滚方案
```bash
# 如果出现问题
git revert HEAD
cloudbase functions:deploy <function-name>
```

### 3. 灰度发布
- 先在测试环境验证
- 再部署到生产环境
- 监控错误日志

---

## 验收标准

### 代码验收
- [ ] 所有接口使用 `executePaginatedQuery`
- [ ] 所有接口返回新字段
- [ ] 所有接口兼容参数命名
- [ ] 保留原有业务逻辑

### 功能验收
- [ ] 所有接口正常返回数据
- [ ] 分页功能正常工作
- [ ] 筛选排序功能正常
- [ ] 性能无明显下降

### 文档验收
- [ ] 更新改造进度表
- [ ] 记录遇到的问题
- [ ] 编写测试报告

---

**创建时间**: 2026-02-14
**执行人员**: Claude Code
**预计完成**: 2026-02-14
