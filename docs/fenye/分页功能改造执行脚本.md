# 分页功能改造执行脚本

## 使用说明

本文档提供分步执行的改造脚本，每个步骤都有详细的代码示例和验证方法。

---

## 阶段一：后端改造

### Step 1: 改造课程模块（5个文件）

#### 1.1 course/handlers/public/getList.js

**改造前**：
```javascript
const { db, findOne, response, getPagination, getTempFileURL } = require('common');

const { offset, limit } = getPagination(page, page_size);

let queryBuilder = db
  .from('courses')
  .select('*', { count: 'exact' })
  .eq('status', 1)
  .range(offset, offset + limit - 1);

const { data: courses, error, count } = await queryBuilder;

return response.success({
  list,
  total: count || 0,
  page,
  page_size
});
```

**改造后**：
```javascript
const { db, findOne, response, executePaginatedQuery, getTempFileURL } = require('common');

let queryBuilder = db
  .from('courses')
  .select('*', { count: 'exact' })
  .eq('status', 1);

const result = await executePaginatedQuery(queryBuilder, page, page_size);

// 处理数据...
const list = await Promise.all((result.list || []).map(async course => {
  // ... 处理逻辑
}));

return response.success({
  ...result,
  list
});
```

**验证命令**：
```bash
# 测试接口
curl -X POST http://localhost/course \
  -H "Content-Type: application/json" \
  -d '{"action":"getList","page":1,"page_size":10}'
```

---

#### 1.2 course/handlers/public/getCaseList.js

**改造要点**：
- 引入 `executePaginatedQuery`
- 移除 `getPagination` 和 `.range()`
- 使用 `result` 对象返回

**完整代码**：
```javascript
const { db, response, executePaginatedQuery, getTempFileURL } = require('common');

module.exports = async (event, context) => {
  const { category, page = 1, page_size = 20 } = event;

  try {
    let queryBuilder = db
      .from('cases')
      .select('*', { count: 'exact' })
      .eq('status', 1)
      .order('created_at', { ascending: false });

    if (category) {
      queryBuilder = queryBuilder.eq('category', category);
    }

    const result = await executePaginatedQuery(queryBuilder, page, page_size);

    // 转换图片URL
    const list = await Promise.all((result.list || []).map(async item => {
      let coverImageUrl = item.cover_image || '';
      if (item.cover_image) {
        try {
          const tempResult = await getTempFileURL(item.cover_image);
          coverImageUrl = tempResult.tempFileURL || item.cover_image;
        } catch (error) {
          console.warn('[getCaseList] 转换临时URL失败:', error.message);
        }
      }
      return { ...item, cover_image: coverImageUrl };
    }));

    return response.success({ ...result, list });
  } catch (error) {
    console.error('[getCaseList] 执行失败:', error);
    return response.error('获取案例列表失败', error);
  }
};
```

---

#### 1.3 course/handlers/public/getMaterialList.js

**改造要点**：同上

**完整代码**：
```javascript
const { db, response, executePaginatedQuery, getTempFileURL } = require('common');

module.exports = async (event, context) => {
  const { category, keyword, page = 1, page_size = 20 } = event;

  try {
    let queryBuilder = db
      .from('materials')
      .select('*', { count: 'exact' })
      .eq('status', 1)
      .order('created_at', { ascending: false });

    if (category) {
      queryBuilder = queryBuilder.eq('category', category);
    }

    if (keyword) {
      queryBuilder = queryBuilder.ilike('title', `%${keyword}%`);
    }

    const result = await executePaginatedQuery(queryBuilder, page, page_size);

    // 转换图片URL
    const list = await Promise.all((result.list || []).map(async item => {
      const images = [];
      if (item.images && Array.isArray(item.images)) {
        for (const fileId of item.images) {
          try {
            const tempResult = await getTempFileURL(fileId);
            images.push(tempResult.tempFileURL || fileId);
          } catch (error) {
            console.warn('[getMaterialList] 转换临时URL失败:', error.message);
            images.push(fileId);
          }
        }
      }
      return { ...item, images };
    }));

    return response.success({ ...result, list });
  } catch (error) {
    console.error('[getMaterialList] 执行失败:', error);
    return response.error('获取资料列表失败', error);
  }
};
```

---

#### 1.4 course/handlers/client/getClassRecords.js

**改造要点**：同上

---

#### 1.5 course/handlers/client/getMyAppointments.js

**改造要点**：同上

---

### Step 2: 改造订单模块（6个文件）

#### 2.1 order/handlers/client/getMallCourses.js

**改造前**：
```javascript
const limit = parseInt(pageSize) || 10;
const offset = (parseInt(page) - 1) * limit;

let queryBuilder = db
  .from('courses')
  .select('*', { count: 'exact' })
  .range(offset, offset + limit - 1);

const { data: courses, error, count: total } = await queryBuilder;

return response.success({
  total: total || 0,
  page: parseInt(page),
  pageSize: parseInt(pageSize),
  list
});
```

**改造后**：
```javascript
const { db, response, executePaginatedQuery, getTempFileURL } = require('common');

module.exports = async (event, context) => {
  const { type, page = 1, page_size = 10 } = event;

  try {
    let queryBuilder = db
      .from('courses')
      .select('*', { count: 'exact' })
      .eq('status', 1)
      .in('type', [1, 2])
      .order('sort_order', { ascending: false })
      .order('id', { ascending: true });

    if (type) {
      queryBuilder = queryBuilder.eq('type', parseInt(type));
    }

    const result = await executePaginatedQuery(queryBuilder, page, page_size);

    // 格式化数据
    const list = await Promise.all((result.list || []).map(async item => {
      let coverImageUrl = item.cover_image || '';
      if (item.cover_image) {
        try {
          const tempResult = await getTempFileURL(item.cover_image);
          coverImageUrl = tempResult.tempFileURL || item.cover_image;
        } catch (error) {
          console.warn('[getMallCourses] 转换临时URL失败:', error.message);
        }
      }

      return {
        id: item.id,
        name: item.name,
        nickname: item.nickname || '',
        type: item.type,
        coverImage: coverImageUrl,
        description: item.description || '',
        teacher: item.teacher || '',
        duration: item.duration || '',
        originalPrice: parseFloat(item.original_price) || 0,
        currentPrice: parseFloat(item.current_price) || 0,
        stock: item.stock,
        soldCount: item.sold_count || 0,
        isUnlimitedStock: item.stock === -1,
        canBuy: item.stock === -1 || item.stock > 0
      };
    }));

    return response.success({ ...result, list }, '获取成功');
  } catch (error) {
    console.error('获取商城课程失败:', error);
    return response.error('获取商城课程失败', error);
  }
};
```

---

#### 2.2 order/handlers/client/getMallGoods.js

**改造要点**：同 getMallCourses.js

---

#### 2.3 order/handlers/client/getList.js

**改造要点**：同上

---

#### 2.4 order/handlers/client/getExchangeRecords.js

**改造要点**：同上

---

### Step 3: 改造用户模块（7个文件）

#### 3.1 user/handlers/client/getMyCourses.js

**改造前**：
```javascript
const { offset, limit } = utils.getPagination(page, pageSize);

const { data: courses, error, count: total } = await db
  .from('user_courses')
  .select('...', { count: 'exact' })
  .range(offset, offset + limit - 1);

return response.success({
  total,
  page,
  pageSize,
  list
});
```

**改造后**：
```javascript
const { db, response, executePaginatedQuery } = require('common');

module.exports = async (event, context) => {
  const { user } = context;
  const { page = 1, page_size = 10 } = event;

  try {
    console.log('[getMyCourses] 获取我的课程:', user.id);

    let queryBuilder = db
      .from('user_courses')
      .select(`
        *,
        course:courses!fk_user_courses_course(
          id, name, type, cover_image, original_price,
          current_price, retrain_price, description,
          duration, teacher, outline
        )
      `, { count: 'exact' })
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });

    const result = await executePaginatedQuery(queryBuilder, page, page_size);

    // 格式化数据
    const list = (result.list || []).map(uc => ({
      id: uc.id,
      user_id: uc.user_id,
      course_id: uc.course_id,
      buy_price: uc.buy_price,
      buy_time: uc.buy_time,
      attend_count: uc.attend_count,
      status: uc.status,
      created_at: uc.created_at,
      title: uc.course?.name,
      cover_image: uc.course?.cover_image,
      type: uc.course?.type,
      original_price: uc.course?.original_price,
      current_price: uc.course?.current_price,
      retrain_price: uc.course?.retrain_price,
      description: uc.course?.description,
      duration: uc.course?.duration,
      teacher: uc.course?.teacher,
      outline: uc.course?.outline
    }));

    console.log('[getMyCourses] 查询成功，共', result.total, '条');
    return response.success({ ...result, list });
  } catch (error) {
    console.error('[getMyCourses] 查询失败:', error);
    return response.error('获取课程列表失败', error);
  }
};
```

---

#### 3.2 user/handlers/client/getMyReferees.js

**改造要点**：同上

---

#### 3.3 user/handlers/client/getCashPointsHistory.js

**改造要点**：同上

---

#### 3.4 user/handlers/client/getMeritPointsHistory.js

**改造要点**：同上

---

#### 3.5 user/handlers/client/getWithdrawRecords.js

**改造要点**：同上

---

#### 3.6 user/handlers/client/getMyOrders.js

**改造要点**：同上

---

### Step 4: 改造系统模块（2个文件）

#### 4.1 system/handlers/client/getAnnouncementList.js

**改造前（使用 query/count）**：
```javascript
const { query, count, response, getPagination } = require('common');

const { limit, offset } = getPagination(page, page_size);

const queryOptions = {
  where: { status: 1 },
  columns: 'id, title, ...',
  limit,
  offset
};

const announcements = await query('announcements', queryOptions);
const total = await count('announcements', { status: 1 });

return response.success({
  list: announcements,
  total: total || 0,
  page: parseInt(page),
  page_size: limitedPageSize
});
```

**改造后（使用 Supabase）**：
```javascript
const { db, response, executePaginatedQuery, getTempFileURL } = require('common');

module.exports = async (event, context) => {
  const { page = 1, page_size = 10 } = event;

  try {
    console.log(`[getAnnouncementList] 获取公告列表, page=${page}, page_size=${page_size}`);

    let queryBuilder = db
      .from('announcements')
      .select('id, title, content, summary, cover_image, category, target_type, is_top, start_time, end_time, view_count, sort_order, published_at, created_at', { count: 'exact' })
      .eq('status', 1)
      .order('is_top', { ascending: false })
      .order('sort_order', { ascending: false })
      .order('published_at', { ascending: false });

    const result = await executePaginatedQuery(queryBuilder, page, page_size);

    // 处理数据
    const list = await Promise.all((result.list || []).map(async a => {
      let coverImageUrl = a.cover_image || '';
      if (a.cover_image) {
        try {
          const tempResult = await getTempFileURL(a.cover_image);
          coverImageUrl = tempResult.tempFileURL || a.cover_image;
        } catch (error) {
          console.warn('[getAnnouncementList] 转换临时URL失败:', error.message);
        }
      }

      return {
        ...a,
        cover_image: coverImageUrl,
        category_text: getCategoryText(a.category),
        target_type_text: getTargetTypeText(a.target_type)
      };
    }));

    return response.success({ ...result, list }, '获取成功');
  } catch (error) {
    console.error('[getAnnouncementList] 失败:', error);
    return response.error('获取公告列表失败', error);
  }
};

function getCategoryText(category) {
  const categoryMap = {
    'general': '普通公告',
    'important': '重要公告',
    'urgent': '紧急公告'
  };
  return categoryMap[category] || '普通公告';
}

function getTargetTypeText(targetType) {
  const targetMap = {
    0: '全部用户',
    1: '学员',
    2: '大使'
  };
  return targetMap[targetType] || '全部用户';
}
```

---

#### 4.2 system/handlers/client/getMyFeedback.js

**改造要点**：同上

---

### Step 5: 改造大使模块（2个文件）

#### 5.1 ambassador/handlers/client/getActivityRecords.js

**改造要点**：同上

---

## 阶段二：前端改造

### Step 1: 更新 API 类型定义

**文件**: `src/api/types.ts`

```typescript
// 更新分页响应接口
export interface PaginationResponse<T = any> {
  list: T[]
  total: number
  page: number
  pageSize: number        // 统一使用驼峰
  totalPages: number      // 新增
  hasMore: boolean        // 新增
  hasPrev: boolean        // 新增
}
```

---

### Step 2: 更新前端页面

#### 2.1 pages/mall/index.vue

**改造前**：
```typescript
const loadMallGoods = async (isLoadMore = false) => {
  const result = await OrderApi.getMallGoods({
    page: page,
    page_size: pageSize
  })

  totalProducts.value = result.total || 0
  hasMore.value = products.value.length < totalProducts.value
}
```

**改造后**：
```typescript
const loadMallGoods = async (isLoadMore = false) => {
  const result = await OrderApi.getMallGoods({
    page: page,
    page_size: pageSize
  })

  totalProducts.value = result.total || 0
  hasMore.value = result.hasMore  // 使用后端返回的字段
}
```

---

#### 2.2 pages/mine/orders/index.vue

**改造前**：
```typescript
const params: any = { page: 1, pageSize: 100 }
```

**改造后**：
```typescript
const params: any = { page: 1, page_size: 100 }  // 统一使用下划线
```

---

#### 2.3 pages/common/announcement/index.vue

**改造前**：
```typescript
announcements.value.push(...result.list)
total.value = result.total
page.value++

if (announcements.value.length >= total.value) {
  finished.value = true
}
```

**改造后**：
```typescript
announcements.value.push(...result.list)
total.value = result.total
page.value++

finished.value = !result.hasMore  // 使用后端返回的字段
```

---

#### 2.4 pages/ambassador/exchange-records/index.vue

**改造要点**：同 announcement

---

#### 2.5 pages/mine/referral-list/index.vue

**改造前**：
```typescript
const result = await UserApi.getMyReferees({
  page: page.value,
  pageSize: pageSize.value  // 驼峰
})

if (referralList.value.length >= result.total) {
  finished.value = true
}
```

**改造后**：
```typescript
const result = await UserApi.getMyReferees({
  page: page.value,
  page_size: pageSize.value  // 改为下划线
})

finished.value = !result.hasMore  // 使用后端返回的字段
```

---

## 阶段三：测试验证

### 测试脚本

#### 后端接口测试

```bash
#!/bin/bash

# 测试课程列表
echo "测试课程列表..."
curl -X POST http://localhost/course \
  -H "Content-Type: application/json" \
  -d '{"action":"getList","page":1,"page_size":10}' | jq

# 测试商城课程
echo "测试商城课程..."
curl -X POST http://localhost/order \
  -H "Content-Type: application/json" \
  -d '{"action":"getMallCourses","page":1,"page_size":10}' | jq

# 测试公告列表
echo "测试公告列表..."
curl -X POST http://localhost/system \
  -H "Content-Type: application/json" \
  -d '{"action":"getAnnouncementList","page":1,"page_size":10}' | jq

# 验证响应格式
echo "验证响应格式..."
# 应该包含: list, total, page, pageSize, totalPages, hasMore, hasPrev
```

---

#### 前端页面测试

```javascript
// 在浏览器控制台执行

// 1. 测试商城页面
// 打开 pages/mall/index.vue
// 检查 console.log 输出的分页数据

// 2. 测试公告列表
// 打开 pages/common/announcement/index.vue
// 滚动到底部，检查是否正确显示"没有更多"

// 3. 测试我的订单
// 打开 pages/mine/orders/index.vue
// 切换 Tab，检查数据是否正确加载
```

---

## 验证清单

### 后端验证

- [ ] 所有接口返回 `hasMore` 字段
- [ ] 所有接口返回 `totalPages` 字段
- [ ] 所有接口返回 `hasPrev` 字段
- [ ] `hasMore` 计算正确（最后一页为 false）
- [ ] `totalPages` 计算正确
- [ ] 空列表返回正确（total=0, hasMore=false）
- [ ] 参数验证正确（page<1 返回错误）

### 前端验证

- [ ] 商城页面加载更多正常
- [ ] 公告列表无限滚动正常
- [ ] 我的订单参数统一为 page_size
- [ ] 推荐人列表参数统一为 page_size
- [ ] 所有页面正确显示"没有更多"
- [ ] 所有页面加载状态正确

---

## 回滚脚本

如果改造后出现问题，执行以下回滚：

```bash
# 1. 回滚 Git 提交
git log --oneline  # 查看提交历史
git revert <commit-hash>  # 回滚指定提交

# 2. 或者重置到改造前
git reset --hard <commit-hash>

# 3. 重新部署云函数
cloudbase functions:deploy --all
```

---

## 完成标志

当以下所有项都完成时，改造完成：

- [ ] 42 个后端接口全部改造完成
- [ ] 9 个前端页面全部改造完成
- [ ] 所有测试用例通过
- [ ] 文档更新完成
- [ ] 代码提交到 Git
- [ ] 部署到生产环境

---

**执行时间**: 预计 5 小时
**执行人员**: 待定
**开始时间**: 待定
**完成时间**: 待定
