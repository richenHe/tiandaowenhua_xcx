# 分页改造快速参考表

## 一、改造模板速查

### 模板 A：Supabase 风格接口改造

**适用于**：已使用 `db.from().select()` 的接口

```javascript
// ❌ 改造前
const { db, response, getPagination } = require('common');
const { offset, limit } = getPagination(page, page_size);

let queryBuilder = db
  .from('table')
  .select('*', { count: 'exact' })
  .range(offset, offset + limit - 1);

const { data, error, count } = await queryBuilder;

return response.success({
  list: data,
  total: count,
  page,
  page_size
});

// ✅ 改造后
const { db, response, executePaginatedQuery } = require('common');

let queryBuilder = db
  .from('table')
  .select('*', { count: 'exact' });

const result = await executePaginatedQuery(queryBuilder, page, page_size);

return response.success(result);
```

---

### 模板 B：query/count 方式改造

**适用于**：使用 `query()` 和 `count()` 的接口

```javascript
// ❌ 改造前
const { query, count, response, getPagination } = require('common');
const { limit, offset } = getPagination(page, page_size);

const list = await query('table', {
  where: { status: 1 },
  limit,
  offset
});

const total = await count('table', { status: 1 });

return response.success({
  list,
  total,
  page,
  page_size
});

// ✅ 改造后
const { db, response, executePaginatedQuery } = require('common');

let queryBuilder = db
  .from('table')
  .select('*', { count: 'exact' })
  .eq('status', 1);

const result = await executePaginatedQuery(queryBuilder, page, page_size);

return response.success(result);
```

---

### 模板 C：带数据处理的改造

**适用于**：需要转换图片 URL 或格式化数据的接口

```javascript
// ✅ 改造后
const { db, response, executePaginatedQuery, getTempFileURL } = require('common');

let queryBuilder = db
  .from('table')
  .select('*', { count: 'exact' })
  .eq('status', 1);

const result = await executePaginatedQuery(queryBuilder, page, page_size);

// 处理数据
const list = await Promise.all((result.list || []).map(async item => {
  // 转换图片 URL
  let coverImageUrl = item.cover_image || '';
  if (item.cover_image) {
    try {
      const tempResult = await getTempFileURL(item.cover_image);
      coverImageUrl = tempResult.tempFileURL || item.cover_image;
    } catch (error) {
      console.warn('转换临时URL失败:', error.message);
    }
  }

  return {
    ...item,
    cover_image: coverImageUrl
  };
}));

return response.success({
  ...result,
  list
});
```

---

## 二、42个接口改造清单

### 课程模块（9个）

| # | 文件路径 | 当前方式 | 改造模板 | 优先级 |
|---|---------|---------|---------|-------|
| 1 | `course/handlers/public/getList.js` | Supabase | 模板 C | P0 |
| 2 | `course/handlers/public/getCaseList.js` | Supabase | 模板 C | P1 |
| 3 | `course/handlers/public/getMaterialList.js` | Supabase | 模板 C | P1 |
| 4 | `course/handlers/client/getClassRecords.js` | Supabase | 模板 A | P1 |
| 5 | `course/handlers/client/getMyAppointments.js` | Supabase | 模板 A | P1 |
| 6 | `course/handlers/admin/getCourseList.js` | query/count | 模板 B | P2 |
| 7 | `course/handlers/admin/getCaseList.js` | query/count | 模板 B | P2 |
| 8 | `course/handlers/admin/getMaterialList.js` | query/count | 模板 B | P2 |
| 9 | `course/handlers/admin/getAppointmentList.js` | query/count | 模板 B | P2 |

### 订单模块（7个）

| # | 文件路径 | 当前方式 | 改造模板 | 优先级 |
|---|---------|---------|---------|-------|
| 10 | `order/handlers/client/getMallCourses.js` | Supabase | 模板 C | P0 |
| 11 | `order/handlers/client/getMallGoods.js` | Supabase | 模板 C | P0 |
| 12 | `order/handlers/client/getList.js` | Supabase | 模板 A | P0 |
| 13 | `order/handlers/client/getExchangeRecords.js` | Supabase | 模板 A | P1 |
| 14 | `order/handlers/admin/getOrderList.js` | query/count | 模板 B | P2 |
| 15 | `order/handlers/admin/getRefundList.js` | Supabase | 模板 A | P2 |
| 16 | `order/handlers/admin/getWithdrawList.js` | Supabase | 模板 A | P2 |

### 用户模块（10个）

| # | 文件路径 | 当前方式 | 改造模板 | 优先级 |
|---|---------|---------|---------|-------|
| 17 | `user/handlers/client/getMyCourses.js` | Supabase | 模板 A | P0 |
| 18 | `user/handlers/client/getMyReferees.js` | Supabase | 模板 A | P1 |
| 19 | `user/handlers/client/getCashPointsHistory.js` | Supabase | 模板 A | P1 |
| 20 | `user/handlers/client/getMeritPointsHistory.js` | Supabase | 模板 A | P1 |
| 21 | `user/handlers/client/getWithdrawRecords.js` | Supabase | 模板 A | P1 |
| 22 | `user/handlers/client/getMyOrders.js` | Supabase | 模板 A | P0 |
| 23 | `user/handlers/admin/getUserList.js` | query/count | 模板 B | P2 |
| 24 | `user/handlers/admin/getRefereeChangeLogs.js` | Supabase | 模板 A | P2 |
| 25 | `user/handlers/client/searchReferees.js` | Supabase | 模板 A | P1 |

### 大使模块（10个）

| # | 文件路径 | 当前方式 | 改造模板 | 优先级 |
|---|---------|---------|---------|-------|
| 26 | `ambassador/handlers/client/getActivityRecords.js` | Supabase | 模板 A | P1 |
| 27 | `ambassador/handlers/admin/getActivityList.js` | query/count | 模板 B | P2 |
| 28 | `ambassador/handlers/admin/getAmbassadorList.js` | query/count | 模板 B | P2 |
| 29 | `ambassador/handlers/admin/getApplicationList.js` | query/count | 模板 B | P2 |
| 30 | `ambassador/handlers/admin/getContractTemplateList.js` | query/count | 模板 B | P2 |
| 31 | `ambassador/handlers/admin/getSignatureList.js` | query/count | 模板 B | P2 |

### 系统模块（6个）

| # | 文件路径 | 当前方式 | 改造模板 | 优先级 |
|---|---------|---------|---------|-------|
| 32 | `system/handlers/client/getAnnouncementList.js` | query/count | 模板 B | P0 |
| 33 | `system/handlers/client/getMyFeedback.js` | Supabase | 模板 A | P1 |
| 34 | `system/handlers/admin/getAdminUserList.js` | query/count | 模板 B | P2 |
| 35 | `system/handlers/admin/getAnnouncementList.js` | query/count | 模板 B | P2 |
| 36 | `system/handlers/admin/getFeedbackList.js` | query/count | 模板 B | P2 |
| 37 | `system/handlers/admin/getNotificationLogs.js` | query/count | 模板 B | P2 |

---

## 三、前端改造清单（9个页面）

| # | 文件路径 | 改造内容 | 优先级 |
|---|---------|---------|-------|
| 1 | `pages/mall/index.vue` | 使用 `result.hasMore` | P0 |
| 2 | `pages/course/my-courses/index.vue` | 使用 `result.hasMore` | P0 |
| 3 | `pages/mine/orders/index.vue` | `pageSize` → `page_size` | P0 |
| 4 | `pages/common/announcement/index.vue` | 使用 `result.hasMore` | P0 |
| 5 | `pages/ambassador/exchange-records/index.vue` | 使用 `result.hasMore` | P1 |
| 6 | `pages/mine/appointments/index.vue` | 使用 `result.hasMore` | P1 |
| 7 | `pages/mine/referral-list/index.vue` | `pageSize` → `page_size` + `hasMore` | P1 |
| 8 | `pages/academy/cases/index.vue` | 使用 `result.hasMore` | P1 |
| 9 | `pages/academy/materials/index.vue` | 使用 `result.hasMore` | P1 |

### 前端改造模板

```typescript
// ❌ 改造前
if (list.value.length >= total.value) {
  finished.value = true
}

// ✅ 改造后
finished.value = !result.hasMore
```

```typescript
// ❌ 改造前
const params = { page: 1, pageSize: 20 }

// ✅ 改造后
const params = { page: 1, page_size: 20 }
```

---

## 四、常见问题速查

### Q1: 如何处理图片 URL 转换？

```javascript
const list = await Promise.all((result.list || []).map(async item => {
  let coverImageUrl = item.cover_image || '';
  if (item.cover_image) {
    try {
      const tempResult = await getTempFileURL(item.cover_image);
      coverImageUrl = tempResult.tempFileURL || item.cover_image;
    } catch (error) {
      console.warn('转换临时URL失败:', error.message);
    }
  }
  return { ...item, cover_image: coverImageUrl };
}));
```

### Q2: 如何处理多个图片？

```javascript
const images = [];
if (item.images && Array.isArray(item.images)) {
  for (const fileId of item.images) {
    try {
      const tempResult = await getTempFileURL(fileId);
      images.push(tempResult.tempFileURL || fileId);
    } catch (error) {
      console.warn('转换临时URL失败:', error.message);
      images.push(fileId);
    }
  }
}
return { ...item, images };
```

### Q3: 如何添加筛选条件？

```javascript
let queryBuilder = db
  .from('table')
  .select('*', { count: 'exact' });

// 添加等值筛选
if (status) {
  queryBuilder = queryBuilder.eq('status', status);
}

// 添加模糊搜索
if (keyword) {
  queryBuilder = queryBuilder.ilike('name', `%${keyword}%`);
}

// 添加范围筛选
if (startDate && endDate) {
  queryBuilder = queryBuilder
    .gte('created_at', startDate)
    .lte('created_at', endDate);
}

const result = await executePaginatedQuery(queryBuilder, page, page_size);
```

### Q4: 如何添加排序？

```javascript
let queryBuilder = db
  .from('table')
  .select('*', { count: 'exact' })
  .order('sort_order', { ascending: false })  // 先按排序字段倒序
  .order('created_at', { ascending: false }); // 再按创建时间倒序
```

### Q5: 如何处理 JOIN 查询？

```javascript
let queryBuilder = db
  .from('user_courses')
  .select(`
    *,
    course:courses!fk_user_courses_course(
      id, name, cover_image, price
    )
  `, { count: 'exact' })
  .eq('user_id', userId);

const result = await executePaginatedQuery(queryBuilder, page, page_size);

// 格式化数据
const list = (result.list || []).map(uc => ({
  id: uc.id,
  course_name: uc.course?.name,
  course_price: uc.course?.price
}));
```

---

## 五、测试命令速查

### 后端测试

```bash
# 测试课程列表
curl -X POST http://localhost/course \
  -H "Content-Type: application/json" \
  -d '{"action":"getList","page":1,"page_size":10}'

# 测试第一页
curl ... -d '{"action":"getList","page":1,"page_size":10}' | jq '.data.hasMore'

# 测试最后一页
curl ... -d '{"action":"getList","page":999,"page_size":10}' | jq '.data.hasMore'

# 测试空列表
curl ... -d '{"action":"getList","page":1,"page_size":10,"type":999}' | jq '.data'

# 验证响应格式
curl ... | jq '.data | keys'
# 应该包含: list, total, page, pageSize, totalPages, hasMore, hasPrev
```

### 前端测试

```javascript
// 在浏览器控制台执行

// 1. 测试分页数据
console.log('分页数据:', result)
console.log('hasMore:', result.hasMore)
console.log('totalPages:', result.totalPages)

// 2. 测试加载更多
// 滚动到底部，观察是否正确显示"没有更多"

// 3. 测试下拉刷新
// 下拉页面，观察数据是否重新加载
```

---

## 六、Git 提交规范

### 提交信息模板

```bash
# 后端改造
git commit -m "refactor(pagination): 统一课程模块分页接口

- 使用 executePaginatedQuery 替代手动分页
- 统一返回格式，新增 hasMore/totalPages/hasPrev 字段
- 涉及接口: getList, getCaseList, getMaterialList

相关文档: docs/分页功能统一改造计划.md"

# 前端改造
git commit -m "refactor(pagination): 更新商城页面分页逻辑

- 使用后端返回的 hasMore 字段
- 统一参数命名为 page_size
- 优化加载更多判断逻辑

相关文档: docs/分页接口对接文档.md"
```

---

## 七、执行顺序建议

### 第一批（P0 优先级，2小时）

1. ✅ `course/handlers/public/getList.js`
2. ✅ `order/handlers/client/getMallCourses.js`
3. ✅ `order/handlers/client/getMallGoods.js`
4. ✅ `order/handlers/client/getList.js`
5. ✅ `user/handlers/client/getMyCourses.js`
6. ✅ `user/handlers/client/getMyOrders.js`
7. ✅ `system/handlers/client/getAnnouncementList.js`
8. ✅ 前端 4 个页面：mall, orders, announcement, my-courses

### 第二批（P1 优先级，2小时）

9. ✅ 课程模块剩余接口（3个）
10. ✅ 订单模块剩余接口（1个）
11. ✅ 用户模块剩余接口（4个）
12. ✅ 大使模块接口（1个）
13. ✅ 系统模块接口（1个）
14. ✅ 前端 5 个页面：exchange-records, appointments, referral-list, cases, materials

### 第三批（P2 优先级，1小时）

15. ✅ 所有管理端接口（16个）

---

## 八、验收标准

### 后端验收

```bash
# 运行测试脚本
bash test-pagination.sh

# 检查点
✓ 所有接口返回 hasMore 字段
✓ 所有接口返回 totalPages 字段
✓ 所有接口返回 hasPrev 字段
✓ hasMore 计算正确
✓ totalPages 计算正确
✓ 空列表处理正确
✓ 参数验证正确
```

### 前端验收

```bash
# 手动测试清单
✓ 商城页面加载更多正常
✓ 公告列表无限滚动正常
✓ 我的订单参数统一
✓ 推荐人列表参数统一
✓ 所有页面正确显示"没有更多"
✓ 所有页面加载状态正确
✓ 所有页面性能流畅
```

---

## 九、紧急回滚

如果出现严重问题，立即执行：

```bash
# 1. 停止部署
cloudbase functions:stop --all

# 2. 回滚代码
git revert HEAD

# 3. 重新部署
cloudbase functions:deploy --all

# 4. 通知团队
echo "分页改造已回滚，请检查问题"
```

---

## 十、相关文档

- [分页工具源码](../cloudfunctions/common/pagination.js)
- [分页接口对接文档](./分页接口对接文档.md)
- [分页功能统一改造计划](./分页功能统一改造计划.md)
- [分页功能改造执行脚本](./分页功能改造执行脚本.md)

---

**最后更新**: 2026-02-14
**维护人员**: 开发团队
