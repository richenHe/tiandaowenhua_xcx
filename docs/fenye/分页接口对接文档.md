# 天道文化小程序 - 分页接口对接文档

## 一、统一分页规范

### 1.1 请求参数（前端 → 后端）

所有列表接口统一使用以下分页参数：

```javascript
{
  page: 1,        // 页码，从 1 开始（必填，默认 1）
  page_size: 20   // 每页数量（必填，默认 20，最大 100）
}
```

### 1.2 响应格式（后端 → 前端）

所有列表接口统一返回以下格式：

```javascript
{
  code: 0,
  message: "success",
  data: {
    list: [],           // 数据数组
    total: 100,         // 总记录数
    page: 1,            // 当前页码
    page_size: 20,      // 每页数量
    totalPages: 5,      // 总页数
    hasMore: true,      // 是否有下一页
    hasPrev: false      // 是否有上一页
  }
}
```

---

## 二、后端分页工具使用

### 2.1 引入分页工具

```javascript
const { executePaginatedQuery, buildPaginationResponse } = require('common');
```

### 2.2 使用方式一：Supabase 查询（推荐）

适用于数据库查询场景：

```javascript
module.exports = async (event, context) => {
  const { page = 1, page_size = 20, keyword } = event;

  try {
    // 构建查询
    let queryBuilder = db
      .from('courses')
      .select('*', { count: 'exact' })  // 必须包含 count: 'exact'
      .eq('status', 1)
      .order('created_at', { ascending: false });

    // 添加筛选条件
    if (keyword) {
      queryBuilder = queryBuilder.ilike('name', `%${keyword}%`);
    }

    // 执行分页查询（自动处理分页逻辑）
    const result = await executePaginatedQuery(queryBuilder, page, page_size);

    // 返回结果
    return response.success(result);

  } catch (error) {
    return response.error('查询失败', error);
  }
};
```

### 2.3 使用方式二：内存数组分页

适用于已获取的数组数据：

```javascript
const { paginateArray } = require('common');

module.exports = async (event, context) => {
  const { page = 1, page_size = 20 } = event;

  try {
    // 获取全部数据
    const allData = await someFunction();

    // 对数组进行分页
    const result = paginateArray(allData, page, page_size);

    return response.success(result);

  } catch (error) {
    return response.error('查询失败', error);
  }
};
```

---

## 三、前端分页组件对接

### 3.1 UniApp 请求示例

```javascript
// pages/course/list.vue
export default {
  data() {
    return {
      list: [],
      total: 0,
      page: 1,
      page_size: 20,
      loading: false,
      finished: false
    }
  },

  onLoad() {
    this.loadData();
  },

  methods: {
    async loadData() {
      if (this.loading || this.finished) return;

      this.loading = true;

      try {
        const res = await uniCloud.callFunction({
          name: 'course',
          data: {
            action: 'getList',
            page: this.page,
            page_size: this.page_size
          }
        });

        if (res.result.code === 0) {
          const { list, total, hasMore } = res.result.data;

          // 追加数据
          this.list = [...this.list, ...list];
          this.total = total;
          this.finished = !hasMore;

          // 加载成功，页码+1
          if (hasMore) {
            this.page++;
          }
        }
      } catch (error) {
        console.error('加载失败', error);
      } finally {
        this.loading = false;
      }
    },

    // 下拉刷新
    onRefresh() {
      this.page = 1;
      this.list = [];
      this.finished = false;
      this.loadData();
    },

    // 上拉加载更多
    onLoadMore() {
      this.loadData();
    }
  }
}
```

### 3.2 使用 uni-ui 分页组件

```vue
<template>
  <view class="page">
    <!-- 列表 -->
    <view class="list">
      <view v-for="item in list" :key="item.id" class="item">
        {{ item.name }}
      </view>
    </view>

    <!-- uni-load-more 加载状态 -->
    <uni-load-more
      :status="loadStatus"
      :content-text="contentText"
      @clickLoadMore="loadData"
    />
  </view>
</template>

<script>
export default {
  data() {
    return {
      list: [],
      page: 1,
      page_size: 20,
      finished: false
    }
  },

  computed: {
    loadStatus() {
      if (this.loading) return 'loading';
      if (this.finished) return 'noMore';
      return 'more';
    },
    contentText() {
      return {
        contentdown: '上拉加载更多',
        contentrefresh: '加载中...',
        contentnomore: '没有更多了'
      }
    }
  }
}
</script>
```

### 3.3 使用 scroll-view 实现

```vue
<template>
  <scroll-view
    scroll-y
    class="scroll-view"
    @scrolltolower="onLoadMore"
    refresher-enabled
    @refresherrefresh="onRefresh"
    :refresher-triggered="refreshing"
  >
    <view v-for="item in list" :key="item.id" class="item">
      {{ item.name }}
    </view>

    <view class="loading-tip">
      <text v-if="loading">加载中...</text>
      <text v-else-if="finished">没有更多了</text>
      <text v-else>上拉加载更多</text>
    </view>
  </scroll-view>
</template>

<script>
export default {
  data() {
    return {
      list: [],
      page: 1,
      page_size: 20,
      loading: false,
      finished: false,
      refreshing: false
    }
  },

  methods: {
    async onRefresh() {
      this.refreshing = true;
      this.page = 1;
      this.list = [];
      this.finished = false;
      await this.loadData();
      this.refreshing = false;
    },

    async onLoadMore() {
      if (!this.loading && !this.finished) {
        await this.loadData();
      }
    }
  }
}
</script>
```

---

## 四、已实现分页的接口清单

### 4.1 课程模块（Course）

| 接口 | 路径 | 说明 |
|-----|------|------|
| 获取课程列表 | `course/getList` | 支持类型筛选、关键词搜索 |
| 获取案例列表 | `course/getCaseList` | 支持分类筛选 |
| 获取资料列表 | `course/getMaterialList` | 支持分类筛选 |
| 获取上课排期 | `course/getClassRecords` | 支持日期筛选 |
| 获取我的预约 | `course/getMyAppointments` | 支持状态筛选 |

**请求示例**：
```javascript
uniCloud.callFunction({
  name: 'course',
  data: {
    action: 'getList',
    page: 1,
    page_size: 20,
    type: 1,           // 可选：课程类型
    keyword: '孙膑'     // 可选：关键词搜索
  }
})
```

### 4.2 订单模块（Order）

| 接口 | 路径 | 说明 |
|-----|------|------|
| 获取商城课程 | `order/getMallCourses` | 积分商城课程列表 |
| 获取商城商品 | `order/getMallGoods` | 积分商城商品列表 |
| 获取订单列表 | `order/getList` | 支持状态筛选 |
| 获取兑换记录 | `order/getExchangeRecords` | 积分兑换记录 |

**请求示例**：
```javascript
uniCloud.callFunction({
  name: 'order',
  data: {
    action: 'getList',
    page: 1,
    page_size: 20,
    status: 1          // 可选：订单状态
  }
})
```

### 4.3 用户模块（User）

| 接口 | 路径 | 说明 |
|-----|------|------|
| 获取我的课程 | `user/getMyCourses` | 已购课程列表 |
| 获取推荐用户 | `user/getMyReferees` | 我推荐的用户 |
| 获取积分明细 | `user/getCashPointsHistory` | 积分变动记录 |
| 获取功德分明细 | `user/getMeritPointsHistory` | 功德分变动记录 |
| 获取提现记录 | `user/getWithdrawRecords` | 提现申请记录 |

**请求示例**：
```javascript
uniCloud.callFunction({
  name: 'user',
  data: {
    action: 'getCashPointsHistory',
    page: 1,
    page_size: 20
  }
})
```

### 4.4 大使模块（Ambassador）

| 接口 | 路径 | 说明 |
|-----|------|------|
| 获取活动列表 | `ambassador/getActivityList` | 大使活动列表 |
| 获取活动记录 | `ambassador/getActivityRecords` | 我的活动记录 |
| 获取大使列表 | `ambassador/getAmbassadorList` | 管理端 |
| 获取申请列表 | `ambassador/getApplicationList` | 管理端 |

**请求示例**：
```javascript
uniCloud.callFunction({
  name: 'ambassador',
  data: {
    action: 'getActivityRecords',
    page: 1,
    page_size: 20
  }
})
```

### 4.5 系统模块（System）

| 接口 | 路径 | 说明 |
|-----|------|------|
| 获取公告列表 | `system/getAnnouncementList` | 系统公告 |
| 获取我的反馈 | `system/getMyFeedback` | 用户反馈记录 |
| 获取管理员列表 | `system/getAdminUserList` | 管理端 |
| 获取反馈列表 | `system/getFeedbackList` | 管理端 |

**请求示例**：
```javascript
uniCloud.callFunction({
  name: 'system',
  data: {
    action: 'getAnnouncementList',
    page: 1,
    page_size: 20
  }
})
```

---

## 五、常见问题

### 5.1 如何实现无限滚动加载？

```javascript
data() {
  return {
    page: 1,
    list: [],
    finished: false
  }
},

methods: {
  async loadMore() {
    if (this.finished) return;

    const res = await this.fetchData(this.page);

    // 追加数据
    this.list = [...this.list, ...res.list];

    // 判断是否还有更多
    this.finished = !res.hasMore;

    // 页码+1
    if (res.hasMore) {
      this.page++;
    }
  }
}
```

### 5.2 如何实现下拉刷新？

```javascript
methods: {
  async onRefresh() {
    // 重置状态
    this.page = 1;
    this.list = [];
    this.finished = false;

    // 重新加载
    await this.loadMore();
  }
}
```

### 5.3 如何处理加载失败？

```javascript
methods: {
  async loadMore() {
    try {
      const res = await this.fetchData(this.page);
      this.list = [...this.list, ...res.list];
      this.finished = !res.hasMore;
      if (res.hasMore) this.page++;
    } catch (error) {
      // 加载失败，不增加页码，允许重试
      uni.showToast({
        title: '加载失败，请重试',
        icon: 'none'
      });
    }
  }
}
```

### 5.4 如何实现分页器（页码跳转）？

```javascript
<template>
  <view class="pagination">
    <button @click="prevPage" :disabled="page === 1">上一页</button>
    <text>{{ page }} / {{ totalPages }}</text>
    <button @click="nextPage" :disabled="!hasMore">下一页</button>
  </view>
</template>

<script>
export default {
  data() {
    return {
      page: 1,
      totalPages: 1,
      hasMore: false,
      list: []
    }
  },

  methods: {
    async loadData() {
      const res = await this.fetchData(this.page);
      this.list = res.list;  // 替换数据，不追加
      this.totalPages = res.totalPages;
      this.hasMore = res.hasMore;
    },

    prevPage() {
      if (this.page > 1) {
        this.page--;
        this.loadData();
      }
    },

    nextPage() {
      if (this.hasMore) {
        this.page++;
        this.loadData();
      }
    }
  }
}
</script>
```

---

## 六、性能优化建议

### 6.1 合理设置 page_size

- **列表页**：建议 10-20 条
- **瀑布流**：建议 20-30 条
- **表格**：建议 20-50 条

### 6.2 使用虚拟列表

对于大数据量列表，使用 `recycle-view` 或 `virtual-list` 组件：

```vue
<recycle-view
  :list="list"
  :item-height="100"
  @loadmore="loadMore"
>
  <template v-slot="{ item }">
    <view class="item">{{ item.name }}</view>
  </template>
</recycle-view>
```

### 6.3 防抖处理

```javascript
methods: {
  loadMore: uni.$u.debounce(async function() {
    // 加载逻辑
  }, 300)
}
```

### 6.4 缓存策略

```javascript
// 使用 uni.setStorageSync 缓存列表数据
methods: {
  async loadData() {
    // 先读取缓存
    const cached = uni.getStorageSync('course_list');
    if (cached) {
      this.list = cached;
    }

    // 请求新数据
    const res = await this.fetchData();
    this.list = res.list;

    // 更新缓存
    uni.setStorageSync('course_list', res.list);
  }
}
```

---

## 七、测试检查清单

- [ ] 首次加载显示正确数据
- [ ] 上拉加载更多正常工作
- [ ] 下拉刷新正常工作
- [ ] 到达最后一页显示"没有更多"
- [ ] 加载失败可以重试
- [ ] 空列表显示正确提示
- [ ] 加载状态显示正确
- [ ] 页码计算正确
- [ ] 数据不重复
- [ ] 性能流畅无卡顿

---

## 八、联系与支持

如有问题，请查看：
- 后端分页工具：`cloudfunctions/common/pagination.js`
- 示例接口：`cloudfunctions/course/handlers/public/getList.js`
- 前端示例：`universal-cloudbase-uniapp-template/src/pages/mall/index.vue`
