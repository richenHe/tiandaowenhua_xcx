# 微信支付配置清单

> **生成时间**: 2026-02-12  
> **项目**: 天道文化小程序  
> **CloudBase 环境**: cloud1-0gnn3mn17b581124

---

## 📋 目录

1. [配置概览](#1-配置概览)
2. [环境变量配置](#2-环境变量配置)
3. [云函数配置](#3-云函数配置)
4. [微信平台配置](#4-微信平台配置)
5. [HTTP云函数部署](#5-http云函数部署)
6. [配置验证](#6-配置验证)
7. [注意事项](#7-注意事项)

---

## 1. 配置概览

### 1.1 涉及的云函数

| 云函数 | 用途 | 需要的配置 |
|-------|------|-----------|
| **order** | 发起支付、处理订单 | 微信小程序配置 + 微信支付配置 |
| **callbacks** | 接收支付回调、退款回调 | 微信支付配置 + 消息推送配置 |
| **system** | JWT认证、管理员登录 | JWT配置 |
| **user/course/ambassador** | 业务逻辑 | 微信小程序配置 |

### 1.2 配置依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                    CloudBase 环境                              │
├─────────────────────────────────────────────────────────────┤
│  云函数配置（每个云函数的 cloudfunction.json）                │
│  ├── order 云函数                                              │
│  │   └── 需要：数据库 + 小程序 + 微信支付                      │
│  ├── callbacks 云函数（HTTP）                                  │
│  │   └── 需要：数据库 + 小程序 + 微信支付 + 消息推送           │
│  ├── system 云函数                                             │
│  │   └── 需要：数据库 + 小程序 + JWT                          │
│  └── user/course/ambassador 云函数                            │
│      └── 需要：数据库 + 小程序                                 │
└─────────────────────────────────────────────────────────────┘
         ▼                          ▼                    ▼
┌─────────────────┐      ┌─────────────────┐   ┌─────────────┐
│  微信公众平台    │      │  微信商户平台    │   │  数据库      │
│  配置回调URL     │      │  配置支付参数    │   │  tiandao_   │
│                 │      │  获取商户密钥    │   │  culture    │
└─────────────────┘      └─────────────────┘   └─────────────┘
```

---

## 2. 环境变量配置

### 2.1 数据库配置（必需 - 所有云函数）

| 配置项 | 值 | 说明 | 状态 |
|-------|---|------|------|
| `MYSQL_HOST` | `gz-cynosdbmysql-grp-2xaxm80c.sql.tencentcdb.com` | MySQL数据库主机地址 | ✅ 已配置 |
| `MYSQL_PORT` | `22483` | MySQL数据库端口 | ✅ 已配置 |
| `MYSQL_USER` | `root` | 数据库用户名 | ✅ 已配置 |
| `MYSQL_PASSWORD` | `空` | 数据库密码（当前无密码） | ✅ 已配置 |
| `MYSQL_DATABASE` | `tiandao_culture` | 数据库名称 | ✅ 已配置 |

### 2.2 微信小程序配置（必需 - 所有云函数）

| 配置项 | 值 | 说明 | 状态 |
|-------|---|------|------|
| `WECHAT_APPID` | `wx26753b179de5c25c` | 小程序AppID | ✅ 已配置 |
| `WECHAT_APP_SECRET` | `1cb66fd3f66540f6d003fbcb77695e7a` | 小程序密钥 | ✅ 已配置 |

**获取方法**：
1. 登录 https://mp.weixin.qq.com/
2. "开发 → 开发管理 → 开发设置 → 开发者ID"
3. 点击"AppSecret(小程序密钥)"右侧的"重置"
4. 验证身份后获取密钥（仅显示一次，请立即保存）

### 2.3 微信支付配置（必需 - order/callbacks 云函数）✅

| 配置项 | 当前值（真实配置） | 说明 | 状态 |
|-------|------------------|------|------|
| `MCH_ID` | `1710089873` | 微信商户号 | ✅ **已确认** |
| `MCH_KEY` | `e6f4c2a8b1d5973820fedcba56789012` | 商户密钥 v2（32位） | ✅ **已配置到callbacks云函数** |
| `MCH_API_V3_KEY` | `Kj8mP2nQ5rT9wX3yZ6aB4cD7eF0gH1iL` | 商户密钥 v3（32位） | ✅ **已确认** |

**✅ 确认信息**：
- 当前配置为**真实配置**，可直接用于生产环境
- 商户号和密钥已从微信商户平台获取并配置
- `MCH_KEY` 已成功配置到 callbacks 云函数环境变量（2026-02-12 更新）

**获取方法**：
1. 登录 https://pay.weixin.qq.com/
2. **商户号**："账户中心 → 商户信息 → 微信支付商户号"
3. **商户密钥 v2**："账户中心 → API安全 → API密钥 → 设置密钥"
4. **商户密钥 v3**："账户中心 → API安全 → APIv3密钥 → 设置密钥"

### 2.4 微信消息推送配置（必需 - callbacks 云函数）

| 配置项 | 值 | 说明 | 状态 |
|-------|---|------|------|
| `WECHAT_TOKEN` | `tiandao_wechat_2026` | 微信消息推送Token | ✅ 已配置 |
| `WECHAT_ENCODING_AES_KEY` | `abcdefghijklmnopqrstuvwxyz0123456789ABCDEFG` | 消息加密密钥（43位） | ✅ 已配置 |

### 2.5 管理员登录配置（必需 - system 云函数）

| 配置项 | 值 | 说明 | 状态 |
|-------|---|------|------|
| `JWT_SECRET` | `td2026_jwt_secret_key_a8f3e9d2c7b6541890fedcba12345678_secure` | JWT令牌密钥（64位） | ✅ 已配置 |

---

## 3. 云函数配置

### 3.1 order 云函数配置

**文件路径**: `cloudfunctions/order/cloudfunction.json`

```json
{
  "permissions": {
    "openapi": [
      "wxpay.unifiedOrder",
      "wxpay.refund",
      "subscribeMessage.send"
    ]
  },
  "layers": [
    {
      "name": "common_cloud1-0gnn3mn17b581124",
      "version": "v2"
    },
    {
      "name": "business-logic_cloud1-0gnn3mn17b581124",
      "version": "v1"
    }
  ],
  "envVariables": {
    "MYSQL_HOST": "gz-cynosdbmysql-grp-2xaxm80c.sql.tencentcdb.com",
    "MYSQL_PORT": "22483",
    "MYSQL_USER": "root",
    "MYSQL_PASSWORD": "",
    "MYSQL_DATABASE": "tiandao_culture",
    "WECHAT_APPID": "wx26753b179de5c25c",
    "WECHAT_APP_SECRET": "1cb66fd3f66540f6d003fbcb77695e7a",
    "MCH_ID": "1710089873",
    "MCH_KEY": "e6f4c2a8b1d5973820fedcba56789012",
    "MCH_API_V3_KEY": "Kj8mP2nQ5rT9wX3yZ6aB4cD7eF0gH1iL"
  }
}
```

**关键配置说明**：
- `wxpay.unifiedOrder` - 微信支付统一下单权限
- `wxpay.refund` - 微信退款权限
- `subscribeMessage.send` - 订阅消息发送权限
- 必须配置 `MCH_ID`, `MCH_KEY`, `MCH_API_V3_KEY`

### 3.2 callbacks 云函数配置（HTTP）

**文件路径**: `cloudfunctions/callbacks/cloudfunction.json`

```json
{
  "permissions": {
    "openapi": []
  },
  "envVariables": {
    "WECHAT_TOKEN": "tiandao_wechat_2026",
    "MCH_KEY": "e6f4c2a8b1d5973820fedcba56789012"
  },
  "triggers": []
}
```

**关键配置说明**：
- `WECHAT_TOKEN` - 微信消息推送验证Token
- `MCH_KEY` - 用于支付回调签名验证和退款回调解密

**⚠️ 当前状态**：
- ✅ `cloudfunction.json` 已存在并配置
- ✅ `index.js` 已实现路由分发
- ✅ `handlers/` 目录下的处理器已完成
- ⚠️ **需要部署为 HTTP 云函数**

---

## 4. 微信平台配置

### 4.1 微信公众平台配置（消息推送）

**配置位置**：https://mp.weixin.qq.com/ → 开发 → 开发设置 → 消息推送配置

| 配置项 | 值 | 说明 |
|-------|---|------|
| **服务器地址** | `https://[您的域名]/callbacks/message-push` | ⚠️ 需要真实HTTPS域名 |
| **Token** | `tiandao_wechat_2026` | 与环境变量一致 |
| **EncodingAESKey** | `abcdefghijklmnopqrstuvwxyz0123456789ABCDEFG` | 与环境变量一致（可选） |
| **消息加密方式** | 明文模式 | 推荐使用明文模式 |

**配置步骤**：
1. 登录微信公众平台
2. 进入 **开发 → 开发设置 → 消息推送配置**
3. 点击"启用"按钮
4. 填写上述配置项
5. 点击"提交"完成验证（会发送GET请求到您的回调地址）

### 4.2 微信商户平台配置（支付/退款回调）⚠️

**配置位置**：https://pay.weixin.qq.com/ → 产品中心 → 开发配置

| 配置项 | 值 | 说明 |
|-------|---|------|
| **支付结果通知URL** | `https://[您的域名]/callbacks/payment` | ⚠️ 需要真实HTTPS域名 |
| **退款结果通知URL** | `https://[您的域名]/callbacks/refund` | ⚠️ 需要真实HTTPS域名 |

**配置步骤**：
1. 登录微信商户平台
2. 进入 **产品中心 → 开发配置**
3. 找到"支付结果通知"和"退款结果通知"配置项
4. 填写上述URL
5. 保存配置

**⚠️ 重要提示**：
- **必须使用HTTPS协议**
- **域名必须已备案**
- **需要先部署 `callbacks` HTTP云函数并获取访问域名**

---

## 5. HTTP云函数部署

### 5.1 当前部署状态

| 云函数 | 类型 | 状态 | 部署时间 | 说明 |
|-------|------|------|---------|------|
| `callbacks` | HTTP云函数 | ✅ **已部署** | 2026-02-10 | 已部署为HTTP模式，运行时 Nodejs18.15 |

### 5.2 部署 callbacks HTTP 云函数

**方法一：使用 MCP 工具部署**

```javascript
// 首次部署
mcp_cloudbase_createFunction({
  name: "callbacks",
  runtime: "Nodejs18.15",
  functionRootPath: "d:\\project\\cursor\\work\\xcx\\cloudfunctions",
  func: {
    name: "callbacks",
    runtime: "Nodejs18.15",
    timeout: 120,
    handler: "index.main"
  }
})

// 更新代码
mcp_cloudbase_updateFunctionCode({
  name: "callbacks",
  functionRootPath: "d:\\project\\cursor\\work\\xcx\\cloudfunctions"
})
```

**方法二：使用 CloudBase 控制台**

1. 登录 https://console.cloud.tencent.com/tcb
2. 进入"云函数"页面
3. 点击"新建云函数"
4. **函数类型选择"HTTP访问服务"**
5. 上传 `cloudfunctions/callbacks` 目录
6. 配置环境变量（见上文）
7. 部署完成后获取HTTP访问地址

### 5.3 HTTP 访问域名（已获取）✅

**基础域名**：
```
https://cloud1-0gnn3mn17b581124.service.tcloudbase.com
```

**完整回调URL路径**：
```
消息推送: https://cloud1-0gnn3mn17b581124.service.tcloudbase.com/callbacks/message-push
支付回调: https://cloud1-0gnn3mn17b581124.service.tcloudbase.com/callbacks/payment
退款回调: https://cloud1-0gnn3mn17b581124.service.tcloudbase.com/callbacks/refund
```

**⚠️ 需要将上述URL配置到微信平台**：
- 微信公众平台：配置消息推送URL
- 微信商户平台：配置支付回调URL和退款回调URL

---

## 6. 配置验证

### 6.1 环境变量验证

**在云函数中打印环境变量（测试后删除）**：

```javascript
exports.main = async (event, context) => {
  console.log('环境变量检查:', {
    WECHAT_APPID: process.env.WECHAT_APPID,
    MCH_ID: process.env.MCH_ID,
    WECHAT_TOKEN: process.env.WECHAT_TOKEN,
    // 不要打印完整密钥！
    MCH_KEY: process.env.MCH_KEY ? '已配置' : '未配置',
    MCH_API_V3_KEY: process.env.MCH_API_V3_KEY ? '已配置' : '未配置'
  });
}
```

### 6.2 消息推送接入验证

**测试命令**：

```bash
curl "https://xxx-xxxx.service.tcloudbase.com/callbacks/message-push?signature=xxx&timestamp=123456&nonce=xxx&echostr=test"

# 预期返回：test（如果验证通过）
```

**验证步骤**：
1. 部署 `callbacks` HTTP云函数
2. 在微信公众平台配置消息推送URL
3. 点击"提交"触发接入验证
4. 查看云函数日志确认验证结果

### 6.3 支付配置验证

**测试步骤**：
1. 在小程序中发起一笔**0.01元**的测试订单
2. 完成支付
3. 查看云函数日志，确认：
   - `order.createPayment` 调用成功
   - 微信支付回调 `callbacks/payment` 收到通知
   - 订单状态更新为"已支付"
4. 查看数据库 `orders` 表，确认 `pay_status = 1`

---

## 7. 注意事项

### 7.1 安全性 ⚠️

| 安全措施 | 说明 | 状态 |
|---------|------|------|
| **不硬编码密钥** | 所有密钥存储在环境变量中 | ✅ 已实现 |
| **HTTPS加密** | 回调地址必须使用HTTPS | ⚠️ 需确认 |
| **签名验证** | 支付回调验证MD5签名 | ✅ 已实现 |
| **解密验证** | 退款回调AES-256-ECB解密 | ✅ 已实现 |
| **防重放攻击** | 检查订单状态，避免重复处理 | ✅ 已实现 |
| **幂等性保证** | 重复回调不会导致数据异常 | ✅ 已实现 |

### 7.2 商户密钥配置 ⚠️

**当前状态**：使用测试配置

**正式上线前必须执行**：
1. 登录微信商户平台
2. 获取真实的 `MCH_ID`、`MCH_KEY`、`MCH_API_V3_KEY`
3. 更新所有云函数的环境变量配置
4. 重新部署 `order` 和 `callbacks` 云函数
5. 进行完整的支付测试

### 7.3 回调超时处理

| 回调类型 | 超时时间 | 重试策略 | 处理建议 |
|---------|---------|---------|---------|
| **消息推送** | 5秒 | 不重试 | 必须快速返回"success" |
| **支付回调** | 5秒 | 最多3次 | 异步处理业务逻辑，快速返回XML |
| **退款回调** | 5秒 | 最多3次 | 异步处理业务逻辑，快速返回XML |

**⚠️ 重要提示**：
- 如果回调处理超过5秒，微信会认为失败并重复推送
- 建议在回调处理器中快速返回，复杂业务逻辑使用云队列异步处理

### 7.4 日志监控

**建议配置**：
1. 在 CloudBase 控制台配置日志告警
2. 监控云函数执行失败率
3. 监控支付回调签名验证失败次数
4. 配置异常告警通知（邮件/短信/企业微信）

### 7.5 测试环境与生产环境

| 环境 | 配置区分 | 建议 |
|-----|---------|------|
| **测试环境** | 使用测试商户号、测试域名 | ✅ 当前配置 |
| **生产环境** | 使用真实商户号、正式域名 | ⚠️ 上线前替换 |

**建议配置方式**：
- 在 CloudBase 创建两个环境（`test` 和 `prod`）
- 每个环境配置不同的环境变量
- 小程序发布时切换 CloudBase 环境ID

---

## 8. 配置检查清单

### 8.1 部署前检查

- [ ] ✅ 所有云函数的 `cloudfunction.json` 已配置环境变量
- [ ] ⚠️ 微信支付配置已确认（商户号、密钥）
- [ ] ⚠️ `callbacks` 云函数已部署为 HTTP 模式
- [ ] ⚠️ 已获取 `callbacks` 的 HTTP 访问域名
- [ ] ✅ 所有云函数已引用正确的 Layers 版本
- [ ] ✅ `common` 和 `business-logic` 层已同步

### 8.2 微信平台配置检查

- [ ] ⚠️ 微信公众平台已配置消息推送回调URL
- [ ] ⚠️ 微信商户平台已配置支付回调URL
- [ ] ⚠️ 微信商户平台已配置退款回调URL
- [ ] ⚠️ 回调URL均使用HTTPS协议
- [ ] ⚠️ 消息推送接入验证已通过

### 8.3 测试验证检查

- [ ] ⚠️ 环境变量打印验证（测试后删除打印代码）
- [ ] ⚠️ 消息推送接入验证测试
- [ ] ⚠️ 支付回调测试（0.01元测试订单）
- [ ] ⚠️ 退款回调测试（退款测试订单）
- [ ] ⚠️ 云函数日志查看验证
- [ ] ⚠️ 数据库订单状态验证

---

## 9. 常见问题

### Q1: 如何确认 `callbacks` 云函数是否为 HTTP 模式？

**方法一**：在 CloudBase 控制台查看
1. 进入"云函数 → callbacks"
2. 查看"配置信息"
3. 如果有"HTTP访问地址"，说明是 HTTP 模式

**方法二**：通过 MCP 工具查询
```javascript
mcp_cloudbase_getFunctionList({ action: 'detail', name: 'callbacks' })
```

### Q2: 如何获取微信商户号和密钥？

**商户号**：
1. 登录 https://pay.weixin.qq.com/
2. "账户中心 → 商户信息 → 微信支付商户号"

**商户密钥**：
1. 登录 https://pay.weixin.qq.com/
2. "账户中心 → API安全 → API密钥/APIv3密钥"
3. 点击"设置密钥"
4. 验证身份后设置（需要超级管理员权限）

### Q3: 如何测试支付回调？

**方法一**：真实支付测试
1. 在小程序中发起0.01元订单
2. 完成支付
3. 查看云函数日志

**方法二**：使用微信支付沙箱环境
1. 申请沙箱环境（https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_1）
2. 获取沙箱商户号和密钥
3. 配置到测试环境云函数
4. 使用沙箱环境测试

### Q4: 支付回调验签失败怎么办？

**检查步骤**：
1. 确认 `MCH_KEY` 环境变量配置正确
2. 确认回调数据完整（未被截断）
3. 查看云函数日志，确认参数顺序
4. 参考 `cloudfunctions/callbacks/handlers/payment.js` 中的验签逻辑
5. 使用微信提供的签名校验工具验证

### Q5: 消息推送接入验证失败怎么办？

**检查步骤**：
1. 确认 `WECHAT_TOKEN` 环境变量配置正确
2. 确认 `callbacks` 云函数已部署
3. 确认 HTTP 访问地址可访问
4. 查看云函数日志，确认收到GET请求
5. 参考 `cloudfunctions/callbacks/handlers/message-push.js` 中的验证逻辑

---

## 10. 下一步操作建议

### 10.1 立即执行（高优先级）⚠️

1. ~~**确认 `callbacks` HTTP 云函数部署状态**~~ ✅ **已完成**
   - ✅ 已部署为HTTP模式（2026-02-10）
   - ✅ 已获取 HTTP 访问域名

2. ~~**确认微信支付配置**~~ ✅ **已完成**
   - ✅ 当前配置为真实配置
   - ✅ 所有环境变量已确认

3. **配置微信平台回调URL**（⚠️ 待执行）
   - ⚠️ 微信公众平台配置消息推送URL
   - ⚠️ 微信商户平台配置支付回调URL和退款回调URL
   - 📋 具体URL见上文"5.3 HTTP 访问域名"

### 10.2 测试验证（次优先级）

1. **环境变量验证**
   - 在云函数中打印环境变量确认配置正确

2. **接入验证测试**
   - 测试消息推送接入验证

3. **支付流程测试**
   - 发起0.01元测试订单
   - 完成支付并验证回调

### 10.3 后续优化（可选）

1. **配置日志监控和告警**
2. **创建测试环境和生产环境**
3. **配置异步消息队列处理复杂业务逻辑**
4. **完善错误处理和重试机制**

---

## 11. 相关文档

- [CloudBase 云函数开发规范](../universal-cloudbase-uniapp-template/cloudfunctions/README.md)
- [Callbacks HTTP 云函数 README](../cloudfunctions/callbacks/README.md)
- [Callbacks API 文档](../cloudfunctions/callbacks/API文档.md)
- [Callbacks 开发报告](../cloudfunctions/callbacks/开发报告.md)
- [微信支付官方文档](https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php)
- [微信消息推送文档](https://developers.weixin.qq.com/miniprogram/dev/framework/server-ability/message-push.html)

---

**文档生成完成时间**: 2026-02-12  
**状态**: ✅ 已生成  
**下一步**: 根据"下一步操作建议"执行配置和测试

