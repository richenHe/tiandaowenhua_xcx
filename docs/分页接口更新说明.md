# 分页接口统一更新说明

## 更新内容

已创建统一的分页工具 `cloudfunctions/common/pagination.js`，提供以下功能：

### 1. 核心函数

- `parsePagination(page, pageSize, maxPageSize)` - 解析和验证分页参数
- `buildPaginationResponse(list, total, page, pageSize)` - 构建统一的分页响应
- `executePaginatedQuery(queryBuilder, page, pageSize)` - 执行 Supabase 分页查询
- `paginateArray(array, page, pageSize)` - 对内存数组进行分页

### 2. 统一响应格式

```javascript
{
  list: [],           // 数据数组
  total: 100,         // 总记录数
  page: 1,            // 当前页码
  pageSize: 20,       // 每页数量（统一使用驼峰命名）
  totalPages: 5,      // 总页数
  hasMore: true,      // 是否有下一页
  hasPrev: false      // 是否有上一页
}
```

## 需要更新的接口列表

### 已使用 Supabase 风格的接口（推荐使用 executePaginatedQuery）

1. **course/handlers/public/getList.js** - 课程列表
2. **course/handlers/public/getCaseList.js** - 案例列表
3. **course/handlers/public/getMaterialList.js** - 资料列表
4. **order/handlers/client/getMallCourses.js** - 商城课程
5. **user/handlers/client/getMyCourses.js** - 我的课程

### 使用旧 query/count 方式的接口（需要改造为 Supabase 风格）

1. **system/handlers/client/getAnnouncementList.js** - 公告列表
2. **course/handlers/admin/getCourseList.js** - 管理端课程列表
3. **course/handlers/admin/getCaseList.js** - 管理端案例列表
4. **course/handlers/admin/getMaterialList.js** - 管理端资料列表
5. **order/handlers/admin/getOrderList.js** - 管理端订单列表
6. **user/handlers/admin/getUserList.js** - 管理端用户列表
7. **ambassador/handlers/admin/getAmbassadorList.js** - 管理端大使列表

## 更新步骤

### 方式一：使用 executePaginatedQuery（推荐）

**适用于**：Supabase 风格查询

**修改前**：
```javascript
const { offset, limit } = getPagination(page, page_size);

let queryBuilder = db
  .from('courses')
  .select('*', { count: 'exact' })
  .eq('status', 1)
  .range(offset, offset + limit - 1);

const { data, error, count } = await queryBuilder;

return response.success({
  list: data,
  total: count,
  page,
  page_size
});
```

**修改后**：
```javascript
const { executePaginatedQuery } = require('common');

let queryBuilder = db
  .from('courses')
  .select('*', { count: 'exact' })
  .eq('status', 1);

const result = await executePaginatedQuery(queryBuilder, page, page_size);

return response.success(result);
```

### 方式二：改造为 Supabase 风格

**适用于**：使用旧 query/count 方式的接口

**修改前**：
```javascript
const { query, count, getPagination } = require('common');

const { limit, offset } = getPagination(page, page_size);

const list = await query('announcements', {
  where: { status: 1 },
  limit,
  offset
});

const total = await count('announcements', { status: 1 });

return response.success({
  list,
  total,
  page,
  page_size
});
```

**修改后**：
```javascript
const { db, executePaginatedQuery } = require('common');

let queryBuilder = db
  .from('announcements')
  .select('*', { count: 'exact' })
  .eq('status', 1);

const result = await executePaginatedQuery(queryBuilder, page, page_size);

return response.success(result);
```

## 参数命名统一

### 请求参数（保持兼容）

支持以下两种命名方式（自动兼容）：
- `page_size`（下划线，推荐）
- `pageSize`（驼峰）

### 响应参数（统一使用驼峰）

```javascript
{
  page: 1,
  pageSize: 20,      // 统一使用驼峰
  total: 100,
  totalPages: 5,
  hasMore: true,
  hasPrev: false,
  list: []
}
```

## 注意事项

1. **保持向后兼容**：现有接口的 `page_size` 参数继续支持
2. **响应格式增强**：新增 `totalPages`、`hasMore`、`hasPrev` 字段
3. **性能优化**：使用 Supabase 的 `count: 'exact'` 一次查询获取总数
4. **错误处理**：统一在 `executePaginatedQuery` 中处理错误

## 测试清单

更新接口后，请测试以下场景：

- [ ] 第一页数据正确
- [ ] 最后一页数据正确
- [ ] `hasMore` 字段正确
- [ ] `totalPages` 计算正确
- [ ] 空列表返回正确
- [ ] 参数验证正确（page < 1, pageSize > 100）
- [ ] 筛选条件正常工作
- [ ] 排序正常工作

## 前端对接

前端可以使用新增的字段简化逻辑：

```javascript
// 判断是否还有更多数据
if (res.data.hasMore) {
  this.page++;
  this.loadMore();
}

// 显示总页数
console.log(`当前第 ${res.data.page} 页，共 ${res.data.totalPages} 页`);

// 判断是否可以上一页
if (res.data.hasPrev) {
  this.showPrevButton = true;
}
```

## 示例代码

完整示例请参考：
- `cloudfunctions/common/pagination.js` - 分页工具
- `docs/分页接口对接文档.md` - 详细文档
