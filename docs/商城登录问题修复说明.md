# å•†åŸç™»å½•é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜ç°è±¡

ç”¨æˆ·å·²ç™»å½•çš„æƒ…å†µä¸‹ï¼Œç‚¹å‡»"å•†åŸ"æ¨¡å—æ—¶æç¤º"è¯·å…ˆç™»å½•"ï¼Œä½†å…¶ä»–æ¨¡å—ï¼ˆå¦‚è¯¾ç¨‹åˆ—è¡¨ï¼‰æ­£å¸¸å·¥ä½œã€‚

## é—®é¢˜æ ¹æº

é€šè¿‡æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—å‘ç°ï¼š

### âŒ é—®é¢˜è¡¨ç°
- `order` äº‘å‡½æ•°çš„ `getMallCourses` æ¥å£æ”¶åˆ°ï¼š`{ openid: 'undefined' }`
- `course` äº‘å‡½æ•°çš„ `getList` æ¥å£æ”¶åˆ°ï¼š`{ openid: '075328' }` âœ…

### ğŸ” æ ¹æœ¬åŸå› 

**SDK ä¸åŒ¹é…é—®é¢˜**ï¼š

1. **`order` äº‘å‡½æ•°**ä½¿ç”¨äº† `wx-server-sdk`ï¼š
```javascript
const cloud = require('wx-server-sdk');
const OPENID = cloud.getWXContext().OPENID; // âŒ è¿”å› undefined
```

2. **`course` äº‘å‡½æ•°**ä½¿ç”¨äº† `@cloudbase/node-sdk`ï¼š
```javascript
const cloudbase = require('@cloudbase/node-sdk');
const app = cloudbase.init({ env: cloudbase.SYMBOL_CURRENT_ENV });
const auth = app.auth();
const userInfo = auth.getUserInfo(); // âœ… æ­£ç¡®è·å–ç”¨æˆ·ä¿¡æ¯
```

3. **å‰ç«¯ä½¿ç”¨çš„æ˜¯ CloudBase SDK**ï¼š
```typescript
import { app } from '@/utils/cloudbase'
app.callFunction({ name: 'order', data: { action: 'getMallCourses' } })
```

**é—®é¢˜æ ¸å¿ƒ**ï¼š
- `wx-server-sdk` ä¸»è¦ç”¨äº**å¾®ä¿¡å°ç¨‹åºäº‘å¼€å‘**ç¯å¢ƒ
- `@cloudbase/node-sdk` ç”¨äº**è…¾è®¯äº‘ CloudBase** ç¯å¢ƒ
- å‰ç«¯ä½¿ç”¨ `@cloudbase/js-sdk` è°ƒç”¨äº‘å‡½æ•°æ—¶ï¼Œä½¿ç”¨ `wx-server-sdk` çš„ `cloud.getWXContext()` æ— æ³•æ­£ç¡®è·å–ç”¨æˆ·èº«ä»½

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹ `order` äº‘å‡½æ•°å…¥å£æ–‡ä»¶

**æ–‡ä»¶**ï¼š`cloudfunctions/order/index.js`

**ä¿®æ”¹å‰**ï¼š
```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });

// è·å–ç”¨æˆ· OPENID
const OPENID = test_openid || cloud.getWXContext().OPENID;
```

**ä¿®æ”¹å**ï¼š
```javascript
const cloudbase = require('@cloudbase/node-sdk');
const cloud = require('wx-server-sdk');

// åˆå§‹åŒ– CloudBase (ç”¨äºè·å–ç”¨æˆ·èº«ä»½)
const app = cloudbase.init({ env: cloudbase.SYMBOL_CURRENT_ENV });
const auth = app.auth();

// åˆå§‹åŒ– wx-server-sdk (ç”¨äºå¾®ä¿¡æ”¯ä»˜)
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });

// åœ¨ exports.main ä¸­è·å–ç”¨æˆ·ä¿¡æ¯
let OPENID = test_openid;
if (!OPENID) {
  const userInfo = auth.getUserInfo();
  if (userInfo && userInfo.openId) {
    OPENID = userInfo.openId;
  } else if (userInfo && userInfo.uid) {
    OPENID = userInfo.uid;
  } else if (userInfo && userInfo.customUserId) {
    OPENID = userInfo.customUserId;
  }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä¿ç•™ `wx-server-sdk`ï¼ˆç”¨äºå¾®ä¿¡æ”¯ä»˜åŠŸèƒ½ï¼‰
- âœ… å¢åŠ  `@cloudbase/node-sdk`ï¼ˆç”¨äºè·å–ç”¨æˆ·èº«ä»½ï¼‰
- âœ… ä½¿ç”¨ `auth.getUserInfo()` è·å–å½“å‰è°ƒç”¨è€…èº«ä»½
- âœ… å…¼å®¹å¤šç§èº«ä»½æ ‡è¯†ï¼ˆopenId/uid/customUserIdï¼‰

### 2. éƒ¨ç½²æ›´æ–°

```bash
# å·²é€šè¿‡ MCP å·¥å…·æ›´æ–°äº‘å‡½æ•°ä»£ç 
tcb fn deploy order
```

## éªŒè¯æ–¹æ³•

### 1. æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—

```bash
# æŸ¥çœ‹ order äº‘å‡½æ•°æ—¥å¿—
tcb fn log order
```

**é¢„æœŸç»“æœ**ï¼š
```
[Order/getMallCourses] æ”¶åˆ°è¯·æ±‚: { openid: '075328' }  // âœ… ä¸å†æ˜¯ 'undefined'
```

### 2. å‰ç«¯æµ‹è¯•

1. ç™»å½•å°ç¨‹åº
2. ç‚¹å‡»åº•éƒ¨"å•†åŸ"tab
3. åº”è¯¥èƒ½æ­£å¸¸åŠ è½½å•†åŸå•†å“å’Œè¯¾ç¨‹åˆ—è¡¨
4. ä¸å†å‡ºç°"è¯·å…ˆç™»å½•"çš„æç¤º

## å…¶ä»–éœ€è¦æ£€æŸ¥çš„äº‘å‡½æ•°

å»ºè®®æ£€æŸ¥æ‰€æœ‰äº‘å‡½æ•°æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„ SDKï¼š

- âœ… `course` - å·²ä½¿ç”¨ `@cloudbase/node-sdk`
- âœ… `order` - å·²ä¿®å¤ä¸º `@cloudbase/node-sdk`
- âš ï¸ `user` - éœ€è¦æ£€æŸ¥
- âš ï¸ `ambassador` - éœ€è¦æ£€æŸ¥
- âš ï¸ `system` - éœ€è¦æ£€æŸ¥
- âš ï¸ `callbacks` - éœ€è¦æ£€æŸ¥

### æ£€æŸ¥å‘½ä»¤

```javascript
// æŸ¥çœ‹äº‘å‡½æ•°å…¥å£æ–‡ä»¶çš„ SDK ä½¿ç”¨æƒ…å†µ
grep -r "require('wx-server-sdk')" cloudfunctions/*/index.js
grep -r "require('@cloudbase/node-sdk')" cloudfunctions/*/index.js
```

## æœ€ä½³å®è·µ

### äº‘å‡½æ•° SDK é€‰æ‹©åŸåˆ™

1. **CloudBase ç¯å¢ƒï¼ˆæ¨èï¼‰**ï¼š
   - ä½¿ç”¨ `@cloudbase/node-sdk`
   - å‰ç«¯ä½¿ç”¨ `@cloudbase/js-sdk` æˆ– `@cloudbase/adapter-uni-app`
   - æ›´å¥½çš„è·¨å¹³å°æ”¯æŒï¼ˆWebã€å°ç¨‹åºã€Appï¼‰

2. **å¾®ä¿¡å°ç¨‹åºäº‘å¼€å‘**ï¼š
   - ä½¿ç”¨ `wx-server-sdk`
   - å‰ç«¯ä½¿ç”¨ `wx-server-sdk`ï¼ˆå°ç¨‹åºç«¯ï¼‰
   - ä»…é™å¾®ä¿¡å°ç¨‹åºç¯å¢ƒ

3. **æ··åˆä½¿ç”¨**ï¼š
   - ä¸»è¦é€»è¾‘ä½¿ç”¨ `@cloudbase/node-sdk`
   - å¾®ä¿¡æ”¯ä»˜ç­‰ç‰¹å®šåŠŸèƒ½ä½¿ç”¨ `wx-server-sdk`
   - æœ¬æ¬¡ä¿®å¤é‡‡ç”¨æ­¤æ–¹æ¡ˆ

### ç”¨æˆ·èº«ä»½è·å–è§„èŒƒ

```javascript
// âœ… æ¨è - CloudBase Node SDK
const cloudbase = require('@cloudbase/node-sdk');
const app = cloudbase.init({ env: cloudbase.SYMBOL_CURRENT_ENV });
const auth = app.auth();

exports.main = async (event, context) => {
  const userInfo = auth.getUserInfo();
  const OPENID = userInfo?.openId || userInfo?.uid || userInfo?.customUserId;
  // ... ä¸šåŠ¡é€»è¾‘
};

// âŒ ä¸æ¨è - åœ¨ CloudBase ç¯å¢ƒä¸‹ä½¿ç”¨ wx-server-sdk
const cloud = require('wx-server-sdk');
const OPENID = cloud.getWXContext().OPENID; // å¯èƒ½è¿”å› undefined
```

## ç›¸å…³æ–‡æ¡£

- [CloudBase Node SDK æ–‡æ¡£](https://docs.cloudbase.net/api-reference/server/node-sdk/introduction.html)
- [CloudBase ç”¨æˆ·è®¤è¯](https://docs.cloudbase.net/authentication/introduction.html)
- [å¾®ä¿¡äº‘å¼€å‘æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)

## ä¿®å¤æ—¶é—´

- é—®é¢˜å‘ç°ï¼š2026-02-12 13:45
- é—®é¢˜å®šä½ï¼š2026-02-12 13:50
- ä¿®å¤å®Œæˆï¼š2026-02-12 13:55
- éƒ¨ç½²æ—¶é—´ï¼š2026-02-12 13:56

## æ€»ç»“

æ­¤é—®é¢˜çš„æ ¸å¿ƒæ˜¯ **SDK ä¸åŒ¹é…**å¯¼è‡´çš„ç”¨æˆ·èº«ä»½è·å–å¤±è´¥ã€‚åœ¨ CloudBase ç¯å¢ƒä¸‹ï¼Œå¿…é¡»ä½¿ç”¨ `@cloudbase/node-sdk` çš„ `auth.getUserInfo()` æ¥è·å–ç”¨æˆ·èº«ä»½ï¼Œè€Œä¸èƒ½ä¾èµ– `wx-server-sdk` çš„ `cloud.getWXContext()`ã€‚

ä¿®å¤åï¼Œæ‰€æœ‰å•†åŸç›¸å…³æ¥å£éƒ½èƒ½æ­£ç¡®è·å–ç”¨æˆ·èº«ä»½ï¼Œç™»å½•é—®é¢˜å½»åº•è§£å†³ã€‚







