# 天道文化小程序 - 前后端联通实施计划

## 📊 项目当前状态

### ✅ 已完成部分（60%）

1. **后端云函数**（100%完成）
   - 8个云函数模块已部署
   - 121个API接口已实现
   - 完整的业务逻辑层

2. **前端API封装**（100%完成）
   - `src/api/request.ts` - 统一请求封装
   - `src/api/modules/` - 5个模块API（user, course, order, ambassador, system）
   - `src/api/types/` - 完整TypeScript类型定义

3. **核心页面已接入**（约25%完成）
   - ✅ 登录页面（`/pages/auth/login/index.vue`）
   - ✅ 个人中心（`/pages/mine/index.vue`）
   - ✅ 首页（`/pages/index/index.vue`）
   - ✅ 订单确认（`/pages/order/confirm/index.vue`）
   - ✅ 大使等级（`/pages/ambassador/level/index.vue`）
   - ✅ 完善资料（`/pages/auth/complete-profile/index.vue`）【2026-02-11完成】
   - ✅ 个人资料编辑（`/pages/mine/profile/index.vue`）【2026-02-11完成】
   - ❌ 兑换记录（`/pages/ambassador/exchange-records/index.vue`）- 仍为Mock数据
   - ❌ 公告列表（`/pages/common/announcement/index.vue`）- 仍为Mock数据

### 🔄 待完成部分（40%）

**需要接入API的页面：约35个**

---

## 🎯 实施目标

将剩余35个前端页面与后端云函数API完成对接，实现完整的业务流程。

---

## ⚠️ 严格要求

1. **不得修改前端页面任何元素**，只能添加接口，注意别影响到前端页面
2. **每次接入一个页面要和我简单汇报**，并手动触发下一页面的接入
3. **传参必须和前端对齐**，否则经常字段报错
4. **每次完成一个页面需要在计划中标注 ✅ 已完成**，确认自己到哪一步
5. **每次对接完接口要检查字段对齐**：
   - 参考数据库文档：`docs/database/数据库详细信息.md`
   - 参考前端API类型：`src/api/types/` 目录
   - 参考云函数实现：`cloudfunctions/` 目录
   - 确保数据库字段、云函数返回字段、前端类型定义三者一致，不要遗漏字段

## 📝 字段命名规范

**固定命名规则，全项目统一遵循：**

### 1. 前端API参数（传给云函数）✅ 修正
使用 **camelCase（驼峰命名）**：
```typescript
// ✅ 正确 - 前端API参数使用驼峰命名
{
  realName: '张三',
  phone: '13800138000',
  city: '北京',
  avatar: 'https://...',
  gender: '男',
  industry: '互联网',
  birthday: '1990-01-01-12'
}

// ❌ 错误 - 不要使用下划线命名
{
  real_name: '张三',  // 这会导致"缺少必填参数"错误
  phone: '13800138000'
}
```

### 2. 数据库字段
使用 **snake_case（下划线命名）**：
- `real_name`, `phone`, `city`, `avatar`, `gender`, `industry`, `birth_bazi`
- `created_at`, `updated_at`, `profile_completed`
- `ambassador_level`, `merit_points`, `cash_points_available`

### 3. 前端页面变量
使用 **camelCase（驼峰命名）**：
```typescript
// ✅ 正确
const formData = ref({
  realName: '',      // 页面内部变量用驼峰
  phone: '',
  avatarUrl: ''
})

// 调用API时直接传递，保持驼峰命名
await UserApi.updateProfile({
  realName: formData.value.realName,  // ✅ 保持驼峰
  phone: formData.value.phone,
  avatar: formData.value.avatarUrl
})
```

### 4. 云函数参数接收
使用 **camelCase（驼峰命名）**：
```javascript
// 云函数接收参数（驼峰）
module.exports = async (event, context) => {
  const { realName, phone, city, avatar } = event;  // ✅ 驼峰命名
  
  // 存入数据库时转换为下划线
  const updateData = {
    real_name: realName,  // 转换为 snake_case
    phone: phone,
    city: city || '',
    avatar: avatar || ''
  };
};
```

### 5. 云函数返回数据
使用 **snake_case（下划线命名）**，与数据库保持一致：
```javascript
// 云函数返回数据库原始字段
return response.success({
  real_name: user.real_name,
  phone: user.phone,
  profile_completed: 1
})
```

### 6. 命名对照表（修正版）✅

| 数据库字段 | 云函数接收参数 | 前端API参数 | 前端页面变量 | 说明 |
|-----------|--------------|-----------|------------|------|
| real_name | realName | realName | realName | 真实姓名 |
| phone | phone | phone | phone | 手机号 |
| city | city | city | city/region | 城市 |
| avatar | avatar | avatar | avatar/avatarUrl | 头像 |
| gender | gender | gender | gender | 性别 |
| industry | industry | industry | industry | 行业 |
| birth_bazi | birthday | birthday | birthdate | 出生八字 |
| profile_completed | - | - | - | 资料完善状态 |
| ambassador_level | - | - | ambassadorLevel | 大使等级 |
| merit_points | - | - | meritPoints | 功德分 |
| cash_points_available | - | - | cashPoints | 可用积分 |

### 7. 核心原则总结 ⚠️

1. **前端 → 云函数**：始终使用 **camelCase（驼峰命名）**
2. **云函数 → 数据库**：云函数内部转换为 **snake_case（下划线命名）**
3. **数据库字段**：始终使用 **snake_case（下划线命名）**
4. **云函数 → 前端**：返回数据库原始字段（snake_case）

**关键教训**：
- ✅ 前端调用API时使用 `realName`（驼峰）
- ❌ 前端调用API时使用 `real_name`（下划线）会导致"缺少必填参数"错误
- ✅ 云函数接收 `realName`（驼峰），内部转换为 `real_name`（下划线）存数据库

---

## 📋 详细实施计划

### 阶段一：用户模块页面接入（6个页面）

#### 1.1 个人资料编辑页面 ✅ 已完成【2026-02-11】
- **文件路径**: `src/pages/mine/profile/index.vue`
- **接入API**:
  - `UserApi.getProfile()` - 获取用户资料
  - `UserApi.updateProfile()` - 更新用户资料
- **功能点**:
  - 显示当前用户信息（姓名、手机、身份证等）
  - 表单编辑和提交
  - 头像上传（如需要）

#### 1.2 选择推荐人页面
- **文件路径**: `src/pages/order/select-referee/index.vue`
- **接入API**:
  - `UserApi.searchReferee()` - 搜索推荐人
  - `UserApi.updateReferee()` - 更新推荐人
- **功能点**:
  - 搜索推荐人（手机号/姓名）
  - 显示推荐人信息
  - 确认选择

#### 1.3 功德分管理页面
- **文件路径**: `src/pages/ambassador/merit-points/index.vue`
- **接入API**:
  - `UserApi.getMeritPoints()` - 获取功德分余额
  - `UserApi.getMeritPointsRecords()` - 获取功德分记录
- **功能点**:
  - 显示功德分余额
  - 显示收支记录列表
  - 分页加载

#### 1.4 积分管理页面
- **文件路径**: `src/pages/ambassador/cash-points/index.vue`
- **接入API**:
  - `UserApi.getCashPoints()` - 获取积分余额
  - `UserApi.getCashPointsRecords()` - 获取积分记录
- **功能点**:
  - 显示积分余额
  - 显示收支记录列表
  - 分页加载

#### 1.5 申请提现页面
- **文件路径**: `src/pages/ambassador/withdraw/index.vue`
- **接入API**:
  - `UserApi.getCashPoints()` - 获取可提现积分
  - `UserApi.applyWithdrawal()` - 申请提现
  - `UserApi.getWithdrawalRecords()` - 获取提现记录
- **功能点**:
  - 显示可提现金额
  - 提现金额输入和验证
  - 提交提现申请
  - 查看提现记录

#### 1.6 推荐人列表页面
- **文件路径**: `src/pages/mine/referral-list/index.vue`
- **接入API**:
  - `UserApi.getReferralList()` - 获取推荐人列表
- **功能点**:
  - 显示推荐人列表
  - 显示推荐关系层级
  - 分页加载

---

### 阶段二：课程模块页面接入（7个页面）

#### 2.1 课程详情页面 ✅ 已完成【2026-02-11】
- **文件路径**: `src/pages/course/detail/index.vue`
- **接入API**:
  - `CourseApi.getDetail()` - 获取课程详情
- **字段对齐检查**:
  - 数据库: `courses` 表 (name, type, current_price, sold_count, description, outline, teacher)
  - 云函数返回: is_purchased, user_course_id, attend_count (额外字段)
  - 前端变量: courseInfo (已对齐)
- **功能点**:
  - 显示课程详细信息
  - 显示课程价格和购买状态
  - 立即购买按钮（跳转订单确认）

#### 2.2 我的课程页面 ✅ 已完成【2026-02-11】
- **文件路径**: `src/pages/course/my-courses/index.vue`
- **接入API**:
  - `UserApi.getMyCourses()` - 获取我的课程列表
- **字段对齐检查**:
  - 数据库: `user_courses` 表 (course_id, buy_time, attend_count, status)
  - 云函数返回: title, cover_image, type, price (关联 courses 表)
  - 前端变量: courses (已对齐)
- **功能点**:
  - 显示已购买课程列表
  - 课程状态显示（进行中/已完成）
  - 点击查看课程详情

#### 2.3 课程排期页面
- **文件路径**: `src/pages/course/schedule/index.vue`
- **接入API**:
  - `CourseApi.getScheduleList()` - 获取课程排期列表
- **功能点**:
  - 显示课程排期日历
  - 显示每个排期的详细信息
  - 预约按钮

#### 2.4 预约确认页面
- **文件路径**: `src/pages/course/appointment-confirm/index.vue`
- **接入API**:
  - `CourseApi.getScheduleDetail()` - 获取排期详情
  - `CourseApi.createAppointment()` - 创建预约
- **功能点**:
  - 显示排期详细信息
  - 确认预约信息
  - 提交预约

#### 2.5 我的预约页面
- **文件路径**: `src/pages/mine/appointments/index.vue`
- **接入API**:
  - `CourseApi.getMyAppointments()` - 获取我的预约列表
  - `CourseApi.cancelAppointment()` - 取消预约
- **功能点**:
  - 显示预约列表
  - 预约状态显示
  - 取消预约功能

#### 2.6 商学院介绍页面
- **文件路径**: `src/pages/academy/intro/index.vue`
- **接入API**:
  - `CourseApi.getAcademyIntro()` - 获取商学院介绍
- **功能点**:
  - 显示商学院介绍内容
  - 富文本内容展示

#### 2.7 学员案例页面
- **文件路径**: `src/pages/academy/cases/index.vue`
- **接入API**:
  - `CourseApi.getAcademyCases()` - 获取学员案例列表
- **功能点**:
  - 显示学员案例列表
  - 案例详情展示
  - 分页加载

---

### 阶段三：订单模块页面接入（5个页面）

#### 3.1 确认支付页面
- **文件路径**: `src/pages/order/payment/index.vue`
- **接入API**:
  - `OrderApi.getDetail()` - 获取订单详情
  - `OrderApi.pay()` - 发起支付
- **功能点**:
  - 显示订单信息
  - 选择支付方式
  - 发起支付

#### 3.2 订单详情页面
- **文件路径**: `src/pages/order/detail/index.vue`
- **接入API**:
  - `OrderApi.getDetail()` - 获取订单详情
  - `OrderApi.cancel()` - 取消订单
- **功能点**:
  - 显示订单详细信息
  - 订单状态显示
  - 取消订单功能

#### 3.3 我的订单页面
- **文件路径**: `src/pages/mine/orders/index.vue`
- **接入API**:
  - `UserApi.getMyOrders()` - 获取订单列表
- **功能点**:
  - 显示订单列表
  - 订单状态筛选
  - 分页加载

#### 3.4 商城首页
- **文件路径**: `src/pages/mall/index.vue`
- **接入API**:
  - `OrderApi.getMallGoodsList()` - 获取商城商品列表
- **功能点**:
  - 显示商品列表
  - 商品分类筛选
  - 点击查看商品详情

#### 3.5 兑换记录页面（已完成）
- **文件路径**: `src/pages/ambassador/exchange-records/index.vue`
- **状态**: ✅ 已完成

---

### 阶段四：大使模块页面接入（10个页面）

#### 4.1 申请成为大使页面
- **文件路径**: `src/pages/ambassador/apply/index.vue`
- **接入API**:
  - `AmbassadorApi.checkEligibility()` - 检查申请资格
  - `AmbassadorApi.apply()` - 提交申请
  - `AmbassadorApi.getApplicationStatus()` - 获取申请状态
- **功能点**:
  - 显示申请条件
  - 填写申请信息
  - 提交申请

#### 4.2 我的团队页面
- **文件路径**: `src/pages/ambassador/team/index.vue`
- **接入API**:
  - `AmbassadorApi.getTeamMembers()` - 获取团队成员列表
  - `AmbassadorApi.getTeamStats()` - 获取团队统计数据
- **功能点**:
  - 显示团队成员列表
  - 显示团队统计数据
  - 分页加载

#### 4.3 我的二维码页面
- **文件路径**: `src/pages/ambassador/qrcode/index.vue`
- **接入API**:
  - `AmbassadorApi.getQRCode()` - 获取推广二维码
- **功能点**:
  - 显示推广二维码
  - 保存二维码到相册
  - 分享功能

#### 4.4 升级指南页面
- **文件路径**: `src/pages/ambassador/upgrade-guide/index.vue`
- **接入API**:
  - `AmbassadorApi.getLevelConfigs()` - 获取等级配置
  - `AmbassadorApi.getUpgradeProgress()` - 获取升级进度
- **功能点**:
  - 显示各等级要求
  - 显示当前升级进度
  - 升级条件说明

#### 4.5 活动记录页面
- **文件路径**: `src/pages/ambassador/activity-records/index.vue`
- **接入API**:
  - `AmbassadorApi.getActivityRecords()` - 获取活动记录
- **功能点**:
  - 显示活动记录列表
  - 活动详情展示
  - 分页加载

#### 4.6 协议详情页面
- **文件路径**: `src/pages/ambassador/contract-detail/index.vue`
- **接入API**:
  - `AmbassadorApi.getContractTemplate()` - 获取协议模板
- **功能点**:
  - 显示协议内容
  - 富文本展示

#### 4.7 签署协议页面
- **文件路径**: `src/pages/ambassador/contract-sign/index.vue`
- **接入API**:
  - `AmbassadorApi.getContractTemplate()` - 获取协议模板
  - `AmbassadorApi.signContract()` - 签署协议
- **功能点**:
  - 显示协议内容
  - 签名功能
  - 提交签署

#### 4.8 我的协议页面
- **文件路径**: `src/pages/mine/contracts/index.vue`
- **接入API**:
  - `AmbassadorApi.getMyContracts()` - 获取我的协议列表
- **功能点**:
  - 显示已签署协议列表
  - 查看协议详情

#### 4.9 功德分管理页面（已在阶段一）
- **状态**: 见阶段一 1.3

#### 4.10 积分管理页面（已在阶段一）
- **状态**: 见阶段一 1.4

---

### 阶段五：系统模块页面接入（2个页面）

#### 5.1 意见反馈页面
- **文件路径**: `src/pages/mine/feedback/index.vue`
- **接入API**:
  - `SystemApi.submitFeedback()` - 提交反馈
  - `SystemApi.getFeedbackList()` - 获取反馈列表
- **功能点**:
  - 反馈表单
  - 图片上传
  - 提交反馈

#### 5.2 公告详情页面
- **文件路径**: 需要创建 `src/pages/common/announcement/detail.vue`
- **接入API**:
  - `SystemApi.getAnnouncementDetail()` - 获取公告详情
- **功能点**:
  - 显示公告详细内容
  - 富文本展示

---

### 阶段六：完善资料页面接入（1个页面）

#### 6.1 完善资料页面 ✅ 已完成【2026-02-11】
- **文件路径**: `src/pages/auth/complete-profile/index.vue`
- **接入API**:
  - `UserApi.updateProfile()` - 完善资料
- **功能点**:
  - 表单填写（姓名、身份证、推荐人等）
  - 表单验证
  - 提交资料

---

## 🔧 技术实施细节

### API调用标准模式

```typescript
// 1. 导入API模块
import { UserApi, CourseApi, OrderApi, AmbassadorApi, SystemApi } from '@/api';

// 2. 在setup中调用
const loadData = async () => {
  try {
    // 自动显示loading
    const result = await UserApi.getProfile();

    // 处理数据
    // ...
  } catch (error) {
    // 自动显示错误提示
    console.error('加载失败:', error);
  }
};

// 3. 静默调用（不显示loading）
import { callCloudFunctionSilent } from '@/api';

const result = await callCloudFunctionSilent({
  name: 'user',
  action: 'client:getProfile'
});
```

### 分页加载标准模式

```typescript
const page = ref(1);
const pageSize = ref(10);
const list = ref([]);
const total = ref(0);
const loading = ref(false);
const finished = ref(false);

const loadMore = async () => {
  if (loading.value || finished.value) return;

  loading.value = true;
  try {
    const result = await UserApi.getMyOrders({
      page: page.value,
      page_size: pageSize.value
    });

    list.value.push(...result.list);
    total.value = result.total;
    page.value++;

    if (list.value.length >= total.value) {
      finished.value = true;
    }
  } catch (error) {
    console.error('加载失败:', error);
  } finally {
    loading.value = false;
  }
};
```

### 表单提交标准模式

```typescript
const formData = ref({
  real_name: '',
  id_card: '',
  // ...
});

const handleSubmit = async () => {
  // 表单验证
  if (!formData.value.real_name) {
    uni.showToast({ title: '请输入姓名', icon: 'none' });
    return;
  }

  try {
    await UserApi.updateProfile(formData.value);

    uni.showToast({ title: '保存成功', icon: 'success' });

    // 返回上一页或跳转
    setTimeout(() => {
      uni.navigateBack();
    }, 1000);
  } catch (error) {
    // 错误已自动处理
  }
};
```

---

## 📝 关键文件路径

### API模块文件
- `src/api/request.ts` - 请求封装核心
- `src/api/modules/user.ts` - 用户API（17个接口）
- `src/api/modules/course.ts` - 课程API（34个接口）
- `src/api/modules/order.ts` - 订单API（13个接口）
- `src/api/modules/ambassador.ts` - 大使API（26个接口）
- `src/api/modules/system.ts` - 系统API（28个接口）

### 类型定义文件
- `src/api/types/user.ts` - 用户类型
- `src/api/types/course.ts` - 课程类型
- `src/api/types/order.ts` - 订单类型
- `src/api/types/ambassador.ts` - 大使类型
- `src/api/types/system.ts` - 系统类型

### 工具文件
- `src/utils/cloudbase.ts` - 云开发初始化
- `src/utils/request-interceptor.ts` - 响应拦截器

---

## ✅ 验证测试计划

### 功能测试清单

#### 用户模块
- [ ] 登录流程测试
- [ ] 个人资料编辑测试
- [ ] 推荐人选择测试
- [ ] 功德分/积分查询测试
- [ ] 提现申请测试

#### 课程模块
- [ ] 课程列表加载测试
- [ ] 课程详情查看测试
- [ ] 课程购买流程测试
- [ ] 课程预约测试
- [ ] 我的课程查看测试

#### 订单模块
- [ ] 订单创建测试
- [ ] 订单支付测试
- [ ] 订单列表查看测试
- [ ] 订单详情查看测试
- [ ] 商城兑换测试

#### 大使模块
- [ ] 大使申请测试
- [ ] 团队查看测试
- [ ] 二维码生成测试
- [ ] 协议签署测试
- [ ] 升级进度查看测试

#### 系统模块
- [ ] 公告查看测试
- [ ] 反馈提交测试

---

## 📊 进度追踪

### 总体进度
- **已完成**: 8个页面（约20%）
- **待完成**: 35个页面（约80%）
- **预计完成时间**: 根据实际开发速度调整

### 阶段进度
- [ ] 阶段一：用户模块（6个页面）
- [ ] 阶段二：课程模块（7个页面）
- [ ] 阶段三：订单模块（5个页面）
- [ ] 阶段四：大使模块（10个页面）
- [ ] 阶段五：系统模块（2个页面）
- [ ] 阶段六：完善资料（1个页面）
- [ ] 功能测试和优化

---

## 🎯 实施优先级

### 高优先级（核心业务流程）
1. 完善资料页面（登录后必经流程）
2. 课程详情页面（购买入口）
3. 订单支付页面（支付流程）
4. 我的课程页面（学习入口）
5. 课程预约相关页面（核心功能）

### 中优先级（重要功能）
1. 个人资料编辑
2. 大使申请流程
3. 团队管理
4. 订单管理

### 低优先级（辅助功能）
1. 商学院介绍
2. 学员案例
3. 意见反馈
4. 公告详情

---

## 📌 注意事项

1. **API调用规范**
   - 统一使用封装好的API模块
   - 不要直接调用 `app.callFunction`
   - 保持代码风格一致

2. **错误处理**
   - 已有统一的错误拦截器
   - 特殊错误需要单独处理时，在catch中处理

3. **加载状态**
   - 默认会显示loading
   - 需要静默加载时使用 `callCloudFunctionSilent`

4. **类型安全**
   - 充分利用TypeScript类型定义
   - 避免使用any类型

5. **用户体验**
   - 添加适当的加载提示
   - 添加空状态提示
   - 添加错误提示

6. **测试验证**
   - 每完成一个页面立即测试
   - 确保数据正确显示
   - 确保交互流程正常

---

## 🚀 开始实施

建议按照以下顺序实施：

1. **第一批**（高优先级）：完善资料、课程详情、订单支付
2. **第二批**（核心功能）：课程预约、我的课程、订单管理
3. **第三批**（大使功能）：大使申请、团队管理、协议签署
4. **第四批**（辅助功能）：其他页面
5. **第五批**（测试优化）：全面测试和优化

每完成一个阶段，进行测试验证后再进入下一阶段。
