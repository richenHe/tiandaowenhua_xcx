# å¤©é“æ–‡åŒ–å°ç¨‹åº - äº‘å‡½æ•°ç¼–å†™è®¡åˆ’

> **ç‰ˆæœ¬**: V1.1
> **åˆ›å»ºæ—¶é—´**: 2026-02-08
> **æ›´æ–°æ—¶é—´**: 2026-02-09
> **ç›®æ ‡ç›®å½•**: `D:\project\cursor\work\xcx\cloudfunctions`

## âš ï¸ é‡è¦æ‰§è¡Œè§„åˆ™

**æ¯ä¸€æ­¥éª¤æ‰§è¡Œå‰å¿…é¡»éµå¾ªä»¥ä¸‹æµç¨‹ï¼š**

1. **è¯´æ˜é˜¶æ®µ**ï¼šè¯¦ç»†è¯´æ˜æœ¬æ­¥éª¤è¦åšä»€ä¹ˆã€æ¶‰åŠå“ªäº›æ–‡ä»¶ã€é¢„æœŸç»“æœ
2. **ç­‰å¾…ç¡®è®¤**ï¼šç­‰å¾…ç”¨æˆ·ç¡®è®¤æ–¹æ¡ˆ
3. **æ‰§è¡Œé˜¶æ®µ**ï¼šç”¨æˆ·ç¡®è®¤åæ‰èƒ½å¼€å§‹æ‰§è¡Œ
4. **æ€»ç»“é˜¶æ®µ**ï¼šæ‰§è¡Œå®Œæˆåæ€»ç»“ç»“æœï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­ä¸‹ä¸€æ­¥

**ç¦æ­¢è¡Œä¸º**ï¼š
- âŒ æœªç»ç¡®è®¤ç›´æ¥æ‰§è¡Œå¤šä¸ªæ­¥éª¤
- âŒ è·³è¿‡è¯´æ˜ç›´æ¥åˆ›å»ºæ–‡ä»¶
- âŒ å‡è®¾ç”¨æˆ·åŒæ„è€Œè‡ªåŠ¨ç»§ç»­

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

**åœ¨æ‰§è¡Œæœ¬è®¡åˆ’å‰ï¼Œå¿…é¡»ä»”ç»†é˜…è¯»ä»¥ä¸‹å‚è€ƒæ–‡æ¡£ï¼š**

### â­ æ ¸å¿ƒå‚è€ƒæ–‡æ¡£ï¼ˆå¿…è¯» - æŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

**0. [äº‘å‡½æ•°æ ‡å‡†éƒ¨ç½²è§„èŒƒ](../cloudfunctions/äº‘å‡½æ•°æ ‡å‡†éƒ¨ç½²è§„èŒƒ.md)** âš ï¸ **æœ€é‡è¦**
   - âœ… **åŸºäº user äº‘å‡½æ•°æˆåŠŸå®è·µæ€»ç»“**
   - æ ‡å‡†ç›®å½•ç»“æ„å’Œä»£ç ç»„ç»‡
   - æ•°æ®åº“è¿æ¥è§„èŒƒï¼ˆCloudBase SDK rdb()ï¼‰
   - å­—æ®µæ˜ å°„è§„èŒƒï¼ˆreferee_code, cash_points_*ï¼‰
   - å®Œæ•´éƒ¨ç½²æµç¨‹å’Œæµ‹è¯•éªŒè¯
   - å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ
   - **å¼ºåˆ¶è¦æ±‚**ï¼šæ¯ä¸ªäº‘å‡½æ•°å¿…é¡»éµå¾ªæ­¤è§„èŒƒ

1. **[æ•°æ®åº“è¯¦ç»†ä¿¡æ¯](../../docs/database/æ•°æ®åº“è¯¦ç»†ä¿¡æ¯.md)**
   - å®Œæ•´çš„æ•°æ®åº“æ¶æ„ï¼ˆ29å¼ è¡¨ï¼‰
   - æ‰€æœ‰è¡¨çš„å­—æ®µå®šä¹‰ã€ç´¢å¼•ã€çº¦æŸ
   - è¡¨ä¹‹é—´çš„å…³è”å…³ç³»
   - æ•°æ®ç±»å‹å’Œé»˜è®¤å€¼è¯´æ˜

2. **[åç«¯APIæ¥å£æ–‡æ¡£](../../åç«¯APIæ¥å£æ–‡æ¡£.md)**
   - æ‰€æœ‰äº‘å‡½æ•°çš„ action å®šä¹‰
   - æ¥å£å‚æ•°å’Œè¿”å›å€¼è§„èŒƒ
   - æƒé™éªŒè¯è§„åˆ™ï¼ˆpublic/client/adminï¼‰
   - é”™è¯¯ç è§„èŒƒå’Œå“åº”æ ¼å¼
   - ä¸šåŠ¡é€»è¾‘è¯´æ˜

3. **[äº‘å‡½æ•°å¼€å‘è§„èŒƒ](../../universal-cloudbase-uniapp-template/cloudfunctions/README.md)**
   - äº‘å‡½æ•°æ¶æ„æ¨¡å¼ï¼ˆæ¨¡å—ä¼˜å…ˆï¼‰
   - ç›®å½•ç»“æ„å’Œæ–‡ä»¶ç»„ç»‡
   - å…¬å…±å±‚ä½¿ç”¨æ–¹æ³•ï¼ˆcommon + business-logicï¼‰
   - å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ
   - äº‘å­˜å‚¨æ¶æ„å’Œæ–‡ä»¶å‘½åè§„èŒƒ
   - **HTTPäº‘å‡½æ•°ä¸å›è°ƒæ¥å£**ï¼ˆæ–°å¢ï¼‰
   - å®šæ—¶ä»»åŠ¡é…ç½®

### å…¬å…±å±‚ SDK æ–‡æ¡£ï¼ˆå¿…è¯»ï¼‰

4. **[common å±‚æ–‡æ¡£](../../cloudfunctions/layers/common/README.md)**
   - æ•°æ®åº“æ“ä½œï¼šquery, insert, update, softDelete, transaction
   - æƒé™éªŒè¯ï¼šcheckClientAuth, checkAdminAuth
   - å“åº”æ ¼å¼ï¼šsuccessResponse, errorResponse
   - å·¥å…·å‡½æ•°ï¼švalidateRequired, getPagination, generateOrderNo ç­‰

5. **[business-logic å±‚æ–‡æ¡£](../../cloudfunctions/layers/business-logic/README.md)**
   - é…ç½®ç®¡ç†ï¼šgetLevelConfig, getAllLevelConfigs
   - ç§¯åˆ†è®¡ç®—ï¼šcalculateMeritPoints, calculateCashPoints
   - å¤§ä½¿ç®¡ç†ï¼šcheckUpgradeEligibility, processAmbassadorUpgrade
   - å¾®ä¿¡æ”¯ä»˜ï¼šcreateWechatPayment, verifyPaymentCallback, processRefund
   - æ¶ˆæ¯é€šçŸ¥ï¼šsendSubscribeMessage, batchSendSubscribeMessage
   - è®¢å•å¤„ç†ï¼šcheckOrderExpiry, generateUserCourseRecord, generateOrderNo
   - äºŒç»´ç ç”Ÿæˆï¼šgenerateShareQRCode, generateAmbassadorQRCode

### é˜…è¯»é¡ºåºå»ºè®®

```
â­ ç¬¬é›¶æ­¥ï¼šæŒæ¡éƒ¨ç½²è§„èŒƒï¼ˆå¿…è¯»ï¼‰
â””â”€â”€ cloudfunctions/äº‘å‡½æ•°æ ‡å‡†éƒ¨ç½²è§„èŒƒ.md
    ï¼ˆåŸºäº user äº‘å‡½æ•°æˆåŠŸç»éªŒï¼ŒåŒ…å«å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œéƒ¨ç½²æµç¨‹ï¼‰

ç¬¬ä¸€æ­¥ï¼šç†è§£ä¸šåŠ¡éœ€æ±‚
â”œâ”€â”€äº‘å‡½æ•°å¼€å‘è§„èŒƒ.md(äº†è§£æ•´ä¸ªactionæ¨¡å—æ¶æ„å’Œå¿…è¦çš„sdkæ–‡æ¡£å‚è€ƒ)
â”œâ”€â”€ åç«¯APIæ¥å£æ–‡æ¡£.mdï¼ˆäº†è§£æ‰€æœ‰æ¥å£å®šä¹‰å’Œä¸šåŠ¡é€»è¾‘ï¼‰
â””â”€â”€ æ•°æ®åº“è¯¦ç»†ä¿¡æ¯.mdï¼ˆäº†è§£æ•°æ®ç»“æ„å’Œè¡¨å…³ç³»ï¼‰

ç¬¬äºŒæ­¥ï¼šå­¦ä¹ å¼€å‘è§„èŒƒ
â”œâ”€â”€ cloudfunctions/README.mdï¼ˆæŒæ¡äº‘å‡½æ•°æ¶æ„å’Œå¼€å‘è§„èŒƒï¼‰
â”œâ”€â”€ layers/common/README.mdï¼ˆå­¦ä¹ å…¬å…±å·¥å…·å±‚çš„ä½¿ç”¨ï¼‰
â””â”€â”€ layers/business-logic/README.mdï¼ˆå­¦ä¹ ä¸šåŠ¡é€»è¾‘å±‚çš„ä½¿ç”¨ï¼‰

ç¬¬ä¸‰æ­¥ï¼šå¼€å§‹ç¼–å†™ä»£ç 
â”œâ”€â”€ ä¸¥æ ¼éµå¾ª"äº‘å‡½æ•°æ ‡å‡†éƒ¨ç½²è§„èŒƒ.md"
â”œâ”€â”€ ä½¿ç”¨ CloudBase SDK rdb() è¿æ¥æ•°æ®åº“
â”œâ”€â”€ ä½¿ç”¨æ­£ç¡®çš„å­—æ®µåï¼ˆreferee_code, cash_points_*ï¼‰
â””â”€â”€ æŒ‰ç…§æœ¬è®¡åˆ’çš„æ­¥éª¤é€æ­¥å®æ–½
```

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 æ¶æ„æ¨¡å¼
é‡‡ç”¨**æ¨¡å—ä¼˜å…ˆæ¶æ„**ï¼ˆå•å‡½æ•°å¤šè·¯ç”±ï¼Œé€šè¿‡ action å‚æ•°åŒºåˆ†æ“ä½œï¼‰ï¼š
- **5ä¸ªæ ¸å¿ƒäº‘å‡½æ•°**: user, course, order, ambassador, system
- **ä»£ç ç»„ç»‡æ–¹å¼**: æœ¬åœ°æ¨¡å—ï¼ˆæ¯ä¸ªäº‘å‡½æ•°å†…ç½® common ä»£ç å‰¯æœ¬ï¼‰
- **æ•°æ®åº“è¿æ¥**: CloudBase Node SDK `rdb()` æ–¹æ³•
- **æ€»è®¡**: 115+ ä¸ª action

âš ï¸ **é‡è¦å˜æ›´**ï¼šåŸºäº user äº‘å‡½æ•°æˆåŠŸå®è·µï¼Œé‡‡ç”¨**æœ¬åœ°æ¨¡å—æ–¹æ¡ˆ**ä»£æ›¿ Layerï¼š
- âœ… ç®€å•å¯é ï¼Œéƒ¨ç½²å¿«é€Ÿ
- âœ… é¿å… Layer ç‰ˆæœ¬å…¼å®¹é—®é¢˜
- âœ… ä¾¿äºè°ƒè¯•å’Œç»´æŠ¤
- ğŸ“– è¯¦è§ï¼š`cloudfunctions/äº‘å‡½æ•°æ ‡å‡†éƒ¨ç½²è§„èŒƒ.md`

### 1.2 ç¯å¢ƒé…ç½®
| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| ç¯å¢ƒID | `cloud1-0gnn3mn17b581124` | CloudBase ç¯å¢ƒ |
| æ•°æ®åº“å | `tiandao_culture` | âš ï¸ åœ¨ db.js ä¸­ç¡¬ç¼–ç  |
| è¿è¡Œæ—¶ | `Nodejs18.15` | æœ€æ–°ç¨³å®šç‰ˆæœ¬ |
| æ•°æ®åº“è¿æ¥ | CloudBase SDK `rdb()` | âœ… æ— éœ€é…ç½®ç¯å¢ƒå˜é‡ |

âš ï¸ **é‡è¦è¯´æ˜**ï¼š
- ä½¿ç”¨ CloudBase SDK è¿æ¥æ•°æ®åº“ï¼Œ**æ— éœ€é…ç½®** `MYSQL_HOST`ã€`MYSQL_PORT`ã€`MYSQL_USER`ã€`MYSQL_PASSWORD` ç­‰ç¯å¢ƒå˜é‡
- æ•°æ®åº“å `tiandao_culture` ç›´æ¥åœ¨ `common/db.js` ä¸­æŒ‡å®š
- CloudBase SDK ä¼šè‡ªåŠ¨å¤„ç†è®¤è¯å’Œè¿æ¥

### 1.3 å…¬å…±ä»£ç æ¨¡å—

âš ï¸ **é‡‡ç”¨ç»Ÿä¸€ç®¡ç† + æœ¬åœ°éƒ¨ç½²æ–¹æ¡ˆ**

**å…¬å…±æ¨¡å—ç»Ÿä¸€ç®¡ç†ä½ç½®**ï¼š
- `cloudfunctions/common/` - ä¸»ç‰ˆæœ¬ï¼ˆç»Ÿä¸€ä¿®æ”¹å¤„ï¼‰
- `cloudfunctions/business-logic/` - ä¸»ç‰ˆæœ¬ï¼ˆç»Ÿä¸€ä¿®æ”¹å¤„ï¼‰

**common æ¨¡å—å†…å®¹**ï¼š
- `db.js`: âœ… **ä½¿ç”¨ CloudBase SDK rdb()** - findOne, query, insert, update, deleteRecord, softDelete, count, batchInsert, upsert, rpc
- `auth.js`: checkClientAuth, checkAdminAuth, generateAdminToken, verifyAdminToken
- `response.js`: success, error, paramError, unauthorized, forbidden, notFound
- `utils.js`: å·¥å…·å‡½æ•°
- `index.js`: ç»Ÿä¸€å¯¼å‡ºå…¥å£

**business-logic æ¨¡å—å†…å®¹**ï¼š
- `payment.js`: å¾®ä¿¡æ”¯ä»˜ç›¸å…³ï¼ˆcreateWechatPayment, verifyPaymentCallback, processRefundï¼‰
- `points.js`: ç§¯åˆ†è®¡ç®—ï¼ˆcalculateMeritPoints, calculateCashPointsï¼‰
- `ambassador.js`: å¤§ä½¿ç®¡ç†ï¼ˆcheckUpgradeEligibility, processAmbassadorUpgradeï¼‰
- `notification.js`: æ¶ˆæ¯é€šçŸ¥ï¼ˆsendSubscribeMessageï¼‰
- `order.js`: è®¢å•å¤„ç†ï¼ˆcheckOrderExpiry, generateUserCourseRecordï¼‰
- `qrcode.js`: äºŒç»´ç ç”Ÿæˆï¼ˆgenerateShareQRCodeï¼‰
- `config.js`: é…ç½®ç®¡ç†ï¼ˆgetLevelConfig, getAllLevelConfigsï¼‰
- `index.js`: ç»Ÿä¸€å¯¼å‡ºå…¥å£

**éƒ¨ç½²æ–¹å¼**ï¼š
1. **ä¿®æ”¹å…¬å…±æ¨¡å—**ï¼šç›´æ¥ä¿®æ”¹ `cloudfunctions/common/` æˆ– `cloudfunctions/business-logic/`
2. **åŒæ­¥åˆ°å„æ¨¡å—**ï¼šæ‰§è¡ŒåŒæ­¥è„šæœ¬
3. **éƒ¨ç½²äº‘å‡½æ•°**ï¼šæ›´æ–°ç›¸å…³äº‘å‡½æ•°

**åŒæ­¥å‘½ä»¤**ï¼š
```powershell
# PowerShell - åŒæ­¥å…¬å…±æ¨¡å—åˆ°æ‰€æœ‰ä¸šåŠ¡æ¨¡å—
cd cloudfunctions

# åŒæ­¥åˆ° user æ¨¡å—
Copy-Item -Path "common\*" -Destination "user\common\" -Recurse -Force
Copy-Item -Path "business-logic\*" -Destination "user\business-logic\" -Recurse -Force

# åŒæ­¥åˆ° order æ¨¡å—
Copy-Item -Path "common\*" -Destination "order\common\" -Recurse -Force
Copy-Item -Path "business-logic\*" -Destination "order\business-logic\" -Recurse -Force

# åŒæ­¥åˆ° course æ¨¡å—
Copy-Item -Path "common\*" -Destination "course\common\" -Recurse -Force
Copy-Item -Path "business-logic\*" -Destination "course\business-logic\" -Recurse -Force

# æˆ–ä½¿ç”¨æ‰¹é‡è„šæœ¬
.\åŒæ­¥å…¬å…±æ¨¡å—.ps1
```

**åŒæ­¥è„šæœ¬**ï¼ˆ`cloudfunctions/åŒæ­¥å…¬å…±æ¨¡å—.ps1`ï¼‰ï¼š
```powershell
#!/usr/bin/env pwsh
# åŒæ­¥å…¬å…±æ¨¡å—åˆ°å„äº‘å‡½æ•°

Write-Host "=== ğŸ”„ åŒæ­¥å…¬å…±æ¨¡å— ===" -ForegroundColor Cyan

$modules = @("user", "order", "course", "ambassador", "system")

foreach ($module in $modules) {
    Write-Host "`nğŸ“¦ åŒæ­¥åˆ° $module æ¨¡å—..." -ForegroundColor Yellow
    
    # åŒæ­¥ common
    if (Test-Path "common") {
        $target = "$module\common"
        if (!(Test-Path $target)) {
            New-Item -ItemType Directory -Path $target -Force | Out-Null
        }
        Copy-Item "common\*" $target -Recurse -Force
        Write-Host "  âœ… common å·²åŒæ­¥" -ForegroundColor Green
    }
    
    # åŒæ­¥ business-logic
    if (Test-Path "business-logic") {
        $target = "$module\business-logic"
        if (!(Test-Path $target)) {
            New-Item -ItemType Directory -Path $target -Force | Out-Null
        }
        Copy-Item "business-logic\*" $target -Recurse -Force
        Write-Host "  âœ… business-logic å·²åŒæ­¥" -ForegroundColor Green
    }
}

Write-Host "`nâœ… æ‰€æœ‰æ¨¡å—åŒæ­¥å®Œæˆï¼" -ForegroundColor Green
```

**é‡è¦è¯´æ˜**ï¼š
- âœ… **ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰å…¬å…±ä»£ç åœ¨ `cloudfunctions/common/` å’Œ `cloudfunctions/business-logic/` ä¸­ç»´æŠ¤
- âœ… **è‡ªåŠ¨åŒæ­¥**ï¼šä¿®æ”¹å…¬å…±æ¨¡å—åï¼Œæ‰§è¡ŒåŒæ­¥è„šæœ¬æ›´æ–°æ‰€æœ‰ä¸šåŠ¡æ¨¡å—
- âœ… **ç¬¦åˆè§„èŒƒ**ï¼šæ¯ä¸ªäº‘å‡½æ•°ä»ç„¶æ˜¯è‡ªåŒ…å«çš„ï¼Œç¬¦åˆ CloudBase éƒ¨ç½²è§„èŒƒ
- âœ… **ä¾¿äºç»´æŠ¤**ï¼šé¿å…æ‰‹åŠ¨é€ä¸ªå¤åˆ¶ï¼Œå‡å°‘é—æ¼å’Œä¸ä¸€è‡´

---

## äºŒã€å…¬å…±æ¨¡å—ç®¡ç†è§„èŒƒ â­

### 2.1 ç›®å½•ç»“æ„

```
cloudfunctions/
â”œâ”€â”€ common/                      # â­ å…¬å…±å±‚ä¸»ç‰ˆæœ¬ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ db.js
â”‚   â”œâ”€â”€ auth.js
â”‚   â”œâ”€â”€ response.js
â”‚   â”œâ”€â”€ utils.js
â”‚   â””â”€â”€ index.js
â”‚
â”œâ”€â”€ business-logic/              # â­ ä¸šåŠ¡é€»è¾‘å±‚ä¸»ç‰ˆæœ¬ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ payment.js
â”‚   â”œâ”€â”€ points.js
â”‚   â”œâ”€â”€ ambassador.js
â”‚   â”œâ”€â”€ notification.js
â”‚   â”œâ”€â”€ order.js
â”‚   â”œâ”€â”€ qrcode.js
â”‚   â”œâ”€â”€ config.js
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ index.js
â”‚
â”œâ”€â”€ åŒæ­¥å…¬å…±æ¨¡å—.ps1             # â­ åŒæ­¥è„šæœ¬
â”‚
â””â”€â”€ [å„ä¸šåŠ¡æ¨¡å—]/
    â”œâ”€â”€ common/                  # ä»ä¸»ç‰ˆæœ¬å¤åˆ¶
    â””â”€â”€ business-logic/          # ä»ä¸»ç‰ˆæœ¬å¤åˆ¶
```

### 2.2 å·¥ä½œæµç¨‹

**å¼€å‘æµç¨‹ï¼š**
1. ä¿®æ”¹ `cloudfunctions/common/` æˆ– `cloudfunctions/business-logic/`
2. æ‰§è¡Œ `.\åŒæ­¥å…¬å…±æ¨¡å—.ps1` åŒæ­¥åˆ°æ‰€æœ‰æ¨¡å—
3. éƒ¨ç½²å—å½±å“çš„äº‘å‡½æ•°

**æ–°å»ºäº‘å‡½æ•°æµç¨‹ï¼š**
1. åˆ›å»ºäº‘å‡½æ•°åŸºç¡€ç»“æ„ï¼ˆindex.js, package.json, cloudfunction.jsonï¼‰
2. æ‰§è¡ŒåŒæ­¥è„šæœ¬è‡ªåŠ¨å¤åˆ¶å…¬å…±æ¨¡å—
3. æˆ–æ‰‹åŠ¨å¤åˆ¶ï¼š
   ```powershell
   Copy-Item -Path "common\*" -Destination "new_module\common\" -Recurse -Force
   Copy-Item -Path "business-logic\*" -Destination "new_module\business-logic\" -Recurse -Force
   ```

### 2.3 æ³¨æ„äº‹é¡¹

âš ï¸ **å…³é”®åŸåˆ™**ï¼š
- **æ°¸è¿œä¸è¦**ç›´æ¥ä¿®æ”¹å„ä¸šåŠ¡æ¨¡å—å†…çš„ `common/` æˆ– `business-logic/`
- **æ°¸è¿œä»**ä¸»ç‰ˆæœ¬ä¿®æ”¹ï¼Œå†åŒæ­¥åˆ°å„æ¨¡å—
- **éƒ¨ç½²å‰å¿…é¡»**ç¡®ä¿å…¬å…±æ¨¡å—å·²åŒæ­¥

âœ… **æ­£ç¡®åšæ³•**ï¼š
```powershell
# 1. ä¿®æ”¹ä¸»ç‰ˆæœ¬
notepad cloudfunctions\common\db.js

# 2. åŒæ­¥åˆ°æ‰€æœ‰æ¨¡å—
cd cloudfunctions
.\åŒæ­¥å…¬å…±æ¨¡å—.ps1

# 3. éƒ¨ç½²æ›´æ–°
# ï¼ˆä½¿ç”¨ CloudBase CLI æˆ– MCP å·¥å…·ï¼‰
```

âŒ **é”™è¯¯åšæ³•**ï¼š
```powershell
# âŒ ä¸è¦ç›´æ¥ä¿®æ”¹ä¸šåŠ¡æ¨¡å—ä¸­çš„å…¬å…±ä»£ç 
notepad cloudfunctions\user\common\db.js  # é”™è¯¯ï¼
```

---

## ä¸‰ã€äº‘å‡½æ•°ç›®å½•ç»“æ„

```
cloudfunctions/
â”œâ”€â”€ cloudbaserc.json              # CloudBase é…ç½®ï¼ˆéœ€æ›´æ–°ï¼‰
â”œâ”€â”€ layers/                       # å…¬å…±å±‚ï¼ˆå·²å­˜åœ¨ï¼‰
â”‚   â”œâ”€â”€ common/nodejs/
â”‚   â””â”€â”€ business-logic/nodejs/
â”‚
â”œâ”€â”€ user/                         # ç”¨æˆ·æ¨¡å—ï¼ˆ17ä¸ªactionï¼‰
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ cloudfunction.json
â”‚   â””â”€â”€ handlers/
â”‚       â”œâ”€â”€ client/               # 13ä¸ªå®¢æˆ·ç«¯æ¥å£
â”‚       â””â”€â”€ admin/                # 4ä¸ªç®¡ç†ç«¯æ¥å£
â”‚
â”œâ”€â”€ course/                       # è¯¾ç¨‹æ¨¡å—ï¼ˆ34ä¸ªactionï¼‰
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ cloudfunction.json
â”‚   â””â”€â”€ handlers/
â”‚       â”œâ”€â”€ public/               # 7ä¸ªå…¬å¼€æ¥å£
â”‚       â”œâ”€â”€ client/               # 7ä¸ªå®¢æˆ·ç«¯æ¥å£
â”‚       â””â”€â”€ admin/                # 20ä¸ªç®¡ç†ç«¯æ¥å£
â”‚
â”œâ”€â”€ order/                        # è®¢å•æ¨¡å—ï¼ˆ13ä¸ªactionï¼‰
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ cloudfunction.json
â”‚   â””â”€â”€ handlers/
â”‚       â”œâ”€â”€ public/               # 1ä¸ªå…¬å¼€æ¥å£ï¼ˆæ”¯ä»˜å›è°ƒï¼‰
â”‚       â”œâ”€â”€ client/               # 8ä¸ªå®¢æˆ·ç«¯æ¥å£
â”‚       â””â”€â”€ admin/                # 4ä¸ªç®¡ç†ç«¯æ¥å£
â”‚
â”œâ”€â”€ ambassador/                   # å¤§ä½¿æ¨¡å—ï¼ˆ26ä¸ªactionï¼‰
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ cloudfunction.json
â”‚   â””â”€â”€ handlers/
â”‚       â”œâ”€â”€ client/               # 11ä¸ªå®¢æˆ·ç«¯æ¥å£
â”‚       â””â”€â”€ admin/                # 15ä¸ªç®¡ç†ç«¯æ¥å£
â”‚
â””â”€â”€ system/                       # ç³»ç»Ÿæ¨¡å—ï¼ˆ28ä¸ªactionï¼‰
    â”œâ”€â”€ index.js
    â”œâ”€â”€ package.json
    â”œâ”€â”€ cloudfunction.json
    â””â”€â”€ handlers/
        â”œâ”€â”€ client/               # 6ä¸ªå®¢æˆ·ç«¯æ¥å£
        â””â”€â”€ admin/                # 22ä¸ªç®¡ç†ç«¯æ¥å£
```

---

## ä¸‰ã€å®æ–½é¡ºåºä¸ä¼˜å…ˆçº§

| é˜¶æ®µ | ä¼˜å…ˆçº§ | äº‘å‡½æ•° | Actionæ•° | ä¾èµ– |
|------|--------|--------|----------|------|
| P0-1 | æœ€é«˜ | user | 17 | commonå±‚ |
| P0-2 | æœ€é«˜ | order | 13 | common, business-logic |
| P1-1 | é«˜ | course | 34 | user |
| P1-2 | é«˜ | ambassador | 26 | user, order |
| P2-1 | ä¸­ | system | 28 | user |
| P2-2 | ä¸­ | callbacks | HTTPå›è°ƒ | common, business-logic |

**callbacks äº‘å‡½æ•°è¯´æ˜ï¼š**
- ç±»å‹ï¼šHTTPäº‘å‡½æ•°ï¼ˆé action æ¨¡å¼ï¼‰
- ç”¨é€”ï¼šç»Ÿä¸€å¤„ç†ç¬¬ä¸‰æ–¹å›è°ƒæ¥å£ï¼ˆå¾®ä¿¡æ¶ˆæ¯æ¨é€ã€æ”¯ä»˜å›è°ƒã€é€€æ¬¾å›è°ƒç­‰ï¼‰
- è·¯ç”±æ–¹å¼ï¼šé€šè¿‡ URL è·¯å¾„åŒºåˆ†ä¸åŒå›è°ƒç±»å‹
- é…ç½®è¦æ±‚ï¼šéœ€è¦é…ç½® HTTP è§¦å‘å™¨å’Œç¯å¢ƒå˜é‡ï¼ˆWECHAT_TOKENã€MCH_KEY ç­‰ï¼‰

---

## å››ã€Action æ¸…å•

### 4.1 User æ¨¡å—ï¼ˆ17ä¸ªï¼‰

**å®¢æˆ·ç«¯æ¥å£ (client:)** - éœ€ç™»å½•
1. `login` - å¾®ä¿¡ç™»å½•/æ³¨å†Œ
2. `getProfile` - è·å–ä¸ªäººèµ„æ–™
3. `updateProfile` - æ›´æ–°ä¸ªäººèµ„æ–™
4. `updateReferee` - ä¿®æ”¹æ¨èäººï¼ˆ7å¤©é™1æ¬¡ï¼‰
5. `getMyCourses` - è·å–æˆ‘çš„è¯¾ç¨‹åˆ—è¡¨
6. `getMyOrders` - è·å–æˆ‘çš„è®¢å•åˆ—è¡¨
7. `getMeritPoints` - è·å–åŠŸå¾·åˆ†ä½™é¢
8. `getMeritPointsHistory` - åŠŸå¾·åˆ†æ˜ç»†
9. `getCashPoints` - è·å–ç§¯åˆ†ä½™é¢
10. `getCashPointsHistory` - ç§¯åˆ†æ˜ç»†
11. `applyWithdraw` - ç”³è¯·æç°
12. `getWithdrawRecords` - æç°è®°å½•
13. `getMyReferees` - æˆ‘æ¨èçš„ç”¨æˆ·

**ç®¡ç†ç«¯æ¥å£ (admin:)** - éœ€ç®¡ç†å‘˜æƒé™
14. `getUserList` - å­¦å‘˜åˆ—è¡¨
15. `getUserDetail` - å­¦å‘˜è¯¦æƒ…
16. `updateUserReferee` - ä¿®æ”¹æ¨èäºº
17. `getRefereeChangeLogs` - å˜æ›´æ—¥å¿—

### 4.2 Course æ¨¡å—ï¼ˆ34ä¸ªï¼‰

**å…¬å¼€æ¥å£ (public:)** - æ— éœ€ç™»å½•
1. `getList` - è¯¾ç¨‹åˆ—è¡¨
2. `getDetail` - è¯¾ç¨‹è¯¦æƒ…
3. `getCaseList` - æ¡ˆä¾‹åˆ—è¡¨
4. `getCaseDetail` - æ¡ˆä¾‹è¯¦æƒ…
5. `getMaterialList` - èµ„æ–™åˆ—è¡¨
6. `getAcademyList` - å•†å­¦é™¢åˆ—è¡¨
7. `getAcademyDetail` - å•†å­¦é™¢è¯¦æƒ…

**å®¢æˆ·ç«¯æ¥å£ (client:)**
8. `getClassRecords` - ä¸Šè¯¾æ’æœŸ
9. `createAppointment` - åˆ›å»ºé¢„çº¦
10. `cancelAppointment` - å–æ¶ˆé¢„çº¦
11. `getMyAppointments` - æˆ‘çš„é¢„çº¦
12. `checkin` - ç­¾åˆ°
13. `recordAcademyProgress` - è®°å½•å­¦ä¹ è¿›åº¦
14. `getAcademyProgress` - è·å–å­¦ä¹ è¿›åº¦

**ç®¡ç†ç«¯æ¥å£ (admin:)**
15-18. è¯¾ç¨‹CRUD
19-22. ä¸Šè¯¾æ’æœŸCRUD
23-25. é¢„çº¦ç®¡ç†
26-29. æ¡ˆä¾‹CRUD
30-33. èµ„æ–™CRUD
34. å•†å­¦é™¢å†…å®¹ç®¡ç†

### 4.3 Order æ¨¡å—ï¼ˆ13ä¸ªï¼‰

**å…¬å¼€æ¥å£ (public:)**
1. `paymentCallback` - å¾®ä¿¡æ”¯ä»˜å›è°ƒ

**å®¢æˆ·ç«¯æ¥å£ (client:)**
2. `create` - åˆ›å»ºè®¢å•
3. `createPayment` - å‘èµ·æ”¯ä»˜
4. `getDetail` - è®¢å•è¯¦æƒ…
5. `getList` - è®¢å•åˆ—è¡¨
6. `cancel` - å–æ¶ˆè®¢å•
7. `getMallGoods` - å•†åŸå•†å“
8. `exchangeGoods` - å…‘æ¢å•†å“
9. `getExchangeRecords` - å…‘æ¢è®°å½•

**ç®¡ç†ç«¯æ¥å£ (admin:)**
10. `getOrderList` - è®¢å•åˆ—è¡¨
11. `getOrderDetail` - è®¢å•è¯¦æƒ…
12. `refund` - é€€æ¬¾
13. `withdrawAudit` - æç°å®¡æ ¸

### 4.4 Ambassador æ¨¡å—ï¼ˆ26ä¸ªï¼‰

**å®¢æˆ·ç«¯æ¥å£ (client:)**
1. `apply` - ç”³è¯·æˆä¸ºå¤§ä½¿
2. `getApplicationStatus` - ç”³è¯·çŠ¶æ€
3. `upgrade` - å¤§ä½¿å‡çº§
4. `getUpgradeGuide` - å‡çº§æŒ‡å—
5. `generateQRCode` - ç”Ÿæˆæ¨å¹¿ç 
6. `getMyQuotas` - æˆ‘çš„åé¢
7. `giftQuota` - èµ é€åé¢
8. `getContractTemplate` - åè®®æ¨¡æ¿
9. `signContract` - ç­¾ç½²åè®®
10. `getMyContracts` - æˆ‘çš„åè®®
11. `getContractDetail` - åè®®è¯¦æƒ…

**ç®¡ç†ç«¯æ¥å£ (admin:)**
12-13. ç”³è¯·å®¡æ ¸
14-15. å¤§ä½¿ç®¡ç†
16-19. æ´»åŠ¨è®°å½•CRUD
20-23. åè®®æ¨¡æ¿CRUD
24-26. åè®®ç­¾ç½²ç®¡ç†

### 4.5 System æ¨¡å—ï¼ˆ28ä¸ªï¼‰

**å®¢æˆ·ç«¯æ¥å£ (client:)**
1. `getFeedbackCourses` - å¯åé¦ˆè¯¾ç¨‹
2. `getFeedbackTypes` - åé¦ˆç±»å‹
3. `submitFeedback` - æäº¤åé¦ˆ
4. `getMyFeedback` - æˆ‘çš„åé¦ˆ
5. `getNotificationConfigs` - é€šçŸ¥é…ç½®
6. `subscribeNotification` - è®¢é˜…é€šçŸ¥

**ç®¡ç†ç«¯æ¥å£ (admin:)**
7. `login` - ç®¡ç†å‘˜ç™»å½•ï¼ˆJWTï¼‰
8. `getConfig` - è·å–ç³»ç»Ÿé…ç½®
9. `updateConfig` - æ›´æ–°ç³»ç»Ÿé…ç½®
10. `getAmbassadorLevelConfigs` - å¤§ä½¿ç­‰çº§é…ç½®
11. `updateAmbassadorLevelConfig` - æ›´æ–°ç­‰çº§é…ç½®
12. `initAmbassadorLevelConfigs` - åˆå§‹åŒ–é…ç½®
13. `getStatistics` - ç»Ÿè®¡ä»ªè¡¨ç›˜
14. `getFeedbackList` - åé¦ˆåˆ—è¡¨
15. `replyFeedback` - å›å¤åé¦ˆ
16-19. é€šçŸ¥é…ç½®CRUD
20-23. å…¬å‘ŠCRUD
24-28. ç®¡ç†å‘˜CRUD

---

## äº”ã€é…ç½®æ–‡ä»¶æ¨¡æ¿

### 5.1 cloudbaserc.jsonï¼ˆæ›´æ–°ï¼‰

âš ï¸ **é‡‡ç”¨æœ¬åœ°æ¨¡å—æ–¹æ¡ˆï¼Œæ— éœ€ Layer å’Œæ•°æ®åº“ç¯å¢ƒå˜é‡**

```json
{
  "envId": "cloud1-0gnn3mn17b581124",
  "functionRoot": "./cloudfunctions",
  "functions": [
    {
      "name": "user",
      "timeout": 60,
      "runtime": "Nodejs18.15",
      "memorySize": 256,
      "envVariables": {}  
    },
    {
      "name": "course",
      "timeout": 60,
      "runtime": "Nodejs18.15",
      "memorySize": 256,
      "envVariables": {}
    },
    {
      "name": "order",
      "timeout": 120,
      "runtime": "Nodejs18.15",
      "memorySize": 512,
      "envVariables": {
        "MCH_ID": "å¾®ä¿¡å•†æˆ·å·ï¼ˆå¯é€‰ï¼‰",
        "MCH_KEY": "å•†æˆ·APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰"
      }
    },
    {
      "name": "ambassador",
      "timeout": 60,
      "runtime": "Nodejs18.15",
      "memorySize": 256,
      "envVariables": {}
    },
    {
      "name": "system",
      "timeout": 60,
      "runtime": "Nodejs18.15",
      "memorySize": 256,
      "envVariables": {
        "JWT_SECRET": "your-jwt-secret-key-min-32-chars"
      }
    }
  ]
}
```

**è¯´æ˜**ï¼š
- âœ… **æ— éœ€é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯**ï¼ˆCloudBase SDK è‡ªåŠ¨å¤„ç†ï¼‰
- âœ… **æ— éœ€é…ç½® Layer**ï¼ˆä½¿ç”¨æœ¬åœ°æ¨¡å—ï¼‰
- âš ï¸ æ”¯ä»˜ç›¸å…³ç¯å¢ƒå˜é‡ï¼ˆMCH_ID, MCH_KEYï¼‰æš‚æ—¶å¯é€‰
- âš ï¸ JWT_SECRET ä»… system æ¨¡å—éœ€è¦ï¼ˆç®¡ç†å‘˜ç™»å½•ï¼‰

### 5.2 å•ä¸ªäº‘å‡½æ•° package.json

```json
{
  "name": "user",
  "version": "1.0.0",
  "description": "ç”¨æˆ·æ¨¡å—äº‘å‡½æ•°",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "latest",
    "@cloudbase/node-sdk": "latest"
  }
}
```

### 5.3 cloudfunction.jsonï¼ˆorderæ¨¡å—ç¤ºä¾‹ï¼‰

```json
{
  "permissions": {
    "openapi": [
      "wxpay.unifiedOrder",
      "wxpay.refund",
      "wxpay.queryOrder",
      "subscribeMessage.send"
    ]
  },
  "triggers": []
}
```

---

## å…­ã€äº‘å‡½æ•°å…¥å£æ¨¡æ¿

### 6.1 æ ‡å‡†å…¥å£æ–‡ä»¶ index.js

âš ï¸ **æ³¨æ„ require è·¯å¾„ï¼šä½¿ç”¨ `./common` è€Œé `common`**

```javascript
/**
 * {æ¨¡å—å}äº‘å‡½æ•°å…¥å£
 */
const cloud = require('wx-server-sdk');
const cloudbase = require('@cloudbase/node-sdk');
const { response, checkClientAuth, checkAdminAuth } = require('./common');  // âš ï¸ æœ¬åœ°æ¨¡å—

// åˆå§‹åŒ–
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const app = cloudbase.init({ env: cloudbase.SYMBOL_CURRENT_ENV });

// å¯¼å…¥å¤„ç†å™¨
const publicHandlers = {
  // getList: require('./handlers/public/getList'),
};

const clientHandlers = {
  // login: require('./handlers/client/login'),
};

const adminHandlers = {
  // getUserList: require('./handlers/admin/getUserList'),
};

// è·¯ç”±é…ç½®
const ROUTES = {
  public: Object.keys(publicHandlers),
  client: Object.keys(clientHandlers),
  admin: Object.keys(adminHandlers)
};

exports.main = async (event, context) => {
  const { action } = event;
  const wxContext = cloud.getWXContext();
  const OPENID = wxContext.OPENID;

  console.log(`[${action}] æ”¶åˆ°è¯·æ±‚:`, { openid: OPENID?.slice(-6) });

  try {
    // å…¬å¼€æ¥å£ï¼ˆæ— éœ€ç™»å½•ï¼‰
    if (ROUTES.public.includes(action)) {
      return await publicHandlers[action](event, { OPENID });
    }

    // å®¢æˆ·ç«¯æ¥å£ï¼ˆéœ€ç”¨æˆ·é‰´æƒï¼‰
    if (ROUTES.client.includes(action)) {
      const user = await checkClientAuth(OPENID);
      return await clientHandlers[action](event, { OPENID, user });
    }

    // ç®¡ç†ç«¯æ¥å£ï¼ˆéœ€ç®¡ç†å‘˜é‰´æƒï¼‰
    if (ROUTES.admin.includes(action)) {
      const admin = await checkAdminAuth(OPENID);
      return await adminHandlers[action](event, { OPENID, admin });
    }

    return response.paramError(`æœªçŸ¥çš„æ“ä½œ: ${action}`);

  } catch (error) {
    console.error(`[${action}] æ‰§è¡Œå¤±è´¥:`, error);
    return response.error(error.message, error, error.code || 500);
  }
};
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `require('./common')` å¼•ç”¨æœ¬åœ°æ¨¡å—
- âœ… ä½¿ç”¨ `cloud.getWXContext()` è·å– OPENID
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

---

## ä¸ƒã€å…³é”®ä¸šåŠ¡å®ç°è¦ç‚¹

### 7.1 User æ¨¡å—

**loginï¼ˆç™»å½•/æ³¨å†Œï¼‰**
- é¦–æ¬¡ç™»å½•è‡ªåŠ¨åˆ›å»ºç”¨æˆ·è®°å½•
- ç”Ÿæˆå”¯ä¸€6ä½æ¨èç 
- è§£æ scene å‚æ•°ç»‘å®šæ¨èäºº
- è¿”å›ç”¨æˆ·å®Œæ•´ä¿¡æ¯

**updateRefereeï¼ˆä¿®æ”¹æ¨èäººï¼‰**
- 7å¤©å†…åªèƒ½ä¿®æ”¹1æ¬¡
- é¦–æ¬¡æ”¯ä»˜åé”å®šï¼ˆreferee_confirmed_atï¼‰
- ä¸èƒ½é€‰æ‹©è‡ªå·±æˆ–ä¸‹çº§ï¼ˆé˜²å¾ªç¯ï¼‰
- è®°å½•å˜æ›´æ—¥å¿—åˆ° referee_change_logs

**applyWithdrawï¼ˆç”³è¯·æç°ï¼‰**
- éªŒè¯å¯ç”¨ç§¯åˆ†ä½™é¢
- æœ€ä½æç°é‡‘é¢é™åˆ¶
- åˆ›å»ºæç°è®°å½•ï¼ˆçŠ¶æ€ï¼šå¾…å®¡æ ¸ï¼‰
- å†»ç»“å¯¹åº”ç§¯åˆ†

### 7.2 Order æ¨¡å—

**createï¼ˆåˆ›å»ºè®¢å•ï¼‰**
- éªŒè¯è¯¾ç¨‹/å•†å“å­˜åœ¨ä¸”ä¸Šæ¶
- æ£€æŸ¥é‡å¤è´­ä¹°
- è®¡ç®—ä»·æ ¼ï¼ˆåŸä»·ã€ä¼˜æƒ ã€åº”ä»˜ï¼‰
- è®¾ç½®30åˆ†é’Ÿè¿‡æœŸæ—¶é—´
- è®°å½•æ¨èäººä¿¡æ¯

**createPaymentï¼ˆå‘èµ·æ”¯ä»˜ï¼‰**
- è°ƒç”¨ business.createWechatPayment
- è¿”å›æ”¯ä»˜å‚æ•°ç»™å‰ç«¯

**paymentCallbackï¼ˆæ”¯ä»˜å›è°ƒï¼‰**
- éªŒè¯ç­¾å
- æ›´æ–°è®¢å•çŠ¶æ€
- ç”Ÿæˆç”¨æˆ·è¯¾ç¨‹è®°å½•
- å‘æ”¾æ¨èäººå¥–åŠ±ï¼ˆç§¯åˆ†+åŠŸå¾·åˆ†ï¼‰
- å‘é€æ”¯ä»˜æˆåŠŸé€šçŸ¥

**exchangeGoodsï¼ˆå…‘æ¢å•†å“ï¼‰**
- äº‹åŠ¡å¤„ç†ï¼šæ‰£åŠŸå¾·åˆ† + å‡åº“å­˜ + åˆ›å»ºè®°å½•
- éªŒè¯åº“å­˜å’Œæ¯äººé™è´­

### 7.3 Course æ¨¡å—

**createAppointmentï¼ˆåˆ›å»ºé¢„çº¦ï¼‰**
- éªŒè¯ç”¨æˆ·å·²è´­ä¹°è¯¥è¯¾ç¨‹
- éªŒè¯ä¸Šè¯¾è®°å½•å­˜åœ¨ä¸”æœ‰åé¢
- æ£€æŸ¥æ˜¯å¦å·²é¢„çº¦
- æ‰£å‡åé¢

**checkinï¼ˆç­¾åˆ°ï¼‰**
- éªŒè¯é¢„çº¦å­˜åœ¨
- ç”Ÿæˆç­¾åˆ°ç æˆ–éªŒè¯ç­¾åˆ°ç 
- æ›´æ–°é¢„çº¦çŠ¶æ€
- è®°å½•ç­¾åˆ°æ—¶é—´

### 7.4 Ambassador æ¨¡å—

**upgradeï¼ˆå¤§ä½¿å‡çº§ï¼‰**
- è°ƒç”¨ business.checkUpgradeEligibility æ£€æŸ¥æ¡ä»¶
- æ”¯ä»˜ç±»å‹ï¼šåˆ›å»ºå‡çº§è®¢å•
- åè®®ç±»å‹ï¼šéªŒè¯åè®®å·²ç­¾ç½²
- è°ƒç”¨ business.processAmbassadorUpgrade æ‰§è¡Œå‡çº§

**signContractï¼ˆç­¾ç½²åè®®ï¼‰**
- è·å–åè®®æ¨¡æ¿
- å¡«å……ç”¨æˆ·å˜é‡
- è®°å½•ç­¾ç½²ä¿¡æ¯ï¼ˆIPã€è®¾å¤‡ã€æ—¶é—´ï¼‰
- åˆ›å»ºåè®®å¿«ç…§

**giftQuotaï¼ˆèµ é€åé¢ï¼‰**
- éªŒè¯åé¢ä½™é‡
- éªŒè¯æ¥æ”¶äººå­˜åœ¨
- åˆ›å»ºåé¢ä½¿ç”¨è®°å½•
- æ‰£å‡å¤§ä½¿åé¢

### 7.5 System æ¨¡å—

**loginï¼ˆç®¡ç†å‘˜ç™»å½•ï¼‰**
- éªŒè¯ç”¨æˆ·åå¯†ç 
- ç”Ÿæˆ JWT Tokenï¼ˆ24å°æ—¶æœ‰æ•ˆï¼‰
- è®°å½•ç™»å½•æ—¥å¿—

**getStatisticsï¼ˆç»Ÿè®¡ä»ªè¡¨ç›˜ï¼‰**
- ç”¨æˆ·ç»Ÿè®¡ï¼šæ€»æ•°ã€ä»Šæ—¥æ–°å¢ã€å¤§ä½¿æ•°é‡
- è®¢å•ç»Ÿè®¡ï¼šæ€»æ•°ã€ä»Šæ—¥è®¢å•ã€æ€»é‡‘é¢
- è¯¾ç¨‹ç»Ÿè®¡ï¼šé¢„çº¦æ•°ã€ç­¾åˆ°ç‡
- å¤§ä½¿ç»Ÿè®¡ï¼šå„ç­‰çº§åˆ†å¸ƒ

---

## å…«ã€æ•°æ®åº“è¡¨å¯¹åº”å…³ç³»

| äº‘å‡½æ•° | ä¸»è¦æ“ä½œè¡¨ |
|--------|-----------|
| user | users, referee_change_logs, user_courses, orders, merit_points_records, cash_points_records, withdrawals |
| course | courses, class_records, appointments, user_courses, academy_intro, academy_cases, academy_materials |
| order | orders, user_courses, mall_goods, mall_exchange_records, merit_points_records, cash_points_records |
| ambassador | ambassador_applications, ambassador_quotas, ambassador_upgrade_logs, quota_usage_records, contract_templates, contract_signatures |
| system | admin_users, admin_operation_logs, system_configs, feedbacks, notification_configs, notification_logs, announcements, ambassador_level_configs |

---

## ä¹ã€éªŒè¯æµ‹è¯•æ–¹æ¡ˆ

### 9.1 å•å…ƒæµ‹è¯•
æ¯ä¸ªäº‘å‡½æ•°ç›®å½•ä¸‹åˆ›å»º `test.js`ï¼š
```javascript
// test.js
const main = require('./index').main;

// æ¨¡æ‹Ÿæµ‹è¯•
async function test() {
  const result = await main({
    action: 'login'
  }, {
    // æ¨¡æ‹Ÿ context
  });
  console.log('æµ‹è¯•ç»“æœ:', result);
}

test();
```

### 9.2 é›†æˆæµ‹è¯•é¡ºåº
1. **user/login** â†’ éªŒè¯ç”¨æˆ·åˆ›å»º
2. **course/public:getList** â†’ éªŒè¯è¯¾ç¨‹æŸ¥è¯¢
3. **order/create** â†’ éªŒè¯è®¢å•åˆ›å»º
4. **order/createPayment** â†’ éªŒè¯æ”¯ä»˜æµç¨‹
5. **ambassador/apply** â†’ éªŒè¯å¤§ä½¿ç”³è¯·
6. **system/admin:login** â†’ éªŒè¯ç®¡ç†å‘˜ç™»å½•

### 9.3 éªŒè¯æ¸…å•
- [ ] å…¬å…±å±‚å¼•ç”¨æ­£å¸¸ï¼ˆrequire('common')ï¼‰
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] æƒé™éªŒè¯æ­£å¸¸ï¼ˆclient/adminï¼‰
- [ ] å“åº”æ ¼å¼ç»Ÿä¸€
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ—¥å¿—è®°å½•å®Œæ•´

---

## åã€ç¯å¢ƒé…ç½®æ–¹æ¡ˆ

### 10.1 ç‹¬ç«‹é…ç½®æ–‡ä»¶ç»“æ„

```
cloudfunctions/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ env.example.js        # é…ç½®æ¨¡æ¿ï¼ˆæäº¤åˆ°gitï¼‰
â”‚   â”œâ”€â”€ env.dev.js            # å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆä¸æäº¤ï¼‰
â”‚   â”œâ”€â”€ env.prod.js           # ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆä¸æäº¤ï¼‰
â”‚   â””â”€â”€ index.js              # é…ç½®åŠ è½½å™¨
â””â”€â”€ .gitignore                # å¿½ç•¥æ•æ„Ÿé…ç½®æ–‡ä»¶
```

### 10.2 é…ç½®æ–‡ä»¶å†…å®¹

**config/env.example.jsï¼ˆæ¨¡æ¿ï¼‰**
```javascript
module.exports = {
  // æ•°æ®åº“é…ç½®
  MYSQL_HOST: 'your-mysql-host',
  MYSQL_PORT: '3306',
  MYSQL_USER: 'your-username',
  MYSQL_PASSWORD: 'your-password',
  MYSQL_DATABASE: 'tiandao_culture',

  // JWTé…ç½®ï¼ˆç®¡ç†å‘˜ç™»å½•ï¼‰
  JWT_SECRET: 'your-jwt-secret-key-min-32-chars',

  // å¾®ä¿¡æ”¯ä»˜é…ç½®ï¼ˆå¯é€‰ï¼‰
  MCH_ID: '',
  MCH_KEY: '',

  // ç¯å¢ƒæ ‡è¯†
  ENV_ID: 'your-cloudbase-env-id'
};
```

**config/env.dev.jsï¼ˆå¼€å‘ç¯å¢ƒ-å®é™…å€¼ï¼‰**
```javascript
module.exports = {
  MYSQL_HOST: 'gz-cynosdbmysql-grp-2xaxm80c.sql.tencentcdb.com',
  MYSQL_PORT: '22483',
  MYSQL_USER: 'xcx',
  MYSQL_PASSWORD: 'xCX020202',
  MYSQL_DATABASE: 'tiandao_culture',

  // è‡ªåŠ¨ç”Ÿæˆçš„JWTå¯†é’¥
  JWT_SECRET: 'TianDao2026SecureJWTKey@CloudBase#Admin!',

  // å¾®ä¿¡æ”¯ä»˜ï¼ˆæš‚æ—¶è·³è¿‡ï¼‰
  MCH_ID: '',
  MCH_KEY: '',

  ENV_ID: 'cloud1-0gnn3mn17b581124'
};
```

**config/index.jsï¼ˆé…ç½®åŠ è½½å™¨ï¼‰**
```javascript
const env = process.env.NODE_ENV || 'dev';
let config;

try {
  config = require(`./env.${env}.js`);
} catch (e) {
  console.warn(`æœªæ‰¾åˆ° env.${env}.jsï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡`);
  config = {
    MYSQL_HOST: process.env.MYSQL_HOST,
    MYSQL_PORT: process.env.MYSQL_PORT,
    MYSQL_USER: process.env.MYSQL_USER,
    MYSQL_PASSWORD: process.env.MYSQL_PASSWORD,
    MYSQL_DATABASE: process.env.MYSQL_DATABASE,
    JWT_SECRET: process.env.JWT_SECRET,
    MCH_ID: process.env.MCH_ID,
    MCH_KEY: process.env.MCH_KEY,
    ENV_ID: process.env.ENV_ID
  };
}

module.exports = config;
```

### 10.3 .gitignore æ·»åŠ 

```
# æ•æ„Ÿé…ç½®æ–‡ä»¶
cloudfunctions/config/env.dev.js
cloudfunctions/config/env.prod.js
```

---

## åä¸€ã€å¾…ç¡®è®¤äº‹é¡¹ï¼ˆå·²ç¡®è®¤ï¼‰

| äº‹é¡¹ | çŠ¶æ€ | æ–¹æ¡ˆ |
|------|------|------|
| å¾®ä¿¡æ”¯ä»˜é…ç½® | â¸ï¸ æš‚è·³è¿‡ | ä½¿ç”¨ç‹¬ç«‹é…ç½®æ–‡ä»¶ï¼Œåç»­è¡¥å…… |
| JWTå¯†é’¥ | âœ… å·²ç¡®è®¤ | è‡ªåŠ¨ç”Ÿæˆå®‰å…¨å¯†é’¥ |
| å®æ–½æ–¹å¼ | âœ… å·²ç¡®è®¤ | é€æ­¥å®æ–½ï¼Œæ¯æ­¥æµ‹è¯•éªŒè¯åç»§ç»­ |
| ç¯å¢ƒé…ç½® | âœ… å·²ç¡®è®¤ | ä½¿ç”¨ç‹¬ç«‹é…ç½®æ–‡ä»¶æ–¹æ¡ˆ |

---

## åä¸€ã€æ–‡ä»¶æ¸…å•ï¼ˆéœ€åˆ›å»ºï¼‰

### 11.1 User äº‘å‡½æ•°
```
cloudfunctions/user/
â”œâ”€â”€ index.js
â”œâ”€â”€ package.json
â”œâ”€â”€ cloudfunction.json
â””â”€â”€ handlers/
    â”œâ”€â”€ client/
    â”‚   â”œâ”€â”€ login.js
    â”‚   â”œâ”€â”€ getProfile.js
    â”‚   â”œâ”€â”€ updateProfile.js
    â”‚   â”œâ”€â”€ updateReferee.js
    â”‚   â”œâ”€â”€ getMyCourses.js
    â”‚   â”œâ”€â”€ getMyOrders.js
    â”‚   â”œâ”€â”€ getMeritPoints.js
    â”‚   â”œâ”€â”€ getMeritPointsHistory.js
    â”‚   â”œâ”€â”€ getCashPoints.js
    â”‚   â”œâ”€â”€ getCashPointsHistory.js
    â”‚   â”œâ”€â”€ applyWithdraw.js
    â”‚   â”œâ”€â”€ getWithdrawRecords.js
    â”‚   â””â”€â”€ getMyReferees.js
    â””â”€â”€ admin/
        â”œâ”€â”€ getUserList.js
        â”œâ”€â”€ getUserDetail.js
        â”œâ”€â”€ updateUserReferee.js
        â””â”€â”€ getRefereeChangeLogs.js
```

### 11.2 Course äº‘å‡½æ•°
```
cloudfunctions/course/
â”œâ”€â”€ index.js
â”œâ”€â”€ package.json
â”œâ”€â”€ cloudfunction.json
â””â”€â”€ handlers/
    â”œâ”€â”€ public/
    â”‚   â”œâ”€â”€ getList.js
    â”‚   â”œâ”€â”€ getDetail.js
    â”‚   â”œâ”€â”€ getCaseList.js
    â”‚   â”œâ”€â”€ getCaseDetail.js
    â”‚   â”œâ”€â”€ getMaterialList.js
    â”‚   â”œâ”€â”€ getAcademyList.js
    â”‚   â””â”€â”€ getAcademyDetail.js
    â”œâ”€â”€ client/
    â”‚   â”œâ”€â”€ getClassRecords.js
    â”‚   â”œâ”€â”€ createAppointment.js
    â”‚   â”œâ”€â”€ cancelAppointment.js
    â”‚   â”œâ”€â”€ getMyAppointments.js
    â”‚   â”œâ”€â”€ checkin.js
    â”‚   â”œâ”€â”€ recordAcademyProgress.js
    â”‚   â””â”€â”€ getAcademyProgress.js
    â””â”€â”€ admin/
        â”œâ”€â”€ createCourse.js
        â”œâ”€â”€ updateCourse.js
        â”œâ”€â”€ deleteCourse.js
        â”œâ”€â”€ getCourseList.js
        â”œâ”€â”€ createClassRecord.js
        â”œâ”€â”€ updateClassRecord.js
        â”œâ”€â”€ deleteClassRecord.js
        â”œâ”€â”€ getClassRecordList.js
        â”œâ”€â”€ getAppointmentList.js
        â”œâ”€â”€ updateAppointmentStatus.js
        â”œâ”€â”€ batchCheckin.js
        â”œâ”€â”€ createCase.js
        â”œâ”€â”€ updateCase.js
        â”œâ”€â”€ deleteCase.js
        â”œâ”€â”€ createMaterial.js
        â”œâ”€â”€ updateMaterial.js
        â”œâ”€â”€ deleteMaterial.js
        â”œâ”€â”€ createAcademyContent.js
        â”œâ”€â”€ updateAcademyContent.js
        â””â”€â”€ deleteAcademyContent.js
```

### 11.3 Order äº‘å‡½æ•°
```
cloudfunctions/order/
â”œâ”€â”€ index.js
â”œâ”€â”€ package.json
â”œâ”€â”€ cloudfunction.json
â””â”€â”€ handlers/
    â”œâ”€â”€ public/
    â”‚   â””â”€â”€ paymentCallback.js
    â”œâ”€â”€ client/
    â”‚   â”œâ”€â”€ create.js
    â”‚   â”œâ”€â”€ createPayment.js
    â”‚   â”œâ”€â”€ getDetail.js
    â”‚   â”œâ”€â”€ getList.js
    â”‚   â”œâ”€â”€ cancel.js
    â”‚   â”œâ”€â”€ getMallGoods.js
    â”‚   â”œâ”€â”€ exchangeGoods.js
    â”‚   â””â”€â”€ getExchangeRecords.js
    â””â”€â”€ admin/
        â”œâ”€â”€ getOrderList.js
        â”œâ”€â”€ getOrderDetail.js
        â”œâ”€â”€ refund.js
        â””â”€â”€ withdrawAudit.js
```

### 11.4 Ambassador äº‘å‡½æ•°
```
cloudfunctions/ambassador/
â”œâ”€â”€ index.js
â”œâ”€â”€ package.json
â”œâ”€â”€ cloudfunction.json
â””â”€â”€ handlers/
    â”œâ”€â”€ client/
    â”‚   â”œâ”€â”€ apply.js
    â”‚   â”œâ”€â”€ getApplicationStatus.js
    â”‚   â”œâ”€â”€ upgrade.js
    â”‚   â”œâ”€â”€ getUpgradeGuide.js
    â”‚   â”œâ”€â”€ generateQRCode.js
    â”‚   â”œâ”€â”€ getMyQuotas.js
    â”‚   â”œâ”€â”€ giftQuota.js
    â”‚   â”œâ”€â”€ getContractTemplate.js
    â”‚   â”œâ”€â”€ signContract.js
    â”‚   â”œâ”€â”€ getMyContracts.js
    â”‚   â””â”€â”€ getContractDetail.js
    â””â”€â”€ admin/
        â”œâ”€â”€ getApplicationList.js
        â”œâ”€â”€ auditApplication.js
        â”œâ”€â”€ getAmbassadorList.js
        â”œâ”€â”€ getAmbassadorDetail.js
        â”œâ”€â”€ createActivity.js
        â”œâ”€â”€ getActivityList.js
        â”œâ”€â”€ updateActivity.js
        â”œâ”€â”€ deleteActivity.js
        â”œâ”€â”€ createContractTemplate.js
        â”œâ”€â”€ updateContractTemplate.js
        â”œâ”€â”€ deleteContractTemplate.js
        â”œâ”€â”€ getContractTemplateList.js
        â”œâ”€â”€ getContractVersions.js
        â”œâ”€â”€ getSignatureList.js
        â”œâ”€â”€ getExpiringContracts.js
        â””â”€â”€ renewContract.js
```

### 11.5 System äº‘å‡½æ•°
```
cloudfunctions/system/
â”œâ”€â”€ index.js
â”œâ”€â”€ package.json
â”œâ”€â”€ cloudfunction.json
â””â”€â”€ handlers/
    â”œâ”€â”€ client/
    â”‚   â”œâ”€â”€ getFeedbackCourses.js
    â”‚   â”œâ”€â”€ getFeedbackTypes.js
    â”‚   â”œâ”€â”€ submitFeedback.js
    â”‚   â”œâ”€â”€ getMyFeedback.js
    â”‚   â”œâ”€â”€ getNotificationConfigs.js
    â”‚   â””â”€â”€ subscribeNotification.js
    â””â”€â”€ admin/
        â”œâ”€â”€ login.js
        â”œâ”€â”€ getConfig.js
        â”œâ”€â”€ updateConfig.js
        â”œâ”€â”€ getAmbassadorLevelConfigs.js
        â”œâ”€â”€ updateAmbassadorLevelConfig.js
        â”œâ”€â”€ initAmbassadorLevelConfigs.js
        â”œâ”€â”€ getStatistics.js
        â”œâ”€â”€ getFeedbackList.js
        â”œâ”€â”€ replyFeedback.js
        â”œâ”€â”€ createNotificationConfig.js
        â”œâ”€â”€ updateNotificationConfig.js
        â”œâ”€â”€ getNotificationConfigList.js
        â”œâ”€â”€ getNotificationLogs.js
        â”œâ”€â”€ sendNotification.js
        â”œâ”€â”€ createAnnouncement.js
        â”œâ”€â”€ updateAnnouncement.js
        â”œâ”€â”€ deleteAnnouncement.js
        â”œâ”€â”€ getAnnouncementList.js
        â”œâ”€â”€ createAdminUser.js
        â”œâ”€â”€ updateAdminUser.js
        â”œâ”€â”€ deleteAdminUser.js
        â””â”€â”€ getAdminUserList.js
```

---

## åäºŒã€åˆ†æ­¥æ‰§è¡Œè®¡åˆ’ï¼ˆé€æ­¥å®æ–½+æµ‹è¯•éªŒè¯ï¼‰

### æ­¥éª¤ 0ï¼šåŸºç¡€é…ç½®ï¼ˆå‡†å¤‡å·¥ä½œï¼‰
**ç›®æ ‡**ï¼šåˆ›å»ºé…ç½®æ–‡ä»¶å’Œæ›´æ–°é¡¹ç›®é…ç½®

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆ›å»º `cloudfunctions/config/` ç›®å½•
- [ ] åˆ›å»º `env.example.js` é…ç½®æ¨¡æ¿
- [ ] åˆ›å»º `env.dev.js` å¼€å‘ç¯å¢ƒé…ç½®
- [ ] åˆ›å»º `config/index.js` é…ç½®åŠ è½½å™¨
- [ ] æ›´æ–° `cloudbaserc.json` æ·»åŠ 5ä¸ªäº‘å‡½æ•°é…ç½®
- [ ] æ›´æ–° `.gitignore` å¿½ç•¥æ•æ„Ÿé…ç½®

**éªŒè¯æ–¹å¼**ï¼š
- é…ç½®æ–‡ä»¶ç»“æ„æ­£ç¡®
- æ•æ„Ÿä¿¡æ¯ä¸ä¼šè¢«æäº¤åˆ°git

**å®Œæˆåæ€»ç»“**ï¼šé…ç½®æ–‡ä»¶åˆ›å»ºæƒ…å†µã€ä¸‹ä¸€æ­¥å‡†å¤‡

---

### æ­¥éª¤ 1ï¼šUser äº‘å‡½æ•°ï¼ˆP0-1ï¼‰
**ç›®æ ‡**ï¼šå®ç°ç”¨æˆ·æ¨¡å—17ä¸ªaction

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆ›å»º `user/index.js` å…¥å£æ–‡ä»¶
- [ ] åˆ›å»º `user/package.json`
- [ ] åˆ›å»º `user/cloudfunction.json`
- [ ] â­ åŒæ­¥å…¬å…±æ¨¡å—ï¼šæ‰§è¡Œ `.\åŒæ­¥å…¬å…±æ¨¡å—.ps1` æˆ–æ‰‹åŠ¨å¤åˆ¶
  ```powershell
  Copy-Item -Path "common\*" -Destination "user\common\" -Recurse -Force
  Copy-Item -Path "business-logic\*" -Destination "user\business-logic\" -Recurse -Force
  ```
- [ ] å®ç°13ä¸ªå®¢æˆ·ç«¯æ¥å£ï¼ˆhandlers/client/ï¼‰
- [ ] å®ç°4ä¸ªç®¡ç†ç«¯æ¥å£ï¼ˆhandlers/admin/ï¼‰

**å…³é”®æ¥å£**ï¼š
| Action | åŠŸèƒ½ | æ¶‰åŠè¡¨ |
|--------|------|--------|
| login | ç™»å½•/æ³¨å†Œ | users |
| getProfile | è·å–èµ„æ–™ | users |
| updateProfile | æ›´æ–°èµ„æ–™ | users |
| updateReferee | ä¿®æ”¹æ¨èäºº | users, referee_change_logs |
| getMyCourses | æˆ‘çš„è¯¾ç¨‹ | user_courses, courses |
| getMyOrders | æˆ‘çš„è®¢å• | orders |
| getMeritPoints | åŠŸå¾·åˆ†ä½™é¢ | users |
| getMeritPointsHistory | åŠŸå¾·åˆ†æ˜ç»† | merit_points_records |
| getCashPoints | ç§¯åˆ†ä½™é¢ | users |
| getCashPointsHistory | ç§¯åˆ†æ˜ç»† | cash_points_records |
| applyWithdraw | ç”³è¯·æç° | withdrawals, users |
| getWithdrawRecords | æç°è®°å½• | withdrawals |
| getMyReferees | æˆ‘æ¨èçš„äºº | users |

**éªŒè¯æ–¹å¼**ï¼š
```bash
# æœ¬åœ°æµ‹è¯•
cd cloudfunctions/user && npm install && node test.js

# æµ‹è¯•ç”¨ä¾‹
1. login - æ–°ç”¨æˆ·æ³¨å†Œã€è€ç”¨æˆ·ç™»å½•
2. getProfile - è·å–ç”¨æˆ·ä¿¡æ¯
3. updateProfile - æ›´æ–°å§“åã€æ‰‹æœº
4. getMyCourses - æŸ¥è¯¢è¯¾ç¨‹åˆ—è¡¨
```

**å®Œæˆåæ€»ç»“**ï¼š
- å·²å®ç°çš„actionåˆ—è¡¨
- æµ‹è¯•ç»“æœ
- é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ
- ä¸‹ä¸€æ­¥å‡†å¤‡

**ç”¨æˆ·æµ‹è¯•åç»§ç»­ä¸‹ä¸€æ­¥**

---

### æ­¥éª¤ 2ï¼šOrder äº‘å‡½æ•°ï¼ˆP0-2ï¼‰
**ç›®æ ‡**ï¼šå®ç°è®¢å•æ¨¡å—13ä¸ªaction

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆ›å»º `order/index.js` å…¥å£æ–‡ä»¶
- [ ] åˆ›å»º `order/package.json`
- [ ] åˆ›å»º `order/cloudfunction.json`ï¼ˆå«æ”¯ä»˜æƒé™ï¼‰
- [ ] â­ åŒæ­¥å…¬å…±æ¨¡å—ï¼šæ‰§è¡Œ `.\åŒæ­¥å…¬å…±æ¨¡å—.ps1`
- [ ] å®ç°1ä¸ªå…¬å¼€æ¥å£ï¼ˆpaymentCallbackï¼‰
- [ ] å®ç°8ä¸ªå®¢æˆ·ç«¯æ¥å£
- [ ] å®ç°4ä¸ªç®¡ç†ç«¯æ¥å£

**å…³é”®æ¥å£**ï¼š
| Action | åŠŸèƒ½ | æ¶‰åŠè¡¨ |
|--------|------|--------|
| create | åˆ›å»ºè®¢å• | orders, courses |
| createPayment | å‘èµ·æ”¯ä»˜ | orders |
| paymentCallback | æ”¯ä»˜å›è°ƒ | orders, user_courses, merit_points_records |
| getDetail | è®¢å•è¯¦æƒ… | orders |
| getList | è®¢å•åˆ—è¡¨ | orders |
| cancel | å–æ¶ˆè®¢å• | orders |
| getMallGoods | å•†åŸå•†å“ | mall_goods |
| exchangeGoods | å…‘æ¢å•†å“ | mall_exchange_records, merit_points_records |
| getExchangeRecords | å…‘æ¢è®°å½• | mall_exchange_records |

**æ³¨æ„**ï¼šæ”¯ä»˜ç›¸å…³åŠŸèƒ½ï¼ˆcreatePayment, paymentCallbackï¼‰æš‚æ—¶è¿”å›"åŠŸèƒ½å¼€å‘ä¸­"ï¼Œå¾…é…ç½®å•†æˆ·ä¿¡æ¯åå¯ç”¨

**éªŒè¯æ–¹å¼**ï¼š
```bash
# æµ‹è¯•ç”¨ä¾‹
1. create - åˆ›å»ºè¯¾ç¨‹è®¢å•
2. getList - æŸ¥è¯¢è®¢å•åˆ—è¡¨
3. cancel - å–æ¶ˆæœªæ”¯ä»˜è®¢å•
4. getMallGoods - æŸ¥è¯¢å•†åŸå•†å“
5. exchangeGoods - åŠŸå¾·åˆ†å…‘æ¢
```

**å®Œæˆåæ€»ç»“**ï¼š
- å·²å®ç°çš„actionåˆ—è¡¨
- æ”¯ä»˜åŠŸèƒ½çŠ¶æ€è¯´æ˜
- æµ‹è¯•ç»“æœ
- ä¸‹ä¸€æ­¥å‡†å¤‡

**ç”¨æˆ·æµ‹è¯•åç»§ç»­ä¸‹ä¸€æ­¥**

---

### æ­¥éª¤ 3ï¼šCourse äº‘å‡½æ•°ï¼ˆP1-1ï¼‰
**ç›®æ ‡**ï¼šå®ç°è¯¾ç¨‹æ¨¡å—34ä¸ªaction

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆ›å»º `course/index.js` å…¥å£æ–‡ä»¶
- [ ] åˆ›å»º `course/package.json`
- [ ] åˆ›å»º `course/cloudfunction.json`
- [ ] â­ åŒæ­¥å…¬å…±æ¨¡å—ï¼šæ‰§è¡Œ `.\åŒæ­¥å…¬å…±æ¨¡å—.ps1`
- [ ] å®ç°7ä¸ªå…¬å¼€æ¥å£ï¼ˆhandlers/public/ï¼‰
- [ ] å®ç°7ä¸ªå®¢æˆ·ç«¯æ¥å£ï¼ˆhandlers/client/ï¼‰
- [ ] å®ç°20ä¸ªç®¡ç†ç«¯æ¥å£ï¼ˆhandlers/admin/ï¼‰

**å…³é”®æ¥å£åˆ†ç»„**ï¼š
- è¯¾ç¨‹ç›¸å…³ï¼šgetList, getDetail, createCourse, updateCourse, deleteCourse
- é¢„çº¦ç›¸å…³ï¼šgetClassRecords, createAppointment, cancelAppointment, checkin
- æ¡ˆä¾‹ç›¸å…³ï¼šgetCaseList, getCaseDetail, createCase, updateCase, deleteCase
- èµ„æ–™ç›¸å…³ï¼šgetMaterialList, createMaterial, updateMaterial, deleteMaterial
- å•†å­¦é™¢ç›¸å…³ï¼šgetAcademyList, getAcademyDetail, recordAcademyProgress

**éªŒè¯æ–¹å¼**ï¼š
```bash
# æµ‹è¯•ç”¨ä¾‹
1. public:getList - è·å–è¯¾ç¨‹åˆ—è¡¨
2. public:getDetail - è·å–è¯¾ç¨‹è¯¦æƒ…
3. client:createAppointment - åˆ›å»ºé¢„çº¦
4. client:getMyAppointments - æˆ‘çš„é¢„çº¦
5. admin:getCourseList - ç®¡ç†ç«¯è¯¾ç¨‹åˆ—è¡¨
```

**å®Œæˆåæ€»ç»“**ï¼šå·²å®ç°åŠŸèƒ½ã€æµ‹è¯•ç»“æœã€ä¸‹ä¸€æ­¥å‡†å¤‡

**ç”¨æˆ·æµ‹è¯•åç»§ç»­ä¸‹ä¸€æ­¥**

---

### æ­¥éª¤ 4ï¼šAmbassador äº‘å‡½æ•°ï¼ˆP1-2ï¼‰
**ç›®æ ‡**ï¼šå®ç°å¤§ä½¿æ¨¡å—26ä¸ªaction

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆ›å»º `ambassador/index.js` å…¥å£æ–‡ä»¶
- [ ] åˆ›å»º `ambassador/package.json`
- [ ] åˆ›å»º `ambassador/cloudfunction.json`
- [ ] â­ åŒæ­¥å…¬å…±æ¨¡å—ï¼šæ‰§è¡Œ `.\åŒæ­¥å…¬å…±æ¨¡å—.ps1`
- [ ] å®ç°11ä¸ªå®¢æˆ·ç«¯æ¥å£
- [ ] å®ç°15ä¸ªç®¡ç†ç«¯æ¥å£

**å…³é”®æ¥å£åˆ†ç»„**ï¼š
- ç”³è¯·ç›¸å…³ï¼šapply, getApplicationStatus, auditApplication
- å‡çº§ç›¸å…³ï¼šupgrade, getUpgradeGuide
- åé¢ç›¸å…³ï¼šgetMyQuotas, giftQuota
- åè®®ç›¸å…³ï¼šgetContractTemplate, signContract, getMyContracts
- ç®¡ç†ç›¸å…³ï¼šgetAmbassadorList, getAmbassadorDetail

**éªŒè¯æ–¹å¼**ï¼š
```bash
# æµ‹è¯•ç”¨ä¾‹
1. client:apply - ç”³è¯·æˆä¸ºå¤§ä½¿
2. client:getApplicationStatus - æŸ¥è¯¢ç”³è¯·çŠ¶æ€
3. client:getMyQuotas - æŸ¥è¯¢åé¢
4. admin:getApplicationList - ç”³è¯·åˆ—è¡¨
5. admin:auditApplication - å®¡æ ¸ç”³è¯·
```

**å®Œæˆåæ€»ç»“**ï¼šå·²å®ç°åŠŸèƒ½ã€æµ‹è¯•ç»“æœã€ä¸‹ä¸€æ­¥å‡†å¤‡

**ç”¨æˆ·æµ‹è¯•åç»§ç»­ä¸‹ä¸€æ­¥**

---

### æ­¥éª¤ 5ï¼šSystem äº‘å‡½æ•°ï¼ˆP2ï¼‰
**ç›®æ ‡**ï¼šå®ç°ç³»ç»Ÿæ¨¡å—28ä¸ªaction

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆ›å»º `system/index.js` å…¥å£æ–‡ä»¶
- [ ] åˆ›å»º `system/package.json`
- [ ] åˆ›å»º `system/cloudfunction.json`
- [ ] â­ åŒæ­¥å…¬å…±æ¨¡å—ï¼šæ‰§è¡Œ `.\åŒæ­¥å…¬å…±æ¨¡å—.ps1`
- [ ] å®ç°6ä¸ªå®¢æˆ·ç«¯æ¥å£
- [ ] å®ç°22ä¸ªç®¡ç†ç«¯æ¥å£

**å…³é”®æ¥å£åˆ†ç»„**ï¼š
- ç®¡ç†å‘˜ï¼šlogin, createAdminUser, updateAdminUser, getAdminUserList
- é…ç½®ï¼šgetConfig, updateConfig, getAmbassadorLevelConfigs
- ç»Ÿè®¡ï¼šgetStatistics
- åé¦ˆï¼šsubmitFeedback, getFeedbackList, replyFeedback
- é€šçŸ¥ï¼šcreateNotificationConfig, sendNotification
- å…¬å‘Šï¼šcreateAnnouncement, getAnnouncementList

**éªŒè¯æ–¹å¼**ï¼š
```bash
# æµ‹è¯•ç”¨ä¾‹
1. admin:login - ç®¡ç†å‘˜ç™»å½•ï¼ˆJWTï¼‰
2. admin:getStatistics - ç»Ÿè®¡æ•°æ®
3. client:submitFeedback - æäº¤åé¦ˆ
4. admin:getAnnouncementList - å…¬å‘Šåˆ—è¡¨
```

**å®Œæˆåæ€»ç»“**ï¼šå·²å®ç°åŠŸèƒ½ã€æµ‹è¯•ç»“æœã€æ•´ä½“å®Œæˆæƒ…å†µ

---

### æ­¥éª¤ 6ï¼šCallbacks HTTPäº‘å‡½æ•°ï¼ˆP2-2ï¼‰
**ç›®æ ‡**ï¼šå®ç°ç»Ÿä¸€å›è°ƒå¤„ç†HTTPäº‘å‡½æ•°

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆ›å»º `callbacks/index.js` ä¸»å…¥å£ï¼ˆè·¯ç”±åˆ†å‘ï¼‰
- [ ] åˆ›å»º `callbacks/config.json`ï¼ˆHTTPè§¦å‘å™¨é…ç½®ï¼‰
- [ ] åˆ›å»º `callbacks/package.json`
- [ ] åˆ›å»º `callbacks/routes/` ç›®å½•
- [ ] å®ç°æ¶ˆæ¯æ¨é€å›è°ƒï¼ˆroutes/message-push.jsï¼‰
- [ ] å®ç°æ”¯ä»˜å›è°ƒï¼ˆroutes/payment.jsï¼‰
- [ ] å®ç°é€€æ¬¾å›è°ƒï¼ˆroutes/refund.jsï¼‰
- [ ] åˆ›å»º `callbacks/middleware/` ç›®å½•
- [ ] å®ç°éªŒç­¾ä¸­é—´ä»¶ï¼ˆmiddleware/verify.jsï¼‰
- [ ] å®ç°æ—¥å¿—ä¸­é—´ä»¶ï¼ˆmiddleware/logger.jsï¼‰

**å…³é”®å›è°ƒæ¥å£**ï¼š

| å›è°ƒç±»å‹ | URLè·¯å¾„ | HTTPæ–¹æ³• | è¯´æ˜ |
|---------|---------|---------|------|
| æ¶ˆæ¯æ¨é€ | /callbacks/message-push | GET/POST | å¾®ä¿¡å°ç¨‹åºæ¶ˆæ¯æ¨é€ï¼ˆæ¥å…¥éªŒè¯+äº‹ä»¶æ¥æ”¶ï¼‰ |
| æ”¯ä»˜å›è°ƒ | /callbacks/payment | POST | å¾®ä¿¡æ”¯ä»˜ç»“æœé€šçŸ¥ |
| é€€æ¬¾å›è°ƒ | /callbacks/refund | POST | å¾®ä¿¡é€€æ¬¾ç»“æœé€šçŸ¥ |

**é…ç½®è¦ç‚¹**ï¼š
```json
{
  "triggers": [
    {
      "name": "http-trigger",
      "type": "http",
      "config": {
        "path": "/callbacks",
        "method": "ALL",
        "authRequired": false
      }
    }
  ],
  "envVariables": {
    "WECHAT_TOKEN": "tiandao_wechat_2026",
    "WECHAT_ENCODING_AES_KEY": "abcdefghijklmnopqrstuvwxyz0123456789ABCDEFG",
    "MCH_ID": "1710089873",
    "MCH_KEY": "e6f4c2a8b1d5973820fedcba56789012"
  }
}
```

**éªŒè¯æ–¹å¼**ï¼š
```bash
# æµ‹è¯•æ¶ˆæ¯æ¨é€æ¥å…¥éªŒè¯ï¼ˆGETè¯·æ±‚ï¼‰
curl "https://xxx.com/callbacks/message-push?signature=xxx&timestamp=123&nonce=xxx&echostr=test"

# æµ‹è¯•æ”¯ä»˜å›è°ƒï¼ˆPOSTè¯·æ±‚ï¼‰
curl -X POST "https://xxx.com/callbacks/payment" \
  -H "Content-Type: application/xml" \
  -d '<xml>...</xml>'

# æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—
https://console.cloud.tencent.com/tcb/scf/detail?id=callbacks
```

**å®Œæˆåæ€»ç»“**ï¼š
- å·²å®ç°çš„å›è°ƒæ¥å£åˆ—è¡¨
- HTTPè§¦å‘å™¨é…ç½®æƒ…å†µ
- ç¬¬ä¸‰æ–¹å¹³å°é…ç½®è¯´æ˜ï¼ˆå¾®ä¿¡å…¬ä¼—å¹³å°ã€å•†æˆ·å¹³å°ï¼‰
- æµ‹è¯•ç»“æœ
- ä¸‹ä¸€æ­¥å‡†å¤‡

**ç”¨æˆ·æµ‹è¯•åç»§ç»­ä¸‹ä¸€æ­¥**

---

### æ­¥éª¤ 7ï¼šé›†æˆæµ‹è¯•ä¸æ–‡æ¡£ï¼ˆåŸæ­¥éª¤6ï¼‰
**ç›®æ ‡**ï¼šå…¨é¢æµ‹è¯•å’Œæ–‡æ¡£å®Œå–„

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•
- [ ] å®Œå–„å„äº‘å‡½æ•°README.md
- [ ] æ›´æ–°é¡¹ç›®æ–‡æ¡£
- [ ] éƒ¨ç½²è¯´æ˜æ–‡æ¡£

**æµ‹è¯•æµç¨‹**ï¼š
1. ç”¨æˆ·æ³¨å†Œ â†’ å®Œå–„èµ„æ–™ â†’ ç»‘å®šæ¨èäºº
2. æµè§ˆè¯¾ç¨‹ â†’ åˆ›å»ºè®¢å• â†’ æ”¯ä»˜ï¼ˆæ¨¡æ‹Ÿï¼‰
3. é¢„çº¦ä¸Šè¯¾ â†’ ç­¾åˆ°
4. ç”³è¯·å¤§ä½¿ â†’ å®¡æ ¸é€šè¿‡ â†’ å‡çº§
5. ç®¡ç†å‘˜ç™»å½• â†’ æŸ¥çœ‹ç»Ÿè®¡ â†’ ç®¡ç†æ•°æ®

---

## åä¸‰ã€æ€»æ–‡ä»¶æ•°ç»Ÿè®¡

| äº‘å‡½æ•° | å…¥å£æ–‡ä»¶ | é…ç½®æ–‡ä»¶ | Handleræ–‡ä»¶ | è·¯ç”±/ä¸­é—´ä»¶ | æ€»è®¡ |
|--------|---------|---------|------------|------------|------|
| config | - | 3 | - | - | 3 |
| user | 1 | 2 | 17 | - | 20 |
| course | 1 | 2 | 34 | - | 37 |
| order | 1 | 2 | 13 | - | 16 |
| ambassador | 1 | 2 | 26 | - | 29 |
| system | 1 | 2 | 28 | - | 31 |
| callbacks | 1 | 2 | - | 7 | 10 |
| **æ€»è®¡** | **6** | **15** | **118** | **7** | **146** |

**callbacks äº‘å‡½æ•°æ–‡ä»¶è¯´æ˜ï¼š**
- å…¥å£æ–‡ä»¶ï¼šindex.jsï¼ˆä¸»è·¯ç”±åˆ†å‘ï¼‰
- é…ç½®æ–‡ä»¶ï¼šconfig.json + package.json
- è·¯ç”±æ¨¡å—ï¼šroutes/message-push.js, routes/payment.js, routes/refund.js, routes/user-info.jsï¼ˆ4ä¸ªï¼‰
- ä¸­é—´ä»¶ï¼šmiddleware/verify.js, middleware/logger.js, middleware/rate-limit.jsï¼ˆ3ä¸ªï¼‰

---

## åå››ã€HTTPäº‘å‡½æ•°ä¸å›è°ƒæ¥å£è¯¦ç»†è¯´æ˜

### 14.1 ä¸ºä»€ä¹ˆéœ€è¦ callbacks äº‘å‡½æ•°ï¼Ÿ

**ä¸šåŠ¡éœ€æ±‚ï¼š**
1. **å¾®ä¿¡æ¶ˆæ¯æ¨é€**ï¼šæ¥æ”¶å¾®ä¿¡æœåŠ¡å™¨æ¨é€çš„è®¢é˜…æ¶ˆæ¯äº‹ä»¶ï¼ˆå‘é€æˆåŠŸ/ç”¨æˆ·æ‹’ç»ï¼‰
2. **å¾®ä¿¡æ”¯ä»˜å›è°ƒ**ï¼šæ¥æ”¶å¾®ä¿¡æ”¯ä»˜ç»“æœé€šçŸ¥ï¼Œæ›´æ–°è®¢å•çŠ¶æ€
3. **å¾®ä¿¡é€€æ¬¾å›è°ƒ**ï¼šæ¥æ”¶å¾®ä¿¡é€€æ¬¾ç»“æœé€šçŸ¥
4. **ç”¨æˆ·ä¿¡æ¯æˆæƒ**ï¼šæ¥æ”¶ç”¨æˆ·æˆæƒä¿¡æ¯å˜æ›´é€šçŸ¥

**æ¶æ„é€‰æ‹©ï¼šå•HTTPäº‘å‡½æ•° vs å¤šä¸ªç‹¬ç«‹äº‘å‡½æ•°**

æœ¬é¡¹ç›®é‡‡ç”¨**å•HTTPäº‘å‡½æ•°**ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å›è°ƒæ¥å£ï¼Œç†ç”±å¦‚ä¸‹ï¼š

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… ç»Ÿä¸€ç®¡ç† | æ‰€æœ‰å›è°ƒæ¥å£åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œä¾¿äºç»´æŠ¤ |
| âœ… ä»£ç å¤ç”¨ | å…±äº«éªŒç­¾ã€æ—¥å¿—ã€é”™è¯¯å¤„ç†é€»è¾‘ |
| âœ… å†·å¯åŠ¨ä¼˜åŒ– | å‡½æ•°æ•°é‡å°‘ï¼Œé«˜é¢‘å›è°ƒä¿æŒçƒ­å¯åŠ¨ |
| âœ… é…ç½®é›†ä¸­ | ç¯å¢ƒå˜é‡ã€Layeré…ç½®ç»Ÿä¸€ç®¡ç† |
| âœ… ç¬¦åˆç°æœ‰æ¶æ„ | ä¸"æ¨¡å—ä¼˜å…ˆæ¶æ„"ä¿æŒä¸€è‡´ |

### 14.2 è·¯å¾„åŒ¹é…æœºåˆ¶

**å…³é”®æ¦‚å¿µï¼š**
- é…ç½® `path: "/callbacks"` åï¼Œæ‰€æœ‰ä»¥ `/callbacks` å¼€å¤´çš„è·¯å¾„éƒ½ä¼šè·¯ç”±åˆ°è¿™ä¸ªå‡½æ•°
- é€šè¿‡ `event.path` è·å–å®Œæ•´è¯·æ±‚è·¯å¾„
- ä½¿ç”¨ `path.endsWith()` è¿›è¡Œè·¯å¾„åŒ¹é…ï¼Œå®ç°å†…éƒ¨è·¯ç”±åˆ†å‘

**è·¯å¾„æ˜ å°„è¡¨ï¼š**

| ç¬¬ä¸‰æ–¹å¹³å° | é…ç½®çš„URL | event.path | è·¯ç”±åŒ¹é… |
|-----------|----------|-----------|---------|
| å¾®ä¿¡æ¶ˆæ¯æ¨é€ | `https://xxx.com/callbacks/message-push` | `/callbacks/message-push` | `path.endsWith('/message-push')` |
| å¾®ä¿¡æ”¯ä»˜ | `https://xxx.com/callbacks/payment` | `/callbacks/payment` | `path.endsWith('/payment')` |
| å¾®ä¿¡é€€æ¬¾ | `https://xxx.com/callbacks/refund` | `/callbacks/refund` | `path.endsWith('/refund')` |

**æ‰§è¡Œæµç¨‹ï¼š**

```
å¤–éƒ¨è¯·æ±‚ â†’ CloudBaseè·¯ç”± â†’ callbacksäº‘å‡½æ•° â†’ å†…éƒ¨è·¯ç”±åˆ†å‘ â†’ å…·ä½“å¤„ç†æ¨¡å—

å¾®ä¿¡æ¶ˆæ¯æ¨é€
https://xxx.com/callbacks/message-push
         â†“
   CloudBase è·¯ç”±
         â†“
  callbacks äº‘å‡½æ•°
         â†“
  event.path = "/callbacks/message-push"
         â†“
  if (path.endsWith('/message-push')) âœ…
         â†“
  routes/message-push.js
```

### 14.3 æ¶ˆæ¯æ¨é€å›è°ƒå®ç°è¦ç‚¹

**æ¥å…¥éªŒè¯ï¼ˆGETè¯·æ±‚ï¼‰ï¼š**
1. å¾®ä¿¡æœåŠ¡å™¨å‘é€ GET è¯·æ±‚éªŒè¯æœåŠ¡å™¨åœ°å€
2. å‚æ•°ï¼šsignature, timestamp, nonce, echostr
3. éªŒè¯æ–¹å¼ï¼šå°† tokenã€timestampã€nonce æ’åºå SHA1 åŠ å¯†
4. éªŒè¯æˆåŠŸï¼šåŸæ ·è¿”å› echostr

**æ¶ˆæ¯æ¥æ”¶ï¼ˆPOSTè¯·æ±‚ï¼‰ï¼š**
1. æ¥æ”¶å¾®ä¿¡æ¨é€çš„äº‹ä»¶æ¶ˆæ¯ï¼ˆJSONæ ¼å¼ï¼‰
2. è§£ææ¶ˆæ¯ç±»å‹å’Œäº‹ä»¶ç±»å‹
3. å¤„ç†è®¢é˜…æ¶ˆæ¯äº‹ä»¶ï¼š
   - `subscribe_msg_sent_event`ï¼šæ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ›´æ–°å‘é€çŠ¶æ€
   - `subscribe_msg_popup_event`ï¼šç”¨æˆ·æ‹’ç»è®¢é˜…ï¼Œè®°å½•æ‹’ç»çŠ¶æ€
4. è¿”å› "success" å­—ç¬¦ä¸²ï¼ˆå¿…é¡»ï¼‰

**å…³é”®ä»£ç ç»“æ„ï¼š**

```javascript
// routes/message-push.js
exports.handler = async (event, context) => {
  const { httpMethod, queryStringParameters, body } = event;

  // GETè¯·æ±‚ï¼šæ¥å…¥éªŒè¯
  if (httpMethod === 'GET') {
    return handleVerification(queryStringParameters);
  }

  // POSTè¯·æ±‚ï¼šæ¥æ”¶æ¶ˆæ¯
  if (httpMethod === 'POST') {
    return await handleMessage(body);
  }
};
```

### 14.4 æ”¯ä»˜å›è°ƒå®ç°è¦ç‚¹

**éªŒç­¾æµç¨‹ï¼š**
1. è§£æ XML æ ¼å¼çš„å›è°ƒæ•°æ®
2. æå–ç­¾åå­—æ®µ `sign`
3. å°†å…¶ä»–å‚æ•°æŒ‰ key æ’åºåæ‹¼æ¥
4. æ‹¼æ¥å•†æˆ·å¯†é’¥å MD5 åŠ å¯†
5. å¯¹æ¯”ç­¾åæ˜¯å¦ä¸€è‡´

**ä¸šåŠ¡å¤„ç†ï¼š**
1. éªŒè¯æ”¯ä»˜ç»“æœï¼ˆreturn_code + result_codeï¼‰
2. æŸ¥è¯¢è®¢å•å¹¶åŠ é”ï¼ˆFOR UPDATEï¼‰
3. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆæ”¯ä»˜æˆåŠŸï¼‰
4. å‘æ”¾è¯¾ç¨‹æƒç›Š
5. å‘æ”¾æ¨èäººå¥–åŠ±
6. å‘é€è®¢é˜…æ¶ˆæ¯é€šçŸ¥
7. è¿”å› XML æ ¼å¼å“åº”

**å“åº”æ ¼å¼ï¼š**

```xml
<xml>
  <return_code><![CDATA[SUCCESS]]></return_code>
  <return_msg><![CDATA[OK]]></return_msg>
</xml>
```

### 14.5 å®‰å…¨æ³¨æ„äº‹é¡¹

| å®‰å…¨æªæ–½ | è¯´æ˜ |
|---------|------|
| âœ… å¿…é¡»éªŒç­¾ | æ‰€æœ‰å›è°ƒæ¥å£å¿…é¡»éªŒè¯ç­¾åï¼Œé˜²æ­¢æ¶æ„è¯·æ±‚ |
| âœ… é˜²é‡æ”¾æ”»å‡» | è®°å½• MsgId æˆ–è®¢å•å·ï¼Œé¿å…é‡å¤å¤„ç† |
| âœ… HTTPSåŠ å¯† | å›è°ƒåœ°å€å¿…é¡»ä½¿ç”¨ HTTPS åè®® |
| âœ… æ•æ„Ÿä¿¡æ¯ä¿æŠ¤ | Tokenã€å¯†é’¥å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­ |
| âœ… å¿«é€Ÿå“åº” | 5ç§’å†…è¿”å›ï¼Œé¿å…å¾®ä¿¡é‡å¤æ¨é€ |
| âœ… å¹‚ç­‰æ€§ | ç¡®ä¿é‡å¤æ¨é€ä¸ä¼šå¯¼è‡´æ•°æ®å¼‚å¸¸ |

### 14.6 é…ç½®æ¸…å•

**å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®ï¼ˆæ¶ˆæ¯æ¨é€ï¼‰ï¼š**
1. ç™»å½• https://mp.weixin.qq.com/
2. å¼€å‘ â†’ å¼€å‘è®¾ç½® â†’ æ¶ˆæ¯æ¨é€é…ç½®
3. æœåŠ¡å™¨åœ°å€ï¼š`https://xxx.com/callbacks/message-push`
4. Tokenï¼š`tiandao_wechat_2026`
5. EncodingAESKeyï¼š`abcdefghijklmnopqrstuvwxyz0123456789ABCDEFG`
6. æ¶ˆæ¯åŠ å¯†æ–¹å¼ï¼šæ˜æ–‡æ¨¡å¼ï¼ˆæˆ–å®‰å…¨æ¨¡å¼ï¼‰

**å¾®ä¿¡å•†æˆ·å¹³å°é…ç½®ï¼ˆæ”¯ä»˜å›è°ƒï¼‰ï¼š**
1. ç™»å½• https://pay.weixin.qq.com/
2. äº§å“ä¸­å¿ƒ â†’ å¼€å‘é…ç½®
3. æ”¯ä»˜ç»“æœé€šçŸ¥URLï¼š`https://xxx.com/callbacks/payment`
4. é€€æ¬¾ç»“æœé€šçŸ¥URLï¼š`https://xxx.com/callbacks/refund`

### 14.7 æµ‹è¯•éªŒè¯

**æµ‹è¯•æ¶ˆæ¯æ¨é€æ¥å…¥éªŒè¯ï¼š**
```bash
curl "https://xxx.com/callbacks/message-push?signature=xxx&timestamp=123&nonce=xxx&echostr=test"
# é¢„æœŸè¿”å›ï¼štest
```

**æµ‹è¯•è®¢é˜…æ¶ˆæ¯å›è°ƒï¼š**
```bash
curl -X POST "https://xxx.com/callbacks/message-push" \
  -H "Content-Type: application/json" \
  -d '{
    "ToUserName": "gh_xxxxxxxxxxxx",
    "FromUserName": "oMgHVjngRipVsoxxx",
    "CreateTime": 1707123456,
    "MsgType": "event",
    "Event": "subscribe_msg_sent_event",
    "SubscribeMsgSentEvent": {
      "List": [{
        "TemplateId": "xxx",
        "MsgId": "123456",
        "ErrorCode": 0,
        "ErrorStatus": "success"
      }]
    }
  }'
# é¢„æœŸè¿”å›ï¼šsuccess
```

**æŸ¥çœ‹æ—¥å¿—ï¼š**
```
https://console.cloud.tencent.com/tcb/scf/detail?id=callbacks
```

---
