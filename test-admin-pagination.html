<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å‘˜åˆ—è¡¨åˆ†é¡µæµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 24px;
    }
    .test-section {
      margin-bottom: 32px;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 4px;
      border-left: 4px solid #0052D9;
    }
    .test-title {
      font-size: 18px;
      font-weight: 600;
      color: #0052D9;
      margin-bottom: 12px;
    }
    .test-result {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .success {
      color: #52c41a;
      font-weight: 600;
    }
    .error {
      color: #ff4d4f;
      font-weight: 600;
    }
    .info {
      color: #1890ff;
    }
    button {
      background: #0052D9;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button:hover {
      background: #266FE8;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .field-check {
      display: flex;
      align-items: center;
      margin: 8px 0;
    }
    .field-check .icon {
      margin-right: 8px;
      font-size: 16px;
    }
    .summary {
      margin-top: 24px;
      padding: 16px;
      background: #e6f7ff;
      border-radius: 4px;
      border: 1px solid #91d5ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª ç®¡ç†å‘˜åˆ—è¡¨åˆ†é¡µåŠŸèƒ½æµ‹è¯•</h1>

    <div class="test-section">
      <div class="test-title">æµ‹è¯•è¯´æ˜</div>
      <p>æœ¬æµ‹è¯•å°†éªŒè¯ <code>system/handlers/admin/getAdminUserList.js</code> æ¥å£çš„åˆ†é¡µæ”¹é€ æ˜¯å¦æˆåŠŸã€‚</p>
      <p><strong>æ”¹é€ å†…å®¹ï¼š</strong></p>
      <ul>
        <li>âœ… ä½¿ç”¨ <code>executePaginatedQuery</code> æ›¿ä»£æ‰‹åŠ¨åˆ†é¡µ</li>
        <li>âœ… ç»Ÿä¸€è¿”å›æ ¼å¼ï¼Œæ–°å¢ <code>hasMore</code>ã€<code>totalPages</code>ã€<code>hasPrev</code> å­—æ®µ</li>
        <li>âœ… å…¼å®¹ <code>pageSize</code> å’Œ <code>page_size</code> å‚æ•°</li>
        <li>âœ… å‰ç«¯ä½¿ç”¨ <code>page_size</code> å‚æ•°</li>
      </ul>
    </div>

    <div class="test-section">
      <div class="test-title">æµ‹è¯•æ§åˆ¶</div>
      <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
      <button onclick="testFirstPage()">æµ‹è¯•ç¬¬ä¸€é¡µ</button>
      <button onclick="testSecondPage()">æµ‹è¯•ç¬¬äºŒé¡µ</button>
      <button onclick="testLastPage()">æµ‹è¯•æœ€åä¸€é¡µ</button>
      <button onclick="testEmptyResult()">æµ‹è¯•ç©ºç»“æœ</button>
      <button onclick="testPageSizeParam()">æµ‹è¯• pageSize å‚æ•°å…¼å®¹</button>
    </div>

    <div id="results"></div>

    <div id="summary" class="summary" style="display: none;">
      <h3>æµ‹è¯•æ€»ç»“</h3>
      <div id="summary-content"></div>
    </div>
  </div>

  <script>
    // æ¨¡æ‹Ÿ API è°ƒç”¨ï¼ˆå®é™…ç¯å¢ƒéœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„ API è°ƒç”¨ï¼‰
    const API_BASE = 'https://your-env-id.service.tcloudbase.com/system';
    const TOKEN = localStorage.getItem('admin_token') || 'test-token';

    let testResults = [];

    async function callAPI(params) {
      try {
        const response = await fetch(API_BASE, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'getAdminUserList',
            jwtToken: TOKEN,
            ...params
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        let result = await response.json();

        // è§£æ CloudBase HTTP API å“åº”
        if (result.body && typeof result.body === 'string') {
          result = JSON.parse(result.body);
        }

        return result;
      } catch (error) {
        console.error('API è°ƒç”¨å¤±è´¥:', error);
        throw error;
      }
    }

    function addTestResult(title, success, message, data = null) {
      const resultsDiv = document.getElementById('results');
      const testDiv = document.createElement('div');
      testDiv.className = 'test-section';

      const statusClass = success ? 'success' : 'error';
      const statusIcon = success ? 'âœ…' : 'âŒ';

      let html = `
        <div class="test-title">${statusIcon} ${title}</div>
        <div class="${statusClass}">${message}</div>
      `;

      if (data) {
        html += `<div class="test-result">${JSON.stringify(data, null, 2)}</div>`;
      }

      testDiv.innerHTML = html;
      resultsDiv.appendChild(testDiv);

      testResults.push({ title, success, message });
    }

    function checkResponseFields(data) {
      const requiredFields = ['list', 'total', 'page', 'pageSize', 'totalPages', 'hasMore', 'hasPrev'];
      const checks = [];

      for (const field of requiredFields) {
        const exists = field in data;
        checks.push({
          field,
          exists,
          value: exists ? data[field] : undefined
        });
      }

      return checks;
    }

    async function testFirstPage() {
      try {
        addTestResult('æµ‹è¯• 1ï¼šç¬¬ä¸€é¡µæ•°æ®', true, 'æ­£åœ¨æµ‹è¯•...', null);

        const result = await callAPI({ page: 1, page_size: 5 });

        if (!result.success) {
          throw new Error(result.message || 'è¯·æ±‚å¤±è´¥');
        }

        const data = result.data;
        const checks = checkResponseFields(data);

        let allPassed = true;
        let checkResults = 'å­—æ®µæ£€æŸ¥ï¼š\n';

        for (const check of checks) {
          const icon = check.exists ? 'âœ…' : 'âŒ';
          checkResults += `${icon} ${check.field}: ${check.exists ? JSON.stringify(check.value) : 'ç¼ºå¤±'}\n`;
          if (!check.exists) allPassed = false;
        }

        // éªŒè¯ç¬¬ä¸€é¡µç‰¹å®šå­—æ®µ
        const validations = [
          { name: 'page åº”è¯¥ä¸º 1', pass: data.page === 1 },
          { name: 'hasPrev åº”è¯¥ä¸º false', pass: data.hasPrev === false },
          { name: 'list åº”è¯¥æ˜¯æ•°ç»„', pass: Array.isArray(data.list) },
          { name: 'total åº”è¯¥å¤§äºç­‰äº 0', pass: data.total >= 0 },
          { name: 'totalPages è®¡ç®—æ­£ç¡®', pass: data.totalPages === Math.ceil(data.total / data.pageSize) }
        ];

        checkResults += '\né€»è¾‘éªŒè¯ï¼š\n';
        for (const v of validations) {
          const icon = v.pass ? 'âœ…' : 'âŒ';
          checkResults += `${icon} ${v.name}\n`;
          if (!v.pass) allPassed = false;
        }

        addTestResult(
          'æµ‹è¯• 1ï¼šç¬¬ä¸€é¡µæ•°æ®',
          allPassed,
          allPassed ? 'æ‰€æœ‰æ£€æŸ¥é€šè¿‡' : 'éƒ¨åˆ†æ£€æŸ¥å¤±è´¥',
          { checkResults, responseData: data }
        );

      } catch (error) {
        addTestResult('æµ‹è¯• 1ï¼šç¬¬ä¸€é¡µæ•°æ®', false, `æµ‹è¯•å¤±è´¥: ${error.message}`, null);
      }
    }

    async function testSecondPage() {
      try {
        addTestResult('æµ‹è¯• 2ï¼šç¬¬äºŒé¡µæ•°æ®', true, 'æ­£åœ¨æµ‹è¯•...', null);

        const result = await callAPI({ page: 2, page_size: 5 });

        if (!result.success) {
          throw new Error(result.message || 'è¯·æ±‚å¤±è´¥');
        }

        const data = result.data;

        const validations = [
          { name: 'page åº”è¯¥ä¸º 2', pass: data.page === 2 },
          { name: 'hasPrev åº”è¯¥ä¸º true', pass: data.hasPrev === true },
          { name: 'hasMore å­—æ®µå­˜åœ¨', pass: 'hasMore' in data }
        ];

        let allPassed = true;
        let checkResults = 'éªŒè¯ç»“æœï¼š\n';
        for (const v of validations) {
          const icon = v.pass ? 'âœ…' : 'âŒ';
          checkResults += `${icon} ${v.name}\n`;
          if (!v.pass) allPassed = false;
        }

        addTestResult(
          'æµ‹è¯• 2ï¼šç¬¬äºŒé¡µæ•°æ®',
          allPassed,
          allPassed ? 'æ‰€æœ‰æ£€æŸ¥é€šè¿‡' : 'éƒ¨åˆ†æ£€æŸ¥å¤±è´¥',
          { checkResults, responseData: data }
        );

      } catch (error) {
        addTestResult('æµ‹è¯• 2ï¼šç¬¬äºŒé¡µæ•°æ®', false, `æµ‹è¯•å¤±è´¥: ${error.message}`, null);
      }
    }

    async function testLastPage() {
      try {
        addTestResult('æµ‹è¯• 3ï¼šæœ€åä¸€é¡µæ•°æ®', true, 'æ­£åœ¨æµ‹è¯•...', null);

        // å…ˆè·å–æ€»æ•°
        const firstResult = await callAPI({ page: 1, page_size: 5 });
        if (!firstResult.success) {
          throw new Error('è·å–æ€»æ•°å¤±è´¥');
        }

        const totalPages = firstResult.data.totalPages;

        // è¯·æ±‚æœ€åä¸€é¡µ
        const result = await callAPI({ page: totalPages, page_size: 5 });

        if (!result.success) {
          throw new Error(result.message || 'è¯·æ±‚å¤±è´¥');
        }

        const data = result.data;

        const validations = [
          { name: `page åº”è¯¥ä¸º ${totalPages}`, pass: data.page === totalPages },
          { name: 'hasMore åº”è¯¥ä¸º false', pass: data.hasMore === false },
          { name: 'hasPrev åº”è¯¥ä¸º true (å¦‚æœæ€»é¡µæ•°>1)', pass: totalPages > 1 ? data.hasPrev === true : true }
        ];

        let allPassed = true;
        let checkResults = 'éªŒè¯ç»“æœï¼š\n';
        for (const v of validations) {
          const icon = v.pass ? 'âœ…' : 'âŒ';
          checkResults += `${icon} ${v.name}\n`;
          if (!v.pass) allPassed = false;
        }

        addTestResult(
          'æµ‹è¯• 3ï¼šæœ€åä¸€é¡µæ•°æ®',
          allPassed,
          allPassed ? 'æ‰€æœ‰æ£€æŸ¥é€šè¿‡' : 'éƒ¨åˆ†æ£€æŸ¥å¤±è´¥',
          { checkResults, totalPages, responseData: data }
        );

      } catch (error) {
        addTestResult('æµ‹è¯• 3ï¼šæœ€åä¸€é¡µæ•°æ®', false, `æµ‹è¯•å¤±è´¥: ${error.message}`, null);
      }
    }

    async function testEmptyResult() {
      try {
        addTestResult('æµ‹è¯• 4ï¼šç©ºç»“æœå¤„ç†', true, 'æ­£åœ¨æµ‹è¯•...', null);

        // ä½¿ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„çŠ¶æ€å€¼æ¥è·å–ç©ºç»“æœ
        const result = await callAPI({ page: 1, page_size: 10, status: 999 });

        if (!result.success) {
          throw new Error(result.message || 'è¯·æ±‚å¤±è´¥');
        }

        const data = result.data;

        const validations = [
          { name: 'list åº”è¯¥æ˜¯ç©ºæ•°ç»„', pass: Array.isArray(data.list) && data.list.length === 0 },
          { name: 'total åº”è¯¥ä¸º 0', pass: data.total === 0 },
          { name: 'totalPages åº”è¯¥ä¸º 0', pass: data.totalPages === 0 },
          { name: 'hasMore åº”è¯¥ä¸º false', pass: data.hasMore === false }
        ];

        let allPassed = true;
        let checkResults = 'éªŒè¯ç»“æœï¼š\n';
        for (const v of validations) {
          const icon = v.pass ? 'âœ…' : 'âŒ';
          checkResults += `${icon} ${v.name}\n`;
          if (!v.pass) allPassed = false;
        }

        addTestResult(
          'æµ‹è¯• 4ï¼šç©ºç»“æœå¤„ç†',
          allPassed,
          allPassed ? 'æ‰€æœ‰æ£€æŸ¥é€šè¿‡' : 'éƒ¨åˆ†æ£€æŸ¥å¤±è´¥',
          { checkResults, responseData: data }
        );

      } catch (error) {
        addTestResult('æµ‹è¯• 4ï¼šç©ºç»“æœå¤„ç†', false, `æµ‹è¯•å¤±è´¥: ${error.message}`, null);
      }
    }

    async function testPageSizeParam() {
      try {
        addTestResult('æµ‹è¯• 5ï¼špageSize å‚æ•°å…¼å®¹æ€§', true, 'æ­£åœ¨æµ‹è¯•...', null);

        // ä½¿ç”¨ pageSize å‚æ•°ï¼ˆé©¼å³°å‘½åï¼‰
        const result = await callAPI({ page: 1, pageSize: 3 });

        if (!result.success) {
          throw new Error(result.message || 'è¯·æ±‚å¤±è´¥');
        }

        const data = result.data;

        const validations = [
          { name: 'pageSize å‚æ•°è¢«æ­£ç¡®è¯†åˆ«', pass: data.pageSize === 3 },
          { name: 'list é•¿åº¦ä¸è¶…è¿‡ pageSize', pass: data.list.length <= 3 }
        ];

        let allPassed = true;
        let checkResults = 'éªŒè¯ç»“æœï¼š\n';
        for (const v of validations) {
          const icon = v.pass ? 'âœ…' : 'âŒ';
          checkResults += `${icon} ${v.name}\n`;
          if (!v.pass) allPassed = false;
        }

        addTestResult(
          'æµ‹è¯• 5ï¼špageSize å‚æ•°å…¼å®¹æ€§',
          allPassed,
          allPassed ? 'æ‰€æœ‰æ£€æŸ¥é€šè¿‡ - åç«¯å…¼å®¹é©¼å³°å‘½å' : 'éƒ¨åˆ†æ£€æŸ¥å¤±è´¥',
          { checkResults, responseData: data }
        );

      } catch (error) {
        addTestResult('æµ‹è¯• 5ï¼špageSize å‚æ•°å…¼å®¹æ€§', false, `æµ‹è¯•å¤±è´¥: ${error.message}`, null);
      }
    }

    async function runAllTests() {
      // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
      document.getElementById('results').innerHTML = '';
      testResults = [];

      // è¿è¡Œæ‰€æœ‰æµ‹è¯•
      await testFirstPage();
      await new Promise(resolve => setTimeout(resolve, 500));

      await testSecondPage();
      await new Promise(resolve => setTimeout(resolve, 500));

      await testLastPage();
      await new Promise(resolve => setTimeout(resolve, 500));

      await testEmptyResult();
      await new Promise(resolve => setTimeout(resolve, 500));

      await testPageSizeParam();

      // æ˜¾ç¤ºæ€»ç»“
      showSummary();
    }

    function showSummary() {
      const summaryDiv = document.getElementById('summary');
      const summaryContent = document.getElementById('summary-content');

      const total = testResults.length;
      const passed = testResults.filter(r => r.success).length;
      const failed = total - passed;

      const passRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;

      summaryContent.innerHTML = `
        <p><strong>æ€»æµ‹è¯•æ•°ï¼š</strong>${total}</p>
        <p><strong class="success">é€šè¿‡ï¼š</strong>${passed}</p>
        <p><strong class="error">å¤±è´¥ï¼š</strong>${failed}</p>
        <p><strong>é€šè¿‡ç‡ï¼š</strong>${passRate}%</p>
        ${passed === total ? '<p class="success">ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼åˆ†é¡µæ”¹é€ æˆåŠŸï¼</p>' : '<p class="error">âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é—®é¢˜ã€‚</p>'}
      `;

      summaryDiv.style.display = 'block';
    }

    // é¡µé¢åŠ è½½æ—¶çš„æç¤º
    window.onload = function() {
      console.log('æµ‹è¯•é¡µé¢å·²åŠ è½½');
      console.log('è¯·ç¡®ä¿ï¼š');
      console.log('1. å·²ç™»å½•ç®¡ç†åå°å¹¶è·å– token');
      console.log('2. ä¿®æ”¹ API_BASE ä¸ºå®é™…çš„äº‘å‡½æ•°åœ°å€');
      console.log('3. äº‘å‡½æ•°å·²éƒ¨ç½²æœ€æ–°ä»£ç ');
    };
  </script>
</body>
</html>
