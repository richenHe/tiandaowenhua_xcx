# å¤©é“æ–‡åŒ–å°ç¨‹åº - äº‘å‡½æ•°å¼€å‘è§„èŒƒ

> **ç‰ˆæœ¬**: V2.0  
> **æ›´æ–°æ—¶é—´**: 2026-02-04  
> **CloudBase ç¯å¢ƒ**: cloud1-0gnn3mn17b581124  
> **æ¶æ„æ¨¡å¼**: æ¨¡å—ä¼˜å…ˆï¼ˆå•å‡½æ•°å¤šè·¯ç”±ï¼Œé€šè¿‡ action å‚æ•°åŒºåˆ†æ“ä½œï¼‰

---

## ğŸ“‹ ç›®å½•

1. [äº‘å‡½æ•°æ¶æ„](#1-äº‘å‡½æ•°æ¶æ„)
2. [ç›®å½•ç»“æ„](#2-ç›®å½•ç»“æ„)
3. [å¼€å‘è§„èŒƒ](#3-å¼€å‘è§„èŒƒ)
4. [å…¬å…±å±‚ä½¿ç”¨](#4-å…¬å…±å±‚ä½¿ç”¨)
5. [ä»£ç ç¤ºä¾‹](#5-ä»£ç ç¤ºä¾‹)
6. [æ‰§è¡Œæµç¨‹](#6-æ‰§è¡Œæµç¨‹)
7. [æ³¨æ„äº‹é¡¹](#7-æ³¨æ„äº‹é¡¹)
8. [å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)

---

## 1. äº‘å‡½æ•°æ¶æ„

### 1.1 æ•´ä½“æ¶æ„

æœ¬é¡¹ç›®é‡‡ç”¨**äº‘å‡½æ•°ä½œä¸ºå”¯ä¸€æ•°æ®è®¿é—®å±‚**ï¼Œå‰åç«¯ç»Ÿä¸€é€šè¿‡äº‘å‡½æ•°æ“ä½œæ•°æ®åº“ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åº”ç”¨å±‚ï¼ˆApplicationï¼‰                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å°ç¨‹åºç«¯ï¼ˆMini Programï¼‰    â”‚    ç®¡ç†åå°ï¼ˆAdmin Panelï¼‰     â”‚
â”‚   - ç”¨æˆ·æ“ä½œç•Œé¢               â”‚    - ç®¡ç†å‘˜æ“ä½œç•Œé¢            â”‚
â”‚   - ä¸šåŠ¡é€»è¾‘å±•ç¤º               â”‚    - æ•°æ®ç®¡ç†                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                â”‚
               â”‚    é€šè¿‡ callFunction è°ƒç”¨      â”‚
               â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº‘å‡½æ•°å±‚ï¼ˆCloud Functionsï¼‰                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸šåŠ¡é€»è¾‘å±‚                                                    â”‚
â”‚  - è‡ªåŠ¨è·å– openidï¼ˆç”¨æˆ·èº«ä»½è¯†åˆ«ï¼‰                            â”‚
â”‚  - æƒé™éªŒè¯ï¼ˆadmin/client/publicï¼‰                           â”‚
â”‚  - æ•°æ®éªŒè¯                                                    â”‚
â”‚  - ä¸šåŠ¡è§„åˆ™æ‰§è¡Œ                                                â”‚
â”‚  - æ•°æ®è½¬æ¢                                                    â”‚
â”‚                                                               â”‚
â”‚  å…±äº«å±‚ï¼ˆLayersï¼‰                                              â”‚
â”‚  - æ•°æ®åº“å·¥å…·åº“ï¼ˆdb-utilsï¼‰                                    â”‚
â”‚  - é€šç”¨å·¥å…·å‡½æ•°ï¼ˆcommon-utilsï¼‰                                â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆbusiness-logicï¼‰                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ SQL æ“ä½œï¼ˆè‡ªåŠ¨æ³¨å…¥ _openidï¼‰
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CloudBase MySQL æ•°æ®åº“                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®å­˜å‚¨å±‚                                                    â”‚
â”‚  - 28å¼ ä¸šåŠ¡è¡¨                                                  â”‚
â”‚  - _openid å­—æ®µï¼ˆç”¨æˆ·æ•°æ®éš”ç¦»ï¼‰                                â”‚
â”‚  - ç´¢å¼•ä¼˜åŒ–                                                    â”‚
â”‚  - å®‰å…¨è§„åˆ™ï¼šADMINONLYï¼ˆå¼ºåˆ¶é€šè¿‡äº‘å‡½æ•°è®¿é—®ï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¶æ„ä¼˜åŠ¿

**âœ… å®‰å…¨æ€§**
- å‰ç«¯æ— æ³•ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œé˜²æ­¢ SQL æ³¨å…¥å’Œæ¶æ„æ“ä½œ
- äº‘å‡½æ•°è‡ªåŠ¨è·å– `openid`ï¼Œé˜²æ­¢å‰ç«¯ä¼ªé€ ç”¨æˆ·èº«ä»½
- æ•°æ®åº“è®¾ç½® `ADMINONLY` è§„åˆ™ï¼Œå¼ºåˆ¶é€šè¿‡äº‘å‡½æ•°è®¿é—®

**âœ… å¯æ§æ€§**
- æ‰€æœ‰ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨äº‘å‡½æ•°ï¼Œä¾¿äºç»´æŠ¤å’Œå‡çº§
- æƒé™æ§åˆ¶ç»Ÿä¸€ç®¡ç†ï¼Œé¿å…å‰ç«¯ç»•è¿‡æ£€æŸ¥
- æ•°æ®éªŒè¯å’Œè½¬æ¢åœ¨æœåŠ¡ç«¯å®Œæˆï¼Œç¡®ä¿æ•°æ®è´¨é‡

**âœ… çµæ´»æ€§**
- äº‘å‡½æ•°å¯ä»¥è‡ªç”±ç»„åˆå¤šè¡¨æŸ¥è¯¢ã€äº‹åŠ¡å¤„ç†ç­‰å¤æ‚æ“ä½œ
- æ˜“äºå®ç°ç¼“å­˜ã€é™æµã€æ—¥å¿—ç­‰ä¸­é—´ä»¶åŠŸèƒ½
- ä¾¿äºè¿›è¡Œ A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒ

### 1.3 æ¨¡å—ä¼˜å…ˆæ¶æ„

**ã€æ¨èã€‘å•å‡½æ•°å¤šè·¯ç”±ï¼ˆé€šè¿‡ action å‚æ•°åŒºåˆ†æ“ä½œï¼‰**

```
ğŸ“¦ 5ä¸ªæ ¸å¿ƒäº‘å‡½æ•°ï¼ˆæŒ‰ä¸šåŠ¡æ¨¡å—åˆ’åˆ†ï¼‰
â”œâ”€â”€ user/              # ç”¨æˆ·æ¨¡å—ï¼ˆç”¨æˆ·ä¿¡æ¯ã€è¯¾ç¨‹ã€è®¢å•ã€ç§¯åˆ†ç­‰ï¼‰
â”œâ”€â”€ course/            # è¯¾ç¨‹æ¨¡å—ï¼ˆè¯¾ç¨‹åˆ—è¡¨ã€è¯¦æƒ…ã€é¢„çº¦ç­‰ï¼‰
â”œâ”€â”€ order/             # è®¢å•æ¨¡å—ï¼ˆåˆ›å»ºã€æ”¯ä»˜ã€å–æ¶ˆã€é€€æ¬¾ç­‰ï¼‰
â”œâ”€â”€ ambassador/        # å¤§ä½¿æ¨¡å—ï¼ˆç”³è¯·ã€é‚€è¯·ã€åé¢ã€æç°ç­‰ï¼‰
â””â”€â”€ system/            # ç³»ç»Ÿæ¨¡å—ï¼ˆé…ç½®ã€ç»Ÿè®¡ã€å…¬å‘Šç­‰ï¼‰

ğŸ”§ 3ä¸ªå…¬å…±å±‚ï¼ˆä»£ç å¤ç”¨ï¼‰
â”œâ”€â”€ layers/db-utils/       # æ•°æ®åº“æ“ä½œå·¥å…·
â”œâ”€â”€ layers/common-utils/   # é€šç”¨å·¥å…·å‡½æ•°ï¼ˆæƒé™ã€å“åº”ã€éªŒè¯ç­‰ï¼‰
â””â”€â”€ layers/business-logic/ # ä¸šåŠ¡é€»è¾‘ï¼ˆå¯é€‰ï¼‰
```

**æ¶æ„ä¼˜åŠ¿ï¼š**

1. âœ… **å‡½æ•°æ•°é‡å°‘**ï¼š5ä¸ªæ ¸å¿ƒå‡½æ•°ï¼Œæ˜“äºç®¡ç†
2. âœ… **å†·å¯åŠ¨æ¦‚ç‡ä½**ï¼šå‡½æ•°è°ƒç”¨é¢‘ç‡é«˜ï¼Œå®ä¾‹é•¿æœŸä¿æŒçƒ­å¯åŠ¨
3. âœ… **æƒé™æ§åˆ¶çµæ´»**ï¼šé€šè¿‡ `action` å‰ç¼€ï¼ˆpublic:/client:/admin:ï¼‰åŒºåˆ†æƒé™
4. âœ… **ä¸šåŠ¡é€»è¾‘é›†ä¸­**ï¼šåŒä¸€æ¨¡å—çš„ä»£ç åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œä¾¿äºç»´æŠ¤
5. âœ… **ä»£ç å¤ç”¨æ€§é«˜**ï¼šå…¬å¼€æ¥å£ã€ç”¨æˆ·æ¥å£ã€ç®¡ç†æ¥å£å¯å…±äº«é€»è¾‘

---

## 2. ç›®å½•ç»“æ„

### 2.1 æ¨èç»“æ„

```
cloudfunctions/                                # äº‘å‡½æ•°æ ¹ç›®å½•
â”‚
â”œâ”€â”€ user/                                      # ã€ç”¨æˆ·æ¨¡å—äº‘å‡½æ•°ã€‘
â”‚   â”œâ”€â”€ index.js                               # ä¸»å…¥å£ï¼ˆå¤„ç†æ‰€æœ‰ç”¨æˆ·ç›¸å…³æ“ä½œï¼‰
â”‚   â”œâ”€â”€ config.json                            # å±‚é…ç½®
â”‚   â””â”€â”€ package.json                           # ä¾èµ–é…ç½®
â”‚       # æ”¯æŒçš„ actionï¼š
â”‚       # - client:getMyCourses       è·å–æˆ‘çš„è¯¾ç¨‹
â”‚       # - client:getMyOrders        è·å–æˆ‘çš„è®¢å•
â”‚       # - client:updateProfile      æ›´æ–°ä¸ªäººèµ„æ–™
â”‚       # - client:getMeritPoints     è·å–åŠŸå¾·ç§¯åˆ†
â”‚       # - admin:getAllUsers         ç®¡ç†å‘˜è·å–æ‰€æœ‰ç”¨æˆ·
â”‚       # - admin:updateUser          ç®¡ç†å‘˜æ›´æ–°ç”¨æˆ·
â”‚       # - admin:deleteUser          ç®¡ç†å‘˜åˆ é™¤ç”¨æˆ·
â”‚
â”œâ”€â”€ course/                                    # ã€è¯¾ç¨‹æ¨¡å—äº‘å‡½æ•°ã€‘
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ config.json
â”‚   â””â”€â”€ package.json
â”‚       # æ”¯æŒçš„ actionï¼š
â”‚       # - public:getList             å…¬å¼€è·å–è¯¾ç¨‹åˆ—è¡¨
â”‚       # - public:getDetail           å…¬å¼€è·å–è¯¾ç¨‹è¯¦æƒ…
â”‚       # - client:makeAppointment     ç”¨æˆ·é¢„çº¦è¯¾ç¨‹
â”‚       # - admin:create               ç®¡ç†å‘˜åˆ›å»ºè¯¾ç¨‹
â”‚       # - admin:update               ç®¡ç†å‘˜æ›´æ–°è¯¾ç¨‹
â”‚
â”œâ”€â”€ order/                                     # ã€è®¢å•æ¨¡å—äº‘å‡½æ•°ã€‘
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ config.json
â”‚   â””â”€â”€ package.json
â”‚       # æ”¯æŒçš„ actionï¼š
â”‚       # - client:create              ç”¨æˆ·åˆ›å»ºè®¢å•
â”‚       # - client:pay                 ç”¨æˆ·æ”¯ä»˜è®¢å•
â”‚       # - client:cancel              ç”¨æˆ·å–æ¶ˆè®¢å•
â”‚       # - admin:getAll               ç®¡ç†å‘˜è·å–æ‰€æœ‰è®¢å•
â”‚       # - admin:refund               ç®¡ç†å‘˜é€€æ¬¾
â”‚
â”œâ”€â”€ ambassador/                                # ã€å¤§ä½¿æ¨¡å—äº‘å‡½æ•°ã€‘
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ config.json
â”‚   â””â”€â”€ package.json
â”‚       # æ”¯æŒçš„ actionï¼š
â”‚       # - client:apply                ç”¨æˆ·ç”³è¯·å¤§ä½¿
â”‚       # - client:invite               å¤§ä½¿é‚€è¯·ç”¨æˆ·
â”‚       # - client:getQuota             å¤§ä½¿è·å–åé¢
â”‚       # - admin:approve               ç®¡ç†å‘˜å®¡æ‰¹ç”³è¯·
â”‚
â”œâ”€â”€ system/                                    # ã€ç³»ç»Ÿæ¨¡å—äº‘å‡½æ•°ã€‘
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ config.json
â”‚   â””â”€â”€ package.json
â”‚       # æ”¯æŒçš„ actionï¼š
â”‚       # - admin:getConfig             è·å–ç³»ç»Ÿé…ç½®
â”‚       # - admin:updateConfig          æ›´æ–°ç³»ç»Ÿé…ç½®
â”‚       # - admin:getStatistics         è·å–ç³»ç»Ÿç»Ÿè®¡
â”‚
â””â”€â”€ layers/                                    # ã€å±‚ç›®å½•ã€‘ï¼ˆå…±äº«ä»£ç ï¼‰
    â”œâ”€â”€ db-utils/                              # æ•°æ®åº“å·¥å…·å±‚
    â”‚   â”œâ”€â”€ nodejs/
    â”‚   â”‚   â””â”€â”€ node_modules/                  # MySQL é©±åŠ¨ç­‰ä¾èµ–
    â”‚   â”œâ”€â”€ index.js                           # å¯¼å‡ºæ•°æ®åº“è¿æ¥å’ŒæŸ¥è¯¢å·¥å…·
    â”‚   â””â”€â”€ package.json
    â”‚
    â”œâ”€â”€ common-utils/                          # é€šç”¨å·¥å…·å±‚
    â”‚   â”œâ”€â”€ index.js                           # æƒé™éªŒè¯ã€å“åº”æ ¼å¼åŒ–ç­‰
    â”‚   â””â”€â”€ package.json
    â”‚
    â””â”€â”€ business-logic/                        # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆå¯é€‰ï¼‰
        â”œâ”€â”€ index.js                           # ç§¯åˆ†è®¡ç®—ã€è®¢å•å¤„ç†ç­‰
        â””â”€â”€ package.json
```

### 2.2 æ–‡ä»¶è¯´æ˜

#### 2.2.1 äº‘å‡½æ•°æ–‡ä»¶

**index.js** - äº‘å‡½æ•°ä¸»å…¥å£
```javascript
// å¿…é¡»å¯¼å‡º main å‡½æ•°ä½œä¸ºå…¥å£
exports.main = async (event, context) => {
  // event: å‰ç«¯ä¼ å…¥çš„å‚æ•°
  // context: äº‘å‡½æ•°ä¸Šä¸‹æ–‡ï¼ˆåŒ…å« OPENID ç­‰ä¿¡æ¯ï¼‰
  
  const { action, ...params } = event;
  const { OPENID } = cloud.getWXContext();
  
  // æ ¹æ® action åˆ†å‘åˆ°ä¸åŒçš„å¤„ç†å‡½æ•°
  // ...
}
```

**config.json** - äº‘å‡½æ•°é…ç½®ï¼ˆå±‚ç»‘å®šï¼‰
```json
{
  "permissions": {
    "openapi": []
  },
  "triggers": [],
  "layers": [
    {
      "name": "db-utils",
      "version": 1
    },
    {
      "name": "common-utils",
      "version": 1
    }
  ]
}
```

**package.json** - ä¾èµ–ç®¡ç†
```json
{
  "name": "user",
  "version": "1.0.0",
  "description": "ç”¨æˆ·æ¨¡å—äº‘å‡½æ•°",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "latest"
  }
}
```

#### 2.2.2 å±‚æ–‡ä»¶

å±‚çš„æ–‡ä»¶ä¼šè¢«æŒ‚è½½åˆ° `/opt` ç›®å½•ï¼Œåœ¨äº‘å‡½æ•°ä¸­é€šè¿‡ `require('/opt/...')` å¼•ç”¨ã€‚

---

## 3. å¼€å‘è§„èŒƒ

### 3.1 Action å‘½åè§„èŒƒ

**æ ¼å¼ï¼š`{namespace}:{operation}`**

#### 3.1.1 Namespaceï¼ˆæƒé™å‘½åç©ºé—´ï¼‰

| Namespace | è¯´æ˜ | æƒé™è¦æ±‚ | ä½¿ç”¨åœºæ™¯ |
|-----------|-----|---------|---------|
| `public` | å…¬å¼€æ¥å£ | æ— éœ€ç™»å½• | è¯¾ç¨‹åˆ—è¡¨ã€å…¬å‘Šåˆ—è¡¨ç­‰ |
| `client` | å®¢æˆ·ç«¯æ¥å£ | éœ€è¦ç™»å½•ï¼ˆæ™®é€šç”¨æˆ·ï¼‰ | æˆ‘çš„è¯¾ç¨‹ã€æˆ‘çš„è®¢å•ç­‰ |
| `admin` | ç®¡ç†ç«¯æ¥å£ | éœ€è¦ç®¡ç†å‘˜æƒé™ | ç”¨æˆ·ç®¡ç†ã€æ•°æ®ç»Ÿè®¡ç­‰ |

#### 3.1.2 Operationï¼ˆæ“ä½œç±»å‹ï¼‰

| å‰ç¼€ | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|
| `get*` | æŸ¥è¯¢æ“ä½œ | getList, getDetail, getMyCourses |
| `create*` | åˆ›å»ºæ“ä½œ | create, createOrder |
| `update*` | æ›´æ–°æ“ä½œ | update, updateProfile |
| `delete*` | åˆ é™¤æ“ä½œ | delete, deleteUser |
| åŠ¨è¯ | å…¶ä»–æ“ä½œ | apply, approve, pay, cancel |

#### 3.1.3 å‘½åç¤ºä¾‹

```javascript
// âœ… æ¨èå†™æ³•
'public:getList'           // å…¬å¼€è·å–åˆ—è¡¨
'public:getDetail'         // å…¬å¼€è·å–è¯¦æƒ…
'client:getMyCourses'      // ç”¨æˆ·è·å–è‡ªå·±çš„è¯¾ç¨‹
'client:createOrder'       // ç”¨æˆ·åˆ›å»ºè®¢å•
'client:updateProfile'     // ç”¨æˆ·æ›´æ–°ä¸ªäººèµ„æ–™
'admin:getAllUsers'        // ç®¡ç†å‘˜è·å–æ‰€æœ‰ç”¨æˆ·
'admin:approve'            // ç®¡ç†å‘˜å®¡æ‰¹
'admin:getStatistics'      // ç®¡ç†å‘˜è·å–ç»Ÿè®¡æ•°æ®

// âŒ ä¸æ¨èå†™æ³•
'getUserCourses'           // ç¼ºå°‘å‘½åç©ºé—´ï¼Œæ— æ³•åŒºåˆ†æƒé™
'admin_getAllUsers'        // ä½¿ç”¨ä¸‹åˆ’çº¿ï¼Œä¸ç¬¦åˆè§„èŒƒ
'getList'                  // ç¼ºå°‘å‘½åç©ºé—´
```

### 3.2 æƒé™éªŒè¯è§„èŒƒ

#### 3.2.1 è·å–ç”¨æˆ·èº«ä»½

```javascript
const cloud = require('wx-server-sdk');
cloud.init();

exports.main = async (event, context) => {
  // âœ… è‡ªåŠ¨è·å–å½“å‰ç”¨æˆ· openid
  const { OPENID } = cloud.getWXContext();
  
  // âŒ ä¸è¦ä»å‰ç«¯æ¥æ”¶ openidï¼ˆå¯ä»¥è¢«ä¼ªé€ ï¼‰
  // const { openid } = event; // é”™è¯¯ï¼
}
```

#### 3.2.2 æƒé™æ£€æŸ¥æµç¨‹

```javascript
exports.main = async (event, context) => {
  const { action, ...params } = event;
  const { OPENID } = cloud.getWXContext();
  
  try {
    // ==================== å…¬å¼€è·¯ç”±ï¼ˆæ— éœ€æƒé™ï¼‰====================
    if (action.startsWith('public:')) {
      return await handlePublicRequest(action, params);
    }
    
    // ==================== å®¢æˆ·ç«¯è·¯ç”±ï¼ˆéœ€è¦ç™»å½•ï¼‰==================
    if (action.startsWith('client:')) {
      // éªŒè¯ç”¨æˆ·èº«ä»½
      const user = await checkClientAuth(OPENID);
      return await handleClientRequest(OPENID, user, action, params);
    }
    
    // ==================== ç®¡ç†ç«¯è·¯ç”±ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰============
    if (action.startsWith('admin:')) {
      // éªŒè¯ç®¡ç†å‘˜æƒé™
      const admin = await checkAdminAuth(OPENID);
      return await handleAdminRequest(OPENID, admin, action, params);
    }
    
    throw new Error(`æœªçŸ¥æ“ä½œ: ${action}`);
    
  } catch (error) {
    return errorResponse(error.message, error);
  }
}
```

### 3.3 æ•°æ®åº“æ“ä½œè§„èŒƒ

#### 3.3.1 è‡ªåŠ¨æ³¨å…¥ _openid

```javascript
// âœ… æ¨èï¼šæŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤ä¸ºå½“å‰ç”¨æˆ·çš„æ•°æ®
const myCourses = await db.query(
  'SELECT * FROM user_courses WHERE _openid = ?',
  [OPENID]
);

// âœ… æ¨èï¼šæ’å…¥æ—¶è‡ªåŠ¨è®¾ç½® _openid
await db.query(
  'INSERT INTO orders (_openid, user_id, ...) VALUES (?, ?, ...)',
  [OPENID, userId, ...]
);

// âŒ é”™è¯¯ï¼šå…è®¸ç”¨æˆ·æŸ¥è¯¢å…¶ä»–ç”¨æˆ·çš„æ•°æ®
const allCourses = await db.query('SELECT * FROM user_courses');
```

#### 3.3.2 ç®¡ç†å‘˜æ“ä½œ

```javascript
// âœ… æ¨èï¼šç®¡ç†å‘˜å¯ä»¥æŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼Œä½†éœ€è¦å…ˆéªŒè¯æƒé™
const admin = await checkAdminAuth(OPENID);

const allUsers = await db.query(
  'SELECT * FROM users WHERE role = ?',
  ['ambassador']
);
```

### 3.4 å“åº”æ ¼å¼è§„èŒƒ

**ç»Ÿä¸€ä½¿ç”¨ä»¥ä¸‹å“åº”æ ¼å¼ï¼š**

```javascript
// æˆåŠŸå“åº”
{
  success: true,
  code: 0,
  message: 'æ“ä½œæˆåŠŸ',
  data: { ... },
  timestamp: 1707123456789
}

// é”™è¯¯å“åº”
{
  success: false,
  code: -1,
  message: 'æ“ä½œå¤±è´¥',
  error: 'å…·ä½“é”™è¯¯ä¿¡æ¯',
  timestamp: 1707123456789
}
```

**ä½¿ç”¨å±‚ä¸­çš„å“åº”å·¥å…·ï¼š**

```javascript
const { successResponse, errorResponse } = require('/opt/common-utils');

// æˆåŠŸ
return successResponse(data, 'æ“ä½œæˆåŠŸ');

// å¤±è´¥
return errorResponse('æ“ä½œå¤±è´¥', error);
```

---

## 4. å…¬å…±å±‚ä½¿ç”¨

### 4.1 å±‚çš„ä½œç”¨

**å±‚ï¼ˆLayerï¼‰** æ˜¯äº‘å‡½æ•°çš„ä»£ç å…±äº«æœºåˆ¶ï¼Œå¯ä»¥å°†ä¾èµ–åº“ã€å…¬å…±ä»£ç æ–‡ä»¶ç­‰èµ„æºç‹¬ç«‹ç®¡ç†ï¼Œå®ç°å¤šä¸ªå‡½æ•°é—´çš„ä»£ç å¤ç”¨ã€‚

**ä¼˜åŠ¿ï¼š**
- âœ… å‡å°éƒ¨ç½²åŒ…ä½“ç§¯
- âœ… æé«˜å¼€å‘æ•ˆç‡ï¼ˆå…¬å…±ä»£ç åªéœ€ç»´æŠ¤ä¸€ä»½ï¼‰
- âœ… æ”¯æŒåœ¨çº¿ç¼–è¾‘ï¼ˆä»£ç åŒ… < 10MBï¼‰
- âœ… ç‰ˆæœ¬ç®¡ç†ï¼ˆå±‚æ”¯æŒç‰ˆæœ¬æ§åˆ¶ï¼‰

### 4.2 å¼•ç”¨å±‚

å±‚ä¸­çš„æ–‡ä»¶ä¼šè¢«æŒ‚è½½åˆ° `/opt` ç›®å½•ï¼š

```javascript
// å¼•ç”¨ db-utils å±‚
const { query, insert, update } = require('/opt/db-utils');

// å¼•ç”¨ common-utils å±‚
const { checkAdminAuth, successResponse } = require('/opt/common-utils');

// å¼•ç”¨ business-logic å±‚
const { calculateMeritPoints } = require('/opt/business-logic');
```

### 4.3 db-utils å±‚ï¼ˆæ•°æ®åº“å·¥å…·ï¼‰

**æä¾›çš„æ–¹æ³•ï¼š**

```javascript
const db = require('/opt/db-utils');

// æŸ¥è¯¢æ•°æ®
const rows = await db.query(
  'SELECT * FROM users WHERE id = ?',
  [userId]
);

// æ’å…¥æ•°æ®
const result = await db.insert(
  'INSERT INTO orders (_openid, ...) VALUES (?, ...)',
  [openid, ...]
);

// æ›´æ–°æ•°æ®
await db.update(
  'UPDATE users SET nickname = ? WHERE _openid = ?',
  [nickname, openid]
);

// è½¯åˆ é™¤
await db.softDelete('users', userId);

// äº‹åŠ¡å¤„ç†
await db.transaction(async (conn) => {
  await conn.query('INSERT INTO ...');
  await conn.query('UPDATE ...');
});
```

### 4.4 common-utils å±‚ï¼ˆé€šç”¨å·¥å…·ï¼‰

**æä¾›çš„æ–¹æ³•ï¼š**

```javascript
const utils = require('/opt/common-utils');

// æƒé™éªŒè¯
const user = await utils.checkClientAuth(openid);
const admin = await utils.checkAdminAuth(openid, 'admin');

// å“åº”æ ¼å¼åŒ–
return utils.successResponse(data, 'æ“ä½œæˆåŠŸ');
return utils.errorResponse('æ“ä½œå¤±è´¥', error);

// å‚æ•°éªŒè¯
const error = utils.validateRequired(event, ['courseId', 'date']);
if (error) {
  return utils.errorResponse(error);
}

// åˆ†é¡µå¤„ç†
const { offset, limit } = utils.getPagination(page, pageSize);

// æ—¥æœŸæ ¼å¼åŒ–
const dateStr = utils.formatDateTime(new Date());
```

### 4.5 business-logic å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼Œå¯é€‰ï¼‰

**æä¾›çš„æ–¹æ³•ï¼š**

```javascript
const business = require('/opt/business-logic');

// è®¡ç®—åŠŸå¾·åˆ†
const meritPoints = business.calculateMeritPoints(orderAmount);

// è®¡ç®—ç§¯åˆ†
const cashPoints = business.calculateCashPoints(orderAmount);

// æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
const canUpgrade = await business.checkUpgradeEligibility(userId);
```

---

## 5. ä»£ç ç¤ºä¾‹

### 5.1 ç”¨æˆ·æ¨¡å—äº‘å‡½æ•°

```javascript
// cloudfunctions/user/index.js
const cloud = require('wx-server-sdk');
cloud.init();

const { query } = require('/opt/db-utils');
const { 
  checkAdminAuth, 
  checkClientAuth, 
  successResponse, 
  errorResponse,
  validateRequired,
  getPagination
} = require('/opt/common-utils');

exports.main = async (event, context) => {
  const { action, ...params } = event;
  const { OPENID } = cloud.getWXContext();
  
  try {
    // ==================== å®¢æˆ·ç«¯è·¯ç”± ====================
    if (action.startsWith('client:')) {
      return await handleClientRequest(OPENID, action, params);
    }
    
    // ==================== ç®¡ç†ç«¯è·¯ç”± ====================
    if (action.startsWith('admin:')) {
      return await handleAdminRequest(OPENID, action, params);
    }
    
    throw new Error(`æœªçŸ¥æ“ä½œ: ${action}`);
    
  } catch (error) {
    console.error('äº‘å‡½æ•°æ‰§è¡Œé”™è¯¯:', error);
    return errorResponse(error.message, error);
  }
}

/**
 * å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
 */
async function handleClientRequest(openid, action, params) {
  // éªŒè¯ç”¨æˆ·èº«ä»½
  const user = await checkClientAuth(openid);
  
  switch (action) {
    case 'client:getMyCourses':
      // è·å–æˆ‘çš„è¯¾ç¨‹
      const courses = await query(
        `SELECT uc.*, c.title, c.cover_image, c.type
         FROM user_courses uc
         LEFT JOIN courses c ON uc.course_id = c.id
         WHERE uc._openid = ?
         ORDER BY uc.created_at DESC`,
        [openid]
      );
      return successResponse(courses);
    
    case 'client:getMyOrders':
      // è·å–æˆ‘çš„è®¢å•
      const { page = 1, pageSize = 20 } = params;
      const { offset, limit } = getPagination(page, pageSize);
      
      const orders = await query(
        `SELECT o.*, c.title as course_title
         FROM orders o
         LEFT JOIN courses c ON o.course_id = c.id
         WHERE o._openid = ?
         ORDER BY o.created_at DESC
         LIMIT ? OFFSET ?`,
        [openid, limit, offset]
      );
      return successResponse(orders);
    
    case 'client:updateProfile':
      // æ›´æ–°ä¸ªäººä¿¡æ¯
      const error = validateRequired(params, ['nickname']);
      if (error) {
        return errorResponse(error);
      }
      
      await query(
        `UPDATE users 
         SET nickname = ?, avatar = ?, phone = ?
         WHERE _openid = ?`,
        [params.nickname, params.avatar, params.phone, openid]
      );
      return successResponse(null, 'æ›´æ–°æˆåŠŸ');
    
    default:
      throw new Error(`æœªçŸ¥çš„å®¢æˆ·ç«¯æ“ä½œ: ${action}`);
  }
}

/**
 * å¤„ç†ç®¡ç†ç«¯è¯·æ±‚
 */
async function handleAdminRequest(openid, action, params) {
  // ğŸ”’ éªŒè¯ç®¡ç†å‘˜æƒé™
  const admin = await checkAdminAuth(openid, 'admin');
  
  switch (action) {
    case 'admin:getAllUsers':
      // è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
      const { page = 1, pageSize = 20, keyword = '' } = params;
      const { offset, limit } = getPagination(page, pageSize);
      
      let sql = 'SELECT * FROM users WHERE 1=1';
      const sqlParams = [];
      
      if (keyword) {
        sql += ' AND (nickname LIKE ? OR phone LIKE ?)';
        sqlParams.push(`%${keyword}%`, `%${keyword}%`);
      }
      
      sql += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';
      sqlParams.push(limit, offset);
      
      const users = await query(sql, sqlParams);
      return successResponse(users);
    
    case 'admin:updateUser':
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      const error = validateRequired(params, ['userId', 'role']);
      if (error) {
        return errorResponse(error);
      }
      
      await query(
        `UPDATE users 
         SET role = ?, status = ?
         WHERE id = ?`,
        [params.role, params.status, params.userId]
      );
      return successResponse(null, 'æ›´æ–°æˆåŠŸ');
    
    default:
      throw new Error(`æœªçŸ¥çš„ç®¡ç†ç«¯æ“ä½œ: ${action}`);
  }
}
```

### 5.2 è¯¾ç¨‹æ¨¡å—äº‘å‡½æ•°

```javascript
// cloudfunctions/course/index.js
const cloud = require('wx-server-sdk');
cloud.init();

const { query } = require('/opt/db-utils');
const { 
  checkAdminAuth, 
  checkClientAuth, 
  successResponse, 
  errorResponse,
  getPagination
} = require('/opt/common-utils');

exports.main = async (event, context) => {
  const { action, ...params } = event;
  const { OPENID } = cloud.getWXContext();
  
  try {
    // ==================== å…¬å¼€è·¯ç”± ====================
    if (action.startsWith('public:')) {
      return await handlePublicRequest(action, params);
    }
    
    // ==================== å®¢æˆ·ç«¯è·¯ç”± ====================
    if (action.startsWith('client:')) {
      return await handleClientRequest(OPENID, action, params);
    }
    
    // ==================== ç®¡ç†ç«¯è·¯ç”± ====================
    if (action.startsWith('admin:')) {
      return await handleAdminRequest(OPENID, action, params);
    }
    
    throw new Error(`æœªçŸ¥æ“ä½œ: ${action}`);
    
  } catch (error) {
    console.error('äº‘å‡½æ•°æ‰§è¡Œé”™è¯¯:', error);
    return errorResponse(error.message, error);
  }
}

/**
 * å¤„ç†å…¬å¼€è¯·æ±‚ï¼ˆæ— éœ€æƒé™ï¼‰
 */
async function handlePublicRequest(action, params) {
  switch (action) {
    case 'public:getList':
      // è·å–è¯¾ç¨‹åˆ—è¡¨
      const { page = 1, pageSize = 20, type = '' } = params;
      const { offset, limit } = getPagination(page, pageSize);
      
      let sql = 'SELECT * FROM courses WHERE status = "published"';
      const sqlParams = [];
      
      if (type) {
        sql += ' AND type = ?';
        sqlParams.push(type);
      }
      
      sql += ' ORDER BY sort_order ASC, created_at DESC LIMIT ? OFFSET ?';
      sqlParams.push(limit, offset);
      
      const courses = await query(sql, sqlParams);
      return successResponse(courses);
    
    case 'public:getDetail':
      // è·å–è¯¾ç¨‹è¯¦æƒ…
      const [course] = await query(
        'SELECT * FROM courses WHERE id = ? AND status = "published"',
        [params.courseId]
      );
      return successResponse(course || null);
    
    default:
      throw new Error(`æœªçŸ¥çš„å…¬å¼€æ“ä½œ: ${action}`);
  }
}

/**
 * å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
 */
async function handleClientRequest(openid, action, params) {
  const user = await checkClientAuth(openid);
  
  switch (action) {
    case 'client:makeAppointment':
      // é¢„çº¦è¯¾ç¨‹
      await query(
        `INSERT INTO appointments 
         (_openid, course_id, class_record_id, status)
         VALUES (?, ?, ?, 'pending')`,
        [openid, params.courseId, params.classRecordId]
      );
      return successResponse(null, 'é¢„çº¦æˆåŠŸ');
    
    default:
      throw new Error(`æœªçŸ¥çš„å®¢æˆ·ç«¯æ“ä½œ: ${action}`);
  }
}

/**
 * å¤„ç†ç®¡ç†ç«¯è¯·æ±‚
 */
async function handleAdminRequest(openid, action, params) {
  // ğŸ”’ éªŒè¯ç®¡ç†å‘˜æƒé™
  const admin = await checkAdminAuth(openid, 'admin');
  
  switch (action) {
    case 'admin:create':
      // åˆ›å»ºè¯¾ç¨‹
      const result = await query(
        `INSERT INTO courses
         (title, subtitle, type, price, status)
         VALUES (?, ?, ?, ?, 'draft')`,
        [params.title, params.subtitle, params.type, params.price]
      );
      return successResponse({ id: result.insertId }, 'åˆ›å»ºæˆåŠŸ');
    
    case 'admin:update':
      // æ›´æ–°è¯¾ç¨‹
      await query(
        `UPDATE courses
         SET title = ?, type = ?, price = ?, status = ?
         WHERE id = ?`,
        [params.title, params.type, params.price, params.status, params.courseId]
      );
      return successResponse(null, 'æ›´æ–°æˆåŠŸ');
    
    default:
      throw new Error(`æœªçŸ¥çš„ç®¡ç†ç«¯æ“ä½œ: ${action}`);
  }
}
```

### 5.3 å‰ç«¯è°ƒç”¨ç¤ºä¾‹

#### 5.3.1 å°ç¨‹åºç«¯è°ƒç”¨

```javascript
// å°ç¨‹åº src/api/user.js
import cloudbase from '@cloudbase/js-sdk';

const app = cloudbase.init({
  env: 'cloud1-0gnn3mn17b581124'
});

/**
 * è·å–æˆ‘çš„è¯¾ç¨‹
 */
export async function getMyCourses() {
  const result = await app.callFunction({
    name: 'user',
    data: {
      action: 'client:getMyCourses'
    }
  });
  return result.result.data;
}

/**
 * æ›´æ–°ä¸ªäººèµ„æ–™
 */
export async function updateProfile(nickname, avatar, phone) {
  const result = await app.callFunction({
    name: 'user',
    data: {
      action: 'client:updateProfile',
      nickname,
      avatar,
      phone
    }
  });
  return result.result;
}
```

#### 5.3.2 ç®¡ç†åå°è°ƒç”¨

```javascript
// ç®¡ç†åå° admin-panel/src/api/user.js
import cloudbase from '@cloudbase/js-sdk';

const app = cloudbase.init({
  env: 'cloud1-0gnn3mn17b581124'
});

/**
 * è·å–æ‰€æœ‰ç”¨æˆ·
 */
export async function getAllUsers(page, pageSize, keyword = '') {
  const result = await app.callFunction({
    name: 'user',
    data: {
      action: 'admin:getAllUsers',
      page,
      pageSize,
      keyword
    }
  });
  return result.result.data;
}

/**
 * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
 */
export async function updateUser(userId, role, status) {
  const result = await app.callFunction({
    name: 'user',
    data: {
      action: 'admin:updateUser',
      userId,
      role,
      status
    }
  });
  return result.result;
}
```

---

## 6. æ‰§è¡Œæµç¨‹

### 6.1 äº‘å‡½æ•°å¼€å‘æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº‘å‡½æ•°å¼€å‘å®Œæ•´æµç¨‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: éœ€æ±‚åˆ†æ
â”œâ”€â”€ ç¡®å®šåŠŸèƒ½æ¨¡å—ï¼ˆç”¨æˆ·/è¯¾ç¨‹/è®¢å•/å¤§ä½¿/ç³»ç»Ÿï¼‰
â”œâ”€â”€ ç¡®å®šæ“ä½œç±»å‹ï¼ˆpublic/client/adminï¼‰
â”œâ”€â”€ ç¡®å®šéœ€è¦çš„å‚æ•°å’Œè¿”å›å€¼
â””â”€â”€ ç¡®å®šéœ€è¦çš„æ•°æ®åº“è¡¨

Step 2: é€‰æ‹©/åˆ›å»ºäº‘å‡½æ•°
â”œâ”€â”€ ç¡®å®šå±äºå“ªä¸ªæ¨¡å—ï¼ˆuser/course/order/ambassador/systemï¼‰
â”œâ”€â”€ å¦‚æœå‡½æ•°ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å‡½æ•°ç›®å½•
â”œâ”€â”€ å¦‚æœå‡½æ•°å·²å­˜åœ¨ï¼Œç›´æ¥æ·»åŠ æ–°çš„ action åˆ†æ”¯
â””â”€â”€ é…ç½® config.jsonï¼ˆç»‘å®šéœ€è¦çš„å±‚ï¼‰

Step 3: ç¼–å†™ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ åœ¨ index.js ä¸­æ·»åŠ æ–°çš„ action åˆ†æ”¯
â”œâ”€â”€ å®ç°æƒé™éªŒè¯ï¼ˆpublic/client/adminï¼‰
â”œâ”€â”€ å®ç°å‚æ•°éªŒè¯ï¼ˆä½¿ç”¨ validateRequiredï¼‰
â”œâ”€â”€ å®ç°æ•°æ®åº“æ“ä½œï¼ˆä½¿ç”¨ db-utils å±‚ï¼‰
â”œâ”€â”€ å®ç°ä¸šåŠ¡é€»è¾‘ï¼ˆå¯ä½¿ç”¨ business-logic å±‚ï¼‰
â””â”€â”€ è¿”å›æ ‡å‡†å“åº”ï¼ˆä½¿ç”¨ successResponse/errorResponseï¼‰

Step 4: æœ¬åœ°æµ‹è¯•
â”œâ”€â”€ å®‰è£…ä¾èµ–ï¼šnpm install
â”œâ”€â”€ ç¼–å†™æµ‹è¯•ç”¨ä¾‹
â”œâ”€â”€ ä½¿ç”¨äº‘å‡½æ•°æ¨¡æ‹Ÿå™¨æµ‹è¯•
â””â”€â”€ æ£€æŸ¥æ—¥å¿—è¾“å‡º

Step 5: éƒ¨ç½²ä¸Šçº¿
â”œâ”€â”€ æ‰“åŒ…äº‘å‡½æ•°ä»£ç 
â”œâ”€â”€ é€šè¿‡æ§åˆ¶å°ä¸Šä¼ éƒ¨ç½²
â”œâ”€â”€ ç­‰å¾…éƒ¨ç½²å®Œæˆ
â””â”€â”€ æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—

Step 6: å‰ç«¯é›†æˆ
â”œâ”€â”€ åœ¨å‰ç«¯é¡¹ç›®ä¸­è°ƒç”¨äº‘å‡½æ•°
â”œâ”€â”€ ä¼ å…¥æ­£ç¡®çš„ action å’Œå‚æ•°
â”œâ”€â”€ å¤„ç†å“åº”æ•°æ®
â””â”€â”€ å¤„ç†é”™è¯¯æƒ…å†µ

Step 7: æµ‹è¯•éªŒè¯
â”œâ”€â”€ æµ‹è¯•å…¬å¼€æ¥å£ï¼ˆæ— éœ€ç™»å½•ï¼‰
â”œâ”€â”€ æµ‹è¯•å®¢æˆ·ç«¯æ¥å£ï¼ˆéœ€è¦ç™»å½•ï¼‰
â”œâ”€â”€ æµ‹è¯•ç®¡ç†ç«¯æ¥å£ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
â”œâ”€â”€ æµ‹è¯•è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸æƒ…å†µ
â””â”€â”€ æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—æ’æŸ¥é—®é¢˜
```

### 6.2 äº‘å‡½æ•°æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº‘å‡½æ•°è°ƒç”¨æ‰§è¡Œæµç¨‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. å‰ç«¯è°ƒç”¨
   â”œâ”€â”€ å°ç¨‹åºï¼šapp.callFunction({ name: 'user', data: { ... } })
   â””â”€â”€ ç®¡ç†åå°ï¼šapp.callFunction({ name: 'user', data: { ... } })

2. CloudBase è·¯ç”±
   â”œâ”€â”€ æ ¹æ® name æ‰¾åˆ°å¯¹åº”çš„äº‘å‡½æ•°
   â”œâ”€â”€ è‡ªåŠ¨æ³¨å…¥ contextï¼ˆåŒ…å« OPENIDï¼‰
   â””â”€â”€ è°ƒç”¨å‡½æ•°çš„ main æ–¹æ³•

3. äº‘å‡½æ•°å…¥å£
   â”œâ”€â”€ exports.main = async (event, context) => { ... }
   â”œâ”€â”€ è§£æ action å‚æ•°ï¼šconst { action, ...params } = event
   â”œâ”€â”€ è·å–ç”¨æˆ·èº«ä»½ï¼šconst { OPENID } = cloud.getWXContext()
   â””â”€â”€ æ ¹æ® action å‰ç¼€åˆ†å‘è·¯ç”±

4. æƒé™éªŒè¯
   â”œâ”€â”€ public:* â†’ æ— éœ€éªŒè¯ï¼Œç›´æ¥æ‰§è¡Œ
   â”œâ”€â”€ client:* â†’ checkClientAuth(OPENID)
   â”‚   â”œâ”€â”€ æŸ¥è¯¢ users è¡¨éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
   â”‚   â””â”€â”€ è¿”å›ç”¨æˆ·ä¿¡æ¯
   â””â”€â”€ admin:* â†’ checkAdminAuth(OPENID, 'admin')
       â”œâ”€â”€ æŸ¥è¯¢ admin_users è¡¨éªŒè¯æ˜¯å¦ä¸ºç®¡ç†å‘˜
       â”œâ”€â”€ æ£€æŸ¥æƒé™ç­‰çº§
       â””â”€â”€ è¿”å›ç®¡ç†å‘˜ä¿¡æ¯

5. ä¸šåŠ¡é€»è¾‘å¤„ç†
   â”œâ”€â”€ å‚æ•°éªŒè¯ï¼švalidateRequired(params, ['field1', 'field2'])
   â”œâ”€â”€ æ•°æ®åº“æŸ¥è¯¢ï¼šdb.query(sql, params)
   â”‚   â”œâ”€â”€ è‡ªåŠ¨æ³¨å…¥ _openidï¼ˆç”¨æˆ·æ•°æ®éš”ç¦»ï¼‰
   â”‚   â”œâ”€â”€ æ‰§è¡Œ SQL æŸ¥è¯¢
   â”‚   â””â”€â”€ è¿”å›æŸ¥è¯¢ç»“æœ
   â”œâ”€â”€ ä¸šåŠ¡è®¡ç®—ï¼šbusiness.calculatePoints(amount)
   â””â”€â”€ æ•°æ®è½¬æ¢ï¼šformatDateTime(date)

6. å“åº”è¿”å›
   â”œâ”€â”€ æˆåŠŸï¼šsuccessResponse(data, 'æ“ä½œæˆåŠŸ')
   â”‚   â””â”€â”€ { success: true, code: 0, message: '...', data: { ... } }
   â””â”€â”€ å¤±è´¥ï¼šerrorResponse('é”™è¯¯ä¿¡æ¯', error)
       â””â”€â”€ { success: false, code: -1, message: '...', error: '...' }

7. å‰ç«¯æ¥æ”¶
   â”œâ”€â”€ è§£æå“åº”ï¼šconst { success, data, message } = result.result
   â”œâ”€â”€ æˆåŠŸå¤„ç†ï¼šæ›´æ–°ç•Œé¢ã€æ˜¾ç¤ºæç¤º
   â””â”€â”€ å¤±è´¥å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€é‡è¯•
```

### 6.3 æ•°æ®åº“æ“ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®åº“æ“ä½œæ‰§è¡Œæµç¨‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. äº‘å‡½æ•°ä¸­è°ƒç”¨ db-utils
   â”œâ”€â”€ const { query } = require('/opt/db-utils');
   â””â”€â”€ const result = await query(sql, params);

2. db-utils è·å–è¿æ¥æ± 
   â”œâ”€â”€ ä»è¿æ¥æ± è·å–æ•°æ®åº“è¿æ¥
   â”œâ”€â”€ å¦‚æœè¿æ¥æ± ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„è¿æ¥æ± 
   â””â”€â”€ é…ç½®ï¼š{ host, user, password, database, ... }

3. æ‰§è¡Œ SQL è¯­å¥
   â”œâ”€â”€ ä½¿ç”¨ mysql2 é©±åŠ¨æ‰§è¡ŒæŸ¥è¯¢
   â”œâ”€â”€ è‡ªåŠ¨è¿›è¡Œå‚æ•°ç»‘å®šï¼ˆé˜²æ­¢ SQL æ³¨å…¥ï¼‰
   â””â”€â”€ ç­‰å¾…æŸ¥è¯¢ç»“æœ

4. è‡ªåŠ¨æ³¨å…¥ _openidï¼ˆç”¨æˆ·æ•°æ®éš”ç¦»ï¼‰
   â”œâ”€â”€ æŸ¥è¯¢æ“ä½œï¼šWHERE _openid = ?
   â”‚   â””â”€â”€ åªè¿”å›å½“å‰ç”¨æˆ·çš„æ•°æ®
   â””â”€â”€ æ’å…¥æ“ä½œï¼šINSERT INTO ... (_openid, ...) VALUES (?, ...)
       â””â”€â”€ è‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰ç”¨æˆ·çš„ openid

5. è¿”å›æŸ¥è¯¢ç»“æœ
   â”œâ”€â”€ SELECT æŸ¥è¯¢ï¼šè¿”å›æ•°æ®è¡Œæ•°ç»„
   â”œâ”€â”€ INSERT æ“ä½œï¼šè¿”å› { insertId, affectedRows }
   â”œâ”€â”€ UPDATE æ“ä½œï¼šè¿”å› { affectedRows }
   â””â”€â”€ DELETE æ“ä½œï¼šè¿”å› { affectedRows }

6. é‡Šæ”¾æ•°æ®åº“è¿æ¥
   â”œâ”€â”€ å°†è¿æ¥å½’è¿˜åˆ°è¿æ¥æ± 
   â””â”€â”€ è¿æ¥æ± è‡ªåŠ¨ç®¡ç†è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸ

7. é”™è¯¯å¤„ç†
   â”œâ”€â”€ æ•è· SQL é”™è¯¯
   â”œâ”€â”€ è®°å½•é”™è¯¯æ—¥å¿—
   â”œâ”€â”€ è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
   â””â”€â”€ é‡Šæ”¾æ•°æ®åº“è¿æ¥
```

---

## 7. æ³¨æ„äº‹é¡¹

### 7.1 å®‰å…¨æ³¨æ„äº‹é¡¹

**ğŸ”’ ç¦æ­¢ä»å‰ç«¯æ¥æ”¶ openid**

```javascript
// âŒ é”™è¯¯å†™æ³•ï¼ˆå¯ä»¥è¢«ä¼ªé€ ï¼‰
exports.main = async (event, context) => {
  const { openid } = event; // ä¸è¦è¿™æ ·åšï¼
  // ...
}

// âœ… æ­£ç¡®å†™æ³•ï¼ˆè‡ªåŠ¨è·å–ï¼‰
exports.main = async (event, context) => {
  const { OPENID } = cloud.getWXContext(); // å®‰å…¨å¯é 
  // ...
}
```

**ğŸ”’ å¿…é¡»è¿›è¡Œæƒé™éªŒè¯**

```javascript
// âŒ é”™è¯¯å†™æ³•ï¼ˆç¼ºå°‘æƒé™éªŒè¯ï¼‰
case 'admin:getAllUsers':
  const users = await query('SELECT * FROM users');
  return successResponse(users);

// âœ… æ­£ç¡®å†™æ³•ï¼ˆå…ˆéªŒè¯æƒé™ï¼‰
case 'admin:getAllUsers':
  const admin = await checkAdminAuth(openid, 'admin');
  const users = await query('SELECT * FROM users');
  return successResponse(users);
```

**ğŸ”’ SQL æ³¨å…¥é˜²æŠ¤**

```javascript
// âŒ é”™è¯¯å†™æ³•ï¼ˆSQL æ³¨å…¥é£é™©ï¼‰
const sql = `SELECT * FROM users WHERE name = '${params.name}'`;
const users = await query(sql);

// âœ… æ­£ç¡®å†™æ³•ï¼ˆä½¿ç”¨å‚æ•°ç»‘å®šï¼‰
const sql = 'SELECT * FROM users WHERE name = ?';
const users = await query(sql, [params.name]);
```

### 7.2 æ€§èƒ½æ³¨æ„äº‹é¡¹

**âš¡ é¿å… N+1 æŸ¥è¯¢**

```javascript
// âŒ é”™è¯¯å†™æ³•ï¼ˆN+1 æŸ¥è¯¢ï¼‰
const orders = await query('SELECT * FROM orders WHERE _openid = ?', [openid]);
for (const order of orders) {
  order.course = await query('SELECT * FROM courses WHERE id = ?', [order.course_id]);
}

// âœ… æ­£ç¡®å†™æ³•ï¼ˆä½¿ç”¨ JOINï¼‰
const orders = await query(
  `SELECT o.*, c.title as course_title
   FROM orders o
   LEFT JOIN courses c ON o.course_id = c.id
   WHERE o._openid = ?`,
  [openid]
);
```

**âš¡ åˆç†ä½¿ç”¨åˆ†é¡µ**

```javascript
// âœ… æ¨èï¼šä½¿ç”¨åˆ†é¡µæŸ¥è¯¢
const { offset, limit } = getPagination(page, pageSize);
const users = await query(
  'SELECT * FROM users LIMIT ? OFFSET ?',
  [limit, offset]
);
```

**âš¡ ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢**

```sql
-- ç¡®ä¿ç»å¸¸æŸ¥è¯¢çš„å­—æ®µæœ‰ç´¢å¼•
CREATE INDEX idx_openid ON user_courses(_openid);
CREATE INDEX idx_user_id ON orders(user_id);
CREATE INDEX idx_status ON orders(status);
```

### 7.3 å¼€å‘æ³¨æ„äº‹é¡¹

**ğŸ“ æ—¥å¿—è®°å½•**

```javascript
exports.main = async (event, context) => {
  console.log('æ”¶åˆ°è¯·æ±‚:', event);
  
  try {
    // ä¸šåŠ¡é€»è¾‘
    const result = await handleRequest(event);
    console.log('æ‰§è¡ŒæˆåŠŸ:', result);
    return successResponse(result);
  } catch (error) {
    console.error('æ‰§è¡Œå¤±è´¥:', error);
    return errorResponse(error.message, error);
  }
}
```

**ğŸ“ å‚æ•°éªŒè¯**

```javascript
// âœ… æ¨èï¼šå…ˆéªŒè¯å‚æ•°
const error = validateRequired(params, ['courseId', 'date', 'time']);
if (error) {
  return errorResponse(error);
}

// å†æ‰§è¡Œä¸šåŠ¡é€»è¾‘
await createAppointment(params);
```

**ğŸ“ é”™è¯¯å¤„ç†**

```javascript
try {
  // ä¸šåŠ¡é€»è¾‘
} catch (error) {
  // è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
  console.error('è¯¦ç»†é”™è¯¯:', {
    message: error.message,
    stack: error.stack,
    event,
    openid
  });
  
  // è¿”å›å‹å¥½çš„é”™è¯¯æç¤º
  return errorResponse('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', error);
}
```

### 7.4 å±‚ï¼ˆLayerï¼‰æ³¨æ„äº‹é¡¹

**ğŸ“¦ å±‚çš„å¤§å°é™åˆ¶**

- å•ä¸ªå±‚çš„å‹ç¼©åŒ…å¤§å°ä¸è¶…è¿‡ **50MB**
- æ¯ä¸ªå‡½æ•°æœ€å¤šå¯ä»¥ç»‘å®š **5ä¸ªå±‚**
- å±‚å’Œå‡½æ•°ä»£ç æ€»å¤§å°ä¸è¶…è¿‡ **500MB**ï¼ˆè§£å‹åï¼‰

**ğŸ“¦ å±‚çš„ç‰ˆæœ¬ç®¡ç†**

```javascript
// âœ… æ¨èï¼šä½¿ç”¨ç‰ˆæœ¬å·ç®¡ç†å±‚
{
  "layers": [
    { "name": "db-utils", "version": 1 },      // ç¨³å®šç‰ˆ
    { "name": "common-utils", "version": 2 }   // æµ‹è¯•ç‰ˆ
  ]
}

// âŒ ä¸æ¨èï¼šç›´æ¥è¦†ç›–å±‚ï¼ˆå¯èƒ½å½±å“æ‰€æœ‰å‡½æ•°ï¼‰
```

**ğŸ“¦ å±‚çš„æ›´æ–°ç­–ç•¥**

1. åˆ›å»ºæ–°ç‰ˆæœ¬çš„å±‚ï¼ˆversion + 1ï¼‰
2. åœ¨æµ‹è¯•å‡½æ•°ä¸­ç»‘å®šæ–°ç‰ˆæœ¬
3. éªŒè¯åŠŸèƒ½æ­£å¸¸åï¼Œé€æ­¥åˆ‡æ¢ç”Ÿäº§å‡½æ•°åˆ°æ–°ç‰ˆæœ¬

---

## 8. å‚è€ƒèµ„æ–™

### 8.1 å†…éƒ¨æ–‡æ¡£

- **[æ•°æ®åº“è®¾è®¡æ–‡æ¡£](../../docs/database/README.md)** - å®Œæ•´çš„æ•°æ®åº“æ¶æ„å’Œéƒ¨ç½²æŒ‡å—
- **[åç«¯APIæ¥å£æ–‡æ¡£](../../åç«¯APIæ¥å£æ–‡æ¡£.md)** - æ‰€æœ‰æ¥å£çš„è¯¦ç»†è¯´æ˜
- **[é¡¹ç›®éœ€æ±‚æ–‡æ¡£](../../éœ€æ±‚æ–‡æ¡£-V2.md)** - ä¸šåŠ¡éœ€æ±‚å’ŒåŠŸèƒ½è¯´æ˜

### 8.2 CloudBase å®˜æ–¹æ–‡æ¡£

- **[äº‘å‡½æ•°å¿«é€Ÿå¼€å§‹](https://docs.cloudbase.net/cloud-function/introduce)** - äº‘å‡½æ•°åŸºç¡€æ•™ç¨‹
- **[äº‘å‡½æ•° API æ–‡æ¡£](https://docs.cloudbase.net/api-reference/server/node-sdk/introduction)** - Node.js SDK API å‚è€ƒ
- **[å±‚ç®¡ç†](https://docs.cloudbase.net/cloud-function/layer)** - å±‚çš„åˆ›å»ºå’Œä½¿ç”¨
- **[æ•°æ®åº“æ–‡æ¡£](https://docs.cloudbase.net/database/introduce)** - CloudBase æ•°æ®åº“ä½¿ç”¨æŒ‡å—
- **[å®‰å…¨è§„åˆ™](https://docs.cloudbase.net/database/security-rules)** - æ•°æ®åº“å®‰å…¨è§„åˆ™é…ç½®

### 8.3 å¿«é€Ÿé“¾æ¥

```
# CloudBase æ§åˆ¶å°
https://console.cloud.tencent.com/tcb

# MySQL æ•°æ®åº“ç®¡ç†
https://tcb.cloud.tencent.com/dev?envId=cloud1-0gnn3mn17b581124#/db/mysql

# äº‘å‡½æ•°ç®¡ç†
https://tcb.cloud.tencent.com/dev?envId=cloud1-0gnn3mn17b581124#/scf

# å±‚ç®¡ç†
https://tcb.cloud.tencent.com/dev?envId=cloud1-0gnn3mn17b581124#/scf/layer
```

### 8.4 å¸¸è§é—®é¢˜é€ŸæŸ¥

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|-----|---------|
| å¦‚ä½•è·å–ç”¨æˆ· openidï¼Ÿ | ä½¿ç”¨ `cloud.getWXContext()` è‡ªåŠ¨è·å– |
| å¦‚ä½•åŒºåˆ†ç”¨æˆ·å’Œç®¡ç†å‘˜ï¼Ÿ | ä½¿ç”¨ action å‰ç¼€ï¼ˆclient:/admin:ï¼‰+ æƒé™éªŒè¯ |
| å¦‚ä½•é˜²æ­¢ SQL æ³¨å…¥ï¼Ÿ | ä½¿ç”¨å‚æ•°ç»‘å®šï¼ˆ`query(sql, [param1, param2])`ï¼‰ |
| å¦‚ä½•å®ç°æ•°æ®éš”ç¦»ï¼Ÿ | æŸ¥è¯¢æ—¶è¿‡æ»¤ `WHERE _openid = ?` |
| å¦‚ä½•å…±äº«ä»£ç ï¼Ÿ | ä½¿ç”¨å±‚ï¼ˆLayerï¼‰ç®¡ç†å…¬å…±ä»£ç  |
| å¦‚ä½•è°ƒè¯•äº‘å‡½æ•°ï¼Ÿ | æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿— + ä½¿ç”¨ `console.log` è¾“å‡º |
| å±‚æ›´æ–°åç«‹å³ç”Ÿæ•ˆå—ï¼Ÿ | ä¸ä¼šï¼Œéœ€è¦ç­‰å¾…æ–°çš„å‡½æ•°å®ä¾‹å¯åŠ¨ |
| å¦‚ä½•å¤„ç†äº‹åŠ¡ï¼Ÿ | ä½¿ç”¨ `db.transaction` åŒ…è£¹å¤šä¸ªæ“ä½œ |

---

**ğŸ“ æ–‡æ¡£ç»´æŠ¤**

- **åˆ›å»ºæ—¶é—´**: 2026-02-04
- **æœ€åæ›´æ–°**: 2026-02-04
- **ç»´æŠ¤äººå‘˜**: å¼€å‘å›¢é˜Ÿ
- **åé¦ˆæ¸ é“**: é¡¹ç›® Issue æˆ–å›¢é˜Ÿå†…éƒ¨è®¨è®º

**ğŸ”— ç›¸å…³èµ„æº**

- [GitHub ä»“åº“](https://github.com/your-org/tiandao-miniprogram)
- [CloudBase æ§åˆ¶å°](https://console.cloud.tencent.com/tcb)
- [å¼€å‘å›¢é˜Ÿæ–‡æ¡£ä¸­å¿ƒ](https://wiki.example.com)

