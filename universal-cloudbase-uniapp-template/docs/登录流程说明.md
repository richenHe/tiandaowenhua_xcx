# 登录流程说明

## 📋 功能概述

实现了完整的微信小程序登录流程，包括：
1. ✅ 微信 OpenID 静默登录
2. ✅ 完善资料页面（包含微信头像和昵称选择器）
3. ✅ 登录状态持久化（重新编译无需重新登录）
4. ✅ 用户资料保存到 CloudBase 数据库

---

## 🔄 登录流程

```
用户点击登录
    ↓
微信 OpenID 静默登录
    ↓
跳转到完善资料页面
    ↓
用户填写资料（或跳过）
    ↓
保存到 CloudBase 数据库
    ↓
进入首页
```

---

## 📁 修改的文件

### 1. `src/pages/auth/login/index.vue`
**修改内容：**
- 登录成功后跳转到完善资料页面（而不是直接跳转到首页）

```vue
// 登录成功后跳转到完善资料页面
setTimeout(() => {
  uni.redirectTo({
    url: '/pages/auth/complete-profile/index'
  });
}, 1500);
```

---

### 2. `src/pages/auth/complete-profile/index.vue`
**修改内容：**

#### ① 添加微信头像选择器
使用微信官方的 `open-type="chooseAvatar"` 组件：

```vue
<button 
  class="avatar-btn" 
  open-type="chooseAvatar" 
  @chooseavatar="onChooseAvatar"
>
  <image 
    v-if="formData.avatarUrl" 
    :src="formData.avatarUrl" 
    class="avatar-image"
  />
  <view v-else class="avatar-placeholder">
    <text>点击选择头像</text>
  </view>
</button>
```

#### ② 添加微信昵称输入框
使用微信官方的 `type="nickname"` 输入框：

```vue
<input
  class="form-input"
  type="nickname"
  placeholder="请输入昵称"
  v-model="formData.nickName"
/>
```

#### ③ 实现保存到数据库
**提交表单时：**
- 验证必填项（真实姓名、手机号）
- 保存完整资料到 CloudBase 数据库的 `users` 集合
- 如果用户已存在则更新，否则新增

**跳过填写时：**
- 只保存头像和昵称（如果有的话）
- 允许用户稍后在个人中心完善资料

---

### 3. `src/App.vue`
**修改内容：**
- 添加登录状态检查逻辑
- 解决重新编译需要重新登录的问题

```typescript
onLaunch(async () => {
  // 检查登录状态
  const loginState = await auth.getLoginState();
  
  if (loginState) {
    console.log("✅ 用户已登录，登录状态已保留");
    // 用户无需重新登录
  } else {
    console.log("⚠️ 用户未登录，需要跳转到登录页面");
    // 跳转到登录页面
    uni.reLaunch({
      url: '/pages/auth/login/index'
    });
  }
});
```

---

### 4. `src/utils/cloudbase.ts`
**修改内容：**
- 导出数据库实例 `db`

```typescript
/**
 * 云开发数据库实例
 */
export const db = app.database();
```

---

## 🗄️ 数据库结构

### `users` 集合

| 字段 | 类型 | 说明 | 必填 |
|------|------|------|------|
| `userId` | String | CloudBase 用户 UID | ✅ |
| `avatarUrl` | String | 微信头像 URL | ❌ |
| `nickName` | String | 微信昵称 | ❌ |
| `realName` | String | 真实姓名 | ✅ (提交时) |
| `phone` | String | 手机号 | ✅ (提交时) |
| `gender` | String | 性别 (`male`/`female`) | ❌ |
| `birthdate` | Object | 出生八字 (`year`, `month`, `day`, `hour`) | ❌ |
| `industry` | String | 从事行业 | ❌ |
| `region` | String | 所在地区 | ❌ |
| `createdAt` | String | 创建时间 (ISO 8601) | ✅ |
| `updatedAt` | String | 更新时间 (ISO 8601) | ✅ |

---

## 🎯 使用说明

### 1. 首次登录
1. 用户点击"微信一键登录"
2. 自动完成 OpenID 静默登录
3. 跳转到完善资料页面
4. 用户可以：
   - **选择头像**：点击头像区域，调用微信官方头像选择器
   - **输入昵称**：使用微信官方昵称输入框
   - **填写资料**：真实姓名、手机号（必填），性别、出生八字、行业、地区（选填）
   - **提交**：保存完整资料到数据库，跳转到首页
   - **跳过**：只保存头像和昵称（如果有），跳转到首页

### 2. 重新编译
- 登录状态会自动保留
- 无需重新登录
- 直接进入首页

### 3. 完善资料
- 用户可以在个人中心页面再次完善资料
- 使用相同的表单组件和保存逻辑

---

## ⚠️ 注意事项

### 1. 微信政策变化
从 2023 年起，微信小程序调整了用户信息获取策略：
- ❌ `uni.getUserProfile()` 不再弹出授权窗口，只返回默认值
- ✅ 必须使用官方组件：
  - `<button open-type="chooseAvatar">` - 头像选择
  - `<input type="nickname">` - 昵称输入

### 2. 数据库权限
确保在 CloudBase 控制台配置 `users` 集合的权限：
- **创建权限**：允许已登录用户创建
- **更新权限**：只允许用户更新自己的记录
- **读取权限**：只允许用户读取自己的记录

推荐权限配置：
```json
{
  "read": "auth.uid == doc.userId",
  "write": "auth.uid == doc.userId"
}
```

### 3. 测试环境
- 在微信开发者工具中，测试号可能不会弹出头像选择窗口
- 建议使用真机预览进行完整测试

---

## 🔧 后续优化建议

1. **个人中心页面**
   - 展示用户资料
   - 允许用户修改资料
   - 使用相同的表单组件

2. **资料完整度提示**
   - 如果用户跳过了完善资料，在首页或个人中心显示提示
   - 引导用户完善资料

3. **手机号验证**
   - 添加短信验证码功能
   - 确保手机号的真实性

4. **头像上传**
   - 将微信头像上传到 CloudBase 云存储
   - 避免微信头像 URL 过期问题

---

## 📚 相关文档

- [CloudBase 身份认证](https://docs.cloudbase.net/authentication-v2/auth/practice/store-extra-user-info)
- [微信小程序用户信息获取](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html)
- [微信小程序头像昵称填写](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html)

