# 天道文化小程序 - 后台管理系统目录架构

**版本**: V1.0
**创建时间**: 2026-02-10
**总接口数**: 68个管理端接口

---

## 📊 系统概览

### 模块统计

| 云函数模块 | 管理端接口数 | 主要功能 |
|-----------|------------|---------|
| **user** | 3 | 学员管理、推荐人管理 |
| **ambassador** | 15 | 大使申请审核、等级管理、活动管理、协议管理 |
| **order** | 4 | 订单管理、提现审核 |
| **course** | 20 | 课程管理、排期管理、预约管理、案例资料管理 |
| **system** | 22 | 系统配置、通知管理、反馈管理、管理员管理、统计分析 |
| **callbacks** | 3 | 微信回调（消息推送、支付、退款） |
| **business-logic** | 1 | 业务逻辑处理（内部调用） |

---

## 🗂️ 后台目录架构

### 1️⃣ 仪表盘 (Dashboard)

**路由**: `/dashboard`

#### 1.1 数据统计概览
- **接口**: `system.getStatistics`
- **功能**:
  - 用户统计（总数、今日新增、大使数量）
  - 订单统计（总数、今日订单、总金额）
  - 课程统计（预约数、签到数、签到率）
  - 大使等级分布
  - 今日数据汇总

---

### 2️⃣ 学员管理 (User Management)

**路由**: `/users`

#### 2.1 学员列表
- **接口**: `user.admin:getUserList`
- **功能**:
  - 分页查询学员列表
  - 搜索（姓名、手机号）
  - 筛选（大使等级、注册日期）
  - 显示字段：姓名、手机、城市、推荐码、大使等级、功德分、积分、注册时间

#### 2.2 学员详情
- **接口**: `user.admin:getUserDetail`
- **功能**:
  - 基本信息（姓名、手机、城市、头像、推荐码）
  - 推荐人信息
  - 推荐用户数量
  - 已购课程列表
  - 订单统计（总订单数、已支付订单数、总消费金额）
  - 最近订单列表
  - 功德分统计（总获得、总消耗、当前余额）
  - 积分统计（总获得、总提现、可用、冻结）
  - 提现统计（总提现次数、已通过金额、待审核金额）

#### 2.3 修改推荐人
- **接口**: `user.admin:updateUserReferee`
- **功能**:
  - 强制修改用户推荐人
  - 清除推荐人
  - 记录变更日志

#### 2.4 推荐人变更日志
- **接口**: `user.admin:getRefereeChangeLogs`
- **功能**:
  - 查看推荐人变更审计日志
  - 筛选（用户ID）
  - 显示：用户信息、原推荐人、新推荐人、变更类型、操作人、备注、时间

---

### 3️⃣ 大使管理 (Ambassador Management)

**路由**: `/ambassadors`

#### 3.1 大使申请审核

##### 3.1.1 申请列表
- **接口**: `ambassador.getApplicationList`
- **功能**:
  - 分页查询申请列表
  - 筛选（状态：待审核/通过/拒绝）
  - 显示：用户信息、申请理由、状态、申请时间

##### 3.1.2 审核申请
- **接口**: `ambassador.auditApplication`
- **功能**:
  - 审核通过（自动升级为初级大使）
  - 审核拒绝（填写拒绝理由）
  - 发送审核结果通知

#### 3.2 大使列表与管理

##### 3.2.1 大使列表
- **接口**: `ambassador.getAmbassadorList`
- **功能**:
  - 分页查询大使列表
  - 筛选（等级）
  - 显示：姓名、手机、等级、推荐码、推荐人数、团队规模、总佣金、注册时间

##### 3.2.2 大使详情
- **接口**: `ambassador.getAmbassadorDetail`
- **功能**:
  - 基本信息
  - 等级信息
  - 推荐统计
  - 名额信息（总数、已用、可用）
  - 升级历史
  - 签署的协议列表

#### 3.3 活动管理

##### 3.3.1 活动列表
- **接口**: `ambassador.getActivityList`
- **功能**: 查询大使活动记录列表

##### 3.3.2 创建活动
- **接口**: `ambassador.createActivity`
- **功能**: 创建线下活动、培训、推广活动记录

##### 3.3.3 更新活动
- **接口**: `ambassador.updateActivity`

##### 3.3.4 删除活动
- **接口**: `ambassador.deleteActivity`

#### 3.4 协议模板管理

##### 3.4.1 协议模板列表
- **接口**: `ambassador.getContractTemplateList`
- **功能**: 查询所有协议模板

##### 3.4.2 创建协议模板
- **接口**: `ambassador.createContractTemplate`
- **功能**: 创建新的大使协议模板

##### 3.4.3 更新协议模板
- **接口**: `ambassador.updateContractTemplate`
- **功能**: 更新协议模板（会创建新版本）

##### 3.4.4 删除协议模板
- **接口**: `ambassador.deleteContractTemplate`
- **功能**: 软删除协议模板

##### 3.4.5 协议版本历史
- **接口**: `ambassador.getContractVersions`
- **功能**: 查看协议的所有版本历史

#### 3.5 协议签署管理

##### 3.5.1 签署记录列表
- **接口**: `ambassador.getSignatureList`
- **功能**:
  - 分页查询签署记录
  - 筛选（等级、状态）
  - 显示：用户信息、协议编号、标题、等级、状态、签署时间、到期时间

##### 3.5.2 即将到期的协议
- **接口**: `ambassador.getExpiringContracts`
- **功能**: 查询即将到期的协议（默认30天内）

---

### 4️⃣ 订单管理 (Order Management)

**路由**: `/orders`

#### 4.1 订单列表
- **接口**: `order.getOrderList`
- **功能**:
  - 分页查询订单列表
  - 筛选（支付状态、日期范围）
  - 搜索（用户姓名、手机号、订单号）
  - 显示：订单号、用户信息、订单类型、金额、支付状态、支付时间、推荐人、奖励发放状态

#### 4.2 订单详情
- **接口**: `order.getOrderDetail`
- **功能**:
  - 订单完整信息
  - 用户信息
  - 支付信息（支付方式、微信订单号、预支付ID）
  - 推荐人信息
  - 课程信息
  - 退款信息

#### 4.3 订单退款
- **接口**: `order.refund`
- **状态**: ⚠️ 功能开发中
- **功能**: 管理员执行订单退款

#### 4.4 提现审核
- **接口**: `order.withdrawAudit`
- **功能**:
  - 审核用户提现申请
  - 审核通过：扣除冻结积分
  - 审核拒绝：解冻积分退回

---

### 5️⃣ 课程管理 (Course Management)

**路由**: `/courses`

#### 5.1 课程管理

##### 5.1.1 课程列表
- **接口**: `course.getCourseList`
- **功能**: 查询所有课程（包括下架的）

##### 5.1.2 创建课程
- **接口**: `course.createCourse`
- **功能**: 创建新课程（初探班、深研班、复训）

##### 5.1.3 更新课程
- **接口**: `course.updateCourse`

##### 5.1.4 删除课程
- **接口**: `course.deleteCourse`
- **功能**: 软删除课程

#### 5.2 上课排期管理

##### 5.2.1 排期列表
- **接口**: `course.getClassRecordList`
- **功能**: 查询所有上课排期

##### 5.2.2 创建排期
- **接口**: `course.createClassRecord`
- **功能**: 创建新的上课排期

##### 5.2.3 更新排期
- **接口**: `course.updateClassRecord`

##### 5.2.4 删除排期
- **接口**: `course.deleteClassRecord`

#### 5.3 预约管理

##### 5.3.1 预约列表
- **接口**: `course.getAppointmentList`
- **功能**:
  - 分页查询预约列表
  - 筛选（上课排期、状态）
  - 显示：用户信息、课程信息、预约状态、签到时间

##### 5.3.2 更新预约状态
- **接口**: `course.updateAppointmentStatus`
- **功能**: 手动更新预约状态

##### 5.3.3 批量签到
- **接口**: `course.batchCheckin`
- **功能**: 批量签到多个预约

#### 5.4 案例管理

##### 5.4.1 案例列表
- **接口**: `course.getCaseList`

##### 5.4.2 创建案例
- **接口**: `course.createCase`

##### 5.4.3 更新案例
- **接口**: `course.updateCase`

##### 5.4.4 删除案例
- **接口**: `course.deleteCase`

#### 5.5 资料管理

##### 5.5.1 资料列表
- **接口**: `course.getMaterialList`

##### 5.5.2 创建资料
- **接口**: `course.createMaterial`

##### 5.5.3 更新资料
- **接口**: `course.updateMaterial`

##### 5.5.4 删除资料
- **接口**: `course.deleteMaterial`

#### 5.6 商学院管理

##### 5.6.1 商学院内容管理
- **接口**: `course.manageAcademyContent`
- **功能**: 创建、更新、删除商学院介绍内容

---

### 6️⃣ 系统管理 (System Management)

**路由**: `/system`

#### 6.1 系统配置

##### 6.1.1 获取配置
- **接口**: `system.getConfig`
- **功能**: 获取系统配置（单个或全部）

##### 6.1.2 更新配置
- **接口**: `system.updateConfig`
- **功能**: 更新系统配置项

#### 6.2 大使等级配置

##### 6.2.1 获取等级配置
- **接口**: `system.getAmbassadorLevelConfigs`
- **功能**: 查询所有大使等级配置

##### 6.2.2 更新等级配置
- **接口**: `system.updateAmbassadorLevelConfig`
- **功能**: 更新指定等级的配置

##### 6.2.3 初始化等级配置
- **接口**: `system.initAmbassadorLevelConfigs`
- **功能**: 创建默认的5个等级配置

#### 6.3 反馈管理

##### 6.3.1 反馈列表
- **接口**: `system.getFeedbackList`
- **功能**:
  - 分页查询反馈列表
  - 筛选（状态、类型）
  - 显示：用户信息、反馈类型、内容、图片、状态、回复内容

##### 6.3.2 回复反馈
- **接口**: `system.replyFeedback`
- **功能**: 回复用户反馈并更新状态

#### 6.4 通知管理

##### 6.4.1 通知配置列表
- **接口**: `system.getNotificationConfigList`
- **功能**: 查询所有通知配置

##### 6.4.2 创建通知配置
- **接口**: `system.createNotificationConfig`

##### 6.4.3 更新通知配置
- **接口**: `system.updateNotificationConfig`

##### 6.4.4 通知发送日志
- **接口**: `system.getNotificationLogs`
- **功能**: 查询通知发送历史记录

##### 6.4.5 发送通知
- **接口**: `system.sendNotification`
- **功能**: 批量发送订阅消息通知

#### 6.5 公告管理

##### 6.5.1 公告列表
- **接口**: `system.getAnnouncementList`

##### 6.5.2 创建公告
- **接口**: `system.createAnnouncement`
- **功能**: 创建系统公告（系统通知、活动公告、维护公告）

##### 6.5.3 更新公告
- **接口**: `system.updateAnnouncement`

##### 6.5.4 删除公告
- **接口**: `system.deleteAnnouncement`
- **功能**: 软删除公告

#### 6.6 管理员管理

##### 6.6.1 管理员列表
- **接口**: `system.getAdminUserList`
- **功能**: 查询所有管理员账号

##### 6.6.2 创建管理员
- **接口**: `system.createAdminUser`
- **功能**: 创建新的管理员账号

##### 6.6.3 更新管理员
- **接口**: `system.updateAdminUser`
- **功能**: 更新管理员信息（不能修改自己的状态）

##### 6.6.4 删除管理员
- **接口**: `system.deleteAdminUser`
- **功能**: 软删除管理员（不能删除自己）

---

### 7️⃣ 登录认证 (Authentication)

**路由**: `/login`

#### 7.1 管理员登录
- **接口**: `system.login`
- **功能**:
  - 用户名密码登录
  - 返回 JWT Token（有效期24小时）
  - 返回管理员信息和权限列表

---

### 8️⃣ 回调监控 (Callback Monitoring)

**路由**: `/callbacks`

#### 8.1 微信消息推送
- **接口**: `callbacks.message-push` (HTTP)
- **功能**:
  - GET: 接入验证
  - POST: 接收订阅消息事件

#### 8.2 微信支付回调
- **接口**: `callbacks.payment` (HTTP)
- **功能**: 接收支付结果通知

#### 8.3 微信退款回调
- **接口**: `callbacks.refund` (HTTP)
- **功能**: 接收退款结果通知

---

## 🎨 推荐的页面布局

### 侧边栏菜单结构

```
📊 仪表盘
   └─ 数据概览

👥 学员管理
   ├─ 学员列表
   └─ 推荐人变更日志

🎖️ 大使管理
   ├─ 申请审核
   ├─ 大使列表
   ├─ 活动管理
   ├─ 协议模板
   └─ 签署记录

📦 订单管理
   ├─ 订单列表
   └─ 提现审核

📚 课程管理
   ├─ 课程列表
   ├─ 上课排期
   ├─ 预约管理
   ├─ 案例管理
   ├─ 资料管理
   └─ 商学院管理

⚙️ 系统管理
   ├─ 系统配置
   ├─ 大使等级配置
   ├─ 反馈管理
   ├─ 通知管理
   ├─ 公告管理
   └─ 管理员管理

🔔 回调监控
   ├─ 消息推送日志
   ├─ 支付回调日志
   └─ 退款回调日志
```

---

## 🔐 权限管理建议

### 角色定义

| 角色 | 权限范围 |
|------|---------|
| **super_admin** | 所有权限 |
| **admin** | 除管理员管理外的所有权限 |
| **operator** | 订单管理、课程管理、反馈管理 |

### 权限标识

```javascript
// 用户管理
'user:read', 'user:write', 'user:delete'

// 大使管理
'ambassador:read', 'ambassador:write', 'ambassador:audit'

// 订单管理
'order:read', 'order:write', 'order:refund', 'order:withdraw_audit'

// 课程管理
'course:read', 'course:write', 'course:delete'

// 系统管理
'system:config', 'system:admin', 'system:notification'
```

---

## 📱 技术实现建议

### 前端技术栈
- **框架**: Vue 3 + Element Plus / React + Ant Design
- **路由**: Vue Router / React Router
- **状态管理**: Pinia / Redux Toolkit
- **HTTP客户端**: Axios
- **图表**: ECharts / Chart.js

### 后端调用方式

```javascript
// 云函数调用示例
const result = await wx.cloud.callFunction({
  name: 'user',
  data: {
    action: 'admin:getUserList',
    page: 1,
    pageSize: 20,
    keyword: '张三'
  }
})

// HTTP回调接口
// 配置在微信公众平台/商户平台
// https://your-domain.com/callbacks/payment
```

### 认证方式

```javascript
// 管理员登录
const { token, admin } = await login(username, password)

// 后续请求携带 Token
headers: {
  'Authorization': `Bearer ${token}`
}
```

---

## 📊 数据库表关系

### 核心表

| 表名 | 说明 | 关联表 |
|------|------|--------|
| **users** | 用户表 | orders, user_courses, appointments |
| **orders** | 订单表 | users, courses |
| **courses** | 课程表 | class_records, user_courses |
| **class_records** | 上课排期表 | courses, appointments |
| **appointments** | 预约表 | users, class_records |
| **ambassador_applications** | 大使申请表 | users |
| **ambassador_quotas** | 大使名额表 | users |
| **contract_templates** | 协议模板表 | contract_signatures |
| **contract_signatures** | 协议签署表 | users, contract_templates |
| **withdrawals** | 提现记录表 | users |
| **feedbacks** | 用户反馈表 | users, courses |
| **admin_users** | 管理员表 | - |
| **system_configs** | 系统配置表 | - |

---

## ⚠️ 注意事项

### 1. 支付功能
以下接口暂时返回"功能开发中"，待配置微信商户信息后启用：
- `order.createPayment` - 发起支付
- `order.paymentCallback` - 支付回调
- `order.refund` - 订单退款

### 2. 权限验证
- 所有管理端接口需要 JWT Token 认证
- Token 有效期 24 小时
- 需要在请求头中携带：`Authorization: Bearer <token>`

### 3. 数据安全
- 密码使用 MD5 加密存储
- 敏感信息（手机号）部分脱敏显示
- 操作日志记录（待实现）

### 4. 性能优化
- 列表接口支持分页
- 大数据量查询使用索引
- 图片使用云存储CDN

### 5. 错误处理
- 统一错误码和错误信息
- 前端友好的错误提示
- 详细的日志记录

---

## 📝 开发优先级建议

### 第一阶段（核心功能）
1. ✅ 管理员登录认证
2. ✅ 仪表盘数据统计
3. ✅ 学员管理（列表、详情）
4. ✅ 订单管理（列表、详情）
5. ✅ 课程管理（列表、创建、编辑）

### 第二阶段（大使系统）
6. ✅ 大使申请审核
7. ✅ 大使列表与详情
8. ✅ 协议模板管理
9. ✅ 签署记录管理
10. ✅ 提现审核

### 第三阶段（运营功能）
11. ✅ 反馈管理
12. ✅ 通知管理
13. ✅ 公告管理
14. ✅ 系统配置
15. ✅ 管理员管理

### 第四阶段（高级功能）
16. 🔄 回调监控
17. 🔄 操作日志
18. 🔄 数据导出
19. 🔄 批量操作
20. 🔄 权限细化

---

## 📞 联系方式

**文档维护**: 开发团队
**最后更新**: 2026-02-10
**版本**: V1.0

---

**说明**:
- ✅ 表示接口已开发完成
- ⚠️ 表示功能开发中
- 🔄 表示待开发功能
